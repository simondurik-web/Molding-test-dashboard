<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Roll Tech Operations Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --staged-blue: #4299e1;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1421 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
        }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 12px; overflow-y: auto; z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.4); transition: transform 0.3s ease;
        }
        .logo { text-align: center; padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .logo h1 { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 11px; color: var(--text-secondary); display: block; margin-top: 4px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 14px; font-weight: 700; }
        .nav-item { display: flex; align-items: center; padding: 11px 14px; margin: 3px 0; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 12px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item.sub-item { padding-left: 36px; font-size: 11px; opacity: 0.9; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 8px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }
        .lang-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; margin: 10px 8px; }
        .lang-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: white; }
        .main-content { margin-left: var(--sidebar-width); padding: 20px 24px; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .dept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dept-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 16px; padding: 24px; border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .dept-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .dept-card.sales::before { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .dept-card.production::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .dept-card.inventory::before { background: linear-gradient(90deg, var(--teal), var(--accent)); }
        .dept-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-color: var(--accent); }
        .dept-card .icon-large { font-size: 40px; margin-bottom: 12px; }
        .dept-card h3 { font-size: 20px; margin-bottom: 8px; }
        .dept-card p { color: var(--text-secondary); font-size: 12px; margin-bottom: 16px; }
        .dept-card .metrics { display: flex; gap: 20px; flex-wrap: wrap; }
        .dept-card .metric .value { font-size: 22px; font-weight: 700; }
        .dept-card .metric .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .dept-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .dept-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .coming-soon { position: absolute; top: 12px; right: 12px; background: var(--warning); color: #1a202c; padding: 3px 10px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .quick-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 24px; }
        .quick-stat { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 12px; padding: 16px; border: 1px solid var(--border); text-align: center; }
        .quick-stat .value { font-size: 24px; font-weight: 700; }
        .quick-stat .value.positive { color: var(--success); }
        .quick-stat .value.negative { color: var(--danger); }
        .quick-stat .value.warning { color: var(--warning); }
        .quick-stat .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .info-banner { border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; display: none; }
        .info-banner.active { display: flex; align-items: center; gap: 12px; }
        .info-banner.warning { background: linear-gradient(135deg, #744210 0%, #975a16 100%); border: 1px solid var(--warning); }
        .info-banner.warning p { color: #fefcbf; }
        .info-banner.info { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border: 1px solid var(--accent); }
        .info-banner.info p { color: #bee3f8; }
        .info-banner p { font-size: 12px; margin: 0; }
        .info-banner .icon { font-size: 20px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border); }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"], .toolbar input[type="text"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .toolbar-spacer { flex: 1; }
        .category-filters { display: flex; gap: 8px; }
        .category-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 2px solid; display: flex; align-items: center; gap: 6px; }
        .category-btn .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .category-btn.rolltech { border-color: var(--accent); color: var(--accent); background: transparent; }
        .category-btn.rolltech.active { background: var(--accent); color: white; }
        .category-btn.rolltech .indicator { background: var(--accent); }
        .category-btn.molding { border-color: var(--warning); color: var(--warning); background: transparent; }
        .category-btn.molding.active { background: var(--warning); color: #1a202c; }
        .category-btn.molding .indicator { background: var(--warning); }
        .category-btn:not(.active) { opacity: 0.5; }
        .category-btn:not(.active):hover { opacity: 0.8; }
        .status-filters { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; border: 1px solid; }
        .status-btn.pending { border-color: var(--warning); color: var(--warning); background: transparent; }
        .status-btn.pending.active { background: var(--warning); color: #1a202c; }
        .status-btn.staged { border-color: var(--staged-blue); color: var(--staged-blue); background: transparent; }
        .status-btn.staged.active { background: var(--staged-blue); color: white; }
        .status-btn.wip { border-color: var(--teal); color: var(--teal); background: transparent; }
        .status-btn.wip.active { background: var(--teal); color: white; }
        .status-btn.shipped { border-color: var(--success); color: var(--success); background: transparent; }
        .status-btn.shipped.active { background: var(--success); color: white; }
        .status-btn:not(.active) { opacity: 0.5; }
        .status-btn:not(.active):hover { opacity: 0.8; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; white-space: nowrap; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .warning-text { color: var(--warning); font-weight: 600; }
        .scrollable-table { max-height: 600px; overflow-y: auto; overflow-x: auto; border-radius: 10px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--staged-blue) 0%, #3182ce 100%); color: white; }
        .badge.wip { background: linear-gradient(135deg, var(--teal) 0%, #2c7a7b 100%); color: white; }
        .badge.urgent { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }
        .badge.priority-1 { background: var(--danger); color: white; }
        .badge.priority-2 { background: var(--warning); color: #1a202c; }
        .badge.priority-3 { background: var(--accent); color: white; }
        .badge.priority-4 { background: var(--teal); color: white; }
        .cell-missing { color: var(--danger); font-weight: 600; }
        .cell-available { color: var(--success); }
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .price-history-container { position: relative; height: 250px; margin-bottom: 20px; padding-bottom: 30px; }
        .price-history-container canvas { max-height: 250px; }
        .search-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1200px) { .quick-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .dept-grid { grid-template-columns: 1fr; }
            .quick-stats { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-spacer { display: none; }
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }
        .inv-low { background: rgba(229,62,62,0.15) !important; }
        .inv-warning { background: rgba(214,158,46,0.15) !important; }
        .inv-ok { background: rgba(56,161,105,0.08) !important; }
        .drilldown-section { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .drilldown-section.active { display: block; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; }
        .breadcrumb { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .close-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .close-btn:hover { border-color: var(--danger); color: var(--danger); }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        .summary-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        @media (max-width: 768px) { .bom-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
        
        /* Column Filter System Styles */
        .filter-th { position: relative; }
        .filter-th-content { display: flex; align-items: center; justify-content: space-between; gap: 4px; }
        .filter-th-btns { display: flex; gap: 2px; margin-left: 4px; }
        .filter-th-btns button { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .filter-th-btns button:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-th.filtered { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; }
        .filter-th.filtered .filter-th-btns button { background: rgba(0,0,0,0.2); }
        .filter-dropdown { position: fixed; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2000; min-width: 240px; max-width: 320px; max-height: 400px; display: none; flex-direction: column; }
        .filter-dropdown.active { display: flex; }
        .filter-dropdown-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-dropdown-header h4 { font-size: 12px; font-weight: 600; margin: 0; }
        .filter-dropdown-header button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; }
        .filter-search { margin: 10px; padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 12px; }
        .filter-search:focus { outline: none; border-color: var(--accent); }
        .filter-actions { display: flex; gap: 8px; padding: 0 10px 8px 10px; }
        .filter-actions button { flex: 1; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .filter-actions button:hover { border-color: var(--accent); color: white; }
        .filter-values-list { flex: 1; overflow-y: auto; padding: 0 10px; max-height: 220px; }
        .filter-value-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .filter-value-item:hover { background: rgba(255,255,255,0.05); }
        .filter-value-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        .filter-value-item label { cursor: pointer; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-dropdown-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .filter-dropdown-footer button { flex: 1; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .filter-dropdown-footer .clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .filter-dropdown-footer .clear-btn:hover { border-color: var(--danger); color: var(--danger); }
        .filter-dropdown-footer .apply-btn { background: var(--accent); border: none; color: white; }
        .filter-dropdown-footer .apply-btn:hover { background: var(--primary-light); }
        .clear-all-filters-btn { background: var(--bg-dark) !important; }
        .clear-all-filters-btn.has-filters { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; color: #1a202c !important; border-color: var(--warning) !important; }
        .watchlist-star { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .watchlist-star:hover { color: var(--warning); }
        .watchlist-star.active { color: var(--warning); }
        
        /* All Data table styles - larger for better readability */
        #all-data .data-table th { font-size: 11px; padding: 10px 8px; white-space: nowrap; min-width: 100px; }
        #all-data .data-table td { font-size: 12px; padding: 8px; white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
        #all-data .scrollable-table { overflow-x: auto; }
        #all-data .filter-th-btns button { width: 20px; height: 20px; font-size: 10px; }
        
        /* Zoom controls */
        .zoom-controls { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 10px 8px; }
        .zoom-btn { width: 28px; height: 28px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .zoom-btn:hover { background: var(--accent); border-color: var(--accent); }
        .zoom-reset-btn { width: 100%; margin-top: 8px; padding: 6px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .zoom-reset-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Zoomed main content */
        .main-content.zoomed { transform-origin: top left; }
        
        /* Pallet Pictures Gallery Styles */
        .pallet-drilldown { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .pallet-drilldown.active { display: block; }
        .pallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .pallet-header h3 { font-size: 18px; }
        .pallet-summary { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .pallet-summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .pallet-summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .pallet-summary-item .value { font-size: 18px; font-weight: 700; }
        .pallet-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .pallet-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.2s; }
        .pallet-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .pallet-card-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pallet-card-header h4 { font-size: 14px; font-weight: 600; }
        .pallet-card-header .pallet-meta { font-size: 11px; color: var(--text-secondary); }
        .pallet-images { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .pallet-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .pallet-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
        .pallet-card-details { padding: 12px; background: rgba(0,0,0,0.2); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pallet-detail { font-size: 11px; }
        .pallet-detail .label { color: var(--text-secondary); }
        .pallet-detail .value { font-weight: 600; color: var(--text-primary); }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .image-modal-close:hover { background: var(--danger); }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover td { background: rgba(49,130,206,0.15) !important; }
        .pallet-indicator { margin-left: 6px; color: var(--accent); font-size: 12px; }
    </style>
</head>
<body>
    <!-- Image Modal for Pallet Pictures -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <div class="image-modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="modalImage" src="" alt="Pallet Picture">
    </div>

    <!-- Column Filter Dropdown Modal -->
    <div class="filter-dropdown" id="columnFilterDropdown">
        <div class="filter-dropdown-header">
            <h4 id="filterDropdownTitle">Filter Column</h4>
            <button onclick="closeFilterDropdown()">‚úï</button>
        </div>
        <input type="text" class="filter-search" id="filterDropdownSearch" placeholder="Search values..." oninput="filterDropdownSearch()">
        <div class="filter-actions">
            <button onclick="filterSelectAll()">Select All</button>
            <button onclick="filterDeselectAll()">Deselect All</button>
        </div>
        <div class="filter-values-list" id="filterValuesList"></div>
        <div class="filter-dropdown-footer">
            <button class="clear-btn" onclick="clearColumnFilter()">Clear</button>
            <button class="apply-btn" onclick="applyColumnFilter()">Apply</button>
        </div>
    </div>

    <div class="mobile-header">
        <div><h1>Roll Tech</h1><span style="font-size:10px;color:var(--text-secondary);">Operations</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="logo"><h1>Roll Tech</h1><span id="logoSubtitle">Operations Dashboard</span></div>
        <div class="lang-toggle">
            <button class="lang-btn active" id="langEN" onclick="setLanguage('en')">English</button>
            <button class="lang-btn" id="langES" onclick="setLanguage('es')">Espa√±ol</button>
        </div>
        <div class="nav-section">
            <div class="nav-item active" data-page="main" onclick="navigateTo('main')"><span class="icon">üè†</span> <span data-i18n="nav.main">Main Dashboard</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.production">Production</div>
            <div class="nav-item" data-page="orders-data" onclick="navigateTo('orders-data')"><span class="icon">üìã</span> <span data-i18n="nav.ordersData">Orders Data</span></div>
            <div class="nav-item sub-item" data-page="orders-queue" onclick="navigateTo('orders-queue')"><span class="icon">üîß</span> <span data-i18n="nav.ordersQueue">Need to Make</span></div>
            <div class="nav-item sub-item" data-page="orders-staged" onclick="navigateTo('orders-staged')"><span class="icon">üì¶</span> <span data-i18n="nav.ordersStaged">Ready to Ship</span></div>
            <div class="nav-item sub-item" data-page="orders-shipped" onclick="navigateTo('orders-shipped')"><span class="icon">üöö</span> <span data-i18n="nav.ordersShipped">Shipped</span></div>
            <div class="nav-item" data-page="inventory" onclick="navigateTo('inventory')"><span class="icon">üì¶</span> <span data-i18n="nav.inventory">Inventory</span></div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.salesFinance">Sales & Finance</div>
            <div class="nav-item" data-page="sales-overview" onclick="navigateTo('sales-overview')"><span class="icon">üìä</span> <span data-i18n="nav.plOverview">P/L Overview</span></div>
            <div class="nav-item sub-item" data-page="sales-parts" onclick="navigateTo('sales-parts')"><span class="icon">üîß</span> <span data-i18n="nav.byPart">By Part Number</span></div>
            <div class="nav-item sub-item" data-page="sales-customers" onclick="navigateTo('sales-customers')"><span class="icon">üë•</span> <span data-i18n="nav.byCustomer">By Customer</span></div>
            <div class="nav-item sub-item" data-page="sales-dates" onclick="navigateTo('sales-dates')"><span class="icon">üìÖ</span> <span data-i18n="nav.byDate">By Date</span></div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.billOfMaterials">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">üìã</span> <span data-i18n="nav.bomExplorer">BOM Explorer</span></div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.rawData">Raw Data</div>
            <div class="nav-item" data-page="all-data" onclick="navigateTo('all-data')"><span class="icon">üóÉÔ∏è</span> <span data-i18n="nav.allData">All Data</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="zoom-controls">
            <label style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block;">Zoom</label>
            <div style="display:flex;align-items:center;gap:6px;">
                <button class="zoom-btn" onclick="adjustZoom(-10)">‚àí</button>
                <input type="number" id="zoomInput" value="100" min="50" max="200" step="10" onchange="setZoom(this.value)" style="width:50px;text-align:center;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:white;padding:4px;font-size:11px;">
                <span style="font-size:10px;color:var(--text-secondary);">%</span>
                <button class="zoom-btn" onclick="adjustZoom(10)">+</button>
            </div>
            <button class="zoom-reset-btn" onclick="resetZoom()">Reset (100%)</button>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
        <div style="color:#718096;font-size:10px;margin-top:8px;text-align:center;">Dashboard v7.3</div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading"><div class="spinner"></div><p style="margin-top:18px;color:var(--text-secondary);" data-i18n="loading">Loading data from Google Sheets...</p></div>

        <!-- MAIN DASHBOARD -->
        <div id="main" class="page">
            <div class="page-header">
                <div><h2 data-i18n="main.title">Operations Dashboard</h2><p data-i18n="main.subtitle">Real-time overview of Roll Tech manufacturing operations</p></div>
                <div class="last-updated"><span class="dot"></span><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="quick-stats">
                <div class="quick-stat"><div class="value warning" id="qsNeedToMake">-</div><div class="label" data-i18n="stats.needToMake">Need to Make</div></div>
                <div class="quick-stat"><div class="value" id="qsUrgentOrders">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                <div class="quick-stat"><div class="value" id="qsTotalQty">-</div><div class="label" data-i18n="stats.totalUnits">Total Units</div></div>
                <div class="quick-stat"><div class="value positive" id="qsMonthlyRevenue">-</div><div class="label" data-i18n="stats.monthRevenue">Month Revenue</div></div>
                <div class="quick-stat"><div class="value" id="qsMonthlyPL">-</div><div class="label" data-i18n="stats.monthPL">Month P/L</div></div>
                <div class="quick-stat"><div class="value warning" id="qsMissingComponents">-</div><div class="label" data-i18n="stats.missingParts">Missing Parts</div></div>
            </div>
            <div class="dept-grid">
                <div class="dept-card production" onclick="navigateTo('orders-queue')">
                    <div class="icon-large">üè≠</div>
                    <h3 data-i18n="dept.production">Production Planning</h3>
                    <p data-i18n="dept.productionDesc">View orders to make, component status, and production queue</p>
                    <div class="metrics">
                        <div class="metric"><div class="value" id="deptProdOrders">-</div><div class="label" data-i18n="dept.needToMake">Need to Make</div></div>
                        <div class="metric"><div class="value" id="deptProdUnits">-</div><div class="label" data-i18n="dept.units">Units</div></div>
                        <div class="metric"><div class="value warning" id="deptProdUrgent">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                    </div>
                </div>
                <div class="dept-card sales" onclick="navigateTo('sales-overview')">
                    <div class="icon-large">üí∞</div>
                    <h3 data-i18n="dept.sales">Sales & P/L Analytics</h3>
                    <p data-i18n="dept.salesDesc">Revenue, profitability, and customer analysis</p>
                    <div class="metrics">
                        <div class="metric"><div class="value positive" id="deptSalesRev">-</div><div class="label" data-i18n="dept.revenue">Revenue</div></div>
                        <div class="metric"><div class="value" id="deptSalesPL">-</div><div class="label" data-i18n="dept.profit">Profit</div></div>
                        <div class="metric"><div class="value" id="deptSalesOrders">-</div><div class="label" data-i18n="dept.orders">Orders</div></div>
                    </div>
                </div>
                <div class="dept-card inventory" onclick="navigateTo('inventory')">
                    <div class="icon-large">üì¶</div>
                    <h3 data-i18n="dept.inventory">Inventory Management</h3>
                    <p data-i18n="dept.inventoryDesc">Stock levels, reorder points, and material tracking</p>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.ordersByStatus">Orders by Status</h3></div>
                    <div class="chart-wrapper"><canvas id="mainStatusChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.upcomingDeadlines">Upcoming Deadlines (Next 14 Days)</h3></div>
                    <div class="chart-wrapper"><canvas id="mainDeadlineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ORDERS DATA PAGE -->
        <div id="orders-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersData.title">All Orders Data</h2><p data-i18n="ordersData.subtitle">Complete order database with all statuses</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersDataBtnRollTech" onclick="toggleOrdersDataCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="ordersDataBtnMolding" onclick="toggleOrdersDataCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group status-filters">
                    <label>Status:</label>
                    <button class="status-btn pending active" id="ordersDataStatusPending" onclick="toggleOrdersDataStatus('pending')"><span data-i18n="status.needToMake">Need to Make</span></button>
                    <button class="status-btn wip active" id="ordersDataStatusWip" onclick="toggleOrdersDataStatus('wip')"><span data-i18n="status.making">Making</span></button>
                    <button class="status-btn staged active" id="ordersDataStatusStaged" onclick="toggleOrdersDataStatus('staged')"><span data-i18n="status.readyToShip">Ready to Ship</span></button>
                    <button class="status-btn shipped" id="ordersDataStatusShipped" onclick="toggleOrdersDataStatus('shipped')"><span data-i18n="status.shipped">Shipped</span></button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersDataSearch" placeholder="Search..." oninput="filterOrdersDataTable()">
                <button class="toolbar-btn" onclick="exportOrdersDataToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Orders</div><div class="value" id="ordersDataTotalOrders">-</div><div class="sub" id="ordersDataTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needToMake">Need to Make</div><div class="value warning" id="ordersDataNeedToMake">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.making">Making</div><div class="value" style="color:var(--teal);" id="ordersDataMaking">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.readyToShip">Ready to Ship</div><div class="value positive" id="ordersDataReadyToShip">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersDataTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="ordersDataTable"><thead><tr id="ordersDataTableHeader"></tr></thead><tbody id="ordersDataTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS QUEUE PAGE -->
        <div id="orders-queue" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersQueue.title">Orders Queue - Need to Make</h2><p data-i18n="ordersQueue.subtitle">Orders pending production (Pending + Approved status)</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersQueueLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersQueueBtnRollTech" onclick="toggleOrdersQueueCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="ordersQueueBtnMolding" onclick="toggleOrdersQueueCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersQueueSearch" placeholder="Search..." oninput="filterOrdersQueueTable()">
                <button class="toolbar-btn" onclick="exportOrdersQueueToCSV()">üì• Export</button>
            </div>
            <div class="info-banner warning" id="ordersQueueMissingBanner">
                <span class="icon">‚ö†¬†¬è</span>
                <p><strong id="ordersQueueMissingCount">0</strong> <span data-i18n="prod.missingMsg">orders have missing components.</span></p>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Orders</div><div class="value" id="ordersQueueTotalOrders">-</div><div class="sub" id="ordersQueueTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Urgent</div><div class="value negative" id="ordersQueueUrgentCount">-</div></div>
                <div class="stat-card"><div class="label">Due This Week</div><div class="value warning" id="ordersQueueDueWeek">-</div><div class="sub" id="ordersQueueDueWeekUnits">- units</div></div>
                <div class="stat-card"><div class="label">Components Ready</div><div class="value positive" id="ordersQueueComponentsReady">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Orders to Make</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersQueueTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersQueueTableHeader"></tr></thead><tbody id="ordersQueueTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS STAGED PAGE -->
        <div id="orders-staged" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersStaged.title">Staged Orders - Ready to Ship</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersStagedBtnRollTech" onclick="toggleOrdersStagedCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="ordersStagedBtnMolding" onclick="toggleOrdersStagedCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersStagedSearch" placeholder="Search..." oninput="filterOrdersStagedTable()">
                <button class="toolbar-btn" onclick="exportOrdersStagedToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Staged Orders</div><div class="value" id="ordersStagedTotalOrders">-</div><div class="sub" id="ordersStagedTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value positive" id="ordersStagedRevenue">-</div></div>
                <div class="stat-card"><div class="label">Avg Order Value</div><div class="value" id="ordersStagedAvgValue">-</div></div>
                <div class="stat-card"><div class="label">Customers</div><div class="value" id="ordersStagedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Ready to Ship</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersStagedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersStagedTableHeader"></tr></thead><tbody id="ordersStagedTableBody"></tbody></table>
                </div>
            </div>
            <!-- Pallet Pictures Drilldown -->
            <div class="pallet-drilldown" id="palletDrilldown">
                <div class="pallet-header">
                    <div>
                        <div class="breadcrumb">Staged Orders ‚Ä∫ <span id="palletDrilldownOrder">-</span></div>
                        <h3 data-i18n="pallet.title">Pallet Pictures</h3>
                    </div>
                    <button class="close-btn" onclick="closePalletDrilldown()">‚úï Close</button>
                </div>
                <div class="pallet-summary" id="palletSummary"></div>
                <div class="pallet-gallery" id="palletGallery"></div>
            </div>
        </div>

        <!-- ORDERS SHIPPED PAGE -->
        <div id="orders-shipped" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersShipped.title">Shipped Orders History</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersShippedBtnRollTech" onclick="toggleOrdersShippedCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="ordersShippedBtnMolding" onclick="toggleOrdersShippedCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="ordersShippedFromDate" onchange="applyShippedDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="ordersShippedToDate" onchange="applyShippedDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetShippedDateFilter()">üîÑ Reset</button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersShippedSearch" placeholder="Search..." oninput="filterOrdersShippedTable()">
                <button class="toolbar-btn" onclick="exportOrdersShippedToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Shipped Orders</div><div class="value" id="ordersShippedTotalOrders">-</div><div class="sub" id="ordersShippedTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value positive" id="ordersShippedRevenue">-</div></div>
                <div class="stat-card"><div class="label">Total P/L</div><div class="value" id="ordersShippedPL">-</div><div class="sub" id="ordersShippedMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Customers</div><div class="value" id="ordersShippedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Shipped Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersShippedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersShippedTableHeader"></tr></thead><tbody id="ordersShippedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- INVENTORY PAGE -->
        <div id="inventory" class="page">
            <div class="page-header">
                <div><h2 data-i18n="inv.title">Inventory Management</h2></div>
            </div>
            <div class="toolbar">
                <input type="text" class="search-box" id="invSearch" placeholder="Search items..." oninput="filterInvTable()">
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="invFilterAll" onclick="setInvFilter('all')">All</button>
                    <button class="toolbar-btn" id="invFilterLow" onclick="setInvFilter('low')">‚ö†¬†¬è Low Stock</button>
                    <button class="toolbar-btn" id="invFilterNeeded" onclick="setInvFilter('needed')">üîß Needs Production</button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="inventoryClearFiltersBtn" onclick="clearAllTableFilters('inventory')">üóëÔ∏è Clear Filters</button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportInvCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Items</div><div class="value" id="invStatTotal">-</div><div class="sub" id="invStatTypes">- product types</div></div>
                <div class="stat-card"><div class="label">Low Stock</div><div class="value" style="color:var(--danger);" id="invStatLow">-</div></div>
                <div class="stat-card"><div class="label">Needs Production</div><div class="value" style="color:var(--warning);" id="invStatNeeded">-</div></div>
                <div class="stat-card"><div class="label">Adequate Stock</div><div class="value" style="color:var(--success);" id="invStatOk">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Inventory Status</h3><span style="color:var(--text-secondary);font-size:12px;" id="invTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="invTable">
                        <thead><tr id="invTableHeader"></tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES OVERVIEW PAGE -->
        <div id="sales-overview" class="page">
            <div class="page-header">
                <div><h2 data-i18n="sales.title">P/L Overview</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="salesBtnRollTech" onclick="toggleSalesCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="salesBtnMolding" onclick="toggleSalesCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportSalesCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value" id="salesStatRevenue">-</div><div class="sub" id="salesStatOrderCount">- orders</div></div>
                <div class="stat-card"><div class="label">Total P/L</div><div class="value" id="salesStatPL">-</div><div class="sub" id="salesStatMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Shipped P/L</div><div class="value" id="salesStatShippedPL">-</div><div class="sub" id="salesStatShippedCount">- shipped</div></div>
                <div class="stat-card"><div class="label">Forecasted P/L</div><div class="value" id="salesStatForecastPL">-</div><div class="sub" id="salesStatForecastCount">- pending</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly P/L Trend</h3></div>
                <div class="chart-wrapper large"><canvas id="salesTrendChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY PARTS PAGE -->
        <div id="sales-parts" class="page">
            <div class="page-header">
                <div><h2>P/L by Part Number</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="partsBtnRollTech" onclick="togglePartsCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="partsBtnMolding" onclick="togglePartsCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="partsFromDate" onchange="applyPartsDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="partsToDate" onchange="applyPartsDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetPartsDateFilter()">üîÑ Clear Dates</button>
                <button class="toolbar-btn" id="partsWatchlistBtn" onclick="togglePartsWatchlistFilter()">‚≠ê Watchlist</button>
                <button class="toolbar-btn clear-all-filters-btn" id="partsClearFiltersBtn" onclick="clearAllTableFilters('parts')">üóëÔ∏è Clear Filters</button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="partsSearch" placeholder="Search parts..." oninput="filterPartsTable()">
                <button class="toolbar-btn" onclick="exportPartsCSV()">üì• Export</button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>All Parts P/L Analysis</h3></div>
                <div class="chart-wrapper large"><canvas id="partsBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Parts Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="partsTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="partsTableHeader"></tr></thead><tbody id="partsTableBody"></tbody></table>
                </div>
            </div>
            <!-- Parts Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="partsCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts ‚Ä∫ <span id="partsCustomerDrilldownPart">-</span></div>
                        <h3>Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closePartsCustomerDrilldown()">‚úï Close</button>
                </div>
                <div class="summary-row" id="partsCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="partsCustomerDrilldownHeader"></tr></thead>
                        <tbody id="partsCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Parts Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="partsOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts ‚Ä∫ <span id="partsOrdersBreadcrumbPart">-</span> ‚Ä∫ <span id="partsOrdersBreadcrumbCustomer">-</span></div>
                        <h3>Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToPartsCustomers()">‚Üê Back</button>
                        <button class="close-btn" onclick="closeAllPartsDrilldowns()">‚úï Close All</button>
                    </div>
                </div>
                <div class="summary-row" id="partsOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="partsOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="partsOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY CUSTOMERS PAGE -->
        <div id="sales-customers" class="page">
            <div class="page-header">
                <div><h2>P/L by Customer</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="customersBtnRollTech" onclick="toggleCustomersCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="customersBtnMolding" onclick="toggleCustomersCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="customersFromDate" onchange="applyCustomersDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="customersToDate" onchange="applyCustomersDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetCustomersDateFilter()">üîÑ Clear Dates</button>
                <button class="toolbar-btn" id="customersWatchlistBtn" onclick="toggleCustomersWatchlistFilter()">‚≠ê Watchlist</button>
                <button class="toolbar-btn clear-all-filters-btn" id="customersClearFiltersBtn" onclick="clearAllTableFilters('customers')">üóëÔ∏è Clear Filters</button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="customersSearch" placeholder="Search customers..." oninput="filterCustomersTable()">
                <button class="toolbar-btn" onclick="exportCustomersCSV()">üì• Export</button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Customer P/L Distribution (Top 10)</h3></div>
                <div class="chart-wrapper large"><canvas id="customersChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Customer Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="customersTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="customersTableHeader"></tr></thead><tbody id="customersTableBody"></tbody></table>
                </div>
            </div>
            <!-- Customers Product Drilldown (Level 1) -->
            <div class="drilldown-section" id="customersProductDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers ‚Ä∫ <span id="customersProductDrilldownCustomer">-</span></div>
                        <h3>Product Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeCustomersProductDrilldown()">‚úï Close</button>
                </div>
                <div class="summary-row" id="customersProductSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part Number</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Margin</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="customersProductDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Customers Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="customersOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers ‚Ä∫ <span id="customersOrdersBreadcrumbCustomer">-</span> ‚Ä∫ <span id="customersOrdersBreadcrumbPart">-</span></div>
                        <h3>Orders Breakdown</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToCustomersProducts()">‚Üê Back</button>
                        <button class="close-btn" onclick="closeAllCustomersDrilldowns()">‚úï Close All</button>
                    </div>
                </div>
                <div class="summary-row" id="customersOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="customersOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="customersOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY DATE PAGE -->
        <div id="sales-dates" class="page">
            <div class="page-header">
                <div><h2>P/L by Date</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="datesBtnRollTech" onclick="toggleDatesCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding active" id="datesBtnMolding" onclick="toggleDatesCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="datesFromDate" onchange="applyDatesDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="datesToDate" onchange="applyDatesDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetDatesDateFilter()">üîÑ Clear Dates</button>
                <button class="toolbar-btn clear-all-filters-btn" id="datesClearFiltersBtn" onclick="clearAllTableFilters('dates')">üóëÔ∏è Clear Filters</button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportDatesCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Orders</div><div class="value" id="datesStatOrders">-</div><div class="sub" id="datesStatUnits">- units</div></div>
                <div class="stat-card"><div class="label">Revenue</div><div class="value" id="datesStatRevenue">-</div></div>
                <div class="stat-card"><div class="label">P/L</div><div class="value" id="datesStatPL">-</div><div class="sub" id="datesStatMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Margin</div><div class="value" id="datesStatMarginPct">-</div><div class="sub" id="datesStatMonths">- months</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly P/L Breakdown</h3></div>
                <div class="chart-wrapper large"><canvas id="datesBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="datesTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="datesTableHeader"></tr></thead><tbody id="datesTableBody"></tbody></table>
                </div>
            </div>
            <!-- Dates Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="datesCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months ‚Ä∫ <span id="datesCustomerDrilldownMonth">-</span></div>
                        <h3>Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeDatesCustomerDrilldown()">‚úï Close</button>
                </div>
                <div class="summary-row" id="datesCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Customer</th><th>Orders</th><th>Quantity</th><th>Revenue</th><th>P/L</th><th>Margin</th></tr></thead>
                        <tbody id="datesCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dates Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="datesOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months ‚Ä∫ <span id="datesOrdersBreadcrumbMonth">-</span> ‚Ä∫ <span id="datesOrdersBreadcrumbCustomer">-</span></div>
                        <h3>Orders Breakdown</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToDatesCustomers()">‚Üê Back</button>
                        <button class="close-btn" onclick="closeAllDatesDrilldowns()">‚úï Close All</button>
                    </div>
                </div>
                <div class="summary-row" id="datesOrdersSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part</th><th>PO #</th><th>Status</th><th>Ship/Due Date</th><th>Qty</th><th>Unit Price</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="datesOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOM EXPLORER PAGE -->
        <div id="bom" class="page">
            <div class="page-header">
                <div><h2 data-i18n="bom.title">BOM Explorer</h2></div>
            </div>
            <div class="info-banner info active">
                <span class="icon">‚ÑπÔ∏è¬è</span>
                <p><strong>Note:</strong> BOM data reflects current filter state in Google Sheets. If items appear missing, check that no filters are active in the source sheets.</p>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" placeholder="Search parts..." oninput="filterBomSelector()">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALL DATA PAGE -->
        <div id="all-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="allData.title">All Data (Raw)</h2><p data-i18n="allData.subtitle">Complete spreadsheet data - Columns A through AX</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="allDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label>Rows:</label>
                    <span id="allDataRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label>Columns:</label>
                    <span id="allDataColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="allDataClearFiltersBtn" onclick="clearAllTableFilters('allData')">üóëÔ∏è Clear Filters</button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="allDataGlobalSearch" placeholder="Global search..." oninput="filterAllDataTable()">
                <button class="toolbar-btn" onclick="exportAllDataToCSV()">üì• Export</button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="allDataTable">
                        <thead><tr id="allDataTableHeader"></tr></thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // INTERNATIONALIZATION
        // ============================================================
        const translations = {
            en: {
                'logoSubtitle': 'Operations Dashboard',
                'nav.main': 'Main Dashboard',
                'nav.production': 'PRODUCTION',
                'nav.ordersData': 'Orders Data',
                'nav.ordersQueue': 'Need to Make',
                'nav.ordersStaged': 'Ready to Ship',
                'nav.ordersShipped': 'Shipped',
                'nav.inventory': 'Inventory',
                'nav.salesFinance': 'SALES & FINANCE',
                'nav.plOverview': 'P/L Overview',
                'nav.byPart': 'By Part Number',
                'nav.byCustomer': 'By Customer',
                'nav.byDate': 'By Date',
                'nav.billOfMaterials': 'BILL OF MATERIALS',
                'nav.bomExplorer': 'BOM Explorer',
                'nav.rawData': 'RAW DATA',
                'nav.allData': 'All Data',
                'allData.title': 'All Data (Raw)',
                'allData.subtitle': 'Complete spreadsheet data - Columns A through AX',
                'loading': 'Loading data from Google Sheets...',
                'main.title': 'Operations Dashboard',
                'main.subtitle': 'Real-time overview of Roll Tech manufacturing operations',
                'stats.needToMake': 'Need to Make',
                'stats.making': 'Making',
                'stats.readyToShip': 'Ready to Ship',
                'stats.urgent': 'Urgent',
                'stats.totalUnits': 'Total Units',
                'stats.monthRevenue': 'Month Revenue',
                'stats.monthPL': 'Month P/L',
                'stats.missingParts': 'Missing Parts',
                'status.needToMake': 'Need to Make',
                'status.making': 'Making',
                'status.readyToShip': 'Ready to Ship',
                'status.shipped': 'Shipped',
                'status.urgent': 'URGENT',
                'dept.production': 'Production Planning',
                'dept.productionDesc': 'View orders to make, component status, and production queue',
                'dept.needToMake': 'Need to Make',
                'dept.units': 'Units',
                'dept.sales': 'Sales & P/L Analytics',
                'dept.salesDesc': 'Revenue, profitability, and customer analysis',
                'dept.revenue': 'Revenue',
                'dept.profit': 'Profit',
                'dept.orders': 'Orders',
                'dept.inventory': 'Inventory Management',
                'dept.inventoryDesc': 'Stock levels, reorder points, and material tracking',
                'chart.ordersByStatus': 'Orders by Status',
                'chart.upcomingDeadlines': 'Upcoming Deadlines (Next 14 Days)',
                'ordersData.title': 'All Orders Data',
                'ordersData.subtitle': 'Complete order database with all statuses',
                'ordersQueue.title': 'Orders Queue - Need to Make',
                'ordersQueue.subtitle': 'Orders pending production (Pending + Approved status)',
                'ordersStaged.title': 'Staged Orders - Ready to Ship',
                'ordersShipped.title': 'Shipped Orders History',
                'prod.missingMsg': 'orders have missing components.',
                'btn.backToDashboard': 'Back',
                'col.line': 'Line',
                'col.priority': 'Priority',
                'col.daysUntil': 'Days Until',
                'col.requestDate': 'Request Date',
                'col.dueDate': 'Due Date',
                'col.customer': 'Customer',
                'col.ifNum': 'IF #',
                'col.part': 'Part #',
                'col.qty': 'Qty',
                'col.packaging': 'Packaging',
                'col.tire': 'Tire',
                'col.hub': 'Hub',
                'col.hubMold': 'Hub Mold',
                'col.bearings': 'Bearings',
                'col.status': 'Status',
                'col.assigned': 'Assigned To',
                'col.shippedDate': 'Shipped Date',
                'col.revenue': 'Revenue',
                'col.pl': 'P/L',
                'missing': 'Missing',
                'sales.title': 'P/L Overview',
                'inv.title': 'Inventory Management',
                'bom.title': 'BOM Explorer',
                'col.weight': 'Weight',
                'col.dimensions': 'Dimensions',
                'col.palletNum': 'Pallet #',
                'col.partsPerPallet': 'Parts/Pallet',
                'pallet.title': 'Pallet Pictures',
                'pallet.noPictures': 'No pallet pictures found for this order.',
                'pallet.clickToView': 'Click to view full size',
                'pallet.weight': 'Weight (lbs)',
                'pallet.dimensions': 'Dimensions (in)',
                'pallet.pallets': 'Pallets',
                'pallet.totalWeight': 'Total Weight'
            },
            es: {
                'logoSubtitle': 'Panel de Operaciones',
                'nav.main': 'Panel Principal',
                'nav.production': 'PRODUCCI√ìN',
                'nav.ordersData': 'Datos de √ìrdenes',
                'nav.ordersQueue': 'Por Fabricar',
                'nav.ordersStaged': 'Listo para Enviar',
                'nav.ordersShipped': 'Enviados',
                'nav.inventory': 'Inventario',
                'nav.salesFinance': 'VENTAS Y FINANZAS',
                'nav.plOverview': 'Resumen P/L',
                'nav.byPart': 'Por N√∫mero de Parte',
                'nav.byCustomer': 'Por Cliente',
                'nav.byDate': 'Por Fecha',
                'nav.billOfMaterials': 'LISTA DE MATERIALES',
                'nav.bomExplorer': 'Explorador BOM',
                'nav.rawData': 'DATOS CRUDOS',
                'nav.allData': 'Todos los Datos',
                'allData.title': 'Todos los Datos (Crudo)',
                'allData.subtitle': 'Datos completos de la hoja - Columnas A hasta AX',
                'loading': 'Cargando datos de Google Sheets...',
                'main.title': 'Panel de Operaciones',
                'main.subtitle': 'Vista en tiempo real de las operaciones de manufactura',
                'stats.needToMake': 'Por Fabricar',
                'stats.making': 'Fabricando',
                'stats.readyToShip': 'Listo para Enviar',
                'stats.urgent': 'Urgente',
                'stats.totalUnits': 'Unidades Totales',
                'stats.monthRevenue': 'Ingresos del Mes',
                'stats.monthPL': 'P/L del Mes',
                'stats.missingParts': 'Partes Faltantes',
                'status.needToMake': 'Por Fabricar',
                'status.making': 'Fabricando',
                'status.readyToShip': 'Listo para Enviar',
                'status.shipped': 'Enviado',
                'status.urgent': 'URGENTE',
                'dept.production': 'Planificaci√≥n de Producci√≥n',
                'dept.productionDesc': 'Ver √≥rdenes a fabricar y estado de componentes',
                'dept.needToMake': 'Por Fabricar',
                'dept.units': 'Unidades',
                'dept.sales': 'Ventas y An√°lisis P/L',
                'dept.salesDesc': 'Ingresos, rentabilidad y an√°lisis de clientes',
                'dept.revenue': 'Ingresos',
                'dept.profit': 'Ganancia',
                'dept.orders': 'Pedidos',
                'dept.inventory': 'Gesti√≥n de Inventario',
                'dept.inventoryDesc': 'Niveles de stock y seguimiento de materiales',
                'chart.ordersByStatus': '√ìrdenes por Estado',
                'chart.upcomingDeadlines': 'Pr√≥ximos Vencimientos (14 D√≠as)',
                'ordersData.title': 'Todos los Datos de √ìrdenes',
                'ordersData.subtitle': 'Base de datos completa de √≥rdenes',
                'ordersQueue.title': 'Cola de √ìrdenes - Por Fabricar',
                'ordersQueue.subtitle': '√ìrdenes pendientes de producci√≥n',
                'ordersStaged.title': '√ìrdenes en Staging - Listas para Enviar',
                'ordersShipped.title': 'Historial de √ìrdenes Enviadas',
                'prod.missingMsg': '√≥rdenes tienen componentes faltantes.',
                'btn.backToDashboard': 'Volver',
                'col.line': 'L√≠nea',
                'col.priority': 'Prioridad',
                'col.daysUntil': 'D√≠as Restantes',
                'col.requestDate': 'Fecha de Solicitud',
                'col.dueDate': 'Fecha de Entrega',
                'col.customer': 'Cliente',
                'col.ifNum': 'IF #',
                'col.part': 'Parte #',
                'col.qty': 'Cant',
                'col.packaging': 'Empaque',
                'col.tire': 'Llanta',
                'col.hub': 'Hub',
                'col.hubMold': 'Molde del Hub',
                'col.bearings': 'Baleros',
                'col.status': 'Estado',
                'col.assigned': 'Asignado a',
                'col.shippedDate': 'Fecha de Env√≠o',
                'col.revenue': 'Ingresos',
                'col.pl': 'P/L',
                'missing': 'Faltante',
                'sales.title': 'Resumen P/L',
                'inv.title': 'Gesti√≥n de Inventario',
                'bom.title': 'Explorador BOM',
                'col.weight': 'Peso',
                'col.dimensions': 'Dimensiones',
                'col.palletNum': 'Paleta #',
                'col.partsPerPallet': 'Partes/Paleta',
                'pallet.title': 'Fotos de Paletas',
                'pallet.noPictures': 'No hay fotos de paletas para esta orden.',
                'pallet.clickToView': 'Clic para ver tama√±o completo',
                'pallet.weight': 'Peso (lbs)',
                'pallet.dimensions': 'Dimensiones (pulg)',
                'pallet.pallets': 'Paletas',
                'pallet.totalWeight': 'Peso Total'
            }
        };
        
        let currentLang = 'en';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langES').classList.toggle('active', lang === 'es');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.getElementById('logoSubtitle').textContent = translations[lang]['logoSubtitle'];
            // Re-render current page
            if (currentPage.startsWith('orders-')) {
                if (currentPage === 'orders-data') updateOrdersDataPage();
                else if (currentPage === 'orders-queue') updateOrdersQueuePage();
                else if (currentPage === 'orders-staged') updateOrdersStagedPage();
                else if (currentPage === 'orders-shipped') updateOrdersShippedPage();
            } else if (currentPage === 'inventory') updateInventoryPage();
            else if (currentPage === 'main') updateMainDashboard();
        }
        
        function t(key) { return translations[currentLang][key] || key; }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const MAIN_DATA_GID = '290032634';
        const FUSION_EXPORT_GID = '1805754553';
        const PROD_DATA_TOTALS_GID = '148810546';
        const CONFIG_GID = '912029812';
        const PALLET_PICTURES_GID = '1879462508';
        
        const COL = {
            CATEGORY: 'Category',
            REQUEST_DATE: 'Date of Request',
            PRIORITY: 'Priority Level',
            URGENT: 'Urgent Override',
            LINE: 'Line',
            CUSTOMER: 'Customer',
            IF_NUM: 'IF #',
            PART: 'Part #',
            QTY: 'Order Qty',
            PACKAGING: 'Packaging (tipo de empaquetado)',
            TIRE: 'Tire',
            HUB: 'Hub',
            HUB_MOLD: 'Hub Mold',
            BEARINGS: 'Bearings',
            ASSIGNED: 'Assigned to',
            STATUS: 'Work order Internal Status',
            FUSION_STATUS: 'IF Status in Fusion',
            DAYS_UNTIL: 'Days until promise date',
            SHIPPED_DATE: 'Shipped Date',
            REQUESTED_DATE: 'Requested Completion Date',
            REVENUE: 'Revenue',
            PL: 'P/L',
            PL_TOTAL: 'P/L total',
            VARIABLE_COST: 'Variable Cost',
            TOTAL_COST: 'Total Cost'
        };
        
        const COL_ALTS = {
            CATEGORY: ['Category', 'Categoria'],
            REQUEST_DATE: ['Date of Request', 'Fecha de Entrega', 'Requested Completion Date'],
            PRIORITY: ['Priority Level', 'Prioridad', 'Priority'],
            LINE: ['Line', 'Linea'],
            CUSTOMER: ['Customer', 'Cliente'],
            PART: ['Part #', 'Numero de parte', 'RT Part #', 'Part Number'],
            QTY: ['Order Qty', 'Cantidad de la orden', 'Qty', 'Quantity'],
            PACKAGING: ['Packaging (tipo de empaquetado)', 'tipo de empaquetado', 'Packaging'],
            TIRE: ['Tire', 'Tire (Llanta)', 'Llanta'],
            HUB: ['Hub', 'Centro', 'Cubo'],
            HUB_MOLD: ['Hub Mold', 'Hub Mold (Molde del Hub)', 'Molde del Hub'],
            BEARINGS: ['Bearings', 'Bearings (Balero)', 'Balero', 'Baleros'],
            ASSIGNED: ['Assigned to', 'Assigned to:', 'Assigned to: (Asignado a:)', 'Asignado a'],
            STATUS: ['Work order Internal Status', 'Work order Status', 'Status', 'Estado'],
            FUSION_STATUS: ['IF Status in Fusion', 'IF Status', 'Fusion Status'],
            DAYS_UNTIL: ['Days until promise date', 'Days until promise date.', 'Dias faltantes', 'Days until', 'Days remaining'],
            IF_NUM: ['IF #', 'IF#', 'IF Number'],
            PL: ['P/L', 'P/L total', 'PL', 'Profit/Loss'],
            REVENUE: ['Revenue', 'Total Sell Price', 'Sales']
        };
        
        function getVal(row, key) {
            const normalize = s => s.toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (row[COL[key]] !== undefined && row[COL[key]] !== null) return row[COL[key]];
            const alts = COL_ALTS[key];
            if (alts) {
                for (const alt of alts) {
                    if (row[alt] !== undefined && row[alt] !== null) return row[alt];
                }
            }
            const targetNames = alts ? [COL[key], ...alts] : [COL[key]];
            for (const target of targetNames) {
                if (!target) continue;
                const targetNorm = normalize(target);
                for (const k of Object.keys(row)) {
                    if (normalize(k) === targetNorm) return row[k];
                }
            }
            return null;
        }
        
        // State
        let allData = [];
        let allRawData = []; // Stores ALL columns A-AX for All Data page
        let allRawHeaders = []; // Column headers from spreadsheet
        let inventoryData = [];
        let palletData = []; // Stores pallet pictures data
        let bomFinalData = [], bomSubData = [], bomIndividualData = [];
        let currentBomTab = 'final';
        let config = {};
        let charts = {};
        let currentPage = 'main';
        let currentPalletOrder = null; // Currently viewed pallet order
        
        // Filter states for each page
        let ordersDataFilters = { categories: { rolltech: true, molding: true }, statuses: { pending: true, wip: true, staged: true, shipped: false } };
        let ordersQueueFilters = { categories: { rolltech: true, molding: true } };
        let ordersStagedFilters = { categories: { rolltech: true, molding: true } };
        let ordersShippedFilters = { categories: { rolltech: true, molding: true }, fromDate: null, toDate: null };
        let salesFilters = { categories: { rolltech: true, molding: true } };
        let datesFilters = { categories: { rolltech: true, molding: true }, fromDate: null, toDate: null };
        let partsFilters = { categories: { rolltech: true, molding: true }, fromDate: null, toDate: null, watchlistOnly: false };
        let customersFilters = { categories: { rolltech: true, molding: true }, fromDate: null, toDate: null, watchlistOnly: false };
        
        // Sort states
        let ordersDataSort = { field: 'daysUntil', asc: true };
        let ordersQueueSort = { field: 'daysUntil', asc: true };
        let ordersStagedSort = { field: 'customer', asc: true };
        let ordersShippedSort = { field: 'shippedDate', asc: false };
        let invFilter = 'all';
        let invSort = { field: 'partNumber', asc: true };
        let partsSort = { field: 'pl', asc: false };
        let customersSort = { field: 'pl', asc: false };
        let datesSort = { field: 'month', asc: false };
        let partsCustomerDrilldownSort = { field: 'pl', asc: false };
        let customersProductDrilldownSort = { field: 'pl', asc: false };
        let allDataSort = { field: null, asc: true };
        
        // Column Filter System State
        let columnFilters = {}; // { tableId: { columnKey: Set(selectedValues) } }
        let activeFilterDropdown = null; // { tableId, columnKey, allValues, selectedValues }
        
        // Drilldown state
        let currentDrilldownPart = null;
        let currentDrilldownCustomer = null;
        let currentDrilldownMonth = null;
        
        // Watchlist (localStorage persistence)
        let watchlistParts = [];
        let watchlistCustomers = [];
        try {
            watchlistParts = JSON.parse(localStorage.getItem('rolltech_watchlist_parts') || '[]');
            watchlistCustomers = JSON.parse(localStorage.getItem('rolltech_watchlist_customers') || '[]');
        } catch(e) { console.warn('Could not load watchlist from localStorage'); }

        // ============================================================
        // UTILITIES
        // ============================================================
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,%\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); return parseFloat(c) || 0; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const isEmpty = v => v === null || v === undefined || v === '';
        const isMissingComponent = v => v === null || v === undefined || v === '' || v === '-';
        const hasMissingCostData = row => isEmpty(row[COL.VARIABLE_COST]) || isEmpty(row[COL.TOTAL_COST]) || (isEmpty(row[COL.PL]) && isEmpty(row[COL.PL_TOTAL]));
        const getPLValue = row => { if (!isEmpty(row[COL.PL])) return parseNumber(row[COL.PL]); if (!isEmpty(row[COL.PL_TOTAL])) return parseNumber(row[COL.PL_TOTAL]); return 0; };
        
        // v5 Helper Functions
        const getAttributionDate = row => {
            const status = getStatus(row);
            if (status === 'shipped') return row[COL.SHIPPED_DATE];
            return row[COL.REQUESTED_DATE] || getVal(row, 'REQUEST_DATE');
        };
        
        const getMonthKey = dateStr => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr.substring(0, 7);
        };
        
        const formatMonthLabel = monthKey => {
            if (!monthKey) return '-';
            const [year, month] = monthKey.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(month) - 1]} ${year}`;
        };
        
        const getUnitPrice = row => {
            const unitPrice = parseNumber(row[COL.UNIT_PRICE]);
            if (unitPrice > 0) return unitPrice;
            const revenue = parseNumber(row[COL.REVENUE]);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? revenue / qty : 0;
        };
        
        const getProfitPerPart = row => {
            const pl = getPLValue(row);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? pl / qty : 0;
        };
        
        // Watchlist functions
        function isInWatchlist(type, value) {
            if (type === 'part') return watchlistParts.includes(value);
            if (type === 'customer') return watchlistCustomers.includes(value);
            return false;
        }
        
        function toggleWatchlistPart(part) {
            const idx = watchlistParts.indexOf(part);
            if (idx > -1) watchlistParts.splice(idx, 1);
            else watchlistParts.push(part);
            try { localStorage.setItem('rolltech_watchlist_parts', JSON.stringify(watchlistParts)); } catch(e) {}
            updateSalesPartsPage();
        }
        
        function toggleWatchlistCustomer(customer) {
            const idx = watchlistCustomers.indexOf(customer);
            if (idx > -1) watchlistCustomers.splice(idx, 1);
            else watchlistCustomers.push(customer);
            try { localStorage.setItem('rolltech_watchlist_customers', JSON.stringify(watchlistCustomers)); } catch(e) {}
            updateSalesCustomersPage();
        }
        
        const getContributionBadge = margin => {
            if (margin < -10) return '<span class="badge" style="background:var(--danger);">CRITICAL</span>';
            if (margin < 0) return '<span class="badge" style="background:var(--warning);color:#1a202c;">LOW</span>';
            if (margin < 15) return '<span class="badge" style="background:var(--accent);">TARGET</span>';
            return '<span class="badge" style="background:var(--success);">PROFITABLE</span>';
        };
        
        const getCategory = row => {
            const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            return 'other';
        };
        
        // UPDATED: Uses FUSION_STATUS (Col G) as fallback when STATUS (Col H) is empty
        const getStatus = row => {
            // Check Work order Internal Status first (Column H)
            let status = (getVal(row, 'STATUS') || '').toLowerCase();
            
            // If STATUS is empty or unclear, use IF Status in Fusion (Column G) as fallback
            if (!status || status === '') {
                status = (getVal(row, 'FUSION_STATUS') || '').toLowerCase();
            }
            
            if (status.includes('pending') || status.includes('approved')) return 'pending';
            if (status.includes('staged')) return 'staged';
            if (status.includes('work in progress') || status.includes('wip')) return 'wip';
            if (status.includes('shipped') || status.includes('invoiced') || status.includes('to bill')) return 'shipped';
            return status;
        };
        
        // UPDATED: Uses translated labels
        const getStatusBadge = status => {
            const s = (status || '').toLowerCase();
            if (s.includes('shipped') || s === 'shipped') return `<span class="badge shipped">${t('status.shipped')}</span>`;
            if (s.includes('pending') || s.includes('approved') || s === 'pending') return `<span class="badge pending">${t('status.needToMake')}</span>`;
            if (s.includes('staged') || s === 'staged') return `<span class="badge staged">${t('status.readyToShip')}</span>`;
            if (s.includes('work in progress') || s.includes('wip') || s === 'wip') return `<span class="badge wip">${t('status.making')}</span>`;
            return `<span class="badge">${status || '-'}</span>`;
        };
        
        // UPDATED: Uses translated "URGENT" label
        const getPriorityBadge = (priority, urgent) => {
            const p = parseNumber(priority);
            const isUrgent = (urgent || '').toLowerCase() === 'urgent';
            if (isUrgent) return `<span class="badge urgent">${t('status.urgent')}</span>`;
            if (p === 1) return '<span class="badge priority-1">P1</span>';
            if (p === 2) return '<span class="badge priority-2">P2</span>';
            if (p === 3) return '<span class="badge priority-3">P3</span>';
            if (p === 4) return '<span class="badge priority-4">P4</span>';
            return `<span class="badge">P${p || '-'}</span>`;
        };
        
        const formatComponent = (value) => {
            if (isMissingComponent(value)) return `<span class="cell-missing">${t('missing')}</span>`;
            if (value === 'NA' || value === 'N/A') return `<span style="color:var(--text-secondary);">NA</span>`;
            return `<span class="cell-available">${value}</span>`;
        };

        // ============================================================
        // COLUMN FILTER SYSTEM
        // ============================================================
        function initTableFilters(tableId) {
            if (!columnFilters[tableId]) columnFilters[tableId] = {};
        }
        
        function createFilterHeader(tableId, columnKey, label, sortable = true) {
            initTableFilters(tableId);
            const isFiltered = columnFilters[tableId][columnKey] && columnFilters[tableId][columnKey].size > 0;
            const filteredClass = isFiltered ? 'filtered' : '';
            const filterIndicator = isFiltered ? ' üìã' : '';
            return `<th class="filter-th ${filteredClass}">
                <div class="filter-th-content">
                    <span>${label}${filterIndicator}</span>
                    <div class="filter-th-btns">
                        ${sortable ? `<button onclick="sortTableColumn('${tableId}', '${columnKey}')" title="Sort">‚Üï</button>` : ''}
                        <button onclick="openColumnFilter('${tableId}', '${columnKey}', this)" title="Filter">√¢‚Äì¬º</button>
                    </div>
                </div>
            </th>`;
        }
        
        function sortTableColumn(tableId, columnKey) {
            // Delegate to existing sort functions based on tableId
            switch(tableId) {
                case 'parts': sortPartsTable(columnKey); break;
                case 'customers': sortCustomersTable(columnKey); break;
                case 'ordersData': sortOrdersDataTable(columnKey); break;
                case 'ordersQueue': sortOrdersQueueTable(columnKey); break;
                case 'ordersStaged': sortOrdersStagedTable(columnKey); break;
                case 'ordersShipped': sortOrdersShippedTable(columnKey); break;
                case 'inventory': sortInvTable(columnKey); break;
                case 'dates': sortDatesTable(columnKey); break;
                case 'allData': sortAllDataTable(columnKey); break;
            }
        }
        
        function openColumnFilter(tableId, columnKey, buttonEl) {
            initTableFilters(tableId);
            const allValues = getUniqueValuesForColumn(tableId, columnKey);
            const currentFilter = columnFilters[tableId][columnKey];
            const selectedValues = currentFilter ? new Set(currentFilter) : new Set(allValues);
            
            activeFilterDropdown = { tableId, columnKey, allValues: [...allValues], selectedValues };
            
            const dropdown = document.getElementById('columnFilterDropdown');
            document.getElementById('filterDropdownTitle').textContent = `Filter: ${columnKey}`;
            document.getElementById('filterDropdownSearch').value = '';
            renderFilterValues(allValues, selectedValues);
            
            // Position dropdown near button
            const rect = buttonEl.getBoundingClientRect();
            dropdown.style.top = Math.min(rect.bottom + 5, window.innerHeight - 420) + 'px';
            dropdown.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
            dropdown.classList.add('active');
        }
        
        function closeFilterDropdown() {
            document.getElementById('columnFilterDropdown').classList.remove('active');
            activeFilterDropdown = null;
        }
        
        function renderFilterValues(values, selectedSet, searchTerm = '') {
            const list = document.getElementById('filterValuesList');
            const filtered = searchTerm ? values.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase())) : values;
            list.innerHTML = filtered.map(v => {
                const checked = selectedSet.has(v) ? 'checked' : '';
                const displayVal = v === '' ? '(empty)' : v;
                return `<div class="filter-value-item">
                    <input type="checkbox" id="fv_${encodeURIComponent(v)}" ${checked} onchange="toggleFilterValue('${encodeURIComponent(v)}')">
                    <label for="fv_${encodeURIComponent(v)}">${displayVal}</label>
                </div>`;
            }).join('');
        }
        
        function filterDropdownSearch() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value;
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function toggleFilterValue(encodedValue) {
            if (!activeFilterDropdown) return;
            const value = decodeURIComponent(encodedValue);
            if (activeFilterDropdown.selectedValues.has(value)) {
                activeFilterDropdown.selectedValues.delete(value);
            } else {
                activeFilterDropdown.selectedValues.add(value);
            }
        }
        
        function filterSelectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.add(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function filterDeselectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.delete(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function clearColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            delete columnFilters[tableId][columnKey];
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function applyColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey, allValues, selectedValues } = activeFilterDropdown;
            
            // If all selected, remove filter; otherwise save it
            if (selectedValues.size === allValues.length) {
                delete columnFilters[tableId][columnKey];
            } else if (selectedValues.size === 0) {
                // Don't allow empty filter - select all instead
                delete columnFilters[tableId][columnKey];
            } else {
                columnFilters[tableId][columnKey] = new Set(selectedValues);
            }
            
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function clearAllTableFilters(tableId) {
            columnFilters[tableId] = {};
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function updateClearAllButton(tableId) {
            const btnId = tableId + 'ClearFiltersBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hasFilters = columnFilters[tableId] && Object.keys(columnFilters[tableId]).length > 0;
                btn.classList.toggle('has-filters', hasFilters);
            }
        }
        
        function refreshTableAfterFilter(tableId) {
            switch(tableId) {
                case 'parts': updateSalesPartsPage(); break;
                case 'customers': updateSalesCustomersPage(); break;
                case 'ordersData': updateOrdersDataPage(); break;
                case 'ordersQueue': updateOrdersQueuePage(); break;
                case 'ordersStaged': updateOrdersStagedPage(); break;
                case 'ordersShipped': updateOrdersShippedPage(); break;
                case 'inventory': renderInvTable(); break;
                case 'dates': updateSalesDatesPage(); break;
                case 'allData': renderAllDataTable(); break;
            }
        }
        
        function passesColumnFilter(tableId, columnKey, value) {
            if (!columnFilters[tableId] || !columnFilters[tableId][columnKey]) return true;
            return columnFilters[tableId][columnKey].has(value);
        }
        
        function getUniqueValuesForColumn(tableId, columnKey) {
            const values = new Set();
            
            switch(tableId) {
                case 'parts':
                    return getUniquePartsColumnValues(columnKey);
                case 'customers':
                    return getUniqueCustomersColumnValues(columnKey);
                case 'ordersData':
                case 'ordersQueue':
                case 'ordersStaged':
                case 'ordersShipped':
                    return getUniqueOrdersColumnValues(tableId, columnKey);
                case 'inventory':
                    return getUniqueInventoryColumnValues(columnKey);
                case 'dates':
                    return getUniqueDatesColumnValues(columnKey);
                case 'allData':
                    return getUniqueAllDataColumnValues(columnKey);
            }
            return Array.from(values).sort();
        }
        
        function getUniquePartsColumnValues(columnKey) {
            const data = getFilteredPartsData();
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(partStats).forEach(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'part': values.add(part); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueCustomersColumnValues(columnKey) {
            const data = getFilteredCustomersData();
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(custStats).forEach(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'customer': values.add(customer); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueOrdersColumnValues(tableId, columnKey) {
            let data = allData;
            // Filter based on table type
            if (tableId === 'ordersQueue') data = data.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            else if (tableId === 'ordersStaged') data = data.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            else if (tableId === 'ordersShipped') data = data.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            else if (tableId === 'ordersData') data = data.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            
            const values = new Set();
            data.forEach(r => {
                switch(columnKey) {
                    case 'line': values.add(getVal(r, 'LINE') || '-'); break;
                    case 'priority': values.add(getVal(r, 'PRIORITY') || '-'); break;
                    case 'customer': values.add(getVal(r, 'CUSTOMER') || '-'); break;
                    case 'part': values.add(getVal(r, 'PART') || '-'); break;
                    case 'status': values.add(getStatus(r)); break;
                    case 'tire': values.add(isMissingComponent(getVal(r, 'TIRE')) ? 'Missing' : 'Available'); break;
                    case 'hub': values.add(isMissingComponent(getVal(r, 'HUB')) ? 'Missing' : 'Available'); break;
                    case 'bearings': values.add(isMissingComponent(getVal(r, 'BEARINGS')) ? 'Missing' : 'Available'); break;
                    case 'assigned': values.add(getVal(r, 'ASSIGNED') || '-'); break;
                    case 'packaging': values.add(getVal(r, 'PACKAGING') || '-'); break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueInventoryColumnValues(columnKey) {
            const values = new Set();
            inventoryData.forEach(i => {
                switch(columnKey) {
                    case 'product': values.add(i.product || '-'); break;
                    case 'partNumber': values.add(i.partNumber); break;
                    case 'fusionQty': values.add(String(i.fusionQty)); break;
                    case 'minimum': values.add(String(i.minimum)); break;
                    case 'manualTarget': values.add(String(i.manualTarget)); break;
                    case 'qtyNeeded': values.add(String(i.qtyNeeded)); break;
                    case 'partsToBeMade': values.add(String(i.partsToBeMade)); break;
                    case 'moldType': values.add(i.moldType || '-'); break;
                    case 'status':
                        const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                        const needsMake = i.partsToBeMade > 0;
                        values.add(isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK'));
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueDatesColumnValues(columnKey) {
            const data = getFilteredDatesData();
            const monthStats = {};
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, pl: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (getStatus(r) === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) monthStats[month].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(monthStats).forEach(([month, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'month': values.add(formatMonthLabel(month)); break;
                    case 'status': values.add(`${stats.shipped}/${stats.orders} Shipped`); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('columnFilterDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!dropdown.contains(e.target) && !e.target.closest('.filter-th-btns')) {
                    closeFilterDropdown();
                }
            }
        });

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function fetchSheetData(gid, captureHeaders = false) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const headers = json.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
            if (captureHeaders) allRawHeaders = headers.filter(h => h); // Store non-empty headers
            return json.table.rows.map(r => {
                const obj = {};
                headers.forEach((h, i) => { if (h && r.c && r.c[i]) obj[h] = r.c[i].f || r.c[i].v; });
                return obj;
            });
        }
        
        async function loadDashboard() {
            try {
                const raw = await fetchSheetData(MAIN_DATA_GID, true); // Pass true to capture headers
                allRawData = raw; // Store ALL raw data for All Data page
                allData = raw.filter(r => {
                    const cat = getCategory(r);
                    return (cat === 'rolltech' || cat === 'molding') && getVal(r, 'PART');
                });
                if (allData.length === 0) allData = raw.filter(r => getVal(r, 'PART'));
                
                loadInventoryData().catch(e => console.warn('Inventory load failed:', e));
                loadBOMData().catch(e => console.warn('BOM load failed:', e));
                fetchPalletData().catch(e => console.warn('Pallet data load failed:', e));
                
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${allData.length} orders<br>${now.toLocaleTimeString()}`;
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('main').classList.add('active');
                updateMainDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">‚ö†¬†¬è Error</h3><p>${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }
        
        async function loadInventoryData() {
            try {
                const fusionData = await fetchSheetData(FUSION_EXPORT_GID);
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                const prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum) {
                        prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            qtyNeeded: parseNumber(row['Quantity Needed']),
                            minimums: parseNumber(row['Minimums']),
                            manualTarget: parseNumber(row['Manual target']),
                            moldType: row['Mold type'] || '',
                            fusionInventory: parseNumber(row['Fusion Inventory']),
                            partsToBeMade: parseNumber(row['Parts to be made'])
                        };
                    }
                });
                const mergedData = [];
                const seenParts = new Set();
                fusionData.forEach(row => {
                    let partNum = (row['itemNumber'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (!partNum) return;
                    seenParts.add(partNum);
                    const prodData = prodTotalsMap[partNum] || {};
                    const fusionTarget = parseNumber(row['Target']);
                    mergedData.push({
                        partNumber: partNum,
                        product: prodData.product || '',
                        fusionQty: parseNumber(row['Real number value']),
                        minimum: prodData.minimums || fusionTarget || 0,
                        manualTarget: prodData.manualTarget || 0,
                        qtyNeeded: prodData.qtyNeeded || 0,
                        partsToBeMade: prodData.partsToBeMade || 0,
                        moldType: prodData.moldType || ''
                    });
                });
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum && !seenParts.has(partNum)) {
                        const data = prodTotalsMap[partNum];
                        mergedData.push({
                            partNumber: partNum,
                            product: data.product || '',
                            fusionQty: data.fusionInventory || 0,
                            minimum: data.minimums || 0,
                            manualTarget: data.manualTarget || 0,
                            qtyNeeded: data.qtyNeeded || 0,
                            partsToBeMade: data.partsToBeMade || 0,
                            moldType: data.moldType || ''
                        });
                    }
                });
                inventoryData = mergedData;
            } catch (e) { console.error('Inventory load error:', e); inventoryData = []; }
        }
        
        async function loadBOMData() {
            try {
                const configData = await fetchSheetData(CONFIG_GID);
                config = {};
                configData.forEach(row => {
                    if (row['Dashboard Name'] === 'P&L Dashboard' && row['GID Number']) {
                        config[row['Tab Name']] = { gid: row['GID Number'] };
                    }
                });
                if (config['BOM individual items Reference data']) bomIndividualData = await fetchSheetData(config['BOM individual items Reference data'].gid);
                if (config['BOM Sub assembly Reference data']) bomSubData = await fetchSheetData(config['BOM Sub assembly Reference data'].gid);
                if (config['BOM Final assembly Reference data']) bomFinalData = await fetchSheetData(config['BOM Final assembly Reference data'].gid);
            } catch (e) { console.warn('BOM load error:', e); }
        }
        
        async function fetchPalletData() {
            try {
                const data = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Raw pallet data first row keys:', data.length > 0 ? Object.keys(data[0]) : 'no data');
                console.log('Raw pallet data sample row:', data[0]);
                
                palletData = data.map(row => {
                    // Get all keys to find the right columns
                    const keys = Object.keys(row);
                    
                    // Find order number - try various patterns
                    let orderNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('order') && k.toLowerCase().includes('number')) {
                            orderNum = row[k];
                            break;
                        }
                    }
                    if (!orderNum) orderNum = row[keys[1]] || ''; // Fallback to column B
                    
                    // Find pallet number
                    let palletNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('pallet') && k.toLowerCase().includes('number')) {
                            palletNum = row[k];
                            break;
                        }
                    }
                    if (!palletNum) palletNum = row[keys[2]] || ''; // Fallback to column C
                    
                    // Find picture URL
                    let pictureUrl = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('picture') && !k.includes('2') && !k.includes('3') && !k.includes('4') && !k.includes('5')) {
                            pictureUrl = row[k];
                            break;
                        }
                    }
                    if (!pictureUrl) pictureUrl = row[keys[3]] || ''; // Fallback to column D
                    
                    // Find weight
                    let weight = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('weight')) {
                            weight = row[k];
                            break;
                        }
                    }
                    if (!weight) weight = row[keys[4]] || ''; // Fallback to column E
                    
                    // Find dimensions
                    let dims = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('dimension')) {
                            dims = row[k];
                            break;
                        }
                    }
                    if (!dims) dims = row[keys[5]] || ''; // Fallback to column F
                    
                    return {
                        orderNumber: String(orderNum).trim(),
                        palletNumber: palletNum,
                        pictureUrl: pictureUrl,
                        weight: weight,
                        dimensions: dims
                    };
                }).filter(p => p.orderNumber && p.orderNumber !== '');
                
                console.log('Pallet data loaded:', palletData.length, 'entries');
                if (palletData.length > 0) {
                    console.log('Sample parsed pallet:', palletData[0]);
                    // Log unique order numbers for debugging
                    const uniqueOrders = [...new Set(palletData.map(p => p.orderNumber))];
                    console.log('Unique order numbers in pallet data:', uniqueOrders.slice(0, 20));
                }
            } catch (e) { 
                console.error('Pallet data load error:', e); 
                palletData = []; 
            }
        }

        // ============================================================
        // NAVIGATION
        // ============================================================
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            currentPage = page;
            switch(page) {
                case 'main': updateMainDashboard(); break;
                case 'orders-data': updateOrdersDataPage(); break;
                case 'orders-queue': updateOrdersQueuePage(); break;
                case 'orders-staged': updateOrdersStagedPage(); break;
                case 'orders-shipped': updateOrdersShippedPage(); break;
                case 'inventory': updateInventoryPage(); break;
                case 'sales-overview': updateSalesOverview(); break;
                case 'sales-parts': updateSalesPartsPage(); break;
                case 'sales-customers': updateSalesCustomersPage(); break;
                case 'sales-dates': updateSalesDatesPage(); break;
                case 'bom': initBomExplorer(); break;
                case 'all-data': updateAllDataPage(); break;
            }
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }
        
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // ============================================================
        // ZOOM CONTROLS
        // ============================================================
        let currentZoom = 100;
        
        function setZoom(value) {
            value = parseInt(value);
            if (isNaN(value) || value < 50) value = 50;
            if (value > 200) value = 200;
            currentZoom = value;
            document.getElementById('zoomInput').value = value;
            const mainContent = document.querySelector('.main-content');
            mainContent.style.transform = `scale(${value / 100})`;
            mainContent.style.transformOrigin = 'top left';
            mainContent.style.width = `${10000 / value}%`;
            mainContent.classList.add('zoomed');
            // Save to localStorage
            try { localStorage.setItem('rolltech_zoom', value); } catch(e) {}
        }
        
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }
        
        function resetZoom() {
            setZoom(100);
        }
        
        function loadSavedZoom() {
            try {
                const saved = localStorage.getItem('rolltech_zoom');
                if (saved) {
                    setZoom(parseInt(saved));
                }
            } catch(e) {}
        }

        // ============================================================
        // MAIN DASHBOARD
        // ============================================================
        function updateMainDashboard() {
            const rollTechData = allData.filter(r => getCategory(r) === 'rolltech');
            const needToMakeOrders = rollTechData.filter(r => getStatus(r) === 'pending' || getStatus(r) === 'wip');
            const urgentOrders = needToMakeOrders.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent');
            const totalQty = needToMakeOrders.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthData = rollTechData.filter(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return false;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                return month === currentMonth;
            });
            const monthRevenue = monthData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const monthPL = monthData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            const missingComponents = needToMakeOrders.filter(r => {
                return isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
            }).length;
            
            document.getElementById('qsNeedToMake').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('qsUrgentOrders').textContent = formatNumber(urgentOrders.length);
            document.getElementById('qsUrgentOrders').className = `value ${urgentOrders.length > 0 ? 'negative' : ''}`;
            document.getElementById('qsTotalQty').textContent = formatNumber(totalQty);
            document.getElementById('qsMonthlyRevenue').textContent = formatCurrency(monthRevenue);
            document.getElementById('qsMonthlyPL').textContent = formatCurrency(monthPL);
            document.getElementById('qsMonthlyPL').className = `value ${monthPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('qsMissingComponents').textContent = formatNumber(missingComponents);
            
            document.getElementById('deptProdOrders').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('deptProdUnits').textContent = formatNumber(totalQty);
            document.getElementById('deptProdUrgent').textContent = formatNumber(urgentOrders.length);
            
            const salesTotal = rollTechData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const salesPL = rollTechData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            document.getElementById('deptSalesRev').textContent = formatCurrency(salesTotal);
            document.getElementById('deptSalesPL').textContent = formatCurrency(salesPL);
            document.getElementById('deptSalesPL').className = `value ${salesPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('deptSalesOrders').textContent = formatNumber(rollTechData.length);
            
            renderMainStatusChart(rollTechData.filter(r => getStatus(r) !== 'shipped'));
            renderMainDeadlineChart(needToMakeOrders);
        }
        
        function renderMainStatusChart(data) {
            const statusCounts = { pending: 0, wip: 0, staged: 0 };
            data.forEach(r => { const s = getStatus(r); if (statusCounts[s] !== undefined) statusCounts[s]++; });
            const labels = [t('status.needToMake'), t('status.making'), t('status.readyToShip')];
            const values = [statusCounts.pending, statusCounts.wip, statusCounts.staged];
            const colors = ['#d69e2e', '#319795', '#4299e1'];
            if (charts.mainStatus) charts.mainStatus.destroy();
            charts.mainStatus = new Chart(document.getElementById('mainStatusChart'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 11 } } } } }
            });
        }
        
        function renderMainDeadlineChart(data) {
            const deadlines = {};
            for (let i = -7; i <= 14; i++) deadlines[i] = 0;
            data.forEach(r => { const days = parseNumber(getVal(r, 'DAYS_UNTIL')); if (days >= -7 && days <= 14) deadlines[days]++; });
            const labels = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return `${Math.abs(n)}d late`; if (n === 0) return 'Today'; return `${n}d`; });
            const values = Object.values(deadlines);
            const colors = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return 'rgba(229,62,62,0.8)'; if (n <= 2) return 'rgba(214,158,46,0.8)'; return 'rgba(49,130,206,0.8)'; });
            if (charts.mainDeadline) charts.mainDeadline.destroy();
            charts.mainDeadline = new Chart(document.getElementById('mainDeadlineChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // ============================================================
        // ORDERS DATA PAGE (All orders with status filters)
        // ============================================================
        function toggleOrdersDataCategory(cat) {
            ordersDataFilters.categories[cat] = !ordersDataFilters.categories[cat];
            if (!ordersDataFilters.categories.rolltech && !ordersDataFilters.categories.molding) { ordersDataFilters.categories[cat] = true; return; }
            document.getElementById('ordersDataBtnRollTech').classList.toggle('active', ordersDataFilters.categories.rolltech);
            document.getElementById('ordersDataBtnMolding').classList.toggle('active', ordersDataFilters.categories.molding);
            updateOrdersDataPage();
        }
        
        function toggleOrdersDataStatus(status) {
            ordersDataFilters.statuses[status] = !ordersDataFilters.statuses[status];
            document.getElementById(`ordersDataStatus${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.toggle('active', ordersDataFilters.statuses[status]);
            updateOrdersDataPage();
        }
        
        function updateOrdersDataPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersDataFilters.categories[cat]) return false;
                if (!ordersDataFilters.statuses[status]) return false;
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const needToMake = data.filter(r => getStatus(r) === 'pending').length;
            const making = data.filter(r => getStatus(r) === 'wip').length;
            const readyToShip = data.filter(r => getStatus(r) === 'staged').length;
            
            document.getElementById('ordersDataTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersDataTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersDataNeedToMake').textContent = formatNumber(needToMake);
            document.getElementById('ordersDataMaking').textContent = formatNumber(making);
            document.getElementById('ordersDataReadyToShip').textContent = formatNumber(readyToShip);
            document.getElementById('ordersDataLastUpdated').textContent = new Date().toLocaleTimeString();
            
            renderOrdersDataTableHeader();
            renderOrdersDataTable(data);
        }
        
        function renderOrdersDataTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'tire', label: t('col.tire') }, { key: 'hub', label: t('col.hub') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'status', label: t('col.status') }
            ];
            document.getElementById('ordersDataTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersDataTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersDataTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersDataTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersDataTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isMissing = isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
                return `<tr style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>
                    <td class="${daysClass}">${daysUntil || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td>${formatComponent(getVal(r, 'TIRE'))}</td>
                    <td>${formatComponent(getVal(r, 'HUB'))}</td>
                    <td>${formatComponent(getVal(r, 'BEARINGS'))}</td>
                    <td>${getStatusBadge(getStatus(r))}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersDataTable(field) {
            if (ordersDataSort.field === field) ordersDataSort.asc = !ordersDataSort.asc;
            else { ordersDataSort.field = field; ordersDataSort.asc = true; }
            updateOrdersDataPage();
        }
        
        function filterOrdersDataTable() { updateOrdersDataPage(); }
        
        function exportOrdersDataToCSV() {
            const data = allData.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            const headers = ['Line','Priority','Days Until','Customer','Part','Qty','Tire','Hub','Bearings','Status'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'BEARINGS'),getStatus(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_data.csv');
        }

        // ============================================================
        // ORDERS QUEUE PAGE (Need to Make = Pending + Approved)
        // ============================================================
        function toggleOrdersQueueCategory(cat) {
            ordersQueueFilters.categories[cat] = !ordersQueueFilters.categories[cat];
            if (!ordersQueueFilters.categories.rolltech && !ordersQueueFilters.categories.molding) { ordersQueueFilters.categories[cat] = true; return; }
            document.getElementById('ordersQueueBtnRollTech').classList.toggle('active', ordersQueueFilters.categories.rolltech);
            document.getElementById('ordersQueueBtnMolding').classList.toggle('active', ordersQueueFilters.categories.molding);
            updateOrdersQueuePage();
        }
        
        function updateOrdersQueuePage() {
            // Queue = "pending" + "wip" statuses (orders still being worked on)
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersQueueFilters.categories[cat] && (status === 'pending' || status === 'wip');
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const urgentCount = data.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent').length;
            const dueWeek = data.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; });
            const dueWeekQty = dueWeek.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const componentsReady = data.filter(r => getCategory(r) !== 'rolltech' || (!isMissingComponent(getVal(r,'TIRE')) && !isMissingComponent(getVal(r,'HUB')) && !isMissingComponent(getVal(r,'BEARINGS')))).length;
            const missingOrders = data.filter(r => getCategory(r) === 'rolltech' && (isMissingComponent(getVal(r,'TIRE')) || isMissingComponent(getVal(r,'HUB')) || isMissingComponent(getVal(r,'BEARINGS'))));
            
            document.getElementById('ordersQueueTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersQueueTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersQueueUrgentCount').textContent = formatNumber(urgentCount);
            document.getElementById('ordersQueueDueWeek').textContent = formatNumber(dueWeek.length);
            document.getElementById('ordersQueueDueWeekUnits').textContent = `${formatNumber(dueWeekQty)} units`;
            document.getElementById('ordersQueueComponentsReady').textContent = formatNumber(componentsReady);
            document.getElementById('ordersQueueLastUpdated').textContent = new Date().toLocaleTimeString();
            
            if (missingOrders.length > 0) {
                document.getElementById('ordersQueueMissingCount').textContent = missingOrders.length;
                document.getElementById('ordersQueueMissingBanner').classList.add('active');
            } else {
                document.getElementById('ordersQueueMissingBanner').classList.remove('active');
            }
            
            renderOrdersQueueTableHeader();
            renderOrdersQueueTable(data);
        }
        
        function renderOrdersQueueTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'dueDate', label: t('col.dueDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'ifNum', label: t('col.ifNum') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }, { key: 'tire', label: t('col.tire') },
                { key: 'hub', label: t('col.hub') }, { key: 'hubMold', label: t('col.hubMold') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'assigned', label: t('col.assigned') }
            ];
            document.getElementById('ordersQueueTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersQueueTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersQueueTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersQueueSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'dueDate': va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    default: va = getVal(a, ordersQueueSort.field) || ''; vb = getVal(b, ordersQueueSort.field) || '';
                }
                if (typeof va === 'string') return ordersQueueSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersQueueSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersQueueSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'LINE') || '').toString().includes(search));
            }
            
            document.getElementById('ordersQueueTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersQueueTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isRollTech = getCategory(r) === 'rolltech';
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                // For Molding items, show "N/A" instead of checking for missing components
                const formatComponentCell = (value, field) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                return `<tr style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>
                    <td class="${daysClass}">${daysUntil || '-'}</td>
                    <td>${r[COL.REQUESTED_DATE] || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td>${getVal(r, 'IF_NUM') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td>${getVal(r, 'PACKAGING') || '-'}</td>
                    <td>${formatComponentCell(getVal(r, 'TIRE'), 'TIRE')}</td>
                    <td>${formatComponentCell(getVal(r, 'HUB'), 'HUB')}</td>
                    <td>${getVal(r, 'HUB_MOLD') || '-'}</td>
                    <td>${formatComponentCell(getVal(r, 'BEARINGS'), 'BEARINGS')}</td>
                    <td>${getVal(r, 'ASSIGNED') || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersQueueTable(field) {
            if (ordersQueueSort.field === field) ordersQueueSort.asc = !ordersQueueSort.asc;
            else { ordersQueueSort.field = field; ordersQueueSort.asc = true; }
            updateOrdersQueuePage();
        }
        
        function filterOrdersQueueTable() { updateOrdersQueuePage(); }
        
        function exportOrdersQueueToCSV() {
            const data = allData.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            const headers = ['Line','Priority','Days Until','Request Date','Customer','IF#','Part','Qty','Packaging','Tire','Hub','Hub Mold','Bearings','Assigned'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'REQUEST_DATE'),getVal(r,'CUSTOMER'),getVal(r,'IF_NUM'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'HUB_MOLD'),getVal(r,'BEARINGS'),getVal(r,'ASSIGNED')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_queue.csv');
        }

        // ============================================================
        // ORDERS STAGED PAGE (Ready to Ship)
        // ============================================================
        function toggleOrdersStagedCategory(cat) {
            ordersStagedFilters.categories[cat] = !ordersStagedFilters.categories[cat];
            if (!ordersStagedFilters.categories.rolltech && !ordersStagedFilters.categories.molding) { ordersStagedFilters.categories[cat] = true; return; }
            document.getElementById('ordersStagedBtnRollTech').classList.toggle('active', ordersStagedFilters.categories.rolltech);
            document.getElementById('ordersStagedBtnMolding').classList.toggle('active', ordersStagedFilters.categories.molding);
            updateOrdersStagedPage();
        }
        
        function updateOrdersStagedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersStagedFilters.categories[cat] && status === 'staged';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const avgValue = data.length > 0 ? totalRevenue / data.length : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersStagedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersStagedTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersStagedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersStagedAvgValue').textContent = formatCurrency(avgValue);
            document.getElementById('ordersStagedCustomers').textContent = formatNumber(customers);
            
            renderOrdersStagedTableHeader();
            renderOrdersStagedTable(data);
        }
        
        function renderOrdersStagedTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }, { key: 'revenue', label: t('col.revenue') },
                { key: 'dueDate', label: t('col.dueDate') }, { key: 'daysUntil', label: t('col.daysUntil') },
                { key: 'weight', label: t('col.weight') }, { key: 'dimensions', label: t('col.dimensions') },
                { key: 'assigned', label: t('col.assigned') }, { key: 'pallets', label: 'üì¶' }
            ];
            document.getElementById('ordersStagedTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersStagedTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersStagedTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                const lineA = getVal(a, 'LINE');
                const lineB = getVal(b, 'LINE');
                const palletA = getPalletDataForOrder(lineA);
                const palletB = getPalletDataForOrder(lineB);
                switch(ordersStagedSort.field) {
                    case 'line': va = parseNumber(lineA); vb = parseNumber(lineB); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'dueDate': 
                        va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); 
                        vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); 
                        break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'weight': 
                        va = palletA.length > 0 ? palletA.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        vb = palletB.length > 0 ? palletB.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        break;
                    case 'pallets':
                        va = palletA.length;
                        vb = palletB.length;
                        break;
                    default: va = getVal(a, ordersStagedSort.field) || ''; vb = getVal(b, ordersStagedSort.field) || '';
                }
                if (typeof va === 'string') return ordersStagedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersStagedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersStagedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersStagedTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersStagedTableBody');
            
            // Debug: log line numbers being rendered
            const lineNums = sorted.map(r => getVal(r, 'LINE')).filter(Boolean);
            console.log('Staged orders Line numbers:', lineNums.slice(0, 20));
            
            tbody.innerHTML = sorted.map(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const palletIndicator = hasPallets ? `<span class="pallet-indicator" title="${pallets.length} ${t('pallet.pallets').toLowerCase()}">üì∑ ${pallets.length}</span>` : '-';
                const clickHandler = hasPallets ? `onclick="showPalletPictures('${line}')" style="cursor:pointer;"` : '';
                return `<tr class="${hasPallets ? 'clickable-row' : ''}" ${clickHandler}>
                <td><strong>${line || '-'}</strong></td>
                <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                <td>${getVal(r, 'PACKAGING') || '-'}</td>
                <td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>
                <td>${r[COL.REQUESTED_DATE] || '-'}</td>
                <td class="${daysClass}">${daysUntil || '-'}</td>
                <td>${hasPallets ? formatNumber(totalWeight) + ' lbs' : '-'}</td>
                <td>${firstDimensions}</td>
                <td>${getVal(r, 'ASSIGNED') || '-'}</td>
                <td>${palletIndicator}</td>
            </tr>`;
            }).join('');
        }
        
        // Get pallet data for a specific order (by Line number)
        function getPalletDataForOrder(lineNum) {
            if (!lineNum || !palletData || palletData.length === 0) return [];
            const lineStr = String(lineNum).trim();
            const matches = palletData.filter(p => String(p.orderNumber).trim() === lineStr);
            if (matches.length > 0) {
                console.log(`Found ${matches.length} pallets for line ${lineStr}`);
            }
            return matches;
        }
        
        // Show pallet pictures modal for an order (using Line number)
        function showPalletPictures(lineNum) {
            const pallets = getPalletDataForOrder(lineNum);
            if (pallets.length === 0) return;
            
            currentPalletOrder = lineNum;
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            
            document.getElementById('palletDrilldownOrder').textContent = `#${lineNum}`;
            
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            document.getElementById('palletSummary').innerHTML = `
                <div class="summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${pallets.length}</div></div>
                <div class="summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Simple table with pallet # and clickable link
            const gallery = document.getElementById('palletGallery');
            gallery.innerHTML = `
                <table class="data-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>${t('col.palletNum')}</th>
                            <th>${t('pallet.weight')}</th>
                            <th>${t('pallet.dimensions')}</th>
                            <th>Picture Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pallets.map((p, idx) => `
                            <tr>
                                <td><strong>${p.palletNumber || (idx + 1)}</strong></td>
                                <td>${p.weight || '-'}</td>
                                <td>${p.dimensions || '-'}</td>
                                <td>${p.pictureUrl ? `<a href="${p.pictureUrl}" target="_blank" style="color:var(--accent);">üì∑ View Photo</a>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('palletDrilldown').classList.add('active');
            document.getElementById('palletDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePalletDrilldown() {
            document.getElementById('palletDrilldown').classList.remove('active');
            currentPalletOrder = null;
        }
        
        function openImageModal(imgUrl) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = imgUrl;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function sortOrdersStagedTable(field) {
            if (ordersStagedSort.field === field) ordersStagedSort.asc = !ordersStagedSort.asc;
            else { ordersStagedSort.field = field; ordersStagedSort.asc = true; }
            updateOrdersStagedPage();
        }
        
        function filterOrdersStagedTable() { updateOrdersStagedPage(); }
        
        function exportOrdersStagedToCSV() {
            const data = allData.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            const headers = ['Line','Customer','Part','Qty','Packaging','Revenue','Due Date','Days Until','Weight (lbs)','Dimensions','Assigned','Pallets'];
            const rows = data.map(r => {
                const line = getVal(r,'LINE');
                const pallets = getPalletDataForOrder(line);
                const totalWeight = pallets.length > 0 ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : '';
                const dimensions = pallets.length > 0 && pallets[0].dimensions ? pallets[0].dimensions : '';
                return [line,getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),r[COL.REVENUE],r[COL.REQUESTED_DATE],getVal(r,'DAYS_UNTIL'),totalWeight,dimensions,getVal(r,'ASSIGNED'),pallets.length].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
            });
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_staged.csv');
        }

        // ============================================================
        // ORDERS SHIPPED PAGE (History with date filter)
        // ============================================================
        function toggleOrdersShippedCategory(cat) {
            ordersShippedFilters.categories[cat] = !ordersShippedFilters.categories[cat];
            if (!ordersShippedFilters.categories.rolltech && !ordersShippedFilters.categories.molding) { ordersShippedFilters.categories[cat] = true; return; }
            document.getElementById('ordersShippedBtnRollTech').classList.toggle('active', ordersShippedFilters.categories.rolltech);
            document.getElementById('ordersShippedBtnMolding').classList.toggle('active', ordersShippedFilters.categories.molding);
            updateOrdersShippedPage();
        }
        
        function applyShippedDateFilter() {
            const fromInput = document.getElementById('ordersShippedFromDate').value;
            const toInput = document.getElementById('ordersShippedToDate').value;
            ordersShippedFilters.fromDate = fromInput ? new Date(fromInput) : null;
            ordersShippedFilters.toDate = toInput ? new Date(toInput) : null;
            updateOrdersShippedPage();
        }
        
        function resetShippedDateFilter() {
            document.getElementById('ordersShippedFromDate').value = '';
            document.getElementById('ordersShippedToDate').value = '';
            ordersShippedFilters.fromDate = null;
            ordersShippedFilters.toDate = null;
            updateOrdersShippedPage();
        }
        
        function updateOrdersShippedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersShippedFilters.categories[cat] || status !== 'shipped') return false;
                
                if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                    const dateStr = r[COL.SHIPPED_DATE];
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (ordersShippedFilters.fromDate && rowDate < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && rowDate > ordersShippedFilters.toDate) return false;
                }
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100).toFixed(1) : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersShippedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersShippedTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersShippedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersShippedPL').textContent = formatCurrency(totalPL);
            document.getElementById('ordersShippedPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('ordersShippedMargin').textContent = `Margin: ${margin}%`;
            document.getElementById('ordersShippedCustomers').textContent = formatNumber(customers);
            
            renderOrdersShippedTableHeader();
            renderOrdersShippedTable(data);
        }
        
        function renderOrdersShippedTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'shippedDate', label: t('col.shippedDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'part', label: t('col.part') },
                { key: 'qty', label: t('col.qty') }, { key: 'revenue', label: t('col.revenue') },
                { key: 'pl', label: t('col.pl') }
            ];
            document.getElementById('ordersShippedTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersShippedTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersShippedTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersShippedTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersShippedTableBody');
            tbody.innerHTML = sorted.map(r => {
                const pl = getPLValue(r);
                return `<tr>
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${r[COL.SHIPPED_DATE] || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersShippedTable(field) {
            if (ordersShippedSort.field === field) ordersShippedSort.asc = !ordersShippedSort.asc;
            else { ordersShippedSort.field = field; ordersShippedSort.asc = true; }
            updateOrdersShippedPage();
        }
        
        function filterOrdersShippedTable() { updateOrdersShippedPage(); }
        
        function exportOrdersShippedToCSV() {
            const data = allData.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            const headers = ['Line','Shipped Date','Customer','Part','Qty','Revenue','P/L'];
            const rows = data.map(r => [getVal(r,'LINE'),r[COL.SHIPPED_DATE],getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_shipped.csv');
        }

        // ============================================================
        // UTILITY FUNCTION
        // ============================================================
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ============================================================
        // INVENTORY PAGE
        // ============================================================
        function setInvFilter(filter) {
            invFilter = filter;
            document.getElementById('invFilterAll').classList.toggle('active', filter === 'all');
            document.getElementById('invFilterLow').classList.toggle('active', filter === 'low');
            document.getElementById('invFilterNeeded').classList.toggle('active', filter === 'needed');
            renderInvTable();
        }
        
        function updateInventoryPage() {
            const lowStock = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            const needsProduction = inventoryData.filter(i => i.partsToBeMade > 0);
            const okStock = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
            const productTypes = [...new Set(inventoryData.map(i => i.product).filter(p => p))];
            
            document.getElementById('invStatTotal').textContent = formatNumber(inventoryData.length);
            document.getElementById('invStatTypes').textContent = `${productTypes.length} product types`;
            document.getElementById('invStatLow').textContent = formatNumber(lowStock.length);
            document.getElementById('invStatNeeded').textContent = formatNumber(needsProduction.length);
            document.getElementById('invStatOk').textContent = formatNumber(okStock.length);
            
            setInvFilter('all');
        }
        
        function sortInvTable(field) {
            if (invSort.field === field) invSort.asc = !invSort.asc;
            else { invSort.field = field; invSort.asc = true; }
            renderInvTable();
        }
        
        function renderInvTableHeader() {
            document.getElementById('invTableHeader').innerHTML = 
                createFilterHeader('inventory', 'product', 'Product Type') +
                createFilterHeader('inventory', 'partNumber', 'Part Number') +
                createFilterHeader('inventory', 'fusionQty', 'Fusion Qty') +
                createFilterHeader('inventory', 'minimum', 'Minimum') +
                createFilterHeader('inventory', 'manualTarget', 'Manual Target') +
                createFilterHeader('inventory', 'qtyNeeded', 'Qty Needed') +
                createFilterHeader('inventory', 'partsToBeMade', 'Parts to Make') +
                createFilterHeader('inventory', 'moldType', 'Mold Type') +
                createFilterHeader('inventory', 'status', 'Status');
        }
        
        function renderInvTable() {
            renderInvTableHeader();
            let data = [...inventoryData];
            const searchTerm = (document.getElementById('invSearch')?.value || '').toLowerCase();
            
            if (invFilter === 'low') data = data.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            else if (invFilter === 'needed') data = data.filter(i => i.partsToBeMade > 0);
            
            if (searchTerm) {
                data = data.filter(i => (i.partNumber || '').toLowerCase().includes(searchTerm) || (i.product || '').toLowerCase().includes(searchTerm) || (i.moldType || '').toLowerCase().includes(searchTerm));
            }
            
            // Apply column filters
            data = data.filter(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const status = isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK');
                
                if (!passesColumnFilter('inventory', 'product', i.product || '-')) return false;
                if (!passesColumnFilter('inventory', 'partNumber', i.partNumber)) return false;
                if (!passesColumnFilter('inventory', 'fusionQty', String(i.fusionQty))) return false;
                if (!passesColumnFilter('inventory', 'minimum', String(i.minimum))) return false;
                if (!passesColumnFilter('inventory', 'manualTarget', String(i.manualTarget))) return false;
                if (!passesColumnFilter('inventory', 'qtyNeeded', String(i.qtyNeeded))) return false;
                if (!passesColumnFilter('inventory', 'partsToBeMade', String(i.partsToBeMade))) return false;
                if (!passesColumnFilter('inventory', 'moldType', i.moldType || '-')) return false;
                if (!passesColumnFilter('inventory', 'status', status)) return false;
                return true;
            });
            
            data.sort((a, b) => {
                let va = a[invSort.field], vb = b[invSort.field];
                if (typeof va === 'string') return invSort.asc ? (va || '').localeCompare(vb || '') : (vb || '').localeCompare(va || '');
                return invSort.asc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
            });
            
            document.getElementById('invTableCount').textContent = `${data.length} items`;
            const tbody = document.getElementById('invTableBody');
            tbody.innerHTML = data.map(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const rowClass = isLow ? 'inv-low' : (needsMake ? 'inv-warning' : '');
                const statusBadge = isLow ? '<span class="badge" style="background:var(--danger);color:white;">LOW</span>' : (needsMake ? '<span class="badge" style="background:var(--warning);color:#1a202c;">MAKE</span>' : '<span class="badge" style="background:var(--success);color:white;">OK</span>');
                return `<tr class="${rowClass}">
                    <td>${i.product || '-'}</td>
                    <td><strong>${i.partNumber}</strong></td>
                    <td>${formatNumber(i.fusionQty)}</td>
                    <td>${formatNumber(i.minimum)}</td>
                    <td>${formatNumber(i.manualTarget)}</td>
                    <td>${formatNumber(i.qtyNeeded)}</td>
                    <td class="${i.partsToBeMade > 0 ? 'negative' : ''}">${formatNumber(i.partsToBeMade)}</td>
                    <td>${i.moldType || '-'}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            }).join('');
            
            updateClearAllButton('inventory');
        }
        
        function filterInvTable() { renderInvTable(); }
        function exportInvCSV() { downloadCSV('Product Type,Part Number,...', 'inventory.csv'); }

        // ============================================================
        // SALES OVERVIEW PAGE (Enhanced)
        // ============================================================
        function toggleSalesCategory(cat) {
            salesFilters.categories[cat] = !salesFilters.categories[cat];
            if (!salesFilters.categories.rolltech && !salesFilters.categories.molding) { salesFilters.categories[cat] = true; return; }
            document.getElementById('salesBtnRollTech').classList.toggle('active', salesFilters.categories.rolltech);
            document.getElementById('salesBtnMolding').classList.toggle('active', salesFilters.categories.molding);
            updateSalesOverview();
        }
        
        function applySalesDateFilter() {
            const fromInput = document.getElementById('salesFromDate').value;
            const toInput = document.getElementById('salesToDate').value;
            salesFilters.fromDate = fromInput ? new Date(fromInput) : null;
            salesFilters.toDate = toInput ? new Date(toInput) : null;
            updateSalesOverview();
        }
        
        function resetSalesDateFilter() {
            document.getElementById('salesFromDate').value = '';
            document.getElementById('salesToDate').value = '';
            salesFilters.fromDate = null;
            salesFilters.toDate = null;
            updateSalesOverview();
        }
        
        function toggleSalesHeatMap() {
            salesHeatMapEnabled = !salesHeatMapEnabled;
            document.getElementById('salesHeatMapBtn').classList.toggle('active', salesHeatMapEnabled);
            updateSalesOverview();
        }
        
        function toggleSalesAutoRefresh() {
            if (salesAutoRefreshInterval) {
                clearInterval(salesAutoRefreshInterval);
                salesAutoRefreshInterval = null;
                document.getElementById('salesAutoRefreshBtn').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span>Auto-refresh: Off</span>';
            } else {
                salesAutoRefreshInterval = setInterval(() => { loadDashboard(); }, 300000); // 5 minutes
                document.getElementById('salesAutoRefreshBtn').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span class="pulse"></span><span>Auto-refresh: On (5 min)</span>';
            }
        }
        
        function getFilteredSalesData() {
            return allData.filter(r => {
                if (!salesFilters.categories[getCategory(r)]) return false;
                if (salesFilters.fromDate || salesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (salesFilters.fromDate && rowDate < salesFilters.fromDate) return false;
                    if (salesFilters.toDate && rowDate > salesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesOverview() {
            const data = getFilteredSalesData();
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            
            data.forEach(r => {
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    totalPL += pl;
                    if (getStatus(r) === 'shipped') { shippedPL += pl; shippedCount++; }
                    else { forecastPL += pl; forecastCount++; }
                } else {
                    if (getStatus(r) === 'shipped') shippedCount++; else forecastCount++;
                }
            });
            
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('salesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('salesStatOrderCount').textContent = `${data.length} orders`;
            document.getElementById('salesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('salesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatMargin').textContent = `Margin: ${margin}%`;
            document.getElementById('salesStatShippedPL').textContent = formatCurrency(shippedPL);
            document.getElementById('salesStatShippedPL').className = `value ${shippedPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatShippedCount').textContent = `${shippedCount} shipped`;
            document.getElementById('salesStatForecastPL').textContent = formatCurrency(forecastPL);
            document.getElementById('salesStatForecastPL').className = `value ${forecastPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatForecastCount').textContent = `${forecastCount} pending`;
            
            // Render the Monthly P/L Trend chart
            renderSalesTrendChart(data);
        }
        
        function renderSalesLossesChart(data) {
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { pl: 0 };
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            // Get top 5 losses and top 5 gains
            const sorted = Object.entries(partStats).sort((a,b) => a[1].pl - b[1].pl);
            const topLosses = sorted.slice(0, 5).filter(([_,v]) => v.pl < 0);
            const topGains = sorted.slice(-5).reverse().filter(([_,v]) => v.pl > 0);
            const combined = [...topLosses, ...topGains.reverse()];
            
            if (charts.salesLosses) charts.salesLosses.destroy();
            charts.salesLosses = new Chart(document.getElementById('salesLossesChart'), {
                type: 'bar',
                data: {
                    labels: combined.map(s => s[0]),
                    datasets: [{
                        data: combined.map(s => s[1].pl),
                        backgroundColor: combined.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)')
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function renderSalesCustomerPieChart(data) {
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { pl: 0 };
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(custStats).filter(([_,v]) => v.pl > 0).sort((a,b) => b[1].pl - a[1].pl).slice(0, 8);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#718096'];
            
            if (charts.salesCustomerPie) charts.salesCustomerPie.destroy();
            charts.salesCustomerPie = new Chart(document.getElementById('salesCustomerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0].substring(0, 20)),
                    datasets: [{ data: sorted.map(s => s[1].pl), backgroundColor: colors }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
        }
        
        function renderSalesTrendChart(data) {
            const monthStats = {};
            data.forEach(r => {
                const d = getAttributionDate(r);
                if (!d) return;
                const month = getMonthKey(d);
                if (!monthStats[month]) monthStats[month] = { shipped: 0, forecast: 0, revenue: 0 };
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (getStatus(r) === 'shipped') monthStats[month].shipped += pl;
                    else monthStats[month].forecast += pl;
                }
            });
            
            const sorted = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0])).slice(-24);
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: sorted.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped P/L', data: sorted.map(s => s[1].shipped), borderColor: '#38a169', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                        { label: 'Forecast P/L', data: sorted.map(s => s[1].forecast), borderColor: '#d69e2e', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5,5], yAxisID: 'y' },
                        { label: 'Revenue', data: sorted.map(s => s[1].revenue), borderColor: '#3182ce', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { type: 'linear', position: 'left', ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y1: { type: 'linear', position: 'right', ticks: { callback: v => formatCurrency(v), color: '#3182ce' }, grid: { drawOnChartArea: false } },
                        x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function exportSalesCSV() {
            const data = getFilteredSalesData();
            const csv = data.map(r => [getVal(r,'PART'),getVal(r,'CUSTOMER'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].join(',')).join('\n');
            downloadCSV('Part,Customer,Qty,Revenue,P/L\n' + csv, `sales_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SALES BY PARTS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function togglePartsCategory(cat) {
            partsFilters.categories[cat] = !partsFilters.categories[cat];
            if (!partsFilters.categories.rolltech && !partsFilters.categories.molding) { partsFilters.categories[cat] = true; return; }
            document.getElementById('partsBtnRollTech').classList.toggle('active', partsFilters.categories.rolltech);
            document.getElementById('partsBtnMolding').classList.toggle('active', partsFilters.categories.molding);
            updateSalesPartsPage();
        }
        
        function applyPartsDateFilter() {
            partsFilters.fromDate = document.getElementById('partsFromDate').value ? new Date(document.getElementById('partsFromDate').value) : null;
            partsFilters.toDate = document.getElementById('partsToDate').value ? new Date(document.getElementById('partsToDate').value) : null;
            updateSalesPartsPage();
        }
        
        function resetPartsDateFilter() {
            document.getElementById('partsFromDate').value = '';
            document.getElementById('partsToDate').value = '';
            partsFilters.fromDate = null;
            partsFilters.toDate = null;
            updateSalesPartsPage();
        }
        
        function togglePartsWatchlistFilter() {
            partsFilters.watchlistOnly = !partsFilters.watchlistOnly;
            document.getElementById('partsWatchlistBtn').classList.toggle('active', partsFilters.watchlistOnly);
            updateSalesPartsPage();
        }
        
        function getFilteredPartsData() {
            return allData.filter(r => {
                if (!partsFilters.categories[getCategory(r)]) return false;
                if (partsFilters.fromDate || partsFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (partsFilters.fromDate && rowDate < partsFilters.fromDate) return false;
                    if (partsFilters.toDate && rowDate > partsFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesPartsPage() {
            const data = getFilteredPartsData();
            const partStats = {};
            
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            let partsArray = Object.entries(partStats).map(([part, stats]) => ({ part, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            // Filter by watchlist if enabled
            if (partsFilters.watchlistOnly) partsArray = partsArray.filter(p => isInWatchlist('part', p.part));
            
            // Search filter
            const search = (document.getElementById('partsSearch')?.value || '').toLowerCase();
            if (search) partsArray = partsArray.filter(p => p.part.toLowerCase().includes(search));
            
            // Column filters
            partsArray = partsArray.filter(p => {
                if (!passesColumnFilter('parts', 'part', p.part)) return false;
                if (!passesColumnFilter('parts', 'orders', String(p.orders))) return false;
                if (!passesColumnFilter('parts', 'qty', String(p.qty))) return false;
                if (!passesColumnFilter('parts', 'revenue', formatCurrency(p.revenue))) return false;
                if (!passesColumnFilter('parts', 'pl', p.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (p.margin < 0) marginCat = 'Negative';
                else if (p.margin < 10) marginCat = 'Low (0-10%)';
                else if (p.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('parts', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort - handle string vs numeric fields
            partsArray.sort((a, b) => {
                if (partsSort.field === 'part') {
                    return partsSort.asc ? a.part.localeCompare(b.part) : b.part.localeCompare(a.part);
                }
                return partsSort.asc ? a[partsSort.field] - b[partsSort.field] : b[partsSort.field] - a[partsSort.field];
            });
            
            // Render chart
            renderPartsBarChart(partsArray);
            
            // Render table
            document.getElementById('partsTableCount').textContent = `${partsArray.length} parts`;
            document.getElementById('partsTableHeader').innerHTML = `
                <th>‚òÖ</th>
                ${createFilterHeader('parts', 'part', 'Part #')}
                ${createFilterHeader('parts', 'orders', 'Orders')}
                ${createFilterHeader('parts', 'qty', 'Qty')}
                ${createFilterHeader('parts', 'revenue', 'Revenue')}
                ${createFilterHeader('parts', 'pl', 'P/L')}
                ${createFilterHeader('parts', 'margin', 'Margin')}
            `;
            
            document.getElementById('partsTableBody').innerHTML = partsArray.map(p => `
                <tr class="clickable" onclick="showPartsCustomerDrilldown('${p.part.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('part', p.part) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistPart('${p.part.replace(/'/g, "\\'")}')">‚òÖ</span></td>
                    <td><strong>${p.part}</strong></td>
                    <td>${formatNumber(p.orders)}</td>
                    <td>${formatNumber(p.qty)}</td>
                    <td>${formatCurrency(p.revenue)}</td>
                    <td class="${p.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(p.pl)}</td>
                    <td class="${p.margin >= 0 ? 'positive' : 'negative'}">${p.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function renderPartsBarChart(partsArray) {
            // Sort all parts from lowest (losses) to highest (gains) P/L
            const sortedParts = [...partsArray].sort((a,b) => a.pl - b.pl);
            if (charts.partsBar) charts.partsBar.destroy();
            charts.partsBar = new Chart(document.getElementById('partsBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedParts.map(p => p.part),
                    datasets: [{ data: sortedParts.map(p => p.pl), backgroundColor: sortedParts.map(p => p.pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)') }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 }, maxRotation: 90 }, grid: { display: false } } } }
            });
        }
        
        function sortPartsTable(field) {
            if (partsSort.field === field) partsSort.asc = !partsSort.asc;
            else { partsSort.field = field; partsSort.asc = field === 'part'; }
            updateSalesPartsPage();
        }
        
        function filterPartsTable() { updateSalesPartsPage(); }
        function exportPartsCSV() { downloadCSV('Part,Orders,Qty,Revenue,P/L,Margin', 'parts_pl.csv'); }
        
        // Parts Drilldown Functions
        let partsCustomerDrilldownData = []; // Store data for re-sorting
        
        function showPartsCustomerDrilldown(part) {
            currentDrilldownPart = part;
            partsCustomerDrilldownSort = { field: 'pl', asc: false }; // Reset sort
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part);
            
            const customerStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!customerStats[c]) customerStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                customerStats[c].orders++;
                customerStats[c].qty += parseNumber(getVal(r, 'QTY'));
                customerStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) customerStats[c].pl += getPLValue(r);
            });
            
            // Convert to array with computed fields
            partsCustomerDrilldownData = Object.entries(customerStats).map(([customer, stats]) => ({
                customer,
                qty: stats.qty,
                unitPrice: stats.qty > 0 ? stats.revenue / stats.qty : 0,
                margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0,
                pl: stats.pl,
                revenue: stats.revenue
            }));
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsCustomerDrilldownPart').textContent = part;
            document.getElementById('partsCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Customers</div><div class="value">${partsCustomerDrilldownData.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            renderPartsCustomerDrilldownTable();
            
            document.getElementById('partsCustomerDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            document.getElementById('partsCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderPartsCustomerDrilldownTable() {
            // Render sortable header
            document.getElementById('partsCustomerDrilldownHeader').innerHTML = `
                <th onclick="sortPartsCustomerDrilldown('customer')">Customer <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('qty')">Qty <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('unitPrice')">Unit Price <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Contribution <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Margin <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('pl')">P/L <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('revenue')">Revenue <span class="sort-indicator">‚Üï</span></th>
            `;
            
            // Sort data
            const sorted = [...partsCustomerDrilldownData].sort((a, b) => {
                if (partsCustomerDrilldownSort.field === 'customer') {
                    return partsCustomerDrilldownSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return partsCustomerDrilldownSort.asc ? a[partsCustomerDrilldownSort.field] - b[partsCustomerDrilldownSort.field] : b[partsCustomerDrilldownSort.field] - a[partsCustomerDrilldownSort.field];
            });
            
            document.getElementById('partsCustomerDrilldownBody').innerHTML = sorted.map(row => {
                return `<tr class="clickable" onclick="showPartsOrdersDrilldown('${currentDrilldownPart.replace(/'/g, "\\'")}', '${row.customer.replace(/'/g, "\\'")}')">
                    <td><strong>${row.customer}</strong></td>
                    <td>${formatNumber(row.qty)}</td>
                    <td>${formatCurrency(row.unitPrice)}</td>
                    <td>${getContributionBadge(row.margin)}</td>
                    <td class="${row.margin >= 0 ? 'positive' : 'negative'}">${row.margin.toFixed(1)}%</td>
                    <td class="${row.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.pl)}</td>
                    <td>${formatCurrency(row.revenue)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortPartsCustomerDrilldown(field) {
            if (partsCustomerDrilldownSort.field === field) {
                partsCustomerDrilldownSort.asc = !partsCustomerDrilldownSort.asc;
            } else {
                partsCustomerDrilldownSort.field = field;
                partsCustomerDrilldownSort.asc = field === 'customer'; // Strings default asc, numbers default desc
            }
            renderPartsCustomerDrilldownTable();
        }
        
        function showPartsOrdersDrilldown(part, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsOrdersBreadcrumbPart').textContent = part;
            document.getElementById('partsOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('partsOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.partsOrdersPrice) charts.partsOrdersPrice.destroy();
            const priceChartEl = document.getElementById('partsOrdersPriceChart');
            console.log('Price History Debug v7.3:', { dataPoints: priceData.length, prices: priceData.slice(0,5).map(d => d.price) });
            if (priceData.length > 1 && priceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                // If all prices are same or very close, create artificial range
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                console.log('Y-Axis Debug v7.3:', { minPrice, maxPrice, allSame, yAxisMin, yAxisMax });
                
                charts.partsOrdersPrice = new Chart(priceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Orders table
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('partsOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('partsOrdersDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePartsCustomerDrilldown() {
            document.getElementById('partsCustomerDrilldown').classList.remove('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            currentDrilldownPart = null;
        }
        
        function closePartsOrdersDrilldown() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function backToPartsCustomers() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function closeAllPartsDrilldowns() { closePartsCustomerDrilldown(); }

        // ============================================================
        // SALES BY CUSTOMERS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleCustomersCategory(cat) {
            customersFilters.categories[cat] = !customersFilters.categories[cat];
            if (!customersFilters.categories.rolltech && !customersFilters.categories.molding) { customersFilters.categories[cat] = true; return; }
            document.getElementById('customersBtnRollTech').classList.toggle('active', customersFilters.categories.rolltech);
            document.getElementById('customersBtnMolding').classList.toggle('active', customersFilters.categories.molding);
            updateSalesCustomersPage();
        }
        
        function applyCustomersDateFilter() {
            customersFilters.fromDate = document.getElementById('customersFromDate').value ? new Date(document.getElementById('customersFromDate').value) : null;
            customersFilters.toDate = document.getElementById('customersToDate').value ? new Date(document.getElementById('customersToDate').value) : null;
            updateSalesCustomersPage();
        }
        
        function resetCustomersDateFilter() {
            document.getElementById('customersFromDate').value = '';
            document.getElementById('customersToDate').value = '';
            customersFilters.fromDate = null;
            customersFilters.toDate = null;
            updateSalesCustomersPage();
        }
        
        function toggleCustomersWatchlistFilter() {
            customersFilters.watchlistOnly = !customersFilters.watchlistOnly;
            document.getElementById('customersWatchlistBtn').classList.toggle('active', customersFilters.watchlistOnly);
            updateSalesCustomersPage();
        }
        
        function getFilteredCustomersData() {
            return allData.filter(r => {
                if (!customersFilters.categories[getCategory(r)]) return false;
                if (customersFilters.fromDate || customersFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (customersFilters.fromDate && rowDate < customersFilters.fromDate) return false;
                    if (customersFilters.toDate && rowDate > customersFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesCustomersPage() {
            const data = getFilteredCustomersData();
            const custStats = {};
            
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            let custArray = Object.entries(custStats).map(([customer, stats]) => ({ customer, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            if (customersFilters.watchlistOnly) custArray = custArray.filter(c => isInWatchlist('customer', c.customer));
            
            const search = (document.getElementById('customersSearch')?.value || '').toLowerCase();
            if (search) custArray = custArray.filter(c => c.customer.toLowerCase().includes(search));
            
            // Column filters
            custArray = custArray.filter(c => {
                if (!passesColumnFilter('customers', 'customer', c.customer)) return false;
                if (!passesColumnFilter('customers', 'orders', String(c.orders))) return false;
                if (!passesColumnFilter('customers', 'qty', String(c.qty))) return false;
                if (!passesColumnFilter('customers', 'revenue', formatCurrency(c.revenue))) return false;
                if (!passesColumnFilter('customers', 'pl', c.pl >= 0 ? 'Positive' : 'Negative')) return false;
                let marginCat;
                if (c.margin < 0) marginCat = 'Negative';
                else if (c.margin < 10) marginCat = 'Low (0-10%)';
                else if (c.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('customers', 'margin', marginCat)) return false;
                return true;
            });
            
            custArray.sort((a, b) => {
                if (customersSort.field === 'customer') {
                    return customersSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return customersSort.asc ? a[customersSort.field] - b[customersSort.field] : b[customersSort.field] - a[customersSort.field];
            });
            
            // Chart
            const top10 = [...custArray].sort((a,b) => b.pl - a.pl).slice(0, 10);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#e53e3e', '#718096', '#4a5568'];
            if (charts.customers) charts.customers.destroy();
            charts.customers = new Chart(document.getElementById('customersChart'), {
                type: 'doughnut',
                data: { labels: top10.map(c => c.customer.substring(0, 20)), datasets: [{ data: top10.map(c => Math.abs(c.pl)), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
            
            // Table
            document.getElementById('customersTableCount').textContent = `${custArray.length} customers`;
            document.getElementById('customersTableHeader').innerHTML = `
                <th>‚òÖ</th>
                ${createFilterHeader('customers', 'customer', 'Customer')}
                ${createFilterHeader('customers', 'orders', 'Orders')}
                ${createFilterHeader('customers', 'qty', 'Qty')}
                ${createFilterHeader('customers', 'revenue', 'Revenue')}
                ${createFilterHeader('customers', 'pl', 'P/L')}
                ${createFilterHeader('customers', 'margin', 'Margin')}
            `;
            
            document.getElementById('customersTableBody').innerHTML = custArray.map(c => `
                <tr class="clickable" onclick="showCustomersProductDrilldown('${c.customer.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('customer', c.customer) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistCustomer('${c.customer.replace(/'/g, "\\'")}')">‚òÖ</span></td>
                    <td><strong>${c.customer}</strong></td>
                    <td>${formatNumber(c.orders)}</td>
                    <td>${formatNumber(c.qty)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(c.pl)}</td>
                    <td class="${c.margin >= 0 ? 'positive' : 'negative'}">${c.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
            
            updateClearAllButton('customers');
        }
        
        function sortCustomersTable(field) {
            if (customersSort.field === field) customersSort.asc = !customersSort.asc;
            else { customersSort.field = field; customersSort.asc = field === 'customer'; }
            updateSalesCustomersPage();
        }
        
        function filterCustomersTable() { updateSalesCustomersPage(); }
        function exportCustomersCSV() { downloadCSV('Customer,Orders,Qty,Revenue,P/L,Margin', 'customers_pl.csv'); }
        
        // Customers Drilldown Functions
        function showCustomersProductDrilldown(customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer);
            
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersProductDrilldownCustomer').textContent = customer;
            document.getElementById('customersProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Products</div><div class="value">${Object.keys(partStats).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(partStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('customersProductDrilldownBody').innerHTML = sorted.map(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                const avgPrice = stats.qty > 0 ? stats.revenue / stats.qty : 0;
                return `<tr class="clickable" onclick="showCustomersOrdersDrilldown('${currentDrilldownCustomer.replace(/'/g, "\\'")}', '${part.replace(/'/g, "\\'")}')">
                    <td><strong>${part}</strong></td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(avgPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersProductDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            document.getElementById('customersProductDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showCustomersOrdersDrilldown(customer, part) {
            currentDrilldownPart = part;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer && getVal(r, 'PART') === part);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('customersOrdersBreadcrumbPart').textContent = part;
            document.getElementById('customersOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart for customer orders
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.customersOrdersPrice) charts.customersOrdersPrice.destroy();
            const custPriceChartEl = document.getElementById('customersOrdersPriceChart');
            if (priceData.length > 1 && custPriceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                
                charts.customersOrdersPrice = new Chart(custPriceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('customersOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersOrdersDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeCustomersProductDrilldown() {
            document.getElementById('customersProductDrilldown').classList.remove('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            currentDrilldownCustomer = null;
        }
        
        function closeCustomersOrdersDrilldown() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function backToCustomersProducts() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function closeAllCustomersDrilldowns() { closeCustomersProductDrilldown(); }

        // ============================================================
        // SALES BY DATE PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleDatesCategory(cat) {
            datesFilters.categories[cat] = !datesFilters.categories[cat];
            if (!datesFilters.categories.rolltech && !datesFilters.categories.molding) { datesFilters.categories[cat] = true; return; }
            document.getElementById('datesBtnRollTech').classList.toggle('active', datesFilters.categories.rolltech);
            document.getElementById('datesBtnMolding').classList.toggle('active', datesFilters.categories.molding);
            updateSalesDatesPage();
        }
        
        function applyDatesDateFilter() {
            datesFilters.fromDate = document.getElementById('datesFromDate').value ? new Date(document.getElementById('datesFromDate').value) : null;
            datesFilters.toDate = document.getElementById('datesToDate').value ? new Date(document.getElementById('datesToDate').value) : null;
            updateSalesDatesPage();
        }
        
        function resetDatesDateFilter() {
            document.getElementById('datesFromDate').value = '';
            document.getElementById('datesToDate').value = '';
            datesFilters.fromDate = null;
            datesFilters.toDate = null;
            updateSalesDatesPage();
        }
        
        function getFilteredDatesData() {
            return allData.filter(r => {
                if (!datesFilters.categories[getCategory(r)]) return false;
                if (datesFilters.fromDate || datesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (datesFilters.fromDate && rowDate < datesFilters.fromDate) return false;
                    if (datesFilters.toDate && rowDate > datesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesDatesPage() {
            const data = getFilteredDatesData();
            const monthStats = {};
            let totalOrders = 0, totalUnits = 0, totalRevenue = 0, totalPL = 0;
            
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                const status = getStatus(r);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, shippedPL: 0, forecastPL: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (status === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (status === 'shipped') monthStats[month].shippedPL += pl;
                    else monthStats[month].forecastPL += pl;
                }
                totalOrders++;
                totalUnits += parseNumber(getVal(r, 'QTY'));
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) totalPL += getPLValue(r);
            });
            
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100) : 0;
            const monthCount = Object.keys(monthStats).length;
            
            document.getElementById('datesStatOrders').textContent = formatNumber(totalOrders);
            document.getElementById('datesStatUnits').textContent = `${formatNumber(totalUnits)} units`;
            document.getElementById('datesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('datesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('datesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMargin').textContent = `Margin: ${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').className = `value ${margin >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMonths').textContent = `${monthCount} months`;
            
            // Convert to array for filtering and sorting
            let monthsArray = Object.entries(monthStats).map(([month, stats]) => {
                const totalPL = stats.shippedPL + stats.forecastPL;
                const rowMargin = stats.revenue > 0 ? (totalPL / stats.revenue * 100) : 0;
                return {
                    month,
                    monthLabel: formatMonthLabel(month),
                    statusText: `${stats.shipped}/${stats.orders} Shipped`,
                    orders: stats.orders,
                    shipped: stats.shipped,
                    qty: stats.qty,
                    revenue: stats.revenue,
                    pl: totalPL,
                    margin: rowMargin,
                    shippedPL: stats.shippedPL,
                    forecastPL: stats.forecastPL
                };
            });
            
            // Apply column filters
            monthsArray = monthsArray.filter(m => {
                if (!passesColumnFilter('dates', 'month', m.monthLabel)) return false;
                if (!passesColumnFilter('dates', 'status', m.statusText)) return false;
                if (!passesColumnFilter('dates', 'orders', String(m.orders))) return false;
                if (!passesColumnFilter('dates', 'qty', String(m.qty))) return false;
                if (!passesColumnFilter('dates', 'revenue', formatCurrency(m.revenue))) return false;
                if (!passesColumnFilter('dates', 'pl', m.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (m.margin < 0) marginCat = 'Negative';
                else if (m.margin < 10) marginCat = 'Low (0-10%)';
                else if (m.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('dates', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort
            monthsArray.sort((a, b) => {
                const field = datesSort.field;
                if (field === 'month') {
                    return datesSort.asc ? a.month.localeCompare(b.month) : b.month.localeCompare(a.month);
                }
                return datesSort.asc ? a[field] - b[field] : b[field] - a[field];
            });
            
            // Use full array for chart (before filtering affects it)
            const chartMonths = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0]));
            
            // Stacked bar chart with shipped profit/loss and forecast profit/loss
            if (charts.datesBar) charts.datesBar.destroy();
            charts.datesBar = new Chart(document.getElementById('datesBarChart'), {
                type: 'bar',
                data: {
                    labels: chartMonths.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped Profit', data: chartMonths.map(s => Math.max(0, s[1].shippedPL)), backgroundColor: 'rgba(56,161,105,0.8)', stack: 'shipped' },
                        { label: 'Shipped Loss', data: chartMonths.map(s => Math.min(0, s[1].shippedPL)), backgroundColor: 'rgba(229,62,62,0.8)', stack: 'shipped' },
                        { label: 'Forecast Profit', data: chartMonths.map(s => Math.max(0, s[1].forecastPL)), backgroundColor: 'rgba(56,161,105,0.4)', stack: 'forecast' },
                        { label: 'Forecast Loss', data: chartMonths.map(s => Math.min(0, s[1].forecastPL)), backgroundColor: 'rgba(229,62,62,0.4)', stack: 'forecast' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { stacked: true, ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
            
            // Render filterable table header
            document.getElementById('datesTableHeader').innerHTML = 
                createFilterHeader('dates', 'month', 'Month') +
                createFilterHeader('dates', 'status', 'Status') +
                createFilterHeader('dates', 'orders', 'Orders') +
                createFilterHeader('dates', 'qty', 'Qty') +
                createFilterHeader('dates', 'revenue', 'Revenue') +
                createFilterHeader('dates', 'pl', 'P/L') +
                createFilterHeader('dates', 'margin', 'Margin');
            
            // Table with X/Y Shipped format
            document.getElementById('datesTableCount').textContent = `${monthsArray.length} months`;
            document.getElementById('datesTableBody').innerHTML = monthsArray.map(m => {
                return `<tr class="clickable" onclick="showDatesCustomerDrilldown('${m.month}')">
                    <td><strong>${m.monthLabel}</strong></td>
                    <td>${m.statusText}</td>
                    <td>${formatNumber(m.orders)}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatCurrency(m.revenue)}</td>
                    <td class="${m.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.pl)}</td>
                    <td class="${m.margin >= 0 ? 'positive' : 'negative'}">${m.margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            updateClearAllButton('dates');
        }
        
        function sortDatesTable(field) {
            if (datesSort.field === field) datesSort.asc = !datesSort.asc;
            else { datesSort.field = field; datesSort.asc = field === 'month'; }
            updateSalesDatesPage();
        }
        
        function exportDatesCSV() { downloadCSV('Month,Status,Orders,Quantity,Revenue,P/L,Margin', 'dates_pl.csv'); }
        
        // Dates Drilldown Functions
        function showDatesCustomerDrilldown(month) {
            currentDrilldownMonth = month;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month);
            
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesCustomerDrilldownMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(custStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('datesCustomerDrilldownBody').innerHTML = sorted.map(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                return `<tr class="clickable" onclick="showDatesOrdersDrilldown('${currentDrilldownMonth}', '${customer.replace(/'/g, "\\'")}')">
                    <td><strong>${customer}</strong></td>
                    <td>${formatNumber(stats.orders)}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesCustomerDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            document.getElementById('datesCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDatesOrdersDrilldown(month, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesOrdersBreadcrumbMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('datesOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('datesOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${dateStr}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesOrdersDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeDatesCustomerDrilldown() {
            document.getElementById('datesCustomerDrilldown').classList.remove('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            currentDrilldownMonth = null;
        }
        
        function closeDatesOrdersDrilldown() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function backToDatesCustomers() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function closeAllDatesDrilldowns() { closeDatesCustomerDrilldown(); }

        // ============================================================
        // ============================================================
        // ALL DATA PAGE (Raw spreadsheet data - Columns A-AX)
        // ============================================================
        function updateAllDataPage() {
            document.getElementById('allDataLastUpdated').textContent = new Date().toLocaleTimeString();
            document.getElementById('allDataRowCount').textContent = allRawData.length;
            document.getElementById('allDataColCount').textContent = allRawHeaders.length;
            
            renderAllDataTableHeader();
            renderAllDataTable();
            updateClearAllButton('allData');
        }
        
        function renderAllDataTableHeader() {
            initTableFilters('allData');
            document.getElementById('allDataTableHeader').innerHTML = allRawHeaders.map((h, i) => 
                createFilterHeader('allData', `col_${i}`, h, true)
            ).join('');
        }
        
        function renderAllDataTable() {
            let data = [...allRawData];
            
            // Filter out rows where column A is empty (array formula fills column A only for valid rows)
            const firstColHeader = allRawHeaders[0];
            if (firstColHeader) {
                data = data.filter(row => {
                    const val = row[firstColHeader];
                    return val !== undefined && val !== null && val !== '';
                });
            }
            
            // Global search filter
            const globalSearch = (document.getElementById('allDataGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return allRawHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return allRawHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('allData', colKey, val);
                });
            });
            
            // Apply sort
            if (allDataSort.field !== null) {
                const colIndex = parseInt(allDataSort.field.replace('col_', ''));
                const header = allRawHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    // Try numeric comparison first
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return allDataSort.asc ? numA - numB : numB - numA;
                    }
                    // Fall back to string comparison
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return allDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body
            const tbody = document.getElementById('allDataTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${allRawHeaders.map(h => {
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('revenue') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('price') || h.toLowerCase().includes('p/l'))) {
                            const cls = num >= 0 ? 'positive' : 'negative';
                            return `<td class="${cls}">${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            document.getElementById('allDataRowCount').textContent = data.length;
        }
        
        function sortAllDataTable(field) {
            if (allDataSort.field === field) {
                allDataSort.asc = !allDataSort.asc;
            } else {
                allDataSort.field = field;
                allDataSort.asc = true;
            }
            renderAllDataTable();
        }
        
        function filterAllDataTable() {
            renderAllDataTable();
        }
        
        function getUniqueAllDataColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = allRawHeaders[colIndex];
            const firstColHeader = allRawHeaders[0];
            const values = new Set();
            // Only include values from rows where column A has data
            allRawData.forEach(row => {
                const firstColVal = row[firstColHeader];
                if (firstColVal === undefined || firstColVal === null || firstColVal === '') return;
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            // Sort values - try numeric first
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportAllDataToCSV() {
            const headers = allRawHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = allRawData.map(row => 
                allRawHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `all_data_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // BOM EXPLORER
        // ============================================================
        function initBomExplorer() { renderBomSelector(); }
        function filterBomSelector() { renderBomSelector((document.getElementById('bomSearch').value || '').toLowerCase()); }
        
        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab));
            document.getElementById('bomSearch').value = '';
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }
        
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available. Check that the source sheet contains data.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.length === 0 ? '<p style="color:var(--text-secondary);">No parts found.</p>' : filtered.map((d, i) => {
                const originalIndex = data.indexOf(d);
                return `<div class="bom-item" data-index="${originalIndex}" onclick="showBomDetails(${originalIndex})">${d[nameKey] || 'Unknown'}</div>`;
            }).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', parseInt(item.dataset.index) === index));
            
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search, exactMatch] of [['Mold','mold',false],['Weight','weight',false],['Labor/Part','labor cost/ part',false],['Overhead','overhead',false],['Total Cost','total cost',true]]) {
                    let key = exactMatch ? Object.keys(part).find(k => k.trim().toLowerCase() === search) : Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`);
                    if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                const partsPkgKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('parts per package'));
                if (partsPkgKey && part[partsPkgKey]) content += `<div class="cost-item"><span class="label">Parts/Pkg</span><span class="value">${part[partsPkgKey]}</span></div>`;
                const laborKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('labor cost / finished') || k.trim().toLowerCase().includes('labor cost/ finished'));
                if (laborKey && part[laborKey]) content += `<div class="cost-item"><span class="label">Labor</span><span class="value">${formatCurrency(parseNumber(part[laborKey]))}</span></div>`;
                const varCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'variable cost');
                if (varCostKey && part[varCostKey]) content += `<div class="cost-item"><span class="label">Variable Cost</span><span class="value">${formatCurrency(parseNumber(part[varCostKey]))}</span></div>`;
                const totalCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'total cost');
                if (totalCostKey && part[totalCostKey]) content += `<div class="cost-item"><span class="label">Total Cost</span><span class="value">${formatCurrency(parseNumber(part[totalCostKey]))}</span></div>`;
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) {
                    content += `<div class="highlight-box">`;
                    if (profitKey && part[profitKey]) { const profitVal = parseNumber(part[profitKey]); const displayVal = profitVal < 1 ? (profitVal * 100).toFixed(0) + '%' : profitVal.toFixed(0) + '%'; content += `<div class="item"><div class="value">${displayVal}</div><div class="label">Profit Target</div></div>`; }
                    if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`;
                    content += `</div>`;
                }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`);
                    if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) {
                        content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                    }
                }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedZoom();
            loadDashboard();
        });
    </script>
</body>
</html>
