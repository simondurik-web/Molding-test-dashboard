<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Molding Operations Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --staged-blue: #4299e1;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1421 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 17px;
            overflow-x: hidden;
        }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 12px; overflow-y: auto; z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.4); transition: transform 0.3s ease;
        }
        .logo { text-align: center; padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .logo h1 { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 11px; color: var(--text-secondary); display: block; margin-top: 4px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 14px; font-weight: 700; }
        .nav-section-title.sales-locked { cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: linear-gradient(135deg, rgba(49,130,206,0.15) 0%, rgba(49,130,206,0.05) 100%); border-radius: 8px; margin: 4px 8px 8px; transition: all 0.2s; }
        .nav-section-title.sales-locked:hover { background: linear-gradient(135deg, rgba(49,130,206,0.25) 0%, rgba(49,130,206,0.15) 100%); }
        .nav-section-title.sales-locked .lock-icon { font-size: 12px; }
        .nav-section-title.sales-unlocked { cursor: default; background: linear-gradient(135deg, rgba(56,161,105,0.15) 0%, rgba(56,161,105,0.05) 100%); margin: 4px 8px 8px; padding: 12px 14px; border-radius: 8px; display: flex; align-items: center; gap: 8px; }
        .nav-section-title.sales-unlocked .lock-icon { display: none; }
        .financial-data { transition: opacity 0.3s; }
        .financial-hidden .financial-data { display: none !important; }
        .nav-item.locked-item { opacity: 0.5; cursor: pointer; }
        .nav-item.locked-item:hover { opacity: 0.7; }
        .nav-item.locked-item::after { content: 'üîí'; margin-left: 8px; font-size: 10px; }
        .nav-item { display: flex; align-items: center; padding: 11px 14px; margin: 3px 0; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 12px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item.sub-item { padding-left: 36px; font-size: 11px; opacity: 0.9; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 8px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }
        .lang-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; margin: 10px 8px; }
        .lang-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: white; }
        .main-content { margin-left: var(--sidebar-width); padding: 20px 24px; min-height: 100vh; max-width: calc(100vw - var(--sidebar-width)); overflow-x: hidden; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .dept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dept-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 16px; padding: 24px; border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .dept-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .dept-card.sales::before { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .dept-card.production::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .dept-card.inventory::before { background: linear-gradient(90deg, var(--teal), var(--accent)); }
        .dept-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-color: var(--accent); }
        .dept-card .icon-large { font-size: 40px; margin-bottom: 12px; }
        .dept-card h3 { font-size: 20px; margin-bottom: 8px; }
        .dept-card p { color: var(--text-secondary); font-size: 12px; margin-bottom: 16px; }
        .dept-card .metrics { display: flex; gap: 20px; flex-wrap: wrap; }
        .dept-card .metric .value { font-size: 22px; font-weight: 700; }
        .dept-card .metric .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .dept-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .dept-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .coming-soon { position: absolute; top: 12px; right: 12px; background: var(--warning); color: #1a202c; padding: 3px 10px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .quick-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 24px; }
        .quick-stat { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 12px; padding: 16px; border: 1px solid var(--border); text-align: center; }
        .quick-stat .value { font-size: 24px; font-weight: 700; }
        .quick-stat .value.positive { color: var(--success); }
        .quick-stat .value.negative { color: var(--danger); }
        .quick-stat .value.warning { color: var(--warning); }
        .quick-stat .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .info-banner { border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; display: none; }
        .info-banner.active { display: flex; align-items: center; gap: 12px; }
        .info-banner.warning { background: linear-gradient(135deg, #744210 0%, #975a16 100%); border: 1px solid var(--warning); }
        .info-banner.warning p { color: #fefcbf; }
        .info-banner.info { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border: 1px solid var(--accent); }
        .info-banner.info p { color: #bee3f8; }
        .info-banner p { font-size: 12px; margin: 0; }
        .info-banner .icon { font-size: 20px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border); }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"], .toolbar input[type="text"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .toolbar-spacer { flex: 1; }
        .category-filters { display: flex; gap: 8px; }
        .category-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 2px solid; display: flex; align-items: center; gap: 6px; }
        .category-btn .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .category-btn.rolltech { border-color: var(--accent); color: var(--accent); background: transparent; }
        .category-btn.rolltech.active { background: var(--accent); color: white; }
        .category-btn.rolltech .indicator { background: var(--accent); }
        .category-btn.molding { border-color: var(--warning); color: var(--warning); background: transparent; }
        .category-btn.molding.active { background: var(--warning); color: #1a202c; }
        .category-btn.molding .indicator { background: var(--warning); }
        .category-btn.snappad { border-color: #9f7aea; color: #9f7aea; background: transparent; }
        .category-btn.snappad.active { background: #9f7aea; color: white; }
        .category-btn.snappad .indicator { background: #9f7aea; }
        .category-btn:not(.active) { opacity: 0.5; }
        .category-btn:not(.active):hover { opacity: 0.8; }
        .status-filters { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; border: 1px solid; }
        .status-btn.pending { border-color: var(--warning); color: var(--warning); background: transparent; }
        .status-btn.pending.active { background: var(--warning); color: #1a202c; }
        .status-btn.staged { border-color: var(--staged-blue); color: var(--staged-blue); background: transparent; }
        .status-btn.staged.active { background: var(--staged-blue); color: white; }
        .status-btn.wip { border-color: var(--teal); color: var(--teal); background: transparent; }
        .status-btn.wip.active { background: var(--teal); color: white; }
        .status-btn.shipped { border-color: var(--success); color: var(--success); background: transparent; }
        .status-btn.shipped.active { background: var(--success); color: white; }
        .status-btn:not(.active) { opacity: 0.5; }
        .status-btn:not(.active):hover { opacity: 0.8; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; white-space: nowrap; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .warning-text { color: var(--warning); font-weight: 600; }
        .scrollable-table { max-height: 600px; overflow-y: auto; overflow-x: auto; border-radius: 10px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--staged-blue) 0%, #3182ce 100%); color: white; }
        .badge.wip { background: linear-gradient(135deg, var(--teal) 0%, #2c7a7b 100%); color: white; }
        .badge.urgent { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }
        .badge.priority-1 { background: var(--danger); color: white; }
        .badge.priority-2 { background: var(--warning); color: #1a202c; }
        .badge.priority-3 { background: var(--accent); color: white; }
        .badge.priority-4 { background: var(--teal); color: white; }
        .cell-missing { color: var(--danger); font-weight: 600; }
        .cell-available { color: var(--success); }
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .price-history-container { position: relative; height: 250px; margin-bottom: 20px; padding-bottom: 30px; }
        .price-history-container canvas { max-height: 250px; }
        .search-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1200px) { .quick-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .dept-grid { grid-template-columns: 1fr; }
            .quick-stats { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-spacer { display: none; }
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }
        .inv-low { background: rgba(229,62,62,0.15) !important; }
        .inv-warning { background: rgba(214,158,46,0.15) !important; }
        .inv-ok { background: rgba(56,161,105,0.08) !important; }
        .drilldown-section { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .drilldown-section.active { display: block; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; }
        .breadcrumb { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .close-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .close-btn:hover { border-color: var(--danger); color: var(--danger); }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        .summary-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        @media (max-width: 768px) { .bom-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
        
        /* Column Filter System Styles */
        .filter-th { position: relative; }
        .filter-th-content { display: flex; align-items: center; justify-content: space-between; gap: 4px; }
        .filter-th-btns { display: flex; gap: 2px; margin-left: 4px; }
        .filter-th-btns button { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .filter-th-btns button:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-th.filtered { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; }
        .filter-th.filtered .filter-th-btns button { background: rgba(0,0,0,0.2); }
        .filter-dropdown { position: fixed; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2000; min-width: 240px; max-width: 320px; max-height: 400px; display: none; flex-direction: column; }
        .filter-dropdown.active { display: flex; }
        .filter-dropdown-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-dropdown-header h4 { font-size: 12px; font-weight: 600; margin: 0; }
        .filter-dropdown-header button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; }
        .filter-search { margin: 10px; padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 12px; }
        .filter-search:focus { outline: none; border-color: var(--accent); }
        .filter-actions { display: flex; gap: 8px; padding: 0 10px 8px 10px; }
        .filter-actions button { flex: 1; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .filter-actions button:hover { border-color: var(--accent); color: white; }
        .filter-values-list { flex: 1; overflow-y: auto; padding: 0 10px; max-height: 220px; }
        .filter-value-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .filter-value-item:hover { background: rgba(255,255,255,0.05); }
        .filter-value-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        .filter-value-item label { cursor: pointer; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-dropdown-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .filter-dropdown-footer button { flex: 1; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .filter-dropdown-footer .clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .filter-dropdown-footer .clear-btn:hover { border-color: var(--danger); color: var(--danger); }
        .filter-dropdown-footer .apply-btn { background: var(--accent); border: none; color: white; }
        .filter-dropdown-footer .apply-btn:hover { background: var(--primary-light); }
        .clear-all-filters-btn { background: var(--bg-dark) !important; }
        .clear-all-filters-btn.has-filters { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; color: #1a202c !important; border-color: var(--warning) !important; }
        .show-hidden-btn { display: none; background: var(--bg-dark) !important; }
        .show-hidden-btn.has-hidden { display: inline-flex; background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%) !important; color: white !important; border-color: var(--accent) !important; }
        .watchlist-star { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .watchlist-star:hover { color: var(--warning); }
        .watchlist-star.active { color: var(--warning); }
        
        /* All Data table styles - larger for better readability */
        #all-data .data-table th { font-size: 11px; padding: 10px 8px; white-space: nowrap; min-width: 100px; }
        #all-data .data-table td { font-size: 12px; padding: 8px; white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
        #all-data .scrollable-table { overflow-x: auto; }
        #all-data .filter-th-btns button { width: 20px; height: 20px; font-size: 10px; }
        
        /* Zoom controls */
        .zoom-controls { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 10px 8px; }
        .zoom-btn { width: 28px; height: 28px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .zoom-btn:hover { background: var(--accent); border-color: var(--accent); }
        .zoom-reset-btn { width: 100%; margin-top: 8px; padding: 6px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .zoom-reset-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Dashboard wrapper for zoom - applies to both sidebar and content */
        .dashboard-wrapper { zoom: 1; }
        
        /* Pallet Pictures Gallery Styles */
        .pallet-drilldown { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .pallet-drilldown.active { display: block; }
        .pallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .pallet-header h3 { font-size: 18px; }
        .pallet-summary { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .pallet-summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .pallet-summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .pallet-summary-item .value { font-size: 18px; font-weight: 700; }
        .pallet-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .pallet-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.2s; }
        .pallet-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .pallet-card-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pallet-card-header h4 { font-size: 14px; font-weight: 600; }
        .pallet-card-header .pallet-meta { font-size: 11px; color: var(--text-secondary); }
        .pallet-images { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .pallet-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .pallet-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
        .pallet-card-details { padding: 12px; background: rgba(0,0,0,0.2); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pallet-detail { font-size: 11px; }
        .pallet-detail .label { color: var(--text-secondary); }
        .pallet-detail .value { font-weight: 600; color: var(--text-primary); }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .image-modal-close:hover { background: var(--danger); }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover td { background: rgba(49,130,206,0.15) !important; }
        .pallet-indicator { margin-left: 6px; color: var(--accent); font-size: 12px; }
        
        /* Inventory History Modal */
        .history-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2500; align-items: center; justify-content: center; }
        .history-modal-overlay.active { display: flex; }
        .history-modal { background: var(--bg-card); border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .history-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }
        .history-modal-header h3 { font-size: 18px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .history-modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .history-modal-close:hover { background: var(--danger); }
        .history-modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 70px); }
        .history-chart-container { height: 300px; margin-bottom: 20px; }
        .history-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
        .history-date-inputs { display: flex; gap: 16px; flex-wrap: wrap; }
        .history-date-group { display: flex; align-items: center; gap: 8px; }
        .history-date-group label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
        .history-date-group input[type="date"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: white; font-size: 12px; }
        .history-date-group input[type="date"]:focus { outline: none; border-color: var(--accent); }
        .history-presets { display: flex; gap: 8px; flex-wrap: wrap; }
        .history-presets button { padding: 8px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .history-presets button:hover { background: var(--accent); border-color: var(--accent); color: white; }
        .history-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .history-stat { background: var(--bg-dark); padding: 14px; border-radius: 10px; text-align: center; }
        .history-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .history-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .history-loading, .history-no-data { text-align: center; padding: 40px; color: var(--text-secondary); }
        .inv-history-btn { margin-left: 8px; background: var(--accent); color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; opacity: 0.8; transition: all 0.2s; }
        .inv-history-btn:hover { opacity: 1; }
        @media (max-width: 768px) {
            .history-modal { width: 95%; max-height: 95vh; }
            .history-controls { flex-direction: column; align-items: stretch; }
            .history-date-inputs { justify-content: center; }
            .history-presets { justify-content: center; }
            .history-stats { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Inventory History Page (Multi-Part) */
        .history-page-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 180px); }
        .history-parts-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .history-panel-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-panel-header h3 { font-size: 14px; font-weight: 600; }
        .history-selected-count { font-size: 11px; color: var(--accent); font-weight: 500; }
        .history-parts-search { margin: 12px; padding: 10px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 12px; }
        .history-parts-search:focus { outline: none; border-color: var(--accent); }
        .history-parts-actions { display: flex; gap: 8px; padding: 0 12px 12px; }
        .history-parts-actions button { flex: 1; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .history-parts-actions button:hover { border-color: var(--accent); color: white; }
        .history-parts-list { flex: 1; overflow-y: auto; padding: 0 8px 8px; }
        .history-part-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .history-part-item:hover { background: rgba(255,255,255,0.05); }
        .history-part-item.selected { background: rgba(49,130,206,0.2); }
        .history-part-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
        .history-part-item .part-info { flex: 1; min-width: 0; }
        .history-part-item .part-number { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-part-item .part-type { font-size: 10px; color: var(--text-secondary); }
        .history-part-item .part-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .history-chart-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .history-chart-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .history-page-chart-container { flex: 1; position: relative; min-height: 300px; }
        .history-page-chart-container canvas { width: 100% !important; height: 100% !important; }
        .history-page-no-selection { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); font-size: 14px; }
        .history-legend { display: flex; flex-wrap: wrap; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
        .history-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .history-legend-color { width: 20px; height: 4px; border-radius: 2px; }
        .history-legend-below { font-size: 10px; color: var(--danger); margin-left: 4px; }
        .history-page-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 150px; overflow-y: auto; }
        .history-part-stat-card { background: var(--bg-dark); border-radius: 10px; padding: 12px; }
        .history-part-stat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .history-part-stat-color { width: 12px; height: 12px; border-radius: 3px; }
        .history-part-stat-name { font-weight: 600; font-size: 12px; flex: 1; }
        .history-part-stat-values { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .history-part-stat-item { text-align: center; }
        .history-part-stat-value { font-size: 14px; font-weight: 600; color: var(--accent); }
        .history-part-stat-value.below-min { color: var(--danger); }
        .history-part-stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        @media (max-width: 900px) {
            .history-page-layout { grid-template-columns: 1fr; height: auto; }
            .history-parts-panel { max-height: 300px; }
            .history-page-chart-container { min-height: 350px; }
        }
    </style>
</head>
<body>
    <!-- Image Modal for Pallet Pictures -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <div class="image-modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="modalImage" src="" alt="Pallet Picture">
    </div>

    <!-- Column Filter Dropdown Modal -->
    <div class="filter-dropdown" id="columnFilterDropdown">
        <div class="filter-dropdown-header">
            <h4 id="filterDropdownTitle" data-i18n="ui.filterColumn">Filter Column</h4>
            <button onclick="closeFilterDropdown()">‚úï</button>
        </div>
        <input type="text" class="filter-search" id="filterDropdownSearch" data-i18n-placeholder="ui.searchValues" placeholder="Search values..." oninput="filterDropdownSearch()">
        <div class="filter-actions">
            <button onclick="filterSelectAll()" data-i18n="ui.selectAll">Select All</button>
            <button onclick="filterDeselectAll()" data-i18n="ui.deselectAll">Deselect All</button>
        </div>
        <div class="filter-values-list" id="filterValuesList"></div>
        <div class="filter-dropdown-footer">
            <button class="clear-btn" onclick="clearColumnFilter()" data-i18n="ui.clear">Clear</button>
            <button class="hide-col-btn" onclick="hideCurrentColumn()" style="background:var(--bg-dark);border-color:var(--border);" data-i18n="ui.hideColumn">üëÅ Hide</button>
            <button class="apply-btn" onclick="applyColumnFilter()" data-i18n="ui.apply">Apply</button>
        </div>
    </div>

    <!-- Inventory History Modal -->
    <div class="history-modal-overlay" id="inventoryHistoryModal" onclick="closeInventoryHistoryModal(event)">
        <div class="history-modal" onclick="event.stopPropagation()">
            <div class="history-modal-header">
                <h3>üìà <span data-i18n="inv.historyTitle">Inventory History</span>: <span id="historyPartName"></span></h3>
                <button class="history-modal-close" onclick="closeInventoryHistoryModal()">‚úï</button>
            </div>
            <div class="history-modal-body">
                <div class="history-chart-container">
                    <canvas id="inventoryHistoryChart"></canvas>
                </div>
                <div class="history-controls">
                    <div class="history-date-inputs">
                        <div class="history-date-group">
                            <label data-i18n="ui.from">From</label>
                            <input type="date" id="historyStartDate" onchange="updateHistoryChart()">
                        </div>
                        <div class="history-date-group">
                            <label data-i18n="ui.to">To</label>
                            <input type="date" id="historyEndDate" onchange="updateHistoryChart()">
                        </div>
                    </div>
                    <div class="history-presets">
                        <button onclick="applyHistoryPreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                        <button onclick="applyHistoryPreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                        <button onclick="applyHistoryPreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                        <button onclick="applyHistoryPreset('all')" data-i18n="inv.allData">All Data</button>
                    </div>
                </div>
                <div class="history-stats" id="historyStatsPanel">
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatCurrent">-</div>
                        <div class="history-stat-label" data-i18n="inv.current">Current</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMin">-</div>
                        <div class="history-stat-label" data-i18n="inv.minimum">Minimum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMax">-</div>
                        <div class="history-stat-label" data-i18n="inv.maximum">Maximum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatAvg">-</div>
                        <div class="history-stat-label" data-i18n="inv.average">Average</div>
                    </div>
                </div>
                <div class="history-loading" id="historyLoading" style="display:none;">
                    <span data-i18n="ui.loading">Loading...</span>
                </div>
                <div class="history-no-data" id="historyNoData" style="display:none;">
                    <span data-i18n="inv.noHistory">No history data available for this part</span>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-header">
        <div><h1>Molding</h1><span style="font-size:10px;color:var(--text-secondary);">Operations Dashboard</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="logo"><h1>Molding</h1><span id="logoSubtitle">Operations Dashboard</span></div>
        <div class="lang-toggle">
            <button class="lang-btn active" id="langEN" onclick="setLanguage('en')">English</button>
            <button class="lang-btn" id="langES" onclick="setLanguage('es')">Espa√±ol</button>
        </div>
        <div class="nav-section">
            <div class="nav-item active" data-page="main" onclick="navigateTo('main')"><span class="icon">üè†</span> <span data-i18n="nav.main">Main Dashboard</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.production">Production</div>
            <div class="nav-item" data-page="orders-data" onclick="navigateTo('orders-data')"><span class="icon">üìã</span> <span data-i18n="nav.ordersData">Orders Data</span></div>
            <div class="nav-item sub-item" data-page="orders-queue" onclick="navigateTo('orders-queue')"><span class="icon">üîß</span> <span data-i18n="nav.ordersQueue">Need to Make</span></div>
            <div class="nav-item sub-item" data-page="orders-staged" onclick="navigateTo('orders-staged')"><span class="icon">üì¶</span> <span data-i18n="nav.ordersStaged">Ready to Ship</span></div>
            <div class="nav-item sub-item" data-page="orders-shipped" onclick="navigateTo('orders-shipped')"><span class="icon">üöö</span> <span data-i18n="nav.ordersShipped">Shipped</span></div>
            <div class="nav-item" data-page="inventory" onclick="navigateTo('inventory')"><span class="icon">üì¶</span> <span data-i18n="nav.inventory">Inventory</span></div>
            <div class="nav-item sub-item" data-page="inventory-history" onclick="navigateTo('inventory-history')"><span class="icon">üìà</span> <span data-i18n="nav.inventoryHistory">Inventory History</span></div>
        </div>
        <div class="nav-section" id="salesNavSection">
            <div class="nav-section-title sales-locked" id="salesNavTitle" onclick="promptSalesPassword()">
                <span class="lock-icon">üîí</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>
            </div>
            <div class="sales-nav-items" id="salesNavItems" style="display:none;">
                <div class="nav-item" data-page="sales-overview" onclick="navigateTo('sales-overview')"><span class="icon">üìä</span> <span data-i18n="nav.plOverview">P/L Overview</span></div>
                <div class="nav-item sub-item" data-page="sales-parts" onclick="navigateTo('sales-parts')"><span class="icon">üîß</span> <span data-i18n="nav.byPart">By Part Number</span></div>
                <div class="nav-item sub-item" data-page="sales-customers" onclick="navigateTo('sales-customers')"><span class="icon">üë•</span> <span data-i18n="nav.byCustomer">By Customer</span></div>
                <div class="nav-item sub-item" data-page="sales-dates" onclick="navigateTo('sales-dates')"><span class="icon">üìÖ</span> <span data-i18n="nav.byDate">By Date</span></div>
            </div>
        </div>
        <div class="nav-section" id="bomNavSection" style="display:none;">
            <div class="nav-section-title" data-i18n="nav.billOfMaterials">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">üìã</span> <span data-i18n="nav.bomExplorer">BOM Explorer</span></div>
        </div>
        <div class="nav-section" id="rawDataNavSection">
            <div class="nav-section-title" data-i18n="nav.rawData">Raw Data</div>
            <div class="nav-item locked-item" id="allDataNavItem" data-page="all-data" onclick="handleAllDataClick()"><span class="icon">üóÉ</span> <span data-i18n="nav.allData">All Data</span></div>
            <div class="nav-item locked-item" id="fpRefNavItem" data-page="fp-reference" onclick="handleRefDataClick('fp-reference')"><span class="icon">üìã</span> <span data-i18n="nav.fpReference">FP Reference</span></div>
            <div class="nav-item locked-item" id="custRefNavItem" data-page="customer-reference" onclick="handleRefDataClick('customer-reference')"><span class="icon">üë•</span> <span data-i18n="nav.customerReference">Customer Reference</span></div>
            <div class="nav-item locked-item" id="quotesNavItem" data-page="quotes-registry" onclick="handleRefDataClick('quotes-registry')"><span class="icon">üìù</span> <span data-i18n="nav.quotesRegistry">Quotes Registry</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="zoom-controls">
            <label style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block;" data-i18n="ui.zoom">Zoom</label>
            <div style="display:flex;align-items:center;gap:6px;">
                <button class="zoom-btn" onclick="adjustZoom(-10)">‚àí</button>
                <input type="number" id="zoomInput" value="100" min="50" max="200" step="10" onchange="setZoom(this.value)" style="width:50px;text-align:center;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:white;padding:4px;font-size:11px;">
                <span style="font-size:10px;color:var(--text-secondary);">%</span>
                <button class="zoom-btn" onclick="adjustZoom(10)">+</button>
            </div>
            <button class="zoom-reset-btn" onclick="resetZoom()" data-i18n="ui.reset">Reset (100%)</button>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
        <div style="color:#718096;font-size:10px;margin-top:8px;text-align:center;">Dashboard v7.12</div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading"><div class="spinner"></div><p style="margin-top:18px;color:var(--text-secondary);" data-i18n="loading">Loading data from Google Sheets...</p></div>

        <!-- MAIN DASHBOARD -->
        <div id="main" class="page">
            <div class="page-header">
                <div><h2 data-i18n="main.title">Operations Dashboard</h2><p data-i18n="main.subtitle">Real-time overview of manufacturing operations</p></div>
                <div class="last-updated"><span class="dot"></span><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="quick-stats">
                <div class="quick-stat"><div class="value warning" id="qsNeedToMake">-</div><div class="label" data-i18n="stats.needToMake">Need to Make</div></div>
                <div class="quick-stat"><div class="value" id="qsUrgentOrders">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                <div class="quick-stat"><div class="value" id="qsTotalQty">-</div><div class="label" data-i18n="stats.totalUnits">Total Units</div></div>
                <div class="quick-stat"><div class="value warning" id="qsMissingComponents">-</div><div class="label" data-i18n="stats.missingParts">Missing Parts</div></div>
            </div>
            <div class="dept-grid">
                <div class="dept-card production" onclick="navigateTo('orders-queue')">
                    <div class="icon-large">üè≠</div>
                    <h3 data-i18n="dept.production">Production Planning</h3>
                    <p data-i18n="dept.productionDesc">View orders to make, component status, and production queue</p>
                    <div class="metrics">
                        <div class="metric"><div class="value" id="deptProdOrders">-</div><div class="label" data-i18n="dept.needToMake">Need to Make</div></div>
                        <div class="metric"><div class="value" id="deptProdUnits">-</div><div class="label" data-i18n="dept.units">Units</div></div>
                        <div class="metric"><div class="value warning" id="deptProdUrgent">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                    </div>
                </div>
                <div class="dept-card inventory" onclick="navigateTo('inventory')">
                    <div class="icon-large">üì¶</div>
                    <h3 data-i18n="dept.inventory">Inventory Management</h3>
                    <p data-i18n="dept.inventoryDesc">Stock levels, reorder points, and material tracking</p>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.ordersByStatus">Orders by Status</h3></div>
                    <div class="chart-wrapper"><canvas id="mainStatusChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.upcomingDeadlines">Upcoming Deadlines (Next 14 Days)</h3></div>
                    <div class="chart-wrapper"><canvas id="mainDeadlineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ORDERS DATA PAGE -->
        <div id="orders-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersData.title">All Orders Data</h2><p data-i18n="ordersData.subtitle">Complete order database with all statuses</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersDataBtnRollTech" onclick="toggleOrdersDataCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersDataBtnMolding" onclick="toggleOrdersDataCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersDataBtnSnapPad" onclick="toggleOrdersDataCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group status-filters">
                    <label data-i18n="ui.status">Status:</label>
                    <button class="status-btn pending active" id="ordersDataStatusPending" onclick="toggleOrdersDataStatus('pending')"><span data-i18n="status.needToMake">Need to Make</span></button>
                    <button class="status-btn wip active" id="ordersDataStatusWip" onclick="toggleOrdersDataStatus('wip')"><span data-i18n="status.making">Making</span></button>
                    <button class="status-btn staged active" id="ordersDataStatusStaged" onclick="toggleOrdersDataStatus('staged')"><span data-i18n="status.readyToShip">Ready to Ship</span></button>
                    <button class="status-btn shipped" id="ordersDataStatusShipped" onclick="toggleOrdersDataStatus('shipped')"><span data-i18n="status.shipped">Shipped</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersDataClearFiltersBtn" onclick="clearAllTableFilters('ordersData')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="ordersDataShowHiddenBtn" onclick="showAllColumns('ordersData')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersDataSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersDataTable()">
                <button class="toolbar-btn" onclick="exportOrdersDataToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalOrders">Total Orders</div><div class="value" id="ordersDataTotalOrders">-</div><div class="sub" id="ordersDataTotalUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needToMake">Need to Make</div><div class="value warning" id="ordersDataNeedToMake">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.making">Making</div><div class="value" style="color:var(--teal);" id="ordersDataMaking">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.readyToShip">Ready to Ship</div><div class="value positive" id="ordersDataReadyToShip">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.orders">Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersDataTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="ordersDataTable"><thead><tr id="ordersDataTableHeader"></tr></thead><tbody id="ordersDataTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS QUEUE PAGE -->
        <div id="orders-queue" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersQueue.title">Orders Queue - Need to Make</h2><p data-i18n="ordersQueue.subtitle">Orders pending production (Pending + Approved status)</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersQueueLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersQueueBtnRollTech" onclick="toggleOrdersQueueCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersQueueBtnMolding" onclick="toggleOrdersQueueCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersQueueBtnSnapPad" onclick="toggleOrdersQueueCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersQueueClearFiltersBtn" onclick="clearAllTableFilters('ordersQueue')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="ordersQueueShowHiddenBtn" onclick="showAllColumns('ordersQueue')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersQueueSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersQueueTable()">
                <button class="toolbar-btn" onclick="exportOrdersQueueToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="info-banner warning" id="ordersQueueMissingBanner">
                <span class="icon">‚ö†¬†¬è</span>
                <p><strong id="ordersQueueMissingCount">0</strong> <span data-i18n="prod.missingMsg">orders have missing components.</span></p>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalOrders">Total Orders</div><div class="value" id="ordersQueueTotalOrders">-</div><div class="sub" id="ordersQueueTotalUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.urgent">Urgent</div><div class="value negative" id="ordersQueueUrgentCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.dueThisWeek">Due This Week</div><div class="value warning" id="ordersQueueDueWeek">-</div><div class="sub" id="ordersQueueDueWeekUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.componentsReady">Components Ready</div><div class="value positive" id="ordersQueueComponentsReady">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.ordersToMake">Orders to Make</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersQueueTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersQueueTableHeader"></tr></thead><tbody id="ordersQueueTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS STAGED PAGE -->
        <div id="orders-staged" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersStaged.title">Staged Orders - Ready to Ship</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersStagedBtnRollTech" onclick="toggleOrdersStagedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersStagedBtnMolding" onclick="toggleOrdersStagedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersStagedBtnSnapPad" onclick="toggleOrdersStagedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersStagedClearFiltersBtn" onclick="clearAllTableFilters('ordersStaged')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="ordersStagedShowHiddenBtn" onclick="showAllColumns('ordersStaged')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersStagedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersStagedTable()">
                <button class="toolbar-btn" onclick="exportOrdersStagedToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.stagedOrders">Staged Orders</div><div class="value" id="ordersStagedTotalOrders">-</div><div class="sub" id="ordersStagedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersStagedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.avgOrderValue">Avg Order Value</div><div class="value" id="ordersStagedAvgValue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersStagedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.readyToShip">Ready to Ship</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersStagedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersStagedTableHeader"></tr></thead><tbody id="ordersStagedTableBody"></tbody></table>
                </div>
            </div>
            <!-- Pallet Pictures Drilldown -->
            <div class="pallet-drilldown" id="palletDrilldown">
                <div class="pallet-header">
                    <div>
                        <div class="breadcrumb">Staged Orders ‚Ä∫ <span id="palletDrilldownOrder">-</span></div>
                        <h3 data-i18n="pallet.title">Pallet Pictures</h3>
                    </div>
                    <button class="close-btn" onclick="closePalletDrilldown()">‚úï <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="pallet-summary" id="palletSummary"></div>
                <div class="pallet-gallery" id="palletGallery"></div>
            </div>
        </div>

        <!-- ORDERS SHIPPED PAGE -->
        <div id="orders-shipped" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersShipped.title">Shipped Orders History</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersShippedBtnRollTech" onclick="toggleOrdersShippedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersShippedBtnMolding" onclick="toggleOrdersShippedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersShippedBtnSnapPad" onclick="toggleOrdersShippedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="ordersShippedFromDate" onchange="applyShippedDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="ordersShippedToDate" onchange="applyShippedDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetShippedDateFilter()">üîÑ Reset</button>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersShippedClearFiltersBtn" onclick="clearAllTableFilters('ordersShipped')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="ordersShippedShowHiddenBtn" onclick="showAllColumns('ordersShipped')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersShippedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersShippedTable()">
                <button class="toolbar-btn" onclick="exportOrdersShippedToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.shippedOrders">Shipped Orders</div><div class="value" id="ordersShippedTotalOrders">-</div><div class="sub" id="ordersShippedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersShippedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="ordersShippedPL">-</div><div class="sub" id="ordersShippedMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersShippedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.shippedOrders">Shipped Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersShippedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersShippedTableHeader"></tr></thead><tbody id="ordersShippedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- INVENTORY PAGE -->
        <div id="inventory" class="page">
            <div class="page-header">
                <div><h2 data-i18n="inv.title">Inventory Management</h2></div>
            </div>
            <div class="toolbar">
                <input type="text" class="search-box" id="invSearch" data-i18n-placeholder="ui.search" placeholder="Search items..." oninput="filterInvTable()">
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="invFilterAll" onclick="setInvFilter('all')" data-i18n="filter.all">All</button>
                    <button class="toolbar-btn" id="invFilterLow" onclick="setInvFilter('low')">‚ö†Ô∏è <span data-i18n="filter.lowStock">Low Stock</span></button>
                    <button class="toolbar-btn" id="invFilterNeeded" onclick="setInvFilter('needed')">üîß <span data-i18n="filter.needsProduction">Needs Production</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="inventoryClearFiltersBtn" onclick="clearAllTableFilters('inventory')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="inventoryShowHiddenBtn" onclick="showAllColumns('inventory')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportInvCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalItems">Total Items</div><div class="value" id="invStatTotal">-</div><div class="sub" id="invStatTypes">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.lowStock">Low Stock</div><div class="value" style="color:var(--danger);" id="invStatLow">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needsProduction">Needs Production</div><div class="value" style="color:var(--warning);" id="invStatNeeded">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.adequateStock">Adequate Stock</div><div class="value" style="color:var(--success);" id="invStatOk">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.inventoryStatus">Inventory Status</h3><span style="color:var(--text-secondary);font-size:12px;" id="invTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="invTable">
                        <thead><tr id="invTableHeader"></tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- INVENTORY HISTORY PAGE (Multi-Part Comparison) -->
        <div id="inventory-history" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="inv.historyPageTitle">üìà Inventory History</h2>
                    <p data-i18n="inv.historyPageSubtitle">Compare inventory levels over time for multiple parts</p>
                </div>
                <button class="toolbar-btn" onclick="navigateTo('inventory')">‚Üê <span data-i18n="btn.back">Back</span></button>
            </div>
            
            <div class="history-page-layout">
                <!-- Left Panel: Part Selection -->
                <div class="history-parts-panel">
                    <div class="history-panel-header">
                        <h3 data-i18n="inv.selectParts">Select Parts</h3>
                        <span class="history-selected-count" id="historySelectedCount">0 <span data-i18n="inv.selected">selected</span></span>
                    </div>
                    <input type="text" class="history-parts-search" id="historyPartsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterHistoryPartsList()">
                    <div class="history-parts-actions">
                        <button onclick="selectAllHistoryParts()" data-i18n="ui.selectAll">Select All</button>
                        <button onclick="deselectAllHistoryParts()" data-i18n="ui.deselectAll">Deselect All</button>
                    </div>
                    <div class="history-parts-list" id="historyPartsList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Right Panel: Chart and Controls -->
                <div class="history-chart-panel">
                    <div class="history-chart-controls">
                        <div class="history-date-inputs">
                            <div class="history-date-group">
                                <label data-i18n="ui.from">From</label>
                                <input type="date" id="historyPageStartDate" onchange="updateHistoryPageChart()">
                            </div>
                            <div class="history-date-group">
                                <label data-i18n="ui.to">To</label>
                                <input type="date" id="historyPageEndDate" onchange="updateHistoryPageChart()">
                            </div>
                        </div>
                        <div class="history-presets">
                            <button onclick="applyHistoryPagePreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                            <button onclick="applyHistoryPagePreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                            <button onclick="applyHistoryPagePreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                            <button onclick="applyHistoryPagePreset('all')" data-i18n="inv.allData">All Data</button>
                        </div>
                    </div>
                    
                    <div class="history-page-chart-container" id="historyPageChartContainer">
                        <canvas id="inventoryHistoryPageChart"></canvas>
                        <div class="history-page-no-selection" id="historyPageNoSelection">
                            <span data-i18n="inv.selectPartsPrompt">Select one or more parts from the list to view their inventory history</span>
                        </div>
                    </div>
                    
                    <div class="history-legend" id="historyPageLegend">
                        <!-- Populated dynamically with part colors -->
                    </div>
                    
                    <div class="history-page-stats" id="historyPageStats">
                        <!-- Populated dynamically with stats for each selected part -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SALES OVERVIEW PAGE -->
        <div id="sales-overview" class="page">
            <div class="page-header">
                <div><h2 data-i18n="sales.title">P/L Overview</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="salesBtnRollTech" onclick="toggleSalesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="salesBtnMolding" onclick="toggleSalesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="salesBtnSnapPad" onclick="toggleSalesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportSalesCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value" id="salesStatRevenue">-</div><div class="sub" id="salesStatOrderCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="salesStatPL">-</div><div class="sub" id="salesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.shippedPL">Shipped P/L</div><div class="value" id="salesStatShippedPL">-</div><div class="sub" id="salesStatShippedCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.forecastedPL">Forecasted P/L</div><div class="value" id="salesStatForecastPL">-</div><div class="sub" id="salesStatForecastCount">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLTrend">Monthly P/L Trend</h3></div>
                <div class="chart-wrapper large"><canvas id="salesTrendChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY PARTS PAGE -->
        <div id="sales-parts" class="page">
            <div class="page-header">
                <div><h2 data-i18n="parts.title">P/L by Part Number</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="partsBtnRollTech" onclick="togglePartsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="partsBtnMolding" onclick="togglePartsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="partsBtnSnapPad" onclick="togglePartsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="partsFromDate" onchange="applyPartsDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="partsToDate" onchange="applyPartsDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetPartsDateFilter()">üîÑ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="partsWatchlistBtn" onclick="togglePartsWatchlistFilter()">‚≠ê <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="partsClearFiltersBtn" onclick="clearAllTableFilters('parts')">üóë Clear Filters</button>
                <button class="toolbar-btn show-hidden-btn" id="partsShowHiddenBtn" onclick="showAllColumns('parts')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="partsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterPartsTable()">
                <button class="toolbar-btn" onclick="exportPartsCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.allPartsPL">All Parts P/L Analysis</h3></div>
                <div class="chart-wrapper large"><canvas id="partsBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.partsDetails">Parts Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="partsTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="partsTableHeader"></tr></thead><tbody id="partsTableBody"></tbody></table>
                </div>
            </div>
            <!-- Parts Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="partsCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts ‚Ä∫ <span id="partsCustomerDrilldownPart">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closePartsCustomerDrilldown()">‚úï <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="partsCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="partsCustomerDrilldownHeader"></tr></thead>
                        <tbody id="partsCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Parts Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="partsOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts ‚Ä∫ <span id="partsOrdersBreadcrumbPart">-</span> ‚Ä∫ <span id="partsOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToPartsCustomers()">‚Üê <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllPartsDrilldowns()">‚úï <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="partsOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="partsOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="partsOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY CUSTOMERS PAGE -->
        <div id="sales-customers" class="page">
            <div class="page-header">
                <div><h2 data-i18n="customers.title">P/L by Customer</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="customersBtnRollTech" onclick="toggleCustomersCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="customersBtnMolding" onclick="toggleCustomersCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="customersBtnSnapPad" onclick="toggleCustomersCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="customersFromDate" onchange="applyCustomersDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="customersToDate" onchange="applyCustomersDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetCustomersDateFilter()">üîÑ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="customersWatchlistBtn" onclick="toggleCustomersWatchlistFilter()">‚≠ê <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="customersClearFiltersBtn" onclick="clearAllTableFilters('customers')">üóë Clear Filters</button>
                <button class="toolbar-btn show-hidden-btn" id="customersShowHiddenBtn" onclick="showAllColumns('customers')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="customersSearch" data-i18n-placeholder="ui.search" placeholder="Search customers..." oninput="filterCustomersTable()">
                <button class="toolbar-btn" onclick="exportCustomersCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.customerPLDist">Customer P/L Distribution (Top 10)</h3></div>
                <div class="chart-wrapper large"><canvas id="customersChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.customerDetails">Customer Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="customersTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="customersTableHeader"></tr></thead><tbody id="customersTableBody"></tbody></table>
                </div>
            </div>
            <!-- Customers Product Drilldown (Level 1) -->
            <div class="drilldown-section" id="customersProductDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers ‚Ä∫ <span id="customersProductDrilldownCustomer">-</span></div>
                        <h3 data-i18n="drilldown.productBreakdown">Product Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeCustomersProductDrilldown()">‚úï <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="customersProductSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part Number</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Margin</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="customersProductDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Customers Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="customersOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers ‚Ä∫ <span id="customersOrdersBreadcrumbCustomer">-</span> ‚Ä∫ <span id="customersOrdersBreadcrumbPart">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToCustomersProducts()">‚Üê <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllCustomersDrilldowns()">‚úï <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="customersOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="customersOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="customersOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY DATE PAGE -->
        <div id="sales-dates" class="page">
            <div class="page-header">
                <div><h2 data-i18n="dates.title">P/L by Date</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="datesBtnRollTech" onclick="toggleDatesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="datesBtnMolding" onclick="toggleDatesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="datesBtnSnapPad" onclick="toggleDatesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="datesFromDate" onchange="applyDatesDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="datesToDate" onchange="applyDatesDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetDatesDateFilter()">üîÑ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="datesClearFiltersBtn" onclick="clearAllTableFilters('dates')">üóë Clear Filters</button>
                <button class="toolbar-btn show-hidden-btn" id="datesShowHiddenBtn" onclick="showAllColumns('dates')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportDatesCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.orders">Orders</div><div class="value" id="datesStatOrders">-</div><div class="sub" id="datesStatUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.revenue">Revenue</div><div class="value" id="datesStatRevenue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.pl">P/L</div><div class="value" id="datesStatPL">-</div><div class="sub" id="datesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.margin">Margin</div><div class="value" id="datesStatMarginPct">-</div><div class="sub" id="datesStatMonths">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLBreakdown">Monthly P/L Breakdown</h3></div>
                <div class="chart-wrapper large"><canvas id="datesBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.monthlyDetails">Monthly Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="datesTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="datesTableHeader"></tr></thead><tbody id="datesTableBody"></tbody></table>
                </div>
            </div>
            <!-- Dates Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="datesCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months ‚Ä∫ <span id="datesCustomerDrilldownMonth">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeDatesCustomerDrilldown()">‚úï <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="datesCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Customer</th><th>Orders</th><th>Quantity</th><th>Revenue</th><th>P/L</th><th>Margin</th></tr></thead>
                        <tbody id="datesCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dates Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="datesOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months ‚Ä∫ <span id="datesOrdersBreadcrumbMonth">-</span> ‚Ä∫ <span id="datesOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToDatesCustomers()">‚Üê <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllDatesDrilldowns()">‚úï <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="datesOrdersSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part</th><th>PO #</th><th>Status</th><th>Ship/Due Date</th><th>Qty</th><th>Unit Price</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="datesOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOM EXPLORER PAGE -->
        <div id="bom" class="page">
            <div class="page-header">
                <div><h2 data-i18n="bom.title">BOM Explorer</h2></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')" data-i18n="bom.finalAssembly">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')" data-i18n="bom.subAssembly">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')" data-i18n="bom.individualItems">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3 data-i18n="bom.selectPart">Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" data-i18n-placeholder="bom.searchParts" placeholder="Search parts..." oninput="filterBomSelector()">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALL DATA PAGE -->
        <div id="all-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="allData.title">All Data (Raw)</h2><p data-i18n="allData.subtitle">Complete spreadsheet data - Columns A through AX</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="allDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="allDataRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="allDataColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="allDataClearFiltersBtn" onclick="clearAllTableFilters('allData')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="allDataShowHiddenBtn" onclick="showAllColumns('allData')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="allDataGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterAllDataTable()">
                <button class="toolbar-btn" onclick="exportAllDataToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="allDataTable">
                        <thead><tr id="allDataTableHeader"></tr></thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FP REFERENCE DATA PAGE -->
        <div id="fp-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="fpRef.title">FP Reference Data</h2><p data-i18n="fpRef.subtitle">Finished Part specifications and attributes</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="fpRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="fpRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="fpRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="fpRefClearFiltersBtn" onclick="clearAllTableFilters('fpRef')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="fpRefShowHiddenBtn" onclick="showAllColumns('fpRef')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="fpRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterFpRefTable()">
                <button class="toolbar-btn" onclick="exportFpRefToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="fpRefTable">
                        <thead><tr id="fpRefTableHeader"></tr></thead>
                        <tbody id="fpRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CUSTOMER REFERENCE DATA PAGE -->
        <div id="customer-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="custRef.title">Customer Reference Data</h2><p data-i18n="custRef.subtitle">Customer pricing tiers and payment terms</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="custRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="custRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="custRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="custRefClearFiltersBtn" onclick="clearAllTableFilters('custRef')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="custRefShowHiddenBtn" onclick="showAllColumns('custRef')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="custRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterCustRefTable()">
                <button class="toolbar-btn" onclick="exportCustRefToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="custRefTable">
                        <thead><tr id="custRefTableHeader"></tr></thead>
                        <tbody id="custRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- QUOTES REGISTRY PAGE -->
        <div id="quotes-registry" class="page">
            <div class="page-header">
                <div><h2 data-i18n="quotes.title">Quotes Registry</h2><p data-i18n="quotes.subtitle">Quote records and customer quotations</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="quotesLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="quotesRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="quotesColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="quotesClearFiltersBtn" onclick="clearAllTableFilters('quotes')">üóë <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn show-hidden-btn" id="quotesShowHiddenBtn" onclick="showAllColumns('quotes')">üëÅ <span data-i18n="ui.showHidden">Show Hidden</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="quotesGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterQuotesTable()">
                <button class="toolbar-btn" onclick="exportQuotesToCSV()">üì• <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="quotesTable">
                        <thead><tr id="quotesTableHeader"></tr></thead>
                        <tbody id="quotesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // INTERNATIONALIZATION
        // ============================================================
        const translations = {
            en: {
                'logoSubtitle': 'Operations Dashboard',
                'nav.main': 'Main Dashboard',
                'nav.production': 'PRODUCTION',
                'nav.ordersData': 'Orders Data',
                'nav.ordersQueue': 'Need to Make',
                'nav.ordersStaged': 'Ready to Ship',
                'nav.ordersShipped': 'Shipped',
                'nav.inventory': 'Inventory',
                'nav.salesFinance': 'SALES & FINANCE',
                'nav.plOverview': 'P/L Overview',
                'nav.byPart': 'By Part Number',
                'nav.byCustomer': 'By Customer',
                'nav.byDate': 'By Date',
                'nav.billOfMaterials': 'BILL OF MATERIALS',
                'nav.bomExplorer': 'BOM Explorer',
                'nav.rawData': 'RAW DATA',
                'nav.allData': 'All Data',
                'nav.fpReference': 'FP Reference',
                'nav.customerReference': 'Customer Reference',
                'nav.quotesRegistry': 'Quotes Registry',
                'fpRef.title': 'FP Reference Data',
                'fpRef.subtitle': 'Finished Part specifications and attributes',
                'custRef.title': 'Customer Reference Data',
                'custRef.subtitle': 'Customer pricing tiers and payment terms',
                'quotes.title': 'Quotes Registry',
                'quotes.subtitle': 'Quote records and customer quotations',
                'allData.title': 'All Data (Raw)',
                'allData.subtitle': 'Complete spreadsheet data - Columns A through AX',
                'loading': 'Loading data from Google Sheets...',
                'main.title': 'Operations Dashboard',
                'main.subtitle': 'Real-time overview of manufacturing operations',
                'stats.needToMake': 'Need to Make',
                'stats.making': 'Making',
                'stats.readyToShip': 'Ready to Ship',
                'stats.urgent': 'Urgent',
                'stats.totalUnits': 'Total Units',
                'stats.monthRevenue': 'Month Revenue',
                'stats.monthPL': 'Month P/L',
                'stats.missingParts': 'Missing Parts',
                'status.needToMake': 'Need to Make',
                'status.making': 'Making',
                'status.readyToShip': 'Ready to Ship',
                'status.shipped': 'Shipped',
                'status.urgent': 'URGENT',
                'dept.production': 'Production Planning',
                'dept.productionDesc': 'View orders to make, component status, and production queue',
                'dept.needToMake': 'Need to Make',
                'dept.units': 'Units',
                'dept.sales': 'Sales & P/L Analytics',
                'dept.salesDesc': 'Revenue, profitability, and customer analysis',
                'dept.revenue': 'Revenue',
                'dept.profit': 'Profit',
                'dept.orders': 'Orders',
                'dept.inventory': 'Inventory Management',
                'dept.inventoryDesc': 'Stock levels, reorder points, and material tracking',
                'chart.ordersByStatus': 'Orders by Status',
                'chart.upcomingDeadlines': 'Upcoming Deadlines (Next 14 Days)',
                'ordersData.title': 'All Orders Data',
                'ordersData.subtitle': 'Complete order database with all statuses',
                'ordersQueue.title': 'Orders Queue - Need to Make',
                'ordersQueue.subtitle': 'Orders pending production (Pending + Approved status)',
                'ordersStaged.title': 'Staged Orders - Ready to Ship',
                'ordersShipped.title': 'Shipped Orders History',
                'prod.missingMsg': 'orders have missing components.',
                'btn.backToDashboard': 'Back',
                'col.line': 'Line',
                'col.priority': 'Priority',
                'col.daysUntil': 'Days Until',
                'col.requestDate': 'Request Date',
                'col.dueDate': 'Due Date',
                'col.customer': 'Customer',
                'col.ifNum': 'IF #',
                'col.part': 'Part #',
                'col.qty': 'Qty',
                'col.packaging': 'Packaging',
                'col.tire': 'Tire',
                'col.hub': 'Hub',
                'col.hubMold': 'Hub Mold',
                'col.bearings': 'Bearings',
                'col.status': 'Status',
                'col.assigned': 'Assigned To',
                'col.shippedDate': 'Shipped Date',
                'col.revenue': 'Revenue',
                'col.pl': 'P/L',
                'missing': 'Missing',
                'sales.title': 'P/L Overview',
                'inv.title': 'Inventory Management',
                'inv.historyTitle': 'Inventory History',
                'inv.clickHistory': 'Click to view history',
                'inv.last7': 'Last 7 Days',
                'inv.last30': 'Last 30 Days',
                'inv.last90': 'Last 90 Days',
                'inv.allData': 'All Data',
                'inv.current': 'Current',
                'inv.minimum': 'Minimum',
                'inv.maximum': 'Maximum',
                'inv.average': 'Average',
                'inv.noHistory': 'No history data available for this part',
                'inv.historyPageTitle': 'üìà Inventory History',
                'inv.historyPageSubtitle': 'Compare inventory levels over time for multiple parts',
                'inv.selectParts': 'Select Parts',
                'inv.selected': 'selected',
                'inv.selectPartsPrompt': 'Select one or more parts from the list to view their inventory history',
                'inv.maxPartsWarning': 'Maximum 10 parts can be compared at once',
                'nav.inventoryHistory': 'Inventory History',
                'bom.title': 'BOM Explorer',
                'col.weight': 'Weight',
                'col.dimensions': 'Dimensions',
                'col.palletNum': 'Pallet #',
                'col.partsPerPallet': 'Parts/Pallet',
                'pallet.title': 'Pallet Pictures',
                'pallet.noPictures': 'No pallet pictures found for this order.',
                'pallet.clickToView': 'Click to view full size',
                'pallet.weight': 'Weight (lbs)',
                'pallet.dimensions': 'Dimensions (in)',
                'pallet.pallets': 'Pallets',
                'pallet.totalWeight': 'Total Weight',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Search values...',
                'ui.selectAll': 'Select All',
                'ui.deselectAll': 'Deselect All',
                'ui.clear': 'Clear',
                'ui.apply': 'Apply',
                'ui.hideColumn': 'üëÅ Hide',
                'ui.showHidden': 'Show Hidden',
                'ui.filterColumn': 'Filter Column',
                'ui.search': 'Search...',
                'ui.export': 'Export',
                'ui.category': 'Category:',
                'ui.status': 'Status:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Reset (100%)',
                'ui.close': 'Close',
                'ui.closeAll': 'Close All',
                'ui.units': 'units',
                'ui.orders': 'orders',
                'ui.months': 'months',
                'ui.productTypes': 'product types',
                'ui.qty': 'Qty',
                'ui.loading': 'Loading...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Molding',
                'category.snappad': 'Snap Pad',
                'ui.from': 'From:',
                'ui.to': 'To:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total Orders',
                'stats.stagedOrders': 'Staged Orders',
                'stats.shippedOrders': 'Shipped Orders',
                'stats.totalRevenue': 'Total Revenue',
                'stats.totalPL': 'Total P/L',
                'stats.avgOrderValue': 'Avg Order Value',
                'stats.customers': 'Customers',
                'stats.dueThisWeek': 'Due This Week',
                'stats.componentsReady': 'Components Ready',
                'stats.margin': 'Margin',
                'table.orders': 'Orders',
                'table.ordersToMake': 'Orders to Make',
                'table.readyToShip': 'Ready to Ship',
                'table.shippedOrders': 'Shipped Orders',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'Shipped P/L',
                'stats.forecastedPL': 'Forecasted P/L',
                'stats.shipped': 'shipped',
                'stats.pending': 'pending',
                'stats.orders': 'Orders',
                'stats.revenue': 'Revenue',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Monthly P/L Trend',
                'chart.allPartsPL': 'All Parts P/L Analysis',
                'chart.customerPLDist': 'Customer P/L Distribution (Top 10)',
                'chart.monthlyPLBreakdown': 'Monthly P/L Breakdown',
                'table.partsDetails': 'Parts Details',
                'table.customerDetails': 'Customer Details',
                'table.monthlyDetails': 'Monthly Details',
                'parts.title': 'P/L by Part Number',
                'customers.title': 'P/L by Customer',
                'dates.title': 'P/L by Date',
                'drilldown.customerBreakdown': 'Customer Breakdown',
                'drilldown.productBreakdown': 'Product Breakdown',
                'drilldown.ordersHistory': 'Orders & Price History',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'All',
                'filter.lowStock': 'Low Stock',
                'filter.needsProduction': 'Needs Production',
                'filter.clearFilters': 'Clear Filters',
                'stats.totalItems': 'Total Items',
                'stats.lowStock': 'Low Stock',
                'stats.needsProduction': 'Needs Production',
                'stats.adequateStock': 'Adequate Stock',
                'table.inventoryStatus': 'Inventory Status',
                'bom.selectPart': 'Select a part to view BOM',
                'bom.searchParts': 'Search parts...',
                'ui.globalSearch': 'Global search...',
                'ui.rows': 'Rows:',
                'ui.columns': 'Columns:',
                'ui.items': 'items',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Final Assembly',
                'bom.subAssembly': 'Sub Assembly',
                'bom.individualItems': 'Individual Items',
                'status.low': 'LOW',
                'status.make': 'MAKE',
                'status.ok': 'OK',
                'status.missing': 'Missing',
                'status.available': 'Available',
                'btn.clearDates': 'Clear Dates',
                'btn.watchlist': 'Watchlist',
                'btn.back': 'Back',
                'btn.backToDashboard': 'Back',
                'prod.missingBanner': 'orders have missing components.',
                'ui.parts': 'parts',
                'ui.customers': 'customers'
            },
            es: {
                'logoSubtitle': 'Panel de Operaciones de Moldeo',
                'nav.main': 'Panel Principal',
                'nav.production': 'PRODUCCI√ìN',
                'nav.ordersData': 'Datos de √ìrdenes',
                'nav.ordersQueue': 'Por Fabricar',
                'nav.ordersStaged': 'Listo para Enviar',
                'nav.ordersShipped': 'Enviados',
                'nav.inventory': 'Inventario',
                'nav.salesFinance': 'VENTAS Y FINANZAS',
                'nav.plOverview': 'Resumen P/L',
                'nav.byPart': 'Por N√∫mero de Parte',
                'nav.byCustomer': 'Por Cliente',
                'nav.byDate': 'Por Fecha',
                'nav.billOfMaterials': 'LISTA DE MATERIALES',
                'nav.bomExplorer': 'Explorador BOM',
                'nav.rawData': 'DATOS CRUDOS',
                'nav.allData': 'Todos los Datos',
                'nav.fpReference': 'Referencia FP',
                'nav.customerReference': 'Referencia de Clientes',
                'nav.quotesRegistry': 'Registro de Cotizaciones',
                'fpRef.title': 'Datos de Referencia FP',
                'fpRef.subtitle': 'Especificaciones y atributos de partes terminadas',
                'custRef.title': 'Datos de Referencia de Clientes',
                'custRef.subtitle': 'Niveles de precios y t√©rminos de pago por cliente',
                'quotes.title': 'Registro de Cotizaciones',
                'quotes.subtitle': 'Registros de cotizaciones a clientes',
                'allData.title': 'Todos los Datos (Crudo)',
                'allData.subtitle': 'Datos completos de la hoja - Columnas A hasta AX',
                'loading': 'Cargando datos de Google Sheets...',
                'main.title': 'Panel de Operaciones',
                'main.subtitle': 'Vista en tiempo real de las operaciones de manufactura',
                'stats.needToMake': 'Por Fabricar',
                'stats.making': 'Fabricando',
                'stats.readyToShip': 'Listo para Enviar',
                'stats.urgent': 'Urgente',
                'stats.totalUnits': 'Unidades Totales',
                'stats.monthRevenue': 'Ingresos del Mes',
                'stats.monthPL': 'P/L del Mes',
                'stats.missingParts': 'Partes Faltantes',
                'status.needToMake': 'Por Fabricar',
                'status.making': 'Fabricando',
                'status.readyToShip': 'Listo para Enviar',
                'status.shipped': 'Enviado',
                'status.urgent': 'URGENTE',
                'dept.production': 'Planificaci√≥n de Producci√≥n',
                'dept.productionDesc': 'Ver √≥rdenes a fabricar y estado de componentes',
                'dept.needToMake': 'Por Fabricar',
                'dept.units': 'Unidades',
                'dept.sales': 'Ventas y An√°lisis P/L',
                'dept.salesDesc': 'Ingresos, rentabilidad y an√°lisis de clientes',
                'dept.revenue': 'Ingresos',
                'dept.profit': 'Ganancia',
                'dept.orders': 'Pedidos',
                'dept.inventory': 'Gesti√≥n de Inventario',
                'dept.inventoryDesc': 'Niveles de stock y seguimiento de materiales',
                'chart.ordersByStatus': '√ìrdenes por Estado',
                'chart.upcomingDeadlines': 'Pr√≥ximos Vencimientos (14 D√≠as)',
                'ordersData.title': 'Todos los Datos de √ìrdenes',
                'ordersData.subtitle': 'Base de datos completa de √≥rdenes',
                'ordersQueue.title': 'Cola de √ìrdenes - Por Fabricar',
                'ordersQueue.subtitle': '√ìrdenes pendientes de producci√≥n',
                'ordersStaged.title': '√ìrdenes en Staging - Listas para Enviar',
                'ordersShipped.title': 'Historial de √ìrdenes Enviadas',
                'prod.missingMsg': '√≥rdenes tienen componentes faltantes.',
                'btn.backToDashboard': 'Volver',
                'col.line': 'L√≠nea',
                'col.priority': 'Prioridad',
                'col.daysUntil': 'D√≠as Restantes',
                'col.requestDate': 'Fecha de Solicitud',
                'col.dueDate': 'Fecha de Entrega',
                'col.customer': 'Cliente',
                'col.ifNum': 'IF #',
                'col.part': 'Parte #',
                'col.qty': 'Cant',
                'col.packaging': 'Empaque',
                'col.tire': 'Llanta',
                'col.hub': 'Hub',
                'col.hubMold': 'Molde del Hub',
                'col.bearings': 'Baleros',
                'col.status': 'Estado',
                'col.assigned': 'Asignado a',
                'col.shippedDate': 'Fecha de Env√≠o',
                'col.revenue': 'Ingresos',
                'col.pl': 'P/L',
                'missing': 'Faltante',
                'sales.title': 'Resumen P/L',
                'inv.title': 'Gesti√≥n de Inventario',
                'inv.historyTitle': 'Historial de Inventario',
                'inv.clickHistory': 'Clic para ver historial',
                'inv.last7': '√öltimos 7 D√≠as',
                'inv.last30': '√öltimos 30 D√≠as',
                'inv.last90': '√öltimos 90 D√≠as',
                'inv.allData': 'Todos los Datos',
                'inv.current': 'Actual',
                'inv.minimum': 'M√≠nimo',
                'inv.maximum': 'M√°ximo',
                'inv.average': 'Promedio',
                'inv.noHistory': 'No hay datos hist√≥ricos disponibles para esta pieza',
                'inv.historyPageTitle': 'üìà Historial de Inventario',
                'inv.historyPageSubtitle': 'Compare niveles de inventario a lo largo del tiempo para m√∫ltiples piezas',
                'inv.selectParts': 'Seleccionar Piezas',
                'inv.selected': 'seleccionadas',
                'inv.selectPartsPrompt': 'Seleccione una o m√°s piezas de la lista para ver su historial de inventario',
                'inv.maxPartsWarning': 'M√°ximo 10 piezas se pueden comparar a la vez',
                'nav.inventoryHistory': 'Historial de Inventario',
                'bom.title': 'Explorador BOM',
                'col.weight': 'Peso',
                'col.dimensions': 'Dimensiones',
                'col.palletNum': 'Paleta #',
                'col.partsPerPallet': 'Partes/Paleta',
                'pallet.title': 'Fotos de Paletas',
                'pallet.noPictures': 'No hay fotos de paletas para esta orden.',
                'pallet.clickToView': 'Clic para ver tama√±o completo',
                'pallet.weight': 'Peso (lbs)',
                'pallet.dimensions': 'Dimensiones (pulg)',
                'pallet.pallets': 'Paletas',
                'pallet.totalWeight': 'Peso Total',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Buscar valores...',
                'ui.selectAll': 'Seleccionar Todo',
                'ui.deselectAll': 'Deseleccionar Todo',
                'ui.clear': 'Limpiar',
                'ui.apply': 'Aplicar',
                'ui.hideColumn': 'üëÅ Ocultar',
                'ui.showHidden': 'Mostrar Ocultas',
                'ui.filterColumn': 'Filtrar Columna',
                'ui.search': 'Buscar...',
                'ui.export': 'Exportar',
                'ui.category': 'Categor√≠a:',
                'ui.status': 'Estado:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Restablecer (100%)',
                'ui.close': 'Cerrar',
                'ui.closeAll': 'Cerrar Todo',
                'ui.units': 'unidades',
                'ui.orders': '√≥rdenes',
                'ui.months': 'meses',
                'ui.productTypes': 'tipos de producto',
                'ui.qty': 'Cant',
                'ui.loading': 'Cargando...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Moldeo',
                'category.snappad': 'Snap Pad',
                'ui.from': 'Desde:',
                'ui.to': 'Hasta:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total de √ìrdenes',
                'stats.stagedOrders': '√ìrdenes en Staging',
                'stats.shippedOrders': '√ìrdenes Enviadas',
                'stats.totalRevenue': 'Ingresos Totales',
                'stats.totalPL': 'P/L Total',
                'stats.avgOrderValue': 'Valor Promedio',
                'stats.customers': 'Clientes',
                'stats.dueThisWeek': 'Vence Esta Semana',
                'stats.componentsReady': 'Componentes Listos',
                'stats.margin': 'Margen',
                'table.orders': '√ìrdenes',
                'table.ordersToMake': '√ìrdenes a Fabricar',
                'table.readyToShip': 'Listo para Enviar',
                'table.shippedOrders': '√ìrdenes Enviadas',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'P/L Enviados',
                'stats.forecastedPL': 'P/L Proyectado',
                'stats.shipped': 'enviados',
                'stats.pending': 'pendientes',
                'stats.orders': '√ìrdenes',
                'stats.revenue': 'Ingresos',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Tendencia Mensual P/L',
                'chart.allPartsPL': 'An√°lisis P/L de Partes',
                'chart.customerPLDist': 'Distribuci√≥n P/L por Cliente (Top 10)',
                'chart.monthlyPLBreakdown': 'Desglose Mensual P/L',
                'table.partsDetails': 'Detalles de Partes',
                'table.customerDetails': 'Detalles de Clientes',
                'table.monthlyDetails': 'Detalles Mensuales',
                'parts.title': 'P/L por N√∫mero de Parte',
                'customers.title': 'P/L por Cliente',
                'dates.title': 'P/L por Fecha',
                'drilldown.customerBreakdown': 'Desglose por Cliente',
                'drilldown.productBreakdown': 'Desglose por Producto',
                'drilldown.ordersHistory': 'Historial de √ìrdenes y Precios',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'Todos',
                'filter.lowStock': 'Inventario Bajo',
                'filter.needsProduction': 'Requiere Producci√≥n',
                'filter.clearFilters': 'Limpiar Filtros',
                'stats.totalItems': 'Total de Art√≠culos',
                'stats.lowStock': 'Inventario Bajo',
                'stats.needsProduction': 'Requiere Producci√≥n',
                'stats.adequateStock': 'Stock Adecuado',
                'table.inventoryStatus': 'Estado del Inventario',
                'bom.selectPart': 'Seleccione una parte para ver BOM',
                'bom.searchParts': 'Buscar partes...',
                'ui.globalSearch': 'B√∫squeda global...',
                'ui.rows': 'Filas:',
                'ui.columns': 'Columnas:',
                'ui.items': 'art√≠culos',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Ensamble Final',
                'bom.subAssembly': 'Sub Ensamble',
                'bom.individualItems': 'Art√≠culos Individuales',
                'status.low': 'BAJO',
                'status.make': 'HACER',
                'status.ok': 'OK',
                'status.missing': 'Faltante',
                'status.available': 'Disponible',
                'btn.clearDates': 'Limpiar Fechas',
                'btn.watchlist': 'Lista de Seguimiento',
                'btn.back': 'Volver',
                'btn.backToDashboard': 'Volver',
                'prod.missingBanner': '√≥rdenes tienen componentes faltantes.',
                'ui.parts': 'partes',
                'ui.customers': 'clientes'
            }
        };
        
        let currentLang = 'en';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langES').classList.toggle('active', lang === 'es');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            // Handle placeholder translations
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            document.getElementById('logoSubtitle').textContent = translations[lang]['logoSubtitle'];
            // Re-render current page
            if (currentPage.startsWith('orders-')) {
                if (currentPage === 'orders-data') updateOrdersDataPage();
                else if (currentPage === 'orders-queue') updateOrdersQueuePage();
                else if (currentPage === 'orders-staged') updateOrdersStagedPage();
                else if (currentPage === 'orders-shipped') updateOrdersShippedPage();
            } else if (currentPage === 'inventory') updateInventoryPage();
            else if (currentPage === 'inventory-history') updateInventoryHistoryPage();
            else if (currentPage === 'main') updateMainDashboard();
            else if (currentPage === 'sales-overview') updateSalesOverview();
            else if (currentPage === 'sales-parts') updateSalesPartsPage();
            else if (currentPage === 'sales-customers') updateSalesCustomersPage();
            else if (currentPage === 'sales-dates') updateSalesDatesPage();
            else if (currentPage === 'fp-reference') renderFpRefTable();
            else if (currentPage === 'customer-reference') renderCustRefTable();
            else if (currentPage === 'quotes-registry') renderQuotesTable();
        }
        
        function t(key) { return translations[currentLang][key] || key; }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const MAIN_DATA_GID = '290032634';
        const FUSION_EXPORT_GID = '1805754553';
        const PROD_DATA_TOTALS_GID = '148810546';
        const CONFIG_GID = '912029812';
        const PALLET_PICTURES_GID = '1879462508';
        const BOM_FINAL_GID = '74377031';
        const BOM_SUB_GID = '206288913';
        const BOM_INDIVIDUAL_GID = '751106736';
        const INVENTORY_HISTORY_GID = '171540940';  // Fusion records export (daily snapshots)
        const FP_REFERENCE_GID = '944406361';  // FP Reference data
        const CUSTOMER_REFERENCE_GID = '336333220';  // Customer Reference data Dashboard
        const QUOTES_REGISTRY_GID = '1279128282';  // Quotes Registry
        
        const COL = {
            CATEGORY: 'Category',
            REQUEST_DATE: 'Date of Request',
            PRIORITY: 'Priority Level',
            URGENT: 'Urgent Override',
            LINE: 'Line',
            CUSTOMER: 'Customer',
            IF_NUM: 'IF #',
            PART: 'Part #',
            QTY: 'Order Qty',
            PACKAGING: 'Packaging (tipo de empaquetado)',
            TIRE: 'Tire',
            HUB: 'Hub',
            HUB_MOLD: 'Hub Mold',
            BEARINGS: 'Bearings',
            ASSIGNED: 'Assigned to',
            STATUS: 'Work order Internal Status',
            FUSION_STATUS: 'IF Status in Fusion',
            DAYS_UNTIL: 'Days until promise date',
            SHIPPED_DATE: 'Shipped Date',
            REQUESTED_DATE: 'Requested Completion Date',
            REVENUE: 'Revenue',
            PL: 'P/L',
            PL_TOTAL: 'P/L total',
            VARIABLE_COST: 'Variable Cost',
            TOTAL_COST: 'Total Cost'
        };
        
        const COL_ALTS = {
            CATEGORY: ['Category', 'Categoria'],
            REQUEST_DATE: ['Date of Request', 'Fecha de Entrega', 'Requested Completion Date'],
            PRIORITY: ['Priority Level', 'Prioridad', 'Priority'],
            LINE: ['Line', 'Linea'],
            CUSTOMER: ['Customer', 'Cliente'],
            PART: ['Part #', 'Numero de parte', 'RT Part #', 'Part Number'],
            QTY: ['Order Qty', 'Cantidad de la orden', 'Qty', 'Quantity'],
            PACKAGING: ['Packaging (tipo de empaquetado)', 'tipo de empaquetado', 'Packaging'],
            TIRE: ['Tire', 'Tire (Llanta)', 'Llanta'],
            HUB: ['Hub', 'Centro', 'Cubo'],
            HUB_MOLD: ['Hub Mold', 'Hub Mold (Molde del Hub)', 'Molde del Hub'],
            BEARINGS: ['Bearings', 'Bearings (Balero)', 'Balero', 'Baleros'],
            ASSIGNED: ['Assigned to', 'Assigned to:', 'Assigned to: (Asignado a:)', 'Asignado a'],
            STATUS: ['Work order Internal Status', 'Work order Status', 'Status', 'Estado'],
            FUSION_STATUS: ['IF Status in Fusion', 'IF Status', 'Fusion Status'],
            DAYS_UNTIL: ['Days until promise date', 'Days until promise date.', 'Dias faltantes', 'Days until', 'Days remaining'],
            IF_NUM: ['IF #', 'IF#', 'IF Number'],
            PL: ['P/L', 'P/L total', 'PL', 'Profit/Loss'],
            REVENUE: ['Revenue', 'Total Sell Price', 'Sales']
        };
        
        function getVal(row, key) {
            const normalize = s => s.toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (row[COL[key]] !== undefined && row[COL[key]] !== null) return row[COL[key]];
            const alts = COL_ALTS[key];
            if (alts) {
                for (const alt of alts) {
                    if (row[alt] !== undefined && row[alt] !== null) return row[alt];
                }
            }
            const targetNames = alts ? [COL[key], ...alts] : [COL[key]];
            for (const target of targetNames) {
                if (!target) continue;
                const targetNorm = normalize(target);
                for (const k of Object.keys(row)) {
                    if (normalize(k) === targetNorm) return row[k];
                }
            }
            return null;
        }
        
        // State
        let allData = [];
        let allRawData = []; // Stores ALL columns A-AX for All Data page
        let allRawHeaders = []; // Column headers from spreadsheet
        let inventoryData = [];
        let palletData = []; // Stores pallet pictures data
        let bomFinalData = [], bomSubData = [], bomIndividualData = [];
        let currentBomTab = 'final';
        
        // Reference Data state (FP Reference, Customer Reference, Quotes Registry)
        let fpReferenceData = [];
        let fpReferenceHeaders = [];
        let customerReferenceData = [];
        let customerReferenceHeaders = [];
        let quotesRegistryData = [];
        let quotesRegistryHeaders = []; // Now loaded from spreadsheet (columns A-J only)
        
        // Inventory History state (for historical tracking charts)
        let inventoryHistoryData = [];      // Raw data: [{partNumber, dataByDate: {date: qty}}]
        let inventoryHistoryDates = [];     // Array of available dates (sorted)
        let inventoryHistoryLoaded = false; // Lazy loading flag
        let currentHistoryPart = null;      // Currently viewed part in history modal
        let historyDateRange = { start: null, end: null }; // Date range filter
        
        // Multi-part history page state
        let selectedHistoryParts = new Set();  // Selected parts for comparison
        let historyPageDateRange = { start: null, end: null }; // Date range for history page
        const historyPartColors = [
            '#3182ce', '#38a169', '#d69e2e', '#805ad5', '#dd6b20',
            '#319795', '#e53e3e', '#667eea', '#48bb78', '#ed8936'
        ]; // Colors for multi-part chart
        
        let config = {};
        let charts = {};
        let currentPage = 'main';
        let currentPalletOrder = null; // Currently viewed pallet order
        
        // Filter states for each page
        let ordersDataFilters = { categories: { rolltech: true, molding: true, snappad: true }, statuses: { pending: true, wip: true, staged: true, shipped: false } };
        let ordersQueueFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersStagedFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersShippedFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let salesFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let datesFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let partsFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        let customersFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        
        // Sort states
        let ordersDataSort = { field: 'daysUntil', asc: true };
        let ordersQueueSort = { field: 'daysUntil', asc: true };
        let ordersStagedSort = { field: 'customer', asc: true };
        let ordersShippedSort = { field: 'shippedDate', asc: false };
        let invFilter = 'all';
        let invSort = { field: 'partNumber', asc: true };
        let partsSort = { field: 'pl', asc: false };
        let customersSort = { field: 'pl', asc: false };
        let datesSort = { field: 'month', asc: false };
        let partsCustomerDrilldownSort = { field: 'pl', asc: false };
        let customersProductDrilldownSort = { field: 'pl', asc: false };
        let allDataSort = { field: null, asc: true };
        let fpRefSort = { field: null, asc: true };
        let custRefSort = { field: null, asc: true };
        let quotesSort = { field: null, asc: true };
        
        // Column Filter System State
        let columnFilters = {}; // { tableId: { columnKey: Set(selectedValues) } }
        let hiddenColumns = {}; // { tableId: Set(columnKeys) }
        let activeFilterDropdown = null; // { tableId, columnKey, allValues, selectedValues }
        
        // Drilldown state
        let currentDrilldownPart = null;
        let currentDrilldownCustomer = null;
        let currentDrilldownMonth = null;
        
        // Watchlist (localStorage persistence)
        let watchlistParts = [];
        let watchlistCustomers = [];
        try {
            watchlistParts = JSON.parse(localStorage.getItem('rolltech_watchlist_parts') || '[]');
            watchlistCustomers = JSON.parse(localStorage.getItem('rolltech_watchlist_customers') || '[]');
        } catch(e) { console.warn('Could not load watchlist from localStorage'); }

        // ============================================================
        // UTILITIES
        // ============================================================
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,%\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); return parseFloat(c) || 0; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const isEmpty = v => v === null || v === undefined || v === '';
        const isMissingComponent = v => v === null || v === undefined || v === '' || v === '-';
        const hasMissingCostData = row => isEmpty(row[COL.VARIABLE_COST]) || isEmpty(row[COL.TOTAL_COST]) || (isEmpty(row[COL.PL]) && isEmpty(row[COL.PL_TOTAL]));
        const getPLValue = row => { if (!isEmpty(row[COL.PL])) return parseNumber(row[COL.PL]); if (!isEmpty(row[COL.PL_TOTAL])) return parseNumber(row[COL.PL_TOTAL]); return 0; };
        
        // v5 Helper Functions
        const getAttributionDate = row => {
            const status = getStatus(row);
            if (status === 'shipped') return row[COL.SHIPPED_DATE];
            return row[COL.REQUESTED_DATE] || getVal(row, 'REQUEST_DATE');
        };
        
        const getMonthKey = dateStr => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr.substring(0, 7);
        };
        
        const formatMonthLabel = monthKey => {
            if (!monthKey) return '-';
            const [year, month] = monthKey.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(month) - 1]} ${year}`;
        };
        
        const getUnitPrice = row => {
            const unitPrice = parseNumber(row[COL.UNIT_PRICE]);
            if (unitPrice > 0) return unitPrice;
            const revenue = parseNumber(row[COL.REVENUE]);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? revenue / qty : 0;
        };
        
        const getProfitPerPart = row => {
            const pl = getPLValue(row);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? pl / qty : 0;
        };
        
        // Watchlist functions
        function isInWatchlist(type, value) {
            if (type === 'part') return watchlistParts.includes(value);
            if (type === 'customer') return watchlistCustomers.includes(value);
            return false;
        }
        
        function toggleWatchlistPart(part) {
            const idx = watchlistParts.indexOf(part);
            if (idx > -1) watchlistParts.splice(idx, 1);
            else watchlistParts.push(part);
            try { localStorage.setItem('rolltech_watchlist_parts', JSON.stringify(watchlistParts)); } catch(e) {}
            updateSalesPartsPage();
        }
        
        function toggleWatchlistCustomer(customer) {
            const idx = watchlistCustomers.indexOf(customer);
            if (idx > -1) watchlistCustomers.splice(idx, 1);
            else watchlistCustomers.push(customer);
            try { localStorage.setItem('rolltech_watchlist_customers', JSON.stringify(watchlistCustomers)); } catch(e) {}
            updateSalesCustomersPage();
        }
        
        const getContributionBadge = margin => {
            if (margin < -10) return '<span class="badge" style="background:var(--danger);">CRITICAL</span>';
            if (margin < 0) return '<span class="badge" style="background:var(--warning);color:#1a202c;">LOW</span>';
            if (margin < 15) return '<span class="badge" style="background:var(--accent);">TARGET</span>';
            return '<span class="badge" style="background:var(--success);">PROFITABLE</span>';
        };
        
        const getCategory = row => {
            const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        };
        
        // UPDATED: Uses FUSION_STATUS (Col G) as fallback when STATUS (Col H) is empty
        const getStatus = row => {
            // Check Work order Internal Status first (Column H)
            let status = (getVal(row, 'STATUS') || '').toLowerCase();
            
            // If STATUS is empty or unclear, use IF Status in Fusion (Column G) as fallback
            if (!status || status === '') {
                status = (getVal(row, 'FUSION_STATUS') || '').toLowerCase();
            }
            
            if (status.includes('pending') || status.includes('approved')) return 'pending';
            if (status.includes('staged')) return 'staged';
            if (status.includes('work in progress') || status.includes('wip')) return 'wip';
            if (status.includes('shipped') || status.includes('invoiced') || status.includes('to bill')) return 'shipped';
            return status;
        };
        
        // UPDATED: Uses translated labels
        const getStatusBadge = status => {
            const s = (status || '').toLowerCase();
            if (s.includes('shipped') || s === 'shipped') return `<span class="badge shipped">${t('status.shipped')}</span>`;
            if (s.includes('pending') || s.includes('approved') || s === 'pending') return `<span class="badge pending">${t('status.needToMake')}</span>`;
            if (s.includes('staged') || s === 'staged') return `<span class="badge staged">${t('status.readyToShip')}</span>`;
            if (s.includes('work in progress') || s.includes('wip') || s === 'wip') return `<span class="badge wip">${t('status.making')}</span>`;
            return `<span class="badge">${status || '-'}</span>`;
        };
        
        // UPDATED: Uses translated "URGENT" label
        const getPriorityBadge = (priority, urgent) => {
            const p = parseNumber(priority);
            const isUrgent = (urgent || '').toLowerCase() === 'urgent';
            if (isUrgent) return `<span class="badge urgent">${t('status.urgent')}</span>`;
            if (p === 1) return '<span class="badge priority-1">P1</span>';
            if (p === 2) return '<span class="badge priority-2">P2</span>';
            if (p === 3) return '<span class="badge priority-3">P3</span>';
            if (p === 4) return '<span class="badge priority-4">P4</span>';
            return `<span class="badge">P${p || '-'}</span>`;
        };
        
        const formatComponent = (value) => {
            if (isMissingComponent(value)) return `<span class="cell-missing">${t('missing')}</span>`;
            if (value === 'NA' || value === 'N/A') return `<span style="color:var(--text-secondary);">NA</span>`;
            return `<span class="cell-available">${value}</span>`;
        };

        // ============================================================
        // COLUMN FILTER SYSTEM
        // ============================================================
        function initTableFilters(tableId) {
            if (!columnFilters[tableId]) columnFilters[tableId] = {};
        }
        
        function createFilterHeader(tableId, columnKey, label, sortable = true) {
            initTableFilters(tableId);
            const isFiltered = columnFilters[tableId][columnKey] && columnFilters[tableId][columnKey].size > 0;
            const filteredClass = isFiltered ? 'filtered' : '';
            const filterIndicator = isFiltered ? ' üìã' : '';
            return `<th class="filter-th ${filteredClass}">
                <div class="filter-th-content">
                    <span>${label}${filterIndicator}</span>
                    <div class="filter-th-btns">
                        ${sortable ? `<button onclick="sortTableColumn('${tableId}', '${columnKey}')" title="Sort">‚Üï</button>` : ''}
                        <button onclick="openColumnFilter('${tableId}', '${columnKey}', this)" title="Filter">√¢‚Äì¬º</button>
                    </div>
                </div>
            </th>`;
        }
        
        function sortTableColumn(tableId, columnKey) {
            // Delegate to existing sort functions based on tableId
            switch(tableId) {
                case 'parts': sortPartsTable(columnKey); break;
                case 'customers': sortCustomersTable(columnKey); break;
                case 'ordersData': sortOrdersDataTable(columnKey); break;
                case 'ordersQueue': sortOrdersQueueTable(columnKey); break;
                case 'ordersStaged': sortOrdersStagedTable(columnKey); break;
                case 'ordersShipped': sortOrdersShippedTable(columnKey); break;
                case 'inventory': sortInvTable(columnKey); break;
                case 'dates': sortDatesTable(columnKey); break;
                case 'allData': sortAllDataTable(columnKey); break;
                case 'fpRef': sortFpRefTable(columnKey); break;
                case 'custRef': sortCustRefTable(columnKey); break;
                case 'quotes': sortQuotesTable(columnKey); break;
            }
        }
        
        function openColumnFilter(tableId, columnKey, buttonEl) {
            initTableFilters(tableId);
            const allValues = getUniqueValuesForColumn(tableId, columnKey);
            const currentFilter = columnFilters[tableId][columnKey];
            const selectedValues = currentFilter ? new Set(currentFilter) : new Set(allValues);
            
            activeFilterDropdown = { tableId, columnKey, allValues: [...allValues], selectedValues };
            
            const dropdown = document.getElementById('columnFilterDropdown');
            document.getElementById('filterDropdownTitle').textContent = `Filter: ${columnKey}`;
            document.getElementById('filterDropdownSearch').value = '';
            renderFilterValues(allValues, selectedValues);
            
            // Position dropdown near button
            const rect = buttonEl.getBoundingClientRect();
            dropdown.style.top = Math.min(rect.bottom + 5, window.innerHeight - 420) + 'px';
            dropdown.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
            dropdown.classList.add('active');
        }
        
        function closeFilterDropdown() {
            document.getElementById('columnFilterDropdown').classList.remove('active');
            activeFilterDropdown = null;
        }
        
        function renderFilterValues(values, selectedSet, searchTerm = '') {
            const list = document.getElementById('filterValuesList');
            const filtered = searchTerm ? values.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase())) : values;
            list.innerHTML = filtered.map(v => {
                const checked = selectedSet.has(v) ? 'checked' : '';
                const displayVal = v === '' ? '(empty)' : v;
                return `<div class="filter-value-item">
                    <input type="checkbox" id="fv_${encodeURIComponent(v)}" ${checked} onchange="toggleFilterValue('${encodeURIComponent(v)}')">
                    <label for="fv_${encodeURIComponent(v)}">${displayVal}</label>
                </div>`;
            }).join('');
        }
        
        function filterDropdownSearch() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value;
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function toggleFilterValue(encodedValue) {
            if (!activeFilterDropdown) return;
            const value = decodeURIComponent(encodedValue);
            if (activeFilterDropdown.selectedValues.has(value)) {
                activeFilterDropdown.selectedValues.delete(value);
            } else {
                activeFilterDropdown.selectedValues.add(value);
            }
        }
        
        function filterSelectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.add(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function filterDeselectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.delete(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function clearColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            delete columnFilters[tableId][columnKey];
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function applyColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey, allValues, selectedValues } = activeFilterDropdown;
            
            // If all selected, remove filter; otherwise save it
            if (selectedValues.size === allValues.length) {
                delete columnFilters[tableId][columnKey];
            } else if (selectedValues.size === 0) {
                // Don't allow empty filter - select all instead
                delete columnFilters[tableId][columnKey];
            } else {
                columnFilters[tableId][columnKey] = new Set(selectedValues);
            }
            
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function clearAllTableFilters(tableId) {
            columnFilters[tableId] = {};
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function updateClearAllButton(tableId) {
            const btnId = tableId + 'ClearFiltersBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hasFilters = columnFilters[tableId] && Object.keys(columnFilters[tableId]).length > 0;
                btn.classList.toggle('has-filters', hasFilters);
            }
        }
        
        function refreshTableAfterFilter(tableId) {
            switch(tableId) {
                case 'parts': updateSalesPartsPage(); break;
                case 'customers': updateSalesCustomersPage(); break;
                case 'ordersData': updateOrdersDataPage(); break;
                case 'ordersQueue': updateOrdersQueuePage(); break;
                case 'ordersStaged': updateOrdersStagedPage(); break;
                case 'ordersShipped': updateOrdersShippedPage(); break;
                case 'inventory': renderInvTable(); break;
                case 'dates': updateSalesDatesPage(); break;
                case 'allData': renderAllDataTable(); break;
                case 'fpRef': renderFpRefTable(); break;
                case 'custRef': renderCustRefTable(); break;
                case 'quotes': renderQuotesTable(); break;
            }
        }
        
        function passesColumnFilter(tableId, columnKey, value) {
            if (!columnFilters[tableId] || !columnFilters[tableId][columnKey]) return true;
            return columnFilters[tableId][columnKey].has(value);
        }
        
        // ============================================================
        // HIDE COLUMNS SYSTEM
        // ============================================================
        function initHiddenColumns(tableId) {
            if (!hiddenColumns[tableId]) hiddenColumns[tableId] = new Set();
        }
        
        function isColumnHidden(tableId, columnKey) {
            return hiddenColumns[tableId] && hiddenColumns[tableId].has(columnKey);
        }
        
        function hideCurrentColumn() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            hideColumn(tableId, columnKey);
            closeFilterDropdown();
        }
        
        function hideColumn(tableId, columnKey) {
            initHiddenColumns(tableId);
            hiddenColumns[tableId].add(columnKey);
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function showAllColumns(tableId) {
            if (hiddenColumns[tableId]) {
                hiddenColumns[tableId].clear();
            }
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function updateShowHiddenButton(tableId) {
            const btnId = tableId + 'ShowHiddenBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hiddenCount = hiddenColumns[tableId] ? hiddenColumns[tableId].size : 0;
                const hasHidden = hiddenCount > 0;
                btn.classList.toggle('has-hidden', hasHidden);
                // Update button text with count
                const spanEl = btn.querySelector('span');
                if (spanEl) {
                    spanEl.textContent = hasHidden ? `${t('ui.showHidden')} (${hiddenCount})` : t('ui.showHidden');
                }
            }
        }
        
        function getVisibleHeaders(tableId, allHeaders) {
            if (!hiddenColumns[tableId] || hiddenColumns[tableId].size === 0) return allHeaders;
            return allHeaders.filter((h, i) => !hiddenColumns[tableId].has(h) && !hiddenColumns[tableId].has(`col_${i}`));
        }
        
        function getUniqueValuesForColumn(tableId, columnKey) {
            const values = new Set();
            
            switch(tableId) {
                case 'parts':
                    return getUniquePartsColumnValues(columnKey);
                case 'customers':
                    return getUniqueCustomersColumnValues(columnKey);
                case 'ordersData':
                case 'ordersQueue':
                case 'ordersStaged':
                case 'ordersShipped':
                    return getUniqueOrdersColumnValues(tableId, columnKey);
                case 'inventory':
                    return getUniqueInventoryColumnValues(columnKey);
                case 'dates':
                    return getUniqueDatesColumnValues(columnKey);
                case 'allData':
                    return getUniqueAllDataColumnValues(columnKey);
                case 'fpRef':
                    return getUniqueFpRefColumnValues(columnKey);
                case 'custRef':
                    return getUniqueCustRefColumnValues(columnKey);
                case 'quotes':
                    return getUniqueQuotesColumnValues(columnKey);
            }
            return Array.from(values).sort();
        }
        
        function getUniquePartsColumnValues(columnKey) {
            const data = getFilteredPartsData();
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(partStats).forEach(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'part': values.add(part); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueCustomersColumnValues(columnKey) {
            const data = getFilteredCustomersData();
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(custStats).forEach(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'customer': values.add(customer); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueOrdersColumnValues(tableId, columnKey) {
            let data = allData;
            // Filter based on table type
            if (tableId === 'ordersQueue') data = data.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            else if (tableId === 'ordersStaged') data = data.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            else if (tableId === 'ordersShipped') data = data.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            else if (tableId === 'ordersData') data = data.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            
            const values = new Set();
            data.forEach(r => {
                switch(columnKey) {
                    case 'line': values.add(getVal(r, 'LINE') || '-'); break;
                    case 'priority': values.add(getVal(r, 'PRIORITY') || '-'); break;
                    case 'customer': values.add(getVal(r, 'CUSTOMER') || '-'); break;
                    case 'part': values.add(getVal(r, 'PART') || '-'); break;
                    case 'status': values.add(getStatus(r)); break;
                    case 'tire': values.add(isMissingComponent(getVal(r, 'TIRE')) ? 'Missing' : 'Available'); break;
                    case 'hub': values.add(isMissingComponent(getVal(r, 'HUB')) ? 'Missing' : 'Available'); break;
                    case 'bearings': values.add(isMissingComponent(getVal(r, 'BEARINGS')) ? 'Missing' : 'Available'); break;
                    case 'assigned': values.add(getVal(r, 'ASSIGNED') || '-'); break;
                    case 'packaging': values.add(getVal(r, 'PACKAGING') || '-'); break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueInventoryColumnValues(columnKey) {
            const values = new Set();
            inventoryData.forEach(i => {
                switch(columnKey) {
                    case 'product': values.add(i.product || '-'); break;
                    case 'partNumber': values.add(i.partNumber); break;
                    case 'fusionQty': values.add(String(i.fusionQty)); break;
                    case 'minimum': values.add(String(i.minimum)); break;
                    case 'manualTarget': values.add(String(i.manualTarget)); break;
                    case 'qtyNeeded': values.add(String(i.qtyNeeded)); break;
                    case 'partsToBeMade': values.add(String(i.partsToBeMade)); break;
                    case 'moldType': values.add(i.moldType || '-'); break;
                    case 'status':
                        const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                        const needsMake = i.partsToBeMade > 0;
                        values.add(isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK'));
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueDatesColumnValues(columnKey) {
            const data = getFilteredDatesData();
            const monthStats = {};
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, pl: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (getStatus(r) === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) monthStats[month].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(monthStats).forEach(([month, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'month': values.add(formatMonthLabel(month)); break;
                    case 'status': values.add(`${stats.shipped}/${stats.orders} Shipped`); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('columnFilterDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!dropdown.contains(e.target) && !e.target.closest('.filter-th-btns')) {
                    closeFilterDropdown();
                }
            }
        });

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function fetchSheetData(gid, captureHeaders = false) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const headers = json.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
            if (captureHeaders) allRawHeaders = headers.filter(h => h); // Store non-empty headers
            return json.table.rows.map(r => {
                const obj = {};
                headers.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f || r.c[i].v || '') : ''; });
                return obj;
            });
        }
        
        async function loadDashboard() {
            try {
                const raw = await fetchSheetData(MAIN_DATA_GID, true); // Pass true to capture headers
                allRawData = raw; // Store ALL raw data for All Data page
                allData = raw.filter(r => {
                    const cat = getCategory(r);
                    return (cat === 'rolltech' || cat === 'molding' || cat === 'snappad') && getVal(r, 'PART');
                });
                if (allData.length === 0) allData = raw.filter(r => getVal(r, 'PART'));
                
                loadInventoryData().catch(e => console.warn('Inventory load failed:', e));
                loadBOMData().catch(e => console.warn('BOM load failed:', e));
                fetchPalletData().catch(e => console.warn('Pallet data load failed:', e));
                
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${allData.length} orders<br>${now.toLocaleTimeString()}`;
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('main').classList.add('active');
                updateMainDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">‚ö†¬†¬è Error</h3><p>${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }
        
        async function loadInventoryData() {
            try {
                const fusionData = await fetchSheetData(FUSION_EXPORT_GID);
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                console.log('Inventory Debug v7.5 - Prod Totals columns:', prodTotalsData.length > 0 ? Object.keys(prodTotalsData[0]) : 'No data');
                console.log('Inventory Debug v7.5 - First Prod Totals row:', prodTotalsData[0]);
                const prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum) {
                        const fusionInv = parseNumber(row['Fusion inventory']) || parseNumber(row['Fusion Inventory']);
                        if (partNum === 'FS-TPO' || partNum === 'FS-URTH-BRN') {
                            console.log('Inventory Debug v7.5 - ' + partNum + ':', { 
                                fusionInventory: fusionInv, 
                                rawLower: row['Fusion inventory'], 
                                rawUpper: row['Fusion Inventory'] 
                            });
                        }
                        prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            qtyNeeded: parseNumber(row['Quantity Needed']),
                            minimums: parseNumber(row['Minimums']),
                            manualTarget: parseNumber(row['Manual target']),
                            moldType: row['Mold type'] || '',
                            fusionInventory: fusionInv,
                            partsToBeMade: parseNumber(row['Parts to be made'])
                        };
                    }
                });
                const mergedData = [];
                const seenParts = new Set();
                fusionData.forEach(row => {
                    let partNum = (row['itemNumber'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (!partNum) return;
                    seenParts.add(partNum);
                    const prodData = prodTotalsMap[partNum] || {};
                    const fusionTarget = parseNumber(row['Target']);
                    const fusionExportQty = parseNumber(row['Real number value']);
                    // Use Fusion Export qty if available, otherwise fall back to Production Data Totals
                    const finalFusionQty = fusionExportQty > 0 ? fusionExportQty : (prodData.fusionInventory || 0);
                    mergedData.push({
                        partNumber: partNum,
                        product: prodData.product || '',
                        fusionQty: finalFusionQty,
                        minimum: prodData.minimums || fusionTarget || 0,
                        manualTarget: prodData.manualTarget || 0,
                        qtyNeeded: prodData.qtyNeeded || 0,
                        partsToBeMade: prodData.partsToBeMade || 0,
                        moldType: prodData.moldType || ''
                    });
                });
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum && !seenParts.has(partNum)) {
                        const data = prodTotalsMap[partNum];
                        mergedData.push({
                            partNumber: partNum,
                            product: data.product || '',
                            fusionQty: data.fusionInventory || 0,
                            minimum: data.minimums || 0,
                            manualTarget: data.manualTarget || 0,
                            qtyNeeded: data.qtyNeeded || 0,
                            partsToBeMade: data.partsToBeMade || 0,
                            moldType: data.moldType || ''
                        });
                    }
                });
                inventoryData = mergedData;
            } catch (e) { console.error('Inventory load error:', e); inventoryData = []; }
        }
        
        // Load historical inventory data (lazy loaded when needed)
        async function loadInventoryHistoryData() {
            if (inventoryHistoryLoaded) return; // Already loaded
            try {
                console.log('Loading inventory history data...');
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${INVENTORY_HISTORY_GID}`;
                const response = await fetch(url);
                const csvText = await response.text();
                
                // Parse CSV manually to preserve date headers
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.warn('No inventory history data found');
                    inventoryHistoryLoaded = true;
                    return;
                }
                
                // Parse header row to get dates (skip first column which is itemNumber)
                const headerRow = parseCSVLine(lines[0]);
                inventoryHistoryDates = [];
                for (let i = 1; i < headerRow.length; i++) {
                    const dateStr = headerRow[i].trim().replace(/^"|"$/g, '');
                    if (dateStr && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        inventoryHistoryDates.push(dateStr);
                    }
                }
                console.log(`Found ${inventoryHistoryDates.length} date columns`);
                
                // Parse data rows
                inventoryHistoryData = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    const partNumber = (row[0] || '').trim().replace(/^"|"$/g, '');
                    if (!partNumber) continue;
                    
                    const dataByDate = {};
                    for (let j = 1; j < row.length && j <= inventoryHistoryDates.length; j++) {
                        const qty = parseNumber(row[j]);
                        const date = inventoryHistoryDates[j - 1];
                        if (date) dataByDate[date] = qty;
                    }
                    
                    inventoryHistoryData.push({ partNumber, dataByDate });
                }
                console.log(`Loaded history for ${inventoryHistoryData.length} parts`);
                inventoryHistoryLoaded = true;
            } catch (e) {
                console.error('Inventory history load error:', e);
                inventoryHistoryData = [];
                inventoryHistoryDates = [];
            }
        }
        
        // Helper to parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        async function loadBOMData() {
            try {
                bomIndividualData = await fetchSheetData(BOM_INDIVIDUAL_GID);
                bomSubData = await fetchSheetData(BOM_SUB_GID);
                bomFinalData = await fetchSheetData(BOM_FINAL_GID);
            } catch (e) { console.warn('BOM load error:', e); }
        }
        
        async function fetchPalletData() {
            try {
                const data = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Raw pallet data first row keys:', data.length > 0 ? Object.keys(data[0]) : 'no data');
                console.log('Raw pallet data sample row:', data[0]);
                
                palletData = data.map(row => {
                    // Get all keys to find the right columns
                    const keys = Object.keys(row);
                    
                    // Find order number - try various patterns
                    let orderNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('order') && k.toLowerCase().includes('number')) {
                            orderNum = row[k];
                            break;
                        }
                    }
                    if (!orderNum) orderNum = row[keys[1]] || ''; // Fallback to column B
                    
                    // Find pallet number
                    let palletNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('pallet') && k.toLowerCase().includes('number')) {
                            palletNum = row[k];
                            break;
                        }
                    }
                    if (!palletNum) palletNum = row[keys[2]] || ''; // Fallback to column C
                    
                    // Find picture URL
                    let pictureUrl = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('picture') && !k.includes('2') && !k.includes('3') && !k.includes('4') && !k.includes('5')) {
                            pictureUrl = row[k];
                            break;
                        }
                    }
                    if (!pictureUrl) pictureUrl = row[keys[3]] || ''; // Fallback to column D
                    
                    // Find weight
                    let weight = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('weight')) {
                            weight = row[k];
                            break;
                        }
                    }
                    if (!weight) weight = row[keys[4]] || ''; // Fallback to column E
                    
                    // Find dimensions
                    let dims = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('dimension')) {
                            dims = row[k];
                            break;
                        }
                    }
                    if (!dims) dims = row[keys[5]] || ''; // Fallback to column F
                    
                    return {
                        orderNumber: String(orderNum).trim(),
                        palletNumber: palletNum,
                        pictureUrl: pictureUrl,
                        weight: weight,
                        dimensions: dims
                    };
                }).filter(p => p.orderNumber && p.orderNumber !== '');
                
                console.log('Pallet data loaded:', palletData.length, 'entries');
                if (palletData.length > 0) {
                    console.log('Sample parsed pallet:', palletData[0]);
                    // Log unique order numbers for debugging
                    const uniqueOrders = [...new Set(palletData.map(p => p.orderNumber))];
                    console.log('Unique order numbers in pallet data:', uniqueOrders.slice(0, 20));
                }
            } catch (e) { 
                console.error('Pallet data load error:', e); 
                palletData = []; 
            }
        }

        // ============================================================
        // SALES PASSWORD PROTECTION
        // ============================================================
        // Simple hash function to obscure password (not cryptographically secure, but deters casual inspection)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        const SALES_HASH = '2001594324'; // Hash of 'Sales@@@'
        let salesUnlocked = sessionStorage.getItem('salesUnlocked') === 'true';
        
        function checkSalesUnlock() {
            if (salesUnlocked) {
                // Show Sales & Finance items
                document.getElementById('salesNavItems').style.display = 'block';
                document.getElementById('salesNavTitle').classList.remove('sales-locked');
                document.getElementById('salesNavTitle').classList.add('sales-unlocked');
                document.getElementById('salesNavTitle').onclick = null;
                document.getElementById('salesNavTitle').innerHTML = '<span class="lock-icon">üîì</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>';
                
                // Show BOM Explorer section
                document.getElementById('bomNavSection').style.display = 'block';
                
                // Unlock All Data nav item
                const allDataNav = document.getElementById('allDataNavItem');
                allDataNav.classList.remove('locked-item');
                allDataNav.onclick = function() { navigateTo('all-data'); };
                
                // Unlock FP Reference nav item
                const fpRefNav = document.getElementById('fpRefNavItem');
                if (fpRefNav) {
                    fpRefNav.classList.remove('locked-item');
                    fpRefNav.onclick = function() { navigateTo('fp-reference'); };
                }
                
                // Unlock Customer Reference nav item
                const custRefNav = document.getElementById('custRefNavItem');
                if (custRefNav) {
                    custRefNav.classList.remove('locked-item');
                    custRefNav.onclick = function() { navigateTo('customer-reference'); };
                }
                
                // Unlock Quotes Registry nav item
                const quotesNav = document.getElementById('quotesNavItem');
                if (quotesNav) {
                    quotesNav.classList.remove('locked-item');
                    quotesNav.onclick = function() { navigateTo('quotes-registry'); };
                }
                
                // Remove financial-hidden class from body to show financial data
                document.body.classList.remove('financial-hidden');
            } else {
                // Add financial-hidden class to body to hide financial data
                document.body.classList.add('financial-hidden');
            }
        }
        
        // Handle All Data click - prompts for password if locked
        function handleAllDataClick() {
            if (salesUnlocked) {
                navigateTo('all-data');
            } else {
                promptSalesPassword();
                if (salesUnlocked) {
                    navigateTo('all-data');
                }
            }
        }
        
        function promptSalesPassword() {
            const password = prompt('Enter password to access Sales & Finance:');
            if (password === null) return; // User cancelled
            
            if (simpleHash(password) === SALES_HASH) {
                salesUnlocked = true;
                sessionStorage.setItem('salesUnlocked', 'true');
                checkSalesUnlock();
                alert('Access granted! Sales & Finance section is now unlocked.');
            } else {
                alert('Incorrect password. Please try again.');
            }
        }
        
        // Check unlock state on page load
        document.addEventListener('DOMContentLoaded', checkSalesUnlock);

        // ============================================================
        // NAVIGATION
        // ============================================================
        function navigateTo(page) {
            // Check if trying to access sales pages without unlock
            const salesPages = ['sales-overview', 'sales-parts', 'sales-customers', 'sales-dates'];
            if (salesPages.includes(page) && !salesUnlocked) {
                promptSalesPassword();
                if (!salesUnlocked) return; // Still not unlocked, don't navigate
            }
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            currentPage = page;
            switch(page) {
                case 'main': updateMainDashboard(); break;
                case 'orders-data': updateOrdersDataPage(); break;
                case 'orders-queue': updateOrdersQueuePage(); break;
                case 'orders-staged': updateOrdersStagedPage(); break;
                case 'orders-shipped': updateOrdersShippedPage(); break;
                case 'inventory': updateInventoryPage(); break;
                case 'inventory-history': updateInventoryHistoryPage(); break;
                case 'sales-overview': updateSalesOverview(); break;
                case 'sales-parts': updateSalesPartsPage(); break;
                case 'sales-customers': updateSalesCustomersPage(); break;
                case 'sales-dates': updateSalesDatesPage(); break;
                case 'bom': initBomExplorer(); break;
                case 'all-data': updateAllDataPage(); break;
                case 'fp-reference': updateFpReferencePage(); break;
                case 'customer-reference': updateCustReferencePage(); break;
                case 'quotes-registry': updateQuotesRegistryPage(); break;
            }
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }
        
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // ============================================================
        // ZOOM CONTROLS
        // ============================================================
        let currentZoom = 100;
        
        function setZoom(value) {
            value = parseInt(value);
            if (isNaN(value) || value < 50) value = 50;
            if (value > 200) value = 200;
            currentZoom = value;
            document.getElementById('zoomInput').value = value;
            // Apply CSS zoom to html element - this scales everything including sidebar
            document.documentElement.style.zoom = value / 100;
            // Save to localStorage
            try { localStorage.setItem('rolltech_zoom', value); } catch(e) {}
        }
        
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }
        
        function resetZoom() {
            setZoom(100);
        }
        
        function loadSavedZoom() {
            try {
                const saved = localStorage.getItem('rolltech_zoom');
                if (saved) {
                    setZoom(parseInt(saved));
                }
            } catch(e) {}
        }

        // ============================================================
        // MAIN DASHBOARD
        // ============================================================
        function updateMainDashboard() {
            const rollTechData = allData.filter(r => getCategory(r) === 'rolltech');
            const needToMakeOrders = rollTechData.filter(r => getStatus(r) === 'pending' || getStatus(r) === 'wip');
            const urgentOrders = needToMakeOrders.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent');
            const totalQty = needToMakeOrders.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthData = rollTechData.filter(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return false;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                return month === currentMonth;
            });
            const monthRevenue = monthData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const monthPL = monthData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            const missingComponents = needToMakeOrders.filter(r => {
                return isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
            }).length;
            
            document.getElementById('qsNeedToMake').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('qsUrgentOrders').textContent = formatNumber(urgentOrders.length);
            document.getElementById('qsUrgentOrders').className = `value ${urgentOrders.length > 0 ? 'negative' : ''}`;
            document.getElementById('qsTotalQty').textContent = formatNumber(totalQty);
            document.getElementById('qsMissingComponents').textContent = formatNumber(missingComponents);
            
            document.getElementById('deptProdOrders').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('deptProdUnits').textContent = formatNumber(totalQty);
            document.getElementById('deptProdUrgent').textContent = formatNumber(urgentOrders.length);
            
            renderMainStatusChart(rollTechData.filter(r => getStatus(r) !== 'shipped'));
            renderMainDeadlineChart(needToMakeOrders);
        }
        
        function renderMainStatusChart(data) {
            const statusCounts = { pending: 0, wip: 0, staged: 0 };
            data.forEach(r => { const s = getStatus(r); if (statusCounts[s] !== undefined) statusCounts[s]++; });
            const labels = [t('status.needToMake'), t('status.making'), t('status.readyToShip')];
            const values = [statusCounts.pending, statusCounts.wip, statusCounts.staged];
            const colors = ['#d69e2e', '#319795', '#4299e1'];
            if (charts.mainStatus) charts.mainStatus.destroy();
            charts.mainStatus = new Chart(document.getElementById('mainStatusChart'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 11 } } } } }
            });
        }
        
        function renderMainDeadlineChart(data) {
            const deadlines = {};
            for (let i = -7; i <= 14; i++) deadlines[i] = 0;
            data.forEach(r => { const days = parseNumber(getVal(r, 'DAYS_UNTIL')); if (days >= -7 && days <= 14) deadlines[days]++; });
            const labels = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return `${Math.abs(n)}d late`; if (n === 0) return 'Today'; return `${n}d`; });
            const values = Object.values(deadlines);
            const colors = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return 'rgba(229,62,62,0.8)'; if (n <= 2) return 'rgba(214,158,46,0.8)'; return 'rgba(49,130,206,0.8)'; });
            if (charts.mainDeadline) charts.mainDeadline.destroy();
            charts.mainDeadline = new Chart(document.getElementById('mainDeadlineChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // ============================================================
        // ORDERS DATA PAGE (All orders with status filters)
        // ============================================================
        function toggleOrdersDataCategory(cat) {
            ordersDataFilters.categories[cat] = !ordersDataFilters.categories[cat];
            if (!ordersDataFilters.categories.rolltech && !ordersDataFilters.categories.molding && !ordersDataFilters.categories.snappad) { ordersDataFilters.categories[cat] = true; return; }
            document.getElementById('ordersDataBtnRollTech').classList.toggle('active', ordersDataFilters.categories.rolltech);
            document.getElementById('ordersDataBtnMolding').classList.toggle('active', ordersDataFilters.categories.molding);
            document.getElementById('ordersDataBtnSnapPad').classList.toggle('active', ordersDataFilters.categories.snappad);
            updateOrdersDataPage();
        }
        
        function toggleOrdersDataStatus(status) {
            ordersDataFilters.statuses[status] = !ordersDataFilters.statuses[status];
            document.getElementById(`ordersDataStatus${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.toggle('active', ordersDataFilters.statuses[status]);
            updateOrdersDataPage();
        }
        
        function updateOrdersDataPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersDataFilters.categories[cat]) return false;
                if (!ordersDataFilters.statuses[status]) return false;
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const needToMake = data.filter(r => getStatus(r) === 'pending').length;
            const making = data.filter(r => getStatus(r) === 'wip').length;
            const readyToShip = data.filter(r => getStatus(r) === 'staged').length;
            
            document.getElementById('ordersDataTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersDataTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersDataNeedToMake').textContent = formatNumber(needToMake);
            document.getElementById('ordersDataMaking').textContent = formatNumber(making);
            document.getElementById('ordersDataReadyToShip').textContent = formatNumber(readyToShip);
            document.getElementById('ordersDataLastUpdated').textContent = new Date().toLocaleTimeString();
            
            renderOrdersDataTableHeader();
            renderOrdersDataTable(data);
        }
        
        function renderOrdersDataTableHeader() {
            initTableFilters('ordersData');
            initHiddenColumns('ordersData');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'tire', label: t('col.tire') }, { key: 'hub', label: t('col.hub') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'status', label: t('col.status') }
            ];
            document.getElementById('ordersDataTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersData', h.key)) return '';
                return createFilterHeader('ordersData', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersDataTable(data) {
            renderOrdersDataTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const status = getStatus(r);
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersData', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'status', status)) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersDataTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersDataTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isRollTech = getCategory(r) === 'rolltech';
                // Only show missing warning for Roll Tech items
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                const lineNum = getVal(r, 'LINE') || '-';
                const status = getStatus(r);
                // Make all rows clickable to show order details
                const rowClass = 'clickable-row';
                const rowClick = `onclick="openOrderDrilldown('${lineNum}')"`;
                
                // Helper for component cells - show N/A for non-Roll Tech
                const formatComponentForCategory = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                let cells = '';
                if (!isColumnHidden('ordersData', 'line')) cells += `<td><strong>${lineNum}</strong></td>`;
                if (!isColumnHidden('ordersData', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersData', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersData', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersData', 'tire')) cells += `<td>${formatComponentForCategory(getVal(r, 'TIRE'))}</td>`;
                if (!isColumnHidden('ordersData', 'hub')) cells += `<td>${formatComponentForCategory(getVal(r, 'HUB'))}</td>`;
                if (!isColumnHidden('ordersData', 'bearings')) cells += `<td>${formatComponentForCategory(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersData', 'status')) cells += `<td>${getStatusBadge(status)}</td>`;
                
                return `<tr class="${rowClass}" ${rowClick} style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersData');
            updateShowHiddenButton('ordersData');
        }
        
        function openOrderDrilldown(lineNum) {
            // Find the order by line number and open appropriate drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                openPalletDrilldown(order, lineNum);
            }
        }
        
        function openPalletDrilldownFromData(lineNum) {
            // Find the order by line number and open pallet drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                openPalletDrilldown(order, lineNum);
            }
        }
        
        function sortOrdersDataTable(field) {
            if (ordersDataSort.field === field) ordersDataSort.asc = !ordersDataSort.asc;
            else { ordersDataSort.field = field; ordersDataSort.asc = true; }
            updateOrdersDataPage();
        }
        
        function filterOrdersDataTable() { updateOrdersDataPage(); }
        
        function exportOrdersDataToCSV() {
            const data = allData.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            const headers = ['Line','Priority','Days Until','Customer','Part','Qty','Tire','Hub','Bearings','Status'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'BEARINGS'),getStatus(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_data.csv');
        }

        // ============================================================
        // ORDERS QUEUE PAGE (Need to Make = Pending + Approved)
        // ============================================================
        function toggleOrdersQueueCategory(cat) {
            ordersQueueFilters.categories[cat] = !ordersQueueFilters.categories[cat];
            if (!ordersQueueFilters.categories.rolltech && !ordersQueueFilters.categories.molding && !ordersQueueFilters.categories.snappad) { ordersQueueFilters.categories[cat] = true; return; }
            document.getElementById('ordersQueueBtnRollTech').classList.toggle('active', ordersQueueFilters.categories.rolltech);
            document.getElementById('ordersQueueBtnMolding').classList.toggle('active', ordersQueueFilters.categories.molding);
            document.getElementById('ordersQueueBtnSnapPad').classList.toggle('active', ordersQueueFilters.categories.snappad);
            updateOrdersQueuePage();
        }
        
        function updateOrdersQueuePage() {
            // Queue = "pending" + "wip" statuses (orders still being worked on)
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersQueueFilters.categories[cat] && (status === 'pending' || status === 'wip');
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const urgentCount = data.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent').length;
            const dueWeek = data.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; });
            const dueWeekQty = dueWeek.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const componentsReady = data.filter(r => getCategory(r) !== 'rolltech' || (!isMissingComponent(getVal(r,'TIRE')) && !isMissingComponent(getVal(r,'HUB')) && !isMissingComponent(getVal(r,'BEARINGS')))).length;
            const missingOrders = data.filter(r => getCategory(r) === 'rolltech' && (isMissingComponent(getVal(r,'TIRE')) || isMissingComponent(getVal(r,'HUB')) || isMissingComponent(getVal(r,'BEARINGS'))));
            
            document.getElementById('ordersQueueTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersQueueTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueUrgentCount').textContent = formatNumber(urgentCount);
            document.getElementById('ordersQueueDueWeek').textContent = formatNumber(dueWeek.length);
            document.getElementById('ordersQueueDueWeekUnits').textContent = `${formatNumber(dueWeekQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueComponentsReady').textContent = formatNumber(componentsReady);
            document.getElementById('ordersQueueLastUpdated').textContent = new Date().toLocaleTimeString();
            
            if (missingOrders.length > 0) {
                document.getElementById('ordersQueueMissingCount').textContent = missingOrders.length;
                document.getElementById('ordersQueueMissingBanner').classList.add('active');
            } else {
                document.getElementById('ordersQueueMissingBanner').classList.remove('active');
            }
            
            renderOrdersQueueTableHeader();
            renderOrdersQueueTable(data);
        }
        
        function renderOrdersQueueTableHeader() {
            initTableFilters('ordersQueue');
            initHiddenColumns('ordersQueue');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'dueDate', label: t('col.dueDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'ifNum', label: t('col.ifNum') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }, { key: 'tire', label: t('col.tire') },
                { key: 'hub', label: t('col.hub') }, { key: 'hubMold', label: t('col.hubMold') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'assigned', label: t('col.assigned') }
            ];
            document.getElementById('ordersQueueTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersQueue', h.key)) return '';
                return createFilterHeader('ordersQueue', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersQueueTable(data) {
            renderOrdersQueueTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersQueue', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                if (!passesColumnFilter('ordersQueue', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersQueue', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hubMold', getVal(r, 'HUB_MOLD') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersQueueSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'dueDate': va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    default: va = getVal(a, ordersQueueSort.field) || ''; vb = getVal(b, ordersQueueSort.field) || '';
                }
                if (typeof va === 'string') return ordersQueueSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersQueueSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersQueueSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'LINE') || '').toString().includes(search));
            }
            
            document.getElementById('ordersQueueTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersQueueTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isRollTech = getCategory(r) === 'rolltech';
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                const formatComponentCell = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                let cells = '';
                if (!isColumnHidden('ordersQueue', 'line')) cells += `<td><strong>${getVal(r, 'LINE') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersQueue', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersQueue', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersQueue', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'tire')) cells += `<td>${formatComponentCell(getVal(r, 'TIRE'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'hub')) cells += `<td>${formatComponentCell(getVal(r, 'HUB'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'hubMold')) cells += `<td>${getVal(r, 'HUB_MOLD') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'bearings')) cells += `<td>${formatComponentCell(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                
                return `<tr style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersQueue');
            updateShowHiddenButton('ordersQueue');
        }
        
        function sortOrdersQueueTable(field) {
            if (ordersQueueSort.field === field) ordersQueueSort.asc = !ordersQueueSort.asc;
            else { ordersQueueSort.field = field; ordersQueueSort.asc = true; }
            updateOrdersQueuePage();
        }
        
        function filterOrdersQueueTable() { updateOrdersQueuePage(); }
        
        function exportOrdersQueueToCSV() {
            const data = allData.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            const headers = ['Line','Priority','Days Until','Request Date','Customer','IF#','Part','Qty','Packaging','Tire','Hub','Hub Mold','Bearings','Assigned'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'REQUEST_DATE'),getVal(r,'CUSTOMER'),getVal(r,'IF_NUM'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'HUB_MOLD'),getVal(r,'BEARINGS'),getVal(r,'ASSIGNED')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_queue.csv');
        }

        // ============================================================
        // ORDERS STAGED PAGE (Ready to Ship)
        // ============================================================
        function toggleOrdersStagedCategory(cat) {
            ordersStagedFilters.categories[cat] = !ordersStagedFilters.categories[cat];
            if (!ordersStagedFilters.categories.rolltech && !ordersStagedFilters.categories.molding && !ordersStagedFilters.categories.snappad) { ordersStagedFilters.categories[cat] = true; return; }
            document.getElementById('ordersStagedBtnRollTech').classList.toggle('active', ordersStagedFilters.categories.rolltech);
            document.getElementById('ordersStagedBtnMolding').classList.toggle('active', ordersStagedFilters.categories.molding);
            document.getElementById('ordersStagedBtnSnapPad').classList.toggle('active', ordersStagedFilters.categories.snappad);
            updateOrdersStagedPage();
        }
        
        function updateOrdersStagedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersStagedFilters.categories[cat] && status === 'staged';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const avgValue = data.length > 0 ? totalRevenue / data.length : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersStagedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersStagedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersStagedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersStagedAvgValue').textContent = formatCurrency(avgValue);
            document.getElementById('ordersStagedCustomers').textContent = formatNumber(customers);
            
            renderOrdersStagedTableHeader();
            renderOrdersStagedTable(data);
        }
        
        function renderOrdersStagedTableHeader() {
            initTableFilters('ordersStaged');
            initHiddenColumns('ordersStaged');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }
            ];
            // Only add revenue column if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
            }
            headers.push(
                { key: 'dueDate', label: t('col.dueDate') }, { key: 'daysUntil', label: t('col.daysUntil') },
                { key: 'weight', label: t('col.weight') }, { key: 'dimensions', label: t('col.dimensions') },
                { key: 'assigned', label: t('col.assigned') }, { key: 'pallets', label: 'üì¶' }
            );
            document.getElementById('ordersStagedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersStaged', h.key)) return '';
                return createFilterHeader('ordersStaged', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersStagedTable(data) {
            renderOrdersStagedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                
                if (!passesColumnFilter('ordersStaged', 'line', line || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (salesUnlocked && !passesColumnFilter('ordersStaged', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                if (!passesColumnFilter('ordersStaged', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'daysUntil', String(daysUntil || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'weight', hasPallets ? formatNumber(totalWeight) + ' lbs' : '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'dimensions', firstDimensions)) return false;
                if (!passesColumnFilter('ordersStaged', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'pallets', hasPallets ? String(pallets.length) : '-')) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                const lineA = getVal(a, 'LINE');
                const lineB = getVal(b, 'LINE');
                const palletA = getPalletDataForOrder(lineA);
                const palletB = getPalletDataForOrder(lineB);
                switch(ordersStagedSort.field) {
                    case 'line': va = parseNumber(lineA); vb = parseNumber(lineB); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'dueDate': 
                        va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); 
                        vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); 
                        break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'weight': 
                        va = palletA.length > 0 ? palletA.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        vb = palletB.length > 0 ? palletB.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        break;
                    case 'pallets':
                        va = palletA.length;
                        vb = palletB.length;
                        break;
                    default: va = getVal(a, ordersStagedSort.field) || ''; vb = getVal(b, ordersStagedSort.field) || '';
                }
                if (typeof va === 'string') return ordersStagedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersStagedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersStagedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersStagedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersStagedTableBody');
            
            // Debug: log line numbers being rendered
            const lineNums = sorted.map(r => getVal(r, 'LINE')).filter(Boolean);
            console.log('Staged orders Line numbers:', lineNums.slice(0, 20));
            
            tbody.innerHTML = sorted.map(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const palletIndicator = hasPallets ? `<span class="pallet-indicator" title="${pallets.length} ${t('pallet.pallets').toLowerCase()}">üì∑ ${pallets.length}</span>` : '-';
                const clickHandler = hasPallets ? `onclick="showPalletPictures('${line}')" style="cursor:pointer;"` : '';
                
                let cells = '';
                if (!isColumnHidden('ordersStaged', 'line')) cells += `<td><strong>${line || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersStaged', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersStaged', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (!isColumnHidden('ordersStaged', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'weight')) cells += `<td>${hasPallets ? formatNumber(totalWeight) + ' lbs' : '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'dimensions')) cells += `<td>${firstDimensions}</td>`;
                if (!isColumnHidden('ordersStaged', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'pallets')) cells += `<td>${palletIndicator}</td>`;
                
                return `<tr class="${hasPallets ? 'clickable-row' : ''}" ${clickHandler}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersStaged');
            updateShowHiddenButton('ordersStaged');
        }
        
        // Get pallet data for a specific order (by Line number)
        function getPalletDataForOrder(lineNum) {
            if (!lineNum || !palletData || palletData.length === 0) return [];
            const lineStr = String(lineNum).trim();
            const matches = palletData.filter(p => String(p.orderNumber).trim() === lineStr);
            if (matches.length > 0) {
                console.log(`Found ${matches.length} pallets for line ${lineStr}`);
            }
            return matches;
        }
        
        // Show pallet pictures modal for an order (using Line number)
        function showPalletPictures(lineNum) {
            const pallets = getPalletDataForOrder(lineNum);
            if (pallets.length === 0) return;
            
            currentPalletOrder = lineNum;
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            
            document.getElementById('palletDrilldownOrder').textContent = `#${lineNum}`;
            
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            document.getElementById('palletSummary').innerHTML = `
                <div class="summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${pallets.length}</div></div>
                <div class="summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Simple table with pallet # and clickable link
            const gallery = document.getElementById('palletGallery');
            gallery.innerHTML = `
                <table class="data-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>${t('col.palletNum')}</th>
                            <th>${t('pallet.weight')}</th>
                            <th>${t('pallet.dimensions')}</th>
                            <th>Picture Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pallets.map((p, idx) => `
                            <tr>
                                <td><strong>${p.palletNumber || (idx + 1)}</strong></td>
                                <td>${p.weight || '-'}</td>
                                <td>${p.dimensions || '-'}</td>
                                <td>${p.pictureUrl ? `<a href="${p.pictureUrl}" target="_blank" style="color:var(--accent);">üì∑ View Photo</a>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('palletDrilldown').classList.add('active');
            document.getElementById('palletDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePalletDrilldown() {
            document.getElementById('palletDrilldown').classList.remove('active');
            currentPalletOrder = null;
        }
        
        function openImageModal(imgUrl) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = imgUrl;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function sortOrdersStagedTable(field) {
            if (ordersStagedSort.field === field) ordersStagedSort.asc = !ordersStagedSort.asc;
            else { ordersStagedSort.field = field; ordersStagedSort.asc = true; }
            updateOrdersStagedPage();
        }
        
        function filterOrdersStagedTable() { updateOrdersStagedPage(); }
        
        function exportOrdersStagedToCSV() {
            const data = allData.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            const headers = ['Line','Customer','Part','Qty','Packaging','Revenue','Due Date','Days Until','Weight (lbs)','Dimensions','Assigned','Pallets'];
            const rows = data.map(r => {
                const line = getVal(r,'LINE');
                const pallets = getPalletDataForOrder(line);
                const totalWeight = pallets.length > 0 ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : '';
                const dimensions = pallets.length > 0 && pallets[0].dimensions ? pallets[0].dimensions : '';
                return [line,getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),r[COL.REVENUE],r[COL.REQUESTED_DATE],getVal(r,'DAYS_UNTIL'),totalWeight,dimensions,getVal(r,'ASSIGNED'),pallets.length].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
            });
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_staged.csv');
        }

        // ============================================================
        // ORDERS SHIPPED PAGE (History with date filter)
        // ============================================================
        function toggleOrdersShippedCategory(cat) {
            ordersShippedFilters.categories[cat] = !ordersShippedFilters.categories[cat];
            if (!ordersShippedFilters.categories.rolltech && !ordersShippedFilters.categories.molding && !ordersShippedFilters.categories.snappad) { ordersShippedFilters.categories[cat] = true; return; }
            document.getElementById('ordersShippedBtnRollTech').classList.toggle('active', ordersShippedFilters.categories.rolltech);
            document.getElementById('ordersShippedBtnMolding').classList.toggle('active', ordersShippedFilters.categories.molding);
            document.getElementById('ordersShippedBtnSnapPad').classList.toggle('active', ordersShippedFilters.categories.snappad);
            updateOrdersShippedPage();
        }
        
        function applyShippedDateFilter() {
            const fromInput = document.getElementById('ordersShippedFromDate').value;
            const toInput = document.getElementById('ordersShippedToDate').value;
            ordersShippedFilters.fromDate = fromInput ? new Date(fromInput) : null;
            ordersShippedFilters.toDate = toInput ? new Date(toInput) : null;
            updateOrdersShippedPage();
        }
        
        function resetShippedDateFilter() {
            document.getElementById('ordersShippedFromDate').value = '';
            document.getElementById('ordersShippedToDate').value = '';
            ordersShippedFilters.fromDate = null;
            ordersShippedFilters.toDate = null;
            updateOrdersShippedPage();
        }
        
        function updateOrdersShippedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersShippedFilters.categories[cat] || status !== 'shipped') return false;
                
                if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                    const dateStr = r[COL.SHIPPED_DATE];
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (ordersShippedFilters.fromDate && rowDate < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && rowDate > ordersShippedFilters.toDate) return false;
                }
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100).toFixed(1) : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersShippedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersShippedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersShippedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersShippedPL').textContent = formatCurrency(totalPL);
            document.getElementById('ordersShippedPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('ordersShippedMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('ordersShippedCustomers').textContent = formatNumber(customers);
            
            renderOrdersShippedTableHeader();
            renderOrdersShippedTable(data);
        }
        
        function renderOrdersShippedTableHeader() {
            initTableFilters('ordersShipped');
            initHiddenColumns('ordersShipped');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'shippedDate', label: t('col.shippedDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'part', label: t('col.part') },
                { key: 'qty', label: t('col.qty') }
            ];
            // Only add revenue and P/L columns if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
                headers.push({ key: 'pl', label: t('col.pl') });
            }
            document.getElementById('ordersShippedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersShipped', h.key)) return '';
                return createFilterHeader('ordersShipped', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersShippedTable(data) {
            renderOrdersShippedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const pl = getPLValue(r);
                if (!passesColumnFilter('ordersShipped', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'shippedDate', r[COL.SHIPPED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (salesUnlocked) {
                    if (!passesColumnFilter('ordersShipped', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                    if (!passesColumnFilter('ordersShipped', 'pl', formatCurrency(pl))) return false;
                }
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersShippedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersShippedTableBody');
            tbody.innerHTML = sorted.map(r => {
                const pl = getPLValue(r);
                
                let cells = '';
                if (!isColumnHidden('ordersShipped', 'line')) cells += `<td><strong>${getVal(r, 'LINE') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'shippedDate')) cells += `<td>${r[COL.SHIPPED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'pl')) cells += `<td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>`;
                
                return `<tr>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersShipped');
            updateShowHiddenButton('ordersShipped');
        }
        
        function sortOrdersShippedTable(field) {
            if (ordersShippedSort.field === field) ordersShippedSort.asc = !ordersShippedSort.asc;
            else { ordersShippedSort.field = field; ordersShippedSort.asc = true; }
            updateOrdersShippedPage();
        }
        
        function filterOrdersShippedTable() { updateOrdersShippedPage(); }
        
        function exportOrdersShippedToCSV() {
            const data = allData.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            const headers = ['Line','Shipped Date','Customer','Part','Qty','Revenue','P/L'];
            const rows = data.map(r => [getVal(r,'LINE'),r[COL.SHIPPED_DATE],getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_shipped.csv');
        }

        // ============================================================
        // UTILITY FUNCTION
        // ============================================================
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ============================================================
        // INVENTORY PAGE
        // ============================================================
        function setInvFilter(filter) {
            invFilter = filter;
            document.getElementById('invFilterAll').classList.toggle('active', filter === 'all');
            document.getElementById('invFilterLow').classList.toggle('active', filter === 'low');
            document.getElementById('invFilterNeeded').classList.toggle('active', filter === 'needed');
            renderInvTable();
        }
        
        function updateInventoryPage() {
            const lowStock = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            const needsProduction = inventoryData.filter(i => i.partsToBeMade > 0);
            const okStock = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
            const productTypes = [...new Set(inventoryData.map(i => i.product).filter(p => p))];
            
            document.getElementById('invStatTotal').textContent = formatNumber(inventoryData.length);
            document.getElementById('invStatTypes').textContent = `${productTypes.length} ${t('ui.productTypes')}`;
            document.getElementById('invStatLow').textContent = formatNumber(lowStock.length);
            document.getElementById('invStatNeeded').textContent = formatNumber(needsProduction.length);
            document.getElementById('invStatOk').textContent = formatNumber(okStock.length);
            
            setInvFilter('all');
        }
        
        function sortInvTable(field) {
            if (invSort.field === field) invSort.asc = !invSort.asc;
            else { invSort.field = field; invSort.asc = true; }
            renderInvTable();
        }
        
        function renderInvTableHeader() {
            initHiddenColumns('inventory');
            const cols = [
                { key: 'product', label: 'Product Type' },
                { key: 'partNumber', label: 'Part Number' },
                { key: 'fusionQty', label: 'Fusion Qty' },
                { key: 'minimum', label: 'Minimum' },
                { key: 'manualTarget', label: 'Manual Target' },
                { key: 'qtyNeeded', label: 'Qty Needed' },
                { key: 'partsToBeMade', label: 'Parts to Make' },
                { key: 'moldType', label: 'Mold Type' },
                { key: 'status', label: 'Status' }
            ];
            document.getElementById('invTableHeader').innerHTML = cols.map(col => {
                if (isColumnHidden('inventory', col.key)) return '';
                return createFilterHeader('inventory', col.key, col.label);
            }).join('');
        }
        
        function renderInvTable() {
            renderInvTableHeader();
            let data = [...inventoryData];
            const searchTerm = (document.getElementById('invSearch')?.value || '').toLowerCase();
            
            if (invFilter === 'low') data = data.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            else if (invFilter === 'needed') data = data.filter(i => i.partsToBeMade > 0);
            
            if (searchTerm) {
                data = data.filter(i => (i.partNumber || '').toLowerCase().includes(searchTerm) || (i.product || '').toLowerCase().includes(searchTerm) || (i.moldType || '').toLowerCase().includes(searchTerm));
            }
            
            // Apply column filters
            data = data.filter(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const status = isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK');
                
                if (!passesColumnFilter('inventory', 'product', i.product || '-')) return false;
                if (!passesColumnFilter('inventory', 'partNumber', i.partNumber)) return false;
                if (!passesColumnFilter('inventory', 'fusionQty', String(i.fusionQty))) return false;
                if (!passesColumnFilter('inventory', 'minimum', String(i.minimum))) return false;
                if (!passesColumnFilter('inventory', 'manualTarget', String(i.manualTarget))) return false;
                if (!passesColumnFilter('inventory', 'qtyNeeded', String(i.qtyNeeded))) return false;
                if (!passesColumnFilter('inventory', 'partsToBeMade', String(i.partsToBeMade))) return false;
                if (!passesColumnFilter('inventory', 'moldType', i.moldType || '-')) return false;
                if (!passesColumnFilter('inventory', 'status', status)) return false;
                return true;
            });
            
            data.sort((a, b) => {
                let va = a[invSort.field], vb = b[invSort.field];
                if (typeof va === 'string') return invSort.asc ? (va || '').localeCompare(vb || '') : (vb || '').localeCompare(va || '');
                return invSort.asc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
            });
            
            document.getElementById('invTableCount').textContent = `${data.length} ${t('ui.items')}`;
            const tbody = document.getElementById('invTableBody');
            tbody.innerHTML = data.map(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const rowClass = isLow ? 'inv-low clickable-row' : (needsMake ? 'inv-warning clickable-row' : 'clickable-row');
                const statusBadge = isLow ? `<span class="badge" style="background:var(--danger);color:white;">${t('status.low')}</span>` : (needsMake ? `<span class="badge" style="background:var(--warning);color:#1a202c;">${t('status.make')}</span>` : `<span class="badge" style="background:var(--success);color:white;">${t('status.ok')}</span>`);
                const escapedPart = (i.partNumber || '').replace(/'/g, "\\'");
                
                // Build row with hidden column support
                let cells = '';
                if (!isColumnHidden('inventory', 'product')) cells += `<td>${i.product || '-'}</td>`;
                if (!isColumnHidden('inventory', 'partNumber')) cells += `<td><strong>${i.partNumber}</strong><button class="inv-history-btn" onclick="event.stopPropagation(); openInventoryHistoryModal('${escapedPart}')">üìà</button></td>`;
                if (!isColumnHidden('inventory', 'fusionQty')) cells += `<td>${formatNumber(i.fusionQty)}</td>`;
                if (!isColumnHidden('inventory', 'minimum')) cells += `<td>${formatNumber(i.minimum)}</td>`;
                if (!isColumnHidden('inventory', 'manualTarget')) cells += `<td>${formatNumber(i.manualTarget)}</td>`;
                if (!isColumnHidden('inventory', 'qtyNeeded')) cells += `<td>${formatNumber(i.qtyNeeded)}</td>`;
                if (!isColumnHidden('inventory', 'partsToBeMade')) cells += `<td class="${i.partsToBeMade > 0 ? 'negative' : ''}">${formatNumber(i.partsToBeMade)}</td>`;
                if (!isColumnHidden('inventory', 'moldType')) cells += `<td>${i.moldType || '-'}</td>`;
                if (!isColumnHidden('inventory', 'status')) cells += `<td>${statusBadge}</td>`;
                
                return `<tr class="${rowClass}" onclick="openInventoryHistoryModal('${escapedPart}')" title="${t('inv.clickHistory')}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('inventory');
            updateShowHiddenButton('inventory');
        }
        
        function filterInvTable() { renderInvTable(); }
        function exportInvCSV() { downloadCSV('Product Type,Part Number,...', 'inventory.csv'); }
        
        // ============================================================
        // INVENTORY HISTORY MODAL
        // ============================================================
        async function openInventoryHistoryModal(partNumber) {
            currentHistoryPart = partNumber;
            const modal = document.getElementById('inventoryHistoryModal');
            const loading = document.getElementById('historyLoading');
            const noData = document.getElementById('historyNoData');
            const chartContainer = document.querySelector('.history-chart-container');
            const statsPanel = document.getElementById('historyStatsPanel');
            const controls = document.querySelector('.history-controls');
            
            // Show modal with loading state
            modal.classList.add('active');
            document.getElementById('historyPartName').textContent = partNumber;
            loading.style.display = 'block';
            noData.style.display = 'none';
            chartContainer.style.display = 'none';
            statsPanel.style.display = 'none';
            controls.style.display = 'none';
            
            // Ensure history data is loaded
            await loadInventoryHistoryData();
            
            // Find data for this part
            const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
            
            loading.style.display = 'none';
            
            if (!partData || Object.keys(partData.dataByDate).length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            // Show chart and controls
            chartContainer.style.display = 'block';
            statsPanel.style.display = 'grid';
            controls.style.display = 'flex';
            
            // Reset date range to all data
            historyDateRange = { start: null, end: null };
            document.getElementById('historyStartDate').value = '';
            document.getElementById('historyEndDate').value = '';
            
            // Render chart
            renderInventoryHistoryChart();
        }
        
        function closeInventoryHistoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('inventoryHistoryModal').classList.remove('active');
            currentHistoryPart = null;
            
            // Destroy chart if exists
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
                charts.inventoryHistory = null;
            }
        }
        
        function renderInventoryHistoryChart() {
            if (!currentHistoryPart) return;
            
            const partData = inventoryHistoryData.find(p => p.partNumber === currentHistoryPart);
            if (!partData) return;
            
            // Get minimum threshold for this part
            const minimum = getPartMinimum(currentHistoryPart);
            
            // Get filtered dates based on range
            let dates = [...inventoryHistoryDates];
            if (historyDateRange.start || historyDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyDateRange.start && date < historyDateRange.start) return false;
                    if (historyDateRange.end && date > historyDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Build data points
            const dataPoints = [];
            const labels = [];
            dates.forEach(dateStr => {
                const qty = partData.dataByDate[dateStr];
                if (qty !== undefined) {
                    dataPoints.push(qty);
                    // Format label as "Jan 12"
                    const parts = dateStr.split('/');
                    const date = new Date(parts[2], parts[0] - 1, parts[1]);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    labels.push(`${monthNames[date.getMonth()]} ${date.getDate()}`);
                }
            });
            
            if (dataPoints.length === 0) {
                document.getElementById('historyNoData').style.display = 'block';
                document.querySelector('.history-chart-container').style.display = 'none';
                document.getElementById('historyStatsPanel').style.display = 'none';
                return;
            }
            
            // Calculate stats
            const current = dataPoints[dataPoints.length - 1] || 0;
            const minVal = Math.min(...dataPoints);
            const maxVal = Math.max(...dataPoints);
            const avg = Math.round(dataPoints.reduce((a, b) => a + b, 0) / dataPoints.length);
            const belowMin = minimum > 0 && current < minimum;
            
            document.getElementById('historyStatCurrent').textContent = formatNumber(current);
            document.getElementById('historyStatCurrent').style.color = belowMin ? 'var(--danger)' : 'var(--accent)';
            document.getElementById('historyStatMin').textContent = formatNumber(minimum);  // Show threshold, not historical low
            document.getElementById('historyStatMin').style.color = minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)';
            document.getElementById('historyStatMax').textContent = formatNumber(maxVal);
            document.getElementById('historyStatAvg').textContent = formatNumber(avg);
            
            // Destroy existing chart
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
            }
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryChart').getContext('2d');
            
            // Handle flat line case
            let suggestedMin = minVal * 0.9;
            let suggestedMax = maxVal * 1.1;
            if (maxVal - minVal < 1) {
                suggestedMin = minVal - Math.max(1, minVal * 0.1);
                suggestedMax = maxVal + Math.max(1, maxVal * 0.1);
            }
            
            // Dataset with segment coloring for below minimum
            const dataset = {
                label: currentHistoryPart,
                data: dataPoints,
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                fill: true,
                tension: 0.2,
                pointRadius: dataPoints.length < 30 ? 4 : 2,
                pointHoverRadius: 6
            };
            
            // Add segment coloring if minimum is set
            if (minimum > 0) {
                dataset.segment = {
                    borderColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? '#e53e3e' : '#3182ce';
                    },
                    backgroundColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? 'rgba(229, 62, 62, 0.1)' : 'rgba(49, 130, 206, 0.1)';
                    }
                };
                dataset.pointBackgroundColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
                dataset.pointBorderColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
            }
            
            charts.inventoryHistory = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [dataset]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    let label = `${t('ui.qty')}: ${formatNumber(ctx.raw)}`;
                                    if (minimum > 0 && ctx.raw < minimum) {
                                        label += ` (${t('status.low')})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            suggestedMin: suggestedMin,
                            suggestedMax: suggestedMax
                        }
                    }
                }
            });
        }
        
        function updateHistoryChart() {
            const startVal = document.getElementById('historyStartDate').value;
            const endVal = document.getElementById('historyEndDate').value;
            
            historyDateRange.start = startVal ? new Date(startVal) : null;
            historyDateRange.end = endVal ? new Date(endVal) : null;
            
            renderInventoryHistoryChart();
        }
        
        function applyHistoryPreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7':
                    start = new Date(now);
                    start.setDate(start.getDate() - 7);
                    break;
                case 'last30':
                    start = new Date(now);
                    start.setDate(start.getDate() - 30);
                    break;
                case 'last90':
                    start = new Date(now);
                    start.setDate(start.getDate() - 90);
                    break;
                case 'all':
                default:
                    start = null;
                    break;
            }
            
            historyDateRange.start = start;
            historyDateRange.end = null;
            
            // Update input fields
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyStartDate').value = '';
            }
            document.getElementById('historyEndDate').value = '';
            
            renderInventoryHistoryChart();
        }

        // ============================================================
        // INVENTORY HISTORY PAGE (Multi-Part Comparison)
        // ============================================================
        async function updateInventoryHistoryPage() {
            // Ensure data is loaded
            await loadInventoryHistoryData();
            
            // Render parts list
            renderHistoryPartsList();
            
            // Render chart (will show "select parts" message if none selected)
            renderHistoryPageChart();
        }
        
        function renderHistoryPartsList() {
            const container = document.getElementById('historyPartsList');
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            
            // Get all unique parts from inventory data (which has minimum info) or history data
            let parts = [];
            if (inventoryData.length > 0) {
                parts = inventoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: item.product || '',
                    minimum: item.minimum || 0
                }));
            } else if (inventoryHistoryData.length > 0) {
                parts = inventoryHistoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: '',
                    minimum: 0
                }));
            }
            
            // Filter by search term
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    p.product.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort alphabetically
            parts.sort((a, b) => a.partNumber.localeCompare(b.partNumber));
            
            container.innerHTML = parts.map((part, idx) => {
                const isSelected = selectedHistoryParts.has(part.partNumber);
                const colorIdx = Array.from(selectedHistoryParts).indexOf(part.partNumber);
                const color = colorIdx >= 0 ? historyPartColors[colorIdx % historyPartColors.length] : '#4a5568';
                
                return `<div class="history-part-item ${isSelected ? 'selected' : ''}" onclick="toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <div class="part-info">
                        <div class="part-number">${part.partNumber}</div>
                        <div class="part-type">${part.product || '-'}</div>
                    </div>
                    ${isSelected ? `<div class="part-color" style="background:${color}"></div>` : ''}
                </div>`;
            }).join('');
            
            // Update selected count
            document.getElementById('historySelectedCount').innerHTML = 
                `${selectedHistoryParts.size} <span data-i18n="inv.selected">${t('inv.selected')}</span>`;
        }
        
        function toggleHistoryPart(partNumber) {
            if (selectedHistoryParts.has(partNumber)) {
                selectedHistoryParts.delete(partNumber);
            } else {
                if (selectedHistoryParts.size >= 10) {
                    alert(t('inv.maxPartsWarning') || 'Maximum 10 parts can be compared at once');
                    return;
                }
                selectedHistoryParts.add(partNumber);
            }
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function selectAllHistoryParts() {
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            let parts = inventoryData.length > 0 ? inventoryData : inventoryHistoryData;
            
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    (p.product || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Limit to 10
            const toAdd = parts.slice(0, 10);
            selectedHistoryParts.clear();
            toAdd.forEach(p => selectedHistoryParts.add(p.partNumber));
            
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function deselectAllHistoryParts() {
            selectedHistoryParts.clear();
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function filterHistoryPartsList() {
            renderHistoryPartsList();
        }
        
        function getPartMinimum(partNumber) {
            const invItem = inventoryData.find(i => i.partNumber === partNumber);
            return invItem ? invItem.minimum : 0;
        }
        
        function renderHistoryPageChart() {
            const chartContainer = document.getElementById('historyPageChartContainer');
            const noSelection = document.getElementById('historyPageNoSelection');
            const legend = document.getElementById('historyPageLegend');
            const statsContainer = document.getElementById('historyPageStats');
            
            // Destroy existing chart
            if (charts.inventoryHistoryPage) {
                charts.inventoryHistoryPage.destroy();
                charts.inventoryHistoryPage = null;
            }
            
            if (selectedHistoryParts.size === 0) {
                noSelection.style.display = 'block';
                legend.innerHTML = '';
                statsContainer.innerHTML = '';
                return;
            }
            
            noSelection.style.display = 'none';
            
            // Get filtered dates
            let dates = [...inventoryHistoryDates];
            if (historyPageDateRange.start || historyPageDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyPageDateRange.start && date < historyPageDateRange.start) return false;
                    if (historyPageDateRange.end && date > historyPageDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Format labels
            const labels = dates.map(dateStr => {
                const parts = dateStr.split('/');
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[date.getMonth()]} ${date.getDate()}`;
            });
            
            // Build datasets
            const datasets = [];
            const partsArray = Array.from(selectedHistoryParts);
            let legendHtml = '';
            let statsHtml = '';
            
            partsArray.forEach((partNumber, idx) => {
                const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
                if (!partData) return;
                
                const color = historyPartColors[idx % historyPartColors.length];
                const minimum = getPartMinimum(partNumber);
                
                // Build data points
                const dataPoints = dates.map(dateStr => partData.dataByDate[dateStr] ?? null);
                
                // Calculate stats
                const validPoints = dataPoints.filter(v => v !== null);
                const current = validPoints.length > 0 ? validPoints[validPoints.length - 1] : 0;
                const min = validPoints.length > 0 ? Math.min(...validPoints) : 0;
                const max = validPoints.length > 0 ? Math.max(...validPoints) : 0;
                const avg = validPoints.length > 0 ? Math.round(validPoints.reduce((a, b) => a + b, 0) / validPoints.length) : 0;
                const belowMin = minimum > 0 && current < minimum;
                
                // Create dataset with segment coloring for below minimum
                datasets.push({
                    label: partNumber,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    tension: 0.2,
                    pointRadius: dates.length < 50 ? 3 : 1,
                    pointHoverRadius: 5,
                    minimum: minimum, // Store for segment callback
                    segment: {
                        borderColor: ctx => {
                            const yVal = ctx.p1.parsed.y;
                            return (minimum > 0 && yVal < minimum) ? '#e53e3e' : color;
                        }
                    }
                });
                
                // Legend
                legendHtml += `<div class="history-legend-item">
                    <div class="history-legend-color" style="background:${color}"></div>
                    <span>${partNumber}</span>
                    ${minimum > 0 ? `<span class="history-legend-below">(min: ${formatNumber(minimum)})</span>` : ''}
                </div>`;
                
                // Stats card
                statsHtml += `<div class="history-part-stat-card">
                    <div class="history-part-stat-header">
                        <div class="history-part-stat-color" style="background:${color}"></div>
                        <div class="history-part-stat-name">${partNumber}</div>
                    </div>
                    <div class="history-part-stat-values">
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value ${belowMin ? 'below-min' : ''}">${formatNumber(current)}</div>
                            <div class="history-part-stat-label">${t('inv.current')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value" style="color: ${minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)'}">${formatNumber(minimum)}</div>
                            <div class="history-part-stat-label">${t('inv.minimum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(max)}</div>
                            <div class="history-part-stat-label">${t('inv.maximum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(avg)}</div>
                            <div class="history-part-stat-label">${t('inv.average')}</div>
                        </div>
                    </div>
                </div>`;
            });
            
            legend.innerHTML = legendHtml;
            statsContainer.innerHTML = statsHtml;
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryPageChart').getContext('2d');
            charts.inventoryHistoryPage = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatNumber(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function updateHistoryPageChart() {
            const startVal = document.getElementById('historyPageStartDate').value;
            const endVal = document.getElementById('historyPageEndDate').value;
            
            historyPageDateRange.start = startVal ? new Date(startVal) : null;
            historyPageDateRange.end = endVal ? new Date(endVal) : null;
            
            renderHistoryPageChart();
        }
        
        function applyHistoryPagePreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7': start = new Date(now); start.setDate(start.getDate() - 7); break;
                case 'last30': start = new Date(now); start.setDate(start.getDate() - 30); break;
                case 'last90': start = new Date(now); start.setDate(start.getDate() - 90); break;
                case 'all': default: start = null; break;
            }
            
            historyPageDateRange.start = start;
            historyPageDateRange.end = null;
            
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyPageStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyPageStartDate').value = '';
            }
            document.getElementById('historyPageEndDate').value = '';
            
            renderHistoryPageChart();
        }

        // ============================================================
        // SALES OVERVIEW PAGE (Enhanced)
        // ============================================================
        function toggleSalesCategory(cat) {
            salesFilters.categories[cat] = !salesFilters.categories[cat];
            if (!salesFilters.categories.rolltech && !salesFilters.categories.molding && !salesFilters.categories.snappad) { salesFilters.categories[cat] = true; return; }
            document.getElementById('salesBtnRollTech').classList.toggle('active', salesFilters.categories.rolltech);
            document.getElementById('salesBtnMolding').classList.toggle('active', salesFilters.categories.molding);
            document.getElementById('salesBtnSnapPad').classList.toggle('active', salesFilters.categories.snappad);
            updateSalesOverview();
        }
        
        function applySalesDateFilter() {
            const fromInput = document.getElementById('salesFromDate').value;
            const toInput = document.getElementById('salesToDate').value;
            salesFilters.fromDate = fromInput ? new Date(fromInput) : null;
            salesFilters.toDate = toInput ? new Date(toInput) : null;
            updateSalesOverview();
        }
        
        function resetSalesDateFilter() {
            document.getElementById('salesFromDate').value = '';
            document.getElementById('salesToDate').value = '';
            salesFilters.fromDate = null;
            salesFilters.toDate = null;
            updateSalesOverview();
        }
        
        function toggleSalesHeatMap() {
            salesHeatMapEnabled = !salesHeatMapEnabled;
            document.getElementById('salesHeatMapBtn').classList.toggle('active', salesHeatMapEnabled);
            updateSalesOverview();
        }
        
        function toggleSalesAutoRefresh() {
            if (salesAutoRefreshInterval) {
                clearInterval(salesAutoRefreshInterval);
                salesAutoRefreshInterval = null;
                document.getElementById('salesAutoRefreshBtn').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span>Auto-refresh: Off</span>';
            } else {
                salesAutoRefreshInterval = setInterval(() => { loadDashboard(); }, 300000); // 5 minutes
                document.getElementById('salesAutoRefreshBtn').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span class="pulse"></span><span>Auto-refresh: On (5 min)</span>';
            }
        }
        
        function getFilteredSalesData() {
            return allData.filter(r => {
                if (!salesFilters.categories[getCategory(r)]) return false;
                if (salesFilters.fromDate || salesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (salesFilters.fromDate && rowDate < salesFilters.fromDate) return false;
                    if (salesFilters.toDate && rowDate > salesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesOverview() {
            const data = getFilteredSalesData();
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            
            data.forEach(r => {
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    totalPL += pl;
                    if (getStatus(r) === 'shipped') { shippedPL += pl; shippedCount++; }
                    else { forecastPL += pl; forecastCount++; }
                } else {
                    if (getStatus(r) === 'shipped') shippedCount++; else forecastCount++;
                }
            });
            
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('salesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('salesStatOrderCount').textContent = `${data.length} ${t('ui.orders')}`;
            document.getElementById('salesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('salesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('salesStatShippedPL').textContent = formatCurrency(shippedPL);
            document.getElementById('salesStatShippedPL').className = `value ${shippedPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatShippedCount').textContent = `${shippedCount} ${t('stats.shipped')}`;
            document.getElementById('salesStatForecastPL').textContent = formatCurrency(forecastPL);
            document.getElementById('salesStatForecastPL').className = `value ${forecastPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatForecastCount').textContent = `${forecastCount} ${t('stats.pending')}`;
            
            // Render the Monthly P/L Trend chart
            renderSalesTrendChart(data);
        }
        
        function renderSalesLossesChart(data) {
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { pl: 0 };
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            // Get top 5 losses and top 5 gains
            const sorted = Object.entries(partStats).sort((a,b) => a[1].pl - b[1].pl);
            const topLosses = sorted.slice(0, 5).filter(([_,v]) => v.pl < 0);
            const topGains = sorted.slice(-5).reverse().filter(([_,v]) => v.pl > 0);
            const combined = [...topLosses, ...topGains.reverse()];
            
            if (charts.salesLosses) charts.salesLosses.destroy();
            charts.salesLosses = new Chart(document.getElementById('salesLossesChart'), {
                type: 'bar',
                data: {
                    labels: combined.map(s => s[0]),
                    datasets: [{
                        data: combined.map(s => s[1].pl),
                        backgroundColor: combined.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)')
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function renderSalesCustomerPieChart(data) {
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { pl: 0 };
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(custStats).filter(([_,v]) => v.pl > 0).sort((a,b) => b[1].pl - a[1].pl).slice(0, 8);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#718096'];
            
            if (charts.salesCustomerPie) charts.salesCustomerPie.destroy();
            charts.salesCustomerPie = new Chart(document.getElementById('salesCustomerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0].substring(0, 20)),
                    datasets: [{ data: sorted.map(s => s[1].pl), backgroundColor: colors }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
        }
        
        function renderSalesTrendChart(data) {
            const monthStats = {};
            data.forEach(r => {
                const d = getAttributionDate(r);
                if (!d) return;
                const month = getMonthKey(d);
                if (!monthStats[month]) monthStats[month] = { shipped: 0, forecast: 0, revenue: 0 };
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (getStatus(r) === 'shipped') monthStats[month].shipped += pl;
                    else monthStats[month].forecast += pl;
                }
            });
            
            const sorted = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0])).slice(-24);
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: sorted.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped P/L', data: sorted.map(s => s[1].shipped), borderColor: '#38a169', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                        { label: 'Forecast P/L', data: sorted.map(s => s[1].forecast), borderColor: '#d69e2e', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5,5], yAxisID: 'y' },
                        { label: 'Revenue', data: sorted.map(s => s[1].revenue), borderColor: '#3182ce', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { type: 'linear', position: 'left', ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y1: { type: 'linear', position: 'right', ticks: { callback: v => formatCurrency(v), color: '#3182ce' }, grid: { drawOnChartArea: false } },
                        x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function exportSalesCSV() {
            const data = getFilteredSalesData();
            const csv = data.map(r => [getVal(r,'PART'),getVal(r,'CUSTOMER'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].join(',')).join('\n');
            downloadCSV('Part,Customer,Qty,Revenue,P/L\n' + csv, `sales_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SALES BY PARTS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function togglePartsCategory(cat) {
            partsFilters.categories[cat] = !partsFilters.categories[cat];
            if (!partsFilters.categories.rolltech && !partsFilters.categories.molding && !partsFilters.categories.snappad) { partsFilters.categories[cat] = true; return; }
            document.getElementById('partsBtnRollTech').classList.toggle('active', partsFilters.categories.rolltech);
            document.getElementById('partsBtnMolding').classList.toggle('active', partsFilters.categories.molding);
            document.getElementById('partsBtnSnapPad').classList.toggle('active', partsFilters.categories.snappad);
            updateSalesPartsPage();
        }
        
        function applyPartsDateFilter() {
            partsFilters.fromDate = document.getElementById('partsFromDate').value ? new Date(document.getElementById('partsFromDate').value) : null;
            partsFilters.toDate = document.getElementById('partsToDate').value ? new Date(document.getElementById('partsToDate').value) : null;
            updateSalesPartsPage();
        }
        
        function resetPartsDateFilter() {
            document.getElementById('partsFromDate').value = '';
            document.getElementById('partsToDate').value = '';
            partsFilters.fromDate = null;
            partsFilters.toDate = null;
            updateSalesPartsPage();
        }
        
        function togglePartsWatchlistFilter() {
            partsFilters.watchlistOnly = !partsFilters.watchlistOnly;
            document.getElementById('partsWatchlistBtn').classList.toggle('active', partsFilters.watchlistOnly);
            updateSalesPartsPage();
        }
        
        function getFilteredPartsData() {
            return allData.filter(r => {
                if (!partsFilters.categories[getCategory(r)]) return false;
                if (partsFilters.fromDate || partsFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (partsFilters.fromDate && rowDate < partsFilters.fromDate) return false;
                    if (partsFilters.toDate && rowDate > partsFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesPartsPage() {
            const data = getFilteredPartsData();
            const partStats = {};
            
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            let partsArray = Object.entries(partStats).map(([part, stats]) => ({ part, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            // Filter by watchlist if enabled
            if (partsFilters.watchlistOnly) partsArray = partsArray.filter(p => isInWatchlist('part', p.part));
            
            // Search filter
            const search = (document.getElementById('partsSearch')?.value || '').toLowerCase();
            if (search) partsArray = partsArray.filter(p => p.part.toLowerCase().includes(search));
            
            // Column filters
            partsArray = partsArray.filter(p => {
                if (!passesColumnFilter('parts', 'part', p.part)) return false;
                if (!passesColumnFilter('parts', 'orders', String(p.orders))) return false;
                if (!passesColumnFilter('parts', 'qty', String(p.qty))) return false;
                if (!passesColumnFilter('parts', 'revenue', formatCurrency(p.revenue))) return false;
                if (!passesColumnFilter('parts', 'pl', p.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (p.margin < 0) marginCat = 'Negative';
                else if (p.margin < 10) marginCat = 'Low (0-10%)';
                else if (p.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('parts', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort - handle string vs numeric fields
            partsArray.sort((a, b) => {
                if (partsSort.field === 'part') {
                    return partsSort.asc ? a.part.localeCompare(b.part) : b.part.localeCompare(a.part);
                }
                return partsSort.asc ? a[partsSort.field] - b[partsSort.field] : b[partsSort.field] - a[partsSort.field];
            });
            
            // Render chart
            renderPartsBarChart(partsArray);
            
            // Render table
            document.getElementById('partsTableCount').textContent = `${partsArray.length} ${t('ui.parts')}`;
            document.getElementById('partsTableHeader').innerHTML = `
                <th>‚òÖ</th>
                ${createFilterHeader('parts', 'part', 'Part #')}
                ${createFilterHeader('parts', 'orders', 'Orders')}
                ${createFilterHeader('parts', 'qty', 'Qty')}
                ${createFilterHeader('parts', 'revenue', 'Revenue')}
                ${createFilterHeader('parts', 'pl', 'P/L')}
                ${createFilterHeader('parts', 'margin', 'Margin')}
            `;
            
            document.getElementById('partsTableBody').innerHTML = partsArray.map(p => `
                <tr class="clickable" onclick="showPartsCustomerDrilldown('${p.part.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('part', p.part) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistPart('${p.part.replace(/'/g, "\\'")}')">‚òÖ</span></td>
                    <td><strong>${p.part}</strong></td>
                    <td>${formatNumber(p.orders)}</td>
                    <td>${formatNumber(p.qty)}</td>
                    <td>${formatCurrency(p.revenue)}</td>
                    <td class="${p.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(p.pl)}</td>
                    <td class="${p.margin >= 0 ? 'positive' : 'negative'}">${p.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function renderPartsBarChart(partsArray) {
            // Sort all parts from lowest (losses) to highest (gains) P/L
            const sortedParts = [...partsArray].sort((a,b) => a.pl - b.pl);
            if (charts.partsBar) charts.partsBar.destroy();
            charts.partsBar = new Chart(document.getElementById('partsBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedParts.map(p => p.part),
                    datasets: [{ data: sortedParts.map(p => p.pl), backgroundColor: sortedParts.map(p => p.pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)') }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 }, maxRotation: 90 }, grid: { display: false } } } }
            });
        }
        
        function sortPartsTable(field) {
            if (partsSort.field === field) partsSort.asc = !partsSort.asc;
            else { partsSort.field = field; partsSort.asc = field === 'part'; }
            updateSalesPartsPage();
        }
        
        function filterPartsTable() { updateSalesPartsPage(); }
        function exportPartsCSV() { downloadCSV('Part,Orders,Qty,Revenue,P/L,Margin', 'parts_pl.csv'); }
        
        // Parts Drilldown Functions
        let partsCustomerDrilldownData = []; // Store data for re-sorting
        
        function showPartsCustomerDrilldown(part) {
            currentDrilldownPart = part;
            partsCustomerDrilldownSort = { field: 'pl', asc: false }; // Reset sort
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part);
            
            const customerStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!customerStats[c]) customerStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                customerStats[c].orders++;
                customerStats[c].qty += parseNumber(getVal(r, 'QTY'));
                customerStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) customerStats[c].pl += getPLValue(r);
            });
            
            // Convert to array with computed fields
            partsCustomerDrilldownData = Object.entries(customerStats).map(([customer, stats]) => ({
                customer,
                qty: stats.qty,
                unitPrice: stats.qty > 0 ? stats.revenue / stats.qty : 0,
                margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0,
                pl: stats.pl,
                revenue: stats.revenue
            }));
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsCustomerDrilldownPart').textContent = part;
            document.getElementById('partsCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Customers</div><div class="value">${partsCustomerDrilldownData.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            renderPartsCustomerDrilldownTable();
            
            document.getElementById('partsCustomerDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            document.getElementById('partsCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderPartsCustomerDrilldownTable() {
            // Render sortable header
            document.getElementById('partsCustomerDrilldownHeader').innerHTML = `
                <th onclick="sortPartsCustomerDrilldown('customer')">Customer <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('qty')">Qty <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('unitPrice')">Unit Price <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Contribution <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Margin <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('pl')">P/L <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortPartsCustomerDrilldown('revenue')">Revenue <span class="sort-indicator">‚Üï</span></th>
            `;
            
            // Sort data
            const sorted = [...partsCustomerDrilldownData].sort((a, b) => {
                if (partsCustomerDrilldownSort.field === 'customer') {
                    return partsCustomerDrilldownSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return partsCustomerDrilldownSort.asc ? a[partsCustomerDrilldownSort.field] - b[partsCustomerDrilldownSort.field] : b[partsCustomerDrilldownSort.field] - a[partsCustomerDrilldownSort.field];
            });
            
            document.getElementById('partsCustomerDrilldownBody').innerHTML = sorted.map(row => {
                return `<tr class="clickable" onclick="showPartsOrdersDrilldown('${currentDrilldownPart.replace(/'/g, "\\'")}', '${row.customer.replace(/'/g, "\\'")}')">
                    <td><strong>${row.customer}</strong></td>
                    <td>${formatNumber(row.qty)}</td>
                    <td>${formatCurrency(row.unitPrice)}</td>
                    <td>${getContributionBadge(row.margin)}</td>
                    <td class="${row.margin >= 0 ? 'positive' : 'negative'}">${row.margin.toFixed(1)}%</td>
                    <td class="${row.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.pl)}</td>
                    <td>${formatCurrency(row.revenue)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortPartsCustomerDrilldown(field) {
            if (partsCustomerDrilldownSort.field === field) {
                partsCustomerDrilldownSort.asc = !partsCustomerDrilldownSort.asc;
            } else {
                partsCustomerDrilldownSort.field = field;
                partsCustomerDrilldownSort.asc = field === 'customer'; // Strings default asc, numbers default desc
            }
            renderPartsCustomerDrilldownTable();
        }
        
        function showPartsOrdersDrilldown(part, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsOrdersBreadcrumbPart').textContent = part;
            document.getElementById('partsOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('partsOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.partsOrdersPrice) charts.partsOrdersPrice.destroy();
            const priceChartEl = document.getElementById('partsOrdersPriceChart');
            console.log('Price History Debug v7.5:', { dataPoints: priceData.length, prices: priceData.slice(0,5).map(d => d.price) });
            if (priceData.length > 1 && priceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                // If all prices are same or very close, create artificial range
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                console.log('Y-Axis Debug v7.5:', { minPrice, maxPrice, allSame, yAxisMin, yAxisMax });
                
                charts.partsOrdersPrice = new Chart(priceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Orders table
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('partsOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('partsOrdersDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePartsCustomerDrilldown() {
            document.getElementById('partsCustomerDrilldown').classList.remove('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            currentDrilldownPart = null;
        }
        
        function closePartsOrdersDrilldown() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function backToPartsCustomers() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function closeAllPartsDrilldowns() { closePartsCustomerDrilldown(); }

        // ============================================================
        // SALES BY CUSTOMERS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleCustomersCategory(cat) {
            customersFilters.categories[cat] = !customersFilters.categories[cat];
            if (!customersFilters.categories.rolltech && !customersFilters.categories.molding && !customersFilters.categories.snappad) { customersFilters.categories[cat] = true; return; }
            document.getElementById('customersBtnRollTech').classList.toggle('active', customersFilters.categories.rolltech);
            document.getElementById('customersBtnMolding').classList.toggle('active', customersFilters.categories.molding);
            document.getElementById('customersBtnSnapPad').classList.toggle('active', customersFilters.categories.snappad);
            updateSalesCustomersPage();
        }
        
        function applyCustomersDateFilter() {
            customersFilters.fromDate = document.getElementById('customersFromDate').value ? new Date(document.getElementById('customersFromDate').value) : null;
            customersFilters.toDate = document.getElementById('customersToDate').value ? new Date(document.getElementById('customersToDate').value) : null;
            updateSalesCustomersPage();
        }
        
        function resetCustomersDateFilter() {
            document.getElementById('customersFromDate').value = '';
            document.getElementById('customersToDate').value = '';
            customersFilters.fromDate = null;
            customersFilters.toDate = null;
            updateSalesCustomersPage();
        }
        
        function toggleCustomersWatchlistFilter() {
            customersFilters.watchlistOnly = !customersFilters.watchlistOnly;
            document.getElementById('customersWatchlistBtn').classList.toggle('active', customersFilters.watchlistOnly);
            updateSalesCustomersPage();
        }
        
        function getFilteredCustomersData() {
            return allData.filter(r => {
                if (!customersFilters.categories[getCategory(r)]) return false;
                if (customersFilters.fromDate || customersFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (customersFilters.fromDate && rowDate < customersFilters.fromDate) return false;
                    if (customersFilters.toDate && rowDate > customersFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesCustomersPage() {
            const data = getFilteredCustomersData();
            const custStats = {};
            
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            let custArray = Object.entries(custStats).map(([customer, stats]) => ({ customer, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            if (customersFilters.watchlistOnly) custArray = custArray.filter(c => isInWatchlist('customer', c.customer));
            
            const search = (document.getElementById('customersSearch')?.value || '').toLowerCase();
            if (search) custArray = custArray.filter(c => c.customer.toLowerCase().includes(search));
            
            // Column filters
            custArray = custArray.filter(c => {
                if (!passesColumnFilter('customers', 'customer', c.customer)) return false;
                if (!passesColumnFilter('customers', 'orders', String(c.orders))) return false;
                if (!passesColumnFilter('customers', 'qty', String(c.qty))) return false;
                if (!passesColumnFilter('customers', 'revenue', formatCurrency(c.revenue))) return false;
                if (!passesColumnFilter('customers', 'pl', c.pl >= 0 ? 'Positive' : 'Negative')) return false;
                let marginCat;
                if (c.margin < 0) marginCat = 'Negative';
                else if (c.margin < 10) marginCat = 'Low (0-10%)';
                else if (c.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('customers', 'margin', marginCat)) return false;
                return true;
            });
            
            custArray.sort((a, b) => {
                if (customersSort.field === 'customer') {
                    return customersSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return customersSort.asc ? a[customersSort.field] - b[customersSort.field] : b[customersSort.field] - a[customersSort.field];
            });
            
            // Chart
            const top10 = [...custArray].sort((a,b) => b.pl - a.pl).slice(0, 10);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#e53e3e', '#718096', '#4a5568'];
            if (charts.customers) charts.customers.destroy();
            charts.customers = new Chart(document.getElementById('customersChart'), {
                type: 'doughnut',
                data: { labels: top10.map(c => c.customer.substring(0, 20)), datasets: [{ data: top10.map(c => Math.abs(c.pl)), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
            
            // Table
            document.getElementById('customersTableCount').textContent = `${custArray.length} ${t('ui.customers')}`;
            document.getElementById('customersTableHeader').innerHTML = `
                <th>‚òÖ</th>
                ${createFilterHeader('customers', 'customer', 'Customer')}
                ${createFilterHeader('customers', 'orders', 'Orders')}
                ${createFilterHeader('customers', 'qty', 'Qty')}
                ${createFilterHeader('customers', 'revenue', 'Revenue')}
                ${createFilterHeader('customers', 'pl', 'P/L')}
                ${createFilterHeader('customers', 'margin', 'Margin')}
            `;
            
            document.getElementById('customersTableBody').innerHTML = custArray.map(c => `
                <tr class="clickable" onclick="showCustomersProductDrilldown('${c.customer.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('customer', c.customer) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistCustomer('${c.customer.replace(/'/g, "\\'")}')">‚òÖ</span></td>
                    <td><strong>${c.customer}</strong></td>
                    <td>${formatNumber(c.orders)}</td>
                    <td>${formatNumber(c.qty)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(c.pl)}</td>
                    <td class="${c.margin >= 0 ? 'positive' : 'negative'}">${c.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
            
            updateClearAllButton('customers');
        }
        
        function sortCustomersTable(field) {
            if (customersSort.field === field) customersSort.asc = !customersSort.asc;
            else { customersSort.field = field; customersSort.asc = field === 'customer'; }
            updateSalesCustomersPage();
        }
        
        function filterCustomersTable() { updateSalesCustomersPage(); }
        function exportCustomersCSV() { downloadCSV('Customer,Orders,Qty,Revenue,P/L,Margin', 'customers_pl.csv'); }
        
        // Customers Drilldown Functions
        function showCustomersProductDrilldown(customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer);
            
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersProductDrilldownCustomer').textContent = customer;
            document.getElementById('customersProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Products</div><div class="value">${Object.keys(partStats).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(partStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('customersProductDrilldownBody').innerHTML = sorted.map(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                const avgPrice = stats.qty > 0 ? stats.revenue / stats.qty : 0;
                return `<tr class="clickable" onclick="showCustomersOrdersDrilldown('${currentDrilldownCustomer.replace(/'/g, "\\'")}', '${part.replace(/'/g, "\\'")}')">
                    <td><strong>${part}</strong></td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(avgPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersProductDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            document.getElementById('customersProductDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showCustomersOrdersDrilldown(customer, part) {
            currentDrilldownPart = part;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer && getVal(r, 'PART') === part);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('customersOrdersBreadcrumbPart').textContent = part;
            document.getElementById('customersOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart for customer orders
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.customersOrdersPrice) charts.customersOrdersPrice.destroy();
            const custPriceChartEl = document.getElementById('customersOrdersPriceChart');
            if (priceData.length > 1 && custPriceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                
                charts.customersOrdersPrice = new Chart(custPriceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('customersOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersOrdersDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeCustomersProductDrilldown() {
            document.getElementById('customersProductDrilldown').classList.remove('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            currentDrilldownCustomer = null;
        }
        
        function closeCustomersOrdersDrilldown() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function backToCustomersProducts() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function closeAllCustomersDrilldowns() { closeCustomersProductDrilldown(); }

        // ============================================================
        // SALES BY DATE PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleDatesCategory(cat) {
            datesFilters.categories[cat] = !datesFilters.categories[cat];
            if (!datesFilters.categories.rolltech && !datesFilters.categories.molding && !datesFilters.categories.snappad) { datesFilters.categories[cat] = true; return; }
            document.getElementById('datesBtnRollTech').classList.toggle('active', datesFilters.categories.rolltech);
            document.getElementById('datesBtnMolding').classList.toggle('active', datesFilters.categories.molding);
            document.getElementById('datesBtnSnapPad').classList.toggle('active', datesFilters.categories.snappad);
            updateSalesDatesPage();
        }
        
        function applyDatesDateFilter() {
            datesFilters.fromDate = document.getElementById('datesFromDate').value ? new Date(document.getElementById('datesFromDate').value) : null;
            datesFilters.toDate = document.getElementById('datesToDate').value ? new Date(document.getElementById('datesToDate').value) : null;
            updateSalesDatesPage();
        }
        
        function resetDatesDateFilter() {
            document.getElementById('datesFromDate').value = '';
            document.getElementById('datesToDate').value = '';
            datesFilters.fromDate = null;
            datesFilters.toDate = null;
            updateSalesDatesPage();
        }
        
        function getFilteredDatesData() {
            return allData.filter(r => {
                if (!datesFilters.categories[getCategory(r)]) return false;
                if (datesFilters.fromDate || datesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (datesFilters.fromDate && rowDate < datesFilters.fromDate) return false;
                    if (datesFilters.toDate && rowDate > datesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesDatesPage() {
            const data = getFilteredDatesData();
            const monthStats = {};
            let totalOrders = 0, totalUnits = 0, totalRevenue = 0, totalPL = 0;
            
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                const status = getStatus(r);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, shippedPL: 0, forecastPL: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (status === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (status === 'shipped') monthStats[month].shippedPL += pl;
                    else monthStats[month].forecastPL += pl;
                }
                totalOrders++;
                totalUnits += parseNumber(getVal(r, 'QTY'));
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) totalPL += getPLValue(r);
            });
            
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100) : 0;
            const monthCount = Object.keys(monthStats).length;
            
            document.getElementById('datesStatOrders').textContent = formatNumber(totalOrders);
            document.getElementById('datesStatUnits').textContent = `${formatNumber(totalUnits)} ${t('ui.units')}`;
            document.getElementById('datesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('datesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('datesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMargin').textContent = `${t('stats.margin')}: ${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').className = `value ${margin >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMonths').textContent = `${monthCount} ${t('ui.months')}`;
            
            // Convert to array for filtering and sorting
            let monthsArray = Object.entries(monthStats).map(([month, stats]) => {
                const totalPL = stats.shippedPL + stats.forecastPL;
                const rowMargin = stats.revenue > 0 ? (totalPL / stats.revenue * 100) : 0;
                return {
                    month,
                    monthLabel: formatMonthLabel(month),
                    statusText: `${stats.shipped}/${stats.orders} Shipped`,
                    orders: stats.orders,
                    shipped: stats.shipped,
                    qty: stats.qty,
                    revenue: stats.revenue,
                    pl: totalPL,
                    margin: rowMargin,
                    shippedPL: stats.shippedPL,
                    forecastPL: stats.forecastPL
                };
            });
            
            // Apply column filters
            monthsArray = monthsArray.filter(m => {
                if (!passesColumnFilter('dates', 'month', m.monthLabel)) return false;
                if (!passesColumnFilter('dates', 'status', m.statusText)) return false;
                if (!passesColumnFilter('dates', 'orders', String(m.orders))) return false;
                if (!passesColumnFilter('dates', 'qty', String(m.qty))) return false;
                if (!passesColumnFilter('dates', 'revenue', formatCurrency(m.revenue))) return false;
                if (!passesColumnFilter('dates', 'pl', m.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (m.margin < 0) marginCat = 'Negative';
                else if (m.margin < 10) marginCat = 'Low (0-10%)';
                else if (m.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('dates', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort
            monthsArray.sort((a, b) => {
                const field = datesSort.field;
                if (field === 'month') {
                    return datesSort.asc ? a.month.localeCompare(b.month) : b.month.localeCompare(a.month);
                }
                return datesSort.asc ? a[field] - b[field] : b[field] - a[field];
            });
            
            // Use full array for chart (before filtering affects it)
            const chartMonths = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0]));
            
            // Stacked bar chart with shipped profit/loss and forecast profit/loss
            if (charts.datesBar) charts.datesBar.destroy();
            charts.datesBar = new Chart(document.getElementById('datesBarChart'), {
                type: 'bar',
                data: {
                    labels: chartMonths.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped Profit', data: chartMonths.map(s => Math.max(0, s[1].shippedPL)), backgroundColor: 'rgba(56,161,105,0.8)', stack: 'shipped' },
                        { label: 'Shipped Loss', data: chartMonths.map(s => Math.min(0, s[1].shippedPL)), backgroundColor: 'rgba(229,62,62,0.8)', stack: 'shipped' },
                        { label: 'Forecast Profit', data: chartMonths.map(s => Math.max(0, s[1].forecastPL)), backgroundColor: 'rgba(56,161,105,0.4)', stack: 'forecast' },
                        { label: 'Forecast Loss', data: chartMonths.map(s => Math.min(0, s[1].forecastPL)), backgroundColor: 'rgba(229,62,62,0.4)', stack: 'forecast' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { stacked: true, ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
            
            // Render filterable table header
            document.getElementById('datesTableHeader').innerHTML = 
                createFilterHeader('dates', 'month', 'Month') +
                createFilterHeader('dates', 'status', 'Status') +
                createFilterHeader('dates', 'orders', 'Orders') +
                createFilterHeader('dates', 'qty', 'Qty') +
                createFilterHeader('dates', 'revenue', 'Revenue') +
                createFilterHeader('dates', 'pl', 'P/L') +
                createFilterHeader('dates', 'margin', 'Margin');
            
            // Table with X/Y Shipped format
            document.getElementById('datesTableCount').textContent = `${monthsArray.length} ${t('ui.months')}`;
            document.getElementById('datesTableBody').innerHTML = monthsArray.map(m => {
                return `<tr class="clickable" onclick="showDatesCustomerDrilldown('${m.month}')">
                    <td><strong>${m.monthLabel}</strong></td>
                    <td>${m.statusText}</td>
                    <td>${formatNumber(m.orders)}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatCurrency(m.revenue)}</td>
                    <td class="${m.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.pl)}</td>
                    <td class="${m.margin >= 0 ? 'positive' : 'negative'}">${m.margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            updateClearAllButton('dates');
        }
        
        function sortDatesTable(field) {
            if (datesSort.field === field) datesSort.asc = !datesSort.asc;
            else { datesSort.field = field; datesSort.asc = field === 'month'; }
            updateSalesDatesPage();
        }
        
        function exportDatesCSV() { downloadCSV('Month,Status,Orders,Quantity,Revenue,P/L,Margin', 'dates_pl.csv'); }
        
        // Dates Drilldown Functions
        function showDatesCustomerDrilldown(month) {
            currentDrilldownMonth = month;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month);
            
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesCustomerDrilldownMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(custStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('datesCustomerDrilldownBody').innerHTML = sorted.map(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                return `<tr class="clickable" onclick="showDatesOrdersDrilldown('${currentDrilldownMonth}', '${customer.replace(/'/g, "\\'")}')">
                    <td><strong>${customer}</strong></td>
                    <td>${formatNumber(stats.orders)}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesCustomerDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            document.getElementById('datesCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDatesOrdersDrilldown(month, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesOrdersBreadcrumbMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('datesOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('datesOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${dateStr}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesOrdersDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeDatesCustomerDrilldown() {
            document.getElementById('datesCustomerDrilldown').classList.remove('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            currentDrilldownMonth = null;
        }
        
        function closeDatesOrdersDrilldown() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function backToDatesCustomers() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function closeAllDatesDrilldowns() { closeDatesCustomerDrilldown(); }

        // ============================================================
        // ============================================================
        // ALL DATA PAGE (Raw spreadsheet data - Columns A-AX)
        // ============================================================
        function updateAllDataPage() {
            document.getElementById('allDataLastUpdated').textContent = new Date().toLocaleTimeString();
            document.getElementById('allDataRowCount').textContent = allRawData.length;
            document.getElementById('allDataColCount').textContent = allRawHeaders.length;
            
            renderAllDataTableHeader();
            renderAllDataTable();
            updateClearAllButton('allData');
        }
        
        function renderAllDataTableHeader() {
            initTableFilters('allData');
            initHiddenColumns('allData');
            document.getElementById('allDataTableHeader').innerHTML = allRawHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('allData', colKey)) return '';
                return createFilterHeader('allData', colKey, h, true);
            }).join('');
        }
        
        function renderAllDataTable() {
            let data = [...allRawData];
            
            // Filter out rows where column A is empty (array formula fills column A only for valid rows)
            const firstColHeader = allRawHeaders[0];
            if (firstColHeader) {
                data = data.filter(row => {
                    const val = row[firstColHeader];
                    return val !== undefined && val !== null && val !== '';
                });
            }
            
            // Global search filter
            const globalSearch = (document.getElementById('allDataGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return allRawHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return allRawHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('allData', colKey, val);
                });
            });
            
            // Apply sort
            if (allDataSort.field !== null) {
                const colIndex = parseInt(allDataSort.field.replace('col_', ''));
                const header = allRawHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    // Try numeric comparison first
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return allDataSort.asc ? numA - numB : numB - numA;
                    }
                    // Fall back to string comparison
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return allDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table header (with hidden columns support)
            renderAllDataTableHeader();
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('allDataTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${allRawHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('allData', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('revenue') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('price') || h.toLowerCase().includes('p/l'))) {
                            const cls = num >= 0 ? 'positive' : 'negative';
                            return `<td class="${cls}">${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = allRawHeaders.filter((h, i) => !isColumnHidden('allData', `col_${i}`)).length;
            document.getElementById('allDataRowCount').textContent = data.length;
            document.getElementById('allDataColCount').textContent = visibleColCount;
            updateShowHiddenButton('allData');
        }
        
        function sortAllDataTable(field) {
            if (allDataSort.field === field) {
                allDataSort.asc = !allDataSort.asc;
            } else {
                allDataSort.field = field;
                allDataSort.asc = true;
            }
            renderAllDataTable();
        }
        
        function filterAllDataTable() {
            renderAllDataTable();
        }
        
        function getUniqueAllDataColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = allRawHeaders[colIndex];
            const firstColHeader = allRawHeaders[0];
            const values = new Set();
            // Only include values from rows where column A has data
            allRawData.forEach(row => {
                const firstColVal = row[firstColHeader];
                if (firstColVal === undefined || firstColVal === null || firstColVal === '') return;
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            // Sort values - try numeric first
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportAllDataToCSV() {
            const headers = allRawHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = allRawData.map(row => 
                allRawHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `all_data_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // BOM EXPLORER
        // ============================================================
        function initBomExplorer() { renderBomSelector(); }
        function filterBomSelector() { renderBomSelector((document.getElementById('bomSearch').value || '').toLowerCase()); }
        
        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab));
            document.getElementById('bomSearch').value = '';
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }
        
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available. Check that the source sheet contains data.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.length === 0 ? '<p style="color:var(--text-secondary);">No parts found.</p>' : filtered.map((d, i) => {
                const originalIndex = data.indexOf(d);
                return `<div class="bom-item" data-index="${originalIndex}" onclick="showBomDetails(${originalIndex})">${d[nameKey] || 'Unknown'}</div>`;
            }).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', parseInt(item.dataset.index) === index));
            
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search, exactMatch] of [['Mold','mold',false],['Weight','weight',false],['Labor/Part','labor cost/ part',false],['Overhead','overhead',false],['Total Cost','total cost',true]]) {
                    let key = exactMatch ? Object.keys(part).find(k => k.trim().toLowerCase() === search) : Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`);
                    if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                const partsPkgKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('parts per package'));
                if (partsPkgKey && part[partsPkgKey]) content += `<div class="cost-item"><span class="label">Parts/Pkg</span><span class="value">${part[partsPkgKey]}</span></div>`;
                const laborKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('labor cost / finished') || k.trim().toLowerCase().includes('labor cost/ finished'));
                if (laborKey && part[laborKey]) content += `<div class="cost-item"><span class="label">Labor</span><span class="value">${formatCurrency(parseNumber(part[laborKey]))}</span></div>`;
                const varCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'variable cost');
                if (varCostKey && part[varCostKey]) content += `<div class="cost-item"><span class="label">Variable Cost</span><span class="value">${formatCurrency(parseNumber(part[varCostKey]))}</span></div>`;
                const totalCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'total cost');
                if (totalCostKey && part[totalCostKey]) content += `<div class="cost-item"><span class="label">Total Cost</span><span class="value">${formatCurrency(parseNumber(part[totalCostKey]))}</span></div>`;
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) {
                    content += `<div class="highlight-box">`;
                    if (profitKey && part[profitKey]) { const profitVal = parseNumber(part[profitKey]); const displayVal = profitVal < 1 ? (profitVal * 100).toFixed(0) + '%' : profitVal.toFixed(0) + '%'; content += `<div class="item"><div class="value">${displayVal}</div><div class="label">Profit Target</div></div>`; }
                    if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`;
                    content += `</div>`;
                }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`);
                    if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) {
                        content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                    }
                }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        // ============================================================
        // REFERENCE DATA SECTIONS (FP Reference, Customer Reference, Quotes Registry)
        // ============================================================
        
        function handleRefDataClick(page) {
            if (!salesUnlocked) {
                promptSalesPassword();
                return;
            }
            navigateTo(page);
        }
        
        // Track if reference data has been loaded
        let referenceDataLoaded = false;
        
        async function updateFpReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderFpRefTable();
        }
        
        async function updateCustReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderCustRefTable();
        }
        
        async function updateQuotesRegistryPage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderQuotesTable();
        }
        
        async function loadReferenceData() {
            try {
                // Load FP Reference Data
                const fpRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${FP_REFERENCE_GID}`;
                const fpRes = await fetch(fpRefUrl);
                const fpText = await fpRes.text();
                const fpJson = JSON.parse(fpText.substring(fpText.indexOf('{'), fpText.lastIndexOf('}') + 1));
                fpReferenceHeaders = fpJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                fpReferenceData = fpJson.table.rows.map(r => {
                    const obj = {};
                    fpReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f || r.c[i].v || '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded FP Reference:', fpReferenceData.length, 'rows');
                
                // Load Customer Reference Data
                const custRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${CUSTOMER_REFERENCE_GID}`;
                const custRes = await fetch(custRefUrl);
                const custText = await custRes.text();
                const custJson = JSON.parse(custText.substring(custText.indexOf('{'), custText.lastIndexOf('}') + 1));
                customerReferenceHeaders = custJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                customerReferenceData = custJson.table.rows.map(r => {
                    const obj = {};
                    customerReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f || r.c[i].v || '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded Customer Reference:', customerReferenceData.length, 'rows');
                
                // Load Quotes Registry Data (with headers from spreadsheet, columns A-J only)
                const quotesUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${QUOTES_REGISTRY_GID}`;
                const quotesRes = await fetch(quotesUrl);
                const quotesText = await quotesRes.text();
                const quotesJson = JSON.parse(quotesText.substring(quotesText.indexOf('{'), quotesText.lastIndexOf('}') + 1));
                // Get headers from spreadsheet columns A-J (first 10 columns only)
                const allQuotesHeaders = quotesJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
                quotesRegistryHeaders = allQuotesHeaders.slice(0, 10).filter(h => h); // Only columns A-J
                quotesRegistryData = quotesJson.table.rows.map(r => {
                    const obj = {};
                    quotesRegistryHeaders.forEach((h, i) => { obj[h] = (r.c && r.c[i]) ? (r.c[i].f || r.c[i].v || '') : ''; });
                    return obj;
                }).filter(row => {
                    // Filter out rows without Quote Number and filter out the header row if it got included as data
                    const quoteNum = row['Quote Number'] || row[quotesRegistryHeaders[0]];
                    return quoteNum && quoteNum !== 'Quote Number';
                });
                console.log('Loaded Quotes Registry:', quotesRegistryData.length, 'rows, Headers:', quotesRegistryHeaders);
                
            } catch (e) {
                console.error('Reference data load error:', e);
            }
        }
        
        // FP Reference Data Functions
        function renderFpRefTableHeader() {
            initTableFilters('fpRef');
            initHiddenColumns('fpRef');
            document.getElementById('fpRefTableHeader').innerHTML = fpReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('fpRef', colKey)) return '';
                return createFilterHeader('fpRef', colKey, h, true);
            }).join('');
        }
        
        function renderFpRefTable() {
            if (fpReferenceHeaders.length === 0) {
                document.getElementById('fpRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderFpRefTableHeader();
            let data = [...fpReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('fpRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return fpReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return fpReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('fpRef', colKey, val);
                });
            });
            
            // Apply sort
            if (fpRefSort.field !== null) {
                const colIndex = parseInt(fpRefSort.field.replace('col_', ''));
                const header = fpReferenceHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return fpRefSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return fpRefSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('fpRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${fpReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('fpRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = fpReferenceHeaders.filter((h, i) => !isColumnHidden('fpRef', `col_${i}`)).length;
            document.getElementById('fpRefRowCount').textContent = data.length;
            document.getElementById('fpRefColCount').textContent = visibleColCount;
            document.getElementById('fpRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('fpRef');
            updateShowHiddenButton('fpRef');
        }
        
        function sortFpRefTable(field) {
            if (fpRefSort.field === field) {
                fpRefSort.asc = !fpRefSort.asc;
            } else {
                fpRefSort.field = field;
                fpRefSort.asc = true;
            }
            renderFpRefTable();
        }
        
        function filterFpRefTable() { renderFpRefTable(); }
        
        function getUniqueFpRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = fpReferenceHeaders[colIndex];
            const values = new Set();
            fpReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportFpRefToCSV() {
            const headers = fpReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = fpReferenceData.map(row => 
                fpReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `fp_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Customer Reference Data Functions
        function renderCustRefTableHeader() {
            initTableFilters('custRef');
            initHiddenColumns('custRef');
            document.getElementById('custRefTableHeader').innerHTML = customerReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('custRef', colKey)) return '';
                return createFilterHeader('custRef', colKey, h, true);
            }).join('');
        }
        
        function renderCustRefTable() {
            if (customerReferenceHeaders.length === 0) {
                document.getElementById('custRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderCustRefTableHeader();
            let data = [...customerReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('custRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return customerReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return customerReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('custRef', colKey, val);
                });
            });
            
            // Apply sort
            if (custRefSort.field !== null) {
                const colIndex = parseInt(custRefSort.field.replace('col_', ''));
                const header = customerReferenceHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return custRefSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return custRefSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('custRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${customerReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('custRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('price') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('sell'))) {
                            return `<td>${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = customerReferenceHeaders.filter((h, i) => !isColumnHidden('custRef', `col_${i}`)).length;
            document.getElementById('custRefRowCount').textContent = data.length;
            document.getElementById('custRefColCount').textContent = visibleColCount;
            document.getElementById('custRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('custRef');
            updateShowHiddenButton('custRef');
        }
        
        function sortCustRefTable(field) {
            if (custRefSort.field === field) {
                custRefSort.asc = !custRefSort.asc;
            } else {
                custRefSort.field = field;
                custRefSort.asc = true;
            }
            renderCustRefTable();
        }
        
        function filterCustRefTable() { renderCustRefTable(); }
        
        function getUniqueCustRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = customerReferenceHeaders[colIndex];
            const values = new Set();
            customerReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportCustRefToCSV() {
            const headers = customerReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = customerReferenceData.map(row => 
                customerReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `customer_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Quotes Registry Functions
        function renderQuotesTableHeader() {
            initTableFilters('quotes');
            initHiddenColumns('quotes');
            document.getElementById('quotesTableHeader').innerHTML = quotesRegistryHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('quotes', colKey)) return '';
                return createFilterHeader('quotes', colKey, h, true);
            }).join('');
        }
        
        function renderQuotesTable() {
            if (quotesRegistryData.length === 0) {
                document.getElementById('quotesTableBody').innerHTML = '<tr><td colspan="11">Loading data...</td></tr>';
                return;
            }
            
            renderQuotesTableHeader();
            let data = [...quotesRegistryData];
            
            // Global search filter
            const globalSearch = (document.getElementById('quotesGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return quotesRegistryHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return quotesRegistryHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('quotes', colKey, val);
                });
            });
            
            // Apply sort
            if (quotesSort.field !== null) {
                const colIndex = parseInt(quotesSort.field.replace('col_', ''));
                const header = quotesRegistryHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return quotesSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return quotesSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('quotesTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${quotesRegistryHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('quotes', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Make Drive Link clickable (case-insensitive check)
                    if (h.toLowerCase().includes('drive') && h.toLowerCase().includes('link') && val && String(val).startsWith('http')) {
                        return `<td><a href="${val}" target="_blank" style="color:var(--accent);">üìÑ View</a></td>`;
                    }
                    // Format Amount as currency (case-insensitive check)
                    if (h.toLowerCase() === 'amount' && val) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && num !== 0) return `<td>${formatCurrency(num)}</td>`;
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = quotesRegistryHeaders.filter((h, i) => !isColumnHidden('quotes', `col_${i}`)).length;
            document.getElementById('quotesRowCount').textContent = data.length;
            document.getElementById('quotesColCount').textContent = visibleColCount;
            document.getElementById('quotesLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('quotes');
            updateShowHiddenButton('quotes');
        }
        
        function sortQuotesTable(field) {
            if (quotesSort.field === field) {
                quotesSort.asc = !quotesSort.asc;
            } else {
                quotesSort.field = field;
                quotesSort.asc = true;
            }
            renderQuotesTable();
        }
        
        function filterQuotesTable() { renderQuotesTable(); }
        
        function getUniqueQuotesColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = quotesRegistryHeaders[colIndex];
            const values = new Set();
            quotesRegistryData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportQuotesToCSV() {
            const headers = quotesRegistryHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = quotesRegistryData.map(row => 
                quotesRegistryHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `quotes_registry_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedZoom();
            loadDashboard();
        });
    </script>
</body>
</html>
