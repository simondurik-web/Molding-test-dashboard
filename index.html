<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Roll Tech Operations Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --staged-blue: #4299e1;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1421 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
        }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 12px; overflow-y: auto; z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.4); transition: transform 0.3s ease;
        }
        .logo { text-align: center; padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .logo h1 { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 11px; color: var(--text-secondary); display: block; margin-top: 4px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 14px; font-weight: 700; }
        .nav-item { display: flex; align-items: center; padding: 11px 14px; margin: 3px 0; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 12px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item.sub-item { padding-left: 36px; font-size: 11px; opacity: 0.9; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 8px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }
        .lang-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; margin: 10px 8px; }
        .lang-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: white; }
        .main-content { margin-left: var(--sidebar-width); padding: 20px 24px; min-height: 100vh; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .dept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dept-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 16px; padding: 24px; border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .dept-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .dept-card.sales::before { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .dept-card.production::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .dept-card.inventory::before { background: linear-gradient(90deg, var(--teal), var(--accent)); }
        .dept-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-color: var(--accent); }
        .dept-card .icon-large { font-size: 40px; margin-bottom: 12px; }
        .dept-card h3 { font-size: 20px; margin-bottom: 8px; }
        .dept-card p { color: var(--text-secondary); font-size: 12px; margin-bottom: 16px; }
        .dept-card .metrics { display: flex; gap: 20px; flex-wrap: wrap; }
        .dept-card .metric .value { font-size: 22px; font-weight: 700; }
        .dept-card .metric .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .dept-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .dept-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .coming-soon { position: absolute; top: 12px; right: 12px; background: var(--warning); color: #1a202c; padding: 3px 10px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .quick-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 24px; }
        .quick-stat { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 12px; padding: 16px; border: 1px solid var(--border); text-align: center; }
        .quick-stat .value { font-size: 24px; font-weight: 700; }
        .quick-stat .value.positive { color: var(--success); }
        .quick-stat .value.negative { color: var(--danger); }
        .quick-stat .value.warning { color: var(--warning); }
        .quick-stat .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .info-banner { border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; display: none; }
        .info-banner.active { display: flex; align-items: center; gap: 12px; }
        .info-banner.warning { background: linear-gradient(135deg, #744210 0%, #975a16 100%); border: 1px solid var(--warning); }
        .info-banner.warning p { color: #fefcbf; }
        .info-banner.info { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border: 1px solid var(--accent); }
        .info-banner.info p { color: #bee3f8; }
        .info-banner p { font-size: 12px; margin: 0; }
        .info-banner .icon { font-size: 20px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border); }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"], .toolbar input[type="text"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .toolbar-spacer { flex: 1; }
        .category-filters { display: flex; gap: 8px; }
        .category-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 2px solid; display: flex; align-items: center; gap: 6px; }
        .category-btn .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .category-btn.rolltech { border-color: var(--accent); color: var(--accent); background: transparent; }
        .category-btn.rolltech.active { background: var(--accent); color: white; }
        .category-btn.rolltech .indicator { background: var(--accent); }
        .category-btn.molding { border-color: var(--warning); color: var(--warning); background: transparent; }
        .category-btn.molding.active { background: var(--warning); color: #1a202c; }
        .category-btn.molding .indicator { background: var(--warning); }
        .category-btn:not(.active) { opacity: 0.5; }
        .category-btn:not(.active):hover { opacity: 0.8; }
        .status-filters { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; border: 1px solid; }
        .status-btn.pending { border-color: var(--warning); color: var(--warning); background: transparent; }
        .status-btn.pending.active { background: var(--warning); color: #1a202c; }
        .status-btn.staged { border-color: var(--staged-blue); color: var(--staged-blue); background: transparent; }
        .status-btn.staged.active { background: var(--staged-blue); color: white; }
        .status-btn.wip { border-color: var(--teal); color: var(--teal); background: transparent; }
        .status-btn.wip.active { background: var(--teal); color: white; }
        .status-btn.shipped { border-color: var(--success); color: var(--success); background: transparent; }
        .status-btn.shipped.active { background: var(--success); color: white; }
        .status-btn:not(.active) { opacity: 0.5; }
        .status-btn:not(.active):hover { opacity: 0.8; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; white-space: nowrap; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .warning-text { color: var(--warning); font-weight: 600; }
        .scrollable-table { max-height: 600px; overflow-y: auto; overflow-x: auto; border-radius: 10px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--staged-blue) 0%, #3182ce 100%); color: white; }
        .badge.wip { background: linear-gradient(135deg, var(--teal) 0%, #2c7a7b 100%); color: white; }
        .badge.urgent { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }
        .badge.priority-1 { background: var(--danger); color: white; }
        .badge.priority-2 { background: var(--warning); color: #1a202c; }
        .badge.priority-3 { background: var(--accent); color: white; }
        .badge.priority-4 { background: var(--teal); color: white; }
        .cell-missing { color: var(--danger); font-weight: 600; }
        .cell-available { color: var(--success); }
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .search-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1200px) { .quick-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .dept-grid { grid-template-columns: 1fr; }
            .quick-stats { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-spacer { display: none; }
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }
        .inv-low { background: rgba(229,62,62,0.15) !important; }
        .inv-warning { background: rgba(214,158,46,0.15) !important; }
        .inv-ok { background: rgba(56,161,105,0.08) !important; }
        .drilldown-section { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .drilldown-section.active { display: block; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; }
        .breadcrumb { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .close-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .close-btn:hover { border-color: var(--danger); color: var(--danger); }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        .summary-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        @media (max-width: 768px) { .bom-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
    </style>
</head>
<body>
    <div class="mobile-header">
        <div><h1>Roll Tech</h1><span style="font-size:10px;color:var(--text-secondary);">Operations</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="logo"><h1>Roll Tech</h1><span id="logoSubtitle">Operations Dashboard</span></div>
        <div class="lang-toggle">
            <button class="lang-btn active" id="langEN" onclick="setLanguage('en')">English</button>
            <button class="lang-btn" id="langES" onclick="setLanguage('es')">Espa√±ol</button>
        </div>
        <div class="nav-section">
            <div class="nav-item active" data-page="main" onclick="navigateTo('main')"><span class="icon">üè†</span> <span data-i18n="nav.main">Main Dashboard</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.production">Production</div>
            <div class="nav-item" data-page="orders-data" onclick="navigateTo('orders-data')"><span class="icon">üìã</span> <span data-i18n="nav.ordersData">Orders Data</span></div>
            <div class="nav-item sub-item" data-page="orders-queue" onclick="navigateTo('orders-queue')"><span class="icon">üîß</span> <span data-i18n="nav.ordersQueue">Need to Make</span></div>
            <div class="nav-item sub-item" data-page="orders-staged" onclick="navigateTo('orders-staged')"><span class="icon">üì¶</span> <span data-i18n="nav.ordersStaged">Ready to Ship</span></div>
            <div class="nav-item sub-item" data-page="orders-shipped" onclick="navigateTo('orders-shipped')"><span class="icon">üöö</span> <span data-i18n="nav.ordersShipped">Shipped</span></div>
            <div class="nav-item" data-page="inventory" onclick="navigateTo('inventory')"><span class="icon">üì¶</span> <span data-i18n="nav.inventory">Inventory</span></div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.salesFinance">Sales & Finance</div>
            <div class="nav-item" data-page="sales-overview" onclick="navigateTo('sales-overview')"><span class="icon">üìä</span> <span data-i18n="nav.plOverview">P/L Overview</span></div>
            <div class="nav-item sub-item" data-page="sales-parts" onclick="navigateTo('sales-parts')"><span class="icon">üîß</span> <span data-i18n="nav.byPart">By Part Number</span></div>
            <div class="nav-item sub-item" data-page="sales-customers" onclick="navigateTo('sales-customers')"><span class="icon">üë•</span> <span data-i18n="nav.byCustomer">By Customer</span></div>
            <div class="nav-item sub-item" data-page="sales-dates" onclick="navigateTo('sales-dates')"><span class="icon">üìÖ</span> <span data-i18n="nav.byDate">By Date</span></div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.billOfMaterials">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">üìã</span> <span data-i18n="nav.bomExplorer">BOM Explorer</span></div>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading"><div class="spinner"></div><p style="margin-top:18px;color:var(--text-secondary);" data-i18n="loading">Loading data from Google Sheets...</p></div>

        <!-- MAIN DASHBOARD -->
        <div id="main" class="page">
            <div class="page-header">
                <div><h2 data-i18n="main.title">Operations Dashboard</h2><p data-i18n="main.subtitle">Real-time overview of Roll Tech manufacturing operations</p></div>
                <div class="last-updated"><span class="dot"></span><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="quick-stats">
                <div class="quick-stat"><div class="value warning" id="qsNeedToMake">-</div><div class="label" data-i18n="stats.needToMake">Need to Make</div></div>
                <div class="quick-stat"><div class="value" id="qsUrgentOrders">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                <div class="quick-stat"><div class="value" id="qsTotalQty">-</div><div class="label" data-i18n="stats.totalUnits">Total Units</div></div>
                <div class="quick-stat"><div class="value positive" id="qsMonthlyRevenue">-</div><div class="label" data-i18n="stats.monthRevenue">Month Revenue</div></div>
                <div class="quick-stat"><div class="value" id="qsMonthlyPL">-</div><div class="label" data-i18n="stats.monthPL">Month P/L</div></div>
                <div class="quick-stat"><div class="value warning" id="qsMissingComponents">-</div><div class="label" data-i18n="stats.missingParts">Missing Parts</div></div>
            </div>
            <div class="dept-grid">
                <div class="dept-card production" onclick="navigateTo('orders-queue')">
                    <div class="icon-large">üè≠</div>
                    <h3 data-i18n="dept.production">Production Planning</h3>
                    <p data-i18n="dept.productionDesc">View orders to make, component status, and production queue</p>
                    <div class="metrics">
                        <div class="metric"><div class="value" id="deptProdOrders">-</div><div class="label" data-i18n="dept.needToMake">Need to Make</div></div>
                        <div class="metric"><div class="value" id="deptProdUnits">-</div><div class="label" data-i18n="dept.units">Units</div></div>
                        <div class="metric"><div class="value warning" id="deptProdUrgent">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                    </div>
                </div>
                <div class="dept-card sales" onclick="navigateTo('sales-overview')">
                    <div class="icon-large">üí∞</div>
                    <h3 data-i18n="dept.sales">Sales & P/L Analytics</h3>
                    <p data-i18n="dept.salesDesc">Revenue, profitability, and customer analysis</p>
                    <div class="metrics">
                        <div class="metric"><div class="value positive" id="deptSalesRev">-</div><div class="label" data-i18n="dept.revenue">Revenue</div></div>
                        <div class="metric"><div class="value" id="deptSalesPL">-</div><div class="label" data-i18n="dept.profit">Profit</div></div>
                        <div class="metric"><div class="value" id="deptSalesOrders">-</div><div class="label" data-i18n="dept.orders">Orders</div></div>
                    </div>
                </div>
                <div class="dept-card inventory" onclick="navigateTo('inventory')">
                    <div class="icon-large">üì¶</div>
                    <h3 data-i18n="dept.inventory">Inventory Management</h3>
                    <p data-i18n="dept.inventoryDesc">Stock levels, reorder points, and material tracking</p>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.ordersByStatus">Orders by Status</h3></div>
                    <div class="chart-wrapper"><canvas id="mainStatusChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.upcomingDeadlines">Upcoming Deadlines (Next 14 Days)</h3></div>
                    <div class="chart-wrapper"><canvas id="mainDeadlineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ORDERS DATA PAGE -->
        <div id="orders-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersData.title">All Orders Data</h2><p data-i18n="ordersData.subtitle">Complete order database with all statuses</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersDataBtnRollTech" onclick="toggleOrdersDataCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="ordersDataBtnMolding" onclick="toggleOrdersDataCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group status-filters">
                    <label>Status:</label>
                    <button class="status-btn pending active" id="ordersDataStatusPending" onclick="toggleOrdersDataStatus('pending')"><span data-i18n="status.needToMake">Need to Make</span></button>
                    <button class="status-btn wip active" id="ordersDataStatusWip" onclick="toggleOrdersDataStatus('wip')"><span data-i18n="status.making">Making</span></button>
                    <button class="status-btn staged active" id="ordersDataStatusStaged" onclick="toggleOrdersDataStatus('staged')"><span data-i18n="status.readyToShip">Ready to Ship</span></button>
                    <button class="status-btn shipped" id="ordersDataStatusShipped" onclick="toggleOrdersDataStatus('shipped')"><span data-i18n="status.shipped">Shipped</span></button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersDataSearch" placeholder="Search..." oninput="filterOrdersDataTable()">
                <button class="toolbar-btn" onclick="exportOrdersDataToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Orders</div><div class="value" id="ordersDataTotalOrders">-</div><div class="sub" id="ordersDataTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needToMake">Need to Make</div><div class="value warning" id="ordersDataNeedToMake">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.making">Making</div><div class="value" style="color:var(--teal);" id="ordersDataMaking">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.readyToShip">Ready to Ship</div><div class="value positive" id="ordersDataReadyToShip">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersDataTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="ordersDataTable"><thead><tr id="ordersDataTableHeader"></tr></thead><tbody id="ordersDataTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS QUEUE PAGE -->
        <div id="orders-queue" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersQueue.title">Orders Queue - Need to Make</h2><p data-i18n="ordersQueue.subtitle">Orders pending production (Pending + Approved status)</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê Back</button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersQueueLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersQueueBtnRollTech" onclick="toggleOrdersQueueCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="ordersQueueBtnMolding" onclick="toggleOrdersQueueCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersQueueSearch" placeholder="Search..." oninput="filterOrdersQueueTable()">
                <button class="toolbar-btn" onclick="exportOrdersQueueToCSV()">üì• Export</button>
            </div>
            <div class="info-banner warning" id="ordersQueueMissingBanner">
                <span class="icon">‚ö†Ô∏è</span>
                <p><strong id="ordersQueueMissingCount">0</strong> <span data-i18n="prod.missingMsg">orders have missing components.</span></p>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Orders</div><div class="value" id="ordersQueueTotalOrders">-</div><div class="sub" id="ordersQueueTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Urgent</div><div class="value negative" id="ordersQueueUrgentCount">-</div></div>
                <div class="stat-card"><div class="label">Due This Week</div><div class="value warning" id="ordersQueueDueWeek">-</div><div class="sub" id="ordersQueueDueWeekUnits">- units</div></div>
                <div class="stat-card"><div class="label">Components Ready</div><div class="value positive" id="ordersQueueComponentsReady">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Orders to Make</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersQueueTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersQueueTableHeader"></tr></thead><tbody id="ordersQueueTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS STAGED PAGE -->
        <div id="orders-staged" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersStaged.title">Staged Orders - Ready to Ship</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersStagedBtnRollTech" onclick="toggleOrdersStagedCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="ordersStagedBtnMolding" onclick="toggleOrdersStagedCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersStagedSearch" placeholder="Search..." oninput="filterOrdersStagedTable()">
                <button class="toolbar-btn" onclick="exportOrdersStagedToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Staged Orders</div><div class="value" id="ordersStagedTotalOrders">-</div><div class="sub" id="ordersStagedTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value positive" id="ordersStagedRevenue">-</div></div>
                <div class="stat-card"><div class="label">Avg Order Value</div><div class="value" id="ordersStagedAvgValue">-</div></div>
                <div class="stat-card"><div class="label">Customers</div><div class="value" id="ordersStagedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Ready to Ship</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersStagedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersStagedTableHeader"></tr></thead><tbody id="ordersStagedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS SHIPPED PAGE -->
        <div id="orders-shipped" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersShipped.title">Shipped Orders History</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="ordersShippedBtnRollTech" onclick="toggleOrdersShippedCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="ordersShippedBtnMolding" onclick="toggleOrdersShippedCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="ordersShippedFromDate" onchange="applyShippedDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="ordersShippedToDate" onchange="applyShippedDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetShippedDateFilter()">üîÑ Reset</button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersShippedSearch" placeholder="Search..." oninput="filterOrdersShippedTable()">
                <button class="toolbar-btn" onclick="exportOrdersShippedToCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Shipped Orders</div><div class="value" id="ordersShippedTotalOrders">-</div><div class="sub" id="ordersShippedTotalUnits">- units</div></div>
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value positive" id="ordersShippedRevenue">-</div></div>
                <div class="stat-card"><div class="label">Total P/L</div><div class="value" id="ordersShippedPL">-</div><div class="sub" id="ordersShippedMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Customers</div><div class="value" id="ordersShippedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Shipped Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersShippedTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="ordersShippedTableHeader"></tr></thead><tbody id="ordersShippedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- INVENTORY PAGE -->
        <div id="inventory" class="page">
            <div class="page-header">
                <div><h2 data-i18n="inv.title">Inventory Management</h2></div>
            </div>
            <div class="toolbar">
                <input type="text" class="search-box" id="invSearch" placeholder="Search items..." oninput="filterInvTable()">
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="invFilterAll" onclick="setInvFilter('all')">All</button>
                    <button class="toolbar-btn" id="invFilterLow" onclick="setInvFilter('low')">‚ö†Ô∏è Low Stock</button>
                    <button class="toolbar-btn" id="invFilterNeeded" onclick="setInvFilter('needed')">üîß Needs Production</button>
                </div>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportInvCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Items</div><div class="value" id="invStatTotal">-</div><div class="sub" id="invStatTypes">- product types</div></div>
                <div class="stat-card"><div class="label">Low Stock</div><div class="value" style="color:var(--danger);" id="invStatLow">-</div></div>
                <div class="stat-card"><div class="label">Needs Production</div><div class="value" style="color:var(--warning);" id="invStatNeeded">-</div></div>
                <div class="stat-card"><div class="label">Adequate Stock</div><div class="value" style="color:var(--success);" id="invStatOk">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Inventory Status</h3><span style="color:var(--text-secondary);font-size:12px;" id="invTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table" id="invTable">
                        <thead><tr>
                            <th onclick="sortInvTable('product')">Product Type</th>
                            <th onclick="sortInvTable('partNumber')">Part Number</th>
                            <th onclick="sortInvTable('fusionQty')">Fusion Qty</th>
                            <th onclick="sortInvTable('minimum')">Minimum</th>
                            <th onclick="sortInvTable('manualTarget')">Manual Target</th>
                            <th onclick="sortInvTable('qtyNeeded')">Qty Needed</th>
                            <th onclick="sortInvTable('partsToBeMade')">Parts to Make</th>
                            <th onclick="sortInvTable('moldType')">Mold Type</th>
                            <th>Status</th>
                        </tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES OVERVIEW PAGE -->
        <div id="sales-overview" class="page">
            <div class="page-header">
                <div><h2 data-i18n="sales.title">P/L Overview</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="salesBtnRollTech" onclick="toggleSalesCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="salesBtnMolding" onclick="toggleSalesCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportSalesCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Total Revenue</div><div class="value" id="salesStatRevenue">-</div><div class="sub" id="salesStatOrderCount">- orders</div></div>
                <div class="stat-card"><div class="label">Total P/L</div><div class="value" id="salesStatPL">-</div><div class="sub" id="salesStatMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Shipped P/L</div><div class="value" id="salesStatShippedPL">-</div><div class="sub" id="salesStatShippedCount">- shipped</div></div>
                <div class="stat-card"><div class="label">Forecasted P/L</div><div class="value" id="salesStatForecastPL">-</div><div class="sub" id="salesStatForecastCount">- pending</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly P/L Trend</h3></div>
                <div class="chart-wrapper large"><canvas id="salesTrendChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY PARTS PAGE -->
        <div id="sales-parts" class="page">
            <div class="page-header">
                <div><h2>P/L by Part Number</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Parts P/L Analysis</h3></div>
                <div class="chart-wrapper large"><canvas id="partsBarChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY CUSTOMERS PAGE -->
        <div id="sales-customers" class="page">
            <div class="page-header">
                <div><h2>P/L by Customer</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Customer P/L Distribution</h3></div>
                <div class="chart-wrapper large"><canvas id="customersChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY DATE PAGE -->
        <div id="sales-dates" class="page">
            <div class="page-header">
                <div><h2>P/L by Date</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">‚Üê Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label>Category:</label>
                    <button class="category-btn rolltech active" id="datesBtnRollTech" onclick="toggleDatesCategory('rolltech')"><span class="indicator"></span> Roll Tech</button>
                    <button class="category-btn molding" id="datesBtnMolding" onclick="toggleDatesCategory('molding')"><span class="indicator"></span> Molding</button>
                </div>
                <div class="toolbar-group">
                    <label>From:</label><input type="date" id="datesFromDate" onchange="applyDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label>To:</label><input type="date" id="datesToDate" onchange="applyDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetDateFilter()">üîÑ Reset</button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportDatesCSV()">üì• Export</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">Orders</div><div class="value" id="datesStatOrders">-</div><div class="sub" id="datesStatUnits">- units</div></div>
                <div class="stat-card"><div class="label">Revenue</div><div class="value" id="datesStatRevenue">-</div></div>
                <div class="stat-card"><div class="label">P/L</div><div class="value" id="datesStatPL">-</div><div class="sub" id="datesStatMargin">Margin: -%</div></div>
                <div class="stat-card"><div class="label">Margin</div><div class="value" id="datesStatMarginPct">-</div><div class="sub" id="datesStatMonths">- months</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly P/L Breakdown</h3></div>
                <div class="chart-wrapper large"><canvas id="datesBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3>Monthly Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="datesTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr><th>Month</th><th>Orders</th><th>Revenue</th><th>P/L</th><th>Margin</th></tr></thead><tbody id="datesTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- BOM EXPLORER PAGE -->
        <div id="bom" class="page">
            <div class="page-header">
                <div><h2 data-i18n="bom.title">BOM Explorer</h2></div>
            </div>
            <div class="info-banner info active">
                <span class="icon">‚ÑπÔ∏è</span>
                <p><strong>Note:</strong> BOM data reflects current filter state in Google Sheets. If items appear missing, check that no filters are active in the source sheets.</p>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" placeholder="Search parts..." oninput="filterBomSelector()">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // INTERNATIONALIZATION
        // ============================================================
        const translations = {
            en: {
                'logoSubtitle': 'Operations Dashboard',
                'nav.main': 'Main Dashboard',
                'nav.production': 'PRODUCTION',
                'nav.ordersData': 'Orders Data',
                'nav.ordersQueue': 'Need to Make',
                'nav.ordersStaged': 'Ready to Ship',
                'nav.ordersShipped': 'Shipped',
                'nav.inventory': 'Inventory',
                'nav.salesFinance': 'SALES & FINANCE',
                'nav.plOverview': 'P/L Overview',
                'nav.byPart': 'By Part Number',
                'nav.byCustomer': 'By Customer',
                'nav.byDate': 'By Date',
                'nav.billOfMaterials': 'BILL OF MATERIALS',
                'nav.bomExplorer': 'BOM Explorer',
                'loading': 'Loading data from Google Sheets...',
                'main.title': 'Operations Dashboard',
                'main.subtitle': 'Real-time overview of Roll Tech manufacturing operations',
                'stats.needToMake': 'Need to Make',
                'stats.making': 'Making',
                'stats.readyToShip': 'Ready to Ship',
                'stats.urgent': 'Urgent',
                'stats.totalUnits': 'Total Units',
                'stats.monthRevenue': 'Month Revenue',
                'stats.monthPL': 'Month P/L',
                'stats.missingParts': 'Missing Parts',
                'status.needToMake': 'Need to Make',
                'status.making': 'Making',
                'status.readyToShip': 'Ready to Ship',
                'status.shipped': 'Shipped',
                'status.urgent': 'URGENT',
                'dept.production': 'Production Planning',
                'dept.productionDesc': 'View orders to make, component status, and production queue',
                'dept.needToMake': 'Need to Make',
                'dept.units': 'Units',
                'dept.sales': 'Sales & P/L Analytics',
                'dept.salesDesc': 'Revenue, profitability, and customer analysis',
                'dept.revenue': 'Revenue',
                'dept.profit': 'Profit',
                'dept.orders': 'Orders',
                'dept.inventory': 'Inventory Management',
                'dept.inventoryDesc': 'Stock levels, reorder points, and material tracking',
                'chart.ordersByStatus': 'Orders by Status',
                'chart.upcomingDeadlines': 'Upcoming Deadlines (Next 14 Days)',
                'ordersData.title': 'All Orders Data',
                'ordersData.subtitle': 'Complete order database with all statuses',
                'ordersQueue.title': 'Orders Queue - Need to Make',
                'ordersQueue.subtitle': 'Orders pending production (Pending + Approved status)',
                'ordersStaged.title': 'Staged Orders - Ready to Ship',
                'ordersShipped.title': 'Shipped Orders History',
                'prod.missingMsg': 'orders have missing components.',
                'btn.backToDashboard': 'Back',
                'col.line': 'Line',
                'col.priority': 'Priority',
                'col.daysUntil': 'Days Until',
                'col.requestDate': 'Request Date',
                'col.customer': 'Customer',
                'col.ifNum': 'IF #',
                'col.part': 'Part #',
                'col.qty': 'Qty',
                'col.packaging': 'Packaging',
                'col.tire': 'Tire',
                'col.hub': 'Hub',
                'col.hubMold': 'Hub Mold',
                'col.bearings': 'Bearings',
                'col.status': 'Status',
                'col.assigned': 'Assigned To',
                'col.shippedDate': 'Shipped Date',
                'col.revenue': 'Revenue',
                'col.pl': 'P/L',
                'missing': 'Missing',
                'sales.title': 'P/L Overview',
                'inv.title': 'Inventory Management',
                'bom.title': 'BOM Explorer'
            },
            es: {
                'logoSubtitle': 'Panel de Operaciones',
                'nav.main': 'Panel Principal',
                'nav.production': 'PRODUCCI√ìN',
                'nav.ordersData': 'Datos de √ìrdenes',
                'nav.ordersQueue': 'Por Fabricar',
                'nav.ordersStaged': 'Listo para Enviar',
                'nav.ordersShipped': 'Enviados',
                'nav.inventory': 'Inventario',
                'nav.salesFinance': 'VENTAS Y FINANZAS',
                'nav.plOverview': 'Resumen P/L',
                'nav.byPart': 'Por N√∫mero de Parte',
                'nav.byCustomer': 'Por Cliente',
                'nav.byDate': 'Por Fecha',
                'nav.billOfMaterials': 'LISTA DE MATERIALES',
                'nav.bomExplorer': 'Explorador BOM',
                'loading': 'Cargando datos de Google Sheets...',
                'main.title': 'Panel de Operaciones',
                'main.subtitle': 'Vista en tiempo real de las operaciones de manufactura',
                'stats.needToMake': 'Por Fabricar',
                'stats.making': 'Fabricando',
                'stats.readyToShip': 'Listo para Enviar',
                'stats.urgent': 'Urgente',
                'stats.totalUnits': 'Unidades Totales',
                'stats.monthRevenue': 'Ingresos del Mes',
                'stats.monthPL': 'P/L del Mes',
                'stats.missingParts': 'Partes Faltantes',
                'status.needToMake': 'Por Fabricar',
                'status.making': 'Fabricando',
                'status.readyToShip': 'Listo para Enviar',
                'status.shipped': 'Enviado',
                'status.urgent': 'URGENTE',
                'dept.production': 'Planificaci√≥n de Producci√≥n',
                'dept.productionDesc': 'Ver √≥rdenes a fabricar y estado de componentes',
                'dept.needToMake': 'Por Fabricar',
                'dept.units': 'Unidades',
                'dept.sales': 'Ventas y An√°lisis P/L',
                'dept.salesDesc': 'Ingresos, rentabilidad y an√°lisis de clientes',
                'dept.revenue': 'Ingresos',
                'dept.profit': 'Ganancia',
                'dept.orders': 'Pedidos',
                'dept.inventory': 'Gesti√≥n de Inventario',
                'dept.inventoryDesc': 'Niveles de stock y seguimiento de materiales',
                'chart.ordersByStatus': '√ìrdenes por Estado',
                'chart.upcomingDeadlines': 'Pr√≥ximos Vencimientos (14 D√≠as)',
                'ordersData.title': 'Todos los Datos de √ìrdenes',
                'ordersData.subtitle': 'Base de datos completa de √≥rdenes',
                'ordersQueue.title': 'Cola de √ìrdenes - Por Fabricar',
                'ordersQueue.subtitle': '√ìrdenes pendientes de producci√≥n',
                'ordersStaged.title': '√ìrdenes en Staging - Listas para Enviar',
                'ordersShipped.title': 'Historial de √ìrdenes Enviadas',
                'prod.missingMsg': '√≥rdenes tienen componentes faltantes.',
                'btn.backToDashboard': 'Volver',
                'col.line': 'L√≠nea',
                'col.priority': 'Prioridad',
                'col.daysUntil': 'D√≠as Restantes',
                'col.requestDate': 'Fecha de Solicitud',
                'col.customer': 'Cliente',
                'col.ifNum': 'IF #',
                'col.part': 'Parte #',
                'col.qty': 'Cant',
                'col.packaging': 'Empaque',
                'col.tire': 'Llanta',
                'col.hub': 'Hub',
                'col.hubMold': 'Molde del Hub',
                'col.bearings': 'Baleros',
                'col.status': 'Estado',
                'col.assigned': 'Asignado a',
                'col.shippedDate': 'Fecha de Env√≠o',
                'col.revenue': 'Ingresos',
                'col.pl': 'P/L',
                'missing': 'Faltante',
                'sales.title': 'Resumen P/L',
                'inv.title': 'Gesti√≥n de Inventario',
                'bom.title': 'Explorador BOM'
            }
        };
        
        let currentLang = 'en';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langES').classList.toggle('active', lang === 'es');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.getElementById('logoSubtitle').textContent = translations[lang]['logoSubtitle'];
            // Re-render current page
            if (currentPage.startsWith('orders-')) {
                if (currentPage === 'orders-data') updateOrdersDataPage();
                else if (currentPage === 'orders-queue') updateOrdersQueuePage();
                else if (currentPage === 'orders-staged') updateOrdersStagedPage();
                else if (currentPage === 'orders-shipped') updateOrdersShippedPage();
            } else if (currentPage === 'inventory') updateInventoryPage();
            else if (currentPage === 'main') updateMainDashboard();
        }
        
        function t(key) { return translations[currentLang][key] || key; }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const MAIN_DATA_GID = '290032634';
        const FUSION_EXPORT_GID = '1805754553';
        const PROD_DATA_TOTALS_GID = '148810546';
        const CONFIG_GID = '912029812';
        
        const COL = {
            CATEGORY: 'Category',
            REQUEST_DATE: 'Date of Request',
            PRIORITY: 'Priority Level',
            URGENT: 'Urgent Override',
            LINE: 'Line',
            CUSTOMER: 'Customer',
            IF_NUM: 'IF #',
            PART: 'Part #',
            QTY: 'Order Qty',
            PACKAGING: 'Packaging (tipo de empaquetado)',
            TIRE: 'Tire',
            HUB: 'Hub',
            HUB_MOLD: 'Hub Mold',
            BEARINGS: 'Bearings',
            ASSIGNED: 'Assigned to',
            STATUS: 'Work order Internal Status',
            DAYS_UNTIL: 'Days until promise date',
            SHIPPED_DATE: 'Shipped Date',
            REQUESTED_DATE: 'Requested Completion Date',
            REVENUE: 'Revenue',
            PL: 'P/L',
            PL_TOTAL: 'P/L total',
            VARIABLE_COST: 'Variable Cost',
            TOTAL_COST: 'Total Cost'
        };
        
        const COL_ALTS = {
            CATEGORY: ['Category', 'Categoria'],
            REQUEST_DATE: ['Date of Request', 'Fecha de Entrega', 'Requested Completion Date'],
            PRIORITY: ['Priority Level', 'Prioridad', 'Priority'],
            LINE: ['Line', 'Linea'],
            CUSTOMER: ['Customer', 'Cliente'],
            PART: ['Part #', 'Numero de parte', 'RT Part #', 'Part Number'],
            QTY: ['Order Qty', 'Cantidad de la orden', 'Qty', 'Quantity'],
            PACKAGING: ['Packaging (tipo de empaquetado)', 'tipo de empaquetado', 'Packaging'],
            TIRE: ['Tire', 'Tire (Llanta)', 'Llanta'],
            HUB: ['Hub', 'Centro', 'Cubo'],
            HUB_MOLD: ['Hub Mold', 'Hub Mold (Molde del Hub)', 'Molde del Hub'],
            BEARINGS: ['Bearings', 'Bearings (Balero)', 'Balero', 'Baleros'],
            ASSIGNED: ['Assigned to', 'Assigned to: (Asignado a:)', 'Asignado a'],
            STATUS: ['Work order Internal Status', 'Work order Status', 'Status', 'Estado'],
            DAYS_UNTIL: ['Days until promise date', 'Dias faltantes', 'Days until', 'Days remaining'],
            IF_NUM: ['IF #', 'IF#', 'IF Number'],
            PL: ['P/L', 'P/L total', 'PL', 'Profit/Loss'],
            REVENUE: ['Revenue', 'Total Sell Price', 'Sales']
        };
        
        function getVal(row, key) {
            const normalize = s => s.toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (row[COL[key]] !== undefined && row[COL[key]] !== null) return row[COL[key]];
            const alts = COL_ALTS[key];
            if (alts) {
                for (const alt of alts) {
                    if (row[alt] !== undefined && row[alt] !== null) return row[alt];
                }
            }
            const targetNames = alts ? [COL[key], ...alts] : [COL[key]];
            for (const target of targetNames) {
                if (!target) continue;
                const targetNorm = normalize(target);
                for (const k of Object.keys(row)) {
                    if (normalize(k) === targetNorm) return row[k];
                }
            }
            return null;
        }
        
        // State
        let allData = [];
        let inventoryData = [];
        let bomFinalData = [], bomSubData = [], bomIndividualData = [];
        let currentBomTab = 'final';
        let config = {};
        let charts = {};
        let currentPage = 'main';
        
        // Filter states for each page
        let ordersDataFilters = { categories: { rolltech: true, molding: false }, statuses: { pending: true, wip: true, staged: true, shipped: false } };
        let ordersQueueFilters = { categories: { rolltech: true, molding: false } };
        let ordersStagedFilters = { categories: { rolltech: true, molding: false } };
        let ordersShippedFilters = { categories: { rolltech: true, molding: false }, fromDate: null, toDate: null };
        let salesFilters = { categories: { rolltech: true, molding: false } };
        let datesFilters = { categories: { rolltech: true, molding: false }, fromDate: null, toDate: null };
        
        // Sort states
        let ordersDataSort = { field: 'daysUntil', asc: true };
        let ordersQueueSort = { field: 'daysUntil', asc: true };
        let ordersStagedSort = { field: 'customer', asc: true };
        let ordersShippedSort = { field: 'shippedDate', asc: false };
        let invFilter = 'all';
        let invSort = { field: 'partNumber', asc: true };

        // ============================================================
        // UTILITIES
        // ============================================================
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,%\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); return parseFloat(c) || 0; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const isEmpty = v => v === null || v === undefined || v === '';
        const isMissingComponent = v => v === null || v === undefined || v === '' || v === '-';
        const hasMissingCostData = row => isEmpty(row[COL.VARIABLE_COST]) || isEmpty(row[COL.TOTAL_COST]) || (isEmpty(row[COL.PL]) && isEmpty(row[COL.PL_TOTAL]));
        const getPLValue = row => { if (!isEmpty(row[COL.PL])) return parseNumber(row[COL.PL]); if (!isEmpty(row[COL.PL_TOTAL])) return parseNumber(row[COL.PL_TOTAL]); return 0; };
        
        const getCategory = row => {
            const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            return 'other';
        };
        
        // UPDATED: Maps both "Pending" AND "Approved" to 'pending' (Need to Make)
        const getStatus = row => {
            const status = (getVal(row, 'STATUS') || '').toLowerCase();
            if (status.includes('pending') || status.includes('approved')) return 'pending';
            if (status.includes('staged')) return 'staged';
            if (status.includes('work in progress') || status.includes('wip')) return 'wip';
            if (status.includes('shipped')) return 'shipped';
            return status;
        };
        
        // UPDATED: Uses translated labels
        const getStatusBadge = status => {
            const s = (status || '').toLowerCase();
            if (s.includes('shipped') || s === 'shipped') return `<span class="badge shipped">${t('status.shipped')}</span>`;
            if (s.includes('pending') || s.includes('approved') || s === 'pending') return `<span class="badge pending">${t('status.needToMake')}</span>`;
            if (s.includes('staged') || s === 'staged') return `<span class="badge staged">${t('status.readyToShip')}</span>`;
            if (s.includes('work in progress') || s.includes('wip') || s === 'wip') return `<span class="badge wip">${t('status.making')}</span>`;
            return `<span class="badge">${status || '-'}</span>`;
        };
        
        // UPDATED: Uses translated "URGENT" label
        const getPriorityBadge = (priority, urgent) => {
            const p = parseNumber(priority);
            const isUrgent = (urgent || '').toLowerCase() === 'urgent';
            if (isUrgent) return `<span class="badge urgent">${t('status.urgent')}</span>`;
            if (p === 1) return '<span class="badge priority-1">P1</span>';
            if (p === 2) return '<span class="badge priority-2">P2</span>';
            if (p === 3) return '<span class="badge priority-3">P3</span>';
            if (p === 4) return '<span class="badge priority-4">P4</span>';
            return `<span class="badge">P${p || '-'}</span>`;
        };
        
        const formatComponent = (value) => {
            if (isMissingComponent(value)) return `<span class="cell-missing">${t('missing')}</span>`;
            if (value === 'NA' || value === 'N/A') return `<span style="color:var(--text-secondary);">NA</span>`;
            return `<span class="cell-available">${value}</span>`;
        };

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function fetchSheetData(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const headers = json.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
            return json.table.rows.map(r => {
                const obj = {};
                headers.forEach((h, i) => { if (h && r.c && r.c[i]) obj[h] = r.c[i].f || r.c[i].v; });
                return obj;
            });
        }
        
        async function loadDashboard() {
            try {
                const raw = await fetchSheetData(MAIN_DATA_GID);
                allData = raw.filter(r => {
                    const cat = getCategory(r);
                    return (cat === 'rolltech' || cat === 'molding') && getVal(r, 'PART');
                });
                if (allData.length === 0) allData = raw.filter(r => getVal(r, 'PART'));
                
                loadInventoryData().catch(e => console.warn('Inventory load failed:', e));
                loadBOMData().catch(e => console.warn('BOM load failed:', e));
                
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${allData.length} orders<br>${now.toLocaleTimeString()}`;
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('main').classList.add('active');
                updateMainDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">‚ö†Ô∏è Error</h3><p>${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }
        
        async function loadInventoryData() {
            try {
                const fusionData = await fetchSheetData(FUSION_EXPORT_GID);
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                const prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum) {
                        prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            qtyNeeded: parseNumber(row['Quantity Needed']),
                            minimums: parseNumber(row['Minimums']),
                            manualTarget: parseNumber(row['Manual target']),
                            moldType: row['Mold type'] || '',
                            fusionInventory: parseNumber(row['Fusion Inventory']),
                            partsToBeMade: parseNumber(row['Parts to be made'])
                        };
                    }
                });
                const mergedData = [];
                const seenParts = new Set();
                fusionData.forEach(row => {
                    let partNum = (row['itemNumber'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (!partNum) return;
                    seenParts.add(partNum);
                    const prodData = prodTotalsMap[partNum] || {};
                    const fusionTarget = parseNumber(row['Target']);
                    mergedData.push({
                        partNumber: partNum,
                        product: prodData.product || '',
                        fusionQty: parseNumber(row['Real number value']),
                        minimum: prodData.minimums || fusionTarget || 0,
                        manualTarget: prodData.manualTarget || 0,
                        qtyNeeded: prodData.qtyNeeded || 0,
                        partsToBeMade: prodData.partsToBeMade || 0,
                        moldType: prodData.moldType || ''
                    });
                });
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum && !seenParts.has(partNum)) {
                        const data = prodTotalsMap[partNum];
                        mergedData.push({
                            partNumber: partNum,
                            product: data.product || '',
                            fusionQty: data.fusionInventory || 0,
                            minimum: data.minimums || 0,
                            manualTarget: data.manualTarget || 0,
                            qtyNeeded: data.qtyNeeded || 0,
                            partsToBeMade: data.partsToBeMade || 0,
                            moldType: data.moldType || ''
                        });
                    }
                });
                inventoryData = mergedData;
            } catch (e) { console.error('Inventory load error:', e); inventoryData = []; }
        }
        
        async function loadBOMData() {
            try {
                const configData = await fetchSheetData(CONFIG_GID);
                config = {};
                configData.forEach(row => {
                    if (row['Dashboard Name'] === 'P&L Dashboard' && row['GID Number']) {
                        config[row['Tab Name']] = { gid: row['GID Number'] };
                    }
                });
                if (config['BOM individual items Reference data']) bomIndividualData = await fetchSheetData(config['BOM individual items Reference data'].gid);
                if (config['BOM Sub assembly Reference data']) bomSubData = await fetchSheetData(config['BOM Sub assembly Reference data'].gid);
                if (config['BOM Final assembly Reference data']) bomFinalData = await fetchSheetData(config['BOM Final assembly Reference data'].gid);
            } catch (e) { console.warn('BOM load error:', e); }
        }

        // ============================================================
        // NAVIGATION
        // ============================================================
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            currentPage = page;
            switch(page) {
                case 'main': updateMainDashboard(); break;
                case 'orders-data': updateOrdersDataPage(); break;
                case 'orders-queue': updateOrdersQueuePage(); break;
                case 'orders-staged': updateOrdersStagedPage(); break;
                case 'orders-shipped': updateOrdersShippedPage(); break;
                case 'inventory': updateInventoryPage(); break;
                case 'sales-overview': updateSalesOverview(); break;
                case 'sales-parts': updateSalesPartsPage(); break;
                case 'sales-customers': updateSalesCustomersPage(); break;
                case 'sales-dates': updateSalesDatesPage(); break;
                case 'bom': initBomExplorer(); break;
            }
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }
        
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // ============================================================
        // MAIN DASHBOARD
        // ============================================================
        function updateMainDashboard() {
            const rollTechData = allData.filter(r => getCategory(r) === 'rolltech');
            const needToMakeOrders = rollTechData.filter(r => getStatus(r) === 'pending');
            const urgentOrders = needToMakeOrders.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent');
            const totalQty = needToMakeOrders.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthData = rollTechData.filter(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return false;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                return month === currentMonth;
            });
            const monthRevenue = monthData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const monthPL = monthData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            const missingComponents = needToMakeOrders.filter(r => {
                return isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
            }).length;
            
            document.getElementById('qsNeedToMake').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('qsUrgentOrders').textContent = formatNumber(urgentOrders.length);
            document.getElementById('qsUrgentOrders').className = `value ${urgentOrders.length > 0 ? 'negative' : ''}`;
            document.getElementById('qsTotalQty').textContent = formatNumber(totalQty);
            document.getElementById('qsMonthlyRevenue').textContent = formatCurrency(monthRevenue);
            document.getElementById('qsMonthlyPL').textContent = formatCurrency(monthPL);
            document.getElementById('qsMonthlyPL').className = `value ${monthPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('qsMissingComponents').textContent = formatNumber(missingComponents);
            
            document.getElementById('deptProdOrders').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('deptProdUnits').textContent = formatNumber(totalQty);
            document.getElementById('deptProdUrgent').textContent = formatNumber(urgentOrders.length);
            
            const salesTotal = rollTechData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const salesPL = rollTechData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            document.getElementById('deptSalesRev').textContent = formatCurrency(salesTotal);
            document.getElementById('deptSalesPL').textContent = formatCurrency(salesPL);
            document.getElementById('deptSalesPL').className = `value ${salesPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('deptSalesOrders').textContent = formatNumber(rollTechData.length);
            
            renderMainStatusChart(rollTechData.filter(r => getStatus(r) !== 'shipped'));
            renderMainDeadlineChart(needToMakeOrders);
        }
        
        function renderMainStatusChart(data) {
            const statusCounts = { pending: 0, wip: 0, staged: 0 };
            data.forEach(r => { const s = getStatus(r); if (statusCounts[s] !== undefined) statusCounts[s]++; });
            const labels = [t('status.needToMake'), t('status.making'), t('status.readyToShip')];
            const values = [statusCounts.pending, statusCounts.wip, statusCounts.staged];
            const colors = ['#d69e2e', '#319795', '#4299e1'];
            if (charts.mainStatus) charts.mainStatus.destroy();
            charts.mainStatus = new Chart(document.getElementById('mainStatusChart'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 11 } } } } }
            });
        }
        
        function renderMainDeadlineChart(data) {
            const deadlines = {};
            for (let i = -7; i <= 14; i++) deadlines[i] = 0;
            data.forEach(r => { const days = parseNumber(getVal(r, 'DAYS_UNTIL')); if (days >= -7 && days <= 14) deadlines[days]++; });
            const labels = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return `${Math.abs(n)}d late`; if (n === 0) return 'Today'; return `${n}d`; });
            const values = Object.values(deadlines);
            const colors = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return 'rgba(229,62,62,0.8)'; if (n <= 2) return 'rgba(214,158,46,0.8)'; return 'rgba(49,130,206,0.8)'; });
            if (charts.mainDeadline) charts.mainDeadline.destroy();
            charts.mainDeadline = new Chart(document.getElementById('mainDeadlineChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // ============================================================
        // ORDERS DATA PAGE (All orders with status filters)
        // ============================================================
        function toggleOrdersDataCategory(cat) {
            ordersDataFilters.categories[cat] = !ordersDataFilters.categories[cat];
            if (!ordersDataFilters.categories.rolltech && !ordersDataFilters.categories.molding) { ordersDataFilters.categories[cat] = true; return; }
            document.getElementById('ordersDataBtnRollTech').classList.toggle('active', ordersDataFilters.categories.rolltech);
            document.getElementById('ordersDataBtnMolding').classList.toggle('active', ordersDataFilters.categories.molding);
            updateOrdersDataPage();
        }
        
        function toggleOrdersDataStatus(status) {
            ordersDataFilters.statuses[status] = !ordersDataFilters.statuses[status];
            document.getElementById(`ordersDataStatus${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.toggle('active', ordersDataFilters.statuses[status]);
            updateOrdersDataPage();
        }
        
        function updateOrdersDataPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersDataFilters.categories[cat]) return false;
                if (!ordersDataFilters.statuses[status]) return false;
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const needToMake = data.filter(r => getStatus(r) === 'pending').length;
            const making = data.filter(r => getStatus(r) === 'wip').length;
            const readyToShip = data.filter(r => getStatus(r) === 'staged').length;
            
            document.getElementById('ordersDataTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersDataTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersDataNeedToMake').textContent = formatNumber(needToMake);
            document.getElementById('ordersDataMaking').textContent = formatNumber(making);
            document.getElementById('ordersDataReadyToShip').textContent = formatNumber(readyToShip);
            document.getElementById('ordersDataLastUpdated').textContent = new Date().toLocaleTimeString();
            
            renderOrdersDataTableHeader();
            renderOrdersDataTable(data);
        }
        
        function renderOrdersDataTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'tire', label: t('col.tire') }, { key: 'hub', label: t('col.hub') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'status', label: t('col.status') }
            ];
            document.getElementById('ordersDataTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersDataTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersDataTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersDataTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersDataTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isMissing = isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
                return `<tr style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>
                    <td class="${daysClass}">${daysUntil || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td>${formatComponent(getVal(r, 'TIRE'))}</td>
                    <td>${formatComponent(getVal(r, 'HUB'))}</td>
                    <td>${formatComponent(getVal(r, 'BEARINGS'))}</td>
                    <td>${getStatusBadge(getStatus(r))}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersDataTable(field) {
            if (ordersDataSort.field === field) ordersDataSort.asc = !ordersDataSort.asc;
            else { ordersDataSort.field = field; ordersDataSort.asc = true; }
            updateOrdersDataPage();
        }
        
        function filterOrdersDataTable() { updateOrdersDataPage(); }
        
        function exportOrdersDataToCSV() {
            const data = allData.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            const headers = ['Line','Priority','Days Until','Customer','Part','Qty','Tire','Hub','Bearings','Status'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'BEARINGS'),getStatus(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_data.csv');
        }

        // ============================================================
        // ORDERS QUEUE PAGE (Need to Make = Pending + Approved)
        // ============================================================
        function toggleOrdersQueueCategory(cat) {
            ordersQueueFilters.categories[cat] = !ordersQueueFilters.categories[cat];
            if (!ordersQueueFilters.categories.rolltech && !ordersQueueFilters.categories.molding) { ordersQueueFilters.categories[cat] = true; return; }
            document.getElementById('ordersQueueBtnRollTech').classList.toggle('active', ordersQueueFilters.categories.rolltech);
            document.getElementById('ordersQueueBtnMolding').classList.toggle('active', ordersQueueFilters.categories.molding);
            updateOrdersQueuePage();
        }
        
        function updateOrdersQueuePage() {
            // Queue = only "pending" status (which includes both Pending and Approved from spreadsheet)
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersQueueFilters.categories[cat] && status === 'pending';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const urgentCount = data.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent').length;
            const dueWeek = data.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; });
            const dueWeekQty = dueWeek.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const componentsReady = data.filter(r => !isMissingComponent(getVal(r,'TIRE')) && !isMissingComponent(getVal(r,'HUB')) && !isMissingComponent(getVal(r,'BEARINGS'))).length;
            const missingOrders = data.filter(r => isMissingComponent(getVal(r,'TIRE')) || isMissingComponent(getVal(r,'HUB')) || isMissingComponent(getVal(r,'BEARINGS')));
            
            document.getElementById('ordersQueueTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersQueueTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersQueueUrgentCount').textContent = formatNumber(urgentCount);
            document.getElementById('ordersQueueDueWeek').textContent = formatNumber(dueWeek.length);
            document.getElementById('ordersQueueDueWeekUnits').textContent = `${formatNumber(dueWeekQty)} units`;
            document.getElementById('ordersQueueComponentsReady').textContent = formatNumber(componentsReady);
            document.getElementById('ordersQueueLastUpdated').textContent = new Date().toLocaleTimeString();
            
            if (missingOrders.length > 0) {
                document.getElementById('ordersQueueMissingCount').textContent = missingOrders.length;
                document.getElementById('ordersQueueMissingBanner').classList.add('active');
            } else {
                document.getElementById('ordersQueueMissingBanner').classList.remove('active');
            }
            
            renderOrdersQueueTableHeader();
            renderOrdersQueueTable(data);
        }
        
        function renderOrdersQueueTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'requestDate', label: t('col.requestDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'ifNum', label: t('col.ifNum') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }, { key: 'tire', label: t('col.tire') },
                { key: 'hub', label: t('col.hub') }, { key: 'hubMold', label: t('col.hubMold') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'assigned', label: t('col.assigned') }
            ];
            document.getElementById('ordersQueueTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersQueueTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersQueueTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersQueueSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'requestDate': va = parseDate(getVal(a, 'REQUEST_DATE')) || new Date(0); vb = parseDate(getVal(b, 'REQUEST_DATE')) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    default: va = getVal(a, ordersQueueSort.field) || ''; vb = getVal(b, ordersQueueSort.field) || '';
                }
                if (typeof va === 'string') return ordersQueueSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersQueueSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersQueueSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'LINE') || '').toString().includes(search));
            }
            
            document.getElementById('ordersQueueTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersQueueTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isMissing = isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
                return `<tr style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>
                    <td class="${daysClass}">${daysUntil || '-'}</td>
                    <td>${getVal(r, 'REQUEST_DATE') || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td>${getVal(r, 'IF_NUM') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td>${getVal(r, 'PACKAGING') || '-'}</td>
                    <td>${formatComponent(getVal(r, 'TIRE'))}</td>
                    <td>${formatComponent(getVal(r, 'HUB'))}</td>
                    <td>${getVal(r, 'HUB_MOLD') || '-'}</td>
                    <td>${formatComponent(getVal(r, 'BEARINGS'))}</td>
                    <td>${getVal(r, 'ASSIGNED') || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersQueueTable(field) {
            if (ordersQueueSort.field === field) ordersQueueSort.asc = !ordersQueueSort.asc;
            else { ordersQueueSort.field = field; ordersQueueSort.asc = true; }
            updateOrdersQueuePage();
        }
        
        function filterOrdersQueueTable() { updateOrdersQueuePage(); }
        
        function exportOrdersQueueToCSV() {
            const data = allData.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            const headers = ['Line','Priority','Days Until','Request Date','Customer','IF#','Part','Qty','Packaging','Tire','Hub','Hub Mold','Bearings','Assigned'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'REQUEST_DATE'),getVal(r,'CUSTOMER'),getVal(r,'IF_NUM'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'HUB_MOLD'),getVal(r,'BEARINGS'),getVal(r,'ASSIGNED')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_queue.csv');
        }

        // ============================================================
        // ORDERS STAGED PAGE (Ready to Ship)
        // ============================================================
        function toggleOrdersStagedCategory(cat) {
            ordersStagedFilters.categories[cat] = !ordersStagedFilters.categories[cat];
            if (!ordersStagedFilters.categories.rolltech && !ordersStagedFilters.categories.molding) { ordersStagedFilters.categories[cat] = true; return; }
            document.getElementById('ordersStagedBtnRollTech').classList.toggle('active', ordersStagedFilters.categories.rolltech);
            document.getElementById('ordersStagedBtnMolding').classList.toggle('active', ordersStagedFilters.categories.molding);
            updateOrdersStagedPage();
        }
        
        function updateOrdersStagedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersStagedFilters.categories[cat] && status === 'staged';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const avgValue = data.length > 0 ? totalRevenue / data.length : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersStagedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersStagedTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersStagedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersStagedAvgValue').textContent = formatCurrency(avgValue);
            document.getElementById('ordersStagedCustomers').textContent = formatNumber(customers);
            
            renderOrdersStagedTableHeader();
            renderOrdersStagedTable(data);
        }
        
        function renderOrdersStagedTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }, { key: 'revenue', label: t('col.revenue') },
                { key: 'requestDate', label: t('col.requestDate') }, { key: 'assigned', label: t('col.assigned') }
            ];
            document.getElementById('ordersStagedTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersStagedTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersStagedTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersStagedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    default: va = getVal(a, ordersStagedSort.field) || ''; vb = getVal(b, ordersStagedSort.field) || '';
                }
                if (typeof va === 'string') return ordersStagedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersStagedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersStagedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersStagedTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersStagedTableBody');
            tbody.innerHTML = sorted.map(r => `<tr>
                <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                <td>${getVal(r, 'PACKAGING') || '-'}</td>
                <td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>
                <td>${getVal(r, 'REQUEST_DATE') || '-'}</td>
                <td>${getVal(r, 'ASSIGNED') || '-'}</td>
            </tr>`).join('');
        }
        
        function sortOrdersStagedTable(field) {
            if (ordersStagedSort.field === field) ordersStagedSort.asc = !ordersStagedSort.asc;
            else { ordersStagedSort.field = field; ordersStagedSort.asc = true; }
            updateOrdersStagedPage();
        }
        
        function filterOrdersStagedTable() { updateOrdersStagedPage(); }
        
        function exportOrdersStagedToCSV() {
            const data = allData.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            const headers = ['Line','Customer','Part','Qty','Packaging','Revenue','Request Date','Assigned'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),r[COL.REVENUE],getVal(r,'REQUEST_DATE'),getVal(r,'ASSIGNED')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_staged.csv');
        }

        // ============================================================
        // ORDERS SHIPPED PAGE (History with date filter)
        // ============================================================
        function toggleOrdersShippedCategory(cat) {
            ordersShippedFilters.categories[cat] = !ordersShippedFilters.categories[cat];
            if (!ordersShippedFilters.categories.rolltech && !ordersShippedFilters.categories.molding) { ordersShippedFilters.categories[cat] = true; return; }
            document.getElementById('ordersShippedBtnRollTech').classList.toggle('active', ordersShippedFilters.categories.rolltech);
            document.getElementById('ordersShippedBtnMolding').classList.toggle('active', ordersShippedFilters.categories.molding);
            updateOrdersShippedPage();
        }
        
        function applyShippedDateFilter() {
            const fromInput = document.getElementById('ordersShippedFromDate').value;
            const toInput = document.getElementById('ordersShippedToDate').value;
            ordersShippedFilters.fromDate = fromInput ? new Date(fromInput) : null;
            ordersShippedFilters.toDate = toInput ? new Date(toInput) : null;
            updateOrdersShippedPage();
        }
        
        function resetShippedDateFilter() {
            document.getElementById('ordersShippedFromDate').value = '';
            document.getElementById('ordersShippedToDate').value = '';
            ordersShippedFilters.fromDate = null;
            ordersShippedFilters.toDate = null;
            updateOrdersShippedPage();
        }
        
        function updateOrdersShippedPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersShippedFilters.categories[cat] || status !== 'shipped') return false;
                
                if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                    const dateStr = r[COL.SHIPPED_DATE];
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (ordersShippedFilters.fromDate && rowDate < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && rowDate > ordersShippedFilters.toDate) return false;
                }
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100).toFixed(1) : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersShippedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersShippedTotalUnits').textContent = `${formatNumber(totalQty)} units`;
            document.getElementById('ordersShippedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersShippedPL').textContent = formatCurrency(totalPL);
            document.getElementById('ordersShippedPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('ordersShippedMargin').textContent = `Margin: ${margin}%`;
            document.getElementById('ordersShippedCustomers').textContent = formatNumber(customers);
            
            renderOrdersShippedTableHeader();
            renderOrdersShippedTable(data);
        }
        
        function renderOrdersShippedTableHeader() {
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'shippedDate', label: t('col.shippedDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'part', label: t('col.part') },
                { key: 'qty', label: t('col.qty') }, { key: 'revenue', label: t('col.revenue') },
                { key: 'pl', label: t('col.pl') }
            ];
            document.getElementById('ordersShippedTableHeader').innerHTML = headers.map(h => `<th onclick="sortOrdersShippedTable('${h.key}')">${h.label} <span class="sort-indicator">‚Üï</span></th>`).join('');
        }
        
        function renderOrdersShippedTable(data) {
            let sorted = [...data].sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersShippedTableCount').textContent = `${sorted.length} orders`;
            const tbody = document.getElementById('ordersShippedTableBody');
            tbody.innerHTML = sorted.map(r => {
                const pl = getPLValue(r);
                return `<tr>
                    <td><strong>${getVal(r, 'LINE') || '-'}</strong></td>
                    <td>${r[COL.SHIPPED_DATE] || '-'}</td>
                    <td>${getVal(r, 'CUSTOMER') || '-'}</td>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>
                    <td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortOrdersShippedTable(field) {
            if (ordersShippedSort.field === field) ordersShippedSort.asc = !ordersShippedSort.asc;
            else { ordersShippedSort.field = field; ordersShippedSort.asc = true; }
            updateOrdersShippedPage();
        }
        
        function filterOrdersShippedTable() { updateOrdersShippedPage(); }
        
        function exportOrdersShippedToCSV() {
            const data = allData.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            const headers = ['Line','Shipped Date','Customer','Part','Qty','Revenue','P/L'];
            const rows = data.map(r => [getVal(r,'LINE'),r[COL.SHIPPED_DATE],getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_shipped.csv');
        }

        // ============================================================
        // UTILITY FUNCTION
        // ============================================================
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ============================================================
        // INVENTORY PAGE
        // ============================================================
        function setInvFilter(filter) {
            invFilter = filter;
            document.getElementById('invFilterAll').classList.toggle('active', filter === 'all');
            document.getElementById('invFilterLow').classList.toggle('active', filter === 'low');
            document.getElementById('invFilterNeeded').classList.toggle('active', filter === 'needed');
            renderInvTable();
        }
        
        function updateInventoryPage() {
            const lowStock = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            const needsProduction = inventoryData.filter(i => i.partsToBeMade > 0);
            const okStock = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
            const productTypes = [...new Set(inventoryData.map(i => i.product).filter(p => p))];
            
            document.getElementById('invStatTotal').textContent = formatNumber(inventoryData.length);
            document.getElementById('invStatTypes').textContent = `${productTypes.length} product types`;
            document.getElementById('invStatLow').textContent = formatNumber(lowStock.length);
            document.getElementById('invStatNeeded').textContent = formatNumber(needsProduction.length);
            document.getElementById('invStatOk').textContent = formatNumber(okStock.length);
            
            setInvFilter('all');
        }
        
        function sortInvTable(field) {
            if (invSort.field === field) invSort.asc = !invSort.asc;
            else { invSort.field = field; invSort.asc = true; }
            renderInvTable();
        }
        
        function renderInvTable() {
            let data = [...inventoryData];
            const searchTerm = (document.getElementById('invSearch')?.value || '').toLowerCase();
            
            if (invFilter === 'low') data = data.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            else if (invFilter === 'needed') data = data.filter(i => i.partsToBeMade > 0);
            
            if (searchTerm) {
                data = data.filter(i => (i.partNumber || '').toLowerCase().includes(searchTerm) || (i.product || '').toLowerCase().includes(searchTerm) || (i.moldType || '').toLowerCase().includes(searchTerm));
            }
            
            data.sort((a, b) => {
                let va = a[invSort.field], vb = b[invSort.field];
                if (typeof va === 'string') return invSort.asc ? (va || '').localeCompare(vb || '') : (vb || '').localeCompare(va || '');
                return invSort.asc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
            });
            
            document.getElementById('invTableCount').textContent = `${data.length} items`;
            const tbody = document.getElementById('invTableBody');
            tbody.innerHTML = data.map(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const rowClass = isLow ? 'inv-low' : (needsMake ? 'inv-warning' : '');
                const statusBadge = isLow ? '<span class="badge" style="background:var(--danger);color:white;">LOW</span>' : (needsMake ? '<span class="badge" style="background:var(--warning);color:#1a202c;">MAKE</span>' : '<span class="badge" style="background:var(--success);color:white;">OK</span>');
                return `<tr class="${rowClass}">
                    <td>${i.product || '-'}</td>
                    <td><strong>${i.partNumber}</strong></td>
                    <td>${formatNumber(i.fusionQty)}</td>
                    <td>${formatNumber(i.minimum)}</td>
                    <td>${formatNumber(i.manualTarget)}</td>
                    <td>${formatNumber(i.qtyNeeded)}</td>
                    <td class="${i.partsToBeMade > 0 ? 'negative' : ''}">${formatNumber(i.partsToBeMade)}</td>
                    <td>${i.moldType || '-'}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            }).join('');
        }
        
        function filterInvTable() { renderInvTable(); }
        
        function exportInvCSV() {
            const headers = ['Product Type','Part Number','Fusion Qty','Minimum','Manual Target','Qty Needed','Parts to Make','Mold Type'];
            const rows = inventoryData.map(i => [i.product, i.partNumber, i.fusionQty, i.minimum, i.manualTarget, i.qtyNeeded, i.partsToBeMade, i.moldType].map(v => `"${v || ''}"`).join(','));
            downloadCSV([headers.join(','), ...rows].join('\n'), `inventory_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SALES PAGES
        // ============================================================
        function toggleSalesCategory(cat) {
            salesFilters.categories[cat] = !salesFilters.categories[cat];
            if (!salesFilters.categories.rolltech && !salesFilters.categories.molding) { salesFilters.categories[cat] = true; return; }
            document.getElementById('salesBtnRollTech').classList.toggle('active', salesFilters.categories.rolltech);
            document.getElementById('salesBtnMolding').classList.toggle('active', salesFilters.categories.molding);
            updateSalesOverview();
        }
        
        function updateSalesOverview() {
            const data = allData.filter(r => salesFilters.categories[getCategory(r)]);
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            
            data.forEach(r => {
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    totalPL += pl;
                    if (getStatus(r) === 'shipped') { shippedPL += pl; shippedCount++; }
                    else { forecastPL += pl; forecastCount++; }
                } else {
                    if (getStatus(r) === 'shipped') shippedCount++; else forecastCount++;
                }
            });
            
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('salesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('salesStatOrderCount').textContent = `${data.length} orders`;
            document.getElementById('salesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('salesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatMargin').textContent = `Margin: ${margin}%`;
            document.getElementById('salesStatShippedPL').textContent = formatCurrency(shippedPL);
            document.getElementById('salesStatShippedPL').className = `value ${shippedPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatShippedCount').textContent = `${shippedCount} shipped`;
            document.getElementById('salesStatForecastPL').textContent = formatCurrency(forecastPL);
            document.getElementById('salesStatForecastPL').className = `value ${forecastPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatForecastCount').textContent = `${forecastCount} pending`;
            
            renderSalesTrendChart(data);
        }
        
        function renderSalesTrendChart(data) {
            const monthStats = {};
            data.forEach(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                if (!monthStats[month]) monthStats[month] = { shipped: 0, forecast: 0 };
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (getStatus(r) === 'shipped') monthStats[month].shipped += pl;
                    else monthStats[month].forecast += pl;
                }
            });
            
            const sorted = Object.entries(monthStats).sort((a, b) => a[0].localeCompare(b[0])).slice(-12);
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [
                        { label: 'Shipped', data: sorted.map(s => s[1].shipped), borderColor: '#38a169', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3 },
                        { label: 'Forecasted', data: sorted.map(s => s[1].forecast), borderColor: '#d69e2e', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0aec0' } } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0' }, grid: { display: false } } } }
            });
        }
        
        function exportSalesCSV() {
            const data = allData.filter(r => salesFilters.categories[getCategory(r)]);
            const csv = data.map(r => [getVal(r, 'PART'), getVal(r, 'CUSTOMER'), getVal(r, 'QTY'), r[COL.REVENUE], r[COL.PL]].join(',')).join('\n');
            downloadCSV('Part,Customer,Qty,Revenue,P/L\n' + csv, `sales_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function updateSalesPartsPage() {
            const data = allData.filter(r => salesFilters.categories[getCategory(r)]);
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { pl: 0 };
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(partStats).sort((a, b) => b[1].pl - a[1].pl).slice(0, 30);
            
            if (charts.partsBar) charts.partsBar.destroy();
            charts.partsBar = new Chart(document.getElementById('partsBarChart'), {
                type: 'bar',
                data: { labels: sorted.map(s => s[0]), datasets: [{ data: sorted.map(s => s[1].pl), backgroundColor: sorted.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)') }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 }, maxRotation: 90 }, grid: { display: false } } } }
            });
        }
        
        function updateSalesCustomersPage() {
            const data = allData.filter(r => salesFilters.categories[getCategory(r)]);
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { pl: 0 };
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(custStats).sort((a, b) => b[1].pl - a[1].pl).slice(0, 10);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#e53e3e', '#718096', '#4a5568'];
            
            if (charts.customers) charts.customers.destroy();
            charts.customers = new Chart(document.getElementById('customersChart'), {
                type: 'doughnut',
                data: { labels: sorted.map(s => s[0].substring(0, 25)), datasets: [{ data: sorted.map(s => Math.abs(s[1].pl)), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
        }

        // ============================================================
        // SALES BY DATE PAGE
        // ============================================================
        function toggleDatesCategory(cat) {
            datesFilters.categories[cat] = !datesFilters.categories[cat];
            if (!datesFilters.categories.rolltech && !datesFilters.categories.molding) { datesFilters.categories[cat] = true; return; }
            document.getElementById('datesBtnRollTech').classList.toggle('active', datesFilters.categories.rolltech);
            document.getElementById('datesBtnMolding').classList.toggle('active', datesFilters.categories.molding);
            updateSalesDatesPage();
        }
        
        function applyDateFilter() {
            const fromInput = document.getElementById('datesFromDate').value;
            const toInput = document.getElementById('datesToDate').value;
            datesFilters.fromDate = fromInput ? new Date(fromInput) : null;
            datesFilters.toDate = toInput ? new Date(toInput) : null;
            updateSalesDatesPage();
        }
        
        function resetDateFilter() {
            document.getElementById('datesFromDate').value = '';
            document.getElementById('datesToDate').value = '';
            datesFilters.fromDate = null;
            datesFilters.toDate = null;
            updateSalesDatesPage();
        }
        
        function updateSalesDatesPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                if (!datesFilters.categories[cat]) return false;
                if (datesFilters.fromDate || datesFilters.toDate) {
                    const status = getStatus(r);
                    const dateStr = status === 'shipped' ? r[COL.SHIPPED_DATE] : (r[COL.REQUESTED_DATE] || getVal(r, 'REQUEST_DATE'));
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (datesFilters.fromDate && rowDate < datesFilters.fromDate) return false;
                    if (datesFilters.toDate && rowDate > datesFilters.toDate) return false;
                }
                return true;
            });
            
            const monthStats = {};
            let totalOrders = 0, totalUnits = 0, totalRevenue = 0, totalPL = 0;
            
            data.forEach(r => {
                const status = getStatus(r);
                const dateStr = status === 'shipped' ? r[COL.SHIPPED_DATE] : (r[COL.REQUESTED_DATE] || getVal(r, 'REQUEST_DATE'));
                if (!dateStr) return;
                let month;
                if (dateStr.includes('/')) { const parts = dateStr.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = dateStr.substring(0, 7); }
                if (!monthStats[month]) monthStats[month] = { orders: 0, units: 0, revenue: 0, pl: 0 };
                monthStats[month].orders++;
                monthStats[month].units += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) monthStats[month].pl += getPLValue(r);
                totalOrders++;
                totalUnits += parseNumber(getVal(r, 'QTY'));
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) totalPL += getPLValue(r);
            });
            
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100) : 0;
            const monthCount = Object.keys(monthStats).length;
            
            document.getElementById('datesStatOrders').textContent = formatNumber(totalOrders);
            document.getElementById('datesStatUnits').textContent = `${formatNumber(totalUnits)} units`;
            document.getElementById('datesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('datesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('datesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMargin').textContent = `Margin: ${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').className = `value ${margin >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMonths').textContent = `${monthCount} months`;
            
            const sortedMonths = Object.entries(monthStats).sort((a, b) => a[0].localeCompare(b[0]));
            
            if (charts.datesBar) charts.datesBar.destroy();
            charts.datesBar = new Chart(document.getElementById('datesBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(s => { const [year, mon] = s[0].split('-'); const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return `${monthNames[parseInt(mon) - 1]} ${year}`; }),
                    datasets: [
                        { label: 'Revenue', data: sortedMonths.map(s => s[1].revenue), backgroundColor: 'rgba(49,130,206,0.7)', borderColor: '#3182ce', borderWidth: 1 },
                        { label: 'P/L', data: sortedMonths.map(s => s[1].pl), backgroundColor: sortedMonths.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.7)' : 'rgba(229,62,62,0.7)'), borderColor: sortedMonths.map(s => s[1].pl >= 0 ? '#38a169' : '#e53e3e'), borderWidth: 1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0aec0' } } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } } } }
            });
            
            document.getElementById('datesTableCount').textContent = `${sortedMonths.length} months`;
            const tbody = document.getElementById('datesTableBody');
            tbody.innerHTML = sortedMonths.reverse().map(([month, stats]) => {
                const [year, mon] = month.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = `${monthNames[parseInt(mon) - 1]} ${year}`;
                const rowMargin = stats.revenue > 0 ? ((stats.pl / stats.revenue) * 100).toFixed(1) : 0;
                return `<tr>
                    <td><strong>${monthName}</strong></td>
                    <td>${formatNumber(stats.orders)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${parseFloat(rowMargin) >= 0 ? 'positive' : 'negative'}">${rowMargin}%</td>
                </tr>`;
            }).join('');
        }
        
        function exportDatesCSV() {
            downloadCSV('Month,Orders,Revenue,P/L,Margin\nSample data...', `pl_by_date_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // BOM EXPLORER
        // ============================================================
        function initBomExplorer() { renderBomSelector(); }
        
        function filterBomSelector() {
            const filter = (document.getElementById('bomSearch').value || '').toLowerCase();
            renderBomSelector(filter);
        }
        
        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab));
            document.getElementById('bomSearch').value = '';
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }
        
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available. Check that no filters are active in the source sheet.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.length === 0 ? '<p style="color:var(--text-secondary);">No parts found.</p>' : filtered.map((d, i) => {
                const originalIndex = data.indexOf(d);
                return `<div class="bom-item" data-index="${originalIndex}" onclick="showBomDetails(${originalIndex})">${d[nameKey] || 'Unknown'}</div>`;
            }).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', parseInt(item.dataset.index) === index));
            
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search, exactMatch] of [['Mold','mold',false],['Weight','weight',false],['Labor/Part','labor cost/ part',false],['Overhead','overhead',false],['Total Cost','total cost',true]]) {
                    let key;
                    if (exactMatch) key = Object.keys(part).find(k => k.trim().toLowerCase() === search);
                    else key = Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`);
                    if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                const partsPkgKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('parts per package'));
                if (partsPkgKey && part[partsPkgKey]) content += `<div class="cost-item"><span class="label">Parts/Pkg</span><span class="value">${part[partsPkgKey]}</span></div>`;
                const laborKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('labor cost / finished') || k.trim().toLowerCase().includes('labor cost/ finished'));
                if (laborKey && part[laborKey]) content += `<div class="cost-item"><span class="label">Labor</span><span class="value">${formatCurrency(parseNumber(part[laborKey]))}</span></div>`;
                const varCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'variable cost');
                if (varCostKey && part[varCostKey]) content += `<div class="cost-item"><span class="label">Variable Cost</span><span class="value">${formatCurrency(parseNumber(part[varCostKey]))}</span></div>`;
                const totalCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'total cost');
                if (totalCostKey && part[totalCostKey]) content += `<div class="cost-item"><span class="label">Total Cost</span><span class="value">${formatCurrency(parseNumber(part[totalCostKey]))}</span></div>`;
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) {
                    content += `<div class="highlight-box">`;
                    if (profitKey && part[profitKey]) { const profitVal = parseNumber(part[profitKey]); const displayVal = profitVal < 1 ? (profitVal * 100).toFixed(0) + '%' : profitVal.toFixed(0) + '%'; content += `<div class="item"><div class="value">${displayVal}</div><div class="label">Profit Target</div></div>`; }
                    if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`;
                    content += `</div>`;
                }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`);
                    if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) {
                        content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                    }
                }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
