<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Molding Operations Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <style>
        /* DARK THEME (Default) */
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --staged-blue: #4299e1;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 180px;
            /* Theme-specific variables */
            --body-bg: linear-gradient(135deg, #1a202c 0%, #0d1421 100%);
            --sidebar-bg: linear-gradient(180deg, #1a365d 0%, #2c5282 100%);
            --card-bg: linear-gradient(135deg, #2d3748 0%, #374151 100%);
            --table-header-bg: #2d3748;
            --table-row-hover: rgba(49, 130, 206, 0.15);
            --table-row-alt: rgba(45, 55, 72, 0.5);
            --input-bg: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --logo-gradient: linear-gradient(135deg, #fff 0%, #a0aec0 100%);
            --stat-card-bg: linear-gradient(135deg, #2d3748 0%, #374151 100%);
            --dropdown-bg: #2d3748;
            --modal-bg: #2d3748;
            --scrollbar-thumb: #4a5568;
            --scrollbar-track: #2d3748;
        }
        
        /* LIGHT THEME */
        html.light-theme {
            --primary: #2b6cb0;
            --primary-light: #3182ce;
            --accent: #2b6cb0;
            --bg-dark: #f7fafc;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --body-bg: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            --sidebar-bg: linear-gradient(180deg, #2b6cb0 0%, #3182ce 100%);
            --card-bg: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            --table-header-bg: #edf2f7;
            --table-row-hover: rgba(49, 130, 206, 0.1);
            --table-row-alt: rgba(237, 242, 247, 0.7);
            --input-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --logo-gradient: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
            --stat-card-bg: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            --dropdown-bg: #ffffff;
            --modal-bg: #ffffff;
            --scrollbar-thumb: #cbd5e0;
            --scrollbar-track: #edf2f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--body-bg);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 17px;
            overflow-x: hidden;
        }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: var(--sidebar-bg);
            padding: 14px 8px; overflow-y: auto; z-index: 1000;
            box-shadow: 4px 0 20px var(--shadow-color); transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar-tab { position: fixed; top: 8px; left: 8px; z-index: 1001; background: var(--primary); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; transform: translateX(-20px); }
        .sidebar-tab.visible { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .main-content.expanded { margin-left: 0 !important; max-width: 100vw !important; padding-top: 42px !important; }
        .logo { text-align: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 12px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 10px; color: var(--text-secondary); display: block; margin-top: 2px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 14px; font-weight: 700; }
        .nav-section-title.sales-locked { cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: linear-gradient(135deg, rgba(49,130,206,0.15) 0%, rgba(49,130,206,0.05) 100%); border-radius: 8px; margin: 4px 8px 8px; transition: all 0.2s; }
        .nav-section-title.sales-locked:hover { background: linear-gradient(135deg, rgba(49,130,206,0.25) 0%, rgba(49,130,206,0.15) 100%); }
        .nav-section-title.sales-locked .lock-icon { font-size: 12px; }
        .nav-section-title.sales-unlocked { cursor: default; background: linear-gradient(135deg, rgba(56,161,105,0.15) 0%, rgba(56,161,105,0.05) 100%); margin: 4px 8px 8px; padding: 12px 14px; border-radius: 8px; display: flex; align-items: center; gap: 8px; }
        .nav-section-title.sales-unlocked .lock-icon { display: none; }
        .financial-data { transition: opacity 0.3s; }
        .financial-hidden .financial-data { display: none !important; }
        .nav-item.locked-item { opacity: 0.5; cursor: pointer; }
        .nav-item.locked-item:hover { opacity: 0.7; }
        .nav-item.locked-item::after { content: 'ðŸ”’'; margin-left: 8px; font-size: 10px; }
        .nav-item { display: flex; align-items: center; padding: 7px 10px; margin: 2px 0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 11px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item.sub-item { padding-left: 36px; font-size: 11px; opacity: 0.9; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 8px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }
        .toggle-controls { margin: 10px 8px; display: flex; flex-direction: column; gap: 6px; }
        .lang-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; }
        .lang-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: white; }
        .theme-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; }
        .theme-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .theme-btn.active { background: var(--accent); }
        html.light-theme .toggle-controls .lang-toggle,
        html.light-theme .toggle-controls .theme-toggle { background: rgba(0,0,0,0.1); }
        html.light-theme .lang-btn,
        html.light-theme .theme-btn { color: rgba(255,255,255,0.7); }
        html.light-theme .lang-btn.active,
        html.light-theme .theme-btn.active { background: rgba(255,255,255,0.2); color: white; }
        .main-content { margin-left: var(--sidebar-width); padding: 10px 12px; min-height: 100vh; max-width: calc(100vw - var(--sidebar-width)); overflow-x: hidden; transition: margin-left 0.3s ease, max-width 0.3s ease; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .dept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dept-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 16px; padding: 24px; border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .dept-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .dept-card.sales::before { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .dept-card.production::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .dept-card.inventory::before { background: linear-gradient(90deg, var(--teal), var(--accent)); }
        .dept-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-color: var(--accent); }
        .dept-card .icon-large { font-size: 40px; margin-bottom: 12px; }
        .dept-card h3 { font-size: 20px; margin-bottom: 8px; }
        .dept-card p { color: var(--text-secondary); font-size: 12px; margin-bottom: 16px; }
        .dept-card .metrics { display: flex; gap: 20px; flex-wrap: wrap; }
        .dept-card .metric .value { font-size: 22px; font-weight: 700; }
        .dept-card .metric .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .dept-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .dept-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .coming-soon { position: absolute; top: 12px; right: 12px; background: var(--warning); color: #1a202c; padding: 3px 10px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .quick-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 24px; }
        .quick-stat { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 12px; padding: 16px; border: 1px solid var(--border); text-align: center; }
        .quick-stat .value { font-size: 24px; font-weight: 700; }
        .quick-stat .value.positive { color: var(--success); }
        .quick-stat .value.negative { color: var(--danger); }
        .quick-stat .value.warning { color: var(--warning); }
        .quick-stat .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .info-banner { border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; display: none; }
        .info-banner.active { display: flex; align-items: center; gap: 12px; }
        .info-banner.warning { background: linear-gradient(135deg, #744210 0%, #975a16 100%); border: 1px solid var(--warning); }
        .info-banner.warning p { color: #fefcbf; }
        .info-banner.info { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border: 1px solid var(--accent); }
        .info-banner.info p { color: #bee3f8; }
        .info-banner p { font-size: 12px; margin: 0; }
        .info-banner .icon { font-size: 20px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border); }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"], .toolbar input[type="text"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .export-dropdown { position: relative; display: inline-block; }
        .export-dropdown-content { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; min-width: 140px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; margin-top: 4px; }
        .export-dropdown-content a { color: white; padding: 10px 14px; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; transition: background 0.15s; }
        .export-dropdown-content a:hover { background: rgba(49,130,206,0.3); }
        .export-dropdown.open .export-dropdown-content { display: block; }
        .toolbar-spacer { flex: 1; }
        .category-filters { display: flex; gap: 8px; }
        .category-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 2px solid; display: flex; align-items: center; gap: 6px; }
        .category-btn .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .category-btn.rolltech { border-color: var(--accent); color: var(--accent); background: transparent; }
        .category-btn.rolltech.active { background: var(--accent); color: white; }
        .category-btn.rolltech .indicator { background: var(--accent); }
        .category-btn.molding { border-color: var(--warning); color: var(--warning); background: transparent; }
        .category-btn.molding.active { background: var(--warning); color: #1a202c; }
        .category-btn.molding .indicator { background: var(--warning); }
        .category-btn.snappad { border-color: #9f7aea; color: #9f7aea; background: transparent; }
        .category-btn.snappad.active { background: #9f7aea; color: white; }
        .category-btn.snappad .indicator { background: #9f7aea; }
        .category-btn:not(.active) { opacity: 0.5; }
        .category-btn:not(.active):hover { opacity: 0.8; }
        .status-filters { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; border: 1px solid; }
        .status-btn.pending { border-color: var(--warning); color: var(--warning); background: transparent; }
        .status-btn.pending.active { background: var(--warning); color: #1a202c; }
        .status-btn.staged { border-color: var(--staged-blue); color: var(--staged-blue); background: transparent; }
        .status-btn.staged.active { background: var(--staged-blue); color: white; }
        .status-btn.wip { border-color: var(--teal); color: var(--teal); background: transparent; }
        .status-btn.wip.active { background: var(--teal); color: white; }
        .status-btn.shipped { border-color: var(--success); color: var(--success); background: transparent; }
        .status-btn.shipped.active { background: var(--success); color: white; }
        .status-btn:not(.active) { opacity: 0.5; }
        .status-btn:not(.active):hover { opacity: 0.8; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; white-space: nowrap; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .warning-text { color: var(--warning); font-weight: 600; }
        .scrollable-table { max-height: 600px; overflow-y: auto; overflow-x: auto; border-radius: 10px; -webkit-overflow-scrolling: touch; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--staged-blue) 0%, #3182ce 100%); color: white; }
        .badge.wip { background: linear-gradient(135deg, var(--teal) 0%, #2c7a7b 100%); color: white; }
        .badge.urgent { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }
        .badge.priority-1 { background: var(--danger); color: white; }
        .badge.priority-2 { background: var(--warning); color: #1a202c; }
        .badge.priority-3 { background: var(--accent); color: white; }
        .badge.priority-4 { background: var(--teal); color: white; }
        .cell-missing { color: var(--danger); font-weight: 600; }
        .cell-available { color: var(--success); }
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .price-history-container { position: relative; height: 250px; margin-bottom: 20px; padding-bottom: 30px; }
        .price-history-container canvas { max-height: 250px; }
        .search-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1200px) { .quick-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; padding-top: 60px; }
            .mobile-header { display: flex; }
            .dept-grid { grid-template-columns: 1fr; }
            .quick-stats { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-spacer { display: none; }
            /* Fix chart sizing on mobile */
            .chart-wrapper { height: 220px; }
            .grid-2 { gap: 12px; }
            .chart-container { padding: 14px; margin-bottom: 12px; }
            /* Hide sidebar-tab on mobile (use mobile-header menu instead) */
            .sidebar-tab { display: none !important; }
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }
        .inv-low { background: rgba(229,62,62,0.15) !important; }
        .inv-warning { background: rgba(214,158,46,0.15) !important; }
        .inv-ok { background: rgba(56,161,105,0.08) !important; }
        .drilldown-section { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .drilldown-section.active { display: block; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; }
        .breadcrumb { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .close-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .close-btn:hover { border-color: var(--danger); color: var(--danger); }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        .summary-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        @media (max-width: 768px) { .bom-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
        
        /* Material Requirements Styles */
        .mat-req-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .mat-req-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
        .mat-req-card .label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .mat-req-card .value { font-size: 1.4rem; font-weight: 700; margin-top: 4px; }
        .mat-req-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .mat-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .mat-badge-shortage { background: rgba(248,113,113,0.15); color: #f87171; }
        .mat-badge-low { background: rgba(251,146,60,0.15); color: #fb923c; }
        .mat-badge-ok { background: rgba(74,222,128,0.15); color: #4ade80; }
        .mat-surplus { color: var(--success); font-weight: 600; }
        .mat-shortage-num { color: var(--danger); font-weight: 600; }
        .mat-coverage-cell { display: flex; align-items: center; gap: 8px; }
        .mat-bar-bg { width: 80px; height: 6px; background: var(--bg-dark); border-radius: 3px; }
        .mat-bar { height: 6px; border-radius: 3px; }
        .mat-bar-green { background: #4ade80; }
        .mat-bar-yellow { background: #fbbf24; }
        .mat-bar-red { background: #f87171; }
        .mat-req-row { cursor: pointer; }
        .mat-req-row:hover { background: var(--bg-hover) !important; }
        .mat-detail-row td { padding: 0 !important; }
        .mat-detail-content { padding: 12px 20px; background: var(--bg-dark); border-radius: 8px; margin: 4px 8px 8px; }
        .mat-detail-table { width: 100%; font-size: 12px; margin-top: 8px; }
        .mat-detail-table th { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); padding: 4px 8px; text-align: left; letter-spacing: 0.5px; }
        .mat-detail-table td { padding: 4px 8px; border-bottom: 1px solid var(--border); }
        .mat-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .mat-section h3 { font-size: 14px; margin-bottom: 12px; color: var(--text-primary); }
        .mat-section table { width: 100%; }
        .mat-section th { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); padding: 6px 10px; text-align: left; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .mat-section td { padding: 6px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .mat-section .num { text-align: right; font-variant-numeric: tabular-nums; }
        @media (max-width: 768px) {
            .mat-req-summary { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .mat-req-card { padding: 10px; }
            .mat-req-card .value { font-size: 1.1rem; }
            .mat-section { overflow-x: auto; }
        }
        
        /* Column Filter System Styles */
        .filter-th { position: relative; }
        .filter-th-content { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .filter-th-btns { display: flex; gap: 2px; }
        .filter-th-btns button { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .filter-th-btns button:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-th.filtered { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; }
        .filter-th.filtered .filter-th-btns button { background: rgba(0,0,0,0.2); }
        .filter-dropdown { position: fixed; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2000; min-width: 240px; max-width: 320px; max-height: 400px; display: none; flex-direction: column; }
        .filter-dropdown.active { display: flex; }
        .filter-dropdown-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-dropdown-header h4 { font-size: 12px; font-weight: 600; margin: 0; }
        .filter-dropdown-header button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; }
        .filter-search { margin: 10px; padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 12px; }
        .filter-search:focus { outline: none; border-color: var(--accent); }
        .filter-actions { display: flex; gap: 8px; padding: 0 10px 8px 10px; }
        .filter-actions button { flex: 1; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .filter-actions button:hover { border-color: var(--accent); color: white; }
        .filter-values-list { flex: 1; overflow-y: auto; padding: 0 10px; max-height: 220px; }
        .filter-value-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .filter-value-item:hover { background: rgba(255,255,255,0.05); }
        .filter-value-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        .filter-value-item label { cursor: pointer; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-dropdown-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .filter-dropdown-footer button { flex: 1; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .filter-dropdown-footer .clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .filter-dropdown-footer .clear-btn:hover { border-color: var(--danger); color: var(--danger); }
        .filter-dropdown-footer .apply-btn { background: var(--accent); border: none; color: white; }
        .filter-dropdown-footer .apply-btn:hover { background: var(--primary-light); }
        .clear-all-filters-btn { background: var(--bg-dark) !important; }
        .clear-all-filters-btn.has-filters { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; color: #1a202c !important; border-color: var(--warning) !important; }
        .show-hidden-btn { display: none; background: var(--bg-dark) !important; }
        .show-hidden-btn.has-hidden { display: inline-flex; background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%) !important; color: white !important; border-color: var(--accent) !important; }
        
        /* Column Toggle Dropdown */
        .columns-btn { background: var(--bg-dark) !important; position: relative; }
        .columns-btn.has-hidden { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%) !important; color: white !important; border-color: var(--accent) !important; }
        .column-toggle-dropdown {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 10001; width: 320px; max-height: 80vh;
            display: none; flex-direction: column; overflow: hidden;
        }
        .column-toggle-dropdown.active { display: flex; }
        .column-toggle-header {
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(135deg, rgba(66,153,225,0.15) 0%, rgba(49,130,206,0.1) 100%);
        }
        .column-toggle-header h4 { margin: 0; font-size: 14px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .column-toggle-header button { background: transparent; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; padding: 4px; }
        .column-toggle-header button:hover { color: var(--text-primary); }
        .column-toggle-actions {
            padding: 10px 14px; border-bottom: 1px solid var(--border);
            display: flex; gap: 8px; background: rgba(0,0,0,0.1);
        }
        .column-toggle-actions button {
            flex: 1; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-secondary);
            transition: all 0.2s;
        }
        .column-toggle-actions button:hover { border-color: var(--accent); color: white; }
        .column-toggle-list { flex: 1; overflow-y: auto; padding: 8px 0; max-height: 400px; }
        .column-toggle-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 16px;
            cursor: pointer; font-size: 13px; transition: background 0.15s;
        }
        .column-toggle-item:hover { background: rgba(255,255,255,0.05); }
        .column-toggle-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent);
        }
        .column-toggle-item label { cursor: pointer; flex: 1; color: var(--text-primary); }
        .column-toggle-item.hidden-col label { color: var(--text-secondary); text-decoration: line-through; }
        .column-toggle-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 10000; display: none;
        }
        .column-toggle-overlay.active { display: block; }
        
        /* Password Modal Styles */
        .password-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 20000; display: none;
        }
        .password-modal-overlay.active { display: block; }
        .password-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-card); border-radius: 12px; z-index: 20001;
            min-width: 320px; max-width: 90vw; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: none; border: 1px solid var(--border);
        }
        .password-modal.active { display: block; }
        .password-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 1px solid var(--border);
        }
        .password-modal-header h4 { margin: 0; font-size: 16px; color: var(--text-primary); }
        .password-modal-header button {
            background: none; border: none; color: var(--text-secondary);
            font-size: 18px; cursor: pointer; padding: 4px 8px;
        }
        .password-modal-header button:hover { color: var(--text-primary); }
        .password-modal-body { padding: 20px; }
        .password-input {
            width: 100%; padding: 12px 14px; font-size: 14px;
            background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary); outline: none;
        }
        .password-input:focus { border-color: var(--accent); }
        .password-error { color: #e53e3e; font-size: 12px; margin-top: 8px; display: none; }
        .password-error.show { display: block; }
        .password-modal-footer {
            display: flex; justify-content: flex-end; gap: 10px;
            padding: 16px 20px; border-top: 1px solid var(--border);
        }
        .password-cancel-btn {
            padding: 10px 18px; background: transparent; border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 13px;
        }
        .password-cancel-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .password-submit-btn {
            padding: 10px 24px; background: var(--accent); border: none;
            border-radius: 8px; color: white; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .password-submit-btn:hover { background: var(--accent-hover); }
        
        .watchlist-star { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .watchlist-star:hover { color: var(--warning); }
        .watchlist-star.active { color: var(--warning); }
        
        /* All Data table styles - larger for better readability */
        #all-data .data-table th { font-size: 11px; padding: 10px 8px; white-space: nowrap; min-width: 100px; }
        #all-data .data-table td { font-size: 12px; padding: 8px; white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
        #all-data .scrollable-table { overflow-x: auto; }
        #all-data .filter-th-btns button { width: 20px; height: 20px; font-size: 10px; }
        
        /* Zoom controls */
        .zoom-controls { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 10px 8px; }
        .zoom-btn { width: 28px; height: 28px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .zoom-btn:hover { background: var(--accent); border-color: var(--accent); }
        .zoom-reset-btn { width: 100%; margin-top: 8px; padding: 6px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .zoom-reset-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Dashboard wrapper for zoom - applies to both sidebar and content */
        .dashboard-wrapper { zoom: 1; }
        
        /* Pallet Pictures Gallery Styles */
        .pallet-drilldown { display: none; background: var(--bg-card); border-radius: 0 0 14px 14px; padding: 20px; border: 1px solid var(--border); border-top: 2px solid var(--accent); margin-top: -1px; }
        .pallet-drilldown.active { display: block; }
        .pallet-drilldown-content { max-width: 100%; }
        tr.drilldown-active { background: rgba(49, 130, 206, 0.15) !important; }
        tr.drilldown-active td { border-bottom: none !important; }
        .order-drilldown-row td { border-top: none !important; }
        .pallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .pallet-header h3 { font-size: 18px; }
        .pallet-summary { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .pallet-summary-item { background: var(--bg-dark); padding: 8px 12px; border-radius: 6px; }
        .pallet-summary-item .label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .pallet-summary-item .value { font-size: 14px; font-weight: 700; }
        .pallet-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .photo-drilldown-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; width: 100%; }
        .photo-drilldown-box { padding: 20px; border-radius: 12px; min-height: 220px; display: flex; flex-direction: column; flex: 1; }
        .photo-drilldown-box h4 { margin: 0 0 16px 0; font-size: 14px; font-weight: 600; }
        .photo-drilldown-box .photo-btn { display: inline-block; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; margin: 4px; }
        .photo-drilldown-box .photo-info { font-size: 11px; color: var(--text-secondary); line-height: 1.6; margin-top: auto; }
        .pallet-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.2s; }
        .pallet-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }

        /* ===== PALLET LOAD CALCULATOR STYLES ===== */
        .plc-section { margin-top: 24px; }
        .plc-toggle-btn { width: 100%; background: var(--bg-card); border: 2px dashed var(--border); border-radius: 10px; padding: 16px; color: var(--text-secondary); font-family: inherit; font-size: 15px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .plc-toggle-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(49, 130, 206, 0.08); }
        .plc-toggle-btn.active { border-style: solid; border-color: var(--accent); color: var(--accent); background: rgba(49, 130, 206, 0.08); }
        .plc-container { display: none; margin-top: 16px; }
        .plc-container.show { display: block; }
        .plc-layout { display: grid; grid-template-columns: 400px 1fr; gap: 20px; align-items: start; }
        @media (max-width: 1100px) { .plc-layout { grid-template-columns: 1fr; } }
        .plc-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .plc-card-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600; }
        .plc-trailer-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .plc-trailer-btn { background: var(--bg-dark); border: 2px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; text-align: center; font-family: inherit; }
        .plc-trailer-btn:hover { border-color: var(--border-light, #3d444d); }
        .plc-trailer-btn.active { border-color: var(--accent); background: rgba(49, 130, 206, 0.1); }
        .plc-trailer-btn .size { font-size: 20px; font-weight: 700; display: block; }
        .plc-trailer-btn .label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; display: block; }
        .plc-field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .plc-field label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .plc-field input, .plc-field select { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; color: var(--text-primary); font-size: 14px; transition: border-color 0.15s; width: 100%; font-family: inherit; }
        .plc-field input:focus, .plc-field select:focus { outline: none; border-color: var(--accent); }
        .plc-pallet-type { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 10px; transition: border-color 0.2s; position: relative; }
        .plc-pallet-type:hover { border-color: var(--border-light, #3d444d); }
        .plc-pallet-type.dragging { opacity: 0.5; border-color: var(--accent); }
        .plc-pallet-type.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2); }
        .plc-ptype-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .plc-ptype-header-left { display: flex; align-items: center; gap: 8px; }
        .plc-drag-handle { cursor: grab; padding: 4px 2px; color: var(--border); display: flex; flex-direction: column; align-items: center; gap: 2px; transition: color 0.15s; user-select: none; }
        .plc-drag-handle:hover { color: var(--accent); }
        .plc-drag-handle:active { cursor: grabbing; }
        .plc-drag-dots { display: flex; gap: 2px; }
        .plc-drag-dots span { width: 3px; height: 3px; background: currentColor; border-radius: 50%; }
        .plc-order-badge { width: 22px; height: 22px; border-radius: 5px; background: rgba(49, 130, 206, 0.15); border: 1px solid var(--accent); color: var(--accent); font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .plc-color-swatch { width: 20px; height: 20px; border-radius: 4px; border: 2px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s; flex-shrink: 0; }
        .plc-color-swatch:hover { transform: scale(1.15); border-color: rgba(255,255,255,0.4); }
        .plc-color-popup { position: absolute; top: 30px; left: 60px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: none; z-index: 100; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .plc-color-popup.show { display: block; }
        .plc-color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .plc-color-opt { width: 26px; height: 26px; border-radius: 5px; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
        .plc-color-opt:hover { transform: scale(1.15); }
        .plc-color-opt.selected { border-color: white; }
        .plc-name-input { background: none; border: none; color: var(--text-primary); font-weight: 600; font-size: 14px; font-family: inherit; outline: none; padding: 2px 4px; border-radius: 4px; max-width: 160px; cursor: text; }
        .plc-name-input:hover { background: var(--bg-dark); }
        .plc-name-input:focus { background: var(--bg-dark); border: 1px solid var(--accent); }
        .plc-remove-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; line-height: 1; padding: 4px 8px; border-radius: 4px; transition: all 0.15s; }
        .plc-remove-btn:hover { background: rgba(248, 81, 73, 0.12); color: #f85149; }
        .plc-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .plc-stack-row { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        .plc-stack-toggle { position: relative; width: 42px; height: 24px; cursor: pointer; flex-shrink: 0; }
        .plc-stack-toggle input { display: none; }
        .plc-stack-slider { position: absolute; inset: 0; background: var(--border); border-radius: 12px; transition: background 0.2s; }
        .plc-stack-slider::after { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; top: 3px; background: var(--text-primary); border-radius: 50%; transition: transform 0.2s; }
        .plc-stack-toggle input:checked + .plc-stack-slider { background: var(--accent); }
        .plc-stack-toggle input:checked + .plc-stack-slider::after { transform: translateX(18px); }
        .plc-orient-toggle { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 4px; }
        .plc-orient-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; transition: all 0.15s; text-align: center; }
        .plc-orient-btn:hover { border-color: var(--border-light, #3d444d); }
        .plc-orient-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(49, 130, 206, 0.1); }
        .plc-orient-info { font-size: 10px; margin-top: 6px; padding: 5px 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); line-height: 1.4; }
        .plc-add-btn { width: 100%; background: var(--bg-dark); border: 2px dashed var(--border); border-radius: 8px; padding: 12px; color: var(--text-secondary); font-family: inherit; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .plc-add-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(49, 130, 206, 0.08); }
        .plc-stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        @media (max-width: 700px) { .plc-stats-bar { grid-template-columns: 1fr 1fr; } }
        .plc-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; }
        .plc-stat .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 4px; }
        .plc-stat .value { font-size: 20px; font-weight: 700; }
        .plc-stat .sub { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .plc-stat.overweight { border-color: #f85149; background: rgba(248, 81, 73, 0.08); }
        .plc-stat.overweight .value { color: #f85149; }
        .plc-stat.ok .value { color: #3fb950; }
        .plc-weight-bar { height: 8px; background: var(--bg-dark); border-radius: 4px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 12px; }
        .plc-weight-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease, background-color 0.3s; }
        .plc-trailer-visual { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; overflow-x: auto; }
        .plc-trailer-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 12px; display: flex; justify-content: space-between; }
        .plc-legend { display: flex; flex-wrap: wrap; gap: 12px 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); }
        .plc-legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.1); display: inline-block; vertical-align: middle; margin-right: 6px; }
        .plc-order-selector { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-top: 8px; }
        .plc-order-selector .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .plc-order-checkbox-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .plc-order-checkbox-list label { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.15s; }
        .plc-order-checkbox-list label:hover { background: rgba(49, 130, 206, 0.08); }
        .plc-order-checkbox-list input[type="checkbox"] { accent-color: var(--accent); }
        .plc-order-search { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; color: var(--text-primary); font-size: 12px; font-family: inherit; margin-bottom: 8px; transition: border-color 0.15s; }
        .plc-order-search:focus { outline: none; border-color: var(--accent); }
        .plc-order-checkbox-list .plc-order-item-hidden { display: none; }
        .plc-link-toggle { margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        /* ===== END PALLET LOAD CALCULATOR STYLES ===== */
        .pallet-card-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pallet-card-header h4 { font-size: 14px; font-weight: 600; }
        .pallet-card-header .pallet-meta { font-size: 11px; color: var(--text-secondary); }
        .pallet-images { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .pallet-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .pallet-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
        .pallet-card-details { padding: 12px; background: rgba(0,0,0,0.2); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pallet-detail { font-size: 11px; }
        .pallet-detail .label { color: var(--text-secondary); }
        .pallet-detail .value { font-weight: 600; color: var(--text-primary); }
        .drawing-thumbnails { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .drawing-thumb {
            width: 180px; cursor: pointer; border-radius: 8px; overflow: hidden;
            border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card);
        }
        .drawing-thumb:hover { border-color: #ed8936; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .drawing-thumb img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .drawing-thumb .drawing-label { padding: 6px 10px; font-size: 11px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(237, 137, 54, 0.15); }
        .drawing-thumbnails { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .drawing-thumb { width: 180px; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card); }
        .drawing-thumb:hover { border-color: #ed8936; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .drawing-thumb img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .drawing-thumb .drawing-label { padding: 6px 10px; font-size: 11px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(237, 137, 54, 0.15); }
        /* Photo thumbnails - smaller than drawings */
        .photo-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; }
        .photo-thumb { width: 100px; cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card); }
        .photo-thumb:hover { border-color: var(--accent); transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .photo-thumb img { width: 100%; height: 75px; object-fit: cover; display: block; }
        .photo-thumb .photo-label { padding: 4px 6px; font-size: 10px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(0,0,0,0.2); }
        .photo-thumb.pallet-photo:hover { border-color: var(--accent); }
        .photo-thumb.pallet-photo .photo-label { background: rgba(49, 130, 206, 0.3); }
        .photo-thumb.fusion-photo:hover { border-color: #38b2ac; }
        .photo-thumb.fusion-photo .photo-label { background: rgba(56, 178, 172, 0.3); }
        .photo-thumb.shipment-photo:hover { border-color: var(--success); }
        .photo-thumb.shipment-photo .photo-label { background: rgba(56, 161, 105, 0.3); }
        .photo-thumb.paperwork-photo:hover { border-color: #718096; }
        .photo-thumb.paperwork-photo .photo-label { background: rgba(113, 128, 150, 0.3); }
        .photo-thumb.closeup-photo:hover { border-color: #805ad5; }
        .photo-thumb.closeup-photo .photo-label { background: rgba(128, 90, 213, 0.3); }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .image-modal-close:hover { background: var(--danger); }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover td { background: rgba(49,130,206,0.15) !important; }
        .pallet-indicator { margin-left: 6px; color: var(--accent); font-size: 12px; }
        
        /* Inventory History Modal */
        .history-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2500; align-items: center; justify-content: center; }
        .history-modal-overlay.active { display: flex; }
        .history-modal { background: var(--bg-card); border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .history-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }
        .history-modal-header h3 { font-size: 18px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .history-modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .history-modal-close:hover { background: var(--danger); }
        .history-modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 70px); }
        .history-chart-container { height: 300px; margin-bottom: 20px; }
        .history-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
        .history-date-inputs { display: flex; gap: 16px; flex-wrap: wrap; }
        .history-date-group { display: flex; align-items: center; gap: 8px; }
        .history-date-group label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
        .history-date-group input[type="date"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: white; font-size: 12px; }
        .history-date-group input[type="date"]:focus { outline: none; border-color: var(--accent); }
        .history-presets { display: flex; gap: 8px; flex-wrap: wrap; }
        .history-presets button { padding: 8px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .history-presets button:hover { background: var(--accent); border-color: var(--accent); color: white; }
        .history-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .history-stats.usage-stats { grid-template-columns: repeat(5, 1fr); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top: 8px; }
        .usage-stats .history-stat-label small { font-size: 10px; color: var(--text-secondary); opacity: 0.7; }
        .history-stat { background: var(--bg-dark); padding: 14px; border-radius: 10px; text-align: center; }
        .history-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .history-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .history-loading, .history-no-data { text-align: center; padding: 40px; color: var(--text-secondary); }
        .inv-history-btn { margin-left: 8px; background: var(--accent); color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; opacity: 0.8; transition: all 0.2s; }
        .inv-history-btn:hover { opacity: 1; }
        @media (max-width: 768px) {
            .history-modal { width: 95%; max-height: 95vh; }
            .history-controls { flex-direction: column; align-items: stretch; }
            .history-date-inputs { justify-content: center; }
            .history-presets { justify-content: center; }
            .history-stats { grid-template-columns: repeat(2, 1fr); }
            .history-stats.usage-stats { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Inventory History Page (Multi-Part) */
        .history-page-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 180px); }
        .history-parts-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .history-panel-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-panel-header h3 { font-size: 14px; font-weight: 600; }
        .history-selected-count { font-size: 11px; color: var(--accent); font-weight: 500; }
        .history-parts-search { margin: 12px; padding: 10px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 12px; }
        .history-parts-search:focus { outline: none; border-color: var(--accent); }
        .history-parts-actions { display: flex; gap: 8px; padding: 0 12px 12px; }
        .history-parts-actions button { flex: 1; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .history-parts-actions button:hover { border-color: var(--accent); color: white; }
        .history-parts-list { flex: 1; overflow-y: auto; padding: 0 8px 8px; }
        .history-part-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .history-part-item:hover { background: rgba(255,255,255,0.05); }
        .history-part-item.selected { background: rgba(49,130,206,0.2); }
        .history-part-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
        .history-part-item .part-info { flex: 1; min-width: 0; }
        .history-part-item .part-number { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-part-item .part-type { font-size: 10px; color: var(--text-secondary); }
        .history-part-item .part-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .history-chart-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .history-chart-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .history-page-chart-container { flex: 1; position: relative; min-height: 300px; }
        .history-page-chart-container canvas { width: 100% !important; height: 100% !important; }
        .history-page-no-selection { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); font-size: 14px; }
        .history-legend { display: flex; flex-wrap: wrap; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
        .history-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .history-legend-color { width: 20px; height: 4px; border-radius: 2px; }
        .history-legend-below { font-size: 10px; color: var(--danger); margin-left: 4px; }
        .history-page-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 150px; overflow-y: auto; }
        .history-part-stat-card { background: var(--bg-dark); border-radius: 10px; padding: 12px; }
        .history-part-stat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .history-part-stat-color { width: 12px; height: 12px; border-radius: 3px; }
        .history-part-stat-name { font-weight: 600; font-size: 12px; flex: 1; }
        .history-part-stat-values { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .history-part-stat-item { text-align: center; }
        .history-part-stat-value { font-size: 14px; font-weight: 600; color: var(--accent); }
        .history-part-stat-value.below-min { color: var(--danger); }
        .history-part-stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        @media (max-width: 900px) {
            .history-page-layout { grid-template-columns: 1fr; height: auto; }
            .history-parts-panel { max-height: 300px; }
            .history-page-chart-container { min-height: 350px; }
        }
        
        /* ========================================== */
        /* LIGHT THEME OVERRIDES                      */
        /* ========================================== */
        
        /* Page Headers */
        html.light-theme .page-header h2 {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Cards - Department Cards, Stat Cards, Quick Stats */
        html.light-theme .dept-card,
        html.light-theme .stat-card,
        html.light-theme .quick-stat {
            background: var(--card-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .dept-card:hover {
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        html.light-theme .stat-card:hover {
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        
        /* Chart Containers */
        html.light-theme .chart-container {
            background: var(--card-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        /* Toolbar */
        html.light-theme .toolbar {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .toolbar select,
        html.light-theme .toolbar input[type="date"],
        html.light-theme .toolbar input[type="text"] {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .toolbar-btn {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .toolbar-btn:hover {
            background: rgba(49,130,206,0.1);
        }
        html.light-theme .export-dropdown-content { background: #fff; border-color: #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        html.light-theme .export-dropdown-content a { color: #2d3748; }
        html.light-theme .export-dropdown-content a:hover { background: rgba(49,130,206,0.1); }
        
        /* Search Box */
        html.light-theme .search-box {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        /* Data Tables */
        html.light-theme .data-table th {
            background: linear-gradient(135deg, #2b6cb0 0%, #3182ce 100%);
        }
        html.light-theme .data-table th:hover {
            background: linear-gradient(135deg, #3182ce 0%, #4299e1 100%);
        }
        html.light-theme .data-table tr:hover td {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .data-table tr:nth-child(even) td {
            background: var(--table-row-alt);
        }
        html.light-theme .data-table tr:nth-child(even):hover td {
            background: rgba(49,130,206,0.08);
        }
        
        /* Scrollable Tables */
        html.light-theme .scrollable-table::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        html.light-theme .scrollable-table::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
        }
        
        /* Info Banner */
        html.light-theme .info-banner.warning {
            background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
            border-color: var(--warning);
        }
        html.light-theme .info-banner.warning p {
            color: #744210;
        }
        html.light-theme .info-banner.info {
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);
            border-color: var(--accent);
        }
        html.light-theme .info-banner.info p {
            color: #1a365d;
        }
        
        /* Modals */
        html.light-theme .filter-dropdown {
            background: var(--modal-bg);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        html.light-theme .filter-dropdown input {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .filter-values-list label {
            color: var(--text-primary);
        }
        html.light-theme .filter-values-list label:hover {
            background: rgba(49,130,206,0.1);
        }
        
        /* Inventory History Modal */
        html.light-theme .history-modal {
            background: var(--modal-bg);
            box-shadow: 0 20px 60px var(--shadow-color);
        }
        html.light-theme .history-modal-header {
            background: linear-gradient(135deg, #2b6cb0 0%, #3182ce 100%);
        }
        html.light-theme .history-controls,
        html.light-theme .history-stats {
            background: var(--bg-dark);
        }
        
        /* Inventory History Page */
        html.light-theme .history-parts-panel,
        html.light-theme .history-chart-panel {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .history-parts-search {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .history-parts-actions button {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .history-part-item:hover {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .history-part-item.selected {
            background: rgba(49,130,206,0.15);
        }
        html.light-theme .history-part-stat-card {
            background: var(--bg-dark);
        }
        
        /* BOM Explorer */
        html.light-theme .bom-sidebar,
        html.light-theme .bom-main {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .bom-search,
        html.light-theme .bom-part-search {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .bom-part-item:hover {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .bom-part-item.selected {
            background: rgba(49,130,206,0.15);
        }
        
        /* Loading State */
        html.light-theme .spinner {
            border-color: rgba(0,0,0,0.1);
            border-top-color: var(--accent);
        }
        
        /* Mobile Header */
        html.light-theme .mobile-header {
            background: var(--sidebar-bg);
        }
        
        /* Drilldown Panel */
        html.light-theme .drilldown-panel {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .drilldown-section {
            background: var(--bg-dark);
        }
        
        /* Photo Drilldown */
        html.light-theme .pallet-drilldown {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .photo-box {
            background: var(--bg-dark);
        }
        
        /* Zoom Controls */
        html.light-theme .zoom-controls input,
        html.light-theme .zoom-btn {
            background: rgba(0,0,0,0.1);
            color: rgba(255,255,255,0.9);
        }
        html.light-theme .zoom-reset-btn {
            background: rgba(0,0,0,0.1);
            color: rgba(255,255,255,0.9);
        }
        
        /* Data Info in Sidebar */
        html.light-theme .data-info {
            border-top-color: rgba(255,255,255,0.2);
        }
        html.light-theme .data-info strong {
            color: white;
        }
        html.light-theme .data-info {
            color: rgba(255,255,255,0.7);
        }
        /* ============================================================
           AI CHAT PANEL
           ============================================================ */
        .ai-chat-fab {
            position: fixed; bottom: 24px; right: 24px; z-index: 2000;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            border: none; color: white; font-size: 26px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(66,133,244,0.4);
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
        }
        .ai-chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(66,133,244,0.6); }
        .ai-chat-fab.hidden { display: none; }

        .ai-chat-panel {
            position: fixed; bottom: 24px; right: 24px; z-index: 2001;
            width: 500px; max-width: calc(100vw - 48px); height: 540px; max-height: calc(100vh - 48px);
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.9) translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.25s ease;
        }
        .ai-chat-panel.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: auto; }
        
        /* Mobile: full-screen AI chat with input in upper half */
        @media (max-width: 480px) {
            .ai-chat-panel {
                top: 0; left: 0; right: 0; bottom: 50%;
                width: 100%; max-width: 100%; height: 50vh; max-height: 50vh;
                border-radius: 0 0 16px 16px; border: none;
                border-bottom: 2px solid var(--accent);
            }
            .ai-chat-panel.open {
                position: fixed;
            }
            .ai-chat-header { 
                padding: 12px 16px; 
                background: var(--bg-card);
                flex-shrink: 0;
            }
            .ai-chat-header-actions .close-btn {
                font-size: 20px; padding: 8px 14px; min-width: 44px;
            }
            .ai-chat-messages {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                padding: 12px;
            }
            .ai-chat-input-area {
                flex-shrink: 0;
                background: var(--bg-card);
                border-top: 1px solid var(--border);
                padding: 10px 12px;
            }
            .ai-chat-input-area textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
                max-height: 60px;
            }
        }

        .ai-chat-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(66,133,244,0.15) 0%, rgba(52,168,83,0.1) 100%);
            flex-shrink: 0;
        }
        .ai-chat-header-left { display: flex; align-items: center; gap: 10px; }
        .ai-chat-header-left .ai-icon { font-size: 22px; }
        .ai-chat-header-left .ai-title { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .ai-chat-header-left .ai-subtitle { font-size: 10px; color: var(--text-secondary); }
        .ai-chat-header-actions { display: flex; gap: 6px; }
        .ai-chat-header-actions button {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            font-size: 16px; padding: 4px 6px; border-radius: 6px; transition: all 0.2s;
        }
        .ai-chat-header-actions button:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .ai-chat-header-actions .close-btn {
            background: var(--danger); color: white; font-size: 20px; font-weight: bold;
            padding: 8px 14px; border-radius: 8px; min-width: 40px;
        }
        .ai-chat-header-actions .close-btn:hover { background: #c53030; }

        .ai-chat-messages {
            flex: 1 1 0; height: 0; min-height: 0; overflow-y: scroll; padding: 16px; display: flex; flex-direction: column; gap: 12px;
            scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        .ai-chat-messages::-webkit-scrollbar { width: 6px; }
        .ai-chat-messages::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

        .ai-msg { max-width: 88%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.55; word-wrap: break-word; }
        .ai-msg.user { align-self: flex-end; background: linear-gradient(135deg, #4285f4 0%, #5a9cf5 100%); color: white; border-bottom-right-radius: 4px; }
        .ai-msg.bot { align-self: flex-start; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .ai-msg.bot .ai-table-wrap { overflow-x: auto; margin: 8px 0; -webkit-overflow-scrolling: touch; border-radius: 6px; border: 1px solid var(--border); max-width: 100%; display: block; scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg-card); }
        .ai-msg.bot .ai-table-wrap::-webkit-scrollbar { height: 8px; }
        .ai-msg.bot .ai-table-wrap::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 4px; }
        .ai-msg.bot .ai-table-wrap::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
        .ai-msg.bot table { width: max-content; min-width: 100%; border-collapse: collapse; font-size: 12px; }
        .ai-msg.bot table th, .ai-msg.bot table td { padding: 5px 10px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .ai-msg.bot table th { background: rgba(66,133,244,0.2); font-weight: 600; font-size: 11px; }
        .ai-msg.bot code { background: rgba(0,0,0,0.2); padding: 1px 5px; border-radius: 3px; font-size: 12px; }
        .ai-msg.bot strong { color: #63b3ed; }
        .ai-msg.bot ul, .ai-msg.bot ol { padding-left: 18px; margin: 4px 0; }
        .ai-msg.system { align-self: center; color: var(--text-secondary); font-size: 11px; font-style: italic; padding: 4px 12px; }
        .ai-msg.error { align-self: flex-start; background: rgba(229,62,62,0.15); color: var(--danger-light); border: 1px solid rgba(229,62,62,0.3); border-bottom-left-radius: 4px; }

        .ai-typing { display: flex; align-items: center; gap: 4px; padding: 10px 14px; align-self: flex-start; }
        .ai-typing-dot { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: aiTypingBounce 1.4s infinite ease-in-out; }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiTypingBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

        .ai-chat-input-area {
            display: flex; align-items: center; gap: 8px;
            padding: 12px 14px; border-top: 1px solid var(--border); background: var(--input-bg);
            flex-shrink: 0;
        }
        .ai-chat-input-area textarea {
            flex: 1; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px;
            padding: 10px 14px; color: var(--text-primary); font-size: 13px; outline: none;
            transition: border-color 0.2s, max-height 0.2s; resize: vertical; min-height: 40px; max-height: 150px;
            line-height: 1.4; font-family: inherit; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg-card);
        }
        .ai-chat-input-area textarea::-webkit-scrollbar { width: 6px; }
        .ai-chat-input-area textarea::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
        .ai-chat-input-area textarea::placeholder { color: var(--text-secondary); }
        .ai-chat-input-area textarea:focus { border-color: #4285f4; }
        .ai-chat-input-area button.ai-send-btn {
            width: 38px; height: 38px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white; font-size: 18px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .ai-chat-input-area button.ai-send-btn:hover { transform: scale(1.08); }
        .ai-chat-input-area button.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* Voice mode toggle */
        .ai-chat-input-area button.ai-voice-mode-toggle {
            width: 28px; height: 28px; border-radius: 50%; border: none;
            background: rgba(66,133,244,0.2); color: #4285f4;
            font-size: 12px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            margin-right: 4px;
        }
        .ai-chat-input-area button.ai-voice-mode-toggle:hover { background: rgba(66,133,244,0.3); }
        .ai-chat-input-area button.ai-voice-mode-toggle.auto-send {
            background: rgba(234,67,53,0.2); color: #ea4335;
        }
        .ai-chat-input-area button.ai-voice-mode-toggle.auto-send:hover { background: rgba(234,67,53,0.3); }
        
        /* Voice input button */
        .ai-chat-input-area button.ai-voice-btn {
            width: 38px; height: 38px; border-radius: 50%; border: none;
            background: rgba(66,133,244,0.15); color: #4285f4;
            font-size: 18px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            margin-right: 6px;
        }
        .ai-chat-input-area button.ai-voice-btn:hover { background: rgba(66,133,244,0.25); transform: scale(1.08); }
        .ai-chat-input-area button.ai-voice-btn.listening {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white; animation: pulse-voice 1s infinite;
        }
        .ai-chat-input-area button.ai-voice-btn.listening.auto-send {
            background: linear-gradient(135deg, #ea4335 0%, #ff6b35 100%);
        }
        .ai-chat-input-area button.ai-voice-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(234,67,53,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(234,67,53,0); }
        }
        .ai-voice-status {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 6px 12px;
            border-radius: 6px; font-size: 11px; white-space: nowrap;
            margin-bottom: 8px; display: none;
        }
        .ai-voice-status.visible { display: block; }

        .ai-suggestions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 14px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .ai-suggestion-chip {
            background: rgba(66,133,244,0.12); border: 1px solid rgba(66,133,244,0.25);
            color: #63b3ed; padding: 5px 12px; border-radius: 16px; font-size: 11px;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .ai-suggestion-chip:hover { background: rgba(66,133,244,0.25); border-color: #4285f4; }

        @media (max-width: 600px) {
            .ai-chat-panel { width: calc(100vw - 16px); height: calc(100vh - 80px); bottom: 8px; right: 8px; border-radius: 12px; }
            .ai-chat-fab { bottom: 16px; right: 16px; width: 50px; height: 50px; font-size: 22px; }
            .ai-suggestions { display: none; }
        }

        /* ============================================================
           iPHONE RESPONSIVE DESIGN (375px - 430px)
           ============================================================ */
        @media (max-width: 480px) {
            /* Root adjustments */
            :root { --sidebar-width: 280px; }
            
            /* Body: prevent horizontal scroll */
            body { overflow-x: hidden; }
            
            /* Sidebar: slide-in overlay (not full screen) */
            .sidebar {
                width: 280px; height: 100vh;
                transform: translateX(0); /* Show by default when not collapsed */
                z-index: 3000;
                padding-top: 16px;
                box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            }
            .sidebar.collapsed { transform: translateX(-100%); } /* Hide when collapsed */
            .sidebar .nav-item { padding: 14px 20px; font-size: 14px; }
            .sidebar .nav-item i { font-size: 18px; min-width: 28px; }
            .sidebar .nav-section { padding: 10px 16px; font-size: 11px; }
            
            /* Sidebar logo area */
            .sidebar .logo { padding: 12px 16px; }
            .sidebar .logo h1 { font-size: 18px; }
            
            /* Sidebar overlay - managed via .active class */
            .sidebar-overlay { z-index: 2999; }
            
            /* Main content: TRUE full width, no margin */
            .main-content { 
                margin-left: 0 !important; 
                padding: 8px !important; 
                padding-bottom: 80px !important;
                width: 100vw;
                max-width: 100vw;
                box-sizing: border-box;
            }
            
            /* Mobile header: always visible, edge to edge */
            .mobile-header {
                display: flex !important;
                position: sticky; top: 0; z-index: 100;
                background: var(--bg-dark); 
                padding: 10px 12px;
                border-bottom: 1px solid var(--border);
                margin: -8px -8px 8px -8px;
                width: calc(100% + 16px);
            }
            .mobile-header .menu-btn { font-size: 24px; padding: 8px 12px; min-width: 44px; }
            
            /* Quick stats: 2x2 grid, edge to edge */
            .quick-stats { 
                grid-template-columns: 1fr 1fr; gap: 6px; 
                margin: 0 -8px; padding: 0 8px;
            }
            .stat-card { padding: 10px 8px; border-radius: 8px; }
            .stat-card .stat-value { font-size: 20px; }
            .stat-card .stat-label { font-size: 9px; }
            
            /* Department grid: edge to edge */
            .dept-grid { 
                grid-template-columns: 1fr; gap: 8px;
                margin: 0 -8px; padding: 0 8px;
            }
            .dept-card { padding: 12px; border-radius: 8px; }
            
            /* Page containers: edge to edge */
            .page { padding: 0 8px; }
            .page h2 { font-size: 16px; margin-bottom: 8px; }
            .page-header { padding: 8px 0; flex-wrap: wrap; gap: 8px; }
            .page-header h2 { font-size: 16px; }
            .page-header p { font-size: 11px; }
            
            /* Stats grid: 2x2 on mobile */
            .stats-grid { 
                grid-template-columns: 1fr 1fr; 
                gap: 8px; 
                margin-bottom: 10px; 
            }
            .stat-card { padding: 10px; border-radius: 8px; }
            .stat-card .value { font-size: 20px; }
            .stat-card .label { font-size: 10px; }
            .stat-card .sub { font-size: 9px; }
            
            /* Cards: reduce border radius, full width */
            .card, .section-card, .chart-container { 
                border-radius: 8px; 
                margin: 0 0 8px 0;
                padding: 8px;
            }
            
            /* Toolbar: compact horizontal scroll on mobile */
            .toolbar {
                flex-wrap: nowrap; overflow-x: auto; gap: 8px;
                padding: 8px 10px; margin-bottom: 8px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .toolbar::-webkit-scrollbar { display: none; }
            .toolbar .category-filters { 
                display: flex; flex-wrap: nowrap; gap: 4px; 
            }
            .toolbar .category-btn, .toolbar .toolbar-btn { 
                padding: 6px 10px; font-size: 10px; white-space: nowrap; 
                flex-shrink: 0;
            }
            .toolbar input[type="text"] { 
                min-width: 120px; max-width: 150px; 
                padding: 8px 10px; font-size: 13px; 
                flex-shrink: 0;
            }
            .toolbar-spacer { display: none; }
            .toolbar-group { display: flex; gap: 4px; flex-shrink: 0; }
            
            /* Tables: horizontal scroll with touch */
            .scrollable-table {
                max-height: calc(100vh - 250px);
                margin: 0 -12px; padding: 0;
                border-radius: 0;
            }
            
            .data-table { font-size: 11px; min-width: 600px; }
            .data-table th, .data-table td { padding: 10px 8px; white-space: nowrap; }
            .data-table th { font-size: 10px; position: sticky; top: 0; z-index: 2; }
            
            /* Make first column sticky for reference while scrolling horizontally */
            .data-table th:first-child, .data-table td:first-child {
                position: sticky; left: 0; z-index: 3;
                background: var(--bg-card); 
                box-shadow: 2px 0 4px rgba(0,0,0,0.2);
            }
            .data-table th:first-child { z-index: 4; background: var(--bg-dark); }
            
            /* Scroll hint gradient on tables */
            .scrollable-table::after {
                content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 30px;
                background: linear-gradient(to right, transparent, rgba(0,0,0,0.3));
                pointer-events: none; opacity: 0.5;
            }
            
            /* Filter dropdowns */
            .filter-dropdown { min-width: 200px; max-height: 50vh; }
            
            /* Cards and sections */
            .card, .section-card { padding: 12px; margin-bottom: 12px; }
            
            /* Buttons: larger touch targets */
            button, .btn { min-height: 44px; min-width: 44px; font-size: 13px; }
            .btn-sm { min-height: 36px; padding: 8px 12px; }
            
            /* Phil Assistant: TOP HALF on mobile (keyboard-safe) */
            /* NOTE: Don't use 100vh! Keep the 50vh from earlier rule (lines 862-896) for keyboard safety */
            .ai-chat-fab { bottom: 20px; right: 20px; width: 56px; height: 56px; font-size: 26px; }
            .ai-chat-header { padding: 16px; }
            .ai-chat-header .ai-title { font-size: 16px; }
            .ai-chat-messages { padding: 12px; }
            .ai-msg { max-width: 92%; font-size: 14px; padding: 12px 14px; }
            .ai-chat-input-area { padding: 12px; }
            .ai-chat-input-area textarea { font-size: 16px; padding: 12px; } /* 16px prevents iOS zoom */
            .ai-chat-input-area button { min-width: 44px; min-height: 44px; }
            
            /* BOM Explorer */
            .bom-grid { grid-template-columns: 1fr; }
            .bom-selector { max-height: 200px; }
            
            /* Inventory history */
            .inv-history-controls { flex-direction: column; gap: 10px; }
            .inv-history-controls select, .inv-history-controls input { width: 100%; padding: 12px; font-size: 14px; }
            
            /* Charts */
            .chart-container { height: 250px; }
            
            /* Pallet/Photo drilldown */
            .photo-drilldown-grid { grid-template-columns: 1fr !important; }
            .pallet-card { padding: 12px; }
            
            /* Column toggle modal */
            .column-toggle-modal { width: 90vw; max-height: 70vh; }
            
            /* Password modal */
            .password-modal-content { width: 90vw; padding: 20px; }
            .password-modal-content input { font-size: 16px; padding: 14px; }
            
            /* Zoom controls: hide on mobile (pinch to zoom instead) */
            .zoom-controls { display: none; }
            
            /* Data loaded indicator */
            .data-status { font-size: 10px; padding: 8px; }
        }
        
        /* Extra small phones (iPhone SE, mini) */
        @media (max-width: 375px) {
            .quick-stats { grid-template-columns: 1fr; }
            .stat-card .stat-value { font-size: 20px; }
            .toolbar .category-btn { flex: 1 1 45%; }
            .data-table { font-size: 10px; }
            .ai-msg { font-size: 13px; }
        }
        
        /* ============================================================
           LANDSCAPE MODE (Mobile)
           ============================================================ */
        @media (max-width: 900px) and (orientation: landscape) {
            /* HIDE mobile bottom nav in landscape - use sidebar instead */
            .mobile-bottom-nav { display: none !important; }
            .mobile-cards-container { display: none !important; }
            .mobile-filter-bar { display: none !important; }
            .mobile-search-bar { display: none !important; }
            .mobile-inv-controls { display: none !important; }
            .mobile-summary-bar { display: none !important; }
            
            /* Show regular table view */
            .scrollable-table { display: block !important; }
            .chart-container { display: block !important; }
            .toolbar { display: flex !important; }
            .stats-grid { display: grid !important; }
            .page-header { display: flex !important; }
            
            /* IMPORTANT: Show menu button in landscape so user can access sidebar */
            .sidebar-tab { display: block !important; }
            .sidebar-tab.visible { opacity: 1 !important; pointer-events: auto !important; transform: translateX(0) !important; }
            
            /* Sidebar: narrower in landscape, start collapsed by default */
            .sidebar { width: 220px; }
            .sidebar.collapsed { transform: translateX(-100%); }
            
            /* Main content: use all available space */
            .main-content { 
                margin-left: 0 !important; 
                padding: 8px 12px !important;
                padding-bottom: 60px !important;
            }
            
            /* Compact stats in landscape */
            .quick-stats { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .stat-card { padding: 10px; }
            .stat-card .stat-value { font-size: 18px; }
            .stat-card .stat-label { font-size: 9px; }
            
            /* Department cards: horizontal */
            .dept-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .dept-card { padding: 12px; }
            
            /* Charts: shorter in landscape, but tables need auto height */
            .chart-container .chart-wrapper { max-height: 180px; overflow: hidden; }
            .chart-container .chart-wrapper.large { max-height: 200px; }
            
            /* Tables should not be height-restricted */
            .chart-container:has(.scrollable-table) .chart-wrapper { max-height: none; overflow: visible; }
            
            /* Drilldown sections: ensure they clear properly and don't overlap */
            .drilldown-section { clear: both; position: relative; z-index: 10; margin-top: 20px; }
            
            /* Tables: force reasonable height in landscape */
            .scrollable-table { max-height: calc(100vh - 80px) !important; min-height: 200px !important; }
            
            /* Phil Assistant: not full screen in landscape */
            .ai-chat-panel {
                width: 350px !important; 
                height: calc(100vh - 20px) !important;
                max-width: 50vw !important;
                bottom: 10px !important; right: 10px !important;
                border-radius: 12px !important;
            }
            .ai-chat-fab { bottom: 12px; right: 12px; width: 48px; height: 48px; }
            
            /* Hide mobile header title in landscape to save space */
            .mobile-header h1 { display: none; }
            .mobile-header { padding: 6px 12px; }
        }
        
        /* iPhone landscape specifically (shorter height) */
        @media (max-height: 500px) and (orientation: landscape) {
            .quick-stats { grid-template-columns: repeat(4, 1fr); }
            .dept-grid { display: none; } /* Hide dept cards in very short landscape */
            .chart-container { height: 150px; }
            .scrollable-table { max-height: calc(100vh - 60px) !important; min-height: 200px !important; }
            .mobile-header { display: none !important; } /* More space for content */
            .main-content { padding-top: 8px !important; }
        }
        
        /* ============================================================
           iPAD OPTIMIZATION (768px - 1024px)
           ============================================================ */
        
        /* iPad Portrait: Show cards (like iPhone) */
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: portrait) {
            body { --sidebar-width: 240px; }
            
            /* Enable mobile mode for cards */
            body.tablet-portrait .mobile-bottom-nav { display: block !important; }
            body.tablet-portrait .mobile-cards-container { display: flex !important; flex-direction: column; gap: 12px; padding: 12px; }
            body.tablet-portrait .mobile-summary-bar { display: block !important; }
            body.tablet-portrait .scrollable-table { display: none !important; }
            body.tablet-portrait .ai-chat-fab { bottom: 70px !important; }
            body.tablet-portrait .main-content { padding-bottom: 70px !important; padding-top: 50px !important; }
            body.tablet-portrait .chart-container { display: block; max-height: 300px; overflow: hidden; }
            body.tablet-portrait #main canvas { max-width: 200px !important; max-height: 200px !important; }
            body.tablet-portrait .toolbar { display: none; }
            body.tablet-portrait .mobile-filter-bar { display: flex !important; }
            body.tablet-portrait .mobile-search-bar { display: block !important; }
            body.tablet-portrait .orders-queue-toolbar { display: none !important; }
            body.tablet-portrait .ai-chat-fab { display: none !important; }
            body.tablet-portrait .menu-toggle { display: none !important; }
            body.tablet-portrait #orders-staged .toolbar { display: none !important; }
            body.tablet-portrait #orders-staged .stats-grid { display: none !important; }
            body.tablet-portrait #orders-staged .page-header { padding-top: 50px; }
            
            /* Larger cards for iPad */
            body.tablet-portrait .mobile-order-card { padding: 18px; }
            body.tablet-portrait .mobile-card-title { font-size: 18px; }
            body.tablet-portrait .mobile-card-value { font-size: 16px; }
            body.tablet-portrait .mobile-card-value.large { font-size: 22px; }
            body.tablet-portrait .mobile-nav-item { padding: 10px 20px; }
            body.tablet-portrait .mobile-nav-item .nav-icon { font-size: 24px; }
            body.tablet-portrait .mobile-nav-item .nav-label { font-size: 12px; }
            
            /* Sidebar: always collapsed, use overlay */
            .sidebar { transform: translateX(-100%); z-index: 3000; }
            .sidebar.open, .sidebar:not(.collapsed) { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
        }
        
        /* iPad Landscape: Show tables (optimized for touch) */
        @media (min-width: 1025px) and (max-width: 1400px),
               (min-width: 481px) and (max-width: 1024px) and (orientation: landscape) {
            /* HIDE mobile bottom nav in landscape - use sidebar instead */
            .mobile-bottom-nav { display: none !important; }
            .mobile-cards-container { display: none !important; }
            .mobile-filter-bar { display: none !important; }
            .mobile-search-bar { display: none !important; }
            .mobile-inv-controls { display: none !important; }
            .mobile-summary-bar { display: none !important; }
            
            /* Touch-friendly tables */
            .data-table th, .data-table td { 
                padding: 14px 12px; 
                font-size: 14px; 
            }
            .data-table th { font-size: 12px; }
            
            /* Larger buttons */
            button, .btn, .toolbar-btn, .category-btn { 
                min-height: 44px; 
                padding: 10px 16px; 
                font-size: 14px; 
            }
            
            /* Better touch scrolling */
            .scrollable-table {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Sidebar: visible but narrower */
            .sidebar { width: 220px; }
            .main-content { margin-left: 220px; }
            
            /* Stats grid */
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .stat-card { padding: 16px; }
            .stat-card .value { font-size: 24px; }
            
            /* Search boxes larger */
            input[type="text"].search-box { 
                padding: 12px 16px; 
                font-size: 15px; 
                min-width: 200px; 
            }
            
            /* Row hover: more visible on touch */
            .data-table tbody tr:active { 
                background: rgba(49,130,206,0.2) !important; 
            }
        }
        
        /* iPad Pro / Large tablets */
        @media (min-width: 1025px) and (max-width: 1400px) {
            .sidebar { width: 240px; }
            .main-content { margin-left: 240px; }
        }
        
        /* ============================================================
           MOBILE MODE - Card-based views
           ============================================================ */
        
        /* Bottom Navigation Bar */
        .mobile-bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-top: 1px solid var(--border);
            padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 2000; box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        .mobile-bottom-nav-inner {
            display: flex; justify-content: space-around; align-items: center;
            max-width: 500px; margin: 0 auto;
        }
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center;
            padding: 6px 12px; border-radius: 8px; cursor: pointer;
            transition: all 0.2s; color: var(--text-secondary); text-decoration: none;
            min-width: 60px;
        }
        .mobile-nav-item:hover, .mobile-nav-item.active {
            background: rgba(49,130,206,0.15); color: var(--accent);
        }
        .mobile-nav-item .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .mobile-nav-item .nav-label { font-size: 10px; font-weight: 600; }
        
        /* QR Share Modal */
        .qr-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .qr-modal-content {
            background: var(--bg-card); border-radius: 16px;
            padding: 20px; max-width: 320px; width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
        }
        .qr-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
        }
        .qr-modal-header h3 { margin: 0; font-size: 18px; color: var(--text); }
        .qr-close-btn {
            background: none; border: none; font-size: 28px; cursor: pointer;
            color: var(--text-muted); padding: 0; line-height: 1;
        }
        .qr-close-btn:hover { color: var(--danger); }
        .qr-modal-body { padding: 10px 0; }
        
        /* Order Cards */
        .mobile-cards-container {
            display: none; flex-direction: column; gap: 10px;
            padding: 10px; padding-bottom: 80px;
        }
        .mobile-order-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 14px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .mobile-order-card.urgent {
            border-left: 4px solid var(--danger);
            background: linear-gradient(90deg, rgba(229,62,62,0.1) 0%, var(--bg-card) 20%);
        }
        .mobile-order-card.overdue {
            border-left: 4px solid var(--warning);
            background: linear-gradient(90deg, rgba(214,158,46,0.1) 0%, var(--bg-card) 20%);
        }
        .mobile-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 10px;
        }
        .mobile-card-title {
            font-size: 16px; font-weight: 700; color: var(--text-primary);
        }
        .mobile-card-subtitle {
            font-size: 12px; color: var(--text-secondary); margin-top: 2px;
        }
        .mobile-card-badge {
            padding: 4px 10px; border-radius: 12px; font-size: 10px;
            font-weight: 700; text-transform: uppercase;
        }
        .mobile-card-badge.urgent { background: var(--danger); color: white; }
        .mobile-card-badge.staged { background: var(--success); color: white; }
        .mobile-card-badge.wip { background: var(--warning); color: black; }
        .mobile-card-badge.pending { background: var(--accent); color: white; }
        .mobile-card-body {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .mobile-card-field {
            display: flex; flex-direction: column;
        }
        .mobile-card-field.full-width { grid-column: 1 / -1; }
        .mobile-card-label {
            font-size: 10px; color: var(--text-secondary); 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .mobile-card-value {
            font-size: 14px; font-weight: 600; color: var(--text-primary);
        }
        .mobile-card-value.large { font-size: 18px; }
        .mobile-card-value.danger { color: var(--danger); }
        .mobile-card-value.success { color: var(--success); }
        .mobile-card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);
        }
        .mobile-card-date {
            font-size: 11px; color: var(--text-secondary);
        }
        .mobile-card-date.overdue { color: var(--danger); font-weight: 600; }
        
        /* Mobile mode summary cards */
        .mobile-summary-bar {
            display: none; padding: 12px; background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
        }
        /* Old mobile-lang-toggle removed - now in bottom nav */
        .mobile-summary-stats {
            display: flex; justify-content: space-around; text-align: center;
        }
        .mobile-summary-stat .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .mobile-summary-stat .stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        
        /* Mobile filter chips */
        .mobile-filter-bar {
            display: none; padding: 10px; overflow-x: auto;
            -webkit-overflow-scrolling: touch; white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }
        .mobile-filter-chip {
            display: inline-block; padding: 8px 14px; margin-right: 8px;
            background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 20px; font-size: 12px; cursor: pointer;
        }
        .mobile-filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        /* Mobile search bar */
        .mobile-search-bar {
            display: none; padding: 10px 12px; border-bottom: 1px solid var(--border);
        }
        .mobile-search-bar input {
            width: 100%; padding: 10px 14px; border-radius: 8px;
            background: var(--bg-dark); border: 1px solid var(--border);
            color: white; font-size: 14px;
        }
        .mobile-search-bar input::placeholder { color: var(--text-secondary); }
        .mobile-search-bar input:focus { outline: none; border-color: var(--accent); }
        
        /* Mobile photo modal */
        .mobile-photo-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark); z-index: 5000; flex-direction: column;
        }
        .mobile-photo-modal.active { display: flex; }
        .mobile-photo-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--primary); color: white;
            border-bottom: 1px solid var(--border);
        }
        .mobile-photo-modal-body {
            flex: 1; overflow-y: auto; padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        .mobile-photo-section { margin-bottom: 24px; }
        .mobile-photo-section h4 { 
            font-size: 14px; margin-bottom: 12px; color: var(--text-primary);
            padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .mobile-photo-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .mobile-photo-grid img {
            width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px;
            border: 2px solid var(--border); cursor: pointer;
        }
        .mobile-photo-grid img:active { opacity: 0.7; }
        
        /* Show mobile elements on small screens */
        @media (max-width: 480px) {
            body.mobile-mode .mobile-bottom-nav { display: block; }
            body.mobile-mode .mobile-cards-container { display: flex; }
            body.mobile-mode .mobile-summary-bar { display: block; }
            body.mobile-mode .mobile-filter-bar { display: flex; }
            body.mobile-mode .mobile-search-bar { display: block; }
            body.mobile-mode .orders-queue-toolbar { display: none !important; }
            body.mobile-mode .ai-chat-fab { display: none !important; }
            body.mobile-mode .menu-toggle { display: none !important; }
            body.mobile-mode #orders-staged .toolbar { display: none !important; }
            body.mobile-mode #orders-staged .stats-grid { display: none !important; }
            body.mobile-mode #orders-staged .page-header { padding-top: 50px; }
            /* HIDE tables when cards are active - cards take priority */
            body.mobile-mode .page.has-card-view .scrollable-table { display: none !important; }
            body.mobile-mode .page.has-card-view .chart-container { display: none !important; }
            /* Show tables only on pages without card views */
            body.mobile-mode .page:not(.has-card-view) .scrollable-table { 
                display: block; 
                max-height: calc(100vh - 200px);
                margin: 0;
                border-radius: 0;
            }
            body.mobile-mode .chart-container .chart-header { padding: 8px 12px; }
            body.mobile-mode .ai-chat-fab { bottom: 70px; }
            body.mobile-mode .main-content { padding-bottom: 70px !important; }
        }
        
        /* Rotate message for pages without card view */
        .mobile-rotate-message {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            min-height: 50vh;
        }
        .mobile-rotate-message .rotate-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: rotateHint 2s ease-in-out infinite;
        }
        @keyframes rotateHint {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        .mobile-rotate-message h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        .mobile-rotate-message p {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 280px;
        }
        @media (max-width: 480px) {
            body.mobile-mode .page:not(.has-card-view) .mobile-rotate-message { display: flex; }
            body.mobile-mode .page:not(.has-card-view) .scrollable-table { display: none !important; }
            body.mobile-mode .page:not(.has-card-view) .chart-container { display: none !important; }
            body.mobile-mode .page:not(.has-card-view) .toolbar { display: none !important; }
            body.mobile-mode .page:not(.has-card-view) .stats-grid { display: none !important; }
            
            /* Hide main dashboard content on mobile (Orders is default) */
            body.mobile-mode #main.page.active .quick-stats,
            body.mobile-mode #main.page.active .dept-grid,
            body.mobile-mode #main.page.active .grid-2,
            body.mobile-mode #main.page.active .page-header { display: none !important; }
            
            /* Hide inventory toolbar and stats on mobile (use mobile controls instead) */
            body.mobile-mode #inventory .toolbar { display: none !important; }
            body.mobile-mode #inventory .page-header { display: none !important; }
            body.mobile-mode #inventory .stats-grid { display: none !important; }
            body.mobile-mode #inventory .chart-container { display: none !important; }
            body.mobile-mode .mobile-inv-controls { display: block !important; }
        }
        
        /* Mobile inventory controls */
        .mobile-inv-controls {
            display: none;
            padding: 10px;
            background: var(--bg-dark);
        }
        .mobile-inv-controls .mobile-search-bar { margin-bottom: 10px; }
        .mobile-inv-controls .mobile-filter-bar { justify-content: flex-start; }
        body.tablet-portrait .mobile-inv-controls { display: block !important; }
        body.tablet-portrait #inventory .toolbar { display: none !important; }
        body.tablet-portrait #inventory .page-header { display: none !important; }
        body.tablet-portrait #inventory .stats-grid { display: none !important; }
        body.tablet-portrait #inventory .chart-container { display: none !important; }
    </style>
</head>
<body>
    <!-- Image Modal for Pallet Pictures -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <div class="image-modal-close" onclick="closeImageModal()">âœ•</div>
        <img id="modalImage" src="" alt="Pallet Picture">
    </div>

    <!-- Column Filter Dropdown Modal -->
    <div class="filter-dropdown" id="columnFilterDropdown">
        <div class="filter-dropdown-header">
            <h4 id="filterDropdownTitle" data-i18n="ui.filterColumn">Filter Column</h4>
            <button onclick="closeFilterDropdown()">âœ•</button>
        </div>
        <input type="text" class="filter-search" id="filterDropdownSearch" data-i18n-placeholder="ui.searchValues" placeholder="Search values..." oninput="filterDropdownSearch()">
        <div class="filter-actions">
            <button onclick="filterSelectAll()" data-i18n="ui.selectAll">Select All</button>
            <button onclick="filterDeselectAll()" data-i18n="ui.deselectAll">Deselect All</button>
        </div>
        <div class="filter-values-list" id="filterValuesList"></div>
        <div class="filter-dropdown-footer">
            <button class="clear-btn" onclick="clearColumnFilter()" data-i18n="ui.clear">Clear</button>
            <button class="hide-col-btn" onclick="hideCurrentColumn()" style="background:var(--bg-dark);border-color:var(--border);" data-i18n="ui.hideColumn">ðŸ‘ Hide</button>
            <button class="apply-btn" onclick="applyColumnFilter()" data-i18n="ui.apply">Apply</button>
        </div>
    </div>

    <!-- Column Toggle Dropdown Modal -->
    <div class="column-toggle-overlay" id="columnToggleOverlay" onclick="closeColumnToggle()"></div>
    <div class="column-toggle-dropdown" id="columnToggleDropdown">
        <div class="column-toggle-header">
            <h4>âš™ï¸ <span data-i18n="ui.columns">Columns</span></h4>
            <button onclick="closeColumnToggle()">âœ•</button>
        </div>
        <div class="column-toggle-actions">
            <button onclick="columnSelectAll()" data-i18n="ui.selectAll">Select All</button>
            <button onclick="columnDeselectAll()" data-i18n="ui.deselectAll">Deselect All</button>
        </div>
        <div class="column-toggle-list" id="columnToggleList"></div>
    </div>

    <!-- Password Modal -->
    <div class="password-modal-overlay" id="passwordModalOverlay" onclick="closePasswordModal()"></div>
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-header">
            <h4>ðŸ”’ <span data-i18n="nav.salesFinance">Sales & Finance</span></h4>
            <button onclick="closePasswordModal()">âœ•</button>
        </div>
        <div class="password-modal-body">
            <p style="margin:0 0 12px;color:var(--text-secondary);font-size:13px;">Enter password to access this section:</p>
            <input type="password" id="salesPasswordInput" class="password-input" placeholder="Password" onkeyup="handlePasswordKeyup(event)">
            <div id="passwordError" class="password-error"></div>
        </div>
        <div class="password-modal-footer">
            <button onclick="closePasswordModal()" class="password-cancel-btn">Cancel</button>
            <button onclick="submitSalesPassword()" class="password-submit-btn">Unlock</button>
        </div>
    </div>

    <!-- Inventory History Modal -->
    <div class="history-modal-overlay" id="inventoryHistoryModal" onclick="closeInventoryHistoryModal(event)">
        <div class="history-modal" onclick="event.stopPropagation()">
            <div class="history-modal-header">
                <h3>ðŸ“ˆ <span data-i18n="inv.historyTitle">Inventory History</span>: <span id="historyPartName"></span></h3>
                <button class="history-modal-close" onclick="closeInventoryHistoryModal()">âœ•</button>
            </div>
            <div class="history-modal-body">
                <div class="history-chart-container">
                    <canvas id="inventoryHistoryChart"></canvas>
                </div>
                <div class="history-controls">
                    <div class="history-date-inputs">
                        <div class="history-date-group">
                            <label data-i18n="ui.from">From</label>
                            <input type="date" id="historyStartDate" onchange="updateHistoryChart()">
                        </div>
                        <div class="history-date-group">
                            <label data-i18n="ui.to">To</label>
                            <input type="date" id="historyEndDate" onchange="updateHistoryChart()">
                        </div>
                    </div>
                    <div class="history-presets">
                        <button onclick="applyHistoryPreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                        <button onclick="applyHistoryPreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                        <button onclick="applyHistoryPreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                        <button onclick="applyHistoryPreset('all')" data-i18n="inv.allData">All Data</button>
                    </div>
                </div>
                <div class="history-stats" id="historyStatsPanel">
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatCurrent">-</div>
                        <div class="history-stat-label" data-i18n="inv.current">Current</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMin">-</div>
                        <div class="history-stat-label" data-i18n="inv.minimum">Minimum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMax">-</div>
                        <div class="history-stat-label" data-i18n="inv.maximum">Maximum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatAvg">-</div>
                        <div class="history-stat-label" data-i18n="inv.average">Average</div>
                    </div>
                </div>
                <div class="history-stats usage-stats" id="historyUsagePanel" style="display:none;">
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyUsage7">-</div>
                        <div class="history-stat-label">7-Day Avg Usage<br><small>/day</small></div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyUsage30">-</div>
                        <div class="history-stat-label">30-Day Avg Usage<br><small>/day</small></div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyDaysToMin">-</div>
                        <div class="history-stat-label">Days to Minimum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyDaysToZero">-</div>
                        <div class="history-stat-label">Days to Zero</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyUsageTrend">-</div>
                        <div class="history-stat-label">Usage Trend</div>
                    </div>
                </div>
                <div class="history-loading" id="historyLoading" style="display:none;">
                    <span data-i18n="ui.loading">Loading...</span>
                </div>
                <div class="history-no-data" id="historyNoData" style="display:none;">
                    <span data-i18n="inv.noHistory">No history data available for this part</span>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-header">
        <div><h1>Molding</h1><span style="font-size:10px;color:var(--text-secondary);">Operations Dashboard</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-tab" id="sidebarTabBtn" onclick="toggleSidebar()" title="Show Menu">â˜° Menu</button>
    <div class="sidebar" id="mainSidebar">
        <div class="logo">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div><h1>Molding</h1><span id="logoSubtitle">Operations Dashboard</span></div>
                <button id="sidebarToggleBtn" onclick="toggleSidebar()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:var(--text-secondary);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">âœ• Hide</button>
            </div>
        </div>
        <div class="toggle-controls">
            <div class="lang-toggle">
                <button class="lang-btn active" id="langEN" onclick="setLanguage('en')">English</button>
                <button class="lang-btn" id="langES" onclick="setLanguage('es')">EspaÃ±ol</button>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn" id="themeDark" onclick="setTheme('dark')" title="Dark Theme">ðŸŒ™</button>
                <button class="theme-btn" id="themeLight" onclick="setTheme('light')" title="Light Theme">â˜€ï¸</button>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-item active" data-page="main" onclick="navigateTo('main')"><span class="icon">ðŸ </span> <span data-i18n="nav.main">Main Dashboard</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.production">Production</div>
            <div class="nav-item" data-page="orders-data" onclick="navigateTo('orders-data')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.ordersData">Orders Data</span></div>
            <div class="nav-item sub-item" data-page="production-make" onclick="navigateTo('production-make')"><span class="icon">ðŸ­</span> <span data-i18n="nav.productionMake">Need to Make</span></div>
            <div class="nav-item sub-item" data-page="orders-queue" onclick="navigateTo('orders-queue')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.ordersQueue">Need to Package</span></div>
            <div class="nav-item sub-item" data-page="orders-staged" onclick="navigateTo('orders-staged')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.ordersStaged">Ready to Ship</span></div>
            <div class="nav-item sub-item" data-page="orders-shipped" onclick="navigateTo('orders-shipped')"><span class="icon">ðŸšš</span> <span data-i18n="nav.ordersShipped">Shipped</span></div>
            <div class="nav-item" data-page="inventory" onclick="navigateTo('inventory')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.inventory">Inventory</span></div>
            <div class="nav-item sub-item" data-page="inventory-history" onclick="navigateTo('inventory-history')"><span class="icon">ðŸ“ˆ</span> <span data-i18n="nav.inventoryHistory">Inventory History</span></div>
            <div class="nav-item sub-item" data-page="material-requirements" onclick="navigateTo('material-requirements')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.materialReq">Material Requirements</span></div>
            <div class="nav-item sub-item" data-page="drawings-library" onclick="navigateTo('drawings-library')"><span class="icon">ðŸ“</span> <span data-i18n="nav.drawingsLibrary">Drawings</span></div>
            <div class="nav-item" data-page="pallet-records" onclick="navigateTo('pallet-records')"><span class="icon">ðŸ“·</span> <span data-i18n="nav.palletRecords">Pallet Records</span></div>
            <div class="nav-item" data-page="shipping-records" onclick="navigateTo('shipping-records')"><span class="icon">ðŸš›</span> <span data-i18n="nav.shippingRecords">Shipping Records</span></div>
            <div class="nav-item" data-page="staged-records" onclick="navigateTo('staged-records')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.stagedRecords">Staged Records</span></div>
        </div>
        <div class="nav-section" id="salesNavSection">
            <div class="nav-section-title sales-locked" id="salesNavTitle" onclick="promptSalesPassword()">
                <span class="lock-icon">ðŸ”’</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>
            </div>
            <div class="sales-nav-items" id="salesNavItems" style="display:none;">
                <div class="nav-item" data-page="sales-overview" onclick="navigateTo('sales-overview')"><span class="icon">ðŸ“Š</span> <span data-i18n="nav.plOverview">P/L Overview</span></div>
                <div class="nav-item sub-item" data-page="sales-parts" onclick="navigateTo('sales-parts')"><span class="icon">ðŸ”§</span> <span data-i18n="nav.byPart">By Part Number</span></div>
                <div class="nav-item sub-item" data-page="sales-customers" onclick="navigateTo('sales-customers')"><span class="icon">ðŸ‘¥</span> <span data-i18n="nav.byCustomer">By Customer</span></div>
                <div class="nav-item sub-item" data-page="sales-dates" onclick="navigateTo('sales-dates')"><span class="icon">ðŸ“…</span> <span data-i18n="nav.byDate">By Date</span></div>
            </div>
        </div>
        <div class="nav-section" id="bomNavSection" style="display:none;">
            <div class="nav-section-title" data-i18n="nav.billOfMaterials">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.bomExplorer">BOM Explorer</span></div>
        </div>
        <div class="nav-section" id="rawDataNavSection">
            <div class="nav-section-title" data-i18n="nav.rawData">Raw Data</div>
            <div class="nav-item locked-item" id="allDataNavItem" data-page="all-data" onclick="handleAllDataClick()"><span class="icon">ðŸ—ƒ</span> <span data-i18n="nav.allData">All Data</span></div>
            <div class="nav-item locked-item" id="fpRefNavItem" data-page="fp-reference" onclick="handleRefDataClick('fp-reference')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.fpReference">FP Reference</span></div>
            <div class="nav-item locked-item" id="custRefNavItem" data-page="customer-reference" onclick="handleRefDataClick('customer-reference')"><span class="icon">ðŸ‘¥</span> <span data-i18n="nav.customerReference">Customer Reference</span></div>
            <div class="nav-item locked-item" id="quotesNavItem" data-page="quotes-registry" onclick="handleRefDataClick('quotes-registry')"><span class="icon">ðŸ“</span> <span data-i18n="nav.quotesRegistry">Quotes Registry</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-item" onclick="toggleAiChat()" style="background:linear-gradient(135deg,rgba(66,133,244,0.15),rgba(52,168,83,0.1));"><span class="icon">ðŸ¤–</span> <span data-i18n="nav.aiAssistant">Phil Assistant</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="zoom-controls">
            <label style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block;" data-i18n="ui.zoom">Zoom</label>
            <div style="display:flex;align-items:center;gap:6px;">
                <button class="zoom-btn" onclick="adjustZoom(-10)">âˆ’</button>
                <input type="number" id="zoomInput" value="100" min="50" max="200" step="10" onchange="setZoom(this.value)" style="width:50px;text-align:center;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:white;padding:4px;font-size:11px;">
                <span style="font-size:10px;color:var(--text-secondary);">%</span>
                <button class="zoom-btn" onclick="adjustZoom(10)">+</button>
            </div>
            <button class="zoom-reset-btn" onclick="resetZoom()" data-i18n="ui.reset">Reset (100%)</button>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
        <div style="color:#718096;font-size:10px;margin-top:8px;text-align:center;">Dashboard v7.31.0</div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading"><div class="spinner"></div><p style="margin-top:18px;color:var(--text-secondary);" data-i18n="loading">Loading data from Google Sheets...</p></div>

        <!-- MAIN DASHBOARD -->
        <div id="main" class="page has-card-view">
            <div class="page-header">
                <div><h2 data-i18n="main.title">Operations Dashboard</h2><p data-i18n="main.subtitle">Real-time overview of manufacturing operations</p></div>
                <div class="last-updated"><span class="dot"></span><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="quick-stats">
                <div class="quick-stat"><div class="value warning" id="qsNeedToMake">-</div><div class="label" data-i18n="stats.needToMake">Need to Make</div></div>
                <div class="quick-stat"><div class="value" id="qsUrgentOrders">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                <div class="quick-stat"><div class="value" id="qsTotalQty">-</div><div class="label" data-i18n="stats.totalUnits">Total Units</div></div>
                <div class="quick-stat"><div class="value warning" id="qsMissingComponents">-</div><div class="label" data-i18n="stats.missingParts">Missing Parts</div></div>
            </div>
            <div class="dept-grid">
                <div class="dept-card production" onclick="navigateTo('orders-queue')">
                    <div class="icon-large">ðŸ­</div>
                    <h3 data-i18n="dept.production">Production Planning</h3>
                    <p data-i18n="dept.productionDesc">View orders to make, component status, and production queue</p>
                    <div class="metrics">
                        <div class="metric"><div class="value" id="deptProdOrders">-</div><div class="label" data-i18n="dept.needToMake">Need to Make</div></div>
                        <div class="metric"><div class="value" id="deptProdUnits">-</div><div class="label" data-i18n="dept.units">Units</div></div>
                        <div class="metric"><div class="value warning" id="deptProdUrgent">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                    </div>
                </div>
                <div class="dept-card inventory" onclick="navigateTo('inventory')">
                    <div class="icon-large">ðŸ“¦</div>
                    <h3 data-i18n="dept.inventory">Inventory Management</h3>
                    <p data-i18n="dept.inventoryDesc">Stock levels, reorder points, and material tracking</p>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.ordersByStatus">Orders by Status</h3></div>
                    <div class="chart-wrapper"><canvas id="mainStatusChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.upcomingDeadlines">Upcoming Deadlines (Next 14 Days)</h3></div>
                    <div class="chart-wrapper"><canvas id="mainDeadlineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ORDERS DATA PAGE -->
        <div id="orders-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersData.title">All Orders Data</h2><p data-i18n="ordersData.subtitle">Complete order database with all statuses</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â†  <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersDataBtnRollTech" onclick="toggleOrdersDataCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersDataBtnMolding" onclick="toggleOrdersDataCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersDataBtnSnapPad" onclick="toggleOrdersDataCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group status-filters">
                    <label data-i18n="ui.status">Status:</label>
                    <button class="status-btn pending active" id="ordersDataStatusPending" onclick="toggleOrdersDataStatus('pending')"><span data-i18n="status.needToMake">Need to Make</span></button>
                    <button class="status-btn wip active" id="ordersDataStatusWip" onclick="toggleOrdersDataStatus('wip')"><span data-i18n="status.making">Making</span></button>
                    <button class="status-btn staged active" id="ordersDataStatusStaged" onclick="toggleOrdersDataStatus('staged')"><span data-i18n="status.readyToShip">Ready to Ship</span></button>
                    <button class="status-btn shipped" id="ordersDataStatusShipped" onclick="toggleOrdersDataStatus('shipped')"><span data-i18n="status.shipped">Shipped</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersDataClearFiltersBtn" onclick="clearAllTableFilters('ordersData')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersDataColumnsBtn" onclick="openColumnToggle('ordersData')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersDataSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersDataTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportOrdersDataToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportOrdersDataToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalOrders">Total Orders</div><div class="value" id="ordersDataTotalOrders">-</div><div class="sub" id="ordersDataTotalUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needToMake">Need to Make</div><div class="value warning" id="ordersDataNeedToMake">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.making">Making</div><div class="value" style="color:var(--teal);" id="ordersDataMaking">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.readyToShip">Ready to Ship</div><div class="value positive" id="ordersDataReadyToShip">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.orders">Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersDataTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="ordersDataTable"><thead><tr id="ordersDataTableHeader"></tr></thead><tbody id="ordersDataTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- PRODUCTION MAKE PAGE (Parts to be manufactured) -->
        <div id="production-make" class="page">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px;gap:8px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <button class="category-btn" id="prodMakeBtnTire" onclick="toggleProdMakeCategory('Tire')" style="padding:4px 10px;font-size:11px;background:#ed8936;"><span class="indicator"></span> Tires</button>
                    <button class="category-btn" id="prodMakeBtnHub" onclick="toggleProdMakeCategory('Hub')" style="padding:4px 10px;font-size:11px;background:#38b2ac;"><span class="indicator"></span> Hubs</button>
                    <button class="category-btn" id="prodMakeBtnFinished" onclick="toggleProdMakeCategory('Rubber molded finished part')" style="padding:4px 10px;font-size:11px;background:#805ad5;"><span class="indicator"></span> Finished Parts</button>
                    <button class="category-btn" id="prodMakeBtnBearing" onclick="toggleProdMakeCategory('Bearing')" style="padding:4px 10px;font-size:11px;background:#4a5568;"><span class="indicator"></span> Bearings</button>
                    <button class="category-btn active" id="prodMakeBtnAll" onclick="toggleProdMakeCategory('all')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> All</button>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);">Total Parts:</span> <strong id="prodMakeTotalParts" style="font-size:14px;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="prodMakeTotalUnits">-</span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <input type="text" class="search-box" id="prodMakeSearch" placeholder="Search part #, mold type..." oninput="filterProdMakeTable()" style="width:180px;padding:4px 8px;font-size:12px;">
                    <button class="toolbar-btn clear-all-filters-btn" id="prodMakeClearFiltersBtn" onclick="clearAllTableFilters('prodMake')" style="padding:4px 8px;font-size:11px;">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                    <button class="toolbar-btn columns-btn" id="prodMakeColumnsBtn" onclick="openColumnToggle('prodMake')" style="padding:4px 8px;font-size:11px;">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                    <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)" style="padding:4px 8px;font-size:11px;">ðŸ“¥ â–¾</button><div class="export-dropdown-content"><a onclick="exportProdMakeToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportProdMakeExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                    <button class="toolbar-btn" onclick="navigateTo('main')" style="padding:4px 8px;font-size:11px;">â† Back</button>
                </div>
            </div>
            <div class="chart-container" style="margin:0 8px;">
                <div class="chart-header" style="padding:4px 12px;">
                    <h3 style="font-size:13px;">ðŸ­ Parts to Manufacture</h3>
                    <span style="color:var(--text-secondary);font-size:11px;" id="prodMakeTableCount">-</span>
                </div>
                <div class="scrollable-table" style="max-height:calc(100vh - 120px);">
                    <table class="data-table" id="prodMakeTable" style="font-size:12px;">
                        <thead>
                            <tr id="prodMakeTableHeader">
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('product')">Product â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('partNumber')">Part # â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('moldType')">Mold Type â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('fusionInventory')">Fusion Inv â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('minimums')">Minimums â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('partsToBeMade')">Parts to Make â†•</th>
                                <th>ðŸ“ Drawing</th>
                            </tr>
                        </thead>
                        <tbody id="prodMakeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ORDERS QUEUE PAGE (Need to Package) -->
        <div id="orders-queue" class="page has-card-view">
            <div class="orders-queue-toolbar" style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px;gap:8px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <button class="category-btn rolltech active" id="ordersQueueBtnRollTech" onclick="toggleOrdersQueueCategory('rolltech')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersQueueBtnMolding" onclick="toggleOrdersQueueCategory('molding')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersQueueBtnSnapPad" onclick="toggleOrdersQueueCategory('snappad')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.totalOrders">Total</span> <strong id="ordersQueueTotalOrders" style="font-size:14px;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="ordersQueueTotalUnits">-</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:#fc8181;">ðŸ”´</span> <strong id="ordersQueueUrgentCount" style="font-size:14px;color:#fc8181;">-</strong> <span style="font-size:11px;color:#fc8181;" data-i18n="stats.urgent">Urgent</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.dueThisWeek">Due This Week</span> <strong id="ordersQueueDueWeek" style="font-size:14px;color:#ecc94b;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="ordersQueueDueWeekUnits">-</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.componentsReady">Ready</span> <strong id="ordersQueueComponentsReady" style="font-size:14px;color:#48bb78;">-</strong>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <button class="toolbar-btn clear-all-filters-btn" id="ordersQueueClearFiltersBtn" onclick="clearAllTableFilters('ordersQueue')" style="padding:4px 8px;font-size:11px;">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear</span></button>
                    <button class="toolbar-btn columns-btn" id="ordersQueueColumnsBtn" onclick="openColumnToggle('ordersQueue')" style="padding:4px 8px;font-size:11px;">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                    <input type="text" class="search-box" id="ordersQueueSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersQueueTable()" style="width:140px;padding:4px 8px;font-size:12px;">
                    <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)" style="padding:4px 8px;font-size:11px;">ðŸ“¥ â–¾</button><div class="export-dropdown-content"><a onclick="exportOrdersQueueToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportOrdersQueueExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                    <button class="toolbar-btn" onclick="navigateTo('main')" style="padding:4px 8px;font-size:11px;">â† Back</button>
                </div>
            </div>
            <div class="info-banner warning" id="ordersQueueMissingBanner" style="margin:0 16px 4px;">
                <span class="icon">âš  </span>
                <p><strong id="ordersQueueMissingCount">0</strong> <span data-i18n="prod.missingMsg">orders have missing components.</span></p>
            </div>
            <div style="display:none;"><span id="ordersQueueLastUpdated">-</span></div>
            
            <!-- Mobile Summary Bar -->
            <div class="mobile-summary-bar">
                <div class="mobile-summary-stats">
                    <div class="mobile-summary-stat">
                        <div class="stat-value" id="mobileOrdersCount">-</div>
                        <div class="stat-label">Orders</div>
                    </div>
                    <div class="mobile-summary-stat">
                        <div class="stat-value" style="color:var(--danger);" id="mobileUrgentCount">-</div>
                        <div class="stat-label">Urgent</div>
                    </div>
                    <div class="mobile-summary-stat">
                        <div class="stat-value" style="color:var(--warning);" id="mobileDueCount">-</div>
                        <div class="stat-label">Due This Week</div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Search Bar -->
            <div class="mobile-search-bar">
                <input type="text" id="mobileSearchInput" placeholder="ðŸ” Search orders..." oninput="mobileSearchOrders(this.value)">
            </div>
            
            <!-- Mobile Filter Chips -->
            <div class="mobile-filter-bar">
                <span class="mobile-filter-chip active" onclick="mobileFilterOrders('all')">All Active</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('urgent')">ðŸ”´ Urgent</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('due-week')">ðŸ“… Due This Week</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('staged')">ðŸ“¦ Staged</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('shipped')">ðŸšš Shipped</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('rolltech')">ðŸ”µ Roll Tech</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('molding')">ðŸŸ¡ Molding</span>
                <span class="mobile-filter-chip" onclick="mobileFilterOrders('snappad')">ðŸŸ£ Snap Pad</span>
            </div>
            
            <!-- Mobile Cards Container -->
            <div class="mobile-cards-container" id="mobileCardsContainer"></div>
            
            <div class="chart-container" style="margin:0 8px;">
                <div class="chart-header" style="padding:4px 12px;"><h3 data-i18n="table.ordersToMake" style="font-size:13px;">Orders to Make</h3><span style="color:var(--text-secondary);font-size:11px;" id="ordersQueueTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 100px);">
                    <table class="data-table" style="font-size:12px;"><thead><tr id="ordersQueueTableHeader"></tr></thead><tbody id="ordersQueueTableBody"></tbody></table>
                </div>
            </div>
        </div>
        <!-- ORDERS STAGED PAGE -->
        <div id="orders-staged" class="page has-card-view">
            <div class="page-header">
                <div><h2 data-i18n="ordersStaged.title">Staged Orders - Ready to Ship</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersStagedBtnRollTech" onclick="toggleOrdersStagedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersStagedBtnMolding" onclick="toggleOrdersStagedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersStagedBtnSnapPad" onclick="toggleOrdersStagedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersStagedClearFiltersBtn" onclick="clearAllTableFilters('ordersStaged')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersStagedColumnsBtn" onclick="openColumnToggle('ordersStaged')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersStagedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersStagedTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportOrdersStagedToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportOrdersStagedToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.stagedOrders">Staged Orders</div><div class="value" id="ordersStagedTotalOrders">-</div><div class="sub" id="ordersStagedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersStagedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.avgOrderValue">Avg Order Value</div><div class="value" id="ordersStagedAvgValue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersStagedCustomers">-</div></div>
            </div>
            <!-- Mobile Search & Filter for Staged -->
            <div class="mobile-search-bar mobile-staged-controls">
                <input type="text" id="mobileStagedSearchInput" placeholder="ðŸ” Search staged orders..." oninput="mobileSearchStaged(this.value)">
            </div>
            <div class="mobile-filter-bar mobile-staged-controls">
                <span class="mobile-filter-chip active" onclick="mobileFilterStaged('all')">All</span>
                <span class="mobile-filter-chip" onclick="mobileFilterStaged('rolltech')">ðŸ”µ Roll Tech</span>
                <span class="mobile-filter-chip" onclick="mobileFilterStaged('molding')">ðŸŸ¡ Molding</span>
                <span class="mobile-filter-chip" onclick="mobileFilterStaged('snappad')">ðŸŸ£ Snap Pad</span>
            </div>
            <!-- Mobile Cards Container for Staged -->
            <div class="mobile-cards-container" id="mobileStagedCardsContainer"></div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.readyToShip">Ready to Ship</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersStagedTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table"><thead><tr id="ordersStagedTableHeader"></tr></thead><tbody id="ordersStagedTableBody"></tbody></table>
                </div>
            </div>

            <!-- PALLET LOAD CALCULATOR SECTION -->
            <div class="plc-section">
                <button class="plc-toggle-btn" id="plcToggleBtn" onclick="plcToggle()">
                    <span style="font-size:20px;">ðŸ“¦</span>
                    <span id="plcToggleText">Pallet Load Calculator</span>
                    <span id="plcToggleArrow" style="font-size:12px;">â–¼</span>
                </button>
                <div class="plc-container" id="plcContainer">
                    <div class="plc-layout">
                        <!-- LEFT PANEL: Controls -->
                        <div class="plc-controls">
                            <div class="plc-card">
                                <div class="plc-card-title" id="plcTrailerTitle">Trailer Type</div>
                                <div class="plc-trailer-toggle">
                                    <button class="plc-trailer-btn active" data-plc-len="53" onclick="plcSelectTrailer(53)"><span class="size">53'</span><span class="label" id="plcVanLabel1">Van Trailer</span></button>
                                    <button class="plc-trailer-btn" data-plc-len="48" onclick="plcSelectTrailer(48)"><span class="size">48'</span><span class="label" id="plcVanLabel2">Van Trailer</span></button>
                                </div>
                                <div style="margin-top: 12px;">
                                    <div class="plc-field">
                                        <label id="plcMaxPayloadLabel">Max Payload (lbs)</label>
                                        <input type="number" id="plcMaxWeight" value="45000" oninput="plcRecalculate()">
                                    </div>
                                </div>
                            </div>
                            <div class="plc-card">
                                <div class="plc-card-title" id="plcPalletTypesTitle">Pallet Types</div>
                                <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    <span>ðŸš›</span> <span id="plcDragHint">Drag to reorder loading sequence. #1 loads first (near door).</span>
                                </div>
                                <div id="plcPalletTypesContainer"></div>
                                <button class="plc-add-btn" onclick="plcAddPalletType()">
                                    <span style="font-size:20px;font-weight:700;">+</span> <span id="plcAddBtnText">Add Pallet Size</span>
                                </button>
                            </div>
                        </div>
                        <!-- RIGHT PANEL: Stats + Visual -->
                        <div class="plc-visual">
                            <div class="plc-stats-bar">
                                <div class="plc-stat" id="plcStatTotal"><div class="label" id="plcStatTotalLabel">Total Pallets</div><div class="value" id="plcTotalPallets">0</div></div>
                                <div class="plc-stat" id="plcStatWeight"><div class="label" id="plcStatWeightLabel">Total Weight</div><div class="value" id="plcTotalWeight">0</div><div class="sub" id="plcWeightSub">of 45,000 lbs</div></div>
                                <div class="plc-stat" id="plcStatSpace"><div class="label" id="plcStatSpaceLabel">Space Used</div><div class="value" id="plcSpaceUsed">0%</div></div>
                                <div class="plc-stat" id="plcStatStatus"><div class="label" id="plcStatStatusLabel">Load Status</div><div class="value" id="plcLoadStatus" style="color: var(--text-secondary);">---</div></div>
                            </div>
                            <div class="plc-weight-bar"><div class="plc-weight-fill" id="plcWeightFill" style="width:0%;background:#3fb950;"></div></div>
                            <div class="plc-trailer-visual">
                                <div class="plc-trailer-label"><span id="plcViewLabel">TOP-DOWN VIEW</span><span id="plcTrailerDimLabel">636" x 98.5"</span></div>
                                <div id="plcTrailerSvg" style="width:100%;overflow-x:auto;"></div>
                                <div class="plc-legend" id="plcLegend"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ORDERS SHIPPED PAGE -->
        <div id="orders-shipped" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersShipped.title">Shipped Orders History</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersShippedBtnRollTech" onclick="toggleOrdersShippedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersShippedBtnMolding" onclick="toggleOrdersShippedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersShippedBtnSnapPad" onclick="toggleOrdersShippedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="ordersShippedFromDate" onchange="applyShippedDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="ordersShippedToDate" onchange="applyShippedDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetShippedDateFilter()">ðŸ”„ Reset</button>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersShippedClearFiltersBtn" onclick="clearAllTableFilters('ordersShipped')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersShippedColumnsBtn" onclick="openColumnToggle('ordersShipped')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersShippedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersShippedTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportOrdersShippedToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportOrdersShippedToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.shippedOrders">Shipped Orders</div><div class="value" id="ordersShippedTotalOrders">-</div><div class="sub" id="ordersShippedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersShippedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="ordersShippedPL">-</div><div class="sub" id="ordersShippedMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersShippedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.shippedOrders">Shipped Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersShippedTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table"><thead><tr id="ordersShippedTableHeader"></tr></thead><tbody id="ordersShippedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- INVENTORY PAGE -->
        <div id="inventory" class="page has-card-view">
            <div class="page-header">
                <div><h2 data-i18n="inv.title">Inventory Management</h2></div>
            </div>
            <div class="toolbar">
                <input type="text" class="search-box" id="invSearch" data-i18n-placeholder="ui.search" placeholder="Search items..." oninput="filterInvTable()">
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="invFilterAll" onclick="setInvFilter('all')" data-i18n="filter.all">All</button>
                    <button class="toolbar-btn" id="invFilterLow" onclick="setInvFilter('low')">âš ï¸ <span data-i18n="filter.lowStock">Low Stock</span></button>
                    <button class="toolbar-btn" id="invFilterNeeded" onclick="setInvFilter('needed')">ðŸ”§ <span data-i18n="filter.needsProduction">Needs Production</span></button>
                    <button class="toolbar-btn" id="invFilterRunningLow" onclick="setInvFilter('runningLow')">ðŸ“‰ <span data-i18n="filter.runningLow">Running Low</span> <span id="invStatRunningLow" class="filter-count" style="font-size:0.75em;opacity:0.7;"></span></button>
                    <button class="toolbar-btn" id="invFilterMake" onclick="setInvFilter('make')">ðŸ­ <span data-i18n="filter.manufactured">Manufactured</span></button>
                    <button class="toolbar-btn" id="invFilterPurchased" onclick="setInvFilter('purchased')">ðŸ›’ <span data-i18n="filter.purchased">Purchased</span></button>
                    <button class="toolbar-btn" id="invFilterCOM" onclick="setInvFilter('com')">ðŸ“‹ <span data-i18n="filter.com">COM</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="inventoryClearFiltersBtn" onclick="clearAllTableFilters('inventory')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="inventoryColumnsBtn" onclick="openColumnToggle('inventory')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <button class="toolbar-btn" onclick="navigateTo('material-requirements')" style="background:var(--accent);color:white;">ðŸ“¦ <span data-i18n="nav.materialReq">Material Requirements</span></button>
                <div class="toolbar-spacer"></div>
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportInvCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportInvExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalItems">Total Items</div><div class="value" id="invStatTotal">-</div><div class="sub" id="invStatTypes">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.lowStock">Low Stock</div><div class="value" style="color:var(--danger);" id="invStatLow">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needsProduction">Needs Production</div><div class="value" style="color:var(--warning);" id="invStatNeeded">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.adequateStock">Adequate Stock</div><div class="value" style="color:var(--success);" id="invStatOk">-</div></div>
            </div>
            <!-- Mobile Search and Filters for Inventory -->
            <div class="mobile-inv-controls">
                <div class="mobile-search-bar">
                    <input type="text" id="mobileInvSearchInput" placeholder="ðŸ” Search inventory..." oninput="mobileSearchInventory(this.value)">
                </div>
                <div class="mobile-filter-bar">
                    <span class="mobile-filter-chip active" onclick="mobileFilterInventory('all')">All</span>
                    <span class="mobile-filter-chip" onclick="mobileFilterInventory('low')">âš ï¸ Low Stock</span>
                    <span class="mobile-filter-chip" onclick="mobileFilterInventory('needed')">ðŸ”§ Needs Production</span>
                </div>
            </div>
            <!-- Mobile Cards Container for Inventory -->
            <div class="mobile-cards-container" id="mobileInventoryCardsContainer"></div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.inventoryStatus">Inventory Status</h3><span style="color:var(--text-secondary);font-size:12px;" id="invTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table" id="invTable">
                        <thead><tr id="invTableHeader"></tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- INVENTORY HISTORY PAGE (Multi-Part Comparison) -->
        <div id="inventory-history" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="inv.historyPageTitle">ðŸ“ˆ Inventory History</h2>
                    <p data-i18n="inv.historyPageSubtitle">Compare inventory levels over time for multiple parts</p>
                </div>
                <button class="toolbar-btn" onclick="navigateTo('inventory')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            
            <div class="history-page-layout">
                <!-- Left Panel: Part Selection -->
                <div class="history-parts-panel">
                    <div class="history-panel-header">
                        <h3 data-i18n="inv.selectParts">Select Parts</h3>
                        <span class="history-selected-count" id="historySelectedCount">0 <span data-i18n="inv.selected">selected</span></span>
                    </div>
                    <input type="text" class="history-parts-search" id="historyPartsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterHistoryPartsList()">
                    <div class="history-parts-actions">
                        <button onclick="selectAllHistoryParts()" data-i18n="ui.selectAll">Select All</button>
                        <button onclick="deselectAllHistoryParts()" data-i18n="ui.deselectAll">Deselect All</button>
                    </div>
                    <div class="history-parts-list" id="historyPartsList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Right Panel: Chart and Controls -->
                <div class="history-chart-panel">
                    <div class="history-chart-controls">
                        <div class="history-date-inputs">
                            <div class="history-date-group">
                                <label data-i18n="ui.from">From</label>
                                <input type="date" id="historyPageStartDate" onchange="updateHistoryPageChart()">
                            </div>
                            <div class="history-date-group">
                                <label data-i18n="ui.to">To</label>
                                <input type="date" id="historyPageEndDate" onchange="updateHistoryPageChart()">
                            </div>
                        </div>
                        <div class="history-presets">
                            <button onclick="applyHistoryPagePreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                            <button onclick="applyHistoryPagePreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                            <button onclick="applyHistoryPagePreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                            <button onclick="applyHistoryPagePreset('all')" data-i18n="inv.allData">All Data</button>
                        </div>
                    </div>
                    
                    <div class="history-page-chart-container" id="historyPageChartContainer">
                        <canvas id="inventoryHistoryPageChart"></canvas>
                        <div class="history-page-no-selection" id="historyPageNoSelection">
                            <span data-i18n="inv.selectPartsPrompt">Select one or more parts from the list to view their inventory history</span>
                        </div>
                    </div>
                    
                    <div class="history-legend" id="historyPageLegend">
                        <!-- Populated dynamically with part colors -->
                    </div>
                    
                    <div class="history-page-stats" id="historyPageStats">
                        <!-- Populated dynamically with stats for each selected part -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SALES OVERVIEW PAGE -->
        <div id="sales-overview" class="page">
            <div class="page-header">
                <div><h2 data-i18n="sales.title">P/L Overview</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="salesBtnRollTech" onclick="toggleSalesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="salesBtnMolding" onclick="toggleSalesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="salesBtnSnapPad" onclick="toggleSalesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-spacer"></div>
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportSalesCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportSalesExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value" id="salesStatRevenue">-</div><div class="sub" id="salesStatOrderCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="salesStatPL">-</div><div class="sub" id="salesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.shippedPL">Shipped P/L</div><div class="value" id="salesStatShippedPL">-</div><div class="sub" id="salesStatShippedCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.forecastedPL">Forecasted P/L</div><div class="value" id="salesStatForecastPL">-</div><div class="sub" id="salesStatForecastCount">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLTrend">Monthly P/L Trend</h3></div>
                <div class="chart-wrapper large"><canvas id="salesTrendChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY PARTS PAGE -->
        <div id="sales-parts" class="page">
            <div class="page-header">
                <div><h2 data-i18n="parts.title">P/L by Part Number</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="partsBtnRollTech" onclick="togglePartsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="partsBtnMolding" onclick="togglePartsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="partsBtnSnapPad" onclick="togglePartsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="partsFromDate" onchange="applyPartsDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="partsToDate" onchange="applyPartsDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetPartsDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="partsWatchlistBtn" onclick="togglePartsWatchlistFilter()">â­ <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="partsClearFiltersBtn" onclick="clearAllTableFilters('parts')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="partsColumnsBtn" onclick="openColumnToggle('parts')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="partsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterPartsTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportPartsCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportPartsExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.allPartsPL">All Parts P/L Analysis</h3></div>
                <div class="chart-wrapper large"><canvas id="partsBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.partsDetails">Parts Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="partsTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="partsTableHeader"></tr></thead><tbody id="partsTableBody"></tbody></table>
                </div>
            </div>
            <!-- Parts Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="partsCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts â€º <span id="partsCustomerDrilldownPart">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closePartsCustomerDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="partsCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="partsCustomerDrilldownHeader"></tr></thead>
                        <tbody id="partsCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Parts Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="partsOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts â€º <span id="partsOrdersBreadcrumbPart">-</span> â€º <span id="partsOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToPartsCustomers()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllPartsDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="partsOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="partsOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="partsOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY CUSTOMERS PAGE -->
        <div id="sales-customers" class="page">
            <div class="page-header">
                <div><h2 data-i18n="customers.title">P/L by Customer</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="customersBtnRollTech" onclick="toggleCustomersCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="customersBtnMolding" onclick="toggleCustomersCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="customersBtnSnapPad" onclick="toggleCustomersCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="customersFromDate" onchange="applyCustomersDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="customersToDate" onchange="applyCustomersDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetCustomersDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="customersWatchlistBtn" onclick="toggleCustomersWatchlistFilter()">â­ <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="customersClearFiltersBtn" onclick="clearAllTableFilters('customers')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="customersColumnsBtn" onclick="openColumnToggle('customers')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="customersSearch" data-i18n-placeholder="ui.search" placeholder="Search customers..." oninput="filterCustomersTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportCustomersCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportCustomersExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.customerPLDist">Customer P/L Distribution (Top 10)</h3></div>
                <div class="chart-wrapper large"><canvas id="customersChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.customerDetails">Customer Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="customersTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="customersTableHeader"></tr></thead><tbody id="customersTableBody"></tbody></table>
                </div>
            </div>
            <!-- Customers Product Drilldown (Level 1) -->
            <div class="drilldown-section" id="customersProductDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers â€º <span id="customersProductDrilldownCustomer">-</span></div>
                        <h3 data-i18n="drilldown.productBreakdown">Product Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeCustomersProductDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="customersProductSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part Number</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Margin</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="customersProductDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Customers Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="customersOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers â€º <span id="customersOrdersBreadcrumbCustomer">-</span> â€º <span id="customersOrdersBreadcrumbPart">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToCustomersProducts()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllCustomersDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="customersOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="customersOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="customersOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY DATE PAGE -->
        <div id="sales-dates" class="page">
            <div class="page-header">
                <div><h2 data-i18n="dates.title">P/L by Date</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="datesBtnRollTech" onclick="toggleDatesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="datesBtnMolding" onclick="toggleDatesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="datesBtnSnapPad" onclick="toggleDatesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="datesFromDate" onchange="applyDatesDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="datesToDate" onchange="applyDatesDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetDatesDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="datesClearFiltersBtn" onclick="clearAllTableFilters('dates')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="datesColumnsBtn" onclick="openColumnToggle('dates')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportDatesCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportDatesExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.orders">Orders</div><div class="value" id="datesStatOrders">-</div><div class="sub" id="datesStatUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.revenue">Revenue</div><div class="value" id="datesStatRevenue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.pl">P/L</div><div class="value" id="datesStatPL">-</div><div class="sub" id="datesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.margin">Margin</div><div class="value" id="datesStatMarginPct">-</div><div class="sub" id="datesStatMonths">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLBreakdown">Monthly P/L Breakdown</h3></div>
                <div class="chart-wrapper large"><canvas id="datesBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.monthlyDetails">Monthly Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="datesTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="datesTableHeader"></tr></thead><tbody id="datesTableBody"></tbody></table>
                </div>
            </div>
            <!-- Dates Monthly Orders Drilldown (Level 1a - shows first) -->
            <div class="drilldown-section" id="datesMonthlyOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months â€º <span id="datesMonthlyOrdersMonth">-</span></div>
                        <h3 data-i18n="drilldown.monthlyOrders">Monthly Orders</h3>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="toolbar-btn clear-all-filters-btn" id="datesMonthlyOrdersClearFiltersBtn" onclick="clearAllTableFilters('datesMonthlyOrders')" style="display:none;">ðŸ—‘ Clear Filters</button>
                        <button class="toolbar-btn columns-btn" onclick="openColumnToggle('datesMonthlyOrders')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                        <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportDatesMonthlyOrdersCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportDatesMonthlyOrdersExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                        <button class="close-btn" onclick="closeDatesMonthlyOrdersDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                    </div>
                </div>
                <div class="summary-row" id="datesMonthlyOrdersSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="datesMonthlyOrdersHeader"></tr></thead>
                        <tbody id="datesMonthlyOrdersBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dates Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="datesCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months â€º <span id="datesCustomerDrilldownMonth">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="toolbar-btn clear-all-filters-btn" id="datesCustomerClearFiltersBtn" onclick="clearAllTableFilters('datesCustomer')" style="display:none;">ðŸ—‘ Clear Filters</button>
                        <button class="toolbar-btn columns-btn" onclick="openColumnToggle('datesCustomer')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                        <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportDatesCustomerCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportDatesCustomerExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                        <button class="close-btn" onclick="closeDatesCustomerDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                    </div>
                </div>
                <div class="summary-row" id="datesCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="datesCustomerHeader"></tr></thead>
                        <tbody id="datesCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dates Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="datesOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months â€º <span id="datesOrdersBreadcrumbMonth">-</span> â€º <span id="datesOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToDatesCustomers()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllDatesDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="datesOrdersSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part</th><th>PO #</th><th>Status</th><th>Ship/Due Date</th><th>Qty</th><th>Unit Price</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="datesOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOM EXPLORER PAGE -->
        <div id="bom" class="page">
            <div class="page-header">
                <div><h2 data-i18n="bom.title">BOM Explorer</h2></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')" data-i18n="bom.finalAssembly">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')" data-i18n="bom.subAssembly">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')" data-i18n="bom.individualItems">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3 data-i18n="bom.selectPart">Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" data-i18n-placeholder="bom.searchParts" placeholder="Search parts..." oninput="filterBomSelector()">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALL DATA PAGE -->
        <div id="all-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="allData.title">All Data (Raw)</h2><p data-i18n="allData.subtitle">Complete spreadsheet data - Columns A through AX</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="allDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="allDataRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="allDataColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="allDataClearFiltersBtn" onclick="clearAllTableFilters('allData')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="allDataColumnsBtn" onclick="openColumnToggle('allData')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="allDataGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterAllDataTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportAllDataToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportAllDataToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="allDataTable">
                        <thead><tr id="allDataTableHeader"></tr></thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FP REFERENCE DATA PAGE -->
        <div id="fp-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="fpRef.title">FP Reference Data</h2><p data-i18n="fpRef.subtitle">Finished Part specifications and attributes</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="fpRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="fpRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="fpRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="fpRefClearFiltersBtn" onclick="clearAllTableFilters('fpRef')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="fpRefColumnsBtn" onclick="openColumnToggle('fpRef')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="fpRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterFpRefTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportFpRefToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportFpRefToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="fpRefTable">
                        <thead><tr id="fpRefTableHeader"></tr></thead>
                        <tbody id="fpRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CUSTOMER REFERENCE DATA PAGE -->
        <div id="customer-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="custRef.title">Customer Reference Data</h2><p data-i18n="custRef.subtitle">Customer pricing tiers and payment terms</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="custRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="custRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="custRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="custRefClearFiltersBtn" onclick="clearAllTableFilters('custRef')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="custRefColumnsBtn" onclick="openColumnToggle('custRef')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="custRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterCustRefTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportCustRefToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportCustRefToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="custRefTable">
                        <thead><tr id="custRefTableHeader"></tr></thead>
                        <tbody id="custRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- QUOTES REGISTRY PAGE -->
        <div id="quotes-registry" class="page">
            <div class="page-header">
                <div><h2 data-i18n="quotes.title">Quotes Registry</h2><p data-i18n="quotes.subtitle">Quote records and customer quotations</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="quotesLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="quotesRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="quotesColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="quotesClearFiltersBtn" onclick="clearAllTableFilters('quotes')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="quotesColumnsBtn" onclick="openColumnToggle('quotes')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="quotesGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterQuotesTable()">
                <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportQuotesToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportQuotesToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="quotesTable">
                        <thead><tr id="quotesTableHeader"></tr></thead>
                        <tbody id="quotesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MATERIAL REQUIREMENTS PAGE -->
        <div id="material-requirements" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="matReq.title">ðŸ“¦ Material Requirements</h2>
                    <p data-i18n="matReq.subtitle">Raw material demand vs. inventory for open orders</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span style="color:var(--text-secondary);font-size:12px;" id="matReqTimestamp">-</span>
                    <button class="toolbar-btn" onclick="updateMaterialRequirementsPage()">ðŸ”„ <span data-i18n="btn.refresh">Refresh</span></button>
                    <button class="toolbar-btn" onclick="exportMaterialRequirementsCSV()">ðŸ“¥ CSV</button>
                    <button class="toolbar-btn" onclick="navigateTo('inventory')">â† <span data-i18n="btn.back">Back</span></button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="mat-req-summary">
                <div class="mat-req-card"><div class="label" data-i18n="matReq.openOrders">Open Orders</div><div class="value" id="matReqOrderCount">-</div></div>
                <div class="mat-req-card"><div class="label" data-i18n="matReq.hubsNeeded">Hubs Needed</div><div class="value" id="matReqHubCount">-</div></div>
                <div class="mat-req-card"><div class="label" data-i18n="matReq.tiresNeeded">Tires Needed</div><div class="value" id="matReqTireCount">-</div></div>
                <div class="mat-req-card"><div class="label" data-i18n="matReq.shortages">Shortages</div><div class="value" id="matReqShortageCount">-</div></div>
                <div class="mat-req-card"><div class="label" data-i18n="matReq.urethaneNeeded">Urethane Needed</div><div class="value" id="matReqUrethane" style="font-size:1.1rem;">-</div></div>
                <div class="mat-req-card"><div class="label" data-i18n="matReq.crumbRubber">Crumb Rubber Needed</div><div class="value" id="matReqCrumbRubber" style="font-size:1.1rem;">-</div></div>
            </div>

            <!-- Material Status Table -->
            <div class="mat-section">
                <h3 data-i18n="matReq.materialStatus">ðŸ“Š Material Inventory vs. Demand</h3>
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;" data-i18n="matReq.clickRow">Click any row to see demand breakdown by component</p>
                <div class="scrollable-table" style="max-height:400px;">
                    <table class="data-table">
                        <thead><tr>
                            <th data-i18n="matReq.material">Material</th>
                            <th class="num" data-i18n="matReq.onHand">On Hand</th>
                            <th class="num" data-i18n="matReq.needed">Needed</th>
                            <th class="num" data-i18n="matReq.surplusShortage">Surplus / Shortage</th>
                            <th data-i18n="matReq.coverage">Coverage</th>
                            <th data-i18n="matReq.status">Status</th>
                        </tr></thead>
                        <tbody id="matReqTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Hub Breakdown -->
            <div class="mat-section">
                <h3 data-i18n="matReq.hubBreakdown">ðŸ”§ Hub Production Breakdown</h3>
                <div class="scrollable-table" style="max-height:350px;">
                    <table class="data-table">
                        <thead><tr>
                            <th data-i18n="matReq.hubPart">Hub Part</th>
                            <th data-i18n="matReq.type">Type</th>
                            <th class="num" data-i18n="matReq.qtyNeeded">Qty Needed</th>
                            <th class="num" data-i18n="matReq.weightEa">Wt/ea (lbs)</th>
                            <th data-i18n="matReq.materials">Materials</th>
                        </tr></thead>
                        <tbody id="matReqHubBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tire Breakdown -->
            <div class="mat-section">
                <h3 data-i18n="matReq.tireBreakdown">ðŸ›ž Tire Production Breakdown</h3>
                <div class="scrollable-table" style="max-height:350px;">
                    <table class="data-table">
                        <thead><tr>
                            <th data-i18n="matReq.tireSize">Tire Size</th>
                            <th class="num" data-i18n="matReq.qtyNeeded">Qty Needed</th>
                            <th class="num" data-i18n="matReq.weightEa">Wt/ea (lbs)</th>
                            <th class="num" data-i18n="matReq.crumbRubberLbs">Crumb Rubber (lbs)</th>
                            <th class="num" data-i18n="matReq.urethaneLbs">Urethane (lbs)</th>
                        </tr></thead>
                        <tbody id="matReqTireBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PALLET RECORDS PAGE -->
        <!-- DRAWINGS LIBRARY PAGE -->
        <div id="drawings-library" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="drawing.drawingsLibrary">ðŸ“ Drawings Library</h2>
                    <p id="drawingsLibraryCount" style="color: var(--text-secondary); font-size: 13px;"></p>
                </div>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="drawingsSearch" placeholder="Search by part number..." data-i18n-placeholder="drawing.searchPlaceholder" oninput="filterDrawingsLibrary()" style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 13px; width: 250px;">
                    <select id="drawingsTypeFilter" onchange="filterDrawingsLibrary()" style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 13px;">
                        <option value="all" data-i18n="drawing.allTypes">All Types</option>
                        <option value="Tire">Tire</option>
                        <option value="Hub">Hub</option>
                    </select>
                </div>
            </div>
            <div id="drawingsLibraryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-top: 16px;"></div>
        </div>

        <div id="pallet-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="palletRecords.title">Pallet Records</h2><p data-i18n="palletRecords.subtitle">Pallet photos and dimension records</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportPalletRecordsToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportPalletRecordsToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="palletRecordsBtnRollTech" onclick="togglePalletRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="palletRecordsBtnMolding" onclick="togglePalletRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="palletRecordsBtnSnapPad" onclick="togglePalletRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="palletRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="palletRecordsClearFiltersBtn" onclick="clearAllTableFilters('palletRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="palletRecordsColumnsBtn" onclick="openColumnToggle('palletRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="palletRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Order#, Customer..." oninput="filterPalletRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="palletRecordsTable">
                        <thead><tr id="palletRecordsTableHeader"></tr></thead>
                        <tbody id="palletRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SHIPPING RECORDS PAGE -->
        <div id="shipping-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="shippingRecords.title">Shipping Records</h2><p data-i18n="shippingRecords.subtitle">Shipment photos and carrier information</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportShippingRecordsToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportShippingRecordsToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="shippingRecordsBtnRollTech" onclick="toggleShippingRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="shippingRecordsBtnMolding" onclick="toggleShippingRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="shippingRecordsBtnSnapPad" onclick="toggleShippingRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="shippingRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="shippingRecordsClearFiltersBtn" onclick="clearAllTableFilters('shippingRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="shippingRecordsColumnsBtn" onclick="openColumnToggle('shippingRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="shippingRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Order#, Customer, Carrier..." oninput="filterShippingRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="shippingRecordsTable">
                        <thead><tr id="shippingRecordsTableHeader"></tr></thead>
                        <tbody id="shippingRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- STAGED RECORDS PAGE -->
        <div id="staged-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="stagedRecords.title">Staged Records</h2><p data-i18n="stagedRecords.subtitle">Staging confirmation and pallet information</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="export-dropdown"><button class="toolbar-btn" onclick="toggleExportDropdown(this)">ðŸ“¥ <span data-i18n="ui.export">Export</span> â–¾</button><div class="export-dropdown-content"><a onclick="exportStagedRecordsToCSV();closeExportDropdowns()">ðŸ“„ CSV</a><a onclick="exportStagedRecordsToExcel();closeExportDropdowns()">ðŸ“Š Excel</a></div></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="stagedRecordsBtnRollTech" onclick="toggleStagedRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="stagedRecordsBtnMolding" onclick="toggleStagedRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="stagedRecordsBtnSnapPad" onclick="toggleStagedRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="stagedRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="stagedRecordsClearFiltersBtn" onclick="clearAllTableFilters('stagedRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="stagedRecordsColumnsBtn" onclick="openColumnToggle('stagedRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="stagedRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Line#, Customer..." oninput="filterStagedRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="stagedRecordsTable">
                        <thead><tr id="stagedRecordsTableHeader"></tr></thead>
                        <tbody id="stagedRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Panel -->
    <button class="ai-chat-fab" id="aiChatFab" onclick="toggleAiChat()" title="Phil Assistant">ðŸ¤–</button>
    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-header">
            <div class="ai-chat-header-left">
                <span class="ai-icon">ðŸ¤–</span>
                <div>
                    <div class="ai-title" data-i18n="ai.title">Phil Assistant</div>
                    <div class="ai-subtitle" data-i18n="ai.subtitle">Ask about orders, inventory & production</div>
                </div>
            </div>
            <div class="ai-chat-header-actions">
                <button onclick="clearAiChat()" title="Clear chat">ðŸ—‘ï¸</button>
                <button class="close-btn" onclick="toggleAiChat()" title="Close">âœ•</button>
            </div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-msg system" id="aiWelcomeMsg"></div>
        </div>
        <div class="ai-suggestions" id="aiSuggestions"></div>
        <div class="ai-chat-input-area" style="position:relative;">
            <textarea id="aiChatInput" data-i18n-placeholder="ai.placeholder" placeholder="Ask about your data..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage();}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,150)+'px';"></textarea>
            <button class="ai-voice-mode-toggle" id="aiVoiceModeToggle" onclick="toggleVoiceMode()" title="Toggle auto-send">âœï¸</button>
            <button class="ai-voice-btn" id="aiVoiceBtn" onclick="toggleVoiceInput()" title="Voice input">ðŸŽ¤</button>
            <span class="ai-voice-status" id="aiVoiceStatus">Listening...</span>
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAiMessage()" title="Send">âž¤</button>
        </div>
    </div>

    <script>
        // ============================================================
        // INTERNATIONALIZATION
        // ============================================================
        const translations = {
            en: {
                'logoSubtitle': 'Operations Dashboard',
                'nav.main': 'Main Dashboard',
                'nav.production': 'PRODUCTION',
                'nav.ordersData': 'Orders Data',
                'nav.productionMake': 'Need to Make',
                'nav.ordersQueue': 'Need to Package',
                'nav.ordersStaged': 'Ready to Ship',
                'nav.ordersShipped': 'Shipped',
                'nav.inventory': 'Inventory',
                'nav.salesFinance': 'SALES & FINANCE',
                'nav.plOverview': 'P/L Overview',
                'nav.byPart': 'By Part Number',
                'nav.byCustomer': 'By Customer',
                'nav.byDate': 'By Date',
                'nav.billOfMaterials': 'BILL OF MATERIALS',
                'nav.bomExplorer': 'BOM Explorer',
                'nav.rawData': 'RAW DATA',
                'nav.allData': 'All Data',
                'nav.fpReference': 'FP Reference',
                'nav.customerReference': 'Customer Reference',
                'nav.quotesRegistry': 'Quotes Registry',
                'nav.palletRecords': 'Pallet Records',
                'nav.shippingRecords': 'Shipping Records',
                'nav.stagedRecords': 'Staged Records',
                'nav.inventoryHistory': 'Inventory History',
                'nav.materialReq': 'Material Requirements',
                'matReq.title': 'ðŸ“¦ Material Requirements',
                'matReq.subtitle': 'Raw material demand vs. inventory for open orders',
                'matReq.openOrders': 'Open Orders',
                'matReq.hubsNeeded': 'Hubs Needed',
                'matReq.tiresNeeded': 'Tires Needed',
                'matReq.shortages': 'Shortages',
                'matReq.urethaneNeeded': 'Urethane Needed',
                'matReq.crumbRubber': 'Crumb Rubber Needed',
                'matReq.materialStatus': 'ðŸ“Š Material Inventory vs. Demand',
                'matReq.clickRow': 'Click any row to see demand breakdown by component',
                'matReq.material': 'Material',
                'matReq.onHand': 'On Hand',
                'matReq.needed': 'Needed',
                'matReq.surplusShortage': 'Surplus / Shortage',
                'matReq.coverage': 'Coverage',
                'matReq.status': 'Status',
                'matReq.hubBreakdown': 'ðŸ”§ Hub Production Breakdown',
                'matReq.tireBreakdown': 'ðŸ›ž Tire Production Breakdown',
                'matReq.hubPart': 'Hub Part',
                'matReq.type': 'Type',
                'matReq.qtyNeeded': 'Qty Needed',
                'matReq.weightEa': 'Wt/ea (lbs)',
                'matReq.materials': 'Materials',
                'matReq.tireSize': 'Tire Size',
                'matReq.crumbRubberLbs': 'Crumb Rubber (lbs)',
                'matReq.urethaneLbs': 'Urethane (lbs)',
                'nav.drawingsLibrary': 'Drawings',
                'palletRecords.title': 'Pallet Records',
                'palletRecords.subtitle': 'Pallet photos and dimension records',
                'shippingRecords.title': 'Shipping Records',
                'shippingRecords.subtitle': 'Shipment photos and carrier information',
                'stagedRecords.title': 'Staged Records',
                'stagedRecords.subtitle': 'Staging confirmation and pallet information',
                'fpRef.title': 'FP Reference Data',
                'fpRef.subtitle': 'Finished Part specifications and attributes',
                'custRef.title': 'Customer Reference Data',
                'custRef.subtitle': 'Customer pricing tiers and payment terms',
                'quotes.title': 'Quotes Registry',
                'quotes.subtitle': 'Quote records and customer quotations',
                'allData.title': 'All Data (Raw)',
                'allData.subtitle': 'Complete spreadsheet data - Columns A through AX',
                'loading': 'Loading data from Google Sheets...',
                'main.title': 'Operations Dashboard',
                'main.subtitle': 'Real-time overview of manufacturing operations',
                'stats.needToMake': 'Need to Make',
                'stats.making': 'Making',
                'stats.readyToShip': 'Ready to Ship',
                'stats.urgent': 'Urgent',
                'stats.totalUnits': 'Total Units',
                'stats.monthRevenue': 'Month Revenue',
                'stats.monthPL': 'Month P/L',
                'stats.missingParts': 'Missing Parts',
                'status.needToMake': 'Need to Make',
                'status.making': 'Making',
                'status.readyToShip': 'Ready to Ship',
                'status.shipped': 'Shipped',
                'status.urgent': 'URGENT',
                'dept.production': 'Production Planning',
                'dept.productionDesc': 'View orders to make, component status, and production queue',
                'dept.needToMake': 'Need to Make',
                'dept.units': 'Units',
                'dept.sales': 'Sales & P/L Analytics',
                'dept.salesDesc': 'Revenue, profitability, and customer analysis',
                'dept.revenue': 'Revenue',
                'dept.profit': 'Profit',
                'dept.orders': 'Orders',
                'dept.inventory': 'Inventory Management',
                'dept.inventoryDesc': 'Stock levels, reorder points, and material tracking',
                'chart.ordersByStatus': 'Orders by Status',
                'chart.upcomingDeadlines': 'Upcoming Deadlines (Next 14 Days)',
                'ordersData.title': 'All Orders Data',
                'ordersData.subtitle': 'Complete order database with all statuses',
                'ordersQueue.title': 'Orders Queue - Need to Make',
                'ordersQueue.subtitle': 'Orders pending production (Pending + Approved status)',
                'ordersStaged.title': 'Staged Orders - Ready to Ship',
                'ordersShipped.title': 'Shipped Orders History',
                'prod.missingMsg': 'orders have missing components.',
                'btn.backToDashboard': 'Back',
                'col.line': 'Line',
                'col.priority': 'Priority',
                'col.daysUntil': 'Days Until',
                'col.requestDate': 'Request Date',
                'col.dueDate': 'Due Date',
                'col.customer': 'Customer',
                'col.category': 'Category',
                'col.ifNum': 'IF #',
                'col.poNum': 'PO #',
                'col.fusionStatus': 'IF Status in Fusion',
                'col.part': 'Part #',
                'col.numPackages': '# Packages',
                'col.partsPerPackage': 'Parts/Package',
                'col.qty': 'Qty',
                'col.fusionInv': 'Fusion Inventory',
                'col.packaging': 'Packaging',
                'col.tire': 'Tire',
                'col.hub': 'Hub',
                'col.hubMold': 'Hub Mold',
                'col.bearings': 'Bearings',
                'col.status': 'Status',
                'col.assigned': 'Assigned To',
                'col.shippedDate': 'Shipped Date',
                'col.daysLate': 'Days Late',
                'col.revenue': 'Revenue',
                'col.pl': 'P/L',
                'missing': 'Missing',
                'sales.title': 'P/L Overview',
                'inv.title': 'Inventory Management',
                'inv.historyTitle': 'Inventory History',
                'inv.clickHistory': 'Click to view history',
                'inv.last7': 'Last 7 Days',
                'inv.last30': 'Last 30 Days',
                'inv.last90': 'Last 90 Days',
                'inv.allData': 'All Data',
                'inv.current': 'Current',
                'inv.minimum': 'Minimum',
                'inv.maximum': 'Maximum',
                'inv.average': 'Average',
                'inv.noHistory': 'No history data available for this part',
                'inv.historyPageTitle': 'ðŸ“ˆ Inventory History',
                'inv.historyPageSubtitle': 'Compare inventory levels over time for multiple parts',
                'inv.selectParts': 'Select Parts',
                'inv.selected': 'selected',
                'inv.selectPartsPrompt': 'Select one or more parts from the list to view their inventory history',
                'inv.maxPartsWarning': 'Maximum 10 parts can be compared at once',
                'nav.inventoryHistory': 'Inventory History',
                'nav.materialReq': 'Material Requirements',
                'bom.title': 'BOM Explorer',
                'col.weight': 'Weight',
                'col.dimensions': 'Dimensions',
                'col.palletNum': 'Pallet #',
                'col.partsPerPallet': 'Parts/Pallet',
                'pallet.title': 'Pallet Pictures',
                'pallet.noPictures': 'No pallet pictures found for this order.',
                'pallet.clickToView': 'Click to view full size',
                'pallet.weight': 'Weight (lbs)',
                'pallet.dimensions': 'Dimensions (in)',
                'pallet.pallets': 'Pallets',
                'pallet.totalWeight': 'Total Weight',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Search values...',
                'ui.selectAll': 'Select All',
                'ui.deselectAll': 'Deselect All',
                'ui.clear': 'Clear',
                'ui.apply': 'Apply',
                'ui.hideColumn': 'ðŸ‘ Hide',
                'ui.showHidden': 'Show Hidden',
                'ui.columns': 'Columns',
                'ui.filterColumn': 'Filter Column',
                'ui.search': 'Search...',
                'ui.export': 'Export',
                'ui.category': 'Category:',
                'ui.status': 'Status:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Reset (100%)',
                'ui.close': 'Close',
                'ui.closeAll': 'Close All',
                'ui.units': 'units',
                'ui.orders': 'orders',
                'ui.months': 'months',
                'ui.productTypes': 'product types',
                'ui.qty': 'Qty',
                'ui.loading': 'Loading...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Molding',
                'category.snappad': 'Snap Pad',
                'ui.from': 'From:',
                'ui.to': 'To:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total Orders',
                'stats.stagedOrders': 'Staged Orders',
                'stats.shippedOrders': 'Shipped Orders',
                'stats.totalRevenue': 'Total Revenue',
                'stats.totalPL': 'Total P/L',
                'stats.avgOrderValue': 'Avg Order Value',
                'stats.customers': 'Customers',
                'stats.dueThisWeek': 'Due This Week',
                'stats.componentsReady': 'Components Ready',
                'stats.margin': 'Margin',
                'table.orders': 'Orders',
                'table.ordersToMake': 'Orders to Make',
                'table.readyToShip': 'Ready to Ship',
                'table.shippedOrders': 'Shipped Orders',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'Shipped P/L',
                'stats.forecastedPL': 'Forecasted P/L',
                'stats.shipped': 'shipped',
                'stats.pending': 'pending',
                'stats.orders': 'Orders',
                'stats.revenue': 'Revenue',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Monthly P/L Trend',
                'chart.allPartsPL': 'All Parts P/L Analysis',
                'chart.customerPLDist': 'Customer P/L Distribution (Top 10)',
                'chart.monthlyPLBreakdown': 'Monthly P/L Breakdown',
                'table.partsDetails': 'Parts Details',
                'table.customerDetails': 'Customer Details',
                'table.monthlyDetails': 'Monthly Details',
                'parts.title': 'P/L by Part Number',
                'customers.title': 'P/L by Customer',
                'dates.title': 'P/L by Date',
                'drilldown.customerBreakdown': 'Customer Breakdown',
                'drilldown.monthlyOrders': 'Monthly Orders',
                'drilldown.productBreakdown': 'Product Breakdown',
                'drilldown.ordersHistory': 'Orders & Price History',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'All',
                'filter.lowStock': 'Low Stock',
                'filter.needsProduction': 'Needs Production',
                'filter.clearFilters': 'Clear Filters',
                'stats.totalItems': 'Total Items',
                'stats.lowStock': 'Low Stock',
                'stats.needsProduction': 'Needs Production',
                'stats.adequateStock': 'Adequate Stock',
                'table.inventoryStatus': 'Inventory Status',
                'bom.selectPart': 'Select a part to view BOM',
                'bom.searchParts': 'Search parts...',
                'ui.globalSearch': 'Global search...',
                'ui.rows': 'Rows:',
                'ui.columns': 'Columns:',
                'ui.items': 'items',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Final Assembly',
                'bom.subAssembly': 'Sub Assembly',
                'bom.individualItems': 'Individual Items',
                'status.low': 'LOW',
                'status.make': 'MAKE',
                'status.ok': 'OK',
                'status.missing': 'Missing',
                'status.available': 'Available',
                'btn.clearDates': 'Clear Dates',
                'btn.watchlist': 'Watchlist',
                'btn.back': 'Back',
                'btn.backToDashboard': 'Back',
                'prod.missingBanner': 'orders have missing components.',
                'ui.parts': 'parts',
                'ui.customers': 'customers',
                // Photo Drilldown translations
                'photo.palletDetails': 'Pallet Details',
                'photo.fusionPictures': 'Fusion Pictures',
                'photo.shipmentPhotos': 'Shipment Photos',
                'photo.closeUpPictures': 'Close-Up Pictures',
                'photo.noPalletData': 'No pallet data',
                'photo.noFusionPictures': 'No fusion pictures',
                'photo.noShipmentPhotos': 'No shipment photos',
                'photo.noCloseUpPictures': 'No close-up pictures',
                'photo.ship': 'Ship',
                'photo.docs': 'Docs',
                'drawing.tireDrawing': 'Tire Drawing',
                'drawing.hubDrawing': 'Hub Drawing',
                'drawing.partDrawing': 'Part Drawing',
                'drawing.noDrawings': 'No drawings available',
                'drawing.drawings': 'Drawings',
                'drawing.drawingsLibrary': 'Drawings Library',
                'drawing.searchPlaceholder': 'Search by part number...',
                'drawing.allTypes': 'All Types',
                'drawing.noResults': 'No drawings found',
                // Theme translations
                'ui.darkTheme': 'Dark',
                'ui.lightTheme': 'Light',
                // Phil Assistant
                'nav.aiAssistant': 'Phil Assistant',
                'ai.title': 'Phil Assistant',
                'ai.subtitle': 'Ask about orders, inventory & production',
                'ai.placeholder': 'Ask about your data...',
                'ai.welcome': 'Hi! I can answer questions about your production orders, inventory, and shipping data. Try asking something!',
                'ai.thinking': 'Thinking...',
                'ai.error': 'Sorry, something went wrong. Please try again.',
                'ai.rateLimit': 'Rate limited â€” please wait a moment and try again.',
                'ai.noData': 'Dashboard data is still loading. Please wait a moment.',
                'ai.cleared': 'Chat cleared.',
                'ai.suggestion1': 'Which orders are late?',
                'ai.suggestion2': 'Low inventory items',
                'ai.suggestion3': 'Orders by customer',
                'ai.suggestion4': 'Status summary',
                // Voice input
                'ai.voiceListening': 'Listening...',
                'ai.voiceNotSupported': 'Voice input not supported in this browser',
                'ai.voiceMicDenied': 'Microphone permission denied. Please allow microphone access.',
                // Mobile card view
                'mobile.rotateTitle': 'Rotate for Full View',
                'mobile.rotateDesc': 'This section is optimized for landscape viewing. Please rotate your device for the best experience.',
                'mobile.quantity': 'Quantity',
                'mobile.due': 'Due',
                'mobile.tire': 'Tire',
                'mobile.hub': 'Hub',
                'mobile.daysOverdue': 'days overdue',
                'mobile.days': 'days',
                'mobile.tapPhotos': 'Tap for photos',
                'mobile.orders': 'Orders',
                'mobile.dueThisWeek': 'Due This Week',
                'mobile.current': 'Current',
                'mobile.minimum': 'Minimum',
                'mobile.needed': 'Needed',
                'mobile.inStock': 'In Stock',
                'mobile.target': 'Target',
                'mobile.toMake': 'To Make',
                'mobile.ofMinimum': '% of minimum'
            },
            es: {
                'logoSubtitle': 'Panel de Operaciones de Moldeo',
                'nav.main': 'Panel Principal',
                'nav.production': 'PRODUCCIÃ“N',
                'nav.ordersData': 'Datos de Ã“rdenes',
                'nav.productionMake': 'Por Fabricar',
                'nav.ordersQueue': 'Por Empacar',
                'nav.ordersStaged': 'Listo para Enviar',
                'nav.ordersShipped': 'Enviados',
                'nav.inventory': 'Inventario',
                'nav.salesFinance': 'VENTAS Y FINANZAS',
                'nav.plOverview': 'Resumen P/L',
                'nav.byPart': 'Por NÃºmero de Parte',
                'nav.byCustomer': 'Por Cliente',
                'nav.byDate': 'Por Fecha',
                'nav.billOfMaterials': 'LISTA DE MATERIALES',
                'nav.bomExplorer': 'Explorador BOM',
                'nav.rawData': 'DATOS CRUDOS',
                'nav.allData': 'Todos los Datos',
                'nav.fpReference': 'Referencia FP',
                'nav.customerReference': 'Referencia de Clientes',
                'nav.quotesRegistry': 'Registro de Cotizaciones',
                'nav.palletRecords': 'Registros de Paletas',
                'nav.shippingRecords': 'Registros de EnvÃ­os',
                'nav.stagedRecords': 'Registros de Staging',
                'nav.inventoryHistory': 'Historial de Inventario',
                'nav.materialReq': 'Requerimientos de Material',
                'matReq.title': 'ðŸ“¦ Requerimientos de Material',
                'matReq.subtitle': 'Demanda de materia prima vs. inventario para Ã³rdenes abiertas',
                'matReq.openOrders': 'Ã“rdenes Abiertas',
                'matReq.hubsNeeded': 'Hubs Necesarios',
                'matReq.tiresNeeded': 'Llantas Necesarias',
                'matReq.shortages': 'Faltantes',
                'matReq.urethaneNeeded': 'Uretano Necesario',
                'matReq.crumbRubber': 'Hule Molido Necesario',
                'matReq.materialStatus': 'ðŸ“Š Inventario de Material vs. Demanda',
                'matReq.clickRow': 'Haz clic en cualquier fila para ver el desglose de demanda por componente',
                'matReq.material': 'Material',
                'matReq.onHand': 'Disponible',
                'matReq.needed': 'Necesario',
                'matReq.surplusShortage': 'Excedente / Faltante',
                'matReq.coverage': 'Cobertura',
                'matReq.status': 'Estado',
                'matReq.hubBreakdown': 'ðŸ”§ Desglose de ProducciÃ³n de Hubs',
                'matReq.tireBreakdown': 'ðŸ›ž Desglose de ProducciÃ³n de Llantas',
                'matReq.hubPart': 'Parte del Hub',
                'matReq.type': 'Tipo',
                'matReq.qtyNeeded': 'Cant. Necesaria',
                'matReq.weightEa': 'Peso/u (lbs)',
                'matReq.materials': 'Materiales',
                'matReq.tireSize': 'TamaÃ±o de Llanta',
                'matReq.crumbRubberLbs': 'Hule Molido (lbs)',
                'matReq.urethaneLbs': 'Uretano (lbs)',
                'nav.drawingsLibrary': 'Dibujos',
                'palletRecords.title': 'Registros de Paletas',
                'palletRecords.subtitle': 'Fotos y dimensiones de paletas',
                'shippingRecords.title': 'Registros de EnvÃ­os',
                'shippingRecords.subtitle': 'Fotos de envÃ­o e informaciÃ³n de transportista',
                'stagedRecords.title': 'Registros de Staging',
                'stagedRecords.subtitle': 'ConfirmaciÃ³n de staging e informaciÃ³n de paletas',
                'fpRef.title': 'Datos de Referencia FP',
                'fpRef.subtitle': 'Especificaciones y atributos de partes terminadas',
                'custRef.title': 'Datos de Referencia de Clientes',
                'custRef.subtitle': 'Niveles de precios y tÃ©rminos de pago por cliente',
                'quotes.title': 'Registro de Cotizaciones',
                'quotes.subtitle': 'Registros de cotizaciones a clientes',
                'allData.title': 'Todos los Datos (Crudo)',
                'allData.subtitle': 'Datos completos de la hoja - Columnas A hasta AX',
                'loading': 'Cargando datos de Google Sheets...',
                'main.title': 'Panel de Operaciones',
                'main.subtitle': 'Vista en tiempo real de las operaciones de manufactura',
                'stats.needToMake': 'Por Fabricar',
                'stats.making': 'Fabricando',
                'stats.readyToShip': 'Listo para Enviar',
                'stats.urgent': 'Urgente',
                'stats.totalUnits': 'Unidades Totales',
                'stats.monthRevenue': 'Ingresos del Mes',
                'stats.monthPL': 'P/L del Mes',
                'stats.missingParts': 'Partes Faltantes',
                'status.needToMake': 'Por Fabricar',
                'status.making': 'Fabricando',
                'status.readyToShip': 'Listo para Enviar',
                'status.shipped': 'Enviado',
                'status.urgent': 'URGENTE',
                'dept.production': 'PlanificaciÃ³n de ProducciÃ³n',
                'dept.productionDesc': 'Ver Ã³rdenes a fabricar y estado de componentes',
                'dept.needToMake': 'Por Fabricar',
                'dept.units': 'Unidades',
                'dept.sales': 'Ventas y AnÃ¡lisis P/L',
                'dept.salesDesc': 'Ingresos, rentabilidad y anÃ¡lisis de clientes',
                'dept.revenue': 'Ingresos',
                'dept.profit': 'Ganancia',
                'dept.orders': 'Pedidos',
                'dept.inventory': 'GestiÃ³n de Inventario',
                'dept.inventoryDesc': 'Niveles de stock y seguimiento de materiales',
                'chart.ordersByStatus': 'Ã“rdenes por Estado',
                'chart.upcomingDeadlines': 'PrÃ³ximos Vencimientos (14 DÃ­as)',
                'ordersData.title': 'Todos los Datos de Ã“rdenes',
                'ordersData.subtitle': 'Base de datos completa de Ã³rdenes',
                'ordersQueue.title': 'Cola de Ã“rdenes - Por Fabricar',
                'ordersQueue.subtitle': 'Ã“rdenes pendientes de producciÃ³n',
                'ordersStaged.title': 'Ã“rdenes en Staging - Listas para Enviar',
                'ordersShipped.title': 'Historial de Ã“rdenes Enviadas',
                'prod.missingMsg': 'Ã³rdenes tienen componentes faltantes.',
                'btn.backToDashboard': 'Volver',
                'col.line': 'LÃ­nea',
                'col.priority': 'Prioridad',
                'col.daysUntil': 'DÃ­as Restantes',
                'col.requestDate': 'Fecha de Solicitud',
                'col.dueDate': 'Fecha de Entrega',
                'col.customer': 'Cliente',
                'col.category': 'CategorÃ­a',
                'col.ifNum': 'IF #',
                'col.poNum': 'PO #',
                'col.fusionStatus': 'Estado de IF en Fusion',
                'col.part': 'NÃºmero de Parte',
                'col.numPackages': '# Paquetes',
                'col.partsPerPackage': 'Partes/Paquete',
                'col.qty': 'Cantidad',
                'col.fusionInv': 'Inventario en Fusion',
                'col.packaging': 'Empaque',
                'col.tire': 'Llanta',
                'col.hub': 'Hub',
                'col.hubMold': 'Molde del Hub',
                'col.bearings': 'Baleros',
                'col.status': 'Estado',
                'col.assigned': 'Asignado a',
                'col.shippedDate': 'Fecha de EnvÃ­o',
                'col.daysLate': 'DÃ­as Tarde',
                'col.revenue': 'Ingresos',
                'col.pl': 'P/L',
                'missing': 'Faltante',
                'sales.title': 'Resumen P/L',
                'inv.title': 'GestiÃ³n de Inventario',
                'inv.historyTitle': 'Historial de Inventario',
                'inv.clickHistory': 'Clic para ver historial',
                'inv.last7': 'Ãšltimos 7 DÃ­as',
                'inv.last30': 'Ãšltimos 30 DÃ­as',
                'inv.last90': 'Ãšltimos 90 DÃ­as',
                'inv.allData': 'Todos los Datos',
                'inv.current': 'Actual',
                'inv.minimum': 'MÃ­nimo',
                'inv.maximum': 'MÃ¡ximo',
                'inv.average': 'Promedio',
                'inv.noHistory': 'No hay datos histÃ³ricos disponibles para esta pieza',
                'inv.historyPageTitle': 'ðŸ“ˆ Historial de Inventario',
                'inv.historyPageSubtitle': 'Compare niveles de inventario a lo largo del tiempo para mÃºltiples piezas',
                'inv.selectParts': 'Seleccionar Piezas',
                'inv.selected': 'seleccionadas',
                'inv.selectPartsPrompt': 'Seleccione una o mÃ¡s piezas de la lista para ver su historial de inventario',
                'inv.maxPartsWarning': 'MÃ¡ximo 10 piezas se pueden comparar a la vez',
                'nav.inventoryHistory': 'Historial de Inventario',
                'nav.materialReq': 'Requerimientos de Material',
                'bom.title': 'Explorador BOM',
                'col.weight': 'Peso',
                'col.dimensions': 'Dimensiones',
                'col.palletNum': 'Paleta #',
                'col.partsPerPallet': 'Partes/Paleta',
                'pallet.title': 'Fotos de Paletas',
                'pallet.noPictures': 'No hay fotos de paletas para esta orden.',
                'pallet.clickToView': 'Clic para ver tamaÃ±o completo',
                'pallet.weight': 'Peso (lbs)',
                'pallet.dimensions': 'Dimensiones (pulg)',
                'pallet.pallets': 'Paletas',
                'pallet.totalWeight': 'Peso Total',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Buscar valores...',
                'ui.selectAll': 'Seleccionar Todo',
                'ui.deselectAll': 'Deseleccionar Todo',
                'ui.clear': 'Limpiar',
                'ui.apply': 'Aplicar',
                'ui.hideColumn': 'ðŸ‘ Ocultar',
                'ui.showHidden': 'Mostrar Ocultas',
                'ui.columns': 'Columnas',
                'ui.filterColumn': 'Filtrar Columna',
                'ui.search': 'Buscar...',
                'ui.export': 'Exportar',
                'ui.category': 'CategorÃ­a:',
                'ui.status': 'Estado:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Restablecer (100%)',
                'ui.close': 'Cerrar',
                'ui.closeAll': 'Cerrar Todo',
                'ui.units': 'unidades',
                'ui.orders': 'Ã³rdenes',
                'ui.months': 'meses',
                'ui.productTypes': 'tipos de producto',
                'ui.qty': 'Cant',
                'ui.loading': 'Cargando...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Moldeo',
                'category.snappad': 'Snap Pad',
                'ui.from': 'Desde:',
                'ui.to': 'Hasta:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total de Ã“rdenes',
                'stats.stagedOrders': 'Ã“rdenes en Staging',
                'stats.shippedOrders': 'Ã“rdenes Enviadas',
                'stats.totalRevenue': 'Ingresos Totales',
                'stats.totalPL': 'P/L Total',
                'stats.avgOrderValue': 'Valor Promedio',
                'stats.customers': 'Clientes',
                'stats.dueThisWeek': 'Vence Esta Semana',
                'stats.componentsReady': 'Componentes Listos',
                'stats.margin': 'Margen',
                'table.orders': 'Ã“rdenes',
                'table.ordersToMake': 'Ã“rdenes a Fabricar',
                'table.readyToShip': 'Listo para Enviar',
                'table.shippedOrders': 'Ã“rdenes Enviadas',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'P/L Enviados',
                'stats.forecastedPL': 'P/L Proyectado',
                'stats.shipped': 'enviados',
                'stats.pending': 'pendientes',
                'stats.orders': 'Ã“rdenes',
                'stats.revenue': 'Ingresos',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Tendencia Mensual P/L',
                'chart.allPartsPL': 'AnÃ¡lisis P/L de Partes',
                'chart.customerPLDist': 'DistribuciÃ³n P/L por Cliente (Top 10)',
                'chart.monthlyPLBreakdown': 'Desglose Mensual P/L',
                'table.partsDetails': 'Detalles de Partes',
                'table.customerDetails': 'Detalles de Clientes',
                'table.monthlyDetails': 'Detalles Mensuales',
                'parts.title': 'P/L por NÃºmero de Parte',
                'customers.title': 'P/L por Cliente',
                'dates.title': 'P/L por Fecha',
                'drilldown.customerBreakdown': 'Desglose por Cliente',
                'drilldown.monthlyOrders': 'Pedidos del Mes',
                'drilldown.productBreakdown': 'Desglose por Producto',
                'drilldown.ordersHistory': 'Historial de Ã“rdenes y Precios',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'Todos',
                'filter.lowStock': 'Inventario Bajo',
                'filter.needsProduction': 'Requiere ProducciÃ³n',
                'filter.clearFilters': 'Limpiar Filtros',
                'stats.totalItems': 'Total de ArtÃ­culos',
                'stats.lowStock': 'Inventario Bajo',
                'stats.needsProduction': 'Requiere ProducciÃ³n',
                'stats.adequateStock': 'Stock Adecuado',
                'table.inventoryStatus': 'Estado del Inventario',
                'bom.selectPart': 'Seleccione una parte para ver BOM',
                'bom.searchParts': 'Buscar partes...',
                'ui.globalSearch': 'BÃºsqueda global...',
                'ui.rows': 'Filas:',
                'ui.columns': 'Columnas:',
                'ui.items': 'artÃ­culos',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Ensamble Final',
                'bom.subAssembly': 'Sub Ensamble',
                'bom.individualItems': 'ArtÃ­culos Individuales',
                'status.low': 'BAJO',
                'status.make': 'HACER',
                'status.ok': 'OK',
                'status.missing': 'Faltante',
                'status.available': 'Disponible',
                'btn.clearDates': 'Limpiar Fechas',
                'btn.watchlist': 'Lista de Seguimiento',
                'btn.back': 'Volver',
                'btn.backToDashboard': 'Volver',
                'prod.missingBanner': 'Ã³rdenes tienen componentes faltantes.',
                'ui.parts': 'partes',
                'ui.customers': 'clientes',
                // Photo Drilldown translations
                'photo.palletDetails': 'Detalles de Paleta',
                'photo.fusionPictures': 'Fotos de Fusion',
                'photo.shipmentPhotos': 'Fotos de EnvÃ­o',
                'photo.closeUpPictures': 'Fotos de Cerca',
                'photo.noPalletData': 'Sin datos de paleta',
                'photo.noFusionPictures': 'Sin fotos de fusion',
                'photo.noShipmentPhotos': 'Sin fotos de envÃ­o',
                'photo.noCloseUpPictures': 'Sin fotos de cerca',
                'photo.ship': 'EnvÃ­o',
                'photo.docs': 'Docs',
                'drawing.tireDrawing': 'Dibujo de Llanta',
                'drawing.hubDrawing': 'Dibujo de Hub',
                'drawing.partDrawing': 'Dibujo de Pieza',
                'drawing.noDrawings': 'No hay dibujos disponibles',
                'drawing.drawings': 'Dibujos',
                'drawing.drawingsLibrary': 'Biblioteca de Dibujos',
                'drawing.searchPlaceholder': 'Buscar por nÃºmero de parte...',
                'drawing.allTypes': 'Todos los Tipos',
                'drawing.noResults': 'No se encontraron dibujos',
                // Theme translations
                'ui.darkTheme': 'Oscuro',
                'ui.lightTheme': 'Claro',
                // Phil Assistant
                'nav.aiAssistant': 'Asistente Phil',
                'ai.title': 'Asistente Phil',
                'ai.subtitle': 'Pregunta sobre Ã³rdenes, inventario y producciÃ³n',
                'ai.placeholder': 'Pregunta sobre tus datos...',
                'ai.welcome': 'Â¡Hola! Puedo responder preguntas sobre tus Ã³rdenes de producciÃ³n, inventario y datos de envÃ­o. Â¡Intenta preguntar algo!',
                'ai.thinking': 'Pensando...',
                'ai.error': 'Lo siento, algo saliÃ³ mal. Por favor intenta de nuevo.',
                'ai.rateLimit': 'LÃ­mite de solicitudes â€” espera un momento e intenta de nuevo.',
                'ai.noData': 'Los datos del dashboard se estÃ¡n cargando. Por favor espera un momento.',
                'ai.cleared': 'Chat limpiado.',
                'ai.suggestion1': 'Â¿QuÃ© Ã³rdenes estÃ¡n atrasadas?',
                'ai.suggestion2': 'ArtÃ­culos con bajo inventario',
                'ai.suggestion3': 'Ã“rdenes por cliente',
                'ai.suggestion4': 'Resumen de estados',
                // Voice input
                'ai.voiceListening': 'Escuchando...',
                'ai.voiceNotSupported': 'Entrada de voz no soportada en este navegador',
                'ai.voiceMicDenied': 'Permiso de micrÃ³fono denegado. Por favor permite el acceso al micrÃ³fono.',
                // Mobile card view
                'mobile.rotateTitle': 'Gira para Ver Completo',
                'mobile.rotateDesc': 'Esta secciÃ³n estÃ¡ optimizada para vista horizontal. Por favor gira tu dispositivo para mejor experiencia.',
                'mobile.quantity': 'Cantidad',
                'mobile.due': 'Vence',
                'mobile.tire': 'Llanta',
                'mobile.hub': 'Hub',
                'mobile.daysOverdue': 'dÃ­as de retraso',
                'mobile.days': 'dÃ­as',
                'mobile.tapPhotos': 'Toca para fotos',
                'mobile.orders': 'Ã“rdenes',
                'mobile.dueThisWeek': 'Vencen Esta Semana',
                'mobile.current': 'Actual',
                'mobile.minimum': 'MÃ­nimo',
                'mobile.needed': 'Necesario',
                'mobile.inStock': 'En Stock',
                'mobile.target': 'Objetivo',
                'mobile.toMake': 'Por Hacer',
                'mobile.ofMinimum': '% del mÃ­nimo'
            }
        };
        
        let currentLang = 'en';
        let currentTheme = 'dark';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langES').classList.toggle('active', lang === 'es');
            // Sync mobile language button
            if (typeof updateMobileLangButton === 'function') updateMobileLangButton();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            // Handle placeholder translations
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            document.getElementById('logoSubtitle').textContent = translations[lang]['logoSubtitle'];
            // Re-render current page
            if (currentPage.startsWith('orders-')) {
                if (currentPage === 'orders-data') updateOrdersDataPage();
                else if (currentPage === 'orders-queue') updateOrdersQueuePage();
                else if (currentPage === 'orders-staged') updateOrdersStagedPage();
                else if (currentPage === 'orders-shipped') updateOrdersShippedPage();
            } else if (currentPage === 'inventory') updateInventoryPage();
            else if (currentPage === 'inventory-history') updateInventoryHistoryPage();
            else if (currentPage === 'drawings-library') updateDrawingsLibrary();
            else if (currentPage === 'main') updateMainDashboard();
            else if (currentPage === 'sales-overview') updateSalesOverview();
            else if (currentPage === 'sales-parts') updateSalesPartsPage();
            else if (currentPage === 'sales-customers') updateSalesCustomersPage();
            else if (currentPage === 'sales-dates') updateSalesDatesPage();
            else if (currentPage === 'fp-reference') renderFpRefTable();
            else if (currentPage === 'customer-reference') renderCustRefTable();
            else if (currentPage === 'quotes-registry') renderQuotesTable();
            else if (currentPage === 'pallet-records') renderPalletRecordsTable();
            else if (currentPage === 'shipping-records') renderShippingRecordsTable();
            else if (currentPage === 'staged-records') renderStagedRecordsTable();
            // Update AI chat language
            if (typeof updateAiLanguage === 'function') updateAiLanguage();
            // Update Pallet Load Calculator language
            if (typeof plcOnLanguageChange === 'function') plcOnLanguageChange();
            // Re-render mobile cards if in mobile mode
            const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
            if (isCardMode) {
                if (typeof renderMobileOrderCards === 'function') renderMobileOrderCards('orders-queue');
                if (typeof renderMobileStagedCards === 'function') renderMobileStagedCards();
                if (typeof renderMobileInventoryCards === 'function') renderMobileInventoryCards();
            }
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.classList.toggle('light-theme', theme === 'light');
            document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
            document.getElementById('themeLight').classList.toggle('active', theme === 'light');
            // Save preference
            try { localStorage.setItem('dashboardTheme', theme); } catch(e) {}
            // Update Chart.js colors for theme
            updateChartsForTheme();
            // Sync mobile theme button
            if (typeof updateMobileThemeButton === 'function') updateMobileThemeButton();
        }
        
        function loadSavedTheme() {
            try {
                const saved = localStorage.getItem('dashboardTheme');
                if (saved === 'light' || saved === 'dark') {
                    setTheme(saved);
                } else {
                    setTheme('dark');
                }
            } catch(e) {
                // Fallback: just set class and buttons directly without calling setTheme
                currentTheme = 'dark';
                try {
                    document.getElementById('themeDark').classList.add('active');
                    document.getElementById('themeLight').classList.remove('active');
                } catch(e2) { /* ignore */ }
            }
        }
        
        function updateChartsForTheme() {
            const textColor = currentTheme === 'light' ? '#1a202c' : '#e2e8f0';
            const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
            
            try {
                if (window.Chart) {
                    Chart.defaults.color = textColor;
                    Chart.defaults.borderColor = gridColor;
                }
            } catch(e) { /* Chart.js not ready yet */ }
            
            // Re-render charts only if they are fully initialized
            try {
                if (window.mainStatusChart && mainStatusChart.options && mainStatusChart.options.plugins) {
                    if (mainStatusChart.options.plugins.legend && mainStatusChart.options.plugins.legend.labels) {
                        mainStatusChart.options.plugins.legend.labels.color = textColor;
                    }
                    mainStatusChart.update();
                }
            } catch(e) { /* chart not ready */ }
            
            try {
                if (window.mainDeadlineChart && mainDeadlineChart.options && mainDeadlineChart.options.scales) {
                    const scales = mainDeadlineChart.options.scales;
                    if (scales.x && scales.x.ticks) scales.x.ticks.color = textColor;
                    if (scales.y && scales.y.ticks) scales.y.ticks.color = textColor;
                    if (scales.x && scales.x.grid) scales.x.grid.color = gridColor;
                    if (scales.y && scales.y.grid) scales.y.grid.color = gridColor;
                    mainDeadlineChart.update();
                }
            } catch(e) { /* chart not ready */ }
        }
        
        function t(key) { return translations[currentLang][key] || key; }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const MAIN_DATA_GID = '290032634';
        const FUSION_EXPORT_GID = '1805754553';
        const PROD_DATA_TOTALS_GID = '430274636'; // Production Data Totals Dashboard (static export, unaffected by filters)
        const CONFIG_GID = '912029812';
        const PALLET_PICTURES_GID = '1879462508';
        const BOM_FINAL_GID = '74377031';
        const BOM_SUB_GID = '206288913';
        const BOM_INDIVIDUAL_GID = '751106736';
        const INVENTORY_HISTORY_GID = '171540940';  // Fusion records export (daily snapshots)
        const FP_REFERENCE_GID = '944406361';  // FP Reference data
        const CUSTOMER_REFERENCE_GID = '336333220';  // Customer Reference data Dashboard
        const QUOTES_REGISTRY_GID = '1279128282';  // Quotes Registry
        const STAGED_RECORDS_GID = '1519623398';  // Staged records dashboard
        const SHIPPING_RECORDS_GID = '1752263458';  // Shipping records dashboard
        // PO # Source: External "Fulfillment Line Data Import" spreadsheet
        const PO_SOURCE_SHEET_ID = '1bQGG8wcnyJpYUQwksvy6oRB1ZCu5VvGzNFwnRWflDhg';
        const PO_SOURCE_GID = '992200772';  // Fulfillment Line Data Import tab
        
        const COL = {
            CATEGORY: 'Category',
            REQUEST_DATE: 'Date of Request',
            PRIORITY: 'Priority Level',
            URGENT: 'Urgent Override',
            LINE: 'Line',
            CUSTOMER: 'Customer',
            IF_NUM: 'IF #',
            PO_NUM: 'PO #',
            ENOUGH_INV: 'Enough inventory for current order',
            NUM_PACKAGES: 'Number of packages',
            PARTS_PER_PACKAGE: 'Parts per package',
            FUSION_INV: 'Fusion inventory',
            HAVE_TIRE: 'Have Tire?',
            HAVE_HUB: 'Have Hub?',
            PART: 'Part #',
            QTY: 'Order Qty',
            PACKAGING: 'Packaging (tipo de empaquetado)',
            TIRE: 'Tire',
            HUB: 'Hub',
            HUB_MOLD: 'Hub Mold',
            BEARINGS: 'Bearings',
            ASSIGNED: 'Assigned to',
            STATUS: 'Work order Internal Status',
            FUSION_STATUS: 'IF Status in Fusion',
            DAYS_UNTIL: 'Days until promise date',
            SHIPPED_DATE: 'Shipped Date',
            REQUESTED_DATE: 'Requested Completion Date',
            REVENUE: 'Revenue',
            PL: 'P/L',
            PL_TOTAL: 'P/L total',
            VARIABLE_COST: 'Variable Cost',
            TOTAL_COST: 'Total Cost'
        };
        
        const COL_ALTS = {
            CATEGORY: ['Category', 'Categoria'],
            REQUEST_DATE: ['Date of Request', 'Fecha de Entrega', 'Requested Completion Date'],
            PRIORITY: ['Priority Level', 'Prioridad', 'Priority'],
            LINE: ['Line', 'Linea'],
            CUSTOMER: ['Customer', 'Cliente'],
            PART: ['Part #', 'Numero de parte', 'RT Part #', 'Part Number'],
            QTY: ['Order Qty', 'Cantidad de la orden', 'Qty', 'Quantity'],
            PACKAGING: ['Packaging (tipo de empaquetado)', 'tipo de empaquetado', 'Packaging'],
            TIRE: ['Tire', 'Tire (Llanta)', 'Llanta'],
            HUB: ['Hub', 'Centro', 'Cubo'],
            HUB_MOLD: ['Hub Mold', 'Hub Mold (Molde del Hub)', 'Molde del Hub'],
            BEARINGS: ['Bearings', 'Bearings (Balero)', 'Balero', 'Baleros'],
            ASSIGNED: ['Assigned to', 'Assigned to:', 'Assigned to: (Asignado a:)', 'Asignado a'],
            STATUS: ['Work order Internal Status', 'Work order Status', 'Status', 'Estado'],
            FUSION_STATUS: ['IF Status in Fusion', 'IF Status', 'Fusion Status'],
            DAYS_UNTIL: ['Days until promise date', 'Days until promise date.', 'Dias faltantes', 'Days until', 'Days remaining'],
            IF_NUM: ['IF #', 'IF#', 'IF Number'],
            PO_NUM: ['PO #', 'PO#', 'PO Number', 'Purchase Order'],
            ENOUGH_INV: ['Enough inventory for current order', 'Enough Inventory', 'Enough inventory'],
            NUM_PACKAGES: ['Number of packages', 'Numero de paquetes', 'NÃºmero de paquetes'],
            PARTS_PER_PACKAGE: ['Parts per package', 'Partes por paquete'],
            FUSION_INV: ['Fusion inventory', 'Fusion Inventory', 'Inventario en Fusion'],
            HAVE_TIRE: ['Have Tire?', 'Have Tire', 'Tiene Llanta?'],
            HAVE_HUB: ['Have Hub?', 'Have Hub', 'Tiene Hub?'],
            PL: ['P/L', 'P/L total', 'PL', 'Profit/Loss'],
            REVENUE: ['Revenue', 'Total Sell Price', 'Sales']
        };
        
        function getVal(row, key) {
            const normalize = s => s.toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (row[COL[key]] !== undefined && row[COL[key]] !== null) return row[COL[key]];
            const alts = COL_ALTS[key];
            if (alts) {
                for (const alt of alts) {
                    if (row[alt] !== undefined && row[alt] !== null) return row[alt];
                }
            }
            const targetNames = alts ? [COL[key], ...alts] : [COL[key]];
            for (const target of targetNames) {
                if (!target) continue;
                const targetNorm = normalize(target);
                for (const k of Object.keys(row)) {
                    if (normalize(k) === targetNorm) return row[k];
                }
            }
            return null;
        }
        
        // State
        let allData = [];
        let allRawData = []; // Stores ALL columns A-AX for All Data page
        let allRawHeaders = []; // Column headers from spreadsheet
        let poLookupMap = {}; // PO # lookup by IF # (loaded from Fulfillment Line Data Import)
        let inventoryData = [];
        let palletData = []; // Stores pallet pictures data
        let bomFinalData = [], bomSubData = [], bomIndividualData = [];
        let currentBomTab = 'final';
        
        // Reference Data state (FP Reference, Customer Reference, Quotes Registry)
        let fpReferenceData = [];
        let fpReferenceHeaders = [];
        let customerReferenceData = [];
        let customerReferenceHeaders = [];
        let quotesRegistryData = [];
        let quotesRegistryHeaders = []; // Now loaded from spreadsheet (columns A-J only)
        
        // New Record Sections state (Pallet, Shipping, Staged)
        let palletRecordsData = [];
        let palletRecordsLoaded = false;
        let shippingRecordsData = [];
        let shippingRecordsLoaded = false;
        let stagedRecordsData = [];
        let stagedRecordsLoaded = false;
        
        // Category filters for new record sections
        let palletRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let shippingRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let stagedRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        
        // Sort state for new record sections
        let palletRecordsSort = { field: null, asc: true };
        let shippingRecordsSort = { field: null, asc: true };
        let stagedRecordsSort = { field: null, asc: true };
        
        // English headers for the new sections (mapped from bilingual spreadsheet headers)
        const PALLET_RECORDS_HEADERS = ['Timestamp', 'Order Number', 'Pallet Number', 'Pallet Picture 1', 'Pallet Weight (lbs)', 'Pallet Dimensions', 'Pallet Picture 2', 'Pallet Picture 3', 'Pallet Picture 4', 'Pallet Picture 5', 'Parts/Boxes per Pallet', 'Customer', 'IF Number', 'Category'];
        const SHIPPING_RECORDS_HEADERS = ['Timestamp', 'Carrier', 'IF Number', 'System', 'Order Number', 'Shipment Pictures', 'Paperwork Pictures', 'Close Up Pictures', 'Customer', 'Category'];
        const STAGED_RECORDS_HEADERS = ['Timestamp', 'Line Number', 'IF Number', 'Order Quantity', 'Number of Pallets', 'Staged By', 'Comments', 'Order Status', 'Staged in Fusion', 'Pallet Dimensions', 'Pallet Weight (lbs)', 'Confirmed Staged', 'Fusion Pictures', 'Customer', 'Category'];
        
        // Spanish headers for the new sections
        const PALLET_RECORDS_HEADERS_ES = ['Marca de tiempo', 'NÃºmero de Orden', 'NÃºmero de Paleta', 'Foto de Paleta 1', 'Peso de Paleta (lbs)', 'Dimensiones de Paleta', 'Foto de Paleta 2', 'Foto de Paleta 3', 'Foto de Paleta 4', 'Foto de Paleta 5', 'Partes/Cajas por Paleta', 'Cliente', 'NÃºmero IF', 'CategorÃ­a'];
        const SHIPPING_RECORDS_HEADERS_ES = ['Marca de tiempo', 'Transportista', 'NÃºmero IF', 'Sistema', 'NÃºmero de Orden', 'Fotos de EnvÃ­o', 'Fotos de Papeleo', 'Fotos de Primer Plano', 'Cliente', 'CategorÃ­a'];
        const STAGED_RECORDS_HEADERS_ES = ['Marca de tiempo', 'NÃºmero de LÃ­nea', 'NÃºmero IF', 'Cantidad de Orden', 'NÃºmero de Paletas', 'Staging por', 'Comentarios', 'Estado de Orden', 'Staging en Fusion', 'Dimensiones de Paleta', 'Peso de Paleta (lbs)', 'Staging Confirmado', 'Fotos de Fusion', 'Cliente', 'CategorÃ­a'];
        
        // Inventory History state (for historical tracking charts)
        let inventoryHistoryData = [];      // Raw data: [{partNumber, dataByDate: {date: qty}}]
        let inventoryHistoryDates = [];     // Array of available dates (sorted)
        let inventoryHistoryLoaded = false; // Lazy loading flag
        let currentHistoryPart = null;      // Currently viewed part in history modal
        let historyDateRange = { start: null, end: null }; // Date range filter
        
        // Multi-part history page state
        let selectedHistoryParts = new Set();  // Selected parts for comparison
        let historyPageDateRange = { start: null, end: null }; // Date range for history page
        const historyPartColors = [
            '#3182ce', '#38a169', '#d69e2e', '#805ad5', '#dd6b20',
            '#319795', '#e53e3e', '#667eea', '#48bb78', '#ed8936'
        ]; // Colors for multi-part chart
        
        let config = {};
        let charts = {};
        let currentPage = 'main';
        let currentPalletOrder = null; // Currently viewed pallet order
        
        // Filter states for each page
        let ordersDataFilters = { categories: { rolltech: true, molding: true, snappad: true }, statuses: { pending: true, wip: true, staged: true, shipped: false } };
        let ordersQueueFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersStagedFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersShippedFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let salesFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let datesFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let partsFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        let customersFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        
        // Sort states
        let ordersDataSort = { field: 'daysUntil', asc: true };
        let ordersQueueSort = { field: 'default', asc: true };
        let ordersStagedSort = { field: 'customer', asc: true };
        let ordersShippedSort = { field: 'shippedDate', asc: false };
        let invFilter = 'all';
        let invSourceFilters = new Set(); // 'make', 'purchased', 'com'
        let invConditionFilters = new Set(); // 'low', 'needed', 'runningLow'
        let invSort = { field: 'partNumber', asc: true };
        let partsSort = { field: 'pl', asc: false };
        let customersSort = { field: 'pl', asc: false };
        let datesSort = { field: 'month', asc: false };
        let partsCustomerDrilldownSort = { field: 'pl', asc: false };
        let customersProductDrilldownSort = { field: 'pl', asc: false };
        let allDataSort = { field: null, asc: true };
        let fpRefSort = { field: null, asc: true };
        let custRefSort = { field: null, asc: true };
        let quotesSort = { field: null, asc: true };
        
        // Column Filter System State
        let columnFilters = {}; // { tableId: { columnKey: Set(selectedValues) } }
        let hiddenColumns = {}; // { tableId: Set(columnKeys) }
        let activeFilterDropdown = null; // { tableId, columnKey, allValues, selectedValues }
        
        // Drilldown state
        let currentDrilldownPart = null;
        let currentDrilldownCustomer = null;
        let currentDrilldownMonth = null;
        
        // Watchlist (localStorage persistence)
        let watchlistParts = [];
        let watchlistCustomers = [];
        try {
            watchlistParts = JSON.parse(localStorage.getItem('rolltech_watchlist_parts') || '[]');
            watchlistCustomers = JSON.parse(localStorage.getItem('rolltech_watchlist_customers') || '[]');
        } catch(e) { console.warn('Could not load watchlist from localStorage'); }

        // ============================================================
        // UTILITIES
        // ============================================================
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,%\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); return parseFloat(c) || 0; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const isEmpty = v => v === null || v === undefined || v === '';
        const isMissingComponent = v => v === null || v === undefined || v === '' || v === '-';
        const hasMissingCostData = row => isEmpty(row[COL.VARIABLE_COST]) || isEmpty(row[COL.TOTAL_COST]) || (isEmpty(row[COL.PL]) && isEmpty(row[COL.PL_TOTAL]));
        const getPLValue = row => { if (!isEmpty(row[COL.PL])) return parseNumber(row[COL.PL]); if (!isEmpty(row[COL.PL_TOTAL])) return parseNumber(row[COL.PL_TOTAL]); return 0; };
        
        // v5 Helper Functions
        const getAttributionDate = row => {
            const status = getStatus(row);
            if (status === 'shipped') return row[COL.SHIPPED_DATE];
            return row[COL.REQUESTED_DATE] || getVal(row, 'REQUEST_DATE');
        };
        
        const getMonthKey = dateStr => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr.substring(0, 7);
        };
        
        const formatMonthLabel = monthKey => {
            if (!monthKey) return '-';
            const [year, month] = monthKey.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(month) - 1]} ${year}`;
        };
        
        const getUnitPrice = row => {
            const unitPrice = parseNumber(row[COL.UNIT_PRICE]);
            if (unitPrice > 0) return unitPrice;
            const revenue = parseNumber(row[COL.REVENUE]);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? revenue / qty : 0;
        };
        
        const getProfitPerPart = row => {
            const pl = getPLValue(row);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? pl / qty : 0;
        };
        
        // Watchlist functions
        function isInWatchlist(type, value) {
            if (type === 'part') return watchlistParts.includes(value);
            if (type === 'customer') return watchlistCustomers.includes(value);
            return false;
        }
        
        function toggleWatchlistPart(part) {
            const idx = watchlistParts.indexOf(part);
            if (idx > -1) watchlistParts.splice(idx, 1);
            else watchlistParts.push(part);
            try { localStorage.setItem('rolltech_watchlist_parts', JSON.stringify(watchlistParts)); } catch(e) {}
            updateSalesPartsPage();
        }
        
        function toggleWatchlistCustomer(customer) {
            const idx = watchlistCustomers.indexOf(customer);
            if (idx > -1) watchlistCustomers.splice(idx, 1);
            else watchlistCustomers.push(customer);
            try { localStorage.setItem('rolltech_watchlist_customers', JSON.stringify(watchlistCustomers)); } catch(e) {}
            updateSalesCustomersPage();
        }
        
        const getContributionBadge = margin => {
            if (margin < -10) return '<span class="badge" style="background:var(--danger);">CRITICAL</span>';
            if (margin < 0) return '<span class="badge" style="background:var(--warning);color:#1a202c;">LOW</span>';
            if (margin < 15) return '<span class="badge" style="background:var(--accent);">TARGET</span>';
            return '<span class="badge" style="background:var(--success);">PROFITABLE</span>';
        };
        
        const getCategory = row => {
            const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        };
        
        const formatCategoryDisplay = cat => {
            if (cat === 'rolltech') return 'Roll Tech';
            if (cat === 'molding') return 'Molding';
            if (cat === 'snappad') return 'Snap Pad';
            return cat || '-';
        };

        // UPDATED: Uses FUSION_STATUS (Col G) as fallback when STATUS (Col H) is empty
        const isCancelledOrClosed = row => {
            const s1 = (getVal(row, 'STATUS') || '').toLowerCase();
            const s2 = (getVal(row, 'FUSION_STATUS') || '').toLowerCase();
            return s1.includes('cancel') || s1.includes('closed') || s2.includes('cancel') || s2.includes('closed');
        };

        const getStatus = row => {
            // Check Work order Internal Status first (Column H)
            let status = (getVal(row, 'STATUS') || '').toLowerCase();
            
            // If STATUS is empty or unclear, use IF Status in Fusion (Column G) as fallback
            if (!status || status === '') {
                status = (getVal(row, 'FUSION_STATUS') || '').toLowerCase();
            }
            
            if (status.includes('cancel')) return 'cancelled';
            if (status.includes('closed')) return 'closed';
            if (status.includes('pending') || status.includes('approved')) return 'pending';
            if (status.includes('staged')) return 'staged';
            if (status.includes('work in progress') || status.includes('wip')) return 'wip';
            if (status.includes('shipped') || status.includes('invoiced') || status.includes('to bill')) return 'shipped';
            return status;
        };
        
        // UPDATED: Uses translated labels
        const getStatusBadge = status => {
            const s = (status || '').toLowerCase();
            if (s.includes('shipped') || s === 'shipped') return `<span class="badge shipped">${t('status.shipped')}</span>`;
            if (s.includes('pending') || s.includes('approved') || s === 'pending') return `<span class="badge pending">${t('status.needToMake')}</span>`;
            if (s.includes('staged') || s === 'staged') return `<span class="badge staged">${t('status.readyToShip')}</span>`;
            if (s.includes('work in progress') || s.includes('wip') || s === 'wip') return `<span class="badge wip">${t('status.making')}</span>`;
            return `<span class="badge">${status || '-'}</span>`;
        };
        
        // UPDATED: Uses translated "URGENT" label
        const getPriorityBadge = (priority, urgent) => {
            const p = parseNumber(priority);
            const uVal = (urgent || '').toString().toLowerCase().trim();
            const isUrgent = uVal === 'urgent' || uVal === 'true' || uVal === '1' || uVal === 'yes' || uVal === 'x';
            if (isUrgent) return `<span class="badge urgent">${t('status.urgent')}</span>`;
            if (p === 1) return '<span class="badge priority-1">P1</span>';
            if (p === 2) return '<span class="badge priority-2">P2</span>';
            if (p === 3) return '<span class="badge priority-3">P3</span>';
            if (p === 4) return '<span class="badge priority-4">P4</span>';
            return `<span class="badge">P${p || '-'}</span>`;
        };
        
        const formatComponent = (value) => {
            if (isMissingComponent(value)) return `<span class="cell-missing">${t('missing')}</span>`;
            if (value === 'NA' || value === 'N/A') return `<span style="color:var(--text-secondary);">NA</span>`;
            return `<span class="cell-available">${value}</span>`;
        };

        // ============================================================
        // COLUMN FILTER SYSTEM
        // ============================================================
        function initTableFilters(tableId) {
            if (!columnFilters[tableId]) columnFilters[tableId] = {};
        }
        
        function createFilterHeader(tableId, columnKey, label, sortable = true) {
            initTableFilters(tableId);
            const isFiltered = columnFilters[tableId][columnKey] && columnFilters[tableId][columnKey].size > 0;
            const filteredClass = isFiltered ? 'filtered' : '';
            const filterIndicator = isFiltered ? ' ðŸ“‹' : '';
            return `<th class="filter-th ${filteredClass}">
                <div class="filter-th-content">
                    <span>${label}${filterIndicator}</span>
                    <div class="filter-th-btns">
                        ${sortable ? `<button onclick="sortTableColumn('${tableId}', '${columnKey}')" title="Sort">â†•</button>` : ''}
                        <button onclick="openColumnFilter('${tableId}', '${columnKey}', this)" title="Filter">Ã¢â€“Â¼</button>
                    </div>
                </div>
            </th>`;
        }
        
        function sortTableColumn(tableId, columnKey) {
            // Delegate to existing sort functions based on tableId
            switch(tableId) {
                case 'parts': sortPartsTable(columnKey); break;
                case 'customers': sortCustomersTable(columnKey); break;
                case 'ordersData': sortOrdersDataTable(columnKey); break;
                case 'ordersQueue': sortOrdersQueueTable(columnKey); break;
                case 'ordersStaged': sortOrdersStagedTable(columnKey); break;
                case 'ordersShipped': sortOrdersShippedTable(columnKey); break;
                case 'inventory': sortInvTable(columnKey); break;
                case 'dates': sortDatesTable(columnKey); break;
                case 'allData': sortAllDataTable(columnKey); break;
                case 'fpRef': sortFpRefTable(columnKey); break;
                case 'custRef': sortCustRefTable(columnKey); break;
                case 'quotes': sortQuotesTable(columnKey); break;
                case 'palletRecords': sortPalletRecordsTable(columnKey); break;
                case 'shippingRecords': sortShippingRecordsTable(columnKey); break;
                case 'stagedRecords': sortStagedRecordsTable(columnKey); break;
                case 'prodMake': sortProdMakeTable(columnKey); break;
                case 'datesMonthlyOrders': sortDatesMonthlyOrdersTable(columnKey); break;
                case 'datesCustomer': sortDatesCustomerTable(columnKey); break;
            }
        }
        
        function openColumnFilter(tableId, columnKey, buttonEl) {
            initTableFilters(tableId);
            const allValues = getUniqueValuesForColumn(tableId, columnKey);
            const currentFilter = columnFilters[tableId][columnKey];
            const selectedValues = currentFilter ? new Set(currentFilter) : new Set(allValues);
            
            activeFilterDropdown = { tableId, columnKey, allValues: [...allValues], selectedValues };
            
            const dropdown = document.getElementById('columnFilterDropdown');
            document.getElementById('filterDropdownTitle').textContent = `Filter: ${columnKey}`;
            document.getElementById('filterDropdownSearch').value = '';
            renderFilterValues(allValues, selectedValues);
            
            // Position dropdown near button
            const rect = buttonEl.getBoundingClientRect();
            dropdown.style.top = Math.min(rect.bottom + 5, window.innerHeight - 420) + 'px';
            dropdown.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
            dropdown.classList.add('active');
        }
        
        function closeFilterDropdown() {
            document.getElementById('columnFilterDropdown').classList.remove('active');
            activeFilterDropdown = null;
        }
        
        function renderFilterValues(values, selectedSet, searchTerm = '') {
            const list = document.getElementById('filterValuesList');
            const filtered = searchTerm ? values.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase())) : values;
            list.innerHTML = filtered.map(v => {
                const checked = selectedSet.has(v) ? 'checked' : '';
                const displayVal = v === '' ? '(empty)' : v;
                return `<div class="filter-value-item">
                    <input type="checkbox" id="fv_${encodeURIComponent(v)}" ${checked} onchange="toggleFilterValue('${encodeURIComponent(v)}')">
                    <label for="fv_${encodeURIComponent(v)}">${displayVal}</label>
                </div>`;
            }).join('');
        }
        
        function filterDropdownSearch() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value;
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function toggleFilterValue(encodedValue) {
            if (!activeFilterDropdown) return;
            const value = decodeURIComponent(encodedValue);
            if (activeFilterDropdown.selectedValues.has(value)) {
                activeFilterDropdown.selectedValues.delete(value);
            } else {
                activeFilterDropdown.selectedValues.add(value);
            }
        }
        
        function filterSelectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.add(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function filterDeselectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.delete(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function clearColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            delete columnFilters[tableId][columnKey];
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function applyColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey, allValues, selectedValues } = activeFilterDropdown;
            
            // If all selected, remove filter; otherwise save it
            if (selectedValues.size === allValues.length) {
                delete columnFilters[tableId][columnKey];
            } else if (selectedValues.size === 0) {
                // Don't allow empty filter - select all instead
                delete columnFilters[tableId][columnKey];
            } else {
                columnFilters[tableId][columnKey] = new Set(selectedValues);
            }
            
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function clearAllTableFilters(tableId) {
            columnFilters[tableId] = {};
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function updateClearAllButton(tableId) {
            const btnId = tableId + 'ClearFiltersBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hasFilters = columnFilters[tableId] && Object.keys(columnFilters[tableId]).length > 0;
                btn.classList.toggle('has-filters', hasFilters);
            }
        }
        
        function refreshTableAfterFilter(tableId) {
            switch(tableId) {
                case 'parts': updateSalesPartsPage(); break;
                case 'customers': updateSalesCustomersPage(); break;
                case 'ordersData': updateOrdersDataPage(); break;
                case 'ordersQueue': updateOrdersQueuePage(); break;
                case 'ordersStaged': updateOrdersStagedPage(); break;
                case 'ordersShipped': updateOrdersShippedPage(); break;
                case 'inventory': renderInvTable(); break;
                case 'dates': updateSalesDatesPage(); break;
                case 'allData': renderAllDataTable(); break;
                case 'fpRef': renderFpRefTable(); break;
                case 'custRef': renderCustRefTable(); break;
                case 'quotes': renderQuotesTable(); break;
                case 'palletRecords': renderPalletRecordsTable(); break;
                case 'shippingRecords': renderShippingRecordsTable(); break;
                case 'stagedRecords': renderStagedRecordsTable(); break;
                case 'prodMake': renderProdMakeTable(); break;
                case 'datesMonthlyOrders': renderDatesMonthlyOrdersTable(); break;
                case 'datesCustomer': renderDatesCustomerTable(); break;
            }
        }
        
        function passesColumnFilter(tableId, columnKey, value) {
            if (!columnFilters[tableId] || !columnFilters[tableId][columnKey]) return true;
            return columnFilters[tableId][columnKey].has(value);
        }
        
        // ============================================================
        // HIDE COLUMNS SYSTEM
        // ============================================================
        function initHiddenColumns(tableId) {
            if (!hiddenColumns[tableId]) {
                hiddenColumns[tableId] = new Set();
                // Default hidden columns per table
                if (tableId === 'ordersQueue') {
                    hiddenColumns[tableId].add('fusionStatus');
                }
            }
        }
        
        function isColumnHidden(tableId, columnKey) {
            return hiddenColumns[tableId] && hiddenColumns[tableId].has(columnKey);
        }
        
        function hideCurrentColumn() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            hideColumn(tableId, columnKey);
            closeFilterDropdown();
        }
        
        function hideColumn(tableId, columnKey) {
            initHiddenColumns(tableId);
            hiddenColumns[tableId].add(columnKey);
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function showAllColumns(tableId) {
            if (hiddenColumns[tableId]) {
                hiddenColumns[tableId].clear();
            }
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function updateShowHiddenButton(tableId) {
            const btnId = tableId + 'ShowHiddenBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hiddenCount = hiddenColumns[tableId] ? hiddenColumns[tableId].size : 0;
                const hasHidden = hiddenCount > 0;
                btn.classList.toggle('has-hidden', hasHidden);
                // Update button text with count
                const spanEl = btn.querySelector('span');
                if (spanEl) {
                    spanEl.textContent = hasHidden ? `${t('ui.showHidden')} (${hiddenCount})` : t('ui.showHidden');
                }
            }
        }
        
        function getVisibleHeaders(tableId, allHeaders) {
            if (!hiddenColumns[tableId] || hiddenColumns[tableId].size === 0) return allHeaders;
            return allHeaders.filter((h, i) => !hiddenColumns[tableId].has(h) && !hiddenColumns[tableId].has(`col_${i}`));
        }
        
        // ============================================================
        // COLUMN TOGGLE SYSTEM (âš™ï¸ Columns button)
        // ============================================================
        let activeColumnToggle = null; // { tableId, columns: [{key, labelEn, labelEs}] }
        
        // Column definitions for each table - defines all possible columns
        const tableColumnDefs = {
            ordersData: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'priority', labelEn: 'Priority', labelEs: 'Prioridad' },
                { key: 'daysUntil', labelEn: 'Days Until', labelEs: 'DÃ­as Restantes' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'tire', labelEn: 'Tire', labelEs: 'Llanta' },
                { key: 'hub', labelEn: 'Hub', labelEs: 'Centro' },
                { key: 'bearings', labelEn: 'Bearings', labelEs: 'Baleros' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' }
            ],
            ordersQueue: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'priority', labelEn: 'Priority', labelEs: 'Prioridad' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'tire', labelEn: 'Tire', labelEs: 'Llanta' },
                { key: 'tireStock', labelEn: 'Tire Stock', labelEs: 'Stock Llanta' },
                { key: 'hub', labelEn: 'Hub', labelEs: 'Centro' },
                { key: 'hubStock', labelEn: 'Hub Stock', labelEs: 'Stock Centro' },
                { key: 'bearings', labelEn: 'Bearings', labelEs: 'Baleros' },
                { key: 'assigned', labelEn: 'Assigned', labelEs: 'Asignado' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' },
                { key: 'fusionStatus', labelEn: 'Fusion Status', labelEs: 'Estado Fusion' }
            ],
            ordersStaged: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'daysUntil', labelEn: 'Days Until', labelEs: 'DÃ­as Restantes' }
            ],
            ordersShipped: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'shippedDate', labelEn: 'Shipped', labelEs: 'Enviado' }
            ],
            inventory: [
                { key: 'product', labelEn: 'Product Type', labelEs: 'Tipo de Producto' },
                { key: 'partNumber', labelEn: 'Part Number', labelEs: 'NÃºmero de Parte' },
                { key: 'fusionQty', labelEn: 'Fusion Qty', labelEs: 'Cant. Fusion' },
                { key: 'minimum', labelEn: 'Minimum', labelEs: 'MÃ­nimo' },
                { key: 'manualTarget', labelEn: 'Manual Target', labelEs: 'Objetivo Manual' },
                { key: 'qtyNeeded', labelEn: 'Qty Needed', labelEs: 'Cant. Necesaria' },
                { key: 'partsToBeMade', labelEn: 'Parts to Make', labelEs: 'Partes a Producir' },
                { key: 'moldType', labelEn: 'Mold Type', labelEs: 'Tipo de Molde' },
                { key: 'avgUsage', labelEn: 'Avg Usage/Day', labelEs: 'Uso Prom/DÃ­a' },
                { key: 'usageTrend', labelEn: 'Trend', labelEs: 'Tendencia' },
                { key: 'daysToMin', labelEn: 'Days to Min', labelEs: 'DÃ­as al MÃ­n' },
                { key: 'daysToZero', labelEn: 'Days to Zero', labelEs: 'DÃ­as a Cero' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' },
                { key: 'itemType', labelEn: 'Item Type', labelEs: 'Tipo de Ãtem' }
            ],
            parts: [
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            customers: [
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            dates: [
                { key: 'month', labelEn: 'Month', labelEs: 'Mes' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            datesMonthlyOrders: [
                { key: 'category', labelEn: 'Category', labelEs: 'CategorÃ­a' },
                { key: 'dateOfRequest', labelEn: 'Date of Request', labelEs: 'Fecha de Solicitud' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'fusionStatus', labelEn: 'IF Status in Fusion', labelEs: 'Estado en Fusion' },
                { key: 'internalStatus', labelEn: 'Internal Status', labelEs: 'Estado Interno' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Order Qty', labelEs: 'Cant. Orden' },
                { key: 'requestedDate', labelEn: 'Requested Date', labelEs: 'Fecha Solicitada' },
                { key: 'unitPrice', labelEn: 'Unit Price', labelEs: 'Precio Unitario' },
                { key: 'contribution', labelEn: 'Contribution Level', labelEs: 'Nivel de ContribuciÃ³n' },
                { key: 'variableCost', labelEn: 'Variable Cost', labelEs: 'Costo Variable' },
                { key: 'totalCost', labelEn: 'Total Cost', labelEs: 'Costo Total' },
                { key: 'salesTarget', labelEn: 'Sales Target (20%)', labelEs: 'Objetivo de Venta (20%)' },
                { key: 'profitPerPart', labelEn: 'Profit/Part', labelEs: 'Ganancia/Parte' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'shippedDate', labelEn: 'Shipped Date', labelEs: 'Fecha de EnvÃ­o' },
                { key: 'shippingCost', labelEn: 'Shipping Cost', labelEs: 'Costo de EnvÃ­o' }
            ],
            datesCustomer: [
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'quantity', labelEn: 'Quantity', labelEs: 'Cantidad' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            palletRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'orderNum', labelEn: 'Order #', labelEs: 'Orden #' },
                { key: 'palletNum', labelEn: 'Pallet #', labelEs: 'Paleta #' },
                { key: 'weight', labelEn: 'Weight', labelEs: 'Peso' },
                { key: 'dimensions', labelEn: 'Dimensions', labelEs: 'Dimensiones' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'photos', labelEn: 'Photos', labelEs: 'Fotos' }
            ],
            shippingRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'carrier', labelEn: 'Carrier', labelEs: 'Transportista' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'system', labelEn: 'System', labelEs: 'Sistema' },
                { key: 'photos', labelEn: 'Photos', labelEs: 'Fotos' }
            ],
            stagedRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'lineNum', labelEn: 'Line #', labelEs: 'LÃ­nea #' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'pallets', labelEn: 'Pallets', labelEs: 'Paletas' },
                { key: 'stagedBy', labelEn: 'Staged By', labelEs: 'Preparado Por' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' }
            ],
            prodMake: [
                { key: 'product', labelEn: 'Product', labelEs: 'Producto' },
                { key: 'partNumber', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'moldType', labelEn: 'Mold Type', labelEs: 'Tipo de Molde' },
                { key: 'fusionInventory', labelEn: 'Fusion Inv', labelEs: 'Inv. Fusion' },
                { key: 'minimums', labelEn: 'Minimums', labelEs: 'MÃ­nimos' },
                { key: 'partsToBeMade', labelEn: 'Parts to Make', labelEs: 'Partes a Fabricar' },
                { key: 'drawing', labelEn: 'Drawing', labelEs: 'Dibujo' }
            ],
            // Dynamic tables - columns read from actual table headers
            allData: 'dynamic',
            fpRef: 'dynamic',
            custRef: 'dynamic',
            quotes: 'dynamic'
        };
        
        // Map tableId to their actual table element IDs
        const tableElementIds = {
            allData: 'allDataTable',
            fpRef: 'fpRefTable',
            custRef: 'custRefTable',
            quotes: 'quotesTable'
        };
        
        function getColumnsFromTable(tableId) {
            const tableElId = tableElementIds[tableId];
            if (!tableElId) return [];
            
            const table = document.getElementById(tableElId);
            if (!table) return [];
            
            const headerRow = table.querySelector('thead tr');
            if (!headerRow) return [];
            
            const columns = [];
            const headers = headerRow.querySelectorAll('th');
            headers.forEach((th, index) => {
                // Get the label text - try to find span first (the label is in the first span)
                let text = '';
                const labelSpan = th.querySelector('.filter-th-content > span');
                if (labelSpan) {
                    // Get only the direct text, not filter indicators
                    text = labelSpan.childNodes[0]?.textContent || labelSpan.textContent || '';
                } else {
                    // Fallback: get first text node only
                    text = th.textContent || '';
                }
                // Clean up - remove any remaining sort arrows, filter symbols, and their Unicode variants
                text = text.replace(/[â†•â–¼ðŸ“‹]/g, '').replace(/[\u25BC\u2195]/g, '').trim();
                if (text) {
                    columns.push({
                        key: `col_${index}`,
                        labelEn: text,
                        labelEs: text // Same text since it comes from sheet
                    });
                }
            });
            return columns;
        }
        
        function openColumnToggle(tableId) {
            if (!tableColumnDefs[tableId]) return;
            initHiddenColumns(tableId);
            
            // Get columns - either from static definition or dynamically from table
            let columns;
            if (tableColumnDefs[tableId] === 'dynamic') {
                columns = getColumnsFromTable(tableId);
                if (columns.length === 0) {
                    // Table not rendered yet, show message
                    columns = [{ key: 'none', labelEn: 'No columns available', labelEs: 'Sin columnas disponibles' }];
                }
            } else {
                columns = tableColumnDefs[tableId];
            }
            
            activeColumnToggle = { tableId, columns: columns };
            
            const dropdown = document.getElementById('columnToggleDropdown');
            const overlay = document.getElementById('columnToggleOverlay');
            const list = document.getElementById('columnToggleList');
            
            // Render column list with checkboxes
            list.innerHTML = activeColumnToggle.columns.map(col => {
                if (col.key === 'none') {
                    return `<div class="column-toggle-item" style="color:var(--text-secondary);font-style:italic;">
                        ${currentLang === 'es' ? col.labelEs : col.labelEn}
                    </div>`;
                }
                const isHidden = hiddenColumns[tableId] && hiddenColumns[tableId].has(col.key);
                const label = currentLang === 'es' ? col.labelEs : col.labelEn;
                const itemClass = isHidden ? 'column-toggle-item hidden-col' : 'column-toggle-item';
                // Use encodeURIComponent for the key to handle special chars
                const safeKey = encodeURIComponent(col.key);
                return `<div class="${itemClass}">
                    <input type="checkbox" id="col_${safeKey}" ${!isHidden ? 'checked' : ''} 
                           onchange="toggleColumnVisibility('${tableId}', '${safeKey}')">
                    <label for="col_${safeKey}">${label}</label>
                </div>`;
            }).join('');
            
            dropdown.classList.add('active');
            overlay.classList.add('active');
        }
        
        function closeColumnToggle() {
            const dropdown = document.getElementById('columnToggleDropdown');
            const overlay = document.getElementById('columnToggleOverlay');
            dropdown.classList.remove('active');
            overlay.classList.remove('active');
            activeColumnToggle = null;
        }
        
        function toggleColumnVisibility(tableId, encodedColumnKey) {
            const columnKey = decodeURIComponent(encodedColumnKey);
            initHiddenColumns(tableId);
            if (hiddenColumns[tableId].has(columnKey)) {
                hiddenColumns[tableId].delete(columnKey);
            } else {
                hiddenColumns[tableId].add(columnKey);
            }
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            
            // Update the visual state of the item in the dropdown
            if (activeColumnToggle && activeColumnToggle.tableId === tableId) {
                const safeKey = encodeURIComponent(columnKey);
                const checkbox = document.getElementById(`col_${safeKey}`);
                if (checkbox) {
                    const item = checkbox.closest('.column-toggle-item');
                    if (item) {
                        item.classList.toggle('hidden-col', hiddenColumns[tableId].has(columnKey));
                    }
                }
            }
        }
        
        function columnSelectAll() {
            if (!activeColumnToggle) return;
            const { tableId } = activeColumnToggle;
            if (hiddenColumns[tableId]) {
                hiddenColumns[tableId].clear();
            }
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            // Re-render list
            openColumnToggle(tableId);
        }
        
        function columnDeselectAll() {
            if (!activeColumnToggle) return;
            const { tableId, columns } = activeColumnToggle;
            initHiddenColumns(tableId);
            columns.forEach(col => hiddenColumns[tableId].add(col.key));
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            // Re-render list
            openColumnToggle(tableId);
        }
        
        function updateColumnsButton(tableId) {
            const btnId = tableId + 'ColumnsBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hiddenCount = hiddenColumns[tableId] ? hiddenColumns[tableId].size : 0;
                const hasHidden = hiddenCount > 0;
                btn.classList.toggle('has-hidden', hasHidden);
                const spanEl = btn.querySelector('span');
                if (spanEl) {
                    spanEl.textContent = hasHidden ? `${t('ui.columns')} (${hiddenCount})` : t('ui.columns');
                }
            }
            // Also update old show-hidden button for backwards compatibility
            updateShowHiddenButton(tableId);
        }
        
        function getUniqueValuesForColumn(tableId, columnKey) {
            const values = new Set();
            
            switch(tableId) {
                case 'parts':
                    return getUniquePartsColumnValues(columnKey);
                case 'customers':
                    return getUniqueCustomersColumnValues(columnKey);
                case 'ordersData':
                case 'ordersQueue':
                case 'ordersStaged':
                case 'ordersShipped':
                    return getUniqueOrdersColumnValues(tableId, columnKey);
                case 'inventory':
                    return getUniqueInventoryColumnValues(columnKey);
                case 'dates':
                    return getUniqueDatesColumnValues(columnKey);
                case 'allData':
                    return getUniqueAllDataColumnValues(columnKey);
                case 'fpRef':
                    return getUniqueFpRefColumnValues(columnKey);
                case 'custRef':
                    return getUniqueCustRefColumnValues(columnKey);
                case 'quotes':
                    return getUniqueQuotesColumnValues(columnKey);
                case 'palletRecords':
                    return getUniquePalletRecordsColumnValues(columnKey);
                case 'shippingRecords':
                    return getUniqueShippingRecordsColumnValues(columnKey);
                case 'stagedRecords':
                    return getUniqueStagedRecordsColumnValues(columnKey);
                case 'prodMake':
                    return getUniqueProdMakeColumnValues(columnKey);
                case 'datesMonthlyOrders':
                    return getUniqueDatesMonthlyOrdersColumnValues(columnKey);
                case 'datesCustomer':
                    return getUniqueDatesCustomerColumnValues(columnKey);
            }
            return Array.from(values).sort();
        }
        
        function getUniqueProdMakeColumnValues(columnKey) {
            const values = new Set();
            prodMakeData.forEach(row => {
                switch(columnKey) {
                    case 'product': values.add(row.product || '-'); break;
                    case 'partNumber': values.add(row.partNumber || '-'); break;
                    case 'moldType': values.add(row.moldType || '-'); break;
                    case 'fusionInventory': values.add(String(row.fusionInventory)); break;
                    case 'minimums': values.add(String(row.minimums)); break;
                    case 'partsToBeMade': values.add(String(row.partsToBeMade)); break;
                }
            });
            return Array.from(values).sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
        }
        
        function getUniquePartsColumnValues(columnKey) {
            const data = getFilteredPartsData();
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(partStats).forEach(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'part': values.add(part); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueCustomersColumnValues(columnKey) {
            const data = getFilteredCustomersData();
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(custStats).forEach(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'customer': values.add(customer); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueOrdersColumnValues(tableId, columnKey) {
            let data = allData;
            // Filter based on table type
            if (tableId === 'ordersQueue') data = data.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            else if (tableId === 'ordersStaged') data = data.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            else if (tableId === 'ordersShipped') data = data.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            else if (tableId === 'ordersData') data = data.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            
            const values = new Set();
            data.forEach(r => {
                switch(columnKey) {
                    case 'line': values.add(getVal(r, 'LINE') || '-'); break;
                    case 'ifNum': values.add(getVal(r, 'IF_NUM') || '-'); break;
                    case 'poNum': values.add(getVal(r, 'PO_NUM') || '-'); break;
                    case 'priority': values.add(getVal(r, 'PRIORITY') || '-'); break;
                    case 'daysUntil': {
                        const days = parseNumber(getVal(r, 'DAYS_UNTIL'));
                        values.add(isNaN(days) ? '-' : String(days));
                        break;
                    }
                    case 'customer': values.add(getVal(r, 'CUSTOMER') || '-'); break;
                    case 'part': values.add(getVal(r, 'PART') || '-'); break;
                    case 'qty': {
                        const qty = parseNumber(getVal(r, 'QTY'));
                        values.add(isNaN(qty) ? '-' : String(qty));
                        break;
                    }
                    case 'status': values.add(getStatus(r)); break;
                    case 'tire': values.add(isMissingComponent(getVal(r, 'TIRE')) ? 'Missing' : 'Available'); break;
                    case 'hub': values.add(isMissingComponent(getVal(r, 'HUB')) ? 'Missing' : 'Available'); break;
                    case 'bearings': values.add(isMissingComponent(getVal(r, 'BEARINGS')) ? 'Missing' : 'Available'); break;
                    case 'assigned': values.add(getVal(r, 'ASSIGNED') || '-'); break;
                    case 'packaging': values.add(getVal(r, 'PACKAGING') || '-'); break;
                    case 'revenue': values.add(formatCurrency(parseNumber(r[COL.REVENUE]) || 0)); break;
                    case 'shippedDate': values.add(getVal(r, 'SHIPPED_DATE') || '-'); break;
                    case 'fusionStatus': values.add(getVal(r, 'FUSION_STATUS') || '-'); break;
                    case 'tireStock': values.add(getVal(r, 'TIRE_STOCK') || '-'); break;
                    case 'hubStock': values.add(getVal(r, 'HUB_STOCK') || '-'); break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueInventoryColumnValues(columnKey) {
            const values = new Set();
            inventoryData.forEach(i => {
                switch(columnKey) {
                    case 'product': values.add(i.product || '-'); break;
                    case 'partNumber': values.add(i.partNumber); break;
                    case 'fusionQty': values.add(String(i.fusionQty)); break;
                    case 'minimum': values.add(String(i.minimum)); break;
                    case 'manualTarget': values.add(String(i.manualTarget)); break;
                    case 'qtyNeeded': values.add(String(i.qtyNeeded)); break;
                    case 'partsToBeMade': values.add(String(i.partsToBeMade)); break;
                    case 'moldType': values.add(i.moldType || '-'); break;
                    case 'itemType': {
                        const t = (i.itemType || '').toLowerCase();
                        if (t.includes('purchased')) values.add('ðŸ›’ Purchased');
                        else if (t.includes('make') || t.includes('manufactured')) values.add('ðŸ­ Manufactured');
                        else if (t.includes('com')) values.add('ðŸ“¦ COM');
                        else values.add('-');
                        break;
                    }
                    case 'avgUsage': {
                        const u = invUsageCache[i.partNumber] || {};
                        if (u.isManufactured && u.prodStats) {
                            values.add(u.prodStats.avgDailyProduction ? u.prodStats.avgDailyProduction.toFixed(1) + ' âš™ï¸' : '-');
                        } else {
                            values.add(u.projectionRate ? u.projectionRate.toFixed(1) : '-');
                        }
                        break;
                    }
                    case 'usageTrend': {
                        const u2 = invUsageCache[i.partNumber] || {};
                        if (u2.isManufactured && u2.prodStats && u2.prodStats.prod7 != null && u2.prodStats.prod30 != null) {
                            if (u2.prodStats.prod7 > u2.prodStats.prod30 * 1.1) values.add('â†‘ Faster');
                            else if (u2.prodStats.prod7 < u2.prodStats.prod30 * 0.9) values.add('â†“ Slower');
                            else values.add('â†’ Stable');
                        } else if (u2.usage7 != null && u2.usage30 != null) {
                            if (u2.usage7 > u2.usage30 * 1.1) values.add('â†‘ Up');
                            else if (u2.usage7 < u2.usage30 * 0.9) values.add('â†“ Down');
                            else values.add('â†’ Stable');
                        } else values.add('-');
                        break;
                    }
                    case 'daysToMin': {
                        const u3 = invUsageCache[i.partNumber] || {};
                        if (u3.isManufactured && u3.prodStats && u3.prodStats.daysToTarget !== null) {
                            values.add(u3.prodStats.daysToTarget + 'd to target');
                        } else {
                            values.add(u3.daysToMin !== null ? (u3.daysToMin === 0 ? 'âš ï¸ NOW' : u3.daysToMin + 'd') : '-');
                        }
                        break;
                    }
                    case 'daysToZero': {
                        const u4 = invUsageCache[i.partNumber] || {};
                        values.add(!u4.isManufactured && u4.daysToZero !== null ? u4.daysToZero + 'd' : '-');
                        break;
                    }
                    case 'status':
                        const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                        const needsMake = i.partsToBeMade > 0;
                        values.add(isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK'));
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueDatesColumnValues(columnKey) {
            const data = getFilteredDatesData();
            const monthStats = {};
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, pl: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (getStatus(r) === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) monthStats[month].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(monthStats).forEach(([month, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'month': values.add(formatMonthLabel(month)); break;
                    case 'status': values.add(`${stats.shipped}/${stats.orders} Shipped`); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('columnFilterDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!dropdown.contains(e.target) && !e.target.closest('.filter-th-btns')) {
                    closeFilterDropdown();
                }
            }
        });

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function fetchSheetData(gid, captureHeaders = false) {
            // Use CSV export instead of gviz JSON to preserve text values in numeric-looking columns
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            
            // Robust CSV parser that handles:
            // - Quoted fields with commas inside
            // - Escaped quotes ("" becomes ")
            // - Newlines inside quoted fields
            // - Inch marks like 8" VSP Mold (stored as "8"" VSP Mold" in CSV)
            function parseCSV(csvText) {
                const rows = [];
                let currentRow = [];
                let currentCell = '';
                let inQuotes = false;
                let i = 0;
                
                while (i < csvText.length) {
                    const char = csvText[i];
                    
                    if (inQuotes) {
                        if (char === '"') {
                            // Check for escaped quote ("")
                            if (csvText[i + 1] === '"') {
                                currentCell += '"';
                                i += 2;
                                continue;
                            } else {
                                // End of quoted field
                                inQuotes = false;
                                i++;
                                continue;
                            }
                        } else {
                            currentCell += char;
                            i++;
                            continue;
                        }
                    }
                    
                    // Not in quotes
                    if (char === '"') {
                        inQuotes = true;
                        i++;
                    } else if (char === ',') {
                        currentRow.push(currentCell);
                        currentCell = '';
                        i++;
                    } else if (char === '\n') {
                        currentRow.push(currentCell);
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                        i++;
                    } else if (char === '\r') {
                        // Skip carriage return
                        i++;
                    } else {
                        currentCell += char;
                        i++;
                    }
                }
                
                // Don't forget the last cell/row
                if (currentCell || currentRow.length > 0) {
                    currentRow.push(currentCell);
                    rows.push(currentRow);
                }
                
                return rows;
            }
            
            const allRows = parseCSV(text);
            if (allRows.length === 0) return [];
            
            const headers = allRows[0].map(h => (h || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
            if (captureHeaders) allRawHeaders = headers.filter(h => h);
            
            return allRows.slice(1).map(cells => {
                const obj = {};
                headers.forEach((h, i) => { if (h) obj[h] = cells[i] || ''; });
                return obj;
            });
        }
        
        // Load PO # data from source sheet (external Fulfillment Line Data Import spreadsheet)
        // This fixes the ARRAYFORMULA/IMPORTRANGE issue where gviz API can't read spilled values
        async function loadPOData() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${PO_SOURCE_SHEET_ID}/gviz/tq?tqx=out:json&gid=${PO_SOURCE_GID}`;
                const res = await fetch(url);
                const text = await res.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                const headers = json.table.cols.map(c => (c.label || '').trim());
                
                // Find column indices for IF # and PO #
                const ifNumCol = headers.findIndex(h => h.toLowerCase() === 'ifnumber' || h.toLowerCase() === 'if #' || h.toLowerCase() === 'if#');
                const poNumCol = headers.findIndex(h => h.toLowerCase() === 'customerpo' || h.toLowerCase() === 'po #' || h.toLowerCase() === 'po#');
                
                if (ifNumCol === -1 || poNumCol === -1) {
                    console.warn('PO Data: Could not find IF # or PO # columns. Headers:', headers);
                    return;
                }
                
                // Build lookup map
                poLookupMap = {};
                json.table.rows.forEach(r => {
                    const ifCell = r.c && r.c[ifNumCol];
                    const poCell = r.c && r.c[poNumCol];
                    const ifNum = ifCell ? (ifCell.v || '') : '';
                    const poNum = poCell ? (poCell.f || poCell.v || '') : '';
                    if (ifNum && poNum) {
                        poLookupMap[ifNum] = String(poNum);
                    }
                });
                console.log(`[PO Data] Loaded ${Object.keys(poLookupMap).length} PO # entries from source sheet`);
            } catch (e) {
                console.warn('PO Data load failed:', e);
            }
        }
        
        async function loadDashboard() {
            try {
                // Load PO data from source sheet first (fixes ARRAYFORMULA issue)
                await loadPOData();
                
                const raw = await fetchSheetData(MAIN_DATA_GID, true); // Pass true to capture headers
                
                // Merge PO # from source sheet into main data
                raw.forEach(r => {
                    const ifNum = r['IF #'] || r['IF#'] || '';
                    if (ifNum && poLookupMap[ifNum]) {
                        r['PO #'] = poLookupMap[ifNum];
                    }
                });
                
                allRawData = raw; // Store ALL raw data for All Data page
                allData = raw.filter(r => {
                    const cat = getCategory(r);
                    return (cat === 'rolltech' || cat === 'molding' || cat === 'snappad') && getVal(r, 'PART');
                });
                if (allData.length === 0) allData = raw.filter(r => getVal(r, 'PART'));
                
                loadInventoryData().catch(e => console.warn('Inventory load failed:', e));
                loadBOMData().catch(e => console.warn('BOM load failed:', e));
                fetchPalletData().catch(e => console.warn('Pallet data load failed:', e));
                
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${allData.length} orders<br>${now.toLocaleTimeString()}`;
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('main').classList.add('active');
                updateMainDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">âš Â Â Error</h3><p>${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }
        
        async function loadInventoryData() {
            try {
                const fusionData = await fetchSheetData(FUSION_EXPORT_GID);
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                const prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum) {
                        const fusionInv = parseNumber(row['Fusion inventory']) || parseNumber(row['Fusion Inventory']);
                        if (partNum === 'FS-TPO' || partNum === 'FS-URTH-BRN') {
                            console.log('Inventory Debug v7.5 - ' + partNum + ':', { 
                                fusionInventory: fusionInv, 
                                rawLower: row['Fusion inventory'], 
                                rawUpper: row['Fusion Inventory'] 
                            });
                        }
                        var drawing1Url = row['Drawing 1 URL'] || row['Drawing 1 url'] || '';
                        var drawing2Url = row['Drawing 2 URL'] || row['Drawing 2 url'] || '';
                        prodTotalsMap[partNum] = {
                            product: row['Product'] || row['product'] || '',
                            qtyNeeded: parseNumber(row['Quantity Needed']),
                            minimums: parseNumber(row['Minimums']),
                            manualTarget: parseNumber(row['Manual target']) || parseNumber(row['Manual Target']),
                            moldType: row['Mold type'] || row['Mold Type'] || '',
                            fusionInventory: fusionInv,
                            partsToBeMade: parseNumber(row['Parts to be made']) || parseNumber(row['Parts to be Made']),
                            drawing1Url: drawing1Url,
                            drawing2Url: drawing2Url,
                            itemType: (row['Make/Purchased/Com'] || '').toString().trim()
                        };
                        // Build global drawing lookup map
                        if (drawing1Url || drawing2Url) {
                            if (!window.drawingMap) window.drawingMap = {};
                            if (!window.drawingTypeMap) window.drawingTypeMap = {};
                            window.drawingMap[partNum] = { drawing1: drawing1Url, drawing2: drawing2Url };
                            var productType = (row['Product'] || row['product'] || '').toString().trim();
                            window.drawingTypeMap[partNum] = productType === 'Tire' ? 'Tire' : productType === 'Hub' ? 'Hub' : (productType || 'Other');
                        }
                    }
                });
                // Expose prodTotalsMap globally for Production Make page
                window.prodTotalsMap = prodTotalsMap;
                const mergedData = [];
                const seenParts = new Set();
                fusionData.forEach(row => {
                    let partNum = (row['itemNumber'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (!partNum) return;
                    seenParts.add(partNum);
                    const prodData = prodTotalsMap[partNum] || {};
                    const fusionTarget = parseNumber(row['Target']);
                    const fusionExportQty = parseNumber(row['Real number value']);
                    // Use Fusion Export qty if available, otherwise fall back to Production Data Totals
                    const finalFusionQty = fusionExportQty > 0 ? fusionExportQty : (prodData.fusionInventory || 0);
                    mergedData.push({
                        partNumber: partNum,
                        product: prodData.product || '',
                        fusionQty: finalFusionQty,
                        minimum: prodData.minimums || fusionTarget || 0,
                        manualTarget: prodData.manualTarget || 0,
                        qtyNeeded: prodData.qtyNeeded || 0,
                        partsToBeMade: prodData.partsToBeMade || 0,
                        moldType: prodData.moldType || '',
                        itemType: prodData.itemType || ''
                    });
                });
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum && !seenParts.has(partNum)) {
                        const data = prodTotalsMap[partNum];
                        mergedData.push({
                            partNumber: partNum,
                            product: data.product || '',
                            fusionQty: data.fusionInventory || 0,
                            minimum: data.minimums || 0,
                            manualTarget: data.manualTarget || 0,
                            qtyNeeded: data.qtyNeeded || 0,
                            partsToBeMade: data.partsToBeMade || 0,
                            moldType: data.moldType || '',
                            itemType: data.itemType || ''
                        });
                    }
                });
                inventoryData = mergedData;
            } catch (e) { console.error('Inventory load error:', e); inventoryData = []; }
        }
        
        // Load historical inventory data (lazy loaded when needed)
        async function loadInventoryHistoryData() {
            if (inventoryHistoryLoaded) return; // Already loaded
            try {
                console.log('Loading inventory history data...');
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${INVENTORY_HISTORY_GID}`;
                const response = await fetch(url);
                const csvText = await response.text();
                
                // Parse CSV manually to preserve date headers
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.warn('No inventory history data found');
                    inventoryHistoryLoaded = true;
                    return;
                }
                
                // Parse header row to get dates (skip first column which is itemNumber)
                const headerRow = parseCSVLine(lines[0]);
                inventoryHistoryDates = [];
                for (let i = 1; i < headerRow.length; i++) {
                    const dateStr = headerRow[i].trim().replace(/^"|"$/g, '');
                    if (dateStr && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        inventoryHistoryDates.push(dateStr);
                    }
                }
                console.log(`Found ${inventoryHistoryDates.length} date columns`);
                
                // Parse data rows
                inventoryHistoryData = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    const partNumber = (row[0] || '').trim().replace(/^"|"$/g, '');
                    if (!partNumber) continue;
                    
                    const dataByDate = {};
                    for (let j = 1; j < row.length && j <= inventoryHistoryDates.length; j++) {
                        const qty = parseNumber(row[j]);
                        const date = inventoryHistoryDates[j - 1];
                        if (date) dataByDate[date] = qty;
                    }
                    
                    inventoryHistoryData.push({ partNumber, dataByDate });
                }
                console.log(`Loaded history for ${inventoryHistoryData.length} parts`);
                inventoryHistoryLoaded = true;
            } catch (e) {
                console.error('Inventory history load error:', e);
                inventoryHistoryData = [];
                inventoryHistoryDates = [];
            }
        }
        
        // Helper to parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        async function loadBOMData() {
            try {
                bomIndividualData = await fetchSheetData(BOM_INDIVIDUAL_GID);
                bomSubData = await fetchSheetData(BOM_SUB_GID);
                bomFinalData = await fetchSheetData(BOM_FINAL_GID);
            } catch (e) { console.warn('BOM load error:', e); }
        }
        
        async function fetchPalletData() {
            try {
                const data = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Raw pallet data first row keys:', data.length > 0 ? Object.keys(data[0]) : 'no data');
                console.log('Raw pallet data sample row:', data[0]);
                
                palletData = data.map(row => {
                    // Get all keys to find the right columns
                    const keys = Object.keys(row);
                    
                    // Find order number - try various patterns
                    let orderNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('order') && k.toLowerCase().includes('number')) {
                            orderNum = row[k];
                            break;
                        }
                    }
                    if (!orderNum) orderNum = row[keys[1]] || ''; // Fallback to column B
                    
                    // Find pallet number
                    let palletNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('pallet') && k.toLowerCase().includes('number')) {
                            palletNum = row[k];
                            break;
                        }
                    }
                    if (!palletNum) palletNum = row[keys[2]] || ''; // Fallback to column C
                    
                    // Find picture URL
                    let pictureUrl = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('picture') && !k.includes('2') && !k.includes('3') && !k.includes('4') && !k.includes('5')) {
                            pictureUrl = row[k];
                            break;
                        }
                    }
                    if (!pictureUrl) pictureUrl = row[keys[3]] || ''; // Fallback to column D
                    
                    // Find weight
                    let weight = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('weight')) {
                            weight = row[k];
                            break;
                        }
                    }
                    if (!weight) weight = row[keys[4]] || ''; // Fallback to column E
                    
                    // Find dimensions
                    let dims = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('dimension')) {
                            dims = row[k];
                            break;
                        }
                    }
                    if (!dims) dims = row[keys[5]] || ''; // Fallback to column F
                    
                    // Find parts/boxes per pallet (Column K)
                    let partsBoxes = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('parts') || k.toLowerCase().includes('boxes') || k.toLowerCase().includes('per pallet')) {
                            partsBoxes = row[k];
                            break;
                        }
                    }
                    if (!partsBoxes) partsBoxes = row[keys[10]] || ''; // Fallback to column K (index 10)
                    
                    return {
                        orderNumber: String(orderNum).trim(),
                        palletNumber: palletNum,
                        pictureUrl: pictureUrl,
                        weight: weight,
                        dimensions: dims,
                        partsPerPallet: partsBoxes
                    };
                }).filter(p => p.orderNumber && p.orderNumber !== '');
                
                console.log('Pallet data loaded:', palletData.length, 'entries');
                if (palletData.length > 0) {
                    console.log('Sample parsed pallet:', palletData[0]);
                    // Log unique order numbers for debugging
                    const uniqueOrders = [...new Set(palletData.map(p => p.orderNumber))];
                    console.log('Unique order numbers in pallet data:', uniqueOrders.slice(0, 20));
                }
            } catch (e) { 
                console.error('Pallet data load error:', e); 
                palletData = []; 
            }
        }

        // ============================================================
        // SALES PASSWORD PROTECTION
        // ============================================================
        // Simple hash function to obscure password (not cryptographically secure, but deters casual inspection)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        const SALES_HASH = '2001594324'; // Hash of 'Sales@@@'
        let salesUnlocked = sessionStorage.getItem('salesUnlocked') === 'true';
        
        function checkSalesUnlock() {
            if (salesUnlocked) {
                // Show Sales & Finance items
                document.getElementById('salesNavItems').style.display = 'block';
                document.getElementById('salesNavTitle').classList.remove('sales-locked');
                document.getElementById('salesNavTitle').classList.add('sales-unlocked');
                document.getElementById('salesNavTitle').onclick = null;
                document.getElementById('salesNavTitle').innerHTML = '<span class="lock-icon">ðŸ”“</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>';
                
                // Show BOM Explorer section
                document.getElementById('bomNavSection').style.display = 'block';
                
                // Unlock All Data nav item
                const allDataNav = document.getElementById('allDataNavItem');
                allDataNav.classList.remove('locked-item');
                allDataNav.onclick = function() { navigateTo('all-data'); };
                
                // Unlock FP Reference nav item
                const fpRefNav = document.getElementById('fpRefNavItem');
                if (fpRefNav) {
                    fpRefNav.classList.remove('locked-item');
                    fpRefNav.onclick = function() { navigateTo('fp-reference'); };
                }
                
                // Unlock Customer Reference nav item
                const custRefNav = document.getElementById('custRefNavItem');
                if (custRefNav) {
                    custRefNav.classList.remove('locked-item');
                    custRefNav.onclick = function() { navigateTo('customer-reference'); };
                }
                
                // Unlock Quotes Registry nav item
                const quotesNav = document.getElementById('quotesNavItem');
                if (quotesNav) {
                    quotesNav.classList.remove('locked-item');
                    quotesNav.onclick = function() { navigateTo('quotes-registry'); };
                }
                
                // Remove financial-hidden class from body to show financial data
                document.body.classList.remove('financial-hidden');
            } else {
                // Add financial-hidden class to body to hide financial data
                document.body.classList.add('financial-hidden');
            }
        }
        
        // Handle All Data click - prompts for password if locked
        function handleAllDataClick() {
            if (salesUnlocked) {
                navigateTo('all-data');
            } else {
                promptSalesPassword('all-data');
            }
        }
        
        let pendingPasswordNavigation = null; // Track where to navigate after unlock
        
        function promptSalesPassword(navigateTo = null) {
            pendingPasswordNavigation = navigateTo;
            document.getElementById('salesPasswordInput').value = '';
            document.getElementById('passwordError').classList.remove('show');
            document.getElementById('passwordModalOverlay').classList.add('active');
            document.getElementById('passwordModal').classList.add('active');
            // Focus the input after a brief delay to ensure modal is visible
            setTimeout(() => document.getElementById('salesPasswordInput').focus(), 100);
        }
        
        function closePasswordModal() {
            document.getElementById('passwordModalOverlay').classList.remove('active');
            document.getElementById('passwordModal').classList.remove('active');
            pendingPasswordNavigation = null;
        }
        
        function handlePasswordKeyup(event) {
            if (event.key === 'Enter') submitSalesPassword();
            if (event.key === 'Escape') closePasswordModal();
        }
        
        function submitSalesPassword() {
            const password = document.getElementById('salesPasswordInput').value;
            if (simpleHash(password) === SALES_HASH) {
                salesUnlocked = true;
                sessionStorage.setItem('salesUnlocked', 'true');
                checkSalesUnlock();
                closePasswordModal();
                // Navigate if there was a pending navigation
                if (pendingPasswordNavigation) {
                    navigateTo(pendingPasswordNavigation);
                    pendingPasswordNavigation = null;
                }
            } else {
                document.getElementById('passwordError').textContent = 'Incorrect password. Please try again.';
                document.getElementById('passwordError').classList.add('show');
                document.getElementById('salesPasswordInput').value = '';
                document.getElementById('salesPasswordInput').focus();
            }
        }
        
        // Check unlock state on page load
        document.addEventListener('DOMContentLoaded', checkSalesUnlock);

        // ============================================================
        // NAVIGATION
        // ============================================================
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const hideBtn = document.getElementById('sidebarToggleBtn');
            const tabBtn = document.getElementById('sidebarTabBtn');
            const main = document.querySelector('.main-content');
            const overlay = document.querySelector('.sidebar-overlay');
            const isMobile = window.innerWidth <= 480;
            
            const isCollapsed = sidebar.classList.toggle('collapsed');
            
            if (isMobile) {
                // On mobile: show overlay when sidebar is open (not collapsed)
                if (overlay) overlay.classList.toggle('active', !isCollapsed);
            } else {
                // On desktop: no overlay needed
                if (overlay) overlay.classList.remove('active');
            }
            
            main.classList.toggle('expanded', isCollapsed);
            tabBtn.classList.toggle('visible', isCollapsed);
            hideBtn.textContent = 'âœ• Hide';
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }
        // Restore sidebar state (or auto-collapse on mobile/tablet portrait/small landscape)
        (function initSidebar() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isPortrait = height > width;
            const isLandscape = !isPortrait;
            const isMobile = width <= 480;
            const isTabletPortrait = width > 480 && width <= 1024 && isPortrait;
            const isSmallLandscape = width <= 900 && isLandscape; // iPhone landscape
            const wasCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            // On mobile, tablet portrait, or small landscape: always start collapsed
            if (isMobile || isTabletPortrait || isSmallLandscape || wasCollapsed) {
                document.getElementById('mainSidebar').classList.add('collapsed');
                document.getElementById('sidebarTabBtn').classList.add('visible');
                document.querySelector('.main-content').classList.add('expanded');
            }
        })();
        
        function navigateTo(page) {
            // Check if trying to access sales pages without unlock
            const salesPages = ['sales-overview', 'sales-parts', 'sales-customers', 'sales-dates'];
            if (salesPages.includes(page) && !salesUnlocked) {
                promptSalesPassword(page);
                return; // Password modal will handle navigation after unlock
            }
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            currentPage = page;
            switch(page) {
                case 'main': updateMainDashboard(); break;
                case 'orders-data': updateOrdersDataPage(); break;
                case 'production-make': updateProdMakePage(); break;
                case 'orders-queue': updateOrdersQueuePage(); break;
                case 'orders-staged': updateOrdersStagedPage(); break;
                case 'orders-shipped': updateOrdersShippedPage(); break;
                case 'inventory': updateInventoryPage(); break;
                case 'inventory-history': updateInventoryHistoryPage(); break;
                case 'material-requirements': updateMaterialRequirementsPage(); break;
                case 'drawings-library': updateDrawingsLibrary(); break;
                case 'sales-overview': updateSalesOverview(); break;
                case 'sales-parts': updateSalesPartsPage(); break;
                case 'sales-customers': updateSalesCustomersPage(); break;
                case 'sales-dates': updateSalesDatesPage(); break;
                case 'bom': initBomExplorer(); break;
                case 'all-data': updateAllDataPage(); break;
                case 'fp-reference': updateFpReferencePage(); break;
                case 'customer-reference': updateCustReferencePage(); break;
                case 'quotes-registry': updateQuotesRegistryPage(); break;
                case 'pallet-records': updatePalletRecordsPage(); break;
                case 'shipping-records': updateShippingRecordsPage(); break;
                case 'staged-records': updateStagedRecordsPage(); break;
            }
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
            
            // Render mobile cards if in mobile/tablet mode
            const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
            if (isCardMode) {
                setTimeout(() => {
                    if (page === 'orders-queue' && typeof renderMobileOrderCards === 'function') renderMobileOrderCards('orders-queue');
                    else if (page === 'orders-staged' && typeof renderMobileStagedCards === 'function') renderMobileStagedCards();
                    else if (page === 'inventory' && typeof renderMobileInventoryCards === 'function') renderMobileInventoryCards();
                }, 100);
            }
        }
        
        // Old mobile toggleSidebar replaced by new unified version above

        // ============================================================
        // ZOOM CONTROLS
        // ============================================================
        let currentZoom = 100;
        
        function setZoom(value) {
            value = parseInt(value);
            if (isNaN(value) || value < 50) value = 50;
            if (value > 200) value = 200;
            currentZoom = value;
            document.getElementById('zoomInput').value = value;
            // Apply CSS zoom to html element - this scales everything including sidebar
            document.documentElement.style.zoom = value / 100;
            // Save to localStorage
            try { localStorage.setItem('rolltech_zoom', value); } catch(e) {}
        }
        
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }
        
        function resetZoom() {
            setZoom(100);
        }
        
        function loadSavedZoom() {
            try {
                const saved = localStorage.getItem('rolltech_zoom');
                if (saved) {
                    setZoom(parseInt(saved));
                }
            } catch(e) {}
        }

        // ============================================================
        // MAIN DASHBOARD
        // ============================================================
        function updateMainDashboard() {
            const rollTechData = allData.filter(r => getCategory(r) === 'rolltech');
            const needToMakeOrders = rollTechData.filter(r => getStatus(r) === 'pending' || getStatus(r) === 'wip');
            const urgentOrders = needToMakeOrders.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent');
            const totalQty = needToMakeOrders.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthData = rollTechData.filter(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return false;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                return month === currentMonth;
            });
            const monthRevenue = monthData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const monthPL = monthData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            const missingComponents = needToMakeOrders.filter(r => {
                return isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
            }).length;
            
            document.getElementById('qsNeedToMake').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('qsUrgentOrders').textContent = formatNumber(urgentOrders.length);
            document.getElementById('qsUrgentOrders').className = `value ${urgentOrders.length > 0 ? 'negative' : ''}`;
            document.getElementById('qsTotalQty').textContent = formatNumber(totalQty);
            document.getElementById('qsMissingComponents').textContent = formatNumber(missingComponents);
            
            document.getElementById('deptProdOrders').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('deptProdUnits').textContent = formatNumber(totalQty);
            document.getElementById('deptProdUrgent').textContent = formatNumber(urgentOrders.length);
            
            renderMainStatusChart(rollTechData.filter(r => getStatus(r) !== 'shipped'));
            renderMainDeadlineChart(needToMakeOrders);
        }
        
        function renderMainStatusChart(data) {
            const statusCounts = { pending: 0, wip: 0, staged: 0 };
            data.forEach(r => { const s = getStatus(r); if (statusCounts[s] !== undefined) statusCounts[s]++; });
            const labels = [t('status.needToMake'), t('status.making'), t('status.readyToShip')];
            const values = [statusCounts.pending, statusCounts.wip, statusCounts.staged];
            const colors = ['#d69e2e', '#319795', '#4299e1'];
            if (charts.mainStatus) charts.mainStatus.destroy();
            charts.mainStatus = new Chart(document.getElementById('mainStatusChart'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 11 } } } } }
            });
        }
        
        function renderMainDeadlineChart(data) {
            const deadlines = {};
            for (let i = -7; i <= 14; i++) deadlines[i] = 0;
            data.forEach(r => { const days = parseNumber(getVal(r, 'DAYS_UNTIL')); if (days >= -7 && days <= 14) deadlines[days]++; });
            const labels = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return `${Math.abs(n)}d late`; if (n === 0) return 'Today'; return `${n}d`; });
            const values = Object.values(deadlines);
            const colors = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return 'rgba(229,62,62,0.8)'; if (n <= 2) return 'rgba(214,158,46,0.8)'; return 'rgba(49,130,206,0.8)'; });
            if (charts.mainDeadline) charts.mainDeadline.destroy();
            charts.mainDeadline = new Chart(document.getElementById('mainDeadlineChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // ============================================================
        // ORDERS DATA PAGE (All orders with status filters)
        // ============================================================
        function toggleOrdersDataCategory(cat) {
            ordersDataFilters.categories[cat] = !ordersDataFilters.categories[cat];
            if (!ordersDataFilters.categories.rolltech && !ordersDataFilters.categories.molding && !ordersDataFilters.categories.snappad) { ordersDataFilters.categories[cat] = true; return; }
            document.getElementById('ordersDataBtnRollTech').classList.toggle('active', ordersDataFilters.categories.rolltech);
            document.getElementById('ordersDataBtnMolding').classList.toggle('active', ordersDataFilters.categories.molding);
            document.getElementById('ordersDataBtnSnapPad').classList.toggle('active', ordersDataFilters.categories.snappad);
            updateOrdersDataPage();
        }
        
        function toggleOrdersDataStatus(status) {
            ordersDataFilters.statuses[status] = !ordersDataFilters.statuses[status];
            document.getElementById(`ordersDataStatus${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.toggle('active', ordersDataFilters.statuses[status]);
            updateOrdersDataPage();
        }
        
        function updateOrdersDataPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersDataFilters.categories[cat]) return false;
                if (!ordersDataFilters.statuses[status]) return false;
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const needToMake = data.filter(r => getStatus(r) === 'pending').length;
            const making = data.filter(r => getStatus(r) === 'wip').length;
            const readyToShip = data.filter(r => getStatus(r) === 'staged').length;
            
            document.getElementById('ordersDataTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersDataTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersDataNeedToMake').textContent = formatNumber(needToMake);
            document.getElementById('ordersDataMaking').textContent = formatNumber(making);
            document.getElementById('ordersDataReadyToShip').textContent = formatNumber(readyToShip);
            document.getElementById('ordersDataLastUpdated').textContent = new Date().toLocaleTimeString();
            
            renderOrdersDataTableHeader();
            renderOrdersDataTable(data);
        }
        
        function renderOrdersDataTableHeader() {
            initTableFilters('ordersData');
            initHiddenColumns('ordersData');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'tire', label: t('col.tire') }, { key: 'hub', label: t('col.hub') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'status', label: t('col.status') }
            ];
            document.getElementById('ordersDataTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersData', h.key)) return '';
                return createFilterHeader('ordersData', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersDataTable(data) {
            renderOrdersDataTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const status = getStatus(r);
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersData', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'status', status)) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersDataTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersDataTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isRollTech = getCategory(r) === 'rolltech';
                // Only show missing warning for Roll Tech items
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                const lineNum = getVal(r, 'LINE') || '-';
                const status = getStatus(r);
                // Make all rows clickable to show order details
                const rowClass = 'clickable-row';
                const rowClick = `onclick="showPalletPictures('${lineNum}', this)"`;                
                // Helper for component cells - show N/A for non-Roll Tech
                const formatComponentForCategory = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                let cells = '';
                if (!isColumnHidden('ordersData', 'line')) cells += `<td><strong>${lineNum}</strong></td>`;
                if (!isColumnHidden('ordersData', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersData', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersData', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersData', 'tire')) cells += `<td>${formatComponentForCategory(getVal(r, 'TIRE'))}</td>`;
                if (!isColumnHidden('ordersData', 'hub')) cells += `<td>${formatComponentForCategory(getVal(r, 'HUB'))}</td>`;
                if (!isColumnHidden('ordersData', 'bearings')) cells += `<td>${formatComponentForCategory(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersData', 'status')) cells += `<td>${getStatusBadge(status)}</td>`;
                
                return `<tr class="${rowClass}" ${rowClick} style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersData');
            updateShowHiddenButton('ordersData');
        }
        
        function openOrderDrilldown(lineNum) {
            // Find the order by line number and open appropriate drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                // Load necessary data asynchronously then show drilldown
                const status = getStatus(order);
                (async () => {
                    if (status === 'staged' && !stagedRecordsLoaded) {
                        await loadStagedRecordsData();
                    }
                    if (status === 'shipped' && !shippingRecordsLoaded) {
                        await loadShippingRecordsData();
                    }
                    showPalletPictures(lineNum);
                })();
            }
        }
        
        function openPalletDrilldownFromData(lineNum) {
            // Find the order by line number and open pallet drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                showPalletPictures(lineNum);
            }
        }
        
        function sortOrdersDataTable(field) {
            if (ordersDataSort.field === field) ordersDataSort.asc = !ordersDataSort.asc;
            else { ordersDataSort.field = field; ordersDataSort.asc = true; }
            updateOrdersDataPage();
        }
        
        function filterOrdersDataTable() { updateOrdersDataPage(); }
        
        function exportOrdersDataToCSV() {
            // 1. Get base filtered data (category + status)
            let data = allData.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            
            // 2. Apply column filters (same as renderOrdersDataTable)
            data = data.filter(r => {
                const status = getStatus(r);
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersData', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'status', status)) return false;
                return true;
            });
            
            // 3. Apply sort (same as renderOrdersDataTable)
            data.sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            // 4. Apply search
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                data = data.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            // 5. Define columns (skip hidden)
            const allCols = [
                { key: 'line', header: 'Line', getValue: r => getVal(r, 'LINE') },
                { key: 'ifNum', header: 'IF #', getValue: r => getVal(r, 'IF_NUM') },
                { key: 'poNum', header: 'PO #', getValue: r => getVal(r, 'PO_NUM') },
                { key: 'priority', header: 'Priority', getValue: r => getVal(r, 'PRIORITY') },
                { key: 'daysUntil', header: 'Days Until', getValue: r => getVal(r, 'DAYS_UNTIL') },
                { key: 'customer', header: 'Customer', getValue: r => getVal(r, 'CUSTOMER') },
                { key: 'part', header: 'Part #', getValue: r => getVal(r, 'PART') },
                { key: 'qty', header: 'Qty', getValue: r => getVal(r, 'QTY') },
                { key: 'tire', header: 'Tire', getValue: r => getCategory(r) === 'rolltech' ? getVal(r, 'TIRE') : 'N/A' },
                { key: 'hub', header: 'Hub', getValue: r => getCategory(r) === 'rolltech' ? getVal(r, 'HUB') : 'N/A' },
                { key: 'bearings', header: 'Bearings', getValue: r => getCategory(r) === 'rolltech' ? getVal(r, 'BEARINGS') : 'N/A' },
                { key: 'status', header: 'Status', getValue: r => getStatus(r) }
            ];
            const visibleCols = allCols.filter(c => !isColumnHidden('ordersData', c.key));
            
            // 6. Build CSV
            const headers = visibleCols.map(c => c.header);
            const rows = data.map(r => visibleCols.map(c => '"' + ((c.getValue(r) || '').toString().replace(/"/g, '""')) + '"').join(','));
            downloadCSV([headers.join(','), ...rows].join('\n'), 'orders_data.csv');
        }

        // ============================================================
        // ORDERS QUEUE PAGE (Need to Make = Pending + Approved)
        // ============================================================
        function toggleOrdersQueueCategory(cat) {
            ordersQueueFilters.categories[cat] = !ordersQueueFilters.categories[cat];
            if (!ordersQueueFilters.categories.rolltech && !ordersQueueFilters.categories.molding && !ordersQueueFilters.categories.snappad) { ordersQueueFilters.categories[cat] = true; return; }
            document.getElementById('ordersQueueBtnRollTech').classList.toggle('active', ordersQueueFilters.categories.rolltech);
            document.getElementById('ordersQueueBtnMolding').classList.toggle('active', ordersQueueFilters.categories.molding);
            document.getElementById('ordersQueueBtnSnapPad').classList.toggle('active', ordersQueueFilters.categories.snappad);
            updateOrdersQueuePage();
            // Also update mobile cards if in mobile/tablet mode
            if (document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait')) {
                renderMobileOrderCards('orders-queue');
            }
        }
        
        // ============================================================
        // PRODUCTION MAKE PAGE (Parts to Manufacture from Production Data Totals)
        // ============================================================
        let prodMakeData = [];
        let prodMakeFilter = 'all';
        let prodMakeSortCol = 'partsToBeMade';
        let prodMakeSortDir = 'desc';
        let prodMakeExpandedPart = null;
        
        async function updateProdMakePage() {
            // Show loading state
            document.getElementById('prodMakeTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Loading data...</td></tr>';
            try {
                // Load production data directly from sheet
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                window.prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim();
                    if (partNum) {
                        window.prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            minimums: parseNumber(row['Minimums']),
                            moldType: row['Mold type'] || row['Mold Type'] || '',
                            fusionInventory: parseNumber(row['Fusion inventory']) || parseNumber(row['Fusion Inventory']),
                            partsToBeMade: parseNumber(row['Parts to be made']) || parseNumber(row['Parts to be Made']),
                            drawing1Url: row['Drawing 1 URL'] || '',
                            drawing2Url: row['Drawing 2 URL'] || ''
                        };
                    }
                });
                console.log('Production Make: Loaded', Object.keys(window.prodTotalsMap).length, 'parts');
                buildProdMakeData();
            } catch (e) {
                console.error('Failed to load production data:', e);
                document.getElementById('prodMakeTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#fc8181;">Error loading data. Please refresh.</td></tr>';
            }
        }
        
        function buildProdMakeData() {
            prodMakeData = [];
            for (const [partNum, data] of Object.entries(prodTotalsMap)) {
                const partsToBeMade = parseNumber(data.partsToBeMade) || 0;
                // Only include items that need to be made (parts to be made > 0)
                if (partsToBeMade > 0) {
                    prodMakeData.push({
                        product: data.product || '',
                        partNumber: partNum,
                        moldType: data.moldType || '',
                        fusionInventory: parseNumber(data.fusionInventory) || 0,
                        minimums: parseNumber(data.minimums) || 0,
                        manualTarget: parseNumber(data.manualTarget) || 0,
                        partsToBeMade: partsToBeMade,
                        drawing1: data.drawing1Url || '',
                        drawing2: data.drawing2Url || ''
                    });
                }
            }
            renderProdMakeTable();
        }
        
        function toggleProdMakeCategory(cat) {
            prodMakeFilter = cat;
            // Update button states
            document.querySelectorAll('#production-make .category-btn').forEach(btn => btn.classList.remove('active'));
            if (cat === 'all') {
                document.getElementById('prodMakeBtnAll').classList.add('active');
            } else if (cat === 'Tire') {
                document.getElementById('prodMakeBtnTire').classList.add('active');
            } else if (cat === 'Hub') {
                document.getElementById('prodMakeBtnHub').classList.add('active');
            } else if (cat === 'Rubber molded finished part') {
                document.getElementById('prodMakeBtnFinished').classList.add('active');
            } else if (cat === 'Bearing') {
                document.getElementById('prodMakeBtnBearing').classList.add('active');
            }
            renderProdMakeTable();
        }
        
        function sortProdMakeTable(col) {
            if (prodMakeSortCol === col) {
                prodMakeSortDir = prodMakeSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                prodMakeSortCol = col;
                prodMakeSortDir = 'desc';
            }
            renderProdMakeTable();
        }
        
        function filterProdMakeTable() {
            renderProdMakeTable();
        }
        
        function renderProdMakeTable() {
            initHiddenColumns('prodMake');
            initTableFilters('prodMake');
            const searchTerm = (document.getElementById('prodMakeSearch')?.value || '').toLowerCase();
            
            // Filter data
            let filtered = prodMakeData.filter(row => {
                // Category filter
                if (prodMakeFilter !== 'all' && row.product !== prodMakeFilter) return false;
                // Search filter
                if (searchTerm) {
                    const searchStr = (row.partNumber + ' ' + row.moldType + ' ' + row.product).toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                // Column filters
                if (!passesColumnFilter('prodMake', 'product', row.product || '-')) return false;
                if (!passesColumnFilter('prodMake', 'partNumber', row.partNumber || '-')) return false;
                if (!passesColumnFilter('prodMake', 'moldType', row.moldType || '-')) return false;
                if (!passesColumnFilter('prodMake', 'fusionInventory', String(row.fusionInventory))) return false;
                if (!passesColumnFilter('prodMake', 'minimums', String(row.minimums))) return false;
                if (!passesColumnFilter('prodMake', 'partsToBeMade', String(row.partsToBeMade))) return false;
                return true;
            });
            
            // Sort data
            filtered.sort((a, b) => {
                let valA = a[prodMakeSortCol];
                let valB = b[prodMakeSortCol];
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return prodMakeSortDir === 'asc' ? valA - valB : valB - valA;
                }
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if (valA < valB) return prodMakeSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return prodMakeSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update stats
            const totalUnits = filtered.reduce((s, r) => s + r.partsToBeMade, 0);
            document.getElementById('prodMakeTotalParts').textContent = filtered.length;
            document.getElementById('prodMakeTotalUnits').textContent = formatNumber(totalUnits) + ' units';
            document.getElementById('prodMakeTableCount').textContent = filtered.length + ' items';
            
            // Update Columns button and Clear Filters button
            updateColumnsButton('prodMake');
            updateClearAllButton('prodMake');
            
            // Build header with filter support
            const headers = [
                { key: 'product', label: 'Product' },
                { key: 'partNumber', label: 'Part #' },
                { key: 'moldType', label: 'Mold Type' },
                { key: 'fusionInventory', label: 'Fusion Inv' },
                { key: 'minimums', label: 'Minimums' },
                { key: 'partsToBeMade', label: 'Parts to Make' },
                { key: 'drawing', label: 'ðŸ“ Drawing' }
            ];
            const visibleHeaders = headers.filter(h => !isColumnHidden('prodMake', h.key));
            const colSpan = visibleHeaders.length;
            
            document.getElementById('prodMakeTableHeader').innerHTML = visibleHeaders.map(h => {
                if (h.key === 'drawing') {
                    return `<th>${h.label}</th>`;
                }
                return createFilterHeader('prodMake', h.key, h.label, true);
            }).join('');
            
            // Build table rows with hidden column support
            const tbody = document.getElementById('prodMakeTableBody');
            let html = '';
            
            filtered.forEach(row => {
                const hasDrawing = row.drawing1 || row.drawing2;
                const productColor = row.product === 'Tire' ? '#ed8936' : 
                                    row.product === 'Hub' ? '#38b2ac' : 
                                    row.product === 'Bearing' ? '#4a5568' : '#805ad5';
                
                html += `<tr class="clickable-row" onclick="toggleProdMakeDrawing('${row.partNumber}')" style="cursor:pointer;">`;
                if (!isColumnHidden('prodMake', 'product')) html += `<td><span style="background:${productColor};color:white;padding:2px 8px;border-radius:4px;font-size:10px;">${row.product}</span></td>`;
                if (!isColumnHidden('prodMake', 'partNumber')) html += `<td><strong>${row.partNumber}</strong></td>`;
                if (!isColumnHidden('prodMake', 'moldType')) html += `<td>${row.moldType || '-'}</td>`;
                if (!isColumnHidden('prodMake', 'fusionInventory')) html += `<td style="text-align:right;">${formatNumber(row.fusionInventory)}</td>`;
                if (!isColumnHidden('prodMake', 'minimums')) html += `<td style="text-align:right;">${formatNumber(row.minimums)}</td>`;
                if (!isColumnHidden('prodMake', 'partsToBeMade')) html += `<td style="text-align:right;font-weight:bold;color:#ed8936;">${formatNumber(row.partsToBeMade)}</td>`;
                if (!isColumnHidden('prodMake', 'drawing')) html += `<td style="text-align:center;">${hasDrawing ? 'ðŸ“ View' : '-'}</td>`;
                html += `</tr>`;
                
                // Add expanded drawing row if this part is expanded
                if (prodMakeExpandedPart === row.partNumber && hasDrawing) {
                    html += `<tr class="drawing-expanded-row">
                        <td colspan="${colSpan}" style="background:rgba(237,137,54,0.1);padding:16px;border:2px solid #ed8936;">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">`;
                    if (row.drawing1) {
                        const thumb1 = getDriveThumbUrl(row.drawing1, 400);
                        const full1 = getDriveThumbUrl(row.drawing1, 1200);
                        if (thumb1) {
                            html += `<div class="drawing-thumb" onclick="event.stopPropagation();openImageModal('${full1}')">
                                <img src="${thumb1}" alt="Drawing 1" loading="lazy" onerror="this.parentElement.style.display='none'">
                                <div class="drawing-label">Drawing 1</div>
                            </div>`;
                        }
                    }
                    if (row.drawing2) {
                        const thumb2 = getDriveThumbUrl(row.drawing2, 400);
                        const full2 = getDriveThumbUrl(row.drawing2, 1200);
                        if (thumb2) {
                            html += `<div class="drawing-thumb" onclick="event.stopPropagation();openImageModal('${full2}')">
                                <img src="${thumb2}" alt="Drawing 2" loading="lazy" onerror="this.parentElement.style.display='none'">
                                <div class="drawing-label">Drawing 2</div>
                            </div>`;
                        }
                    }
                    html += `</div></td></tr>`;
                }
            });
            
            tbody.innerHTML = html;
        }
        
        function toggleProdMakeDrawing(partNumber) {
            if (prodMakeExpandedPart === partNumber) {
                prodMakeExpandedPart = null;
            } else {
                prodMakeExpandedPart = partNumber;
            }
            renderProdMakeTable();
        }
        
        function exportProdMakeToCSV() {
            const searchTerm = (document.getElementById('prodMakeSearch')?.value || '').toLowerCase();
            let filtered = prodMakeData.filter(row => {
                if (prodMakeFilter !== 'all' && row.product !== prodMakeFilter) return false;
                if (searchTerm) {
                    const searchStr = (row.partNumber + ' ' + row.moldType + ' ' + row.product).toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                return true;
            });
            
            let csv = 'Product,Part Number,Mold Type,Fusion Inventory,Minimums,Parts to Make\\n';
            filtered.forEach(row => {
                csv += `"${row.product}","${row.partNumber}","${row.moldType}",${row.fusionInventory},${row.minimums},${row.partsToBeMade}\\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'parts-to-make-' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function updateOrdersQueuePage() {
            // Queue = "pending" + "wip" statuses (orders still being worked on)
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersQueueFilters.categories[cat] && (status === 'pending' || status === 'wip');
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const isUrgentRow = r => { const u = (getVal(r, 'URGENT') || '').toString().toLowerCase().trim(); return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x'; };
            const urgentCount = data.filter(isUrgentRow).length;
            const dueWeek = data.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; });
            const dueWeekQty = dueWeek.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const componentsReady = data.filter(r => getCategory(r) !== 'rolltech' || (!isMissingComponent(getVal(r,'TIRE')) && !isMissingComponent(getVal(r,'HUB')) && !isMissingComponent(getVal(r,'BEARINGS')))).length;
            const missingOrders = data.filter(r => getCategory(r) === 'rolltech' && (isMissingComponent(getVal(r,'TIRE')) || isMissingComponent(getVal(r,'HUB')) || isMissingComponent(getVal(r,'BEARINGS'))));
            
            document.getElementById('ordersQueueTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersQueueTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueUrgentCount').textContent = formatNumber(urgentCount);
            document.getElementById('ordersQueueDueWeek').textContent = formatNumber(dueWeek.length);
            document.getElementById('ordersQueueDueWeekUnits').textContent = `${formatNumber(dueWeekQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueComponentsReady').textContent = formatNumber(componentsReady);
            document.getElementById('ordersQueueLastUpdated').textContent = new Date().toLocaleTimeString();
            
            if (missingOrders.length > 0) {
                document.getElementById('ordersQueueMissingCount').textContent = missingOrders.length;
                document.getElementById('ordersQueueMissingBanner').classList.add('active');
            } else {
                document.getElementById('ordersQueueMissingBanner').classList.remove('active');
            }
            
            renderOrdersQueueTableHeader();
            renderOrdersQueueTable(data);
        }
        
        function renderOrdersQueueTableHeader() {
            initTableFilters('ordersQueue');
            initHiddenColumns('ordersQueue');
            const headers = [
                { key: 'category', label: t('col.category') },
                { key: 'dueDate', label: t('col.dueDate') },
                { key: 'priority', label: t('col.priority') },
                { key: 'line', label: t('col.line') },
                { key: 'customer', label: t('col.customer') },
                { key: 'ifNum', label: t('col.ifNum') },
                { key: 'fusionStatus', label: t('col.fusionStatus') },
                { key: 'part', label: t('col.part') },
                { key: 'numPackages', label: t('col.numPackages') },
                { key: 'packaging', label: t('col.packaging') },
                { key: 'partsPerPackage', label: t('col.partsPerPackage') },
                { key: 'qty', label: t('col.qty') },
                { key: 'fusionInv', label: t('col.fusionInv') },
                { key: 'tire', label: t('col.tire') },
                { key: 'hub', label: t('col.hub') },
                { key: 'hubMold', label: t('col.hubMold') },
                { key: 'bearings', label: t('col.bearings') },
                { key: 'assigned', label: t('col.assigned') },
                { key: 'status', label: t('col.status') },
                { key: 'daysUntil', label: t('col.daysUntil') }
            ];
            document.getElementById('ordersQueueTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersQueue', h.key)) return '';
                return createFilterHeader('ordersQueue', h.key, h.label, true);
            }).join('');
        }
        
        // Helper: check if inventory is enough
        function hasEnoughInventory(r) {
            const val = (getVal(r, 'ENOUGH_INV') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        function hasTire(r) {
            const val = (getVal(r, 'HAVE_TIRE') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        function hasHub(r) {
            const val = (getVal(r, 'HAVE_HUB') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        
        function renderOrdersQueueTable(data) {
            renderOrdersQueueTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersQueue', 'category', getCategory(r) || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'fusionStatus', getVal(r, 'FUSION_STATUS') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'numPackages', getVal(r, 'NUM_PACKAGES') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'partsPerPackage', getVal(r, 'PARTS_PER_PACKAGE') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersQueue', 'fusionInv', getVal(r, 'FUSION_INV') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hubMold', getVal(r, 'HUB_MOLD') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'status', getStatusBadge(getStatus(r)))) return false;
                if (!passesColumnFilter('ordersQueue', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                return true;
            });
            
            // Default sort: urgent first, then group by category, then by requested completion date
            const catOrder = { 'rolltech': 0, 'molding': 1, 'snappad': 2 };
            const isUrgentItem = r => { const u = (getVal(r, 'URGENT') || '').toString().toLowerCase().trim(); return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x'; };
            sorted.sort((a, b) => {
                let va, vb;
                // Always put urgent items first in default sort
                if (ordersQueueSort.field === 'default') {
                    const urgA = isUrgentItem(a) ? 0 : 1;
                    const urgB = isUrgentItem(b) ? 0 : 1;
                    if (urgA !== urgB) return urgA - urgB;
                    // Then group by category
                    const catA = catOrder[getCategory(a)] ?? 3;
                    const catB = catOrder[getCategory(b)] ?? 3;
                    if (catA !== catB) return catA - catB;
                    va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0);
                    vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0);
                    return va - vb;
                }
                switch(ordersQueueSort.field) {
                    case 'category': va = catOrder[getCategory(a)] ?? 3; vb = catOrder[getCategory(b)] ?? 3; break;
                    case 'dueDate': va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'fusionStatus': va = getVal(a, 'FUSION_STATUS') || ''; vb = getVal(b, 'FUSION_STATUS') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = getVal(a, ordersQueueSort.field) || ''; vb = getVal(b, ordersQueueSort.field) || '';
                }
                if (typeof va === 'string') return ordersQueueSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersQueueSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersQueueSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'LINE') || '').toString().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersQueueTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersQueueTableBody');
            
            let lastCat = null;
            const colCount = document.getElementById('ordersQueueTableHeader').querySelectorAll('th').length;
            
            tbody.innerHTML = sorted.map(r => {
                const cat = getCategory(r);
                const isRollTech = cat === 'rolltech';
                const isUrgent = isUrgentItem(r);
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                
                // Part # coloring: Molding/Snap Pad use inventory check; Roll Tech stays normal
                const partVal = getVal(r, 'PART') || '-';
                let partCell;
                if (cat === 'molding' || cat === 'snappad') {
                    const enough = hasEnoughInventory(r);
                    partCell = enough ? `<strong style="color:#48bb78;">${partVal}</strong>` : `<strong style="color:#fc8181;font-weight:900;">${partVal}</strong>`;
                } else {
                    partCell = `<strong>${partVal}</strong>`;
                }
                
                // Tire coloring: Roll Tech only
                const tireVal = getVal(r, 'TIRE') || '-';
                let tireCell;
                if (isRollTech) {
                    if (tireVal === '-' || !tireVal) { tireCell = '<span style="color:var(--text-secondary);">-</span>'; }
                    else { tireCell = hasTire(r) ? `<span style="color:#48bb78;">${tireVal}</span>` : `<strong style="color:#fc8181;">${tireVal}</strong>`; }
                } else {
                    tireCell = '<span style="color:var(--text-secondary);">N/A</span>';
                }
                
                // Hub coloring: Roll Tech only
                const hubVal = getVal(r, 'HUB') || '-';
                let hubCell;
                if (isRollTech) {
                    if (hubVal === '-' || !hubVal) { hubCell = '<span style="color:var(--text-secondary);">-</span>'; }
                    else { hubCell = hasHub(r) ? `<span style="color:#48bb78;">${hubVal}</span>` : `<strong style="color:#fc8181;">${hubVal}</strong>`; }
                } else {
                    hubCell = '<span style="color:var(--text-secondary);">N/A</span>';
                }
                
                const formatComponentCell = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                // Category group separator
                let catRow = '';
                if (cat !== lastCat) {
                    lastCat = cat;
                    const catLabel = cat === 'rolltech' ? 'Roll Tech' : cat === 'molding' ? 'Molding' : cat === 'snappad' ? 'Snap Pad' : cat;
                    catRow = `<tr class="category-group-header"><td colspan="${colCount || 20}" style="background:var(--card-bg);padding:10px 16px;font-weight:bold;font-size:14px;border-top:2px solid var(--border-color);color:var(--text-primary);">ðŸ“ ${catLabel}</td></tr>`;
                }
                
                let cells = '';
                if (!isColumnHidden('ordersQueue', 'category')) cells += `<td>${cat === 'rolltech' ? 'Roll Tech' : cat === 'molding' ? 'Molding' : cat === 'snappad' ? 'Snap Pad' : cat}</td>`;
                if (!isColumnHidden('ordersQueue', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'line')) cells += `<td><strong>${getVal(r, 'LINE') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersQueue', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'fusionStatus')) cells += `<td>${getVal(r, 'FUSION_STATUS') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'part')) cells += `<td>${partCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'numPackages')) { const npRaw = parseFloat(getVal(r, 'NUM_PACKAGES')); cells += `<td>${npRaw > 0 ? Math.ceil(npRaw) : (getVal(r, 'NUM_PACKAGES') || '-')}</td>`; }
                if (!isColumnHidden('ordersQueue', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'partsPerPackage')) cells += `<td>${getVal(r, 'PARTS_PER_PACKAGE') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersQueue', 'fusionInv')) cells += `<td>${getVal(r, 'FUSION_INV') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'tire')) cells += `<td>${tireCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'hub')) cells += `<td>${hubCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'hubMold')) cells += `<td>${getVal(r, 'HUB_MOLD') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'bearings')) cells += `<td>${formatComponentCell(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'status')) cells += `<td>${getStatusBadge(getStatus(r))}</td>`;
                if (!isColumnHidden('ordersQueue', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                
                const rowStyle = isUrgent ? 'background:rgba(229,62,62,0.25);' : isMissing ? 'background:rgba(229,62,62,0.1);' : '';
                const lineNum = getVal(r, 'LINE') || '';
                const statusVal = getStatus(r);
                const clickable = ` class="clickable-row" style="${rowStyle}cursor:pointer;" onclick="showNtmPalletDetails('${lineNum}', this)"`;
                return `${catRow}<tr${clickable}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersQueue');
            updateShowHiddenButton('ordersQueue');
        }
        
        function sortOrdersQueueTable(field) {
            if (ordersQueueSort.field === field) ordersQueueSort.asc = !ordersQueueSort.asc;
            else { ordersQueueSort.field = field; ordersQueueSort.asc = true; }
            updateOrdersQueuePage();
        }
        
        function filterOrdersQueueTable() { updateOrdersQueuePage(); }
        
        function exportOrdersQueueToCSV() {
            const data = allData.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            const headers = ['Category','Due Date','Priority','Line','Customer','IF #','IF Status','Part #','# Packages','Packaging','Parts/Package','Qty','Fusion Inventory','Tire','Hub','Hub Mold','Bearings','Assigned','Status','Days Until'];
            const rows = data.map(r => [getCategory(r),r[COL.REQUESTED_DATE],getVal(r,'PRIORITY'),getVal(r,'LINE'),getVal(r,'CUSTOMER'),getVal(r,'IF_NUM'),getVal(r,'FUSION_STATUS'),getVal(r,'PART'),getVal(r,'NUM_PACKAGES'),getVal(r,'PACKAGING'),getVal(r,'PARTS_PER_PACKAGE'),getVal(r,'QTY'),getVal(r,'FUSION_INV'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'HUB_MOLD'),getVal(r,'BEARINGS'),getVal(r,'ASSIGNED'),getStatus(r),getVal(r,'DAYS_UNTIL')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_queue.csv');
        }

        // ============================================================
        // ORDERS STAGED PAGE (Ready to Ship)
        // ============================================================
        function toggleOrdersStagedCategory(cat) {
            ordersStagedFilters.categories[cat] = !ordersStagedFilters.categories[cat];
            if (!ordersStagedFilters.categories.rolltech && !ordersStagedFilters.categories.molding && !ordersStagedFilters.categories.snappad) { ordersStagedFilters.categories[cat] = true; return; }
            document.getElementById('ordersStagedBtnRollTech').classList.toggle('active', ordersStagedFilters.categories.rolltech);
            document.getElementById('ordersStagedBtnMolding').classList.toggle('active', ordersStagedFilters.categories.molding);
            document.getElementById('ordersStagedBtnSnapPad').classList.toggle('active', ordersStagedFilters.categories.snappad);
            updateOrdersStagedPage();
        }
        
        async function updateOrdersStagedPage() {
            // Load staged records data for fusion pictures (async)
            if (!stagedRecordsLoaded) {
                await loadStagedRecordsData();
            }
            
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersStagedFilters.categories[cat] && status === 'staged';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const avgValue = data.length > 0 ? totalRevenue / data.length : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersStagedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersStagedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersStagedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersStagedAvgValue').textContent = formatCurrency(avgValue);
            document.getElementById('ordersStagedCustomers').textContent = formatNumber(customers);
            
            renderOrdersStagedTableHeader();
            renderOrdersStagedTable(data);
        }
        
        function renderOrdersStagedTableHeader() {
            initTableFilters('ordersStaged');
            initHiddenColumns('ordersStaged');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }
            ];
            // Only add revenue column if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
            }
            headers.push(
                { key: 'dueDate', label: t('col.dueDate') }, { key: 'daysUntil', label: t('col.daysUntil') },
                { key: 'weight', label: t('col.weight') }, { key: 'dimensions', label: t('col.dimensions') },
                { key: 'assigned', label: t('col.assigned') }, { key: 'pallets', label: 'ðŸ“¦' }
            );
            document.getElementById('ordersStagedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersStaged', h.key)) return '';
                return createFilterHeader('ordersStaged', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersStagedTable(data) {
            renderOrdersStagedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                
                if (!passesColumnFilter('ordersStaged', 'line', line || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (salesUnlocked && !passesColumnFilter('ordersStaged', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                if (!passesColumnFilter('ordersStaged', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'daysUntil', String(daysUntil || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'weight', hasPallets ? formatNumber(totalWeight) + ' lbs' : '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'dimensions', firstDimensions)) return false;
                if (!passesColumnFilter('ordersStaged', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'pallets', hasPallets ? String(pallets.length) : '-')) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                const lineA = getVal(a, 'LINE');
                const lineB = getVal(b, 'LINE');
                const palletA = getPalletDataForOrder(lineA);
                const palletB = getPalletDataForOrder(lineB);
                switch(ordersStagedSort.field) {
                    case 'line': va = parseNumber(lineA); vb = parseNumber(lineB); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'dueDate': 
                        va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); 
                        vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); 
                        break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'weight': 
                        va = palletA.length > 0 ? palletA.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        vb = palletB.length > 0 ? palletB.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        break;
                    case 'pallets':
                        va = palletA.length;
                        vb = palletB.length;
                        break;
                    default: va = getVal(a, ordersStagedSort.field) || ''; vb = getVal(b, ordersStagedSort.field) || '';
                }
                if (typeof va === 'string') return ordersStagedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersStagedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersStagedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersStagedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersStagedTableBody');
            
            // Debug: log line numbers being rendered
            const lineNums = sorted.map(r => getVal(r, 'LINE')).filter(Boolean);
            console.log('Staged orders Line numbers:', lineNums.slice(0, 20));
            
            tbody.innerHTML = sorted.map(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const palletIndicator = hasPallets ? `<span class="pallet-indicator" title="${pallets.length} ${t('pallet.pallets').toLowerCase()}">ðŸ“· ${pallets.length}</span>` : 'ðŸ“‹';
                // Always allow clicking to view drilldown (may have fusion pictures even without pallets)
                const clickHandler = `onclick="showPalletPictures('${line}', this)" style="cursor:pointer;"`;
                
                let cells = '';
                if (!isColumnHidden('ordersStaged', 'line')) cells += `<td><strong>${line || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersStaged', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersStaged', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (!isColumnHidden('ordersStaged', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'weight')) cells += `<td>${hasPallets ? formatNumber(totalWeight) + ' lbs' : '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'dimensions')) cells += `<td>${firstDimensions}</td>`;
                if (!isColumnHidden('ordersStaged', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'pallets')) cells += `<td>${palletIndicator}</td>`;
                
                return `<tr class="clickable-row" ${clickHandler}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersStaged');
            updateShowHiddenButton('ordersStaged');
        }
        
        // Get pallet data for a specific order (by Line number)
        function getPalletDataForOrder(lineNum) {
            if (!lineNum || !palletData || palletData.length === 0) return [];
            const lineStr = String(lineNum).trim();
            const matches = palletData.filter(p => String(p.orderNumber).trim() === lineStr);
            if (matches.length > 0) {
                console.log(`Found ${matches.length} pallets for line ${lineStr}`);
            }
            return matches;
        }
        
        // Get staged records data for an order by IF number or Line number
        function getStagedRecordsForOrder(ifNum, lineNum) {
            if (!stagedRecordsData || stagedRecordsData.length === 0) return null;
            const ifNumNorm = String(ifNum || '').trim().toUpperCase();
            const lineNumNorm = String(lineNum || '').trim();
            
            // Only return records where Order Status = "Staged" (these have the Fusion pictures)
            return stagedRecordsData.find(row => {
                const orderStatus = String(row['Order Status'] || '').trim().toLowerCase();
                // Skip records that are not "Staged" - they don't have fusion pictures
                if (!orderStatus.includes('staged')) return false;
                
                const rowIf = String(row['IF Number'] || '').trim().toUpperCase();
                const rowLine = String(row['Line Number'] || '').trim();
                if (ifNumNorm && rowIf && rowIf.includes(ifNumNorm)) return true;
                if (lineNumNorm && rowLine === lineNumNorm) return true;
                return false;
            });
        }
        
        // Get shipping records data for an order by IF number
        function getShippingRecordsForOrder(ifNum) {
            if (!shippingRecordsData || shippingRecordsData.length === 0) return [];
            const ifNumNorm = String(ifNum || '').trim().toUpperCase();
            if (!ifNumNorm) return [];
            
            return shippingRecordsData.filter(row => {
                const rowIf = String(row['IF Number'] || '').trim().toUpperCase();
                // Check if IF number matches (can be comma-separated or dash-separated)
                if (rowIf.includes(ifNumNorm)) return true;
                // Parse multiple IFs
                const ifNums = rowIf.split(/[,\-\s]+/).map(s => s.trim().toUpperCase());
                return ifNums.includes(ifNumNorm);
            });
        }
        
        // Show pallet pictures modal for an order (using Line number)
        async function showPalletPictures(lineNum, clickedRow) {
            // Ensure staged and shipping records are loaded
            await loadStagedRecordsData();
            await loadShippingRecordsData();
            
            // If clicking the same order, close it
            if (currentPalletOrder === lineNum) {
                closePalletDrilldown();
                return;
            }
            
            // Close any existing drilldown first
            closePalletDrilldown();
            
            const pallets = getPalletDataForOrder(lineNum);
            
            currentPalletOrder = lineNum;
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            const ifNum = orderData ? getVal(orderData, 'IF_NUM') : '';
            const status = orderData ? getStatus(orderData) : '';
            const daysUntil = orderData ? parseNumber(getVal(orderData, 'DAYS_UNTIL')) : 0;
            
            // Calculate days early/late for shipped orders
            let daysEarlyLate = '';
            let daysEarlyLateClass = '';
            if (status === 'shipped' && orderData) {
                const shippedDateStr = orderData[COL.SHIPPED_DATE];
                const requestedDateStr = orderData[COL.REQUESTED_DATE];
                if (shippedDateStr && requestedDateStr) {
                    const shippedDate = parseDate(shippedDateStr);
                    const requestedDate = parseDate(requestedDateStr);
                    if (shippedDate && requestedDate) {
                        const diffDays = Math.round((requestedDate - shippedDate) / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysEarlyLate = `${diffDays} days early`;
                            daysEarlyLateClass = 'positive';
                        } else if (diffDays < 0) {
                            daysEarlyLate = `${Math.abs(diffDays)} days late`;
                            daysEarlyLateClass = 'negative';
                        } else {
                            daysEarlyLate = 'On time';
                            daysEarlyLateClass = 'positive';
                        }
                    }
                }
            }
            
            // Get staged records for fusion picture (for staged orders)
            const stagedRecord = getStagedRecordsForOrder(ifNum, lineNum);
            const fusionPictures = stagedRecord ? (stagedRecord['Fusion Pictures'] || []) : [];
            
            // Get shipping records for shipping photos (for shipped orders)
            const shippingRecords = getShippingRecordsForOrder(ifNum);
            console.log('==== SHIPPING PHOTOS DEBUG ====');
            console.log('IF Number:', ifNum);
            console.log('Shipping records found:', shippingRecords.length);
            if (shippingRecords.length > 0) {
                console.log('First shipping record:', JSON.stringify(shippingRecords[0], null, 2));
            }
            // Aggregate all photos from all matching records
            const shipmentPictures = shippingRecords.flatMap(r => r['Shipment Pictures'] || []);
            const paperworkPictures = shippingRecords.flatMap(r => r['Paperwork Pictures'] || []);
            const closeUpPictures = shippingRecords.flatMap(r => r['Close Up Pictures'] || []);
            console.log('Photos found - Shipment:', shipmentPictures.length, 'Paperwork:', paperworkPictures.length, 'CloseUp:', closeUpPictures.length);
            console.log('============================');
            
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            const numPkgRaw = orderData ? parseFloat(getVal(orderData, 'NUM_PACKAGES')) : 0;
            const totalPalletsExpected = numPkgRaw > 0 ? Math.ceil(numPkgRaw) : 0;
            const palletCountDisplay = totalPalletsExpected > 0 ? `${pallets.length} of ${totalPalletsExpected}` : `${pallets.length}`;
            
            // Build summary section with IF# and days info
            let summaryHtml = `
                <div class="pallet-summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.ifNum')}</div><div class="value">${ifNum || '-'}</div></div>
            `;
            
            if (status === 'staged') {
                // Show days remaining for staged orders
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                summaryHtml += `<div class="pallet-summary-item"><div class="label">${t('col.daysUntil')}</div><div class="value ${daysClass}">${daysUntil} days</div></div>`;
            } else if (status === 'shipped' && daysEarlyLate) {
                // Show days early/late for shipped orders
                summaryHtml += `<div class="pallet-summary-item"><div class="label">Delivery</div><div class="value ${daysEarlyLateClass}">${daysEarlyLate}</div></div>`;
            }
            
            summaryHtml += `
                <div class="pallet-summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${palletCountDisplay}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Build gallery content - horizontal layout with 4 boxes filling full width
            let galleryHtml = '<div class="photo-drilldown-grid">';
            
            // BOX 1: Pallet Details (Blue)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(49, 130, 206, 0.15); border: 1px solid var(--accent); border-top: 4px solid var(--accent);">`;
            galleryHtml += `<h4 style="color: var(--accent);">ðŸ“¦ ${t('photo.palletDetails')}</h4>`;
            if (pallets.length > 0) {
                // Show pallet info with photo thumbnails
                galleryHtml += `<div class="photo-thumbnails" style="margin-bottom: 12px;">`;
                pallets.forEach((p, idx) => {
                    const num = p.palletNumber || (idx + 1);
                    const palletLabel = totalPalletsExpected > 0 ? `Pallet ${num} of ${totalPalletsExpected}` : `Pallet ${num}`;
                    if (p.pictureUrl) {
                        galleryHtml += buildPhotoThumb(p.pictureUrl, palletLabel, 'pallet-photo');
                    }
                });
                galleryHtml += `</div>`;
                galleryHtml += `<div class="photo-info" style="font-size: 11px;">`;
                galleryHtml += pallets.map((p, idx) => `#${p.palletNumber || (idx + 1)}: ${p.weight || '-'}lbs, ${p.dimensions || '-'}`).join(' | ');
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noPalletData')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 2: Fusion Pictures (Teal/Cyan)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(56, 178, 172, 0.15); border: 1px solid #38b2ac; border-top: 4px solid #38b2ac;">`;
            galleryHtml += `<h4 style="color: #38b2ac;">ðŸ“„ ${t('photo.fusionPictures')}</h4>`;
            if (fusionPictures.length > 0) {
                galleryHtml += `<div class="photo-thumbnails">`;
                fusionPictures.forEach((url, i) => {
                    galleryHtml += buildPhotoThumb(url, `Fusion ${i + 1}`, 'fusion-photo');
                });
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noFusionPictures')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 3: Shipment & Paperwork Pictures (Green)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(56, 161, 105, 0.15); border: 1px solid var(--success); border-top: 4px solid var(--success);">`;
            galleryHtml += `<h4 style="color: var(--success);">ðŸšš ${t('photo.shipmentPhotos')}</h4>`;
            if (shipmentPictures.length > 0 || paperworkPictures.length > 0) {
                if (shipmentPictures.length > 0) {
                    galleryHtml += `<div style="margin-bottom: 10px;"><div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">${t('photo.ship')}:</div>`;
                    galleryHtml += `<div class="photo-thumbnails">`;
                    shipmentPictures.forEach((url, i) => {
                        galleryHtml += buildPhotoThumb(url, `${t('photo.ship')} ${i + 1}`, 'shipment-photo');
                    });
                    galleryHtml += `</div></div>`;
                }
                if (paperworkPictures.length > 0) {
                    galleryHtml += `<div><div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">${t('photo.docs')}:</div>`;
                    galleryHtml += `<div class="photo-thumbnails">`;
                    paperworkPictures.forEach((url, i) => {
                        galleryHtml += buildPhotoThumb(url, `Doc ${i + 1}`, 'paperwork-photo');
                    });
                    galleryHtml += `</div></div>`;
                }
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noShipmentPhotos')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 4: Close-Up Pictures (Purple)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(128, 90, 213, 0.15); border: 1px solid #805ad5; border-top: 4px solid #805ad5;">`;
            galleryHtml += `<h4 style="color: #805ad5;">ðŸ” ${t('photo.closeUpPictures')}</h4>`;
            if (closeUpPictures.length > 0) {
                galleryHtml += `<div class="photo-thumbnails">`;
                closeUpPictures.forEach((url, i) => {
                    galleryHtml += buildPhotoThumb(url, `Close-up ${i + 1}`, 'closeup-photo');
                });
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noCloseUpPictures')}</div>`;
            }
            galleryHtml += `</div>`;
            
            galleryHtml += '</div>'; // Close grid
            
            // Add drawing thumbnails for tire and hub (category-aware)
            var drillTirePartNum = orderData ? getVal(orderData, 'TIRE') : '';
            var drillHubPartNum = orderData ? getVal(orderData, 'HUB') : '';
            var drillCategory = orderData ? getCategory(orderData) : '';
            var drillPartNum = orderData ? getVal(orderData, 'PART') : '';
            galleryHtml += buildDrawingThumbnails(drillTirePartNum, drillHubPartNum, drillCategory, drillPartNum);
            
            // Build the full drilldown HTML
            const drilldownHtml = `
                <tr id="orderDrilldownRow" class="order-drilldown-row">
                    <td colspan="20" style="padding: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 0 0 10px 10px;">
                        <div style="padding: 20px 24px;">
                            <div class="pallet-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div class="breadcrumb" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Order Details â€º Line #${lineNum}</div>
                                    <h3 style="font-size: 16px; margin: 0;">Order Photos & Details</h3>
                                </div>
                                <button class="close-btn" onclick="closePalletDrilldown()" style="background: var(--bg-dark); border: 1px solid var(--border); padding: 8px 14px; border-radius: 6px; cursor: pointer; color: var(--text); font-size: 12px;">âœ• Close</button>
                            </div>
                            <div class="pallet-summary" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                                ${summaryHtml}
                            </div>
                            <div style="width: 100%;">
                                ${galleryHtml}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            
            // Find the clicked row and insert drilldown after it
            if (clickedRow) {
                clickedRow.classList.add('drilldown-active');
                clickedRow.insertAdjacentHTML('afterend', drilldownHtml);
            } else {
                // Fallback: find the row by line number
                const allRows = document.querySelectorAll('tr.clickable-row');
                for (const row of allRows) {
                    const lineCell = row.querySelector('td:first-child strong');
                    if (lineCell && lineCell.textContent === String(lineNum)) {
                        row.classList.add('drilldown-active');
                        row.insertAdjacentHTML('afterend', drilldownHtml);
                        break;
                    }
                }
            }
            
            // Scroll the drilldown into view
            const drilldownRow = document.getElementById('orderDrilldownRow');
            if (drilldownRow) {
                drilldownRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function closePalletDrilldown() {
            // Remove any existing drilldown row
            const existingDrilldown = document.getElementById('orderDrilldownRow');
            if (existingDrilldown) {
                existingDrilldown.remove();
            }
            // Remove active state from all rows
            document.querySelectorAll('tr.drilldown-active').forEach(row => row.classList.remove('drilldown-active'));
            currentPalletOrder = null;
        }
        
        // Need to Make - Pallet drilldown for MAKING status rows (pallet details only)
        async function showNtmPalletDetails(lineNum, clickedRow) {
            // Toggle: if clicking same order, close it
            if (currentPalletOrder === lineNum) {
                closePalletDrilldown();
                return;
            }
            closePalletDrilldown();
            
            const pallets = getPalletDataForOrder(lineNum);
            currentPalletOrder = lineNum;
            
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            const ifNum = orderData ? getVal(orderData, 'IF_NUM') : '';
            const qty = orderData ? parseNumber(getVal(orderData, 'QTY')) : 0;
            const numPackagesRaw = orderData ? parseFloat(getVal(orderData, 'NUM_PACKAGES')) : 0;
            const totalPalletsExpected = numPackagesRaw > 0 ? Math.ceil(numPackagesRaw) : 0;
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            const totalParts = pallets.reduce((s, p) => s + parseNumber(p.partsPerPallet || p.boxesPerPallet), 0);
            const palletCountDisplay = totalPalletsExpected > 0 ? `${pallets.length} of ${totalPalletsExpected}` : `${pallets.length}`;
            
            // Summary info
            let summaryHtml = `
                <div class="pallet-summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.ifNum')}</div><div class="value">${ifNum || '-'}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.qty')}</div><div class="value">${formatNumber(qty)}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${palletCountDisplay}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Build pallet details - ONLY pallet box (no fusion, shipping, or close-up)
            let palletHtml = '';
            if (pallets.length > 0) {
                palletHtml += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; width: 100%;">`;
                pallets.forEach((p, idx) => {
                    const num = p.palletNumber || (idx + 1);
                    const photoUrls = p.pictureUrl ? getPhotoUrls(p.pictureUrl) : null;
                    palletHtml += `<div style="background: rgba(49, 130, 206, 0.1); border: 1px solid var(--accent); border-radius: 10px; overflow: hidden;">`;
                    const palletLabel = totalPalletsExpected > 0 ? `ðŸ“¦ Pallet ${num} of ${totalPalletsExpected}` : `ðŸ“¦ Pallet ${num}`;
                    palletHtml += `<div style="padding: 12px 16px; background: rgba(49, 130, 206, 0.15); border-bottom: 1px solid var(--accent);">`;
                    palletHtml += `<strong style="color: var(--accent);">${palletLabel}</strong>`;
                    palletHtml += `</div>`;
                    if (photoUrls) {
                        palletHtml += `<div style="padding: 12px; cursor: pointer;" onclick="openImageModal('${photoUrls.full}')">`;
                        palletHtml += `<img src="${photoUrls.thumb}" alt="Pallet ${num}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px; border: 2px solid var(--border); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'" onerror="this.parentElement.style.display='none'">`;
                        palletHtml += `</div>`;
                    }
                    palletHtml += `<div class="pallet-card-details">`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Weight:</span> <span class="value">${p.weight || '-'} lbs</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Dimensions:</span> <span class="value">${p.dimensions || '-'}</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Parts/Boxes:</span> <span class="value">${p.partsPerPallet || p.boxesPerPallet || '-'}</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Order #:</span> <span class="value">${p.orderNumber || '-'}</span></div>`;
                    palletHtml += `</div></div>`;
                });
                palletHtml += `</div>`;
            } else {
                palletHtml = `<div style="text-align:center; padding: 30px; color: var(--text-secondary);"><p style="font-size: 14px;">ðŸ“¦ ${t('photo.noPalletData')}</p><p style="font-size: 12px; margin-top: 8px;">No pallet records found for Line #${lineNum}</p></div>`;
            }
            
            // Add drawing thumbnails for NTM drilldown (category-aware)
            var ntmTirePartNum = orderData ? getVal(orderData, 'TIRE') : '';
            var ntmHubPartNum = orderData ? getVal(orderData, 'HUB') : '';
            var ntmCategory = orderData ? getCategory(orderData) : '';
            var ntmPartNum = orderData ? getVal(orderData, 'PART') : '';
            var ntmDrawingHtml = buildDrawingThumbnails(ntmTirePartNum, ntmHubPartNum, ntmCategory, ntmPartNum);
            
            const colCount = document.getElementById('ordersQueueTableHeader').querySelectorAll('th').length;
            const drilldownHtml = `
                <tr id="orderDrilldownRow" class="order-drilldown-row">
                    <td colspan="${colCount}" style="padding: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 0 0 10px 10px; margin-top: -1px;">
                        <div style="padding: 20px 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Making â€º Line #${lineNum}</div>
                                    <h3 style="font-size: 16px; margin: 0;">ðŸ“¦ Pallet Details</h3>
                                </div>
                                <button onclick="closePalletDrilldown()" style="background: var(--bg-dark); border: 1px solid var(--border); padding: 8px 14px; border-radius: 6px; cursor: pointer; color: var(--text); font-size: 12px;">âœ• Close</button>
                            </div>
                            <div class="pallet-summary" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                                ${summaryHtml}
                            </div>
                            ${palletHtml}
                            ${ntmDrawingHtml}
                        </div>
                    </td>
                </tr>
            `;
            
            if (clickedRow) {
                clickedRow.classList.add('drilldown-active');
                clickedRow.insertAdjacentHTML('afterend', drilldownHtml);
            }
            
            const drilldownRow = document.getElementById('orderDrilldownRow');
            if (drilldownRow) {
                drilldownRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function openImageModal(imgUrl) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = imgUrl;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        // Get thumbnail and full URLs for a photo (handles Google Drive/Forms and direct URLs)
        function getPhotoUrls(url) {
            if (!url) return null;
            url = String(url).trim();
            if (!url) return null;
            
            var fileId = null;
            
            // Pattern 1: /d/FILEID/ (standard Drive share link)
            var m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (m1) fileId = m1[1];
            
            // Pattern 2: id=FILEID (Google Forms, open?id=, export?id=)
            if (!fileId) {
                var m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (m2) fileId = m2[1];
            }
            
            // Pattern 3: lh3.googleusercontent.com/d/FILEID
            if (!fileId) {
                var m3 = url.match(/googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/);
                if (m3) fileId = m3[1];
            }
            
            // If we found a Google file ID, use thumbnail API
            if (fileId) {
                return {
                    thumb: 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w200',
                    full: 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1200'
                };
            }
            
            // Direct image URL - use as-is for both
            return { thumb: url, full: url };
        }
        
        // Build photo thumbnail HTML
        function buildPhotoThumb(url, label, cssClass) {
            var urls = getPhotoUrls(url);
            if (!urls) return '';
            return '<div class="photo-thumb ' + cssClass + '" onclick="openImageModal(\'' + urls.full + '\')">' +
                   '<img src="' + urls.thumb + '" alt="' + label + '" loading="lazy" onerror="this.parentElement.style.display=\'none\'">' +
                   '<div class="photo-label">' + label + '</div></div>';
        }
        
        // Extract Google Drive file ID from URL and build thumbnail URL
        function getDriveThumbUrl(driveUrl, size) {
            if (!driveUrl) return null;
            var m = driveUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
            return m ? 'https://drive.google.com/thumbnail?id=' + m[1] + '&sz=w' + (size || 400) : null;
        }

        // Build drawing thumbnails HTML â€” category-aware labels
        // For Roll Tech: shows Tire Drawing + Hub Drawing separately
        // For other categories: shows Part Drawing (using part number lookup)
        function buildDrawingThumbnails(tirePartNum, hubPartNum, category, partNum) {
            if (!window.drawingMap) return '';
            var isRollTech = category === 'rolltech';
            var drawings = [];
            
            if (isRollTech) {
                // Roll Tech: separate tire and hub drawings
                var tireDrawings = tirePartNum ? (window.drawingMap[tirePartNum.toString().trim()] || null) : null;
                var hubDrawings = hubPartNum ? (window.drawingMap[hubPartNum.toString().trim()] || null) : null;
                if (tireDrawings) {
                    if (tireDrawings.drawing1) drawings.push({ url: tireDrawings.drawing1, label: t('drawing.tireDrawing') + ' 1', alt: 'Tire Drawing 1' });
                    if (tireDrawings.drawing2) drawings.push({ url: tireDrawings.drawing2, label: t('drawing.tireDrawing') + ' 2', alt: 'Tire Drawing 2' });
                }
                if (hubDrawings) {
                    if (hubDrawings.drawing1) drawings.push({ url: hubDrawings.drawing1, label: t('drawing.hubDrawing') + ' 1', alt: 'Hub Drawing 1' });
                    if (hubDrawings.drawing2) drawings.push({ url: hubDrawings.drawing2, label: t('drawing.hubDrawing') + ' 2', alt: 'Hub Drawing 2' });
                }
            } else {
                // Other categories: look up part number directly
                var partDrawings = partNum ? (window.drawingMap[partNum.toString().trim()] || null) : null;
                if (partDrawings) {
                    if (partDrawings.drawing1) drawings.push({ url: partDrawings.drawing1, label: t('drawing.partDrawing') + ' 1', alt: 'Part Drawing 1' });
                    if (partDrawings.drawing2) drawings.push({ url: partDrawings.drawing2, label: t('drawing.partDrawing') + ' 2', alt: 'Part Drawing 2' });
                }
            }
            
            if (drawings.length === 0) return '';
            
            var html = '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">';
            html += '<h4 style="font-size: 14px; font-weight: 600; color: #ed8936; margin: 0 0 12px 0;">\uD83D\uDCD0 ' + t('drawing.drawings') + '</h4>';
            html += '<div class="drawing-thumbnails">';
            
            drawings.forEach(function(d) {
                var thumbUrl = getDriveThumbUrl(d.url, 400);
                var fullUrl = getDriveThumbUrl(d.url, 1200);
                if (thumbUrl) {
                    html += '<div class="drawing-thumb" onclick="openImageModal(\'' + fullUrl + '\')">';
                    html += '<img src="' + thumbUrl + '" alt="' + d.alt + '" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                    html += '<div class="drawing-label">' + d.label + '</div></div>';
                }
            });
            
            html += '</div></div>';
            return html;
        }
        
        // ============================================================
        // DRAWINGS LIBRARY PAGE
        // ============================================================
        function updateDrawingsLibrary() {
            if (!window.drawingMap) {
                // Drawings not loaded yet â€” try loading inventory data first
                loadInventoryData().then(function() { renderDrawingsLibrary(); });
                return;
            }
            renderDrawingsLibrary();
        }
        
        function filterDrawingsLibrary() {
            renderDrawingsLibrary();
        }
        
        function renderDrawingsLibrary() {
            var grid = document.getElementById('drawingsLibraryGrid');
            var countEl = document.getElementById('drawingsLibraryCount');
            if (!grid) return;
            
            if (!window.drawingMap || Object.keys(window.drawingMap).length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 16px;">ðŸ“ ' + t('drawing.noResults') + '</p></div>';
                if (countEl) countEl.textContent = '0 ' + t('drawing.drawings').toLowerCase();
                return;
            }
            
            var search = (document.getElementById('drawingsSearch')?.value || '').toLowerCase().trim();
            var typeFilter = document.getElementById('drawingsTypeFilter')?.value || 'all';
            
            // Build list of all parts with drawings, with their type from prodTotalsData
            var entries = [];
            var drawingMapKeys = Object.keys(window.drawingMap);
            
            // Also build type info from drawingTypeMap (populated during data load)
            drawingMapKeys.forEach(function(partNum) {
                var d = window.drawingMap[partNum];
                var typeInfo = window.drawingTypeMap ? (window.drawingTypeMap[partNum] || 'Other') : 'Other';
                
                // Apply filters
                if (search && !partNum.toLowerCase().includes(search)) return;
                if (typeFilter !== 'all' && typeInfo !== typeFilter) return;
                
                entries.push({
                    partNum: partNum,
                    type: typeInfo,
                    drawing1: d.drawing1,
                    drawing2: d.drawing2
                });
            });
            
            // Sort: Tires first, then Hubs, then others
            var typeOrder = { 'Tire': 0, 'Hub': 1, 'Other': 2 };
            entries.sort(function(a, b) {
                var ta = typeOrder[a.type] !== undefined ? typeOrder[a.type] : 2;
                var tb = typeOrder[b.type] !== undefined ? typeOrder[b.type] : 2;
                if (ta !== tb) return ta - tb;
                return a.partNum.localeCompare(b.partNum);
            });
            
            if (countEl) countEl.textContent = entries.length + ' ' + t('drawing.drawings').toLowerCase();
            
            if (entries.length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;"><p style="font-size: 16px;">ðŸ“ ' + t('drawing.noResults') + '</p></div>';
                return;
            }
            
            var html = '';
            entries.forEach(function(entry) {
                var typeColor = entry.type === 'Tire' ? '#3182ce' : entry.type === 'Hub' ? '#38b2ac' : '#ed8936';
                var typeBadge = '<span style="background:' + typeColor + '; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">' + entry.type + '</span>';
                
                html += '<div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.borderColor=\'#ed8936\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
                html += '<div style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">';
                html += '<strong style="font-size: 14px; color: var(--text-primary);">' + entry.partNum + '</strong>';
                html += typeBadge;
                html += '</div>';
                html += '<div style="display: flex; gap: 8px; padding: 12px;">';
                
                if (entry.drawing1) {
                    var thumb1 = getDriveThumbUrl(entry.drawing1, 400);
                    var full1 = getDriveThumbUrl(entry.drawing1, 1200);
                    if (thumb1) {
                        html += '<div style="flex: 1; cursor: pointer; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);" onclick="openImageModal(\'' + full1 + '\')">';
                        html += '<img src="' + thumb1 + '" style="width:100%; height: 100px; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                        html += '<div style="padding: 4px; text-align: center; font-size: 10px; color: var(--text-secondary); background: rgba(237,137,54,0.1);">Drawing 1</div>';
                        html += '</div>';
                    }
                }
                
                if (entry.drawing2) {
                    var thumb2 = getDriveThumbUrl(entry.drawing2, 400);
                    var full2 = getDriveThumbUrl(entry.drawing2, 1200);
                    if (thumb2) {
                        html += '<div style="flex: 1; cursor: pointer; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);" onclick="openImageModal(\'' + full2 + '\')">';
                        html += '<img src="' + thumb2 + '" style="width:100%; height: 100px; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                        html += '<div style="padding: 4px; text-align: center; font-size: 10px; color: var(--text-secondary); background: rgba(237,137,54,0.1);">Drawing 2</div>';
                        html += '</div>';
                    }
                }
                
                html += '</div></div>';
            });
            
            grid.innerHTML = html;
        }
        
        function sortOrdersStagedTable(field) {
            if (ordersStagedSort.field === field) ordersStagedSort.asc = !ordersStagedSort.asc;
            else { ordersStagedSort.field = field; ordersStagedSort.asc = true; }
            updateOrdersStagedPage();
        }
        
        function filterOrdersStagedTable() { updateOrdersStagedPage(); }
        
        function exportOrdersStagedToCSV() {
            const data = allData.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            const headers = ['Line','IF #','PO #','Customer','Part','Qty','Packaging','Revenue','Due Date','Days Until','Weight (lbs)','Dimensions','Assigned','Pallets'];
            const rows = data.map(r => {
                const line = getVal(r,'LINE');
                const pallets = getPalletDataForOrder(line);
                const totalWeight = pallets.length > 0 ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : '';
                const dimensions = pallets.length > 0 && pallets[0].dimensions ? pallets[0].dimensions : '';
                return [line,getVal(r,'IF_NUM'),getVal(r,'PO_NUM'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),r[COL.REVENUE],r[COL.REQUESTED_DATE],getVal(r,'DAYS_UNTIL'),totalWeight,dimensions,getVal(r,'ASSIGNED'),pallets.length].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
            });
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_staged.csv');
        }

        // ============================================================
        // PALLET LOAD CALCULATOR
        // ============================================================
        const PLC_COLORS = [
            { fill: '#3182ce', label: 'rgba(49,130,206,0.22)' },
            { fill: '#f0883e', label: 'rgba(240,136,62,0.22)' },
            { fill: '#3fb950', label: 'rgba(63,185,80,0.22)' },
            { fill: '#bc8cff', label: 'rgba(188,140,255,0.22)' },
            { fill: '#d29922', label: 'rgba(210,153,34,0.22)' },
            { fill: '#f778ba', label: 'rgba(247,120,186,0.22)' },
            { fill: '#79c0ff', label: 'rgba(121,192,255,0.22)' },
            { fill: '#7ee787', label: 'rgba(126,231,135,0.22)' },
            { fill: '#ff7b72', label: 'rgba(255,123,114,0.22)' },
            { fill: '#a5d6ff', label: 'rgba(165,214,255,0.22)' },
            { fill: '#ffa657', label: 'rgba(255,166,87,0.22)' },
            { fill: '#d2a8ff', label: 'rgba(210,168,255,0.22)' },
        ];
        const PLC_TRAILERS = { 53: { length: 636, width: 98.5 }, 48: { length: 576, width: 98.5 } };
        let plcTrailerLength = 53;
        let plcPalletTypes = [];
        let plcNextId = 1;
        let plcOpenColorPicker = null;
        let plcDragSrcIndex = null;

        const PLC_I18N = {
            en: {
                toggle: 'Pallet Load Calculator', trailerType: 'Trailer Type', vanTrailer: 'Van Trailer', maxPayload: 'Max Payload (lbs)',
                palletTypes: 'Pallet Types', addPalletSize: 'Add Pallet Size', totalPallets: 'Total Pallets', totalWeight: 'Total Weight',
                spaceUsed: 'Space Used', loadStatus: 'Load Status', topDown: 'TOP-DOWN VIEW', widthIn: 'Width â€” W (in)', lengthIn: 'Length â€” L (in)',
                qty: 'Qty', weightEa: 'Weight/ea (lbs)', orientation: 'Orientation', auto: 'Auto', wAcross: 'W across', lAcross: 'L across',
                doubleStack: 'Double Stack', perRow: 'per row', across: 'across', deep: 'deep', gap: 'gap', placed: 'placed',
                bestFit: 'Best fit', pallet: 'Pallet', noFit: 'NO FIT', overweight: 'OVERWEIGHT', over: 'OVER', ok: 'OK',
                door: 'DOOR', front: 'FRONT', of: 'of', dragHint: 'Drag to reorder loading sequence. #1 loads first (near door).',
                loadOrder: 'Load order', nearDoor: 'near door', nearFront: 'near front', palletsNoFit: 'pallets do not fit',
                linkOrders: 'Link Ready to Ship Orders', selectOrders: 'Select orders to add to this pallet type',
                searchOrders: 'Search by IF#, PO#, customer, line...',
                palletNoFit: 'pallet does not fit', floorSpots: 'floor spots', physicalPallets: 'physical pallets',
                note: '<strong>Note:</strong> This shows an estimated arrangement. Actual loading may vary.',
            },
            es: {
                toggle: 'Calculadora de Carga de Tarimas', trailerType: 'Tipo de TrÃ¡iler', vanTrailer: 'TrÃ¡iler Cerrado', maxPayload: 'Carga MÃ¡xima (lbs)',
                palletTypes: 'Tipos de Tarimas', addPalletSize: 'Agregar Tarima', totalPallets: 'Total Tarimas', totalWeight: 'Peso Total',
                spaceUsed: 'Espacio Usado', loadStatus: 'Estado de Carga', topDown: 'VISTA SUPERIOR', widthIn: 'Ancho â€” W (in)', lengthIn: 'Largo â€” L (in)',
                qty: 'Cant', weightEa: 'Peso/c.u. (lbs)', orientation: 'OrientaciÃ³n', auto: 'Auto', wAcross: 'W ancho', lAcross: 'L ancho',
                doubleStack: 'Doble Estiba', perRow: 'por fila', across: 'ancho', deep: 'fondo', gap: 'espacio', placed: 'colocadas',
                bestFit: 'Mejor ajuste', pallet: 'Tarima', noFit: 'NO CABE', overweight: 'SOBREPESO', over: 'EXCESO', ok: 'OK',
                door: 'PUERTA', front: 'FRENTE', of: 'de', dragHint: 'Arrastra para cambiar el orden. #1 se carga primero (junto a puerta).',
                loadOrder: 'Orden de carga', nearDoor: 'junto a puerta', nearFront: 'junto al frente', palletsNoFit: 'tarimas no caben',
                linkOrders: 'Vincular Ã“rdenes Listas para Enviar', selectOrders: 'Selecciona Ã³rdenes para agregar a esta tarima',
                searchOrders: 'Buscar por IF#, PO#, cliente, lÃ­nea...',
                palletNoFit: 'tarima no cabe', floorSpots: 'posiciones en piso', physicalPallets: 'tarimas fÃ­sicas',
                note: '<strong>Nota:</strong> Esto muestra un arreglo estimado. La carga real puede variar.',
            }
        };

        function plcT(key) { const lang = currentLang || 'en'; return (PLC_I18N[lang] && PLC_I18N[lang][key]) || PLC_I18N.en[key] || key; }

        function plcToggle() {
            const container = document.getElementById('plcContainer');
            const btn = document.getElementById('plcToggleBtn');
            const arrow = document.getElementById('plcToggleArrow');
            const isShown = container.classList.toggle('show');
            btn.classList.toggle('active', isShown);
            arrow.textContent = isShown ? 'â–²' : 'â–¼';
            if (isShown && plcPalletTypes.length === 0) {
                plcAddPalletType(48, 40, `${plcT('pallet')} 1`);
            }
            plcUpdateLabels();
        }

        function plcUpdateLabels() {
            const el = (id, text) => { const e = document.getElementById(id); if (e) e.textContent = text; };
            el('plcToggleText', plcT('toggle'));
            el('plcTrailerTitle', plcT('trailerType'));
            el('plcVanLabel1', plcT('vanTrailer'));
            el('plcVanLabel2', plcT('vanTrailer'));
            el('plcMaxPayloadLabel', plcT('maxPayload'));
            el('plcPalletTypesTitle', plcT('palletTypes'));
            el('plcAddBtnText', plcT('addPalletSize'));
            el('plcStatTotalLabel', plcT('totalPallets'));
            el('plcStatWeightLabel', plcT('totalWeight'));
            el('plcStatSpaceLabel', plcT('spaceUsed'));
            el('plcStatStatusLabel', plcT('loadStatus'));
            el('plcViewLabel', plcT('topDown'));
            el('plcDragHint', plcT('dragHint'));
        }

        function plcSelectTrailer(len) {
            plcTrailerLength = len;
            document.querySelectorAll('.plc-trailer-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.plcLen) === len));
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcGetStagedOrders() {
            return allData.filter(r => getStatus(r) === 'staged').map(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
                const avgWeight = pallets.length > 0 ? Math.round(totalWeight / pallets.length) : 0;
                const dims = pallets.length > 0 && pallets[0].dimensions ? pallets[0].dimensions : '';
                const numPkg = parseFloat(getVal(r, 'NUM_PACKAGES')) || 0;
                const palletCount = numPkg > 0 ? Math.ceil(numPkg) : pallets.length;
                let w = 0, l = 0;
                if (dims) {
                    const parts = dims.split(/x/i).map(s => parseFloat(s.trim()));
                    if (parts.length >= 2) { w = parts[0] || 0; l = parts[1] || 0; }
                }
                return {
                    line, ifNum: getVal(r, 'IF_NUM') || '', customer: getVal(r, 'CUSTOMER') || '',
                    poNum: getVal(r, 'PO_NUM') || '',
                    qty: parseNumber(getVal(r, 'QTY')), palletCount, avgWeight, w, l, dims,
                    part: getVal(r, 'PART') || '',
                };
            });
        }

        function plcAddPalletType(defaultW, defaultL, defaultLabel) {
            const id = plcNextId++;
            const ci = plcPalletTypes.length % PLC_COLORS.length;
            plcPalletTypes.push({
                id, width: defaultW || 48, length: defaultL || 40, weight: 0, qty: 0,
                orientation: 'auto', doubleStack: false, color: { ...PLC_COLORS[ci] },
                label: defaultLabel || `${plcT('pallet')} ${plcPalletTypes.length + 1}`,
                linkedOrders: [], linkMode: false,
            });
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcRemovePalletType(id) {
            plcPalletTypes = plcPalletTypes.filter(p => p.id !== id);
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcUpdatePallet(id, field, value) {
            const pt = plcPalletTypes.find(p => p.id === id);
            if (!pt) return;
            if (field === 'orientation' || field === 'label') pt[field] = value;
            else if (field === 'doubleStack' || field === 'linkMode') pt[field] = value;
            else pt[field] = parseFloat(value) || 0;
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcSetColor(id, ci) {
            const pt = plcPalletTypes.find(p => p.id === id);
            if (pt) pt.color = { ...PLC_COLORS[ci] };
            plcOpenColorPicker = null;
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcToggleColorPicker(id, ev) {
            ev.stopPropagation();
            const popup = document.getElementById(`plcColor_${id}`);
            const isOpen = popup && popup.classList.contains('show');
            document.querySelectorAll('.plc-color-popup').forEach(p => p.classList.remove('show'));
            if (!isOpen && popup) { popup.classList.add('show'); plcOpenColorPicker = id; }
            else plcOpenColorPicker = null;
        }

        document.addEventListener('click', e => {
            if (plcOpenColorPicker && !e.target.closest('.plc-color-swatch') && !e.target.closest('.plc-color-popup')) {
                document.querySelectorAll('.plc-color-popup').forEach(p => p.classList.remove('show'));
                plcOpenColorPicker = null;
            }
        });

        function plcToggleOrder(palletId, orderLine) {
            const pt = plcPalletTypes.find(p => p.id === palletId);
            if (!pt) return;
            const staged = plcGetStagedOrders();
            const order = staged.find(o => o.line === orderLine);

            // If deselecting the current order
            if (pt.linkedOrders.includes(orderLine)) {
                pt.linkedOrders = [];
                pt.qty = 0; pt.weight = 0; pt.width = 48; pt.length = 40;
                pt.label = `${plcT('pallet')} ${plcPalletTypes.indexOf(pt) + 1}`;
            }
            // If this pallet already has an order â†’ create a new pallet type for the new order
            else if (pt.linkedOrders.length > 0 && order) {
                const ci = plcPalletTypes.length % PLC_COLORS.length;
                const newId = plcNextId++;
                const newPt = {
                    id: newId, width: order.w || 48, length: order.l || 40,
                    weight: order.avgWeight || 0, qty: order.palletCount || 0,
                    orientation: 'auto', doubleStack: false, color: { ...PLC_COLORS[ci] },
                    label: order.customer ? `${order.customer.substring(0, 20)}` : `${plcT('pallet')} ${plcPalletTypes.length + 1}`,
                    linkedOrders: [orderLine], linkMode: true,
                };
                plcPalletTypes.push(newPt);
            }
            // Selecting an order on an empty pallet
            else if (order) {
                pt.linkedOrders = [orderLine];
                pt.qty = order.palletCount || 0;
                pt.weight = order.avgWeight || 0;
                if (order.w > 0) pt.width = order.w;
                if (order.l > 0) pt.length = order.l;
                pt.label = order.customer ? `${order.customer.substring(0, 20)}` : pt.label;
            }
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcFilterOrders(palletId, query) {
            const list = document.getElementById(`plcOrderList_${palletId}`);
            if (!list) return;
            const q = query.toLowerCase().trim();
            list.querySelectorAll('label').forEach(lbl => {
                const data = lbl.getAttribute('data-search') || '';
                lbl.classList.toggle('plc-order-item-hidden', q !== '' && !data.includes(q));
            });
        }

        function plcMovePallet(id, dir) {
            const idx = plcPalletTypes.findIndex(p => p.id === id);
            if (idx < 0) return;
            const ni = idx + dir;
            if (ni < 0 || ni >= plcPalletTypes.length) return;
            [plcPalletTypes[idx], plcPalletTypes[ni]] = [plcPalletTypes[ni], plcPalletTypes[idx]];
            plcRenderPalletTypes();
            plcRecalculate();
        }

        function plcHandleDragStart(e, idx) { plcDragSrcIndex = idx; e.dataTransfer.effectAllowed = 'move'; setTimeout(() => { const c = document.querySelectorAll('.plc-pallet-type'); if (c[idx]) c[idx].classList.add('dragging'); }, 0); }
        function plcHandleDragOver(e, idx) { e.preventDefault(); document.querySelectorAll('.plc-pallet-type').forEach((c, i) => c.classList.toggle('drag-over', i === idx && i !== plcDragSrcIndex)); }
        function plcHandleDragLeave(e, idx) { const c = document.querySelectorAll('.plc-pallet-type'); if (c[idx]) c[idx].classList.remove('drag-over'); }
        function plcHandleDrop(e, idx) {
            e.preventDefault();
            document.querySelectorAll('.plc-pallet-type').forEach(c => { c.classList.remove('drag-over', 'dragging'); });
            if (plcDragSrcIndex === null || plcDragSrcIndex === idx) return;
            const moved = plcPalletTypes.splice(plcDragSrcIndex, 1)[0];
            plcPalletTypes.splice(idx, 0, moved);
            plcDragSrcIndex = null;
            plcRenderPalletTypes();
            plcRecalculate();
        }
        function plcHandleDragEnd() { plcDragSrcIndex = null; document.querySelectorAll('.plc-pallet-type').forEach(c => { c.classList.remove('dragging', 'drag-over'); }); }

        function plcGetPlacedDims(pt) {
            const tW = PLC_TRAILERS[plcTrailerLength].width;
            if (pt.orientation === 'widthwise') return { across: pt.width, along: pt.length };
            if (pt.orientation === 'lengthwise') return { across: pt.length, along: pt.width };
            const fitW = Math.floor(tW / pt.width), fitL = Math.floor(tW / pt.length);
            if (fitL > fitW) return { across: pt.length, along: pt.width };
            if (fitW > fitL) return { across: pt.width, along: pt.length };
            return { across: Math.max(pt.width, pt.length), along: Math.min(pt.width, pt.length) };
        }

        function plcRenderPalletTypes() {
            const container = document.getElementById('plcPalletTypesContainer');
            if (!container) return;
            container.innerHTML = '';
            const tW = PLC_TRAILERS[plcTrailerLength].width;
            const total = plcPalletTypes.length;
            const staged = plcGetStagedOrders();

            plcPalletTypes.forEach((pt, index) => {
                const fitW = Math.floor(tW / pt.width), fitL = Math.floor(tW / pt.length);
                const wasteW = (tW - fitW * pt.width).toFixed(1), wasteL = (tW - fitL * pt.length).toFixed(1);
                let autoFit, autoAcross, autoAlong;
                if (fitL > fitW) { autoAcross = pt.length; autoAlong = pt.width; autoFit = fitL; }
                else if (fitW > fitL) { autoAcross = pt.width; autoAlong = pt.length; autoFit = fitW; }
                else { autoAcross = Math.max(pt.width, pt.length); autoAlong = Math.min(pt.width, pt.length); autoFit = fitW; }

                let colorOpts = '';
                PLC_COLORS.forEach((c, ci) => {
                    colorOpts += `<div class="plc-color-opt ${c.fill === pt.color.fill ? 'selected' : ''}" style="background:${c.fill}" onclick="plcSetColor(${pt.id}, ${ci})"></div>`;
                });

                const orderLabel = index === 0 ? `#${index + 1} â€” ${plcT('nearDoor')}` : index === total - 1 ? `#${index + 1} â€” ${plcT('nearFront')}` : `#${index + 1}`;

                // Build order selector
                let orderSelectorHtml = '';
                if (pt.linkMode) {
                    orderSelectorHtml = `<div class="plc-order-selector">
                        <div class="header"><strong style="font-size:12px;color:var(--accent);">${plcT('selectOrders')}</strong></div>
                        <input type="text" class="plc-order-search" placeholder="ðŸ” ${plcT('searchOrders')}" oninput="plcFilterOrders(${pt.id}, this.value)">
                        <div class="plc-order-checkbox-list" id="plcOrderList_${pt.id}">`;
                    // Find orders already linked by OTHER pallet types
                    const takenByOther = new Map();
                    plcPalletTypes.forEach((other, oi) => {
                        if (other.id !== pt.id) other.linkedOrders.forEach(ln => takenByOther.set(ln, oi + 1));
                    });
                    staged.forEach(o => {
                        const isSelected = pt.linkedOrders.includes(o.line);
                        const takenBy = takenByOther.get(o.line);
                        const disabled = takenBy !== undefined && !isSelected;
                        const searchData = `${o.line} ${o.ifNum} ${o.poNum} ${o.customer} ${o.part}`.toLowerCase();
                        const disabledStyle = disabled ? 'opacity:0.4;pointer-events:none;' : '';
                        const takenLabel = disabled ? ` <span style="font-size:10px;color:var(--accent);">(Pallet #${takenBy})</span>` : '';
                        orderSelectorHtml += `<label data-search="${searchData}" style="${disabledStyle}cursor:pointer;"><input type="checkbox" ${isSelected ? 'checked' : ''} onclick="plcToggleOrder(${pt.id}, '${o.line}')" ${disabled ? 'disabled' : ''} style="accent-color:var(--accent);"> <span style="min-width:45px;display:inline-block;color:var(--text-secondary);font-size:11px;">#${o.line}</span> <strong>${o.ifNum || '-'}</strong> <span style="color:var(--text-secondary);font-size:11px;">${o.poNum ? 'PO:' + o.poNum : ''}</span> â€” ${o.customer} Â· ${o.palletCount} pallets Â· ${o.dims || 'no dims'} Â· ${o.avgWeight} lbs/ea${takenLabel}</label>`;
                    });
                    orderSelectorHtml += `</div></div>`;
                }

                const el = document.createElement('div');
                el.className = 'plc-pallet-type';
                el.draggable = true;
                el.ondragstart = e => plcHandleDragStart(e, index);
                el.ondragover = e => plcHandleDragOver(e, index);
                el.ondragleave = e => plcHandleDragLeave(e, index);
                el.ondrop = e => plcHandleDrop(e, index);
                el.ondragend = plcHandleDragEnd;
                el.innerHTML = `
                    <div class="plc-ptype-header">
                        <div class="plc-ptype-header-left">
                            <div class="plc-drag-handle" title="Drag to reorder"><div class="plc-drag-dots"><span></span><span></span></div><div class="plc-drag-dots"><span></span><span></span></div><div class="plc-drag-dots"><span></span><span></span></div></div>
                            <div class="plc-order-badge">${index + 1}</div>
                            <div style="position:relative;">
                                <div class="plc-color-swatch" style="background:${pt.color.fill}" onclick="plcToggleColorPicker(${pt.id}, event)"></div>
                                <div class="plc-color-popup" id="plcColor_${pt.id}"><div class="plc-color-grid">${colorOpts}</div></div>
                            </div>
                            <input class="plc-name-input" type="text" value="${pt.label}" onchange="plcUpdatePallet(${pt.id}, 'label', this.value)" onclick="this.select()">
                        </div>
                        <div style="display:flex;align-items:center;gap:2px;">
                            <button class="plc-remove-btn" style="font-size:14px;padding:4px 6px;${index === 0 ? 'opacity:0.3;pointer-events:none;' : ''}" onclick="plcMovePallet(${pt.id}, -1)" title="â–²">â–²</button>
                            <button class="plc-remove-btn" style="font-size:14px;padding:4px 6px;${index === total - 1 ? 'opacity:0.3;pointer-events:none;' : ''}" onclick="plcMovePallet(${pt.id}, 1)" title="â–¼">â–¼</button>
                            ${total > 1 ? `<button class="plc-remove-btn" onclick="plcRemovePalletType(${pt.id})" title="Remove">&times;</button>` : ''}
                        </div>
                    </div>
                    <div style="font-size:10px;color:var(--text-secondary);margin-bottom:8px;margin-left:52px;">
                        ${plcT('loadOrder')}: <span style="color:var(--accent);font-weight:600;">${orderLabel}</span>
                    </div>
                    <div class="plc-link-toggle">
                        <label class="plc-stack-toggle"><input type="checkbox" ${pt.linkMode ? 'checked' : ''} onchange="plcUpdatePallet(${pt.id}, 'linkMode', this.checked)"><span class="plc-stack-slider"></span></label>
                        <span style="font-size:12px;color:var(--text-secondary);">ðŸ“‹ ${plcT('linkOrders')}</span>
                    </div>
                    ${orderSelectorHtml}
                    <div class="plc-fields-grid" style="margin-top:8px;">
                        <div class="plc-field"><label>${plcT('widthIn')}</label><input type="number" value="${pt.width}" min="1" onchange="plcUpdatePallet(${pt.id}, 'width', this.value)" ${pt.linkMode && pt.linkedOrders.length > 0 ? 'style="opacity:0.6"' : ''}></div>
                        <div class="plc-field"><label>${plcT('lengthIn')}</label><input type="number" value="${pt.length}" min="1" onchange="plcUpdatePallet(${pt.id}, 'length', this.value)" ${pt.linkMode && pt.linkedOrders.length > 0 ? 'style="opacity:0.6"' : ''}></div>
                    </div>
                    <div class="plc-fields-grid">
                        <div class="plc-field"><label>${plcT('qty')}</label><input type="number" value="${pt.qty}" min="0" max="200" onchange="plcUpdatePallet(${pt.id}, 'qty', this.value)" ${pt.linkMode && pt.linkedOrders.length > 0 ? 'style="opacity:0.6"' : ''}></div>
                        <div class="plc-field"><label>${plcT('weightEa')}</label><input type="number" value="${pt.weight}" min="0" onchange="plcUpdatePallet(${pt.id}, 'weight', this.value)" ${pt.linkMode && pt.linkedOrders.length > 0 ? 'style="opacity:0.6"' : ''}></div>
                    </div>
                    <div class="plc-stack-row">
                        <label class="plc-stack-toggle"><input type="checkbox" ${pt.doubleStack ? 'checked' : ''} onchange="plcUpdatePallet(${pt.id}, 'doubleStack', this.checked)"><span class="plc-stack-slider"></span></label>
                        <span style="font-size:12px;color:var(--text-secondary);">ðŸ“¦ðŸ“¦ ${plcT('doubleStack')} ${pt.doubleStack ? '<span style="font-size:10px;background:rgba(49,130,206,0.15);color:var(--accent);padding:2px 6px;border-radius:4px;font-weight:700;">Ã—2</span>' : ''}</span>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="plc-field"><label>${plcT('orientation')}</label>
                            <div class="plc-orient-toggle">
                                <button class="plc-orient-btn ${pt.orientation === 'auto' ? 'active' : ''}" onclick="plcUpdatePallet(${pt.id}, 'orientation', 'auto')">âš¡ ${plcT('auto')}</button>
                                <button class="plc-orient-btn ${pt.orientation === 'widthwise' ? 'active' : ''}" onclick="plcUpdatePallet(${pt.id}, 'orientation', 'widthwise')">${plcT('wAcross')}</button>
                                <button class="plc-orient-btn ${pt.orientation === 'lengthwise' ? 'active' : ''}" onclick="plcUpdatePallet(${pt.id}, 'orientation', 'lengthwise')">${plcT('lAcross')}</button>
                            </div>
                            <div class="plc-orient-info">
                                ${pt.orientation === 'auto' ? `${plcT('bestFit')}: <strong style="color:#3fb950;">${autoFit} ${plcT('perRow')}</strong> â€” ${autoAcross}" ${plcT('across')}, ${autoAlong}" ${plcT('deep')}`
                                : pt.orientation === 'widthwise' ? `<strong style="color:#3fb950;">${fitW} ${plcT('perRow')}</strong> â€” W:${pt.width}" ${plcT('across')}, L:${pt.length}" ${plcT('deep')} â€” ${wasteW}" ${plcT('gap')}`
                                : `<strong style="color:#3fb950;">${fitL} ${plcT('perRow')}</strong> â€” L:${pt.length}" ${plcT('across')}, W:${pt.width}" ${plcT('deep')} â€” ${wasteL}" ${plcT('gap')}`}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function plcPackPallets() {
            const trailer = PLC_TRAILERS[plcTrailerLength];
            const tW = trailer.width, tL = trailer.length;
            let all = [];
            plcPalletTypes.forEach((pt, typeOrder) => {
                const dims = plcGetPlacedDims(pt);
                const spots = pt.doubleStack ? Math.ceil(pt.qty / 2) : pt.qty;
                for (let i = 0; i < spots; i++) {
                    all.push({ across: dims.across, along: dims.along, origW: pt.width, origL: pt.length,
                        acrossIsWidth: dims.across === pt.width, color: pt.color, typeId: pt.id, label: pt.label,
                        isDoubleStack: pt.doubleStack, typeOrder });
                }
            });
            all.sort((a, b) => a.typeOrder - b.typeOrder || b.along - a.along || b.across - a.across);
            let placed = [], cursorY = 0;
            while (all.length > 0 && cursorY < tL) {
                let rowH = 0, cursorX = 0, toRem = [];
                for (let i = 0; i < all.length; i++) {
                    const p = all[i];
                    if (cursorX + p.across <= tW + 0.5 && cursorY + p.along <= tL + 0.5) {
                        placed.push({ x: cursorX, y: cursorY, ...p });
                        cursorX += p.across;
                        rowH = Math.max(rowH, p.along);
                        toRem.push(i);
                    }
                }
                toRem.reverse().forEach(i => all.splice(i, 1));
                if (rowH === 0) break;
                cursorY += rowH;
            }
            return { placed, overflow: all.length };
        }

        function plcRecalculate() {
            const trailer = PLC_TRAILERS[plcTrailerLength];
            const maxWeight = parseFloat(document.getElementById('plcMaxWeight').value) || 45000;
            document.getElementById('plcTrailerDimLabel').textContent = `${trailer.length}" x ${trailer.width}"`;
            let totalQty = 0, totalWt = 0, totalSpots = 0;
            plcPalletTypes.forEach(pt => { totalQty += pt.qty; totalWt += pt.qty * pt.weight; totalSpots += pt.doubleStack ? Math.ceil(pt.qty / 2) : pt.qty; });
            const { placed, overflow } = plcPackPallets();
            const area = trailer.length * trailer.width;
            let used = 0; placed.forEach(p => used += p.across * p.along);
            const spacePct = area > 0 ? Math.min(100, Math.round((used / area) * 100)) : 0;

            const palletsEl = document.getElementById('plcTotalPallets');
            if (totalSpots !== totalQty && totalQty > 0) palletsEl.innerHTML = `${totalQty} <span style="font-size:12px;color:var(--text-secondary);">(${totalSpots} ${plcT('floorSpots')})</span>`;
            else palletsEl.textContent = totalQty;

            document.getElementById('plcTotalWeight').textContent = totalWt.toLocaleString();
            document.getElementById('plcWeightSub').textContent = `${plcT('of')} ${maxWeight.toLocaleString()} lbs`;
            document.getElementById('plcSpaceUsed').textContent = spacePct + '%';

            const isOver = totalWt > maxWeight, noFit = overflow > 0;
            const statusCard = document.getElementById('plcStatStatus');
            const weightCard = document.getElementById('plcStatWeight');
            const statusEl = document.getElementById('plcLoadStatus');
            statusCard.className = 'plc-stat'; weightCard.className = 'plc-stat';
            if (totalQty === 0) { statusEl.textContent = '---'; statusEl.style.color = 'var(--text-secondary)'; }
            else if (isOver && noFit) { statusEl.textContent = plcT('over'); statusEl.style.color = '#f85149'; statusCard.classList.add('overweight'); weightCard.classList.add('overweight'); }
            else if (isOver) { statusEl.textContent = plcT('overweight'); statusEl.style.color = '#f85149'; statusCard.classList.add('overweight'); weightCard.classList.add('overweight'); }
            else if (noFit) { statusEl.textContent = plcT('noFit'); statusEl.style.color = '#f85149'; statusCard.classList.add('overweight'); }
            else { statusEl.textContent = plcT('ok'); statusEl.style.color = '#3fb950'; statusCard.classList.add('ok'); }

            const wPct = maxWeight > 0 ? Math.min(100, (totalWt / maxWeight) * 100) : 0;
            const wb = document.getElementById('plcWeightFill');
            wb.style.width = wPct + '%';
            wb.style.background = wPct > 100 ? '#f85149' : wPct > 85 ? '#d29922' : '#3fb950';

            plcDrawTrailer(placed, overflow);
        }

        function plcSvgDimArrow(x1, y1, x2, y2, color, labelText, fontSize) {
            let svg = '';
            const dx = x2 - x1, dy = y2 - y1, len = Math.sqrt(dx * dx + dy * dy);
            if (len < 4) return '';
            const ux = dx / len, uy = dy / len, px = -uy, py = ux;
            const hl = Math.min(4, len * 0.15), hw = hl * 0.5;
            svg += `<line x1="${x1 + px * 3}" y1="${y1 + py * 3}" x2="${x1 - px * 3}" y2="${y1 - py * 3}" stroke="${color}" stroke-width="0.8" opacity="0.9"/>`;
            svg += `<line x1="${x2 + px * 3}" y1="${y2 + py * 3}" x2="${x2 - px * 3}" y2="${y2 - py * 3}" stroke="${color}" stroke-width="0.8" opacity="0.9"/>`;
            svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="0.8" opacity="0.8"/>`;
            svg += `<polygon points="${x1},${y1} ${x1 + ux * hl + px * hw},${y1 + uy * hl + py * hw} ${x1 + ux * hl - px * hw},${y1 + uy * hl - py * hw}" fill="${color}" opacity="0.9"/>`;
            svg += `<polygon points="${x2},${y2} ${x2 - ux * hl + px * hw},${y2 - uy * hl + py * hw} ${x2 - ux * hl - px * hw},${y2 - uy * hl - py * hw}" fill="${color}" opacity="0.9"/>`;
            const mx = (x1 + x2) / 2, my = (y1 + y2) / 2, fs = fontSize || 7;
            const textW = labelText.length * fs * 0.55, textH = fs + 2;
            if (Math.abs(dy) < Math.abs(dx)) {
                svg += `<rect x="${mx - textW / 2 - 2}" y="${my - textH}" width="${textW + 4}" height="${textH + 2}" fill="var(--bg-card, #1a1e23)" rx="2" opacity="0.85"/>`;
                svg += `<text x="${mx}" y="${my - 2}" fill="${color}" font-size="${fs}" font-family="monospace" text-anchor="middle" font-weight="700">${labelText}</text>`;
            } else {
                svg += `<rect x="${mx - textW - 4}" y="${my - textH / 2}" width="${textW + 4}" height="${textH + 2}" fill="var(--bg-card, #1a1e23)" rx="2" opacity="0.85"/>`;
                svg += `<text x="${mx - 3}" y="${my + fs / 2 - 1}" fill="${color}" font-size="${fs}" font-family="monospace" text-anchor="end" font-weight="700">${labelText}</text>`;
            }
            return svg;
        }

        function plcDrawTrailer(placed, overflow) {
            const trailer = PLC_TRAILERS[plcTrailerLength];
            const tW = trailer.width, tL = trailer.length;
            const maxW = 720, scale = Math.min(maxW / tL, 5);
            const mT = 35, mL = 40, mR = 55, mB = 45;
            const svgW = tL * scale + mL + mR, svgH = tW * scale + mT + mB;
            const oX = mL, oY = mT;
            let svg = `<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
            svg += `<rect x="${oX}" y="${oY}" width="${tL * scale}" height="${tW * scale}" fill="var(--bg-dark, #161b22)" stroke="var(--border, #2d333b)" stroke-width="2" rx="3"/>`;
            for (let g = 48; g < tL; g += 48) svg += `<line x1="${oX + g * scale}" y1="${oY}" x2="${oX + g * scale}" y2="${oY + tW * scale}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="3,3"/>`;
            svg += `<rect x="${oX - 6}" y="${oY + tW * scale * 0.15}" width="6" height="${tW * scale * 0.7}" fill="var(--accent)" rx="2" opacity="0.6"/>`;
            svg += `<text x="${oX - 3}" y="${oY - 10}" fill="var(--text-secondary)" font-size="9" font-family="monospace" text-anchor="middle">${plcT('door')}</text>`;
            svg += `<text x="${oX + tL * scale}" y="${oY - 10}" fill="var(--text-secondary)" font-size="9" font-family="monospace" text-anchor="middle">${plcT('front')}</text>`;
            svg += plcSvgDimArrow(oX, oY + tW * scale + 16, oX + tL * scale, oY + tW * scale + 16, '#8b949e', `${tL}" (${plcTrailerLength}')`, 9);
            svg += plcSvgDimArrow(oX + tL * scale + 16, oY, oX + tL * scale + 16, oY + tW * scale, '#8b949e', `${tW}"`, 9);
            const dimDrawn = {};
            placed.forEach(p => {
                const px = oX + p.y * scale, py = oY + p.x * scale;
                const pw = p.along * scale, ph = p.across * scale;
                svg += `<rect x="${px + 1}" y="${py + 1}" width="${pw - 2}" height="${ph - 2}" fill="${p.color.label}" stroke="${p.color.fill}" stroke-width="1.5" rx="2"/>`;
                if (p.isDoubleStack) {
                    svg += `<rect x="${px + 3}" y="${py + 3}" width="${pw - 6}" height="${ph - 6}" fill="none" stroke="${p.color.fill}" stroke-width="0.8" stroke-dasharray="2,2" rx="2" opacity="0.5"/>`;
                    svg += `<rect x="${px + pw - 16}" y="${py + 2}" width="14" height="10" fill="${p.color.fill}" rx="2" opacity="0.8"/>`;
                    svg += `<text x="${px + pw - 9}" y="${py + 10}" fill="#0f1215" font-size="7" font-family="monospace" text-anchor="middle" font-weight="700">x2</text>`;
                }
                if (!dimDrawn[p.typeId] && pw > 35 && ph > 25) {
                    dimDrawn[p.typeId] = true;
                    const acL = p.acrossIsWidth ? `W:${p.origW}"` : `L:${p.origL}"`;
                    const alL = p.acrossIsWidth ? `L:${p.origL}"` : `W:${p.origW}"`;
                    svg += plcSvgDimArrow(px + pw * 0.25, py + 5, px + pw * 0.25, py + ph - 5, p.color.fill, acL, Math.min(7, ph / 3.5));
                    svg += plcSvgDimArrow(px + 5, py + ph * 0.35, px + pw - 5, py + ph * 0.35, p.color.fill, alL, Math.min(7, pw / 5));
                } else if (pw > 18 && ph > 12) {
                    svg += `<text x="${px + pw / 2}" y="${py + ph / 2 + 3}" fill="${p.color.fill}" font-size="${Math.min(7, Math.min(pw, ph) / 4)}" font-family="monospace" text-anchor="middle" opacity="0.65">${p.across}x${p.along}</text>`;
                }
            });
            svg += `</svg>`;
            document.getElementById('plcTrailerSvg').innerHTML = svg;

            const legendEl = document.getElementById('plcLegend');
            legendEl.innerHTML = '';
            plcPalletTypes.forEach((pt, idx) => {
                if (pt.qty > 0) {
                    const pc = placed.filter(p => p.typeId === pt.id).length;
                    const stackNote = pt.doubleStack ? ` (Ã—2 ${plcT('doubleStack')})` : '';
                    legendEl.innerHTML += `<span><span class="plc-legend-swatch" style="background:${pt.color.fill}"></span>#${idx + 1} ${pt.label} (${pt.width}"Ã—${pt.length}") â€” ${pt.qty} ${plcT('physicalPallets')}, ${pc} ${plcT('placed')}${stackNote}</span>`;
                }
            });
            if (overflow > 0) legendEl.innerHTML += `<span style="color:#f85149;">âš  ${overflow} ${overflow > 1 ? plcT('palletsNoFit') : plcT('palletNoFit')}</span>`;
        }

        // Update PLC labels when language changes
        const _origSetLangForPlc = typeof window.setLanguage === 'function' ? window.setLanguage : null;
        // Hook into the existing language toggle to update PLC labels
        function plcOnLanguageChange() {
            if (document.getElementById('plcContainer') && document.getElementById('plcContainer').classList.contains('show')) {
                plcUpdateLabels();
                plcRenderPalletTypes();
                plcRecalculate();
            }
        }

        // ============================================================
        // ORDERS SHIPPED PAGE (History with date filter)
        // ============================================================
        function toggleOrdersShippedCategory(cat) {
            ordersShippedFilters.categories[cat] = !ordersShippedFilters.categories[cat];
            if (!ordersShippedFilters.categories.rolltech && !ordersShippedFilters.categories.molding && !ordersShippedFilters.categories.snappad) { ordersShippedFilters.categories[cat] = true; return; }
            document.getElementById('ordersShippedBtnRollTech').classList.toggle('active', ordersShippedFilters.categories.rolltech);
            document.getElementById('ordersShippedBtnMolding').classList.toggle('active', ordersShippedFilters.categories.molding);
            document.getElementById('ordersShippedBtnSnapPad').classList.toggle('active', ordersShippedFilters.categories.snappad);
            updateOrdersShippedPage();
        }
        
        function applyShippedDateFilter() {
            const fromInput = document.getElementById('ordersShippedFromDate').value;
            const toInput = document.getElementById('ordersShippedToDate').value;
            ordersShippedFilters.fromDate = fromInput ? new Date(fromInput) : null;
            ordersShippedFilters.toDate = toInput ? new Date(toInput) : null;
            updateOrdersShippedPage();
        }
        
        function resetShippedDateFilter() {
            document.getElementById('ordersShippedFromDate').value = '';
            document.getElementById('ordersShippedToDate').value = '';
            ordersShippedFilters.fromDate = null;
            ordersShippedFilters.toDate = null;
            updateOrdersShippedPage();
        }
        
        async function updateOrdersShippedPage() {
            // Load shipping records data for shipping photos (async)
            if (!shippingRecordsLoaded) {
                await loadShippingRecordsData();
            }
            
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersShippedFilters.categories[cat] || status !== 'shipped') return false;
                
                if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                    const dateStr = r[COL.SHIPPED_DATE];
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (ordersShippedFilters.fromDate && rowDate < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && rowDate > ordersShippedFilters.toDate) return false;
                }
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100).toFixed(1) : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersShippedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersShippedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersShippedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersShippedPL').textContent = formatCurrency(totalPL);
            document.getElementById('ordersShippedPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('ordersShippedMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('ordersShippedCustomers').textContent = formatNumber(customers);
            
            renderOrdersShippedTableHeader();
            renderOrdersShippedTable(data);
        }
        
        function renderOrdersShippedTableHeader() {
            initTableFilters('ordersShipped');
            initHiddenColumns('ordersShipped');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'shippedDate', label: t('col.shippedDate') },
                { key: 'daysLate', label: t('col.daysLate') },
                { key: 'customer', label: t('col.customer') }, { key: 'part', label: t('col.part') },
                { key: 'qty', label: t('col.qty') }
            ];
            // Only add revenue and P/L columns if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
                headers.push({ key: 'pl', label: t('col.pl') });
            }
            document.getElementById('ordersShippedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersShipped', h.key)) return '';
                return createFilterHeader('ordersShipped', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersShippedTable(data) {
            renderOrdersShippedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const pl = getPLValue(r);
                if (!passesColumnFilter('ordersShipped', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'shippedDate', r[COL.SHIPPED_DATE] || '-')) return false;
                // Days Late filter
                const _shipD = parseDate(r[COL.SHIPPED_DATE]), _reqD = parseDate(r[COL.REQUESTED_DATE]);
                const _daysLate = (_shipD && _reqD) ? Math.round((_shipD - _reqD) / 86400000) : null;
                const _daysLateStr = _daysLate !== null ? (_daysLate > 0 ? '+' + _daysLate : String(_daysLate)) : '-';
                if (!passesColumnFilter('ordersShipped', 'daysLate', _daysLateStr)) return false;
                if (!passesColumnFilter('ordersShipped', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (salesUnlocked) {
                    if (!passesColumnFilter('ordersShipped', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                    if (!passesColumnFilter('ordersShipped', 'pl', formatCurrency(pl))) return false;
                }
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'daysLate': {
                        const shipA = parseDate(a[COL.SHIPPED_DATE]), reqA = parseDate(a[COL.REQUESTED_DATE]);
                        const shipB = parseDate(b[COL.SHIPPED_DATE]), reqB = parseDate(b[COL.REQUESTED_DATE]);
                        va = (shipA && reqA) ? (shipA - reqA) : 0;
                        vb = (shipB && reqB) ? (shipB - reqB) : 0;
                        break;
                    }
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersShippedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersShippedTableBody');
            tbody.innerHTML = sorted.map(r => {
                const pl = getPLValue(r);
                const line = getVal(r, 'LINE');
                // Add click handler for shipped orders photo drilldown
                const clickHandler = `onclick="showPalletPictures('${line}', this)" style="cursor:pointer;"`;
                
                let cells = '';
                if (!isColumnHidden('ordersShipped', 'line')) cells += `<td><strong>${line || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'shippedDate')) cells += `<td>${r[COL.SHIPPED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'daysLate')) {
                    const shipD = parseDate(r[COL.SHIPPED_DATE]), reqD = parseDate(r[COL.REQUESTED_DATE]);
                    const late = (shipD && reqD) ? Math.round((shipD - reqD) / 86400000) : null;
                    const lateStr = late !== null ? (late > 0 ? '+' + late : String(late)) : '-';
                    const lateClass = late === null ? '' : (late > 0 ? 'negative' : 'positive');
                    cells += `<td class="${lateClass}">${lateStr}</td>`;
                }
                if (!isColumnHidden('ordersShipped', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'pl')) cells += `<td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>`;
                
                return `<tr class="clickable-row" ${clickHandler}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersShipped');
            updateShowHiddenButton('ordersShipped');
        }
        
        function sortOrdersShippedTable(field) {
            if (ordersShippedSort.field === field) ordersShippedSort.asc = !ordersShippedSort.asc;
            else { ordersShippedSort.field = field; ordersShippedSort.asc = true; }
            updateOrdersShippedPage();
        }
        
        function filterOrdersShippedTable() { updateOrdersShippedPage(); }
        
        function exportOrdersShippedToCSV() {
            // 1. Get base filtered data (category + shipped status)
            let data = allData.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            
            // 2. Apply date range filter
            if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                data = data.filter(r => {
                    const d = parseDate(r[COL.SHIPPED_DATE]);
                    if (!d) return false;
                    if (ordersShippedFilters.fromDate && d < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && d > ordersShippedFilters.toDate) return false;
                    return true;
                });
            }
            
            // 3. Apply column filters (same as renderOrdersShippedTable)
            data = data.filter(r => {
                if (!passesColumnFilter('ordersShipped', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'shippedDate', r[COL.SHIPPED_DATE] || '-')) return false;
                const _shipD = parseDate(r[COL.SHIPPED_DATE]), _reqD = parseDate(r[COL.REQUESTED_DATE]);
                const _daysLate = (_shipD && _reqD) ? Math.round((_shipD - _reqD) / 86400000) : null;
                const _daysLateStr = _daysLate !== null ? (_daysLate > 0 ? '+' + _daysLate : String(_daysLate)) : '-';
                if (!passesColumnFilter('ordersShipped', 'daysLate', _daysLateStr)) return false;
                if (!passesColumnFilter('ordersShipped', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (salesUnlocked) {
                    if (!passesColumnFilter('ordersShipped', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                    if (!passesColumnFilter('ordersShipped', 'pl', formatCurrency(getPLValue(r)))) return false;
                }
                return true;
            });
            
            // 4. Apply sort (same as renderOrdersShippedTable)
            data.sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'daysLate': {
                        const shipA = parseDate(a[COL.SHIPPED_DATE]), reqA = parseDate(a[COL.REQUESTED_DATE]);
                        const shipB = parseDate(b[COL.SHIPPED_DATE]), reqB = parseDate(b[COL.REQUESTED_DATE]);
                        va = (shipA && reqA) ? (shipA - reqA) : 0;
                        vb = (shipB && reqB) ? (shipB - reqB) : 0;
                        break;
                    }
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            // 5. Apply search
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                data = data.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            // 6. Define columns with getValue functions (skip hidden)
            const allCols = [
                { key: 'line', header: 'Line', getValue: r => getVal(r, 'LINE') },
                { key: 'ifNum', header: 'IF #', getValue: r => getVal(r, 'IF_NUM') },
                { key: 'poNum', header: 'PO #', getValue: r => getVal(r, 'PO_NUM') },
                { key: 'shippedDate', header: 'Shipped Date', getValue: r => r[COL.SHIPPED_DATE] },
                { key: 'daysLate', header: 'Days Late', getValue: r => {
                    const shipD = parseDate(r[COL.SHIPPED_DATE]), reqD = parseDate(r[COL.REQUESTED_DATE]);
                    return (shipD && reqD) ? Math.round((shipD - reqD) / 86400000) : '';
                }},
                { key: 'customer', header: 'Customer', getValue: r => getVal(r, 'CUSTOMER') },
                { key: 'part', header: 'Part #', getValue: r => getVal(r, 'PART') },
                { key: 'qty', header: 'Qty', getValue: r => getVal(r, 'QTY') }
            ];
            if (salesUnlocked) {
                allCols.push({ key: 'revenue', header: 'Revenue', getValue: r => r[COL.REVENUE] });
                allCols.push({ key: 'pl', header: 'P/L', getValue: r => getPLValue(r) });
            }
            
            // 7. Filter to visible columns only
            const visibleCols = allCols.filter(c => !isColumnHidden('ordersShipped', c.key));
            
            // 8. Build CSV
            const headers = visibleCols.map(c => c.header);
            const rows = data.map(r => visibleCols.map(c => {
                const v = c.getValue(r);
                return '"' + ((v === null || v === undefined ? '' : v).toString().replace(/"/g, '""')) + '"';
            }).join(','));
            
            downloadCSV([headers.join(','), ...rows].join('\n'), 'orders_shipped.csv');
        }

        // ============================================================
        // UTILITY FUNCTION
        // ============================================================
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ============================================================
        // EXPORT DROPDOWN + EXCEL EXPORT ENGINE
        // ============================================================
        function toggleExportDropdown(btn) {
            const dd = btn.closest('.export-dropdown');
            const wasOpen = dd.classList.contains('open');
            closeExportDropdowns();
            if (!wasOpen) dd.classList.add('open');
        }
        function closeExportDropdowns() {
            document.querySelectorAll('.export-dropdown.open').forEach(d => d.classList.remove('open'));
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.export-dropdown')) closeExportDropdowns();
        });

        // Column type detection for generic Excel formatting
        const EXCEL_COL_TYPE_MAP = {
            // Currency columns
            unitPrice: 'currency', variableCost: 'currency', totalCost: 'currency', salesTarget: 'currency',
            profitPerPart: 'currency', pl: 'currency', revenue: 'currency', shippingCost: 'currency',
            totalRevenue: 'currency', totalPL: 'currency', price: 'currency', cost: 'currency',
            // Percentage columns
            contribution: 'percent', margin: 'percent',
            // Date columns
            dateOfRequest: 'date', requestedDate: 'date', shippedDate: 'date', timestamp: 'date', date: 'date',
            // Integer columns
            qty: 'integer', orders: 'integer', quantity: 'integer', orderQty: 'integer', count: 'integer'
        };

        function detectColType(key, headerText) {
            if (EXCEL_COL_TYPE_MAP[key]) return EXCEL_COL_TYPE_MAP[key];
            const h = (headerText || '').toLowerCase();
            if (h.includes('price') || h.includes('cost') || h.includes('revenue') || h.includes('p/l') || h.includes('profit') || h.includes('sales target')) return 'currency';
            if (h.includes('margin') || h.includes('contribution') || h.includes('%')) return 'percent';
            if (h.includes('date') || h.includes('fecha')) return 'date';
            if (h.includes('qty') || h.includes('quantity') || h.includes('orders') || h.includes('cant')) return 'integer';
            return 'text';
        }

        // Generic Excel export â€” smart formatting, no fancy design
        async function genericExcelExport(headers, rows, colKeys, filename, colTypes) {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('Data');

            // Header row
            const headerRow = ws.addRow(headers);
            headerRow.height = 28;
            headerRow.eachCell((cell, colNum) => {
                cell.font = { name: 'Aptos', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F3864' } };
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.border = {
                    bottom: { style: 'medium', color: { argb: 'FF0D1B3E' } },
                    left: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                    right: { style: 'thin', color: { argb: 'FFD6DCE4' } }
                };
            });

            // Data rows
            rows.forEach((row, ri) => {
                const dataRow = ws.addRow(row.map((val, ci) => {
                    const t = colTypes[ci];
                    if (t === 'currency' || t === 'integer') { const n = parseFloat(String(val).replace(/[$,%]/g, '')); return isNaN(n) ? val : n; }
                    if (t === 'percent') { const n = parseFloat(String(val).replace('%', '')); return isNaN(n) ? val : n / 100; }
                    return val;
                }));
                dataRow.height = 22;
                const bgColor = ri % 2 === 0 ? 'FFF2F6FC' : 'FFFFFFFF';
                dataRow.eachCell((cell, colNum) => {
                    const t = colTypes[colNum - 1];
                    cell.font = { name: 'Aptos', size: 10, color: { argb: 'FF2D2D2D' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        bottom: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        left: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        right: { style: 'thin', color: { argb: 'FFD6DCE4' } }
                    };
                    if (t === 'currency') { cell.numFmt = '$#,##0.00'; cell.alignment = { horizontal: 'right', vertical: 'middle' }; }
                    else if (t === 'percent') { cell.numFmt = '0.0%'; cell.alignment = { horizontal: 'center', vertical: 'middle' }; }
                    else if (t === 'integer') { cell.numFmt = '#,##0'; cell.alignment = { horizontal: 'center', vertical: 'middle' }; }
                    else if (t === 'date') { cell.alignment = { horizontal: 'center', vertical: 'middle' }; }
                    else { cell.alignment = { horizontal: 'left', vertical: 'middle' }; }

                    // P/L color coding for currency cols that are profit-related
                    if ((t === 'currency') && ['pl','profitPerPart','totalPL'].includes(colKeys[colNum-1])) {
                        const v = typeof cell.value === 'number' ? cell.value : 0;
                        if (v > 0) cell.font = { ...cell.font, color: { argb: 'FF1A7A2E' }, bold: true };
                        else if (v < 0) cell.font = { ...cell.font, color: { argb: 'FFCC0000' }, bold: true };
                    }
                    if (t === 'percent' && ['contribution','margin'].includes(colKeys[colNum-1])) {
                        const v = typeof cell.value === 'number' ? cell.value : 0;
                        if (v > 0) cell.font = { ...cell.font, color: { argb: 'FF1A7A2E' } };
                        else if (v < 0) cell.font = { ...cell.font, color: { argb: 'FFCC0000' } };
                    }
                });
            });

            // Auto column widths
            ws.columns.forEach((col, i) => {
                let maxLen = String(headers[i] || '').length;
                rows.forEach(r => { const l = String(r[i] || '').length; if (l > maxLen) maxLen = l; });
                col.width = Math.min(Math.max(maxLen + 4, 10), 35);
            });

            // Freeze header + auto filter
            ws.views = [{ state: 'frozen', ySplit: 1 }];
            ws.autoFilter = { from: { row: 1, column: 1 }, to: { row: rows.length + 1, column: headers.length } };

            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        }

        // Helper to extract visible table data for generic export
        function getTableExportData(tableId, getRowFn, dataArr, sortState, formatCellFn) {
            const colDefs = tableColumnDefs[tableId];
            if (!colDefs || colDefs === 'dynamic') return null;
            const visibleCols = colDefs.filter(c => !isColumnHidden(tableId, c.key));
            let rows = dataArr.map(r => typeof getRowFn === 'function' ? getRowFn(r) : r);
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden(tableId, c.key)) continue;
                    const formatted = typeof formatCellFn === 'function' ? formatCellFn(c.key, row) : String(row[c.key] || '');
                    if (!passesColumnFilter(tableId, c.key, formatted)) return false;
                }
                return true;
            });
            if (sortState && sortState.field) {
                const sf = sortState.field, asc = sortState.asc;
                rows.sort((a, b) => {
                    let va = a[sf], vb = b[sf];
                    if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                    return String(va||'').localeCompare(String(vb||'')) * (asc ? 1 : -1);
                });
            }
            const isEs = currentLang === 'es';
            const headers = visibleCols.map(c => isEs ? c.labelEs : c.labelEn);
            const colKeys = visibleCols.map(c => c.key);
            const colTypes = visibleCols.map(c => detectColType(c.key, isEs ? c.labelEs : c.labelEn));
            const exportRows = rows.map(row => visibleCols.map(c => {
                const t = detectColType(c.key, isEs ? c.labelEs : c.labelEn);
                const v = row[c.key];
                if (t === 'currency') return typeof v === 'number' ? v : v;
                if (t === 'percent') return typeof v === 'number' ? v : v;
                if (t === 'integer') return typeof v === 'number' ? v : v;
                return v == null ? '' : v;
            }));
            return { headers, colKeys, colTypes, exportRows };
        }

        // ============================================================
        // MONTHLY ORDERS â€” SPECIALIZED EXCEL TEMPLATE (Simon's design)
        // ============================================================
        async function exportDatesMonthlyOrdersExcel() {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('Monthly Orders');
            const colDefs = tableColumnDefs['datesMonthlyOrders'];
            const visibleCols = colDefs.filter(c => !isColumnHidden('datesMonthlyOrders', c.key));
            const isEs = currentLang === 'es';

            // Prepare data (same filtering/sorting as CSV export)
            let rows = datesMonthlyOrdersData.map(r => getDatesMonthlyOrderRow(r));
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden('datesMonthlyOrders', c.key)) continue;
                    if (!passesColumnFilter('datesMonthlyOrders', c.key, formatMonthlyOrderCell(c.key, row))) return false;
                }
                return true;
            });
            const sf = datesMonthlyOrdersSort.field, asc = datesMonthlyOrdersSort.asc;
            rows.sort((a, b) => {
                let va = a[sf], vb = b[sf];
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                return String(va||'').localeCompare(String(vb||'')) * (asc ? 1 : -1);
            });

            const headers = visibleCols.map(c => isEs ? c.labelEs : c.labelEn);

            // Column type and alignment map per key
            const colSpec = {
                category:       { type: 'text', align: 'center', width: 85/7 },
                dateOfRequest:  { type: 'date', align: 'center', width: 105/7 },
                ifNum:          { type: 'text', align: 'center', width: 95/7 },
                fusionStatus:   { type: 'text', align: 'center', width: 115/7 },
                internalStatus: { type: 'text', align: 'center', width: 110/7 },
                poNum:          { type: 'text', align: 'left', width: 155/7 },
                customer:       { type: 'text', align: 'left', width: 210/7 },
                part:           { type: 'text', align: 'center', width: 130/7 },
                qty:            { type: 'integer', align: 'center', width: 80/7 },
                requestedDate:  { type: 'date', align: 'center', width: 105/7 },
                unitPrice:      { type: 'currency', align: 'right', width: 85/7 },
                contribution:   { type: 'percent', align: 'center', width: 105/7 },
                variableCost:   { type: 'currency', align: 'right', width: 95/7 },
                totalCost:      { type: 'currency', align: 'right', width: 85/7 },
                salesTarget:    { type: 'currency', align: 'right', width: 105/7 },
                profitPerPart:  { type: 'currency', align: 'right', width: 90/7 },
                pl:             { type: 'currency', align: 'right', width: 100/7 },
                revenue:        { type: 'currency', align: 'right', width: 100/7 },
                shippedDate:    { type: 'date', align: 'center', width: 100/7 },
                shippingCost:   { type: 'currency', align: 'right', width: 100/7 }
            };

            // Set column widths
            ws.columns = visibleCols.map(c => ({ width: (colSpec[c.key] || { width: 14 }).width }));

            // === HEADER ROW ===
            const headerRow = ws.addRow(headers);
            headerRow.height = 32;
            headerRow.eachCell((cell) => {
                cell.font = { name: 'Aptos', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F3864' } };
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.border = {
                    bottom: { style: 'medium', color: { argb: 'FF0D1B3E' } },
                    left: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                    right: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                    top: { style: 'medium', color: { argb: 'FF1F3864' } }
                };
            });

            // === DATA ROWS ===
            const numDataRows = rows.length;
            rows.forEach((row, ri) => {
                const vals = visibleCols.map(c => {
                    const spec = colSpec[c.key] || { type: 'text' };
                    const v = row[c.key];
                    if (spec.type === 'currency') return typeof v === 'number' ? v : (parseFloat(String(v).replace(/[$,]/g,'')) || 0);
                    if (spec.type === 'percent') return typeof v === 'number' ? v / 100 : 0;
                    if (spec.type === 'integer') return typeof v === 'number' ? v : (parseInt(v) || 0);
                    return v == null || v === '-' ? '' : v;
                });
                const dataRow = ws.addRow(vals);
                dataRow.height = 22;
                const bgArgb = ri % 2 === 0 ? 'FFF2F6FC' : 'FFFFFFFF';
                dataRow.eachCell((cell, colNum) => {
                    const key = visibleCols[colNum - 1].key;
                    const spec = colSpec[key] || { type: 'text', align: 'left' };
                    cell.font = { name: 'Aptos', size: 10, color: { argb: 'FF2D2D2D' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgArgb } };
                    cell.alignment = { horizontal: spec.align, vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        bottom: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        left: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                        right: { style: 'thin', color: { argb: 'FFD6DCE4' } }
                    };
                    if (spec.type === 'currency') cell.numFmt = '$#,##0.00';
                    else if (spec.type === 'percent') cell.numFmt = '0.0%';
                    else if (spec.type === 'integer') cell.numFmt = '#,##0';

                    // P/L color coding (columns: pl, profitPerPart, contribution)
                    if (['pl', 'profitPerPart'].includes(key)) {
                        const v = typeof cell.value === 'number' ? cell.value : 0;
                        if (v > 0) cell.font = { name: 'Aptos', size: 10, bold: true, color: { argb: 'FF1A7A2E' } };
                        else if (v < 0) cell.font = { name: 'Aptos', size: 10, bold: true, color: { argb: 'FFCC0000' } };
                    }
                    if (key === 'contribution') {
                        const v = typeof cell.value === 'number' ? cell.value : 0;
                        if (v > 0) cell.font = { name: 'Aptos', size: 10, color: { argb: 'FF1A7A2E' } };
                        else if (v < 0) cell.font = { name: 'Aptos', size: 10, color: { argb: 'FFCC0000' } };
                    }
                });
            });

            // === BLANK SEPARATOR (prevents totals from being sorted/filtered with data) ===
            const sepRow = ws.addRow([]);
            sepRow.height = 6;

            // === TOTALS ROW (uses SUBTOTAL formulas â€” auto-updates when filtering) ===
            function colLtr(idx) { let s = ''; let n = idx + 1; while (n > 0) { n--; s = String.fromCharCode(65 + (n % 26)) + s; n = Math.floor(n / 26); } return s; }
            const totalsRowNum = numDataRows + 3; // header(1) + data + separator
            const dataStart = 2, dataEnd = numDataRows + 1;
            const totalsVals = visibleCols.map((c, ci) => {
                const col = colLtr(ci);
                if (c.key === 'category') return 'TOTALS';
                // SUBTOTAL(109,...) = SUM of visible cells only; SUBTOTAL(101,...) = AVERAGE of visible
                if (c.key === 'qty') return { formula: `SUBTOTAL(109,${col}${dataStart}:${col}${dataEnd})` };
                if (c.key === 'contribution') return { formula: `SUBTOTAL(101,${col}${dataStart}:${col}${dataEnd})` };
                if (c.key === 'pl') return { formula: `SUBTOTAL(109,${col}${dataStart}:${col}${dataEnd})` };
                if (c.key === 'revenue') return { formula: `SUBTOTAL(109,${col}${dataStart}:${col}${dataEnd})` };
                return '';
            });
            const totRow = ws.addRow(totalsVals);
            totRow.height = 32;
            totRow.eachCell((cell, colNum) => {
                const key = visibleCols[colNum - 1].key;
                const spec = colSpec[key] || { type: 'text', align: 'center' };
                cell.font = { name: 'Aptos', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F3864' } };
                cell.alignment = { horizontal: key === 'category' ? 'center' : (spec.align || 'right'), vertical: 'middle' };
                cell.border = {
                    top: { style: 'medium', color: { argb: 'FF0D1B3E' } },
                    bottom: { style: 'medium', color: { argb: 'FF0D1B3E' } },
                    left: { style: 'thin', color: { argb: 'FFD6DCE4' } },
                    right: { style: 'thin', color: { argb: 'FFD6DCE4' } }
                };
                if (spec.type === 'currency') cell.numFmt = '$#,##0.00';
                else if (spec.type === 'percent') cell.numFmt = '0.0%';
                else if (spec.type === 'integer') cell.numFmt = '#,##0';
                // Special colors for totals
                if (key === 'pl') { const v = typeof cell.value === 'number' ? cell.value : 0; cell.font = { name: 'Aptos', size: 11, bold: true, color: { argb: v >= 0 ? 'FF4ADE80' : 'FFFF6B6B' } }; }
                if (key === 'qty') cell.alignment = { horizontal: 'center', vertical: 'middle' };
                if (key === 'contribution') cell.alignment = { horizontal: 'center', vertical: 'middle' };
            });

            // === CONDITIONAL FORMATTING (3-color scales + data bars) ===
            const plColIdx = visibleCols.findIndex(c => c.key === 'pl');
            const contribColIdx = visibleCols.findIndex(c => c.key === 'contribution');
            const revenueColIdx = visibleCols.findIndex(c => c.key === 'revenue');
            const qtyColIdx = visibleCols.findIndex(c => c.key === 'qty');

            // ExcelJS conditional formatting for 3-color scales
            const lastDataRow = numDataRows + 1; // +1 for header

            if (plColIdx >= 0) {
                const col = colLtr(plColIdx);
                ws.addConditionalFormatting({ ref: `${col}2:${col}${lastDataRow}`, rules: [{ type: 'colorScale', cfvo: [{ type: 'min' }, { type: 'num', value: 0 }, { type: 'max' }], color: [{ argb: 'FFF4CCCC' }, { argb: 'FFFFFFFF' }, { argb: 'FFD9EAD3' }], priority: 1 }] });
            }
            if (contribColIdx >= 0) {
                const col = colLtr(contribColIdx);
                ws.addConditionalFormatting({ ref: `${col}2:${col}${lastDataRow}`, rules: [{ type: 'colorScale', cfvo: [{ type: 'min' }, { type: 'num', value: 0 }, { type: 'max' }], color: [{ argb: 'FFF4CCCC' }, { argb: 'FFFFFFFF' }, { argb: 'FFD9EAD3' }], priority: 2 }] });
            }
            if (revenueColIdx >= 0) {
                const col = colLtr(revenueColIdx);
                ws.addConditionalFormatting({ ref: `${col}2:${col}${lastDataRow}`, rules: [{ type: 'dataBar', cfvo: [{ type: 'min' }, { type: 'max' }], color: { argb: 'FF4472C4' }, priority: 3 }] });
            }
            if (qtyColIdx >= 0) {
                const col = colLtr(qtyColIdx);
                ws.addConditionalFormatting({ ref: `${col}2:${col}${lastDataRow}`, rules: [{ type: 'dataBar', cfvo: [{ type: 'min' }, { type: 'max' }], color: { argb: 'FF8FAADC' }, priority: 4 }] });
            }

            // Outside border for entire table
            const lastCol = colLtr(visibleCols.length - 1);
            const lastRow = numDataRows + 2; // header + data + totals

            // Freeze header row + auto filter (data rows only, excludes totals)
            ws.views = [{ state: 'frozen', ySplit: 1 }];
            ws.autoFilter = { from: { row: 1, column: 1 }, to: { row: numDataRows + 1, column: visibleCols.length } };

            // Download
            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `monthly_orders_${currentDrilldownMonth || 'export'}.xlsx`; a.click();
        }

        // ============================================================
        // GENERIC EXCEL EXPORT WRAPPERS (all other tables)
        // ============================================================
        function exportDatesCustomerExcel() {
            const colDefs = tableColumnDefs['datesCustomer'];
            const visibleCols = colDefs.filter(c => !isColumnHidden('datesCustomer', c.key));
            const custStats = {};
            datesCustomerData.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { customer: c, orders: 0, quantity: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].quantity += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            let rows = Object.values(custStats).map(s => { s.margin = s.revenue > 0 ? (s.pl / s.revenue * 100) : 0; return s; });
            rows = rows.filter(row => { for (const c of colDefs) { if (isColumnHidden('datesCustomer', c.key)) continue; if (!passesColumnFilter('datesCustomer', c.key, formatDatesCustomerCell(c.key, row))) return false; } return true; });
            rows.sort((a, b) => { const sf = datesCustomerSort.field, asc = datesCustomerSort.asc; let va = a[sf], vb = b[sf]; if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va; return String(va||'').localeCompare(String(vb||'')) * (asc ? 1 : -1); });
            const isEs = currentLang === 'es';
            const headers = visibleCols.map(c => isEs ? c.labelEs : c.labelEn);
            const colKeys = visibleCols.map(c => c.key);
            const colTypes = visibleCols.map(c => detectColType(c.key, isEs ? c.labelEs : c.labelEn));
            const exportRows = rows.map(row => visibleCols.map(c => row[c.key]));
            genericExcelExport(headers, exportRows, colKeys, `customer_breakdown_${currentDrilldownMonth || 'export'}.xlsx`, colTypes);
        }

        // Helper: build generic Excel from DOM table (for tables without structured data)
        function exportFromDOMTable(tableBodyId, tableHeaderId, filename) {
            const headerEl = document.getElementById(tableHeaderId);
            const bodyEl = document.getElementById(tableBodyId);
            if (!headerEl || !bodyEl) return;
            const headers = []; const colKeys = [];
            headerEl.querySelectorAll('th').forEach((th, i) => { headers.push(th.textContent.replace(/[â†‘â†“â–²â–¼â¬†â¬‡]/g,'').trim()); colKeys.push('col' + i); });
            const rows = [];
            bodyEl.querySelectorAll('tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    let v = td.textContent.trim();
                    const n = parseFloat(v.replace(/[$,%]/g, ''));
                    if (!isNaN(n) && v.match(/^[\$\-\d,\.%]+$/)) row.push(v); else row.push(v);
                });
                if (row.length) rows.push(row);
            });
            const colTypes = headers.map((h, i) => detectColType(colKeys[i], h));
            genericExcelExport(headers, rows, colKeys, filename, colTypes);
        }

        // Wrapper functions for each table's Excel export
        function exportOrdersDataExcel() { exportFromDOMTable('ordersDataTableBody', 'ordersDataTableHeader', 'orders_data.xlsx'); }
        function exportProdMakeExcel() { exportFromDOMTable('prodMakeTableBody', 'prodMakeTableHeader', 'need_to_make.xlsx'); }
        function exportOrdersQueueExcel() { exportFromDOMTable('ordersQueueTableBody', 'ordersQueueTableHeader', 'orders_queue.xlsx'); }
        function exportOrdersStagedExcel() { exportFromDOMTable('ordersStagedTableBody', 'ordersStagedTableHeader', 'orders_staged.xlsx'); }
        function exportOrdersShippedExcel() { exportFromDOMTable('ordersShippedTableBody', 'ordersShippedTableHeader', 'orders_shipped.xlsx'); }
        function exportInvExcel() { exportFromDOMTable('invTableBody', 'invTableHeader', 'inventory.xlsx'); }
        function exportSalesExcel() {
            const data = getFilteredSalesData();
            const headers = ['Part', 'Customer', 'Qty', 'Revenue', 'P/L'];
            const colKeys = ['part', 'customer', 'qty', 'revenue', 'pl'];
            const colTypes = ['text', 'text', 'integer', 'currency', 'currency'];
            const rows = data.map(r => [getVal(r,'PART'), getVal(r,'CUSTOMER'), parseNumber(getVal(r,'QTY')), parseNumber(r[COL.REVENUE]), hasMissingCostData(r) ? 0 : getPLValue(r)]);
            genericExcelExport(headers, rows, colKeys, `sales_${new Date().toISOString().split('T')[0]}.xlsx`, colTypes);
        }
        function exportPartsExcel() { exportFromDOMTable('partsTableBody', 'partsTableHeader', 'parts_pl.xlsx'); }
        function exportCustomersExcel() { exportFromDOMTable('customersTableBody', 'customersTableHeader', 'customers_pl.xlsx'); }
        function exportDatesExcel() { exportFromDOMTable('datesTableBody', 'datesTableHeader', 'dates_pl.xlsx'); }
        function exportAllDataExcel() { exportFromDOMTable('allDataTableBody', 'allDataTableHeader', `all_data_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportFpRefExcel() { exportFromDOMTable('fpRefTableBody', 'fpRefTableHeader', `fp_reference_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportCustRefExcel() { exportFromDOMTable('custRefTableBody', 'custRefTableHeader', `customer_reference_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportQuotesExcel() { exportFromDOMTable('quotesTableBody', 'quotesTableHeader', `quotes_registry_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportPalletRecordsExcel() { exportFromDOMTable('palletRecordsTableBody', 'palletRecordsTableHeader', `pallet_records_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportShippingRecordsExcel() { exportFromDOMTable('shippingRecordsTableBody', 'shippingRecordsTableHeader', `shipping_records_${new Date().toISOString().split('T')[0]}.xlsx`); }
        function exportStagedRecordsExcel() { exportFromDOMTable('stagedRecordsTableBody', 'stagedRecordsTableHeader', `staged_records_${new Date().toISOString().split('T')[0]}.xlsx`); }

        // ============================================================
        // INVENTORY PAGE
        // ============================================================
        function setInvFilter(filter) {
            const sourceFilters = ['make', 'purchased', 'com'];
            const conditionFilters = ['low', 'needed', 'runningLow'];
            
            if (filter === 'all') {
                // Reset everything
                invSourceFilters.clear();
                invConditionFilters.clear();
            } else if (sourceFilters.includes(filter)) {
                // Toggle source filter (multi-select)
                if (invSourceFilters.has(filter)) invSourceFilters.delete(filter);
                else invSourceFilters.add(filter);
            } else if (conditionFilters.includes(filter)) {
                // Toggle condition filter (multi-select)
                if (invConditionFilters.has(filter)) invConditionFilters.delete(filter);
                else invConditionFilters.add(filter);
            }
            
            // Update active states
            const anyActive = invSourceFilters.size > 0 || invConditionFilters.size > 0;
            document.getElementById('invFilterAll').classList.toggle('active', !anyActive);
            document.getElementById('invFilterLow').classList.toggle('active', invConditionFilters.has('low'));
            document.getElementById('invFilterNeeded').classList.toggle('active', invConditionFilters.has('needed'));
            document.getElementById('invFilterRunningLow')?.classList.toggle('active', invConditionFilters.has('runningLow'));
            document.getElementById('invFilterMake')?.classList.toggle('active', invSourceFilters.has('make'));
            document.getElementById('invFilterPurchased')?.classList.toggle('active', invSourceFilters.has('purchased'));
            document.getElementById('invFilterCOM')?.classList.toggle('active', invSourceFilters.has('com'));
            
            // Keep legacy invFilter for backward compat
            invFilter = anyActive ? 'multi' : 'all';
            renderInvTable();
        }
        
        // Cache for usage stats (recalculated when inventory page loads)
        let invUsageCache = {};

        async function updateInventoryPage() {
            // Load history data for forecast columns
            await loadInventoryHistoryData();
            
            // Pre-compute usage/production stats for all inventory items
            invUsageCache = {};
            inventoryData.forEach(i => {
                const type = (i.itemType || '').toLowerCase();
                const isManufactured = type.includes('make') || type.includes('manufactured');
                const usageStats = calculateUsageStats(i.partNumber);
                const prodStats = isManufactured ? calculateProductionStats(i.partNumber) : null;
                invUsageCache[i.partNumber] = { ...usageStats, prodStats, isManufactured };
            });
            
            const lowStock = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            const needsProduction = inventoryData.filter(i => i.partsToBeMade > 0);
            const okStock = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
            const runningLow = inventoryData.filter(i => {
                const u = invUsageCache[i.partNumber];
                return u && u.daysToMin !== null && u.daysToMin < 30;
            });
            const productTypes = [...new Set(inventoryData.map(i => i.product).filter(p => p))];
            
            document.getElementById('invStatTotal').textContent = formatNumber(inventoryData.length);
            document.getElementById('invStatTypes').textContent = `${productTypes.length} ${t('ui.productTypes')}`;
            document.getElementById('invStatLow').textContent = formatNumber(lowStock.length);
            document.getElementById('invStatNeeded').textContent = formatNumber(needsProduction.length);
            document.getElementById('invStatOk').textContent = formatNumber(okStock.length);
            if (document.getElementById('invStatRunningLow')) {
                document.getElementById('invStatRunningLow').textContent = formatNumber(runningLow.length);
            }
            
            // Preserve existing filter selection, only default to 'all' on first load
            if (invSourceFilters.size === 0 && invConditionFilters.size === 0) {
                setInvFilter('all');
            } else {
                renderInvTable();
            }
        }
        
        function sortInvTable(field) {
            if (invSort.field === field) invSort.asc = !invSort.asc;
            else { invSort.field = field; invSort.asc = true; }
            renderInvTable();
        }
        
        function renderInvTableHeader() {
            initHiddenColumns('inventory');
            const cols = [
                { key: 'product', label: 'Product Type' },
                { key: 'partNumber', label: 'Part Number' },
                { key: 'fusionQty', label: 'Fusion Qty' },
                { key: 'minimum', label: 'Minimum' },
                { key: 'manualTarget', label: 'Manual Target' },
                { key: 'qtyNeeded', label: 'Qty Needed' },
                { key: 'partsToBeMade', label: 'Parts to Make' },
                { key: 'moldType', label: 'Mold Type' },
                { key: 'avgUsage', label: 'Avg Usage/Day' },
                { key: 'usageTrend', label: 'Trend' },
                { key: 'daysToMin', label: 'Days to Min' },
                { key: 'daysToZero', label: 'Days to Zero' },
                { key: 'status', label: 'Status' },
                { key: 'itemType', label: 'Item Type' }
            ];
            document.getElementById('invTableHeader').innerHTML = cols.map(col => {
                if (isColumnHidden('inventory', col.key)) return '';
                return createFilterHeader('inventory', col.key, col.label);
            }).join('');
        }
        
        function renderInvTable() {
            renderInvTableHeader();
            let data = [...inventoryData];
            const searchTerm = (document.getElementById('invSearch')?.value || '').toLowerCase();
            
            // Multi-select filter logic
            if (invSourceFilters.size > 0) {
                data = data.filter(i => {
                    const type = (i.itemType || '').toLowerCase();
                    return invSourceFilters.has(type);
                });
            }
            if (invConditionFilters.size > 0) {
                data = data.filter(i => {
                    // OR within condition group â€” item passes if it matches ANY selected condition
                    if (invConditionFilters.has('low') && i.fusionQty < i.minimum && i.minimum > 0) return true;
                    if (invConditionFilters.has('needed') && i.partsToBeMade > 0) return true;
                    if (invConditionFilters.has('runningLow')) {
                        const u = invUsageCache[i.partNumber];
                        if (u && u.daysToMin !== null && u.daysToMin < 30) return true;
                    }
                    return false;
                });
            }
            
            if (searchTerm) {
                data = data.filter(i => (i.partNumber || '').toLowerCase().includes(searchTerm) || (i.product || '').toLowerCase().includes(searchTerm) || (i.moldType || '').toLowerCase().includes(searchTerm));
            }
            
            // Apply column filters
            data = data.filter(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const status = isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK');
                
                if (!passesColumnFilter('inventory', 'product', i.product || '-')) return false;
                if (!passesColumnFilter('inventory', 'partNumber', i.partNumber)) return false;
                if (!passesColumnFilter('inventory', 'fusionQty', String(i.fusionQty))) return false;
                if (!passesColumnFilter('inventory', 'minimum', String(i.minimum))) return false;
                if (!passesColumnFilter('inventory', 'manualTarget', String(i.manualTarget))) return false;
                if (!passesColumnFilter('inventory', 'qtyNeeded', String(i.qtyNeeded))) return false;
                if (!passesColumnFilter('inventory', 'partsToBeMade', String(i.partsToBeMade))) return false;
                if (!passesColumnFilter('inventory', 'moldType', i.moldType || '-')) return false;
                
                // Item type filter
                const iType = (i.itemType || '').toLowerCase();
                const itemTypeBadge = iType.includes('purchased') ? 'ðŸ›’ Purchased' : (iType.includes('make') || iType.includes('manufactured') ? 'ðŸ­ Manufactured' : (iType.includes('com') ? 'ðŸ“¦ COM' : '-'));
                if (!passesColumnFilter('inventory', 'itemType', itemTypeBadge)) return false;
                
                // Forecast column filters (type-aware)
                const uStats = invUsageCache[i.partNumber] || {};
                const isMfgF = uStats.isManufactured;
                const pStatsF = uStats.prodStats;
                const avgUsageVal = isMfgF && pStatsF ? (pStatsF.avgDailyProduction ? pStatsF.avgDailyProduction.toFixed(1) + ' âš™ï¸' : '-') : (uStats.projectionRate ? uStats.projectionRate.toFixed(1) : '-');
                let trendVal;
                if (isMfgF && pStatsF && pStatsF.prod7 != null && pStatsF.prod30 != null) {
                    trendVal = pStatsF.prod7 > pStatsF.prod30 * 1.1 ? 'â†‘ Faster' : (pStatsF.prod7 < pStatsF.prod30 * 0.9 ? 'â†“ Slower' : 'â†’ Stable');
                } else {
                    trendVal = (uStats.usage7 != null && uStats.usage30 != null) ? (uStats.usage7 > uStats.usage30 * 1.1 ? 'â†‘ Up' : (uStats.usage7 < uStats.usage30 * 0.9 ? 'â†“ Down' : 'â†’ Stable')) : '-';
                }
                const daysToMinVal = isMfgF && pStatsF && pStatsF.daysToTarget !== null ? pStatsF.daysToTarget + 'd to target' : (uStats.daysToMin !== null ? (uStats.daysToMin === 0 ? 'âš ï¸ NOW' : String(uStats.daysToMin) + 'd') : '-');
                const daysToZeroVal = !isMfgF && uStats.daysToZero !== null ? String(uStats.daysToZero) + 'd' : '-';
                if (!passesColumnFilter('inventory', 'avgUsage', avgUsageVal)) return false;
                if (!passesColumnFilter('inventory', 'usageTrend', trendVal)) return false;
                if (!passesColumnFilter('inventory', 'daysToMin', daysToMinVal)) return false;
                if (!passesColumnFilter('inventory', 'daysToZero', daysToZeroVal)) return false;
                if (!passesColumnFilter('inventory', 'status', status)) return false;
                return true;
            });
            
            data.sort((a, b) => {
                let va, vb;
                // Handle forecast columns
                if (invSort.field === 'itemType') {
                    va = a.itemType || ''; vb = b.itemType || '';
                } else if (invSort.field === 'avgUsage') {
                    const ca = invUsageCache[a.partNumber] || {};
                    const cb = invUsageCache[b.partNumber] || {};
                    va = ca.isManufactured && ca.prodStats ? (ca.prodStats.avgDailyProduction || 0) : (ca.projectionRate || 0);
                    vb = cb.isManufactured && cb.prodStats ? (cb.prodStats.avgDailyProduction || 0) : (cb.projectionRate || 0);
                } else if (invSort.field === 'daysToMin') {
                    va = invUsageCache[a.partNumber]?.daysToMin ?? 99999;
                    vb = invUsageCache[b.partNumber]?.daysToMin ?? 99999;
                } else if (invSort.field === 'daysToZero') {
                    va = invUsageCache[a.partNumber]?.daysToZero ?? 99999;
                    vb = invUsageCache[b.partNumber]?.daysToZero ?? 99999;
                } else if (invSort.field === 'usageTrend') {
                    const ua = invUsageCache[a.partNumber] || {};
                    const ub = invUsageCache[b.partNumber] || {};
                    va = (ua.usage7 != null && ua.usage30 != null && ua.usage30 > 0) ? ua.usage7 / ua.usage30 : 0;
                    vb = (ub.usage7 != null && ub.usage30 != null && ub.usage30 > 0) ? ub.usage7 / ub.usage30 : 0;
                } else {
                    va = a[invSort.field]; vb = b[invSort.field];
                }
                if (typeof va === 'string') return invSort.asc ? (va || '').localeCompare(vb || '') : (vb || '').localeCompare(va || '');
                return invSort.asc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
            });
            
            document.getElementById('invTableCount').textContent = `${data.length} ${t('ui.items')}`;
            const tbody = document.getElementById('invTableBody');
            tbody.innerHTML = data.map(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const rowClass = isLow ? 'inv-low clickable-row' : (needsMake ? 'inv-warning clickable-row' : 'clickable-row');
                const statusBadge = isLow ? `<span class="badge" style="background:var(--danger);color:white;">${t('status.low')}</span>` : (needsMake ? `<span class="badge" style="background:var(--warning);color:#1a202c;">${t('status.make')}</span>` : `<span class="badge" style="background:var(--success);color:white;">${t('status.ok')}</span>`);
                const escapedPart = (i.partNumber || '').replace(/'/g, "\\'");
                
                // Build row with hidden column support
                let cells = '';
                if (!isColumnHidden('inventory', 'product')) cells += `<td>${i.product || '-'}</td>`;
                if (!isColumnHidden('inventory', 'partNumber')) cells += `<td><strong>${i.partNumber}</strong><button class="inv-history-btn" onclick="event.stopPropagation(); openInventoryHistoryModal('${escapedPart}')">ðŸ“ˆ</button></td>`;
                if (!isColumnHidden('inventory', 'fusionQty')) cells += `<td>${formatNumber(i.fusionQty)}</td>`;
                if (!isColumnHidden('inventory', 'minimum')) cells += `<td>${formatNumber(i.minimum)}</td>`;
                if (!isColumnHidden('inventory', 'manualTarget')) cells += `<td>${formatNumber(i.manualTarget)}</td>`;
                if (!isColumnHidden('inventory', 'qtyNeeded')) cells += `<td>${formatNumber(i.qtyNeeded)}</td>`;
                if (!isColumnHidden('inventory', 'partsToBeMade')) cells += `<td class="${i.partsToBeMade > 0 ? 'negative' : ''}">${formatNumber(i.partsToBeMade)}</td>`;
                if (!isColumnHidden('inventory', 'moldType')) cells += `<td>${i.moldType || '-'}</td>`;
                
                // Forecast columns â€” different logic for manufactured vs purchased/COM
                const uStats = invUsageCache[i.partNumber] || {};
                const isMfg = uStats.isManufactured;
                const pStats = uStats.prodStats;
                
                if (!isColumnHidden('inventory', 'avgUsage')) {
                    if (isMfg && pStats) {
                        const avgVal = pStats.avgDailyProduction ? pStats.avgDailyProduction.toFixed(1) : '-';
                        cells += `<td style="color:#4299e1;">${avgVal}${avgVal !== '-' ? ' âš™ï¸' : ''}</td>`;
                    } else {
                        const avgVal = uStats.projectionRate ? uStats.projectionRate.toFixed(1) : '-';
                        cells += `<td>${avgVal}</td>`;
                    }
                }
                if (!isColumnHidden('inventory', 'usageTrend')) {
                    let trendIcon = '-';
                    let trendColor = 'var(--text-secondary)';
                    if (isMfg && pStats && pStats.prod7 != null && pStats.prod30 != null) {
                        if (pStats.prod7 > pStats.prod30 * 1.1) { trendIcon = 'â†‘ Faster'; trendColor = 'var(--success)'; }
                        else if (pStats.prod7 < pStats.prod30 * 0.9) { trendIcon = 'â†“ Slower'; trendColor = 'var(--danger)'; }
                        else { trendIcon = 'â†’ Stable'; trendColor = 'var(--text-secondary)'; }
                    } else if (uStats.usage7 != null && uStats.usage30 != null) {
                        if (uStats.usage7 > uStats.usage30 * 1.1) { trendIcon = 'â†‘ Up'; trendColor = 'var(--danger)'; }
                        else if (uStats.usage7 < uStats.usage30 * 0.9) { trendIcon = 'â†“ Down'; trendColor = 'var(--success)'; }
                        else { trendIcon = 'â†’ Stable'; trendColor = 'var(--text-secondary)'; }
                    }
                    cells += `<td style="color:${trendColor};font-weight:600;">${trendIcon}</td>`;
                }
                if (!isColumnHidden('inventory', 'daysToMin')) {
                    let dtmText = '-', dtmColor = 'var(--text-secondary)';
                    if (isMfg && pStats && pStats.daysToTarget !== null) {
                        dtmText = pStats.daysToTarget + 'd to target';
                        dtmColor = 'var(--accent)';
                    } else if (uStats.daysToMin !== null) {
                        if (uStats.daysToMin === 0) { dtmText = 'âš ï¸ NOW'; dtmColor = 'var(--danger)'; }
                        else { dtmText = uStats.daysToMin + 'd'; dtmColor = uStats.daysToMin < 14 ? 'var(--danger)' : (uStats.daysToMin < 30 ? 'var(--warning)' : 'var(--success)'); }
                    }
                    cells += `<td style="color:${dtmColor};font-weight:600;">${dtmText}</td>`;
                }
                if (!isColumnHidden('inventory', 'daysToZero')) {
                    let dtzText = '-', dtzColor = 'var(--text-secondary)';
                    if (!isMfg && uStats.daysToZero !== null) {
                        dtzText = uStats.daysToZero + 'd';
                        dtzColor = uStats.daysToZero < 30 ? 'var(--danger)' : (uStats.daysToZero < 60 ? 'var(--warning)' : 'var(--success)');
                    }
                    cells += `<td style="color:${dtzColor};font-weight:600;">${dtzText}</td>`;
                }
                
                if (!isColumnHidden('inventory', 'status')) cells += `<td>${statusBadge}</td>`;
                
                // Item Type column (last)
                if (!isColumnHidden('inventory', 'itemType')) {
                    const type = (i.itemType || '').toLowerCase();
                    let typeBadge = '-';
                    if (type.includes('purchased')) typeBadge = '<span class="badge" style="background:#48bb78;color:white;font-size:10px;">ðŸ›’ Purchased</span>';
                    else if (type.includes('make') || type.includes('manufactured')) typeBadge = '<span class="badge" style="background:#4299e1;color:white;font-size:10px;">ðŸ­ Manufactured</span>';
                    else if (type.includes('com')) typeBadge = '<span class="badge" style="background:#ed8936;color:white;font-size:10px;">ðŸ“¦ COM</span>';
                    cells += `<td>${typeBadge}</td>`;
                }
                
                return `<tr class="${rowClass}" onclick="openInventoryHistoryModal('${escapedPart}')" title="${t('inv.clickHistory')}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('inventory');
            updateShowHiddenButton('inventory');
        }
        
        function filterInvTable() { renderInvTable(); }
        function exportInvCSV() { downloadCSV('Product Type,Part Number,...', 'inventory.csv'); }
        
        // ============================================================
        // INVENTORY HISTORY MODAL
        // ============================================================
        async function openInventoryHistoryModal(partNumber) {
            currentHistoryPart = partNumber;
            const modal = document.getElementById('inventoryHistoryModal');
            const loading = document.getElementById('historyLoading');
            const noData = document.getElementById('historyNoData');
            const chartContainer = document.querySelector('.history-chart-container');
            const statsPanel = document.getElementById('historyStatsPanel');
            const controls = document.querySelector('.history-controls');
            
            // Show modal with loading state
            modal.classList.add('active');
            document.getElementById('historyPartName').textContent = partNumber;
            loading.style.display = 'block';
            noData.style.display = 'none';
            chartContainer.style.display = 'none';
            statsPanel.style.display = 'none';
            controls.style.display = 'none';
            
            // Ensure history data is loaded
            await loadInventoryHistoryData();
            
            // Find data for this part
            const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
            
            loading.style.display = 'none';
            
            if (!partData || Object.keys(partData.dataByDate).length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            // Show chart and controls
            chartContainer.style.display = 'block';
            statsPanel.style.display = 'grid';
            controls.style.display = 'flex';
            
            // Reset date range to all data
            historyDateRange = { start: null, end: null };
            document.getElementById('historyStartDate').value = '';
            document.getElementById('historyEndDate').value = '';
            
            // Render chart
            renderInventoryHistoryChart();
        }
        
        function closeInventoryHistoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('inventoryHistoryModal').classList.remove('active');
            currentHistoryPart = null;
            
            // Destroy chart if exists
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
                charts.inventoryHistory = null;
            }
        }
        
        function renderInventoryHistoryChart() {
            if (!currentHistoryPart) return;
            
            const partData = inventoryHistoryData.find(p => p.partNumber === currentHistoryPart);
            if (!partData) return;
            
            // Get minimum threshold for this part
            const minimum = getPartMinimum(currentHistoryPart);
            
            // Get filtered dates based on range
            let dates = [...inventoryHistoryDates];
            if (historyDateRange.start || historyDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyDateRange.start && date < historyDateRange.start) return false;
                    if (historyDateRange.end && date > historyDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Build data points
            const dataPoints = [];
            const labels = [];
            dates.forEach(dateStr => {
                const qty = partData.dataByDate[dateStr];
                if (qty !== undefined) {
                    dataPoints.push(qty);
                    // Format label as "Jan 12"
                    const parts = dateStr.split('/');
                    const date = new Date(parts[2], parts[0] - 1, parts[1]);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    labels.push(`${monthNames[date.getMonth()]} ${date.getDate()}`);
                }
            });
            
            if (dataPoints.length === 0) {
                document.getElementById('historyNoData').style.display = 'block';
                document.querySelector('.history-chart-container').style.display = 'none';
                document.getElementById('historyStatsPanel').style.display = 'none';
                return;
            }
            
            // Calculate stats
            const current = dataPoints[dataPoints.length - 1] || 0;
            const minVal = Math.min(...dataPoints);
            const maxVal = Math.max(...dataPoints);
            const avg = Math.round(dataPoints.reduce((a, b) => a + b, 0) / dataPoints.length);
            const belowMin = minimum > 0 && current < minimum;
            
            document.getElementById('historyStatCurrent').textContent = formatNumber(current);
            document.getElementById('historyStatCurrent').style.color = belowMin ? 'var(--danger)' : 'var(--accent)';
            document.getElementById('historyStatMin').textContent = formatNumber(minimum);  // Show threshold, not historical low
            document.getElementById('historyStatMin').style.color = minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)';
            document.getElementById('historyStatMax').textContent = formatNumber(maxVal);
            document.getElementById('historyStatAvg').textContent = formatNumber(avg);

            // Calculate and display usage/production stats (all items)
            const invItem = inventoryData.find(i => i.partNumber === currentHistoryPart);
            const usagePanel = document.getElementById('historyUsagePanel');
            const itemType = (invItem?.itemType || '').toLowerCase();
            const isMfgItem = itemType.includes('make') || itemType.includes('manufactured');

            {
                usagePanel.style.display = 'grid';

                if (isMfgItem) {
                    // MANUFACTURED: show production stats
                    const prod = calculateProductionStats(currentHistoryPart);
                    document.getElementById('historyUsage7').textContent = prod.prod7 !== null ? prod.prod7.toFixed(1) : 'N/A';
                    document.getElementById('historyUsage7').parentElement.querySelector('.history-stat-label').innerHTML = '7-Day Avg Made<br><small>/day âš™ï¸</small>';
                    document.getElementById('historyUsage30').textContent = prod.prod30 !== null ? prod.prod30.toFixed(1) : 'N/A';
                    document.getElementById('historyUsage30').parentElement.querySelector('.history-stat-label').innerHTML = '30-Day Avg Made<br><small>/day âš™ï¸</small>';

                    if (prod.daysToTarget !== null) {
                        document.getElementById('historyDaysToMin').textContent = prod.daysToTarget + 'd';
                        document.getElementById('historyDaysToMin').style.color = 'var(--accent)';
                        document.getElementById('historyDaysToMin').parentElement.querySelector('.history-stat-label').textContent = 'Days to Target';
                    } else {
                        document.getElementById('historyDaysToMin').textContent = 'N/A';
                        document.getElementById('historyDaysToMin').style.color = 'var(--text-secondary)';
                        document.getElementById('historyDaysToMin').parentElement.querySelector('.history-stat-label').textContent = 'Days to Target';
                    }

                    document.getElementById('historyDaysToZero').textContent = '-';
                    document.getElementById('historyDaysToZero').style.color = 'var(--text-secondary)';
                    document.getElementById('historyDaysToZero').parentElement.querySelector('.history-stat-label').textContent = 'N/A';
                } else {
                    // PURCHASED/COM: show usage/consumption stats
                    const usage = calculateUsageStats(currentHistoryPart);
                    document.getElementById('historyUsage7').textContent = usage.usage7 !== null ? usage.usage7.toFixed(1) : 'N/A';
                    document.getElementById('historyUsage7').parentElement.querySelector('.history-stat-label').innerHTML = '7-Day Avg Usage<br><small>/day</small>';
                    document.getElementById('historyUsage30').textContent = usage.usage30 !== null ? usage.usage30.toFixed(1) : 'N/A';
                    document.getElementById('historyUsage30').parentElement.querySelector('.history-stat-label').innerHTML = '30-Day Avg Usage<br><small>/day</small>';

                    if (usage.daysToMin !== null) {
                        document.getElementById('historyDaysToMin').textContent = usage.daysToMin === 0 ? 'âš ï¸ NOW' : usage.daysToMin + 'd';
                        document.getElementById('historyDaysToMin').style.color = usage.daysToMin < 14 ? 'var(--danger)' : (usage.daysToMin < 30 ? 'var(--warning)' : 'var(--success)');
                    } else {
                        document.getElementById('historyDaysToMin').textContent = 'N/A';
                        document.getElementById('historyDaysToMin').style.color = 'var(--text-secondary)';
                    }
                    document.getElementById('historyDaysToMin').parentElement.querySelector('.history-stat-label').textContent = 'Days to Minimum';

                    if (usage.daysToZero !== null) {
                        document.getElementById('historyDaysToZero').textContent = usage.daysToZero + 'd';
                        document.getElementById('historyDaysToZero').style.color = usage.daysToZero < 30 ? 'var(--danger)' : (usage.daysToZero < 60 ? 'var(--warning)' : 'var(--success)');
                    } else {
                        document.getElementById('historyDaysToZero').textContent = 'N/A';
                        document.getElementById('historyDaysToZero').style.color = 'var(--text-secondary)';
                    }
                    document.getElementById('historyDaysToZero').parentElement.querySelector('.history-stat-label').textContent = 'Days to Zero';
                }

                // Trend: compare 7-day vs 30-day (different logic for mfg vs purchased)
                if (isMfgItem) {
                    const prod = calculateProductionStats(currentHistoryPart);
                    if (prod.prod7 !== null && prod.prod30 !== null && prod.prod30 > 0) {
                        const ratio = prod.prod7 / prod.prod30;
                        if (ratio > 1.15) {
                            document.getElementById('historyUsageTrend').textContent = 'âš¡ Faster';
                            document.getElementById('historyUsageTrend').style.color = 'var(--success)';
                        } else if (ratio < 0.85) {
                            document.getElementById('historyUsageTrend').textContent = 'ðŸŒ Slower';
                            document.getElementById('historyUsageTrend').style.color = 'var(--danger)';
                        } else {
                            document.getElementById('historyUsageTrend').textContent = 'âž¡ï¸ Stable';
                            document.getElementById('historyUsageTrend').style.color = 'var(--text-secondary)';
                        }
                    } else {
                        document.getElementById('historyUsageTrend').textContent = '-';
                        document.getElementById('historyUsageTrend').style.color = 'var(--text-secondary)';
                    }
                    document.getElementById('historyUsageTrend').parentElement.querySelector('.history-stat-label').textContent = 'Production Trend';
                } else {
                    const usage2 = calculateUsageStats(currentHistoryPart);
                    if (usage2.usage7 !== null && usage2.usage30 !== null && usage2.usage30 > 0) {
                        const ratio = usage2.usage7 / usage2.usage30;
                        if (ratio > 1.15) {
                            document.getElementById('historyUsageTrend').textContent = 'ðŸ“ˆ Increasing';
                            document.getElementById('historyUsageTrend').style.color = 'var(--danger)';
                        } else if (ratio < 0.85) {
                            document.getElementById('historyUsageTrend').textContent = 'ðŸ“‰ Decreasing';
                            document.getElementById('historyUsageTrend').style.color = 'var(--success)';
                        } else {
                            document.getElementById('historyUsageTrend').textContent = 'âž¡ï¸ Stable';
                            document.getElementById('historyUsageTrend').style.color = 'var(--text-secondary)';
                        }
                    } else {
                        document.getElementById('historyUsageTrend').textContent = '-';
                        document.getElementById('historyUsageTrend').style.color = 'var(--text-secondary)';
                    }
                    document.getElementById('historyUsageTrend').parentElement.querySelector('.history-stat-label').textContent = 'Usage Trend';
                }
            }

            // Destroy existing chart
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
            }
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryChart').getContext('2d');
            
            // Handle flat line case
            let suggestedMin = minVal * 0.9;
            let suggestedMax = maxVal * 1.1;
            if (maxVal - minVal < 1) {
                suggestedMin = minVal - Math.max(1, minVal * 0.1);
                suggestedMax = maxVal + Math.max(1, maxVal * 0.1);
            }
            
            // Dataset with segment coloring for below minimum
            const dataset = {
                label: currentHistoryPart,
                data: dataPoints,
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                fill: true,
                tension: 0.2,
                pointRadius: dataPoints.length < 30 ? 4 : 2,
                pointHoverRadius: 6
            };
            
            // Add segment coloring if minimum is set
            if (minimum > 0) {
                dataset.segment = {
                    borderColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? '#e53e3e' : '#3182ce';
                    },
                    backgroundColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? 'rgba(229, 62, 62, 0.1)' : 'rgba(49, 130, 206, 0.1)';
                    }
                };
                dataset.pointBackgroundColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
                dataset.pointBorderColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
            }

            // Build projection datasets
            const extraDatasets = [];
            if (isMfgItem) {
                // MANUFACTURED: show production projection (inventory growing)
                const prod = calculateProductionStats(currentHistoryPart);
                if (prod.avgDailyProduction && prod.avgDailyProduction > 0) {
                    const target = invItem ? (invItem.manualTarget || 0) : 0;
                    const projDays = target > 0 && current < target ? Math.min(Math.ceil((target - current) / prod.avgDailyProduction) + 5, 120) : 60;
                    const projLabels = [];
                    const projData = [];
                    const monthNames2 = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const lastDate2 = new Date();
                    for (let d = 0; d <= projDays; d++) {
                        const fd = new Date(lastDate2); fd.setDate(fd.getDate() + d);
                        const projQty = current + (prod.avgDailyProduction * d);
                        projLabels.push(d === 0 ? labels[labels.length - 1] : `${monthNames2[fd.getMonth()]} ${fd.getDate()}`);
                        projData.push(Math.round(projQty));
                        if (target > 0 && projQty >= target) break;
                    }
                    const paddedProj = new Array(dataPoints.length - 1).fill(null).concat(projData);
                    const allLbls = labels.concat(projLabels.slice(1));
                    while (dataPoints.length < allLbls.length) dataPoints.push(null);
                    labels.length = 0; allLbls.forEach(l => labels.push(l));
                    extraDatasets.push({
                        label: 'Projected Production (30d avg)',
                        data: paddedProj, borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.05)',
                        borderDash: [8, 4], fill: false, tension: 0, pointRadius: 0, pointHoverRadius: 4, borderWidth: 2
                    });
                    if (target > 0) {
                        extraDatasets.push({
                            label: 'Target', data: new Array(labels.length).fill(target),
                            borderColor: '#4299e1', borderDash: [4, 4], fill: false, pointRadius: 0, pointHoverRadius: 0, borderWidth: 1.5
                        });
                    }
                    if (minimum > 0) {
                        extraDatasets.push({
                            label: 'Minimum Threshold', data: new Array(labels.length).fill(minimum),
                            borderColor: '#ed8936', borderDash: [4, 4], fill: false, pointRadius: 0, pointHoverRadius: 0, borderWidth: 1.5
                        });
                    }
                    suggestedMin = 0;
                }
            } else {
                // PURCHASED/COM: show depletion projection
                const usage = calculateUsageStats(currentHistoryPart);
                if (usage.projectionRate && usage.projectionRate > 0 && usage.currentQty > 0) {
                    // Add projected future data points (extend chart into the future)
                    const projectionDays = Math.min(Math.ceil(usage.currentQty / usage.projectionRate) + 5, 120); // max 120 days
                    const projectionLabels = [];
                    const projectionData = [];
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                    // Start from current (last actual data point)
                    const lastActualDate = new Date();
                    for (let d = 0; d <= projectionDays; d++) {
                        const futureDate = new Date(lastActualDate);
                        futureDate.setDate(futureDate.getDate() + d);
                        const projQty = Math.max(0, usage.currentQty - (usage.projectionRate * d));

                        if (d === 0) {
                            // First projection point = last actual point (connect them)
                            projectionLabels.push(labels[labels.length - 1]);
                        } else {
                            projectionLabels.push(`${monthNames[futureDate.getMonth()]} ${futureDate.getDate()}`);
                        }
                        projectionData.push(projQty);
                        if (projQty <= 0) break; // Stop at zero
                    }

                    // Pad actual data with nulls for projection length, and pad projection data with nulls for actual length
                    const paddedProjection = new Array(dataPoints.length - 1).fill(null).concat(projectionData);
                    const allLabels = labels.concat(projectionLabels.slice(1)); // skip first projection label (duplicate of last actual)

                    // Pad actual data to match extended labels
                    while (dataPoints.length < allLabels.length) dataPoints.push(null);

                    // Replace labels array
                    labels.length = 0;
                    allLabels.forEach(l => labels.push(l));

                    // Projection line (30-day rate)
                    extraDatasets.push({
                        label: 'Projected (30d avg)',
                        data: paddedProjection,
                        borderColor: '#e53e3e',
                        backgroundColor: 'rgba(229, 62, 62, 0.05)',
                        borderDash: [8, 4],
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    });

                    // Add minimum threshold line across full range if minimum > 0
                    if (minimum > 0) {
                        extraDatasets.push({
                            label: 'Minimum Threshold',
                            data: new Array(labels.length).fill(minimum),
                            borderColor: '#ed8936',
                            borderDash: [4, 4],
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 1.5
                        });
                    }

                    // Zero line
                    extraDatasets.push({
                        label: 'Zero',
                        data: new Array(labels.length).fill(0),
                        borderColor: 'rgba(229, 62, 62, 0.3)',
                        borderDash: [2, 2],
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        borderWidth: 1
                    });

                    // Update suggestedMax to include projection
                    suggestedMin = 0;
                }
            }

            charts.inventoryHistory = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [dataset, ...extraDatasets]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: extraDatasets.length > 0, labels: { color: '#a0aec0', usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    let label = `${t('ui.qty')}: ${formatNumber(ctx.raw)}`;
                                    if (minimum > 0 && ctx.raw < minimum) {
                                        label += ` (${t('status.low')})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            suggestedMin: suggestedMin,
                            suggestedMax: suggestedMax
                        }
                    }
                }
            });
        }
        
        function updateHistoryChart() {
            const startVal = document.getElementById('historyStartDate').value;
            const endVal = document.getElementById('historyEndDate').value;
            
            historyDateRange.start = startVal ? new Date(startVal) : null;
            historyDateRange.end = endVal ? new Date(endVal) : null;
            
            renderInventoryHistoryChart();
        }
        
        function applyHistoryPreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7':
                    start = new Date(now);
                    start.setDate(start.getDate() - 7);
                    break;
                case 'last30':
                    start = new Date(now);
                    start.setDate(start.getDate() - 30);
                    break;
                case 'last90':
                    start = new Date(now);
                    start.setDate(start.getDate() - 90);
                    break;
                case 'all':
                default:
                    start = null;
                    break;
            }
            
            historyDateRange.start = start;
            historyDateRange.end = null;
            
            // Update input fields
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyStartDate').value = '';
            }
            document.getElementById('historyEndDate').value = '';
            
            renderInventoryHistoryChart();
        }

        // ============================================================
        // INVENTORY HISTORY PAGE (Multi-Part Comparison)
        // ============================================================
        async function updateInventoryHistoryPage() {
            // Ensure data is loaded
            await loadInventoryHistoryData();
            
            // Render parts list
            renderHistoryPartsList();
            
            // Render chart (will show "select parts" message if none selected)
            renderHistoryPageChart();
        }
        
        function renderHistoryPartsList() {
            const container = document.getElementById('historyPartsList');
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            
            // Get all unique parts from inventory data (which has minimum info) or history data
            let parts = [];
            if (inventoryData.length > 0) {
                parts = inventoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: item.product || '',
                    minimum: item.minimum || 0
                }));
            } else if (inventoryHistoryData.length > 0) {
                parts = inventoryHistoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: '',
                    minimum: 0
                }));
            }
            
            // Filter by search term
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    p.product.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort alphabetically
            parts.sort((a, b) => a.partNumber.localeCompare(b.partNumber));
            
            container.innerHTML = parts.map((part, idx) => {
                const isSelected = selectedHistoryParts.has(part.partNumber);
                const colorIdx = Array.from(selectedHistoryParts).indexOf(part.partNumber);
                const color = colorIdx >= 0 ? historyPartColors[colorIdx % historyPartColors.length] : '#4a5568';
                
                return `<div class="history-part-item ${isSelected ? 'selected' : ''}" onclick="toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <div class="part-info">
                        <div class="part-number">${part.partNumber}</div>
                        <div class="part-type">${part.product || '-'}</div>
                    </div>
                    ${isSelected ? `<div class="part-color" style="background:${color}"></div>` : ''}
                </div>`;
            }).join('');
            
            // Update selected count
            document.getElementById('historySelectedCount').innerHTML = 
                `${selectedHistoryParts.size} <span data-i18n="inv.selected">${t('inv.selected')}</span>`;
        }
        
        function toggleHistoryPart(partNumber) {
            if (selectedHistoryParts.has(partNumber)) {
                selectedHistoryParts.delete(partNumber);
            } else {
                if (selectedHistoryParts.size >= 10) {
                    alert(t('inv.maxPartsWarning') || 'Maximum 10 parts can be compared at once');
                    return;
                }
                selectedHistoryParts.add(partNumber);
            }
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function selectAllHistoryParts() {
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            let parts = inventoryData.length > 0 ? inventoryData : inventoryHistoryData;
            
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    (p.product || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Limit to 10
            const toAdd = parts.slice(0, 10);
            selectedHistoryParts.clear();
            toAdd.forEach(p => selectedHistoryParts.add(p.partNumber));
            
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function deselectAllHistoryParts() {
            selectedHistoryParts.clear();
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function filterHistoryPartsList() {
            renderHistoryPartsList();
        }
        
        function getPartMinimum(partNumber) {
            const invItem = inventoryData.find(i => i.partNumber === partNumber);
            return invItem ? invItem.minimum : 0;
        }

        function calculateUsageStats(partNumber) {
            const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
            if (!partData || Object.keys(partData.dataByDate).length < 2) {
                return { usage7: null, usage30: null, daysToMin: null, daysToZero: null };
            }

            // Sort all dates chronologically
            const allDates = Object.keys(partData.dataByDate).map(dateStr => {
                const parts = dateStr.split('/');
                return { str: dateStr, date: new Date(parts[2], parts[0] - 1, parts[1]) };
            }).sort((a, b) => a.date - b.date);

            if (allDates.length < 2) return { usage7: null, usage30: null, daysToMin: null, daysToZero: null };

            const latest = allDates[allDates.length - 1];
            const currentQty = partData.dataByDate[latest.str];

            // Calculate usage over N days: find the data point closest to N days ago
            function getUsageRate(days) {
                const targetDate = new Date(latest.date);
                targetDate.setDate(targetDate.getDate() - days);

                // Find closest data point to target date
                let closest = null;
                let closestDiff = Infinity;
                for (const d of allDates) {
                    const diff = Math.abs(d.date - targetDate);
                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closest = d;
                    }
                }

                if (!closest || closest.str === latest.str) return null;

                const pastQty = partData.dataByDate[closest.str];
                const actualDays = (latest.date - closest.date) / (1000 * 60 * 60 * 24);
                if (actualDays < 1) return null;

                // Usage = how much inventory decreased per day (positive = consuming)
                const dailyUsage = (pastQty - currentQty) / actualDays;
                return dailyUsage > 0 ? dailyUsage : 0; // If inventory went up, usage is 0 (restocked)
            }

            const usage7 = getUsageRate(7);
            const usage30 = getUsageRate(30);

            // Use 30-day rate for projections, fall back to 7-day
            const projectionRate = usage30 !== null && usage30 > 0 ? usage30 : (usage7 !== null && usage7 > 0 ? usage7 : null);

            const minimum = getPartMinimum(partNumber);
            let daysToMin = null;
            let daysToZero = null;

            if (projectionRate && projectionRate > 0) {
                daysToZero = Math.round(currentQty / projectionRate);
                if (minimum > 0 && currentQty > minimum) {
                    daysToMin = Math.round((currentQty - minimum) / projectionRate);
                } else if (minimum > 0 && currentQty <= minimum) {
                    daysToMin = 0; // Already below minimum
                }
            }

            return { usage7, usage30, daysToMin, daysToZero, projectionRate, currentQty };
        }

        function calculateProductionStats(partNumber) {
            const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
            if (!partData || Object.keys(partData.dataByDate).length < 2) {
                return { prod7: null, prod30: null, daysToTarget: null, avgDailyProduction: null };
            }

            const allDates = Object.keys(partData.dataByDate).map(dateStr => {
                const parts = dateStr.split('/');
                return { str: dateStr, date: new Date(parts[2], parts[0] - 1, parts[1]) };
            }).sort((a, b) => a.date - b.date);

            if (allDates.length < 2) return { prod7: null, prod30: null, daysToTarget: null, avgDailyProduction: null };

            const latest = allDates[allDates.length - 1];
            const currentQty = partData.dataByDate[latest.str];

            // Calculate production rate: sum of daily INCREASES over N days / N days
            function getProductionRate(days) {
                const targetDate = new Date(latest.date);
                targetDate.setDate(targetDate.getDate() - days);

                // Get all data points within the window
                const windowPoints = allDates.filter(d => d.date >= targetDate && d.date <= latest.date);
                if (windowPoints.length < 2) return null;

                let totalProduced = 0;
                for (let idx = 1; idx < windowPoints.length; idx++) {
                    const prev = partData.dataByDate[windowPoints[idx - 1].str];
                    const curr = partData.dataByDate[windowPoints[idx].str];
                    const diff = curr - prev;
                    if (diff > 0) totalProduced += diff; // Only count increases (production)
                }

                const actualDays = (latest.date - windowPoints[0].date) / (1000 * 60 * 60 * 24);
                if (actualDays < 1) return null;
                return totalProduced / actualDays;
            }

            const prod7 = getProductionRate(7);
            const prod30 = getProductionRate(30);
            const avgDailyProduction = prod30 !== null && prod30 > 0 ? prod30 : (prod7 !== null && prod7 > 0 ? prod7 : null);

            // Days to target (if target exists)
            const invItem = inventoryData.find(i => i.partNumber === partNumber);
            const target = invItem ? (invItem.manualTarget || 0) : 0;
            let daysToTarget = null;
            if (avgDailyProduction && avgDailyProduction > 0 && target > 0 && currentQty < target) {
                daysToTarget = Math.round((target - currentQty) / avgDailyProduction);
            }

            return { prod7, prod30, daysToTarget, avgDailyProduction, currentQty };
        }

        function renderHistoryPageChart() {
            const chartContainer = document.getElementById('historyPageChartContainer');
            const noSelection = document.getElementById('historyPageNoSelection');
            const legend = document.getElementById('historyPageLegend');
            const statsContainer = document.getElementById('historyPageStats');
            
            // Destroy existing chart
            if (charts.inventoryHistoryPage) {
                charts.inventoryHistoryPage.destroy();
                charts.inventoryHistoryPage = null;
            }
            
            if (selectedHistoryParts.size === 0) {
                noSelection.style.display = 'block';
                legend.innerHTML = '';
                statsContainer.innerHTML = '';
                return;
            }
            
            noSelection.style.display = 'none';
            
            // Get filtered dates
            let dates = [...inventoryHistoryDates];
            if (historyPageDateRange.start || historyPageDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyPageDateRange.start && date < historyPageDateRange.start) return false;
                    if (historyPageDateRange.end && date > historyPageDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Format labels
            const labels = dates.map(dateStr => {
                const parts = dateStr.split('/');
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[date.getMonth()]} ${date.getDate()}`;
            });
            
            // Build datasets
            const datasets = [];
            const partsArray = Array.from(selectedHistoryParts);
            let legendHtml = '';
            let statsHtml = '';
            
            partsArray.forEach((partNumber, idx) => {
                const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
                if (!partData) return;
                
                const color = historyPartColors[idx % historyPartColors.length];
                const minimum = getPartMinimum(partNumber);
                
                // Build data points
                const dataPoints = dates.map(dateStr => partData.dataByDate[dateStr] ?? null);
                
                // Calculate stats
                const validPoints = dataPoints.filter(v => v !== null);
                const current = validPoints.length > 0 ? validPoints[validPoints.length - 1] : 0;
                const min = validPoints.length > 0 ? Math.min(...validPoints) : 0;
                const max = validPoints.length > 0 ? Math.max(...validPoints) : 0;
                const avg = validPoints.length > 0 ? Math.round(validPoints.reduce((a, b) => a + b, 0) / validPoints.length) : 0;
                const belowMin = minimum > 0 && current < minimum;
                
                // Create dataset with segment coloring for below minimum
                datasets.push({
                    label: partNumber,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    tension: 0.2,
                    pointRadius: dates.length < 50 ? 3 : 1,
                    pointHoverRadius: 5,
                    minimum: minimum, // Store for segment callback
                    segment: {
                        borderColor: ctx => {
                            const yVal = ctx.p1.parsed.y;
                            return (minimum > 0 && yVal < minimum) ? '#e53e3e' : color;
                        }
                    }
                });
                
                // Legend
                legendHtml += `<div class="history-legend-item">
                    <div class="history-legend-color" style="background:${color}"></div>
                    <span>${partNumber}</span>
                    ${minimum > 0 ? `<span class="history-legend-below">(min: ${formatNumber(minimum)})</span>` : ''}
                </div>`;
                
                // Stats card
                statsHtml += `<div class="history-part-stat-card">
                    <div class="history-part-stat-header">
                        <div class="history-part-stat-color" style="background:${color}"></div>
                        <div class="history-part-stat-name">${partNumber}</div>
                    </div>
                    <div class="history-part-stat-values">
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value ${belowMin ? 'below-min' : ''}">${formatNumber(current)}</div>
                            <div class="history-part-stat-label">${t('inv.current')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value" style="color: ${minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)'}">${formatNumber(minimum)}</div>
                            <div class="history-part-stat-label">${t('inv.minimum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(max)}</div>
                            <div class="history-part-stat-label">${t('inv.maximum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(avg)}</div>
                            <div class="history-part-stat-label">${t('inv.average')}</div>
                        </div>
                    </div>
                </div>`;
            });
            
            legend.innerHTML = legendHtml;
            statsContainer.innerHTML = statsHtml;
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryPageChart').getContext('2d');
            charts.inventoryHistoryPage = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatNumber(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function updateHistoryPageChart() {
            const startVal = document.getElementById('historyPageStartDate').value;
            const endVal = document.getElementById('historyPageEndDate').value;
            
            historyPageDateRange.start = startVal ? new Date(startVal) : null;
            historyPageDateRange.end = endVal ? new Date(endVal) : null;
            
            renderHistoryPageChart();
        }
        
        function applyHistoryPagePreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7': start = new Date(now); start.setDate(start.getDate() - 7); break;
                case 'last30': start = new Date(now); start.setDate(start.getDate() - 30); break;
                case 'last90': start = new Date(now); start.setDate(start.getDate() - 90); break;
                case 'all': default: start = null; break;
            }
            
            historyPageDateRange.start = start;
            historyPageDateRange.end = null;
            
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyPageStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyPageStartDate').value = '';
            }
            document.getElementById('historyPageEndDate').value = '';
            
            renderHistoryPageChart();
        }

        // ============================================================
        // SALES OVERVIEW PAGE (Enhanced)
        // ============================================================
        function toggleSalesCategory(cat) {
            salesFilters.categories[cat] = !salesFilters.categories[cat];
            if (!salesFilters.categories.rolltech && !salesFilters.categories.molding && !salesFilters.categories.snappad) { salesFilters.categories[cat] = true; return; }
            document.getElementById('salesBtnRollTech').classList.toggle('active', salesFilters.categories.rolltech);
            document.getElementById('salesBtnMolding').classList.toggle('active', salesFilters.categories.molding);
            document.getElementById('salesBtnSnapPad').classList.toggle('active', salesFilters.categories.snappad);
            updateSalesOverview();
        }
        
        function applySalesDateFilter() {
            const fromInput = document.getElementById('salesFromDate').value;
            const toInput = document.getElementById('salesToDate').value;
            salesFilters.fromDate = fromInput ? new Date(fromInput) : null;
            salesFilters.toDate = toInput ? new Date(toInput) : null;
            updateSalesOverview();
        }
        
        function resetSalesDateFilter() {
            document.getElementById('salesFromDate').value = '';
            document.getElementById('salesToDate').value = '';
            salesFilters.fromDate = null;
            salesFilters.toDate = null;
            updateSalesOverview();
        }
        
        function toggleSalesHeatMap() {
            salesHeatMapEnabled = !salesHeatMapEnabled;
            document.getElementById('salesHeatMapBtn').classList.toggle('active', salesHeatMapEnabled);
            updateSalesOverview();
        }
        
        function toggleSalesAutoRefresh() {
            if (salesAutoRefreshInterval) {
                clearInterval(salesAutoRefreshInterval);
                salesAutoRefreshInterval = null;
                document.getElementById('salesAutoRefreshBtn').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span>Auto-refresh: Off</span>';
            } else {
                salesAutoRefreshInterval = setInterval(() => { loadDashboard(); }, 300000); // 5 minutes
                document.getElementById('salesAutoRefreshBtn').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span class="pulse"></span><span>Auto-refresh: On (5 min)</span>';
            }
        }
        
        function getFilteredSalesData() {
            return allData.filter(r => {
                if (isCancelledOrClosed(r)) return false;
                if (!salesFilters.categories[getCategory(r)]) return false;
                if (salesFilters.fromDate || salesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (salesFilters.fromDate && rowDate < salesFilters.fromDate) return false;
                    if (salesFilters.toDate && rowDate > salesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesOverview() {
            const data = getFilteredSalesData();
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            
            data.forEach(r => {
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    totalPL += pl;
                    if (getStatus(r) === 'shipped') { shippedPL += pl; shippedCount++; }
                    else { forecastPL += pl; forecastCount++; }
                } else {
                    if (getStatus(r) === 'shipped') shippedCount++; else forecastCount++;
                }
            });
            
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('salesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('salesStatOrderCount').textContent = `${data.length} ${t('ui.orders')}`;
            document.getElementById('salesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('salesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('salesStatShippedPL').textContent = formatCurrency(shippedPL);
            document.getElementById('salesStatShippedPL').className = `value ${shippedPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatShippedCount').textContent = `${shippedCount} ${t('stats.shipped')}`;
            document.getElementById('salesStatForecastPL').textContent = formatCurrency(forecastPL);
            document.getElementById('salesStatForecastPL').className = `value ${forecastPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatForecastCount').textContent = `${forecastCount} ${t('stats.pending')}`;
            
            // Render the Monthly P/L Trend chart
            renderSalesTrendChart(data);
        }
        
        function renderSalesLossesChart(data) {
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { pl: 0 };
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            // Get top 5 losses and top 5 gains
            const sorted = Object.entries(partStats).sort((a,b) => a[1].pl - b[1].pl);
            const topLosses = sorted.slice(0, 5).filter(([_,v]) => v.pl < 0);
            const topGains = sorted.slice(-5).reverse().filter(([_,v]) => v.pl > 0);
            const combined = [...topLosses, ...topGains.reverse()];
            
            if (charts.salesLosses) charts.salesLosses.destroy();
            charts.salesLosses = new Chart(document.getElementById('salesLossesChart'), {
                type: 'bar',
                data: {
                    labels: combined.map(s => s[0]),
                    datasets: [{
                        data: combined.map(s => s[1].pl),
                        backgroundColor: combined.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)')
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function renderSalesCustomerPieChart(data) {
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { pl: 0 };
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(custStats).filter(([_,v]) => v.pl > 0).sort((a,b) => b[1].pl - a[1].pl).slice(0, 8);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#718096'];
            
            if (charts.salesCustomerPie) charts.salesCustomerPie.destroy();
            charts.salesCustomerPie = new Chart(document.getElementById('salesCustomerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0].substring(0, 20)),
                    datasets: [{ data: sorted.map(s => s[1].pl), backgroundColor: colors }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
        }
        
        function renderSalesTrendChart(data) {
            const monthStats = {};
            data.forEach(r => {
                const d = getAttributionDate(r);
                if (!d) return;
                const month = getMonthKey(d);
                if (!monthStats[month]) monthStats[month] = { shipped: 0, forecast: 0, revenue: 0 };
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (getStatus(r) === 'shipped') monthStats[month].shipped += pl;
                    else monthStats[month].forecast += pl;
                }
            });
            
            const sorted = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0])).slice(-24);
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: sorted.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped P/L', data: sorted.map(s => s[1].shipped), borderColor: '#38a169', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                        { label: 'Forecast P/L', data: sorted.map(s => s[1].forecast), borderColor: '#d69e2e', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5,5], yAxisID: 'y' },
                        { label: 'Revenue', data: sorted.map(s => s[1].revenue), borderColor: '#3182ce', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { type: 'linear', position: 'left', ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y1: { type: 'linear', position: 'right', ticks: { callback: v => formatCurrency(v), color: '#3182ce' }, grid: { drawOnChartArea: false } },
                        x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function exportSalesCSV() {
            const data = getFilteredSalesData();
            const csv = data.map(r => [getVal(r,'PART'),getVal(r,'CUSTOMER'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].join(',')).join('\n');
            downloadCSV('Part,Customer,Qty,Revenue,P/L\n' + csv, `sales_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SALES BY PARTS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function togglePartsCategory(cat) {
            partsFilters.categories[cat] = !partsFilters.categories[cat];
            if (!partsFilters.categories.rolltech && !partsFilters.categories.molding && !partsFilters.categories.snappad) { partsFilters.categories[cat] = true; return; }
            document.getElementById('partsBtnRollTech').classList.toggle('active', partsFilters.categories.rolltech);
            document.getElementById('partsBtnMolding').classList.toggle('active', partsFilters.categories.molding);
            document.getElementById('partsBtnSnapPad').classList.toggle('active', partsFilters.categories.snappad);
            updateSalesPartsPage();
        }
        
        function applyPartsDateFilter() {
            partsFilters.fromDate = document.getElementById('partsFromDate').value ? new Date(document.getElementById('partsFromDate').value) : null;
            partsFilters.toDate = document.getElementById('partsToDate').value ? new Date(document.getElementById('partsToDate').value) : null;
            updateSalesPartsPage();
        }
        
        function resetPartsDateFilter() {
            document.getElementById('partsFromDate').value = '';
            document.getElementById('partsToDate').value = '';
            partsFilters.fromDate = null;
            partsFilters.toDate = null;
            updateSalesPartsPage();
        }
        
        function togglePartsWatchlistFilter() {
            partsFilters.watchlistOnly = !partsFilters.watchlistOnly;
            document.getElementById('partsWatchlistBtn').classList.toggle('active', partsFilters.watchlistOnly);
            updateSalesPartsPage();
        }
        
        function getFilteredPartsData() {
            return allData.filter(r => {
                if (isCancelledOrClosed(r)) return false;
                if (!partsFilters.categories[getCategory(r)]) return false;
                if (partsFilters.fromDate || partsFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (partsFilters.fromDate && rowDate < partsFilters.fromDate) return false;
                    if (partsFilters.toDate && rowDate > partsFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesPartsPage() {
            const data = getFilteredPartsData();
            const partStats = {};
            
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            let partsArray = Object.entries(partStats).map(([part, stats]) => ({ part, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            // Filter by watchlist if enabled
            if (partsFilters.watchlistOnly) partsArray = partsArray.filter(p => isInWatchlist('part', p.part));
            
            // Search filter
            const search = (document.getElementById('partsSearch')?.value || '').toLowerCase();
            if (search) partsArray = partsArray.filter(p => p.part.toLowerCase().includes(search));
            
            // Column filters
            partsArray = partsArray.filter(p => {
                if (!passesColumnFilter('parts', 'part', p.part)) return false;
                if (!passesColumnFilter('parts', 'orders', String(p.orders))) return false;
                if (!passesColumnFilter('parts', 'qty', String(p.qty))) return false;
                if (!passesColumnFilter('parts', 'revenue', formatCurrency(p.revenue))) return false;
                if (!passesColumnFilter('parts', 'pl', p.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (p.margin < 0) marginCat = 'Negative';
                else if (p.margin < 10) marginCat = 'Low (0-10%)';
                else if (p.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('parts', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort - handle string vs numeric fields
            partsArray.sort((a, b) => {
                if (partsSort.field === 'part') {
                    return partsSort.asc ? a.part.localeCompare(b.part) : b.part.localeCompare(a.part);
                }
                return partsSort.asc ? a[partsSort.field] - b[partsSort.field] : b[partsSort.field] - a[partsSort.field];
            });
            
            // Render chart
            renderPartsBarChart(partsArray);
            
            // Render table
            document.getElementById('partsTableCount').textContent = `${partsArray.length} ${t('ui.parts')}`;
            document.getElementById('partsTableHeader').innerHTML = `
                <th>â˜…</th>
                ${createFilterHeader('parts', 'part', 'Part #')}
                ${createFilterHeader('parts', 'orders', 'Orders')}
                ${createFilterHeader('parts', 'qty', 'Qty')}
                ${createFilterHeader('parts', 'revenue', 'Revenue')}
                ${createFilterHeader('parts', 'pl', 'P/L')}
                ${createFilterHeader('parts', 'margin', 'Margin')}
            `;
            
            document.getElementById('partsTableBody').innerHTML = partsArray.map(p => `
                <tr class="clickable" onclick="showPartsCustomerDrilldown('${p.part.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('part', p.part) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistPart('${p.part.replace(/'/g, "\\'")}')">â˜…</span></td>
                    <td><strong>${p.part}</strong></td>
                    <td>${formatNumber(p.orders)}</td>
                    <td>${formatNumber(p.qty)}</td>
                    <td>${formatCurrency(p.revenue)}</td>
                    <td class="${p.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(p.pl)}</td>
                    <td class="${p.margin >= 0 ? 'positive' : 'negative'}">${p.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function renderPartsBarChart(partsArray) {
            // Sort all parts from lowest (losses) to highest (gains) P/L
            const sortedParts = [...partsArray].sort((a,b) => a.pl - b.pl);
            if (charts.partsBar) charts.partsBar.destroy();
            charts.partsBar = new Chart(document.getElementById('partsBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedParts.map(p => p.part),
                    datasets: [{ data: sortedParts.map(p => p.pl), backgroundColor: sortedParts.map(p => p.pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)') }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 }, maxRotation: 90 }, grid: { display: false } } } }
            });
        }
        
        function sortPartsTable(field) {
            if (partsSort.field === field) partsSort.asc = !partsSort.asc;
            else { partsSort.field = field; partsSort.asc = field === 'part'; }
            updateSalesPartsPage();
        }
        
        function filterPartsTable() { updateSalesPartsPage(); }
        function exportPartsCSV() { downloadCSV('Part,Orders,Qty,Revenue,P/L,Margin', 'parts_pl.csv'); }
        
        // Parts Drilldown Functions
        let partsCustomerDrilldownData = []; // Store data for re-sorting
        
        function showPartsCustomerDrilldown(part) {
            currentDrilldownPart = part;
            partsCustomerDrilldownSort = { field: 'pl', asc: false }; // Reset sort
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part);
            
            const customerStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!customerStats[c]) customerStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                customerStats[c].orders++;
                customerStats[c].qty += parseNumber(getVal(r, 'QTY'));
                customerStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) customerStats[c].pl += getPLValue(r);
            });
            
            // Convert to array with computed fields
            partsCustomerDrilldownData = Object.entries(customerStats).map(([customer, stats]) => ({
                customer,
                qty: stats.qty,
                unitPrice: stats.qty > 0 ? stats.revenue / stats.qty : 0,
                margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0,
                pl: stats.pl,
                revenue: stats.revenue
            }));
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsCustomerDrilldownPart').textContent = part;
            document.getElementById('partsCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Customers</div><div class="value">${partsCustomerDrilldownData.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            renderPartsCustomerDrilldownTable();
            
            document.getElementById('partsCustomerDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            document.getElementById('partsCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderPartsCustomerDrilldownTable() {
            // Render sortable header
            document.getElementById('partsCustomerDrilldownHeader').innerHTML = `
                <th onclick="sortPartsCustomerDrilldown('customer')">Customer <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('qty')">Qty <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('unitPrice')">Unit Price <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Contribution <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Margin <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('pl')">P/L <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('revenue')">Revenue <span class="sort-indicator">â†•</span></th>
            `;
            
            // Sort data
            const sorted = [...partsCustomerDrilldownData].sort((a, b) => {
                if (partsCustomerDrilldownSort.field === 'customer') {
                    return partsCustomerDrilldownSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return partsCustomerDrilldownSort.asc ? a[partsCustomerDrilldownSort.field] - b[partsCustomerDrilldownSort.field] : b[partsCustomerDrilldownSort.field] - a[partsCustomerDrilldownSort.field];
            });
            
            document.getElementById('partsCustomerDrilldownBody').innerHTML = sorted.map(row => {
                return `<tr class="clickable" onclick="showPartsOrdersDrilldown('${currentDrilldownPart.replace(/'/g, "\\'")}', '${row.customer.replace(/'/g, "\\'")}')">
                    <td><strong>${row.customer}</strong></td>
                    <td>${formatNumber(row.qty)}</td>
                    <td>${formatCurrency(row.unitPrice)}</td>
                    <td>${getContributionBadge(row.margin)}</td>
                    <td class="${row.margin >= 0 ? 'positive' : 'negative'}">${row.margin.toFixed(1)}%</td>
                    <td class="${row.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.pl)}</td>
                    <td>${formatCurrency(row.revenue)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortPartsCustomerDrilldown(field) {
            if (partsCustomerDrilldownSort.field === field) {
                partsCustomerDrilldownSort.asc = !partsCustomerDrilldownSort.asc;
            } else {
                partsCustomerDrilldownSort.field = field;
                partsCustomerDrilldownSort.asc = field === 'customer'; // Strings default asc, numbers default desc
            }
            renderPartsCustomerDrilldownTable();
        }
        
        function showPartsOrdersDrilldown(part, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsOrdersBreadcrumbPart').textContent = part;
            document.getElementById('partsOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('partsOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.partsOrdersPrice) charts.partsOrdersPrice.destroy();
            const priceChartEl = document.getElementById('partsOrdersPriceChart');
            console.log('Price History Debug v7.5:', { dataPoints: priceData.length, prices: priceData.slice(0,5).map(d => d.price) });
            if (priceData.length > 1 && priceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                // If all prices are same or very close, create artificial range
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                console.log('Y-Axis Debug v7.5:', { minPrice, maxPrice, allSame, yAxisMin, yAxisMax });
                
                charts.partsOrdersPrice = new Chart(priceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Orders table
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('partsOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('partsOrdersDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePartsCustomerDrilldown() {
            document.getElementById('partsCustomerDrilldown').classList.remove('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            currentDrilldownPart = null;
        }
        
        function closePartsOrdersDrilldown() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function backToPartsCustomers() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function closeAllPartsDrilldowns() { closePartsCustomerDrilldown(); }

        // ============================================================
        // SALES BY CUSTOMERS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleCustomersCategory(cat) {
            customersFilters.categories[cat] = !customersFilters.categories[cat];
            if (!customersFilters.categories.rolltech && !customersFilters.categories.molding && !customersFilters.categories.snappad) { customersFilters.categories[cat] = true; return; }
            document.getElementById('customersBtnRollTech').classList.toggle('active', customersFilters.categories.rolltech);
            document.getElementById('customersBtnMolding').classList.toggle('active', customersFilters.categories.molding);
            document.getElementById('customersBtnSnapPad').classList.toggle('active', customersFilters.categories.snappad);
            updateSalesCustomersPage();
        }
        
        function applyCustomersDateFilter() {
            customersFilters.fromDate = document.getElementById('customersFromDate').value ? new Date(document.getElementById('customersFromDate').value) : null;
            customersFilters.toDate = document.getElementById('customersToDate').value ? new Date(document.getElementById('customersToDate').value) : null;
            updateSalesCustomersPage();
        }
        
        function resetCustomersDateFilter() {
            document.getElementById('customersFromDate').value = '';
            document.getElementById('customersToDate').value = '';
            customersFilters.fromDate = null;
            customersFilters.toDate = null;
            updateSalesCustomersPage();
        }
        
        function toggleCustomersWatchlistFilter() {
            customersFilters.watchlistOnly = !customersFilters.watchlistOnly;
            document.getElementById('customersWatchlistBtn').classList.toggle('active', customersFilters.watchlistOnly);
            updateSalesCustomersPage();
        }
        
        function getFilteredCustomersData() {
            return allData.filter(r => {
                if (isCancelledOrClosed(r)) return false;
                if (!customersFilters.categories[getCategory(r)]) return false;
                if (customersFilters.fromDate || customersFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (customersFilters.fromDate && rowDate < customersFilters.fromDate) return false;
                    if (customersFilters.toDate && rowDate > customersFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesCustomersPage() {
            const data = getFilteredCustomersData();
            const custStats = {};
            
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            let custArray = Object.entries(custStats).map(([customer, stats]) => ({ customer, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            if (customersFilters.watchlistOnly) custArray = custArray.filter(c => isInWatchlist('customer', c.customer));
            
            const search = (document.getElementById('customersSearch')?.value || '').toLowerCase();
            if (search) custArray = custArray.filter(c => c.customer.toLowerCase().includes(search));
            
            // Column filters
            custArray = custArray.filter(c => {
                if (!passesColumnFilter('customers', 'customer', c.customer)) return false;
                if (!passesColumnFilter('customers', 'orders', String(c.orders))) return false;
                if (!passesColumnFilter('customers', 'qty', String(c.qty))) return false;
                if (!passesColumnFilter('customers', 'revenue', formatCurrency(c.revenue))) return false;
                if (!passesColumnFilter('customers', 'pl', c.pl >= 0 ? 'Positive' : 'Negative')) return false;
                let marginCat;
                if (c.margin < 0) marginCat = 'Negative';
                else if (c.margin < 10) marginCat = 'Low (0-10%)';
                else if (c.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('customers', 'margin', marginCat)) return false;
                return true;
            });
            
            custArray.sort((a, b) => {
                if (customersSort.field === 'customer') {
                    return customersSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return customersSort.asc ? a[customersSort.field] - b[customersSort.field] : b[customersSort.field] - a[customersSort.field];
            });
            
            // Chart
            const top10 = [...custArray].sort((a,b) => b.pl - a.pl).slice(0, 10);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#e53e3e', '#718096', '#4a5568'];
            if (charts.customers) charts.customers.destroy();
            charts.customers = new Chart(document.getElementById('customersChart'), {
                type: 'doughnut',
                data: { labels: top10.map(c => c.customer.substring(0, 20)), datasets: [{ data: top10.map(c => Math.abs(c.pl)), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
            
            // Table
            document.getElementById('customersTableCount').textContent = `${custArray.length} ${t('ui.customers')}`;
            document.getElementById('customersTableHeader').innerHTML = `
                <th>â˜…</th>
                ${createFilterHeader('customers', 'customer', 'Customer')}
                ${createFilterHeader('customers', 'orders', 'Orders')}
                ${createFilterHeader('customers', 'qty', 'Qty')}
                ${createFilterHeader('customers', 'revenue', 'Revenue')}
                ${createFilterHeader('customers', 'pl', 'P/L')}
                ${createFilterHeader('customers', 'margin', 'Margin')}
            `;
            
            document.getElementById('customersTableBody').innerHTML = custArray.map(c => `
                <tr class="clickable" onclick="showCustomersProductDrilldown('${c.customer.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('customer', c.customer) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistCustomer('${c.customer.replace(/'/g, "\\'")}')">â˜…</span></td>
                    <td><strong>${c.customer}</strong></td>
                    <td>${formatNumber(c.orders)}</td>
                    <td>${formatNumber(c.qty)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(c.pl)}</td>
                    <td class="${c.margin >= 0 ? 'positive' : 'negative'}">${c.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
            
            updateClearAllButton('customers');
        }
        
        function sortCustomersTable(field) {
            if (customersSort.field === field) customersSort.asc = !customersSort.asc;
            else { customersSort.field = field; customersSort.asc = field === 'customer'; }
            updateSalesCustomersPage();
        }
        
        function filterCustomersTable() { updateSalesCustomersPage(); }
        function exportCustomersCSV() { downloadCSV('Customer,Orders,Qty,Revenue,P/L,Margin', 'customers_pl.csv'); }
        
        // Customers Drilldown Functions
        function showCustomersProductDrilldown(customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer);
            
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersProductDrilldownCustomer').textContent = customer;
            document.getElementById('customersProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Products</div><div class="value">${Object.keys(partStats).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(partStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('customersProductDrilldownBody').innerHTML = sorted.map(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                const avgPrice = stats.qty > 0 ? stats.revenue / stats.qty : 0;
                return `<tr class="clickable" onclick="showCustomersOrdersDrilldown('${currentDrilldownCustomer.replace(/'/g, "\\'")}', '${part.replace(/'/g, "\\'")}')">
                    <td><strong>${part}</strong></td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(avgPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersProductDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            document.getElementById('customersProductDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showCustomersOrdersDrilldown(customer, part) {
            currentDrilldownPart = part;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer && getVal(r, 'PART') === part);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('customersOrdersBreadcrumbPart').textContent = part;
            document.getElementById('customersOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart for customer orders
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.customersOrdersPrice) charts.customersOrdersPrice.destroy();
            const custPriceChartEl = document.getElementById('customersOrdersPriceChart');
            if (priceData.length > 1 && custPriceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                
                charts.customersOrdersPrice = new Chart(custPriceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('customersOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersOrdersDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeCustomersProductDrilldown() {
            document.getElementById('customersProductDrilldown').classList.remove('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            currentDrilldownCustomer = null;
        }
        
        function closeCustomersOrdersDrilldown() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function backToCustomersProducts() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function closeAllCustomersDrilldowns() { closeCustomersProductDrilldown(); }

        // ============================================================
        // SALES BY DATE PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleDatesCategory(cat) {
            datesFilters.categories[cat] = !datesFilters.categories[cat];
            if (!datesFilters.categories.rolltech && !datesFilters.categories.molding && !datesFilters.categories.snappad) { datesFilters.categories[cat] = true; return; }
            document.getElementById('datesBtnRollTech').classList.toggle('active', datesFilters.categories.rolltech);
            document.getElementById('datesBtnMolding').classList.toggle('active', datesFilters.categories.molding);
            document.getElementById('datesBtnSnapPad').classList.toggle('active', datesFilters.categories.snappad);
            updateSalesDatesPage();
        }
        
        function applyDatesDateFilter() {
            datesFilters.fromDate = document.getElementById('datesFromDate').value ? new Date(document.getElementById('datesFromDate').value) : null;
            datesFilters.toDate = document.getElementById('datesToDate').value ? new Date(document.getElementById('datesToDate').value) : null;
            updateSalesDatesPage();
        }
        
        function resetDatesDateFilter() {
            document.getElementById('datesFromDate').value = '';
            document.getElementById('datesToDate').value = '';
            datesFilters.fromDate = null;
            datesFilters.toDate = null;
            updateSalesDatesPage();
        }
        
        function getFilteredDatesData() {
            return allData.filter(r => {
                if (isCancelledOrClosed(r)) return false;
                if (!datesFilters.categories[getCategory(r)]) return false;
                if (datesFilters.fromDate || datesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (datesFilters.fromDate && rowDate < datesFilters.fromDate) return false;
                    if (datesFilters.toDate && rowDate > datesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesDatesPage() {
            const data = getFilteredDatesData();
            const monthStats = {};
            let totalOrders = 0, totalUnits = 0, totalRevenue = 0, totalPL = 0;
            
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                const status = getStatus(r);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, shippedPL: 0, forecastPL: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (status === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (status === 'shipped') monthStats[month].shippedPL += pl;
                    else monthStats[month].forecastPL += pl;
                }
                totalOrders++;
                totalUnits += parseNumber(getVal(r, 'QTY'));
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) totalPL += getPLValue(r);
            });
            
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100) : 0;
            const monthCount = Object.keys(monthStats).length;
            
            document.getElementById('datesStatOrders').textContent = formatNumber(totalOrders);
            document.getElementById('datesStatUnits').textContent = `${formatNumber(totalUnits)} ${t('ui.units')}`;
            document.getElementById('datesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('datesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('datesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMargin').textContent = `${t('stats.margin')}: ${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').className = `value ${margin >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMonths').textContent = `${monthCount} ${t('ui.months')}`;
            
            // Convert to array for filtering and sorting
            let monthsArray = Object.entries(monthStats).map(([month, stats]) => {
                const totalPL = stats.shippedPL + stats.forecastPL;
                const rowMargin = stats.revenue > 0 ? (totalPL / stats.revenue * 100) : 0;
                return {
                    month,
                    monthLabel: formatMonthLabel(month),
                    statusText: `${stats.shipped}/${stats.orders} Shipped`,
                    orders: stats.orders,
                    shipped: stats.shipped,
                    qty: stats.qty,
                    revenue: stats.revenue,
                    pl: totalPL,
                    margin: rowMargin,
                    shippedPL: stats.shippedPL,
                    forecastPL: stats.forecastPL
                };
            });
            
            // Apply column filters
            monthsArray = monthsArray.filter(m => {
                if (!passesColumnFilter('dates', 'month', m.monthLabel)) return false;
                if (!passesColumnFilter('dates', 'status', m.statusText)) return false;
                if (!passesColumnFilter('dates', 'orders', String(m.orders))) return false;
                if (!passesColumnFilter('dates', 'qty', String(m.qty))) return false;
                if (!passesColumnFilter('dates', 'revenue', formatCurrency(m.revenue))) return false;
                if (!passesColumnFilter('dates', 'pl', m.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (m.margin < 0) marginCat = 'Negative';
                else if (m.margin < 10) marginCat = 'Low (0-10%)';
                else if (m.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('dates', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort
            monthsArray.sort((a, b) => {
                const field = datesSort.field;
                if (field === 'month') {
                    return datesSort.asc ? a.month.localeCompare(b.month) : b.month.localeCompare(a.month);
                }
                return datesSort.asc ? a[field] - b[field] : b[field] - a[field];
            });
            
            // Use full array for chart (before filtering affects it)
            const chartMonths = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0]));
            
            // Stacked bar chart with shipped profit/loss and forecast profit/loss
            if (charts.datesBar) charts.datesBar.destroy();
            charts.datesBar = new Chart(document.getElementById('datesBarChart'), {
                type: 'bar',
                data: {
                    labels: chartMonths.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped Profit', data: chartMonths.map(s => Math.max(0, s[1].shippedPL)), backgroundColor: 'rgba(56,161,105,0.8)', stack: 'shipped', yAxisID: 'y' },
                        { label: 'Shipped Loss', data: chartMonths.map(s => Math.min(0, s[1].shippedPL)), backgroundColor: 'rgba(229,62,62,0.8)', stack: 'shipped', yAxisID: 'y' },
                        { label: 'Forecast Profit', data: chartMonths.map(s => Math.max(0, s[1].forecastPL)), backgroundColor: 'rgba(56,161,105,0.4)', stack: 'forecast', yAxisID: 'y' },
                        { label: 'Forecast Loss', data: chartMonths.map(s => Math.min(0, s[1].forecastPL)), backgroundColor: 'rgba(229,62,62,0.4)', stack: 'forecast', yAxisID: 'y' },
                        { label: 'Revenue', type: 'line', data: chartMonths.map(s => s[1].revenue), borderColor: 'rgba(66,153,225,1)', backgroundColor: 'rgba(66,153,225,0.1)', borderWidth: 2.5, pointBackgroundColor: 'rgba(66,153,225,1)', pointRadius: 4, pointHoverRadius: 6, fill: false, tension: 0.3, yAxisID: 'yRevenue', order: -1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { stacked: true, position: 'left', ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' }, title: { display: true, text: 'P/L', color: '#a0aec0' } },
                        yRevenue: { position: 'right', ticks: { callback: v => formatCurrency(v), color: 'rgba(66,153,225,0.8)' }, grid: { display: false }, title: { display: true, text: 'Revenue', color: 'rgba(66,153,225,0.8)' } },
                        x: { stacked: true, ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
            
            // Render filterable table header
            document.getElementById('datesTableHeader').innerHTML = 
                createFilterHeader('dates', 'month', 'Month') +
                createFilterHeader('dates', 'status', 'Status') +
                createFilterHeader('dates', 'orders', 'Orders') +
                createFilterHeader('dates', 'qty', 'Qty') +
                createFilterHeader('dates', 'revenue', 'Revenue') +
                createFilterHeader('dates', 'pl', 'P/L') +
                createFilterHeader('dates', 'margin', 'Margin');
            
            // Table with X/Y Shipped format
            document.getElementById('datesTableCount').textContent = `${monthsArray.length} ${t('ui.months')}`;
            document.getElementById('datesTableBody').innerHTML = monthsArray.map(m => {
                return `<tr class="clickable" onclick="showDatesCustomerDrilldown('${m.month}')">
                    <td><strong>${m.monthLabel}</strong></td>
                    <td>${m.statusText}</td>
                    <td>${formatNumber(m.orders)}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatCurrency(m.revenue)}</td>
                    <td class="${m.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.pl)}</td>
                    <td class="${m.margin >= 0 ? 'positive' : 'negative'}">${m.margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            updateClearAllButton('dates');
        }
        
        function sortDatesTable(field) {
            if (datesSort.field === field) datesSort.asc = !datesSort.asc;
            else { datesSort.field = field; datesSort.asc = field === 'month'; }
            updateSalesDatesPage();
        }
        
        function exportDatesCSV() {
            // Get filtered data and aggregate by month (same as updateSalesDatesPage)
            const data = getFilteredDatesData();
            const monthStats = {};
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                const status = getStatus(r);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, shippedPL: 0, forecastPL: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (status === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (status === 'shipped') monthStats[month].shippedPL += pl;
                    else monthStats[month].forecastPL += pl;
                }
            });
            
            // Convert to array and apply filters/sort (same as render)
            let monthsArray = Object.entries(monthStats).map(([month, stats]) => {
                const totalPL = stats.shippedPL + stats.forecastPL;
                const rowMargin = stats.revenue > 0 ? (totalPL / stats.revenue * 100) : 0;
                return { month, monthLabel: formatMonthLabel(month), statusText: `${stats.shipped}/${stats.orders} Shipped`, orders: stats.orders, qty: stats.qty, revenue: stats.revenue, pl: totalPL, margin: rowMargin };
            });
            
            // Apply column filters
            monthsArray = monthsArray.filter(m => {
                if (!passesColumnFilter('dates', 'month', m.monthLabel)) return false;
                if (!passesColumnFilter('dates', 'status', m.statusText)) return false;
                if (!passesColumnFilter('dates', 'orders', String(m.orders))) return false;
                if (!passesColumnFilter('dates', 'qty', String(m.qty))) return false;
                if (!passesColumnFilter('dates', 'revenue', formatCurrency(m.revenue))) return false;
                if (!passesColumnFilter('dates', 'pl', m.pl >= 0 ? 'Positive' : 'Negative')) return false;
                let marginCat = m.margin < 0 ? 'Negative' : m.margin < 10 ? 'Low (0-10%)' : m.margin < 20 ? 'Medium (10-20%)' : 'High (>20%)';
                if (!passesColumnFilter('dates', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort
            monthsArray.sort((a, b) => {
                const field = datesSort.field;
                if (field === 'month') return datesSort.asc ? a.month.localeCompare(b.month) : b.month.localeCompare(a.month);
                return datesSort.asc ? a[field] - b[field] : b[field] - a[field];
            });
            
            // Build CSV (respecting hidden columns)
            const allCols = [
                { key: 'month', header: 'Month', getValue: m => m.monthLabel },
                { key: 'status', header: 'Status', getValue: m => m.statusText },
                { key: 'orders', header: 'Orders', getValue: m => m.orders },
                { key: 'qty', header: 'Quantity', getValue: m => m.qty },
                { key: 'revenue', header: 'Revenue', getValue: m => m.revenue },
                { key: 'pl', header: 'P/L', getValue: m => m.pl },
                { key: 'margin', header: 'Margin %', getValue: m => m.margin.toFixed(1) + '%' }
            ];
            const visibleCols = allCols.filter(c => !isColumnHidden('dates', c.key));
            const headers = visibleCols.map(c => c.header);
            const rows = monthsArray.map(m => visibleCols.map(c => '"' + (c.getValue(m) || '').toString().replace(/"/g, '""') + '"').join(','));
            downloadCSV([headers.join(','), ...rows].join('\n'), 'dates_pl.csv');
        }
        
        // Dates Drilldown Functions
        function showDatesCustomerDrilldown(month) {
            currentDrilldownMonth = month;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const monthLabel = formatMonthLabel(month);
            
            // --- Monthly Orders (new, shows first) ---
            datesMonthlyOrdersData = data;
            document.getElementById('datesMonthlyOrdersMonth').textContent = monthLabel;
            document.getElementById('datesMonthlyOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            renderDatesMonthlyOrdersTable();
            document.getElementById('datesMonthlyOrdersDrilldown').classList.add('active');

            // --- Customer Breakdown (existing, shows below) ---
            datesCustomerData = data;
            document.getElementById('datesCustomerDrilldownMonth').textContent = monthLabel;
            document.getElementById('datesCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            renderDatesCustomerTable();
            
            document.getElementById('datesCustomerDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            document.getElementById('datesMonthlyOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDatesOrdersDrilldown(month, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesOrdersBreadcrumbMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('datesOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('datesOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${dateStr}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesOrdersDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeDatesCustomerDrilldown() {
            document.getElementById('datesCustomerDrilldown').classList.remove('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            document.getElementById('datesMonthlyOrdersDrilldown').classList.remove('active');
            currentDrilldownMonth = null;
        }
        
        function closeDatesOrdersDrilldown() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function backToDatesCustomers() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function closeAllDatesDrilldowns() { closeDatesCustomerDrilldown(); closeDatesMonthlyOrdersDrilldown(); }
        function closeDatesMonthlyOrdersDrilldown() { document.getElementById('datesMonthlyOrdersDrilldown').classList.remove('active'); }

        // ============================================================
        // DATES MONTHLY ORDERS DRILLDOWN â€” state & helpers
        // ============================================================
        let datesMonthlyOrdersSort = { field: 'requestedDate', asc: false };
        let datesMonthlyOrdersData = []; // cached filtered data for current month
        let datesCustomerSort = { field: 'revenue', asc: false };
        let datesCustomerData = []; // cached for customer breakdown

        function sortDatesMonthlyOrdersTable(columnKey) {
            if (datesMonthlyOrdersSort.field === columnKey) datesMonthlyOrdersSort.asc = !datesMonthlyOrdersSort.asc;
            else { datesMonthlyOrdersSort.field = columnKey; datesMonthlyOrdersSort.asc = false; }
            renderDatesMonthlyOrdersTable();
        }
        function sortDatesCustomerTable(columnKey) {
            if (datesCustomerSort.field === columnKey) datesCustomerSort.asc = !datesCustomerSort.asc;
            else { datesCustomerSort.field = columnKey; datesCustomerSort.asc = false; }
            renderDatesCustomerTable();
        }

        function getDatesMonthlyOrderRow(r) {
            const unitPrice = getUnitPrice(r);
            const profitPart = getProfitPerPart(r);
            const pl = hasMissingCostData(r) ? 0 : getPLValue(r);
            const revenue = parseNumber(r[COL.REVENUE]);
            const qty = parseNumber(getVal(r, 'QTY'));
            const variableCost = parseNumber(r[COL.VARIABLE_COST]);
            const totalCost = parseNumber(r[COL.TOTAL_COST]);
            const salesTarget = unitPrice > 0 ? unitPrice * 1.2 : 0;
            const margin = revenue > 0 ? (pl / revenue * 100) : 0;
            const shippingCost = parseNumber(r['Shipping Cost'] || r['shippingCost'] || r['Freight Cost'] || 0);
            return {
                category: formatCategoryDisplay(getCategory(r)),
                dateOfRequest: r[COL.REQUEST_DATE] || '-',
                ifNum: getVal(r, 'IF_NUM') || '-',
                fusionStatus: getVal(r, 'FUSION_STATUS') || '-',
                internalStatus: getVal(r, 'STATUS') || '-',
                poNum: getVal(r, 'PO_NUM') || '-',
                customer: getVal(r, 'CUSTOMER') || '-',
                part: getVal(r, 'PART') || '-',
                qty: qty,
                requestedDate: r[COL.REQUESTED_DATE] || '-',
                unitPrice: unitPrice,
                contribution: margin,
                variableCost: variableCost,
                totalCost: totalCost,
                salesTarget: salesTarget,
                profitPerPart: profitPart,
                pl: pl,
                revenue: revenue,
                shippedDate: r[COL.SHIPPED_DATE] || '-',
                shippingCost: shippingCost,
                _raw: r
            };
        }

        function renderDatesMonthlyOrdersTable() {
            initTableFilters('datesMonthlyOrders');
            const isEs = currentLang === 'es';
            const colDefs = tableColumnDefs['datesMonthlyOrders'];

            // Build headers
            const headerRow = document.getElementById('datesMonthlyOrdersHeader');
            headerRow.innerHTML = colDefs.filter(c => !isColumnHidden('datesMonthlyOrders', c.key)).map(c => 
                createFilterHeader('datesMonthlyOrders', c.key, isEs ? c.labelEs : c.labelEn, true)
            ).join('');

            // Filter
            let rows = datesMonthlyOrdersData.map(r => getDatesMonthlyOrderRow(r));
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden('datesMonthlyOrders', c.key)) continue;
                    const val = formatMonthlyOrderCell(c.key, row);
                    if (!passesColumnFilter('datesMonthlyOrders', c.key, val)) return false;
                }
                return true;
            });

            // Sort
            const sf = datesMonthlyOrdersSort.field;
            const asc = datesMonthlyOrdersSort.asc;
            rows.sort((a, b) => {
                let va = a[sf], vb = b[sf];
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                va = String(va || ''); vb = String(vb || '');
                return asc ? va.localeCompare(vb) : vb.localeCompare(va);
            });

            // Render
            const tbody = document.getElementById('datesMonthlyOrdersBody');
            tbody.innerHTML = rows.map(row => {
                const cells = colDefs.filter(c => !isColumnHidden('datesMonthlyOrders', c.key)).map(c => {
                    const val = row[c.key];
                    if (['unitPrice','variableCost','totalCost','salesTarget','profitPerPart','pl','revenue','shippingCost'].includes(c.key)) {
                        const cls = (c.key === 'pl' || c.key === 'profitPerPart') ? (val >= 0 ? 'positive' : 'negative') : '';
                        return `<td class="${cls}">${formatCurrency(val)}</td>`;
                    }
                    if (c.key === 'contribution') {
                        return `<td>${getContributionBadge(val)}</td>`;
                    }
                    if (c.key === 'qty') return `<td>${formatNumber(val)}</td>`;
                    return `<td>${val}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function formatMonthlyOrderCell(key, row) {
            const val = row[key];
            if (['unitPrice','variableCost','totalCost','salesTarget','profitPerPart','pl','revenue','shippingCost'].includes(key)) return formatCurrency(val);
            if (key === 'contribution') return val >= 20 ? 'High (>20%)' : val >= 10 ? 'Medium (10-20%)' : val >= 0 ? 'Low (0-10%)' : 'Negative';
            if (key === 'qty') return String(val);
            return String(val || '-');
        }

        function getUniqueDatesMonthlyOrdersColumnValues(columnKey) {
            const values = new Set();
            datesMonthlyOrdersData.forEach(r => {
                const row = getDatesMonthlyOrderRow(r);
                values.add(formatMonthlyOrderCell(columnKey, row));
            });
            return Array.from(values).sort();
        }

        function renderDatesCustomerTable() {
            initTableFilters('datesCustomer');
            const isEs = currentLang === 'es';
            const colDefs = tableColumnDefs['datesCustomer'];

            // Build headers
            const headerRow = document.getElementById('datesCustomerHeader');
            headerRow.innerHTML = colDefs.filter(c => !isColumnHidden('datesCustomer', c.key)).map(c =>
                createFilterHeader('datesCustomer', c.key, isEs ? c.labelEs : c.labelEn, true)
            ).join('');

            // Aggregate data by customer
            const custStats = {};
            datesCustomerData.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { customer: c, orders: 0, quantity: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].quantity += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });

            let rows = Object.values(custStats).map(s => {
                s.margin = s.revenue > 0 ? (s.pl / s.revenue * 100) : 0;
                return s;
            });

            // Filter
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden('datesCustomer', c.key)) continue;
                    const val = formatDatesCustomerCell(c.key, row);
                    if (!passesColumnFilter('datesCustomer', c.key, val)) return false;
                }
                return true;
            });

            // Sort
            const sf = datesCustomerSort.field;
            const asc = datesCustomerSort.asc;
            rows.sort((a, b) => {
                let va = a[sf], vb = b[sf];
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                va = String(va || ''); vb = String(vb || '');
                return asc ? va.localeCompare(vb) : vb.localeCompare(va);
            });

            // Render
            const tbody = document.getElementById('datesCustomerDrilldownBody');
            tbody.innerHTML = rows.map(row => {
                const cells = colDefs.filter(c => !isColumnHidden('datesCustomer', c.key)).map(c => {
                    if (c.key === 'customer') return `<td><strong>${row.customer}</strong></td>`;
                    if (c.key === 'orders') return `<td>${formatNumber(row.orders)}</td>`;
                    if (c.key === 'quantity') return `<td>${formatNumber(row.quantity)}</td>`;
                    if (c.key === 'revenue') return `<td>${formatCurrency(row.revenue)}</td>`;
                    if (c.key === 'pl') return `<td class="${row.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.pl)}</td>`;
                    if (c.key === 'margin') return `<td class="${row.margin >= 0 ? 'positive' : 'negative'}">${row.margin.toFixed(1)}%</td>`;
                    return `<td>-</td>`;
                }).join('');
                return `<tr class="clickable" onclick="showDatesOrdersDrilldown('${currentDrilldownMonth}', '${row.customer.replace(/'/g, "\\'")}')">${cells}</tr>`;
            }).join('');
        }

        function formatDatesCustomerCell(key, row) {
            if (key === 'revenue') return formatCurrency(row.revenue);
            if (key === 'pl') return formatCurrency(row.pl);
            if (key === 'margin') return row.margin.toFixed(1) + '%';
            if (key === 'orders' || key === 'quantity') return String(row[key]);
            return String(row[key] || '-');
        }

        function getUniqueDatesCustomerColumnValues(columnKey) {
            const custStats = {};
            datesCustomerData.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { customer: c, orders: 0, quantity: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].quantity += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            const values = new Set();
            Object.values(custStats).forEach(row => {
                row.margin = row.revenue > 0 ? (row.pl / row.revenue * 100) : 0;
                values.add(formatDatesCustomerCell(columnKey, row));
            });
            return Array.from(values).sort();
        }

        // Export functions for each drilldown section
        function exportDatesMonthlyOrdersCSV() {
            const colDefs = tableColumnDefs['datesMonthlyOrders'];
            const visibleCols = colDefs.filter(c => !isColumnHidden('datesMonthlyOrders', c.key));
            let rows = datesMonthlyOrdersData.map(r => getDatesMonthlyOrderRow(r));
            // Apply filters
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden('datesMonthlyOrders', c.key)) continue;
                    if (!passesColumnFilter('datesMonthlyOrders', c.key, formatMonthlyOrderCell(c.key, row))) return false;
                }
                return true;
            });
            // Sort
            const sf = datesMonthlyOrdersSort.field, asc = datesMonthlyOrdersSort.asc;
            rows.sort((a, b) => {
                let va = a[sf], vb = b[sf];
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                return String(va||'').localeCompare(String(vb||'')) * (asc ? 1 : -1);
            });
            const headers = visibleCols.map(c => currentLang === 'es' ? c.labelEs : c.labelEn);
            const csvRows = rows.map(row => visibleCols.map(c => {
                const val = ['unitPrice','variableCost','totalCost','salesTarget','profitPerPart','pl','revenue','shippingCost'].includes(c.key) ? row[c.key] : (c.key === 'contribution' ? row[c.key].toFixed(1) + '%' : row[c.key]);
                return '"' + String(val || '').replace(/"/g, '""') + '"';
            }).join(','));
            downloadCSV([headers.join(','), ...csvRows].join('\n'), `monthly_orders_${currentDrilldownMonth || 'export'}.csv`);
        }

        function exportDatesCustomerCSV() {
            const colDefs = tableColumnDefs['datesCustomer'];
            const visibleCols = colDefs.filter(c => !isColumnHidden('datesCustomer', c.key));
            const custStats = {};
            datesCustomerData.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { customer: c, orders: 0, quantity: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].quantity += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            let rows = Object.values(custStats).map(s => { s.margin = s.revenue > 0 ? (s.pl / s.revenue * 100) : 0; return s; });
            rows = rows.filter(row => {
                for (const c of colDefs) {
                    if (isColumnHidden('datesCustomer', c.key)) continue;
                    if (!passesColumnFilter('datesCustomer', c.key, formatDatesCustomerCell(c.key, row))) return false;
                }
                return true;
            });
            rows.sort((a, b) => {
                const sf = datesCustomerSort.field, asc = datesCustomerSort.asc;
                let va = a[sf], vb = b[sf];
                if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
                return String(va||'').localeCompare(String(vb||'')) * (asc ? 1 : -1);
            });
            const headers = visibleCols.map(c => currentLang === 'es' ? c.labelEs : c.labelEn);
            const csvRows = rows.map(row => visibleCols.map(c => {
                const val = c.key === 'margin' ? row.margin.toFixed(1) + '%' : row[c.key];
                return '"' + String(val || '').replace(/"/g, '""') + '"';
            }).join(','));
            downloadCSV([headers.join(','), ...csvRows].join('\n'), `customer_breakdown_${currentDrilldownMonth || 'export'}.csv`);
        }

        // ============================================================
        // ============================================================
        // ALL DATA PAGE (Raw spreadsheet data - Columns A-AX)
        // ============================================================
        function updateAllDataPage() {
            document.getElementById('allDataLastUpdated').textContent = new Date().toLocaleTimeString();
            document.getElementById('allDataRowCount').textContent = allRawData.length;
            document.getElementById('allDataColCount').textContent = allRawHeaders.length;
            
            renderAllDataTableHeader();
            renderAllDataTable();
            updateClearAllButton('allData');
        }
        
        function renderAllDataTableHeader() {
            initTableFilters('allData');
            initHiddenColumns('allData');
            document.getElementById('allDataTableHeader').innerHTML = allRawHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('allData', colKey)) return '';
                return createFilterHeader('allData', colKey, h, true);
            }).join('');
        }
        
        function renderAllDataTable() {
            let data = [...allRawData];
            
            // Filter out rows where column A is empty (array formula fills column A only for valid rows)
            const firstColHeader = allRawHeaders[0];
            if (firstColHeader) {
                data = data.filter(row => {
                    const val = row[firstColHeader];
                    return val !== undefined && val !== null && val !== '';
                });
            }
            
            // Global search filter
            const globalSearch = (document.getElementById('allDataGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return allRawHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return allRawHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('allData', colKey, val);
                });
            });
            
            // Apply sort
            if (allDataSort.field !== null) {
                const colIndex = parseInt(allDataSort.field.replace('col_', ''));
                const header = allRawHeaders[colIndex];
                const looksNumeric = v => v !== '' && !isNaN(Number(v.replace(/[$,%\s()]/g, '').replace(/^\((.+)\)$/, '-$1')));
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const strA = va !== undefined && va !== null ? String(va).trim() : '';
                    const strB = vb !== undefined && vb !== null ? String(vb).trim() : '';
                    if (looksNumeric(strA) && looksNumeric(strB)) {
                        return allDataSort.asc ? parseNumber(va) - parseNumber(vb) : parseNumber(vb) - parseNumber(va);
                    }
                    return allDataSort.asc ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }
            
            // Render table header (with hidden columns support)
            renderAllDataTableHeader();
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('allDataTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${allRawHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('allData', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('revenue') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('price') || h.toLowerCase().includes('p/l'))) {
                            const cls = num >= 0 ? 'positive' : 'negative';
                            return `<td class="${cls}">${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = allRawHeaders.filter((h, i) => !isColumnHidden('allData', `col_${i}`)).length;
            document.getElementById('allDataRowCount').textContent = data.length;
            document.getElementById('allDataColCount').textContent = visibleColCount;
            updateShowHiddenButton('allData');
        }
        
        function sortAllDataTable(field) {
            if (allDataSort.field === field) {
                allDataSort.asc = !allDataSort.asc;
            } else {
                allDataSort.field = field;
                allDataSort.asc = true;
            }
            renderAllDataTable();
        }
        
        function filterAllDataTable() {
            renderAllDataTable();
        }
        
        function getUniqueAllDataColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = allRawHeaders[colIndex];
            const firstColHeader = allRawHeaders[0];
            const values = new Set();
            // Only include values from rows where column A has data
            allRawData.forEach(row => {
                const firstColVal = row[firstColHeader];
                if (firstColVal === undefined || firstColVal === null || firstColVal === '') return;
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            // Sort values - try numeric first
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportAllDataToCSV() {
            const headers = allRawHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = allRawData.map(row => 
                allRawHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `all_data_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // BOM EXPLORER
        // ============================================================
        // ========== MATERIAL REQUIREMENTS ==========
        function computeMaterialRequirements() {
            const shippedStatuses = new Set(['staged', 'shipped', 'invoiced', 'to bill', 'cancelled', 'canceled', 'complete', 'closed', '']);
            const bom2Map = {};
            bomSubData.forEach(row => {
                const partName = (row['Part name'] || row['Part name '] || Object.values(row)[0] || '').toString().trim();
                if (!partName) return;
                const weight = parseFloat((row['Part weight'] || '0').toString().replace(/,/g, '')) || 0;
                const materials = [];
                for (let i = 1; i <= 5; i++) {
                    const name = (row['Component ' + i] || row['Component ' + i + ' '] || '').toString().trim();
                    const rawQty = (row['Component ' + i + ' Qty.'] || row['Component ' + i + ' Qty'] || '0').toString().trim();
                    let qty = parseFloat(rawQty.replace(/,/g, '').replace(/%/g, '')) || 0;
                    if (rawQty.includes('%')) qty = qty / 100; // Convert percentage to decimal (e.g., 1% -> 0.01)
                    if (name && qty > 0 && name.toLowerCase() !== 'scrap') materials.push({ name, qtyPerUnit: qty });
                }
                bom2Map[partName] = { weight, materials, category: (row['Sub-Product Category'] || '').toString().trim() };
            });
            const openOrders = allData.filter(row => {
                const status = (getVal(row, 'STATUS') || getVal(row, 'FUSION_STATUS') || '').toString().toLowerCase().trim();
                return !shippedStatuses.has(status);
            });
            const hubDemand = {}, tireDemand = {};
            let totalOpenOrders = 0;
            openOrders.forEach(row => {
                const qty = parseInt((getVal(row, 'QTY') || '0').toString().replace(/,/g, '')) || 0;
                if (qty <= 0) return;
                totalOpenOrders++;
                const hub = (getVal(row, 'HUB') || '').toString().trim();
                const tire = (getVal(row, 'TIRE') || '').toString().trim();
                if (hub) hubDemand[hub] = (hubDemand[hub] || 0) + qty;
                if (tire) tireDemand[tire] = (tireDemand[tire] || 0) + qty;
            });
            const materialDemand = {};
            function addMaterialDemand(componentName, componentQty, sourceLabel) {
                if (bom2Map[componentName]) {
                    bom2Map[componentName].materials.forEach(mat => {
                        const totalLbs = mat.qtyPerUnit * componentQty;
                        if (!materialDemand[mat.name]) materialDemand[mat.name] = { needed: 0, sources: [] };
                        materialDemand[mat.name].needed += totalLbs;
                        materialDemand[mat.name].sources.push({ component: componentName, qty: componentQty, materialPerUnit: mat.qtyPerUnit, totalLbs, sourceLabel });
                    });
                }
            }
            Object.entries(hubDemand).forEach(([hub, qty]) => addMaterialDemand(hub, qty, 'Hub'));
            Object.entries(tireDemand).forEach(([tire, qty]) => addMaterialDemand(tire, qty, 'Tire'));
            const inventoryLookup = {};
            inventoryData.forEach(item => {
                const partNum = (item.partNumber || item.itemNumber || '').toString().trim();
                if (partNum) inventoryLookup[partNum] = item.fusionQty || 0;
            });
            const materials = Object.entries(materialDemand).map(([name, data]) => {
                const onHand = inventoryLookup[name] || 0;
                const needed = Math.round(data.needed);
                const surplus = onHand - needed;
                const coverage = needed > 0 ? Math.min(100, Math.round((onHand / needed) * 100)) : 100;
                let status = 'ok';
                if (surplus < 0 && coverage < 50) status = 'shortage';
                else if (surplus < 0) status = 'low';
                return { name, onHand, needed, surplus, coverage, status, sources: data.sources };
            }).sort((a, b) => a.surplus - b.surplus);
            const hubs = Object.entries(hubDemand).map(([hub, qty]) => {
                const bom = bom2Map[hub];
                return { part: hub, qty, weight: bom ? bom.weight : 0, category: bom ? bom.category : '', materials: bom ? bom.materials.map(m => ({ name: m.name, perUnit: m.qtyPerUnit, total: Math.round(m.qtyPerUnit * qty) })) : [] };
            }).sort((a, b) => b.qty - a.qty);
            const tires = Object.entries(tireDemand).map(([tire, qty]) => {
                const bom = bom2Map[tire];
                return { part: tire, qty, weight: bom ? bom.weight : 0, category: bom ? bom.category : '', materials: bom ? bom.materials.map(m => ({ name: m.name, perUnit: m.qtyPerUnit, total: Math.round(m.qtyPerUnit * qty) })) : [] };
            }).sort((a, b) => b.qty - a.qty);
            return {
                totalOpenOrders,
                totalHubs: Object.values(hubDemand).reduce((s, v) => s + v, 0),
                totalTires: Object.values(tireDemand).reduce((s, v) => s + v, 0),
                materials, hubs, tires,
                shortages: materials.filter(m => m.status === 'shortage' || m.status === 'low'),
                totalUrethane: materials.filter(m => m.name.toLowerCase().includes('urth')).reduce((s, m) => s + m.needed, 0),
                totalCrumbRubber: materials.filter(m => m.name.toLowerCase().includes('abr')).reduce((s, m) => s + m.needed, 0)
            };
        }

        function updateMaterialRequirementsPage() {
            const data = computeMaterialRequirements();
            const lang = currentLang;
            const t = (en, es) => lang === 'es' ? es : en;
            document.getElementById('matReqOrderCount').textContent = formatNumber(data.totalOpenOrders);
            document.getElementById('matReqHubCount').textContent = formatNumber(data.totalHubs);
            document.getElementById('matReqTireCount').textContent = formatNumber(data.totalTires);
            document.getElementById('matReqShortageCount').textContent = data.shortages.length;
            document.getElementById('matReqShortageCount').style.color = data.shortages.length > 0 ? 'var(--danger)' : 'var(--success)';
            document.getElementById('matReqUrethane').textContent = formatNumber(data.totalUrethane) + ' lbs';
            document.getElementById('matReqCrumbRubber').textContent = formatNumber(data.totalCrumbRubber) + ' lbs';
            const tbody = document.getElementById('matReqTableBody');
            tbody.innerHTML = '';
            data.materials.forEach(mat => {
                const statusBadge = mat.status === 'shortage' ? '<span class="mat-badge mat-badge-shortage">' + t('SHORTAGE','FALTANTE') + '</span>' : mat.status === 'low' ? '<span class="mat-badge mat-badge-low">' + t('LOW','BAJO') + '</span>' : '<span class="mat-badge mat-badge-ok">OK</span>';
                const surplusClass = mat.surplus >= 0 ? 'mat-surplus' : 'mat-shortage-num';
                const barClass = mat.coverage >= 80 ? 'mat-bar-green' : mat.coverage >= 40 ? 'mat-bar-yellow' : 'mat-bar-red';
                const tr = document.createElement('tr');
                tr.className = 'mat-req-row';
                tr.onclick = function() { toggleMaterialDetail(mat.name); };
                tr.innerHTML = '<td>' + mat.name + '</td><td class="num">' + formatNumber(mat.onHand) + '</td><td class="num">' + formatNumber(mat.needed) + '</td><td class="num ' + surplusClass + '">' + (mat.surplus >= 0 ? '+' : '') + formatNumber(mat.surplus) + '</td><td><div class="mat-coverage-cell"><span>' + mat.coverage + '%</span><div class="mat-bar-bg"><div class="mat-bar ' + barClass + '" style="width:' + mat.coverage + '%"></div></div></div></td><td>' + statusBadge + '</td>';
                tbody.appendChild(tr);
                const detailTr = document.createElement('tr');
                detailTr.id = 'matDetail_' + mat.name.replace(/[^a-zA-Z0-9]/g, '_');
                detailTr.className = 'mat-detail-row';
                detailTr.style.display = 'none';
                const grouped = {};
                mat.sources.forEach(s => {
                    if (!grouped[s.component]) grouped[s.component] = { qty: 0, materialPerUnit: s.materialPerUnit, totalLbs: 0, sourceLabel: s.sourceLabel };
                    grouped[s.component].qty += s.qty;
                    grouped[s.component].totalLbs += s.totalLbs;
                });
                let detailHTML = '<td colspan="6"><div class="mat-detail-content"><strong>' + t('Demand Breakdown','Desglose de Demanda') + ':</strong><table class="mat-detail-table"><tr><th>' + t('Component','Componente') + '</th><th>' + t('Type','Tipo') + '</th><th class="num">' + t('Units','Unidades') + '</th><th class="num">' + t('Lbs/Unit','Lbs/Unidad') + '</th><th class="num">' + t('Total Lbs','Total Lbs') + '</th></tr>';
                Object.entries(grouped).forEach(([comp, info]) => {
                    detailHTML += '<tr><td>' + comp + '</td><td>' + info.sourceLabel + '</td><td class="num">' + formatNumber(info.qty) + '</td><td class="num">' + info.materialPerUnit.toFixed(3) + '</td><td class="num">' + formatNumber(Math.round(info.totalLbs)) + '</td></tr>';
                });
                detailHTML += '</table></div></td>';
                detailTr.innerHTML = detailHTML;
                tbody.appendChild(detailTr);
            });
            const hubBody = document.getElementById('matReqHubBody');
            hubBody.innerHTML = '';
            data.hubs.forEach(hub => {
                const matStr = hub.materials.map(m => m.name + ' (' + formatNumber(m.total) + ' lbs)').join(' Â· ');
                hubBody.innerHTML += '<tr><td>' + hub.part + '</td><td>' + hub.category + '</td><td class="num">' + formatNumber(hub.qty) + '</td><td class="num">' + hub.weight.toFixed(2) + '</td><td>' + (matStr || 'â€”') + '</td></tr>';
            });
            const tireBody = document.getElementById('matReqTireBody');
            tireBody.innerHTML = '';
            data.tires.forEach(tire => {
                const crumb = tire.materials.find(m => m.name.toLowerCase().includes('abr'));
                const urethane = tire.materials.find(m => m.name.toLowerCase().includes('urth'));
                tireBody.innerHTML += '<tr><td>' + tire.part + '</td><td class="num">' + formatNumber(tire.qty) + '</td><td class="num">' + tire.weight.toFixed(2) + '</td><td class="num">' + (crumb ? formatNumber(crumb.total) : 'â€”') + '</td><td class="num">' + (urethane ? formatNumber(urethane.total) : 'â€”') + '</td></tr>';
            });
            const now = new Date();
            document.getElementById('matReqTimestamp').textContent = t('Updated','Actualizado') + ': ' + now.toLocaleTimeString();
        }

        function toggleMaterialDetail(materialName) {
            const id = 'matDetail_' + materialName.replace(/[^a-zA-Z0-9]/g, '_');
            const row = document.getElementById(id);
            if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function exportMaterialRequirementsCSV() {
            const data = computeMaterialRequirements();
            let csv = 'Material,On Hand,Needed,Surplus/Shortage,Coverage %,Status\n';
            data.materials.forEach(m => { csv += '"' + m.name + '",' + m.onHand + ',' + m.needed + ',' + m.surplus + ',' + m.coverage + '%,' + m.status + '\n'; });
            csv += '\nHub,Category,Qty Needed,Weight/ea\n';
            data.hubs.forEach(h => { csv += '"' + h.part + '","' + h.category + '",' + h.qty + ',' + h.weight + '\n'; });
            csv += '\nTire,Qty Needed,Weight/ea\n';
            data.tires.forEach(t => { csv += '"' + t.part + '",' + t.qty + ',' + t.weight + '\n'; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'material-requirements-' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
        }

        function initBomExplorer() { renderBomSelector(); }
        function filterBomSelector() { renderBomSelector((document.getElementById('bomSearch').value || '').toLowerCase()); }
        
        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab));
            document.getElementById('bomSearch').value = '';
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }
        
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available. Check that the source sheet contains data.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.length === 0 ? '<p style="color:var(--text-secondary);">No parts found.</p>' : filtered.map((d, i) => {
                const originalIndex = data.indexOf(d);
                return `<div class="bom-item" data-index="${originalIndex}" onclick="showBomDetails(${originalIndex})">${d[nameKey] || 'Unknown'}</div>`;
            }).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', parseInt(item.dataset.index) === index));
            
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search, exactMatch] of [['Mold','mold',false],['Weight','weight',false],['Labor/Part','labor cost/ part',false],['Overhead','overhead',false],['Total Cost','total cost',true]]) {
                    let key = exactMatch ? Object.keys(part).find(k => k.trim().toLowerCase() === search) : Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`);
                    if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                const partsPkgKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('parts per package'));
                if (partsPkgKey && part[partsPkgKey]) content += `<div class="cost-item"><span class="label">Parts/Pkg</span><span class="value">${part[partsPkgKey]}</span></div>`;
                const laborKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('labor cost / finished') || k.trim().toLowerCase().includes('labor cost/ finished'));
                if (laborKey && part[laborKey]) content += `<div class="cost-item"><span class="label">Labor</span><span class="value">${formatCurrency(parseNumber(part[laborKey]))}</span></div>`;
                const varCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'variable cost');
                if (varCostKey && part[varCostKey]) content += `<div class="cost-item"><span class="label">Variable Cost</span><span class="value">${formatCurrency(parseNumber(part[varCostKey]))}</span></div>`;
                const totalCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'total cost');
                if (totalCostKey && part[totalCostKey]) content += `<div class="cost-item"><span class="label">Total Cost</span><span class="value">${formatCurrency(parseNumber(part[totalCostKey]))}</span></div>`;
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) {
                    content += `<div class="highlight-box">`;
                    if (profitKey && part[profitKey]) { const profitVal = parseNumber(part[profitKey]); const displayVal = profitVal < 1 ? (profitVal * 100).toFixed(0) + '%' : profitVal.toFixed(0) + '%'; content += `<div class="item"><div class="value">${displayVal}</div><div class="label">Profit Target</div></div>`; }
                    if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`;
                    content += `</div>`;
                }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`);
                    if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) {
                        content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                    }
                }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        // ============================================================
        // REFERENCE DATA SECTIONS (FP Reference, Customer Reference, Quotes Registry)
        // ============================================================
        
        function handleRefDataClick(page) {
            if (!salesUnlocked) {
                promptSalesPassword(page);
                return;
            }
            navigateTo(page);
        }
        
        // Track if reference data has been loaded
        let referenceDataLoaded = false;
        
        async function updateFpReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderFpRefTable();
        }
        
        async function updateCustReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderCustRefTable();
        }
        
        async function updateQuotesRegistryPage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderQuotesTable();
        }
        
        async function updatePalletRecordsPage() {
            if (!palletRecordsLoaded) {
                await loadPalletRecordsData();
            }
            renderPalletRecordsTable();
        }
        
        async function updateShippingRecordsPage() {
            if (!shippingRecordsLoaded) {
                await loadShippingRecordsData();
            }
            renderShippingRecordsTable();
        }
        
        async function updateStagedRecordsPage() {
            if (!stagedRecordsLoaded) {
                await loadStagedRecordsData();
            }
            renderStagedRecordsTable();
        }
        
        async function loadReferenceData() {
            try {
                // Load FP Reference Data
                const fpRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${FP_REFERENCE_GID}`;
                const fpRes = await fetch(fpRefUrl);
                const fpText = await fpRes.text();
                const fpJson = JSON.parse(fpText.substring(fpText.indexOf('{'), fpText.lastIndexOf('}') + 1));
                fpReferenceHeaders = fpJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                fpReferenceData = fpJson.table.rows.map(r => {
                    const obj = {};
                    fpReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded FP Reference:', fpReferenceData.length, 'rows');
                
                // Load Customer Reference Data
                const custRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${CUSTOMER_REFERENCE_GID}`;
                const custRes = await fetch(custRefUrl);
                const custText = await custRes.text();
                const custJson = JSON.parse(custText.substring(custText.indexOf('{'), custText.lastIndexOf('}') + 1));
                customerReferenceHeaders = custJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                customerReferenceData = custJson.table.rows.map(r => {
                    const obj = {};
                    customerReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded Customer Reference:', customerReferenceData.length, 'rows');
                
                // Load Quotes Registry Data (with headers from spreadsheet, columns A-J only)
                const quotesUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${QUOTES_REGISTRY_GID}`;
                const quotesRes = await fetch(quotesUrl);
                const quotesText = await quotesRes.text();
                const quotesJson = JSON.parse(quotesText.substring(quotesText.indexOf('{'), quotesText.lastIndexOf('}') + 1));
                // Get headers from spreadsheet columns A-J (first 10 columns only)
                const allQuotesHeaders = quotesJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
                quotesRegistryHeaders = allQuotesHeaders.slice(0, 10).filter(h => h); // Only columns A-J
                quotesRegistryData = quotesJson.table.rows.map(r => {
                    const obj = {};
                    quotesRegistryHeaders.forEach((h, i) => { obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => {
                    // Filter out rows without Quote Number and filter out the header row if it got included as data
                    const quoteNum = row['Quote Number'] || row[quotesRegistryHeaders[0]];
                    return quoteNum && quoteNum !== 'Quote Number';
                });
                console.log('Loaded Quotes Registry:', quotesRegistryData.length, 'rows, Headers:', quotesRegistryHeaders);
                
            } catch (e) {
                console.error('Reference data load error:', e);
            }
        }
        
        // FP Reference Data Functions
        function renderFpRefTableHeader() {
            initTableFilters('fpRef');
            initHiddenColumns('fpRef');
            document.getElementById('fpRefTableHeader').innerHTML = fpReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('fpRef', colKey)) return '';
                return createFilterHeader('fpRef', colKey, h, true);
            }).join('');
        }
        
        function renderFpRefTable() {
            if (fpReferenceHeaders.length === 0) {
                document.getElementById('fpRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderFpRefTableHeader();
            let data = [...fpReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('fpRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return fpReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return fpReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('fpRef', colKey, val);
                });
            });
            
            // Apply sort
            if (fpRefSort.field !== null) {
                const colIndex = parseInt(fpRefSort.field.replace('col_', ''));
                const header = fpReferenceHeaders[colIndex];
                const looksNumeric = v => v !== '' && !isNaN(Number(v.replace(/[$,%\s()]/g, '').replace(/^\((.+)\)$/, '-$1')));
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const strA = va !== undefined && va !== null ? String(va).trim() : '';
                    const strB = vb !== undefined && vb !== null ? String(vb).trim() : '';
                    if (looksNumeric(strA) && looksNumeric(strB)) {
                        return fpRefSort.asc ? parseNumber(va) - parseNumber(vb) : parseNumber(vb) - parseNumber(va);
                    }
                    return fpRefSort.asc ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('fpRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${fpReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('fpRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = fpReferenceHeaders.filter((h, i) => !isColumnHidden('fpRef', `col_${i}`)).length;
            document.getElementById('fpRefRowCount').textContent = data.length;
            document.getElementById('fpRefColCount').textContent = visibleColCount;
            document.getElementById('fpRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('fpRef');
            updateShowHiddenButton('fpRef');
        }
        
        function sortFpRefTable(field) {
            if (fpRefSort.field === field) {
                fpRefSort.asc = !fpRefSort.asc;
            } else {
                fpRefSort.field = field;
                fpRefSort.asc = true;
            }
            renderFpRefTable();
        }
        
        function filterFpRefTable() { renderFpRefTable(); }
        
        function getUniqueFpRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = fpReferenceHeaders[colIndex];
            const values = new Set();
            fpReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportFpRefToCSV() {
            const headers = fpReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = fpReferenceData.map(row => 
                fpReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `fp_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Customer Reference Data Functions
        function renderCustRefTableHeader() {
            initTableFilters('custRef');
            initHiddenColumns('custRef');
            document.getElementById('custRefTableHeader').innerHTML = customerReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('custRef', colKey)) return '';
                return createFilterHeader('custRef', colKey, h, true);
            }).join('');
        }
        
        function renderCustRefTable() {
            if (customerReferenceHeaders.length === 0) {
                document.getElementById('custRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderCustRefTableHeader();
            let data = [...customerReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('custRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return customerReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return customerReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('custRef', colKey, val);
                });
            });
            
            // Apply sort
            if (custRefSort.field !== null) {
                const colIndex = parseInt(custRefSort.field.replace('col_', ''));
                const header = customerReferenceHeaders[colIndex];
                const looksNumeric = v => v !== '' && !isNaN(Number(v.replace(/[$,%\s()]/g, '').replace(/^\((.+)\)$/, '-$1')));
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const strA = va !== undefined && va !== null ? String(va).trim() : '';
                    const strB = vb !== undefined && vb !== null ? String(vb).trim() : '';
                    if (looksNumeric(strA) && looksNumeric(strB)) {
                        return custRefSort.asc ? parseNumber(va) - parseNumber(vb) : parseNumber(vb) - parseNumber(va);
                    }
                    return custRefSort.asc ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('custRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${customerReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('custRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('price') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('sell'))) {
                            return `<td>${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = customerReferenceHeaders.filter((h, i) => !isColumnHidden('custRef', `col_${i}`)).length;
            document.getElementById('custRefRowCount').textContent = data.length;
            document.getElementById('custRefColCount').textContent = visibleColCount;
            document.getElementById('custRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('custRef');
            updateShowHiddenButton('custRef');
        }
        
        function sortCustRefTable(field) {
            if (custRefSort.field === field) {
                custRefSort.asc = !custRefSort.asc;
            } else {
                custRefSort.field = field;
                custRefSort.asc = true;
            }
            renderCustRefTable();
        }
        
        function filterCustRefTable() { renderCustRefTable(); }
        
        function getUniqueCustRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = customerReferenceHeaders[colIndex];
            const values = new Set();
            customerReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportCustRefToCSV() {
            const headers = customerReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = customerReferenceData.map(row => 
                customerReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `customer_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Quotes Registry Functions
        function renderQuotesTableHeader() {
            initTableFilters('quotes');
            initHiddenColumns('quotes');
            document.getElementById('quotesTableHeader').innerHTML = quotesRegistryHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('quotes', colKey)) return '';
                return createFilterHeader('quotes', colKey, h, true);
            }).join('');
        }
        
        function renderQuotesTable() {
            if (quotesRegistryData.length === 0) {
                document.getElementById('quotesTableBody').innerHTML = '<tr><td colspan="11">Loading data...</td></tr>';
                return;
            }
            
            renderQuotesTableHeader();
            let data = [...quotesRegistryData];
            
            // Global search filter
            const globalSearch = (document.getElementById('quotesGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return quotesRegistryHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return quotesRegistryHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('quotes', colKey, val);
                });
            });
            
            // Apply sort
            if (quotesSort.field !== null) {
                const colIndex = parseInt(quotesSort.field.replace('col_', ''));
                const header = quotesRegistryHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    // Only use numeric sort if values actually look numeric (not just parseNumber returning 0 for text)
                    const strA = va !== undefined && va !== null ? String(va).trim() : '';
                    const strB = vb !== undefined && vb !== null ? String(vb).trim() : '';
                    const looksNumeric = v => v !== '' && !isNaN(Number(v.replace(/[$,%\s()]/g, '').replace(/^\((.+)\)$/, '-$1')));
                    if (looksNumeric(strA) && looksNumeric(strB)) {
                        const numA = parseNumber(va), numB = parseNumber(vb);
                        return quotesSort.asc ? numA - numB : numB - numA;
                    }
                    return quotesSort.asc ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('quotesTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${quotesRegistryHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('quotes', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Make Drive Link clickable (case-insensitive check)
                    if (h.toLowerCase().includes('drive') && h.toLowerCase().includes('link') && val && String(val).startsWith('http')) {
                        return `<td><a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“„ View</a></td>`;
                    }
                    // Format Amount as currency (case-insensitive check)
                    if (h.toLowerCase() === 'amount' && val) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && num !== 0) return `<td>${formatCurrency(num)}</td>`;
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = quotesRegistryHeaders.filter((h, i) => !isColumnHidden('quotes', `col_${i}`)).length;
            document.getElementById('quotesRowCount').textContent = data.length;
            document.getElementById('quotesColCount').textContent = visibleColCount;
            document.getElementById('quotesLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('quotes');
            updateShowHiddenButton('quotes');
        }
        
        function sortQuotesTable(field) {
            if (quotesSort.field === field) {
                quotesSort.asc = !quotesSort.asc;
            } else {
                quotesSort.field = field;
                quotesSort.asc = true;
            }
            renderQuotesTable();
        }
        
        function filterQuotesTable() { renderQuotesTable(); }
        
        function getUniqueQuotesColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = quotesRegistryHeaders[colIndex];
            const values = new Set();
            quotesRegistryData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportQuotesToCSV() {
            const headers = quotesRegistryHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = quotesRegistryData.map(row => 
                quotesRegistryHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `quotes_registry_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // PALLET RECORDS FUNCTIONS
        // ============================================================
        
        async function loadPalletRecordsData() {
            if (palletRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Pallet Records raw data sample:', rawData.length > 0 ? rawData[0] : 'no data');
                console.log('Pallet Records raw data count:', rawData.length);
                
                // Map the original bilingual headers to simplified English headers
                // The headers in the spreadsheet are bilingual, so we need to find them
                palletRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Order Number': findVal('order number', 'numero de orden'),
                        'Pallet Number': findVal('pallet number', 'numero de paleta'),
                        'Pallet Picture 1': findVal('pallet pictures', 'fotos de paletas'),
                        'Pallet Weight (lbs)': findVal('pallet weight', 'peso de la paleta'),
                        'Pallet Dimensions': findVal('pallet dimensions', 'dimensiones de la paleta'),
                        'Pallet Picture 2': findVal('pallet pictures 2', 'fotos de paletas 2'),
                        'Pallet Picture 3': findVal('pallet pictures 3', 'fotos de paletas 3'),
                        'Pallet Picture 4': findVal('pallet pictures 4', 'fotos de paletas 4'),
                        'Pallet Picture 5': findVal('pallet pictures 5', 'fotos de paletas 5'),
                        'Parts/Boxes per Pallet': findVal('parts/boxes per pallet', 'partes o cajas por paleta'),
                        'Customer': findVal('customer', 'cliente'),
                        'IF Number': findVal('if number', 'numero if'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Order Number'];
                });
                
                palletRecordsLoaded = true;
                console.log('Loaded Pallet Records:', palletRecordsData.length, 'rows');
                if (palletRecordsData.length > 0) {
                    console.log('First row sample:', palletRecordsData[0]);
                }
            } catch (e) {
                console.error('Pallet Records load error:', e);
                palletRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getPalletRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function togglePalletRecordsCategory(cat) {
            palletRecordsFilters.categories[cat] = !palletRecordsFilters.categories[cat];
            document.getElementById(`palletRecordsBtnRollTech`).classList.toggle('active', palletRecordsFilters.categories.rolltech);
            document.getElementById(`palletRecordsBtnMolding`).classList.toggle('active', palletRecordsFilters.categories.molding);
            document.getElementById(`palletRecordsBtnSnapPad`).classList.toggle('active', palletRecordsFilters.categories.snappad);
            renderPalletRecordsTable();
        }
        
        function renderPalletRecordsTableHeader() {
            const headers = currentLang === 'es' ? PALLET_RECORDS_HEADERS_ES : PALLET_RECORDS_HEADERS;
            initTableFilters('palletRecords');
            initHiddenColumns('palletRecords');
            document.getElementById('palletRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('palletRecords', colKey)) return '';
                return createFilterHeader('palletRecords', colKey, h, true);
            }).join('');
        }
        
        function renderPalletRecordsTable() {
            if (!palletRecordsLoaded) {
                document.getElementById('palletRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('palletRecordsRowCount').textContent = '-';
                return;
            }
            if (palletRecordsData.length === 0) {
                document.getElementById('palletRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('palletRecordsRowCount').textContent = '0';
                return;
            }
            
            renderPalletRecordsTableHeader();
            const headers = PALLET_RECORDS_HEADERS;
            let data = [...palletRecordsData];
            
            // Category filter
            data = data.filter(row => palletRecordsFilters.categories[getPalletRecordsCategory(row)] || getPalletRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('palletRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('palletRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (palletRecordsSort.field !== null) {
                const colIndex = parseInt(palletRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return palletRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return palletRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('palletRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('palletRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('palletRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links
                    if (h.includes('Picture') && val && val.toString().includes('http')) {
                        val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('palletRecords');
        }
        
        function sortPalletRecordsTable(field) {
            if (palletRecordsSort.field === field) {
                palletRecordsSort.asc = !palletRecordsSort.asc;
            } else {
                palletRecordsSort.field = field;
                palletRecordsSort.asc = true;
            }
            renderPalletRecordsTable();
        }
        
        function filterPalletRecordsTable() { renderPalletRecordsTable(); }
        
        function getUniquePalletRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = PALLET_RECORDS_HEADERS[colIndex];
            const values = new Set();
            palletRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportPalletRecordsToCSV() {
            const headers = currentLang === 'es' ? PALLET_RECORDS_HEADERS_ES : PALLET_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = palletRecordsData.map(row => 
                PALLET_RECORDS_HEADERS.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `pallet_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SHIPPING RECORDS FUNCTIONS
        // ============================================================
        
        async function loadShippingRecordsData() {
            if (shippingRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(SHIPPING_RECORDS_GID);
                console.log('==== SHIPPING RECORDS LOAD DEBUG ====');
                console.log('Raw data count:', rawData.length);
                if (rawData.length > 0) {
                    const headers = Object.keys(rawData[0]);
                    console.log('ALL Column headers (' + headers.length + '):', headers);
                    // Show headers that might contain pictures
                    const pictureHeaders = headers.filter(h => 
                        h.toLowerCase().includes('picture') || 
                        h.toLowerCase().includes('foto') ||
                        h.toLowerCase().includes('image') ||
                        h.toLowerCase().includes('ship') ||
                        h.toLowerCase().includes('envio') ||
                        h.toLowerCase().includes('paper') ||
                        h.toLowerCase().includes('papeleo') ||
                        h.toLowerCase().includes('close') ||
                        h.toLowerCase().includes('cercana')
                    );
                    console.log('Picture-related headers:', pictureHeaders);
                    console.log('First row sample:', rawData[0]);
                }
                console.log('=====================================');
                
                // Helper to extract URLs from a field that may contain multiple URLs
                const extractUrls = (value) => {
                    if (!value) return [];
                    const str = value.toString();
                    // Split by comma, newline, or space followed by http
                    const urls = str.split(/[,\n]|\s+(?=https?:)/)
                        .map(u => u.trim())
                        .filter(u => u && u.includes('http'));
                    return urls;
                };
                
                // Map the original bilingual headers to simplified English headers
                shippingRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    // Get all picture URLs from columns matching ANY of the keywords
                    const findAllPictures = (...keywords) => {
                        const allUrls = [];
                        for (const [header, value] of Object.entries(row)) {
                            const h = header.toLowerCase();
                            if (keywords.some(k => h.includes(k.toLowerCase()))) {
                                const urls = extractUrls(value);
                                allUrls.push(...urls);
                            }
                        }
                        return allUrls;
                    };
                    
                    // Determine system and normalize
                    let system = findVal('system', 'sistema').toString().toLowerCase();
                    if (system.includes('fusion')) system = 'Fusion';
                    else if (system.includes('veeqo') || system.includes('veeco')) system = 'Veeqo';
                    else if (system) system = 'Other';
                    else system = '';
                    
                    // Get all shipment pictures - match various patterns for shipment photos
                    // Column names may include: "Shipment", "EnvÃ­o", "Envio", "ship"
                    const shipmentPictures = findAllPictures('shipment', 'envÃ­o', 'envio', 'ship');
                    
                    // Get all paperwork pictures
                    // Column names may include: "Paperwork", "Papeleo", "BOL", "document"
                    const paperworkPictures = findAllPictures('paperwork', 'papeleo', 'bol', 'document');
                    
                    // Get all close up pictures
                    // Column names may include: "Close-up", "Close up", "Closeup", "Primer Plano", "Cercana"
                    const closeUpPictures = findAllPictures('close-up', 'close up', 'closeup', 'primer plano', 'cercana');
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Carrier': findVal('carrier', 'transportista'),
                        'IF Number': findVal('if #', 'if number', 'numero if', 'numero de if'),
                        'System': system,
                        'Order Number': findVal('order number', 'numero de orden'),
                        'Shipment Pictures': shipmentPictures,  // Array of URLs
                        'Paperwork Pictures': paperworkPictures, // Array of URLs
                        'Close Up Pictures': closeUpPictures,   // Array of URLs
                        'Customer': findVal('customer', 'cliente', 'costumer'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Carrier'];
                });
                
                shippingRecordsLoaded = true;
                console.log('Loaded Shipping Records:', shippingRecordsData.length, 'rows');
                if (shippingRecordsData.length > 0) {
                    console.log('First row sample:', shippingRecordsData[0]);
                    // Log first row with any photos
                    const rowWithPhotos = shippingRecordsData.find(r => r['Shipment Pictures'].length > 0 || r['Paperwork Pictures'].length > 0 || r['Close Up Pictures'].length > 0);
                    if (rowWithPhotos) {
                        console.log('Row with photos sample:', rowWithPhotos);
                    }
                }
            } catch (e) {
                console.error('Shipping Records load error:', e);
                shippingRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getShippingRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function toggleShippingRecordsCategory(cat) {
            shippingRecordsFilters.categories[cat] = !shippingRecordsFilters.categories[cat];
            document.getElementById(`shippingRecordsBtnRollTech`).classList.toggle('active', shippingRecordsFilters.categories.rolltech);
            document.getElementById(`shippingRecordsBtnMolding`).classList.toggle('active', shippingRecordsFilters.categories.molding);
            document.getElementById(`shippingRecordsBtnSnapPad`).classList.toggle('active', shippingRecordsFilters.categories.snappad);
            renderShippingRecordsTable();
        }
        
        function renderShippingRecordsTableHeader() {
            const headers = currentLang === 'es' ? SHIPPING_RECORDS_HEADERS_ES : SHIPPING_RECORDS_HEADERS;
            initTableFilters('shippingRecords');
            initHiddenColumns('shippingRecords');
            document.getElementById('shippingRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('shippingRecords', colKey)) return '';
                return createFilterHeader('shippingRecords', colKey, h, true);
            }).join('');
        }
        
        function renderShippingRecordsTable() {
            if (!shippingRecordsLoaded) {
                document.getElementById('shippingRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('shippingRecordsRowCount').textContent = '-';
                return;
            }
            if (shippingRecordsData.length === 0) {
                document.getElementById('shippingRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('shippingRecordsRowCount').textContent = '0';
                return;
            }
            
            renderShippingRecordsTableHeader();
            const headers = SHIPPING_RECORDS_HEADERS;
            let data = [...shippingRecordsData];
            
            // Category filter
            data = data.filter(row => shippingRecordsFilters.categories[getShippingRecordsCategory(row)] || getShippingRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('shippingRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('shippingRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (shippingRecordsSort.field !== null) {
                const colIndex = parseInt(shippingRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return shippingRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return shippingRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('shippingRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('shippingRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('shippingRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links - handle arrays of URLs
                    if (h.includes('Pictures')) {
                        if (Array.isArray(val) && val.length > 0) {
                            val = val.map((url, idx) => `<a href="${url}" target="_blank" style="color:var(--accent);margin-right:4px;">ðŸ“·${val.length > 1 ? (idx + 1) : ''}</a>`).join('');
                        } else if (typeof val === 'string' && val.includes('http')) {
                            val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                        } else {
                            val = '-';
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('shippingRecords');
        }
        
        function sortShippingRecordsTable(field) {
            if (shippingRecordsSort.field === field) {
                shippingRecordsSort.asc = !shippingRecordsSort.asc;
            } else {
                shippingRecordsSort.field = field;
                shippingRecordsSort.asc = true;
            }
            renderShippingRecordsTable();
        }
        
        function filterShippingRecordsTable() { renderShippingRecordsTable(); }
        
        function getUniqueShippingRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = SHIPPING_RECORDS_HEADERS[colIndex];
            const values = new Set();
            shippingRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportShippingRecordsToCSV() {
            const headers = currentLang === 'es' ? SHIPPING_RECORDS_HEADERS_ES : SHIPPING_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = shippingRecordsData.map(row => 
                SHIPPING_RECORDS_HEADERS.map(h => {
                    let val = row[h];
                    if (val === undefined || val === null) return '""';
                    // Handle arrays by joining with semicolon
                    if (Array.isArray(val)) val = val.join('; ');
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `shipping_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // STAGED RECORDS FUNCTIONS
        // ============================================================
        
        async function loadStagedRecordsData() {
            if (stagedRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(STAGED_RECORDS_GID);
                console.log('Staged Records raw data sample:', rawData.length > 0 ? rawData[0] : 'no data');
                console.log('Staged Records raw data count:', rawData.length);
                
                // Map the original bilingual headers to simplified English headers
                stagedRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    // Helper to extract URLs from a field
                    const extractUrls = (value) => {
                        if (!value) return [];
                        const str = value.toString();
                        const urls = str.split(/[,\n]|\s+(?=https?:)/)
                            .map(u => u.trim())
                            .filter(u => u && u.includes('http'));
                        return urls;
                    };
                    
                    // Find Fusion Picture specifically (Column M) - be careful not to match "Staged in Fusion"
                    const findFusionPicture = () => {
                        for (const [header, value] of Object.entries(row)) {
                            const h = header.toLowerCase();
                            // Match "Fusion Picture" or "Foto de Fusion" but NOT "Staged in Fusion"
                            if ((h.includes('fusion picture') || h.includes('foto de fusion') || h === 'fusion') && !h.includes('staged')) {
                                if (value && value.toString().includes('http')) {
                                    return extractUrls(value);
                                }
                            }
                        }
                        return [];
                    };
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Line Number': findVal('line number', 'numero de linea'),
                        'IF Number': findVal('if number', 'numero if', 'numero de if'),
                        'Order Quantity': findVal('order quantity', 'cantidad de orden', 'cantidad'),
                        'Number of Pallets': findVal('number of pallets', 'numero de paletas'),
                        'Staged By': findVal('name', 'nombre', 'staged by'),
                        'Comments': findVal('comments', 'comentarios'),
                        'Order Status': findVal('order status', 'estado de orden', 'status'),
                        'Staged in Fusion': findVal('staged in fusion', 'fulfillment staged'),
                        'Pallet Dimensions': findVal('pallet dimensions', 'dimensiones de la paleta'),
                        'Pallet Weight (lbs)': findVal('pallet weight', 'peso de la paleta'),
                        'Confirmed Staged': findVal('confirmed', 'confirmacion', 'confirmation'),
                        'Fusion Pictures': findFusionPicture(),  // Now returns array of URLs
                        'Customer': findVal('customer', 'cliente'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Line Number'];
                });
                
                stagedRecordsLoaded = true;
                console.log('Loaded Staged Records:', stagedRecordsData.length, 'rows');
                if (stagedRecordsData.length > 0) {
                    console.log('First row sample:', stagedRecordsData[0]);
                }
            } catch (e) {
                console.error('Staged Records load error:', e);
                stagedRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getStagedRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function toggleStagedRecordsCategory(cat) {
            stagedRecordsFilters.categories[cat] = !stagedRecordsFilters.categories[cat];
            document.getElementById(`stagedRecordsBtnRollTech`).classList.toggle('active', stagedRecordsFilters.categories.rolltech);
            document.getElementById(`stagedRecordsBtnMolding`).classList.toggle('active', stagedRecordsFilters.categories.molding);
            document.getElementById(`stagedRecordsBtnSnapPad`).classList.toggle('active', stagedRecordsFilters.categories.snappad);
            renderStagedRecordsTable();
        }
        
        function renderStagedRecordsTableHeader() {
            const headers = currentLang === 'es' ? STAGED_RECORDS_HEADERS_ES : STAGED_RECORDS_HEADERS;
            initTableFilters('stagedRecords');
            initHiddenColumns('stagedRecords');
            document.getElementById('stagedRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('stagedRecords', colKey)) return '';
                return createFilterHeader('stagedRecords', colKey, h, true);
            }).join('');
        }
        
        function renderStagedRecordsTable() {
            if (!stagedRecordsLoaded) {
                document.getElementById('stagedRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('stagedRecordsRowCount').textContent = '-';
                return;
            }
            if (stagedRecordsData.length === 0) {
                document.getElementById('stagedRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('stagedRecordsRowCount').textContent = '0';
                return;
            }
            
            renderStagedRecordsTableHeader();
            const headers = STAGED_RECORDS_HEADERS;
            let data = [...stagedRecordsData];
            
            // Category filter
            data = data.filter(row => stagedRecordsFilters.categories[getStagedRecordsCategory(row)] || getStagedRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('stagedRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('stagedRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (stagedRecordsSort.field !== null) {
                const colIndex = parseInt(stagedRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return stagedRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return stagedRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('stagedRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('stagedRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('stagedRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links - handle arrays of URLs
                    if (h.includes('Pictures')) {
                        if (Array.isArray(val) && val.length > 0) {
                            val = val.map((url, idx) => `<a href="${url}" target="_blank" style="color:var(--accent);margin-right:4px;">ðŸ“·${val.length > 1 ? (idx + 1) : ''}</a>`).join('');
                        } else if (typeof val === 'string' && val.includes('http')) {
                            val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                        } else {
                            val = '-';
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('stagedRecords');
        }
        
        function sortStagedRecordsTable(field) {
            if (stagedRecordsSort.field === field) {
                stagedRecordsSort.asc = !stagedRecordsSort.asc;
            } else {
                stagedRecordsSort.field = field;
                stagedRecordsSort.asc = true;
            }
            renderStagedRecordsTable();
        }
        
        function filterStagedRecordsTable() { renderStagedRecordsTable(); }
        
        function getUniqueStagedRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = STAGED_RECORDS_HEADERS[colIndex];
            const values = new Set();
            stagedRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportStagedRecordsToCSV() {
            const headers = currentLang === 'es' ? STAGED_RECORDS_HEADERS_ES : STAGED_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = stagedRecordsData.map(row => 
                STAGED_RECORDS_HEADERS.map(h => {
                    let val = row[h];
                    if (val === undefined || val === null) return '""';
                    // Handle arrays by joining with semicolon
                    if (Array.isArray(val)) val = val.join('; ');
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `staged_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // AI ASSISTANT â€” Gemini Integration
        // ============================================================
        // Key split to avoid automated leak detection on public repos
        const _gk = ['AIza','SyCQ','iYrn','1yOk','B7RF','A683','NyW6','pl_7','TtXL','rEU'];
        const GEMINI_API_KEY = _gk.join('');
        const GEMINI_MODELS = [
            'gemini-2.5-flash',
            'gemini-2.0-flash',
            'gemini-2.0-flash-lite'
        ];
        let aiChatOpen = false;
        let aiChatHistory = []; // {role:'user'|'model', parts:[{text}]}
        let aiCurrentModel = 0;
        let aiIsBusy = false;

        // Build the system instruction that teaches Gemini our domain
        function buildAiSystemInstruction() {
            return `You are **Phil**, an AI assistant embedded in the Molding Operations Dashboard for Entech Industries (Roll Tech division) in Elkhart, Indiana. You help production staff with orders, inventory, and shipping questions.

**LANGUAGE RULE (CRITICAL):** 
- ALWAYS detect the language of the user's message
- If the user writes in ENGLISH â†’ respond ONLY in English
- If the user writes in SPANISH â†’ respond ONLY in Spanish
- NEVER mix languages
- Table headers and labels MUST match the user's language (English: "Part", "In Stock" / Spanish: "Parte", "Cantidad en Stock")

---

## COMPANY OVERVIEW

**Entech Industries** recycles tires and manufactures molded rubber products:
1. **Roll Tech** â€” Molded rubber wheels/casters for material handling (PRIMARY)
2. **Molding** â€” General rubber products (mats, pads, bumpers)
3. **Snap Pad** â€” Railroad crossing pads

**Production Process:** Scrap tires â†’ Shred into crumb rubber â†’ Mold into products using hydraulic presses

---

## PRODUCT STRUCTURE (CRITICAL FOR UNDERSTANDING PARTS)

### Roll Tech Wheels = Tire + Hub + Bearings
A complete wheel has 3 main components:
- **Tire** (outer rubber ring) â€” molded from crumb rubber + urethane coating
- **Hub** (center piece) â€” injection molded plastic
- **Bearings** (optional) â€” press-fit into hub

### Part Number Decoding: \`6XX.YYY.ZZZZ\`
- **6** = Roll Tech prefix
- **XX** = Hub series (16=VSP, 18/19/20=SNL Snap Lock)
- **YYY** = Tire size (163, 201, 254, 261, 308, 405)
- **ZZZZ** = Hub specification

**Examples:**
- \`619.308.2211\` = SNL hub series 19, Tire 308, 22mm bore, style 11
- \`616.261.191\` = VSP hub series 16, Tire 261, 19mm bore

### Tire Sizes (from BOM)
| Tire | Weight (lbs) | Parts/Hour |
|------|--------------|------------|
| 163 | 1.2 | 54 |
| 201 | 2.0 | 54 |
| 254 | 5.0 | 42 |
| 261 | 2.3 | 24 |
| 308 | 4.4 | 31 |
| 405 | 10.6 | 7 |

### Hub Part Numbers: \`HXX.YYY.ZZZZC\`
- H = Hub prefix
- XX = Series (16, 18, 19, 20)
- YYY = Bore size (170=17mm, 190=19mm, 220=22mm)
- ZZZZ = Diameter/style
- C = Color (B=Black, G=Gray)

**Example:** \`H19.170.22100B\` = Series 19, 17mm shaft, 100mm diameter, Black

---

## DEPARTMENTS & WORKFLOW

**Production Areas:**
1. **Tire Molding** â€” Hydraulic presses make tires (cycle time varies by size)
2. **Hub Molding** â€” Injection machines make plastic hubs
3. **Assembly** â€” Workers combine tire + hub + bearings + small parts (~37/hour/worker)
4. **Staging** â€” Packed pallets weighed, photographed, marked ready
5. **Shipping** â€” Loads trucks, updates status to shipped

---

## ORDER STATUS FLOW

\`\`\`
PENDING â†’ WIP (Making) â†’ STAGED (Ready to Ship) â†’ SHIPPED
\`\`\`

| Status | Meaning | Dashboard Section |
|--------|---------|-------------------|
| pending | Order received, not started | Need to Make |
| wip | Being manufactured on press | Making |
| staged | Packed on pallets, ready to ship | Ready to Ship |
| shipped | Sent to customer | Shipped |

**Overdue:** Days Until < 0 (NEGATIVE = late!)
**Priority:** 1 = highest urgency; Urgent flag overrides priority number

---

## INVENTORY LOGIC

### Checking if Order Can Be Made (Roll Tech)
For a wheel order, you need BOTH:
- **Tire** in stock (check tire component inventory)
- **Hub** in stock (check hub component inventory)

**Fields:**
- \`Have Tire?\` â€” Tire component available
- \`Have Hub?\` â€” Hub component available
- \`Enough Inventory\` â€” Both components ready

### Inventory Status
- **Good** (Green): Fusion Qty â‰¥ Minimum
- **Low** (Yellow): Fusion Qty < Minimum but > 0
- **Out** (Red): Fusion Qty = 0

---

## DATA YOU HAVE ACCESS TO

### 1. Production Orders (allData) â€” ~${allData.length} orders
Key fields: Category, Line, IF#, PO#, Customer, Part#, Order Qty, Status, Priority, Urgent, Days Until, Assigned to, Tire, Hub, Have Tire?, Have Hub?

### 2. Inventory (inventoryData) â€” ~${inventoryData.length} items
Key fields: Part Number, Fusion Qty, Minimum, Manual Target, Parts to Make, Mold Type

### 3. Pallet Records â€” ${palletRecordsData.length} records
Pallets packed with photos and measurements.

---

## FINANCIAL DATA ACCESS
${salesUnlocked ? 'âœ… Sales & Finance UNLOCKED. You can answer questions about revenue, P/L, costs, margins.' : 'ðŸ”’ Sales & Finance LOCKED. If asked about revenue, profit, costs, or margins, say: "Financial data is locked. Please unlock Sales & Finance first." Do NOT guess or reveal financial figures.'}

---

## ACCURACY RULES (CRITICAL)

1. **Use ONLY the STATISTICS section** for counts â€” never estimate
2. When asked "how many orders for Part X?" â†’ find exact count in statistics
3. **Double-check:** If you say "Found 5 orders," list exactly 5 rows
4. If unsure, list items in a table and count the rows you show
5. For Roll Tech parts, remember to check BOTH tire AND hub components

---

## RESPONSE STYLE

- **Be concise** â€” production floor tool, not chatbot
- Use **tables** for multiple items
- Include **counts** ("Found 3 orders:")
- Orders: show Line, Customer, Part#, Qty, Status, Days Until
- Inventory: show Part#, Fusion Qty, Minimum, Status
- Numbers: use commas (1,234)
- Dates: MM/DD/YYYY
- **Spanish terms:** pendiente (pending), fabricando (wip), listo (staged), enviado (shipped), atrasado (overdue)

---

## TABLE FORMATTING (CRITICAL)

**NEVER leave tables incomplete!** This is a critical rule.

1. **Always include data rows** â€” If you start a table, you MUST include the data rows. Never show just headers.
2. **Complete the table** â€” Every table must have: header row + separator + data rows
3. **If too many rows (>15)** â€” Show top 10-15, then say "...and X more" with a summary
4. **Verify before sending** â€” Before finishing your response, check: Did I include the actual data in the table?
5. **Markdown table format:**
   \`\`\`
   | Header1 | Header2 | Header3 |
   |---------|---------|---------|
   | data1   | data2   | data3   |
   | data1   | data2   | data3   |
   \`\`\`

**BAD (never do this):**
| LÃ­nea | Cliente | Parte |
|-------|---------|-------|
(no data rows â€” WRONG!)

**GOOD:**
| LÃ­nea | Cliente | Parte |
|-------|---------|-------|
| 2557 | Schaefer | 619.308.2211 |
| 2558 | TBC | 620.254.1911 |

---

## PERSONALITY: When You Can't Answer

If someone asks something outside your knowledge (not about orders, inventory, production, shipping), respond with **humor** but redirect to what you CAN help with. Be friendly and funny!

**Example responses for off-topic questions:**
- "I could answer that, but then I'd have to charge you consulting fees ðŸ˜„ How about we stick to production stuff?"
- "That's the ONE question in the universe I can't answer! But ask me about late orders and I'm your guy ðŸ“¦"
- "My expertise is wheels, not [topic]. But hey, want to know which orders are overdue?"
- "Hmm, my brain is 100% molded rubber and inventory data. Try me on something production-related!"
- "I specialize in tires and hubs, not [topic]. But I CAN tell you if we have enough 308s in stock! ðŸ›ž"

**In Spanish:**
- "Â¡Esa es la ÃšNICA pregunta que no puedo contestar! Pero pregÃºntame sobre Ã³rdenes atrasadas ðŸ“¦"
- "Mi cerebro es 100% hule moldeado y datos de inventario. Â¡PregÃºntame algo de producciÃ³n!"

Always end by redirecting to something production-related. Be helpful AND fun!`;
        }

        // Pre-compute statistics for AI accuracy
        function buildAiStatistics() {
            let stats = '\\n## PRE-COMPUTED STATISTICS (use these for counts â€” do NOT count rows manually)\\n';

            if (allData.length === 0) return stats + 'No order data loaded.\\n';

            // Overall counts
            const statusCounts = { pending: 0, wip: 0, staged: 0, shipped: 0 };
            const catCounts = { rolltech: 0, molding: 0, snappad: 0, other: 0 };
            const byPart = {};
            const byCustomer = {};
            const overdueOrders = [];
            const urgentOrders = [];

            allData.forEach(row => {
                const status = getStatus(row);
                const cat = getCategory(row);
                const part = (getVal(row, 'PART') || '-').toString().trim();
                const cust = (getVal(row, 'CUSTOMER') || '-').toString().trim();
                const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                const line = getVal(row, 'LINE') || '-';
                const urgent = (getVal(row, 'URGENT') || '').toString().toLowerCase().trim();
                const isUrgent = urgent === 'urgent' || urgent === 'true' || urgent === '1' || urgent === 'yes' || urgent === 'x';

                if (statusCounts[status] !== undefined) statusCounts[status]++;
                if (catCounts[cat] !== undefined) catCounts[cat]++;
                else catCounts.other++;

                // By Part
                if (!byPart[part]) byPart[part] = { total: 0, pending: 0, wip: 0, staged: 0, shipped: 0, totalQty: 0, customers: new Set() };
                byPart[part].total++;
                if (byPart[part][status] !== undefined) byPart[part][status]++;
                byPart[part].totalQty += parseNumber(getVal(row, 'QTY')) || 0;
                byPart[part].customers.add(cust);

                // By Customer
                if (!byCustomer[cust]) byCustomer[cust] = { total: 0, pending: 0, wip: 0, staged: 0, shipped: 0, totalQty: 0, parts: new Set() };
                byCustomer[cust].total++;
                if (byCustomer[cust][status] !== undefined) byCustomer[cust][status]++;
                byCustomer[cust].totalQty += parseNumber(getVal(row, 'QTY')) || 0;
                byCustomer[cust].parts.add(part);

                // Overdue
                if (days < 0 && status !== 'shipped') overdueOrders.push({ line, part, cust, days, status });
                // Urgent
                if (isUrgent) urgentOrders.push({ line, part, cust, status });
            });

            // Overall summary
            const activeTotal = statusCounts.pending + statusCounts.wip + statusCounts.staged;
            stats += `\\n### Overall: ${allData.length} total orders (${activeTotal} active, ${statusCounts.shipped} shipped)\\n`;
            stats += `Status breakdown: pending=${statusCounts.pending}, wip=${statusCounts.wip}, staged=${statusCounts.staged}, shipped=${statusCounts.shipped}\\n`;
            stats += `Category breakdown: RollTech=${catCounts.rolltech}, Molding=${catCounts.molding}, SnapPad=${catCounts.snappad}\\n`;
            stats += `Overdue orders (active, DaysUntil < 0): ${overdueOrders.length}\\n`;
            stats += `Urgent orders: ${urgentOrders.length}\\n`;

            // Per-part summary
            stats += `\\n### Orders by Part Number (${Object.keys(byPart).length} unique parts):\\n`;
            Object.entries(byPart).sort((a, b) => b[1].total - a[1].total).forEach(([part, d]) => {
                const custList = Array.from(d.customers).join(', ');
                stats += `Part ${part}: ${d.total} orders (pending=${d.pending}, wip=${d.wip}, staged=${d.staged}, shipped=${d.shipped}) | TotalQty=${d.totalQty.toLocaleString()} | Customers: ${custList}\\n`;
            });

            // Per-customer summary
            stats += `\\n### Orders by Customer (${Object.keys(byCustomer).length} unique customers):\\n`;
            Object.entries(byCustomer).sort((a, b) => b[1].total - a[1].total).forEach(([cust, d]) => {
                const partList = Array.from(d.parts).join(', ');
                stats += `Customer ${cust}: ${d.total} orders (pending=${d.pending}, wip=${d.wip}, staged=${d.staged}, shipped=${d.shipped}) | TotalQty=${d.totalQty.toLocaleString()} | Parts: ${partList}\\n`;
            });

            // Overdue details
            if (overdueOrders.length > 0) {
                stats += `\\n### Overdue Orders (${overdueOrders.length} total):\\n`;
                overdueOrders.sort((a, b) => a.days - b.days).forEach(o => {
                    stats += `Line ${o.line}: Part=${o.part} | Customer=${o.cust} | ${Math.abs(o.days)} days overdue | Status=${o.status}\\n`;
                });
            }

            // Inventory stats
            if (inventoryData.length > 0) {
                const lowItems = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
                const okItems = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
                stats += `\\n### Inventory: ${inventoryData.length} items total, ${lowItems.length} LOW (below minimum), ${okItems.length} OK\\n`;
                if (lowItems.length > 0) {
                    stats += `Low inventory items:\\n`;
                    lowItems.sort((a, b) => (a.fusionQty / (a.minimum || 1)) - (b.fusionQty / (b.minimum || 1))).forEach(i => {
                        stats += `Part ${i.partNumber}: Qty=${i.fusionQty} / Min=${i.minimum} (${i.minimum > 0 ? Math.round(i.fusionQty / i.minimum * 100) : 0}% of minimum)\\n`;
                    });
                }
            }

            return stats;
        }

        // Build compact data context string from live dashboard data
        function buildAiDataContext() {
            let ctx = '';
            const hasSalesAccess = salesUnlocked === true;

            // Pre-computed statistics (Option 1: helps AI avoid miscounting)
            ctx += buildAiStatistics();

            // Raw orders data
            if (allData.length > 0) {
                ctx += '\\n## Raw Orders Data (for detailed lookups)\\n';
                allData.forEach((row, i) => {
                    const line = getVal(row, 'LINE') || '-';
                    const cust = getVal(row, 'CUSTOMER') || '-';
                    const part = getVal(row, 'PART') || '-';
                    const qty = getVal(row, 'QTY') || '-';
                    const status = getStatus(row);
                    const cat = getCategory(row);
                    const days = getVal(row, 'DAYS_UNTIL');
                    const ifNum = getVal(row, 'IF_NUM') || '-';
                    const poNum = getVal(row, 'PO_NUM') || '-';
                    const priority = getVal(row, 'PRIORITY') || '-';
                    const urgent = getVal(row, 'URGENT') || '';
                    const assigned = getVal(row, 'ASSIGNED') || '-';
                    const tire = getVal(row, 'TIRE') || '';
                    const hub = getVal(row, 'HUB') || '';
                    const bearings = getVal(row, 'BEARINGS') || '';
                    const dueDate = getVal(row, 'REQUESTED_DATE') || '-';
                    const enoughInv = getVal(row, 'ENOUGH_INV') || '';
                    const haveTire = getVal(row, 'HAVE_TIRE') || '';
                    const haveHub = getVal(row, 'HAVE_HUB') || '';
                    let orderLine = `Order ${i+1}: Line=${line} | IF#=${ifNum} | PO#=${poNum} | Customer=${cust} | Part=${part} | Qty=${qty} | Status=${status} | Category=${cat} | Priority=${priority} | Urgent=${urgent} | DaysUntil=${days} | DueDate=${dueDate} | Assigned=${assigned} | Tire=${tire} | Hub=${hub} | Bearings=${bearings} | EnoughInv=${enoughInv} | HaveTire=${haveTire} | HaveHub=${haveHub}`;
                    // Only include financial data if sales section is unlocked
                    if (hasSalesAccess) {
                        const revenue = getVal(row, 'REVENUE') || '';
                        const pl = getVal(row, 'PL') || '';
                        const plTotal = row[COL.PL_TOTAL] || '';
                        const varCost = row[COL.VARIABLE_COST] || '';
                        const totalCost = row[COL.TOTAL_COST] || '';
                        orderLine += ` | Revenue=${revenue} | P/L=${pl} | P/L_Total=${plTotal} | VariableCost=${varCost} | TotalCost=${totalCost}`;
                    }
                    ctx += orderLine + '\\n';
                });
            }
            // Inventory data
            if (inventoryData.length > 0) {
                ctx += '\\n## Raw Inventory Data (for detailed lookups)\\n';
                inventoryData.forEach((item, i) => {
                    const status = item.fusionQty < item.minimum ? 'LOW' : (item.fusionQty >= (item.manualTarget || item.minimum) ? 'OK' : 'WATCH');
                    ctx += `Inv ${i+1}: Part=${item.partNumber} | Product=${item.product} | FusionQty=${item.fusionQty} | Min=${item.minimum} | Target=${item.manualTarget || '-'} | QtyNeeded=${item.qtyNeeded} | ToMake=${item.partsToBeMade} | MoldType=${item.moldType || '-'} | Status=${status}\\n`;
                });
            }
            // Pallet summary (compact)
            if (palletRecordsData && palletRecordsData.length > 0) {
                ctx += `\\n## Pallet Records: ${palletRecordsData.length} total records available\\n`;
            }
            return ctx;
        }

        // Option 3: Pre-filter data based on user query to give AI targeted results
        function buildQueryHelper(userMessage) {
            const msg = userMessage.toLowerCase();
            let helper = '';

            // Detect part number mentions (patterns like 620.308.2211, FS-TPO, THRESH-1.5, etc.)
            const partPatterns = msg.match(/\b[\d]{3}[\.\-][\d]{3}[\.\-][\d]{3,}[\w]*/gi) || [];
            const partWords = msg.match(/\b(?:fs|sp|spo|spec|spcf|spef|thresh|rubb|earthedge|padasm)[\-\w]+/gi) || [];
            const allPartMentions = [...partPatterns, ...partWords];

            if (allPartMentions.length > 0) {
                allPartMentions.forEach(searchPart => {
                    const sp = searchPart.toLowerCase();
                    const matchingOrders = allData.filter(row => {
                        const part = (getVal(row, 'PART') || '').toString().toLowerCase();
                        return part.includes(sp) || sp.includes(part);
                    });
                    const matchingInv = inventoryData.filter(item => {
                        const part = (item.partNumber || '').toLowerCase();
                        return part.includes(sp) || sp.includes(part);
                    });
                    if (matchingOrders.length > 0 || matchingInv.length > 0) {
                        helper += `\\n[QUERY HELPER â€” pre-filtered results for "${searchPart}"]\\n`;
                        if (matchingOrders.length > 0) {
                            helper += `Matching orders: exactly ${matchingOrders.length} found\\n`;
                            matchingOrders.forEach((row, i) => {
                                helper += `  ${i+1}. Line=${getVal(row,'LINE')} | IF#=${getVal(row,'IF_NUM')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | Qty=${getVal(row,'QTY')} | Status=${getStatus(row)} | DaysUntil=${getVal(row,'DAYS_UNTIL')}\\n`;
                            });
                        }
                        if (matchingInv.length > 0) {
                            helper += `Matching inventory: exactly ${matchingInv.length} found\\n`;
                            matchingInv.forEach((item, i) => {
                                helper += `  ${i+1}. Part=${item.partNumber} | FusionQty=${item.fusionQty} | Min=${item.minimum} | Status=${item.fusionQty < item.minimum ? 'LOW' : 'OK'}\\n`;
                            });
                        }
                    }
                });
            }

            // Detect customer name mentions
            const knownCustomers = [...new Set(allData.map(r => (getVal(r, 'CUSTOMER') || '').toString().trim()).filter(Boolean))];
            knownCustomers.forEach(cust => {
                if (msg.includes(cust.toLowerCase())) {
                    const matchingOrders = allData.filter(row => (getVal(row, 'CUSTOMER') || '').toString().trim().toLowerCase() === cust.toLowerCase());
                    if (matchingOrders.length > 0) {
                        helper += `\\n[QUERY HELPER â€” pre-filtered results for customer "${cust}"]\\n`;
                        helper += `Matching orders: exactly ${matchingOrders.length} found\\n`;
                        matchingOrders.forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Part=${getVal(row,'PART')} | Qty=${getVal(row,'QTY')} | Status=${getStatus(row)} | DaysUntil=${getVal(row,'DAYS_UNTIL')}\\n`;
                        });
                    }
                }
            });

            // Detect status queries
            const statusTerms = { 'late': 'overdue', 'overdue': 'overdue', 'atrasad': 'overdue', 'retrasad': 'overdue', 'urgent': 'urgent', 'urgente': 'urgent' };
            Object.entries(statusTerms).forEach(([term, type]) => {
                if (msg.includes(term)) {
                    if (type === 'overdue') {
                        const overdue = allData.filter(row => {
                            const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                            return days < 0 && getStatus(row) !== 'shipped';
                        });
                        helper += `\\n[QUERY HELPER â€” overdue/late orders]\\n`;
                        helper += `Overdue active orders: exactly ${overdue.length} found\\n`;
                        overdue.sort((a, b) => parseNumber(getVal(a, 'DAYS_UNTIL')) - parseNumber(getVal(b, 'DAYS_UNTIL'))).forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | ${Math.abs(parseNumber(getVal(row,'DAYS_UNTIL')))} days overdue | Status=${getStatus(row)}\\n`;
                        });
                    }
                    if (type === 'urgent') {
                        const urgents = allData.filter(row => {
                            const u = (getVal(row, 'URGENT') || '').toString().toLowerCase().trim();
                            return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x';
                        });
                        helper += `\\n[QUERY HELPER â€” urgent orders]\\n`;
                        helper += `Urgent orders: exactly ${urgents.length} found\\n`;
                        urgents.forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | Status=${getStatus(row)}\\n`;
                        });
                    }
                }
            });

            return helper;
        }

        // Call Gemini API
        async function callGemini(userMessage) {
            const systemInstruction = buildAiSystemInstruction();
            const dataContext = buildAiDataContext();
            const queryHelper = buildQueryHelper(userMessage);

            // Add data context as first user message if not already there
            const contents = [];
            if (aiChatHistory.length === 0) {
                // First message â€” prepend data context + query helper
                contents.push({
                    role: 'user',
                    parts: [{ text: `Here is the current live data from the dashboard:\\n${dataContext}${queryHelper}\\n\\nMy question: ${userMessage}` }]
                });
            } else {
                // Subsequent messages â€” include history
                // Re-inject fresh data context with each turn for accuracy
                const firstMsg = {
                    role: 'user',
                    parts: [{ text: `[UPDATED LIVE DATA]\\n${dataContext}` }]
                };
                const firstResp = {
                    role: 'model',
                    parts: [{ text: 'Got it, I have the latest data.' }]
                };
                contents.push(firstMsg, firstResp);
                // Add prior conversation
                for (let i = 0; i < aiChatHistory.length; i++) {
                    contents.push(aiChatHistory[i]);
                }
                contents.push({ role: 'user', parts: [{ text: `${queryHelper}\\n\\n${userMessage}` }] });
            }

            let lastError = null;
            let errors = [];
            for (let m = aiCurrentModel; m < GEMINI_MODELS.length; m++) {
                const model = GEMINI_MODELS[m];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                try {
                    console.log(`[AI] Trying model: ${model}`);
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system_instruction: { parts: [{ text: systemInstruction }] },
                            contents: contents,
                            generationConfig: {
                                temperature: 0.3,
                                maxOutputTokens: 2048
                            }
                        })
                    });
                    if (resp.status === 429) {
                        console.warn(`[AI] ${model}: rate limited (429)`);
                        errors.push(`${model}: rate limited`);
                        lastError = 'rate_limit';
                        continue;
                    }
                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        const errMsg = errData.error?.message || `HTTP ${resp.status}`;
                        console.warn(`[AI] ${model}: error â€” ${errMsg}`);
                        errors.push(`${model}: ${errMsg}`);
                        lastError = new Error(errMsg);
                        continue;
                    }
                    const data = await resp.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) {
                        const blockReason = data.candidates?.[0]?.finishReason || data.promptFeedback?.blockReason || 'empty';
                        throw new Error(`No response (${blockReason})`);
                    }
                    console.log(`[AI] Success with ${model}`);
                    aiCurrentModel = m; // Stick with working model
                    return { text, model };
                } catch (e) {
                    console.warn(`[AI] ${model}: ${e.message}`);
                    errors.push(`${model}: ${e.message}`);
                    lastError = e;
                }
            }
            // All models failed
            aiCurrentModel = 0; // Reset for next attempt
            const allRateLimited = errors.every(e => e.includes('rate limited'));
            if (allRateLimited) {
                throw new Error('RATE_LIMIT');
            }
            throw new Error(errors.join(' â†’ '));
        }

        // Render markdown-ish text to HTML (simple parser)
        function renderAiMarkdown(text) {
            // --- Phase 1: Parse markdown tables as blocks BEFORE line-level processing ---
            text = text.replace(/((?:^\|.+\n?)+)/gm, (tableBlock) => {
                const lines = tableBlock.trim().split('\n').filter(l => l.trim());
                if (lines.length < 2) return tableBlock;
                // Find separator row (line of |---|---|)
                const sepIdx = lines.findIndex((l, i) => i > 0 && /^\|[\s:|-]+\|?\s*$/.test(l.trim()));
                if (sepIdx < 1) return tableBlock; // No separator = not a real table
                const parseCells = (line) => {
                    let l = line.trim();
                    if (l.startsWith('|')) l = l.slice(1);
                    if (l.endsWith('|')) l = l.slice(0, -1);
                    return l.split('|').map(c => c.trim());
                };
                const headerRows = lines.slice(0, sepIdx);
                const bodyRows = lines.slice(sepIdx + 1).filter(l => l.trim() && /\|/.test(l));
                let t = '<div class="ai-table-wrap"><table>';
                t += '<thead>';
                headerRows.forEach(r => {
                    t += '<tr>' + parseCells(r).map(c => `<th>${c}</th>`).join('') + '</tr>';
                });
                t += '</thead>';
                if (bodyRows.length) {
                    t += '<tbody>';
                    bodyRows.forEach(r => {
                        t += '<tr>' + parseCells(r).map(c => `<td>${c}</td>`).join('') + '</tr>';
                    });
                    t += '</tbody>';
                }
                t += '</table></div>';
                return '\n' + t + '\n';
            });

            // --- Phase 2: Inline markdown ---
            let html = text
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^### (.*$)/gm, '<strong style="font-size:14px;display:block;margin:8px 0 4px;">$1</strong>')
                .replace(/^## (.*$)/gm, '<strong style="font-size:15px;display:block;margin:10px 0 4px;">$1</strong>')
                .replace(/^[-â€¢]\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>')
                .replace(/\n/g, '<br>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.*?<\/li><br>?)+)/g, (match) => {
                return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
            });

            // Clean up extra <br> around block elements
            html = html.replace(/<\/(table|ul|ol|pre|div)><br>/g, '</$1>');
            html = html.replace(/<br><(div class="ai-table-wrap")/g, '<$1');

            return html;
        }

        // Toggle chat panel
        function toggleAiChat() {
            aiChatOpen = !aiChatOpen;
            document.getElementById('aiChatPanel').classList.toggle('open', aiChatOpen);
            document.getElementById('aiChatFab').classList.toggle('hidden', aiChatOpen);
            if (aiChatOpen) {
                initAiChat();
                setTimeout(() => document.getElementById('aiChatInput').focus(), 300);
            }
        }

        // ============================================
        // VOICE INPUT (Web Speech API)
        // ============================================
        let voiceRecognition = null;
        let isListening = false;
        let voiceAutoSend = false; // true = auto-send after speech, false = edit mode
        
        function initVoiceRecognition() {
            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log('[Voice] Speech recognition not supported');
                document.getElementById('aiVoiceBtn').style.display = 'none';
                return;
            }
            
            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = true;
            voiceRecognition.interimResults = true;
            voiceRecognition.lang = currentLang === 'es' ? 'es-MX' : 'en-US';
            
            voiceRecognition.onstart = () => {
                console.log('[Voice] Started listening, autoSend:', voiceAutoSend);
                isListening = true;
                document.getElementById('aiVoiceBtn').classList.add('listening');
                document.getElementById('aiVoiceStatus').classList.add('visible');
                document.getElementById('aiVoiceStatus').textContent = voiceAutoSend 
                    ? (currentLang === 'es' ? 'ðŸš€ Auto-enviar' : 'ðŸš€ Auto-send')
                    : (currentLang === 'es' ? 'âœï¸ Editar' : 'âœï¸ Edit');
            };
            
            voiceRecognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                // Build complete transcript from all results
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show accumulated final + current interim
                const input = document.getElementById('aiChatInput');
                const displayText = (finalTranscript + interimTranscript).trim();
                input.value = displayText;
                // Auto-resize textarea
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 150) + 'px';
                document.getElementById('aiVoiceStatus').textContent = currentLang === 'es' ? 'Escuchando...' : 'Listening...';
                console.log('[Voice] Transcript:', displayText.substring(0, 50) + '...');
            };
            
            voiceRecognition.onerror = (event) => {
                console.log('[Voice] Error:', event.error);
                stopVoiceInput();
                if (event.error === 'not-allowed') {
                    alert(currentLang === 'es' ? 'Permiso de micrÃ³fono denegado. Por favor permite el acceso al micrÃ³fono.' : 'Microphone permission denied. Please allow microphone access.');
                }
            };
            
            voiceRecognition.onend = () => {
                console.log('[Voice] Ended, autoSend:', voiceAutoSend);
                stopVoiceInput();
                const input = document.getElementById('aiChatInput');
                if (voiceAutoSend && input.value.trim()) {
                    // Auto-send mode (long press)
                    setTimeout(() => sendAiMessage(), 300);
                } else {
                    // Edit mode (tap) - focus input so user can edit
                    input.focus();
                    input.selectionStart = input.selectionEnd = input.value.length;
                }
            };
        }
        
        function toggleVoiceMode() {
            voiceAutoSend = !voiceAutoSend;
            const toggle = document.getElementById('aiVoiceModeToggle');
            if (voiceAutoSend) {
                toggle.classList.add('auto-send');
                toggle.textContent = 'ðŸš€';
                toggle.title = 'Auto-send ON (tap to switch to edit mode)';
            } else {
                toggle.classList.remove('auto-send');
                toggle.textContent = 'âœï¸';
                toggle.title = 'Edit mode (tap to switch to auto-send)';
            }
            console.log('[Voice] Mode toggled, autoSend:', voiceAutoSend);
        }
        
        function toggleVoiceInput() {
            console.log('[Voice] toggleVoiceInput called, autoSend:', voiceAutoSend);
            
            // Check browser support first
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log('[Voice] Not supported in this browser');
                alert(currentLang === 'es' ? 'Entrada de voz no soportada en este navegador. Usa Chrome o Safari.' : 'Voice input not supported in this browser. Use Chrome or Safari.');
                return;
            }
            
            if (!voiceRecognition) {
                initVoiceRecognition();
                if (!voiceRecognition) {
                    console.log('[Voice] Failed to initialize');
                    return;
                }
            }
            
            // Update language based on current setting
            voiceRecognition.lang = currentLang === 'es' ? 'es-MX' : 'en-US';
            console.log('[Voice] Language set to:', voiceRecognition.lang);
            
            if (isListening) {
                console.log('[Voice] Stopping...');
                voiceRecognition.stop();
            } else {
                console.log('[Voice] Starting...');
                document.getElementById('aiChatInput').value = '';
                try {
                    voiceRecognition.start();
                } catch (e) {
                    console.error('[Voice] Start error:', e);
                    alert(currentLang === 'es' ? 'Error al iniciar el micrÃ³fono: ' + e.message : 'Error starting microphone: ' + e.message);
                }
            }
        }
        
        function stopVoiceInput() {
            isListening = false;
            document.getElementById('aiVoiceBtn').classList.remove('listening');
            document.getElementById('aiVoiceStatus').classList.remove('visible');
        }

        // Initialize chat UI
        function initAiChat() {
            const welcomeMsg = document.getElementById('aiWelcomeMsg');
            if (welcomeMsg && !welcomeMsg.dataset.init) {
                welcomeMsg.textContent = t('ai.welcome');
                welcomeMsg.dataset.init = '1';
                // Render suggestion chips
                renderAiSuggestions();
            }
        }

        function renderAiSuggestions() {
            const container = document.getElementById('aiSuggestions');
            container.innerHTML = '';
            ['ai.suggestion1', 'ai.suggestion2', 'ai.suggestion3', 'ai.suggestion4'].forEach(key => {
                const chip = document.createElement('div');
                chip.className = 'ai-suggestion-chip';
                chip.textContent = t(key);
                chip.onclick = () => {
                    document.getElementById('aiChatInput').value = t(key);
                    sendAiMessage();
                };
                container.appendChild(chip);
            });
        }

        // Send a message
        async function sendAiMessage() {
            if (aiIsBusy) return;
            const input = document.getElementById('aiChatInput');
            const msg = input.value.trim();
            if (!msg) return;

            // Check data loaded
            if (allData.length === 0 && inventoryData.length === 0) {
                appendAiMessage(t('ai.noData'), 'system');
                return;
            }

            input.value = '';
            aiIsBusy = true;
            document.getElementById('aiSendBtn').disabled = true;
            document.getElementById('aiSuggestions').style.display = 'none';

            // Show user message
            appendAiMessage(msg, 'user');

            // Show typing indicator
            const typingEl = showAiTyping();

            try {
                const result = await callGemini(msg);
                // Save to history
                aiChatHistory.push({ role: 'user', parts: [{ text: msg }] });
                aiChatHistory.push({ role: 'model', parts: [{ text: result.text }] });
                // Remove typing, show response
                typingEl.remove();
                appendAiMessage(result.text, 'bot');
            } catch (e) {
                typingEl.remove();
                if (e.message === 'RATE_LIMIT') {
                    appendAiMessage(t('ai.rateLimit'), 'error');
                } else {
                    appendAiMessage(`${t('ai.error')}\n${e.message}`, 'error');
                }
            } finally {
                aiIsBusy = false;
                document.getElementById('aiSendBtn').disabled = false;
                input.focus();
            }
        }

        function appendAiMessage(text, type) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = `ai-msg ${type}`;
            if (type === 'bot') {
                div.innerHTML = renderAiMarkdown(text);
            } else {
                div.textContent = text;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showAiTyping() {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = 'ai-typing';
            div.innerHTML = '<div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function clearAiChat() {
            aiChatHistory = [];
            aiCurrentModel = 0;
            const container = document.getElementById('aiChatMessages');
            container.innerHTML = '<div class="ai-msg system" id="aiWelcomeMsg"></div>';
            document.getElementById('aiWelcomeMsg').textContent = t('ai.welcome');
            document.getElementById('aiWelcomeMsg').dataset.init = '1';
            document.getElementById('aiSuggestions').style.display = 'flex';
            renderAiSuggestions();
            appendAiMessage(t('ai.cleared'), 'system');
        }

        // Update AI chat text when language changes
        function updateAiLanguage() {
            const welcomeMsg = document.getElementById('aiWelcomeMsg');
            if (welcomeMsg && welcomeMsg.dataset.init) {
                welcomeMsg.textContent = t('ai.welcome');
            }
            const input = document.getElementById('aiChatInput');
            if (input) input.placeholder = t('ai.placeholder');
            const title = document.querySelector('.ai-chat-header .ai-title');
            if (title) title.textContent = t('ai.title');
            const subtitle = document.querySelector('.ai-chat-header .ai-subtitle');
            if (subtitle) subtitle.textContent = t('ai.subtitle');
            renderAiSuggestions();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedZoom();
            loadSavedTheme();
            loadDashboard();
        });
    </script>
<!-- QR Code Share Modal -->
    <div id="qrShareModal" class="qr-modal" style="display:none;">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h3>ðŸ“± Share Dashboard</h3>
                <button class="qr-close-btn" onclick="closeQrModal()">&times;</button>
            </div>
            <div class="qr-modal-body">
                <p style="margin-bottom:15px;color:var(--text-muted);font-size:14px;">Scan to open on another device:</p>
                <img id="qrCodeImage" src="" alt="QR Code" style="width:200px;height:200px;border-radius:8px;background:white;padding:10px;">
                <p id="qrUrlDisplay" style="margin-top:15px;font-size:12px;color:var(--text-muted);word-break:break-all;max-width:280px;"></p>
            </div>
        </div>
    </div>

<!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <div class="mobile-bottom-nav-inner">
            <a class="mobile-nav-item" onclick="showQrModal()" id="mobileShareBtn">
                <span class="nav-icon">ðŸ“¤</span>
                <span class="nav-label">Share</span>
            </a>
            <a class="mobile-nav-item" onclick="toggleMobileTheme()" id="mobileThemeBtn">
                <span class="nav-icon" id="mobileThemeIcon">ðŸŒ™</span>
                <span class="nav-label" id="mobileThemeLabel">Dark</span>
            </a>
            <a class="mobile-nav-item" onclick="toggleMobileLang()" id="mobileLangBtn">
                <span class="nav-icon">ðŸŒ</span>
                <span class="nav-label" id="mobileLangLabel">EN</span>
            </a>
            <a class="mobile-nav-item active" data-page="orders-queue" onclick="mobileNavTo('orders-queue')">
                <span class="nav-icon">ðŸ“‹</span>
                <span class="nav-label">Orders</span>
            </a>
            <a class="mobile-nav-item" data-page="orders-staged" onclick="mobileNavTo('orders-staged')">
                <span class="nav-icon">ðŸ“¦</span>
                <span class="nav-label">Staged</span>
            </a>
            <a class="mobile-nav-item" data-page="inventory" onclick="mobileNavTo('inventory')">
                <span class="nav-icon">ðŸ­</span>
                <span class="nav-label">Inventory</span>
            </a>
            <a class="mobile-nav-item" onclick="toggleAiChat()">
                <span class="nav-icon">ðŸ¤–</span>
                <span class="nav-label">Phil</span>
            </a>
        </div>
    </nav>

    <script>
    // ============================================================
    // MOBILE MODE FUNCTIONS
    // ============================================================
    
    // Auto-enable mobile/tablet mode based on screen size and orientation
    function checkMobileMode() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        const isPortrait = height > width;
        
        // iPhone: width <= 480px
        const isMobile = width <= 480;
        
        // iPad Portrait: 481-1024px in portrait orientation
        // Also trigger on width 768-834 which is common iPad portrait widths
        const isTabletPortrait = (width > 480 && width <= 1024 && isPortrait) || 
                                  (width >= 768 && width <= 834);
        
        // Small landscape (iPhone landscape)
        const isSmallLandscape = width <= 900 && !isPortrait;
        
        console.log('[MobileMode] width:', width, 'height:', height, 'portrait:', isPortrait, 'mobile:', isMobile, 'tablet-portrait:', isTabletPortrait, 'small-landscape:', isSmallLandscape);
        
        document.body.classList.toggle('mobile-mode', isMobile);
        document.body.classList.toggle('tablet-portrait', isTabletPortrait);
        
        // Auto-collapse sidebar when entering portrait/mobile/small-landscape mode
        if (isMobile || isTabletPortrait || isSmallLandscape) {
            const sidebar = document.querySelector('.sidebar');
            const tabBtn = document.getElementById('sidebarTabBtn');
            const bottomNav = document.getElementById('mobileBottomNav');
            if (sidebar) sidebar.classList.add('collapsed');
            if (tabBtn) tabBtn.classList.add('visible'); // Show menu button
            if (bottomNav && (isMobile || isTabletPortrait)) bottomNav.style.display = 'block';
            
            // Force render cards after mode change (with delay for data) - only for portrait modes
            if (isMobile || isTabletPortrait) {
                setTimeout(() => {
                    if (typeof forceRenderCards === 'function') forceRenderCards();
                }, 500);
            }
        }
        
        return isMobile || isTabletPortrait;
    }
    
    // Force render cards for current page
    function forceRenderCards() {
        console.log('[Cards] Force rendering...');
        const pages = ['orders-queue', 'orders-staged', 'inventory'];
        
        // Render for orders-queue
        if (typeof renderMobileOrderCards === 'function') {
            renderMobileOrderCards('orders-queue');
            console.log('[Cards] Rendered orders-queue');
        }
        
        // Render for staged
        if (typeof renderMobileStagedCards === 'function') {
            renderMobileStagedCards();
            console.log('[Cards] Rendered staged');
        }
        
        // Render for inventory
        if (typeof renderMobileInventoryCards === 'function') {
            renderMobileInventoryCards();
            console.log('[Cards] Rendered inventory');
        }
    }
    
    // Inject rotate message into pages without card views
    function injectRotateMessages() {
        const rotateHTML = `
            <div class="mobile-rotate-message">
                <div class="rotate-icon">ðŸ“±â†»</div>
                <h3 data-i18n="mobile.rotateTitle">Rotate for Full View</h3>
                <p data-i18n="mobile.rotateDesc">This section is optimized for landscape viewing. Please rotate your device for the best experience.</p>
            </div>
        `;
        
        document.querySelectorAll('.page:not(.has-card-view)').forEach(page => {
            // Only add if not already present
            if (!page.querySelector('.mobile-rotate-message')) {
                const pageHeader = page.querySelector('.page-header');
                if (pageHeader) {
                    pageHeader.insertAdjacentHTML('afterend', rotateHTML);
                } else {
                    page.insertAdjacentHTML('afterbegin', rotateHTML);
                }
            }
        });
        
        // Apply translations if available
        if (typeof applyTranslations === 'function') {
            applyTranslations();
        }
    }
    
    // Initialize on load, resize, and orientation change
    window.addEventListener('load', () => {
        const isMobileMode = checkMobileMode();
        injectRotateMessages();
        
        // On mobile, default to Orders page instead of Home (wait for data to load)
        if (isMobileMode) {
            // Update toggle buttons immediately
            setTimeout(() => {
                updateMobileThemeButton();
                updateMobileLangButton();
            }, 100);
        }
        
        // Render ALL cards after data loads (give it time)
        setTimeout(() => {
            const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
            console.log('[Mobile] Page loaded, card mode:', isCardMode);
            if (isCardMode) {
                // Navigate to Orders AFTER data loads
                mobileNavTo('orders-queue');
                forceRenderCards();
            }
        }, 2500); // Wait for data to load
        
        // Also try again after 5 seconds in case data was slow
        setTimeout(() => {
            const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
            if (isCardMode) {
                console.log('[Mobile] Retry render after 5s');
                forceRenderCards();
            }
        }, 5000);
    });
    window.addEventListener('resize', checkMobileMode);
    window.addEventListener('orientationchange', () => {
        setTimeout(checkMobileMode, 100);
        // Re-render cards after orientation change
        setTimeout(() => {
            if (document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait')) {
                const currentPage = document.querySelector('.page:not([style*="display: none"])')?.id || 'main';
                if (currentPage === 'orders-queue') renderMobileOrderCards('orders-queue');
                else if (currentPage === 'orders-staged' && typeof renderMobileStagedCards === 'function') renderMobileStagedCards();
                else if (currentPage === 'inventory' && typeof renderMobileInventoryCards === 'function') renderMobileInventoryCards();
            }
        }, 500);
    });
    
    // Mobile navigation
    function mobileNavTo(page) {
        // Update active state
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Navigate to page
        navigateTo(page);
        
        // Render mobile cards for relevant pages
        if (['orders-queue', 'orders-staged', 'orders-shipped'].includes(page)) {
            renderMobileOrderCards(page);
        }
    }
    
    // QR Code Share functions
    function showQrModal() {
        const modal = document.getElementById('qrShareModal');
        const qrImg = document.getElementById('qrCodeImage');
        const urlDisplay = document.getElementById('qrUrlDisplay');
        
        // Use current page URL (automatically correct for test vs production)
        const dashboardUrl = window.location.href.split('?')[0].split('#')[0];
        
        // Generate QR code via free API
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(dashboardUrl)}`;
        qrImg.src = qrApiUrl;
        urlDisplay.textContent = dashboardUrl;
        
        modal.style.display = 'flex';
    }
    
    function closeQrModal() {
        document.getElementById('qrShareModal').style.display = 'none';
    }
    
    // Close modal on backdrop click
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('qrShareModal');
        if (e.target === modal) closeQrModal();
    });
    
    // Mobile theme toggle
    function toggleMobileTheme() {
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
        updateMobileThemeButton();
    }
    
    function updateMobileThemeButton() {
        const icon = document.getElementById('mobileThemeIcon');
        const label = document.getElementById('mobileThemeLabel');
        if (icon) icon.textContent = currentTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
        if (label) label.textContent = currentTheme === 'dark' ? 'Dark' : 'Light';
    }
    
    // Mobile language toggle
    function toggleMobileLang() {
        const newLang = currentLang === 'en' ? 'es' : 'en';
        setLanguage(newLang);
        updateMobileLangButton();
    }
    
    function updateMobileLangButton() {
        const label = document.getElementById('mobileLangLabel');
        if (label) label.textContent = currentLang.toUpperCase();
    }
    
    // Render order cards for mobile view
    function renderMobileOrderCards(pageType) {
        const container = document.getElementById('mobileCardsContainer');
        if (!container) return;
        
        let orders = [];
        let filterFn = () => true;
        
        if (pageType === 'orders-queue') {
            filterFn = row => {
                const status = getStatus(row);
                const cat = getCategory(row);
                // Also check category filters (Roll Tech / Molding / Snap Pad buttons)
                const catOk = typeof ordersQueueFilters !== 'undefined' ? ordersQueueFilters.categories[cat] : true;
                return (status === 'pending' || status === 'wip') && catOk;
            };
        } else if (pageType === 'orders-staged') {
            filterFn = row => getStatus(row) === 'staged';
        } else if (pageType === 'orders-shipped') {
            filterFn = row => getStatus(row) === 'shipped';
        }
        
        orders = allData.filter(filterFn);
        
        // Apply mobile filter state (All/Urgent/Due This Week/Roll Tech/Molding)
        if (typeof mobileFilterState !== 'undefined' && mobileFilterState !== 'all') {
            orders = orders.filter(row => {
                const cat = getCategory(row);
                const urgent = isUrgent(row);
                const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                
                switch (mobileFilterState) {
                    case 'urgent': return urgent;
                    case 'due-week': return days >= 0 && days <= 7;
                    case 'rolltech': return cat === 'rolltech';
                    case 'molding': return cat === 'molding';
                    case 'snappad': return cat === 'snappad';
                    default: return true;
                }
            });
        }
        
        // Apply mobile search filter
        if (typeof mobileSearchTerm !== 'undefined' && mobileSearchTerm) {
            orders = orders.filter(row => {
                const customer = (getVal(row, 'CUSTOMER') || '').toLowerCase();
                const part = (getVal(row, 'PART') || '').toLowerCase();
                const line = (getVal(row, 'LINE') || '').toLowerCase();
                const ifNum = (getVal(row, 'IF_NUM') || '').toLowerCase();
                const poNum = (getVal(row, 'PO_NUM') || '').toLowerCase();
                const tire = (getVal(row, 'TIRE') || '').toLowerCase();
                const hub = (getVal(row, 'HUB') || '').toLowerCase();
                return customer.includes(mobileSearchTerm) || 
                       part.includes(mobileSearchTerm) || 
                       line.includes(mobileSearchTerm) ||
                       ifNum.includes(mobileSearchTerm) ||
                       poNum.includes(mobileSearchTerm) ||
                       tire.includes(mobileSearchTerm) ||
                       hub.includes(mobileSearchTerm);
            });
        }
        
        // Sort by urgency then days until
        orders.sort((a, b) => {
            const aUrgent = isUrgent(a) ? 0 : 1;
            const bUrgent = isUrgent(b) ? 0 : 1;
            if (aUrgent !== bUrgent) return aUrgent - bUrgent;
            return parseNumber(getVal(a, 'DAYS_UNTIL')) - parseNumber(getVal(b, 'DAYS_UNTIL'));
        });
        
        // Update mobile summary stats
        const statsContainer = document.querySelector('.mobile-summary-bar');
        if (statsContainer) {
            const urgentCount = orders.filter(r => isUrgent(r)).length;
            const dueWeekCount = orders.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; }).length;
            statsContainer.innerHTML = `
                <div class="mobile-summary-stat"><span class="stat-value">${orders.length}</span><span class="stat-label">Orders</span></div>
                <div class="mobile-summary-stat"><span class="stat-value" style="color:var(--danger)">${urgentCount}</span><span class="stat-label">Urgent</span></div>
                <div class="mobile-summary-stat"><span class="stat-value">${dueWeekCount}</span><span class="stat-label">Due This Week</span></div>
            `;
        }
        
        // Render cards
        container.innerHTML = orders.slice(0, 50).map(row => {
            const line = getVal(row, 'LINE') || '-';
            const customer = getVal(row, 'CUSTOMER') || '-';
            const part = getVal(row, 'PART') || '-';
            const qty = formatNumber(parseNumber(getVal(row, 'QTY')));
            const poNum = getVal(row, 'PO_NUM') || '-';
            const ifNum = getVal(row, 'IF_NUM') || '-';
            const status = getStatus(row);
            const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
            const urgent = isUrgent(row);
            const dueDate = getVal(row, 'REQUESTED_DATE') || '-';
            const tire = getVal(row, 'TIRE') || '-';
            const hub = getVal(row, 'HUB') || '-';
            const hubMold = getVal(row, 'HUB_MOLD') || '-';
            const cat = getCategory(row);
            const isRollTech = cat === 'rolltech';
            
            // Tire/Hub stock colors (green if have, red if don't) - only for Roll Tech
            const tireHasStock = hasTire(row);
            const hubHasStock = hasHub(row);
            const tireColor = isRollTech ? (tireHasStock ? '#48bb78' : '#fc8181') : 'inherit';
            const hubColor = isRollTech ? (hubHasStock ? '#48bb78' : '#fc8181') : 'inherit';
            const tireFontWeight = isRollTech && !tireHasStock ? 'bold' : 'normal';
            const hubFontWeight = isRollTech && !hubHasStock ? 'bold' : 'normal';
            
            let cardClass = 'mobile-order-card';
            if (urgent) cardClass += ' urgent';
            else if (days < 0) cardClass += ' overdue';
            
            let badgeClass = 'mobile-card-badge ' + status;
            let badgeText = status.toUpperCase();
            if (urgent) { badgeClass = 'mobile-card-badge urgent'; badgeText = 'URGENT'; }
            
            let daysText = days >= 0 ? `${days} days` : `${Math.abs(days)} days overdue`;
            let daysClass = days < 0 ? 'overdue' : '';
            
            // Use showMobilePhotos on mobile/tablet, showPalletPictures on desktop
            const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
            const clickFn = isCardMode ? `showMobilePhotos('${line}')` : `showPalletPictures('${line}')`;
            
            // Only show Hub Mold row for Roll Tech orders
            const hubMoldRow = isRollTech ? `
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Hub Mold</span>
                            <span class="mobile-card-value">${hubMold}</span>
                        </div>` : '';
            
            return `
                <div class="${cardClass}" onclick="${clickFn}">
                    <div class="mobile-card-header">
                        <div>
                            <div class="mobile-card-title">${customer}</div>
                            <div class="mobile-card-subtitle">Line ${line} â€¢ ${part}</div>
                        </div>
                        <span class="${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Quantity</span>
                            <span class="mobile-card-value large">${qty}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Due</span>
                            <span class="mobile-card-value ${days < 0 ? 'danger' : ''}">${daysText}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">PO #</span>
                            <span class="mobile-card-value">${poNum}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">IF #</span>
                            <span class="mobile-card-value">${ifNum}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Tire</span>
                            <span class="mobile-card-value" style="color:${tireColor};font-weight:${tireFontWeight};">${tire}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Hub</span>
                            <span class="mobile-card-value" style="color:${hubColor};font-weight:${hubFontWeight};">${hub}</span>
                        </div>${hubMoldRow}
                    </div>
                    <div class="mobile-card-footer">
                        <span class="mobile-card-date ${daysClass}">ðŸ“… ${dueDate}</span>
                        <span style="color:var(--text-secondary);font-size:11px;">Tap for details â†’</span>
                    </div>
                </div>
            `;
        }).join('');
        
        // Show count
        const countEl = container.previousElementSibling?.querySelector('.mobile-summary-stat .stat-value');
        if (countEl) countEl.textContent = orders.length;
    }
    
    // Helper to check if order is urgent
    function isUrgent(row) {
        const u = (getVal(row, 'URGENT') || '').toString().toLowerCase().trim();
        return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x';
    }
    
    // Mobile staged filter/search state
    let mobileStagedFilterState = 'all';
    let mobileStagedSearchTerm = '';
    
    function mobileSearchStaged(searchText) {
        mobileStagedSearchTerm = (searchText || '').toLowerCase().trim();
        renderMobileStagedCards();
    }
    
    function mobileFilterStaged(filter) {
        mobileStagedFilterState = filter;
        // Update chip active states
        document.querySelectorAll('.mobile-staged-controls .mobile-filter-chip').forEach(chip => {
            const chipFilter = chip.getAttribute('onclick')?.match(/mobileFilterStaged\('([^']+)'\)/)?.[1];
            chip.classList.toggle('active', chipFilter === filter);
        });
        renderMobileStagedCards();
    }
    
    // Render STAGED order cards
    function renderMobileStagedCards() {
        const container = document.getElementById('mobileStagedCardsContainer');
        const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
        if (!container || !isCardMode) return;
        
        let orders = allData.filter(row => getStatus(row) === 'staged');
        
        // Apply category filter
        if (mobileStagedFilterState !== 'all') {
            orders = orders.filter(row => {
                const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
                if (mobileStagedFilterState === 'rolltech') return cat.includes('roll') || cat.includes('tech');
                if (mobileStagedFilterState === 'molding') return cat.includes('molding') || cat.includes('mold');
                if (mobileStagedFilterState === 'snappad') return cat.includes('snap') || cat.includes('pad');
                return true;
            });
        }
        
        // Apply search filter
        if (mobileStagedSearchTerm) {
            orders = orders.filter(row => {
                const searchStr = [
                    getVal(row, 'CUSTOMER'),
                    getVal(row, 'LINE'),
                    getVal(row, 'PART'),
                    getVal(row, 'IF_NUM'),
                    getVal(row, 'PO_NUM'),
                    getVal(row, 'HUB'),
                    getVal(row, 'TIRE')
                ].join(' ').toLowerCase();
                return searchStr.includes(mobileStagedSearchTerm);
            });
        }
        
        container.innerHTML = orders.slice(0, 50).map(row => {
            const line = getVal(row, 'LINE') || '-';
            const customer = getVal(row, 'CUSTOMER') || '-';
            const part = getVal(row, 'PART') || '-';
            const qty = formatNumber(parseNumber(getVal(row, 'QTY')));
            const ifNum = getVal(row, 'IF_NUM') || '-';
            const poNum = getVal(row, 'PO_NUM') || '-';
            
            return `
                <div class="mobile-order-card" onclick="showMobilePhotos('${line}')" style="border-left: 4px solid var(--success);">
                    <div class="mobile-card-header">
                        <div>
                            <div class="mobile-card-title">${customer}</div>
                            <div class="mobile-card-subtitle">Line ${line} â€¢ ${part}</div>
                        </div>
                        <span class="mobile-card-badge staged">STAGED</span>
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">Quantity</span>
                            <span class="mobile-card-value large">${qty}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">IF #</span>
                            <span class="mobile-card-value">${ifNum}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">PO #</span>
                            <span class="mobile-card-value">${poNum}</span>
                        </div>
                    </div>
                    <div class="mobile-card-footer">
                        <span class="mobile-card-date">ðŸ“¦ Ready to ship</span>
                        <span style="color:var(--text-secondary);font-size:11px;">Tap for photos â†’</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Mobile inventory filter/search state
    let mobileInvFilterState = 'all';
    let mobileInvSearchTerm = '';
    
    function mobileSearchInventory(searchText) {
        mobileInvSearchTerm = (searchText || '').toLowerCase().trim();
        renderMobileInventoryCards();
    }
    
    function mobileFilterInventory(filter) {
        console.log('[Inventory Filter] Called with filter:', filter, 'inventoryData length:', inventoryData.length);
        mobileInvFilterState = filter;
        // Update chip active states
        document.querySelectorAll('.mobile-inv-controls .mobile-filter-chip').forEach(chip => {
            const chipFilter = chip.getAttribute('onclick')?.match(/mobileFilterInventory\('([^']+)'\)/)?.[1];
            chip.classList.toggle('active', chipFilter === filter);
        });
        
        // Update count display
        let count = inventoryData.length;
        if (filter === 'low') {
            count = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0).length;
        } else if (filter === 'needed') {
            count = inventoryData.filter(i => i.partsToBeMade > 0).length;
        }
        const searchInput = document.getElementById('mobileInvSearchInput');
        if (searchInput) {
            searchInput.placeholder = `ðŸ” ${count} items (${filter})...`;
        }
        
        renderMobileInventoryCards();
        console.log('[Inventory Filter] Cards rendered, count:', count);
    }
    
    // Render INVENTORY cards
    function renderMobileInventoryCards() {
        const container = document.getElementById('mobileInventoryCardsContainer');
        console.log('[Inventory Cards] Rendering... container:', !!container, 'inventoryData:', inventoryData.length, 'filter:', mobileInvFilterState);
        if (!container) return;
        // Always render if container exists (CSS handles visibility)
        
        // Filter items based on mobile filter
        let items = [...inventoryData];
        
        // Apply filter
        if (mobileInvFilterState === 'low') {
            items = items.filter(item => item.fusionQty < item.minimum && item.minimum > 0);
        } else if (mobileInvFilterState === 'needed') {
            items = items.filter(item => item.partsToBeMade > 0);
        }
        
        // Apply search
        if (mobileInvSearchTerm) {
            items = items.filter(item => {
                const searchStr = [item.partNumber, item.product].join(' ').toLowerCase();
                return searchStr.includes(mobileInvSearchTerm);
            });
        }
        
        // Sort alphabetically by part number (default)
        items.sort((a, b) => (a.partNumber || '').localeCompare(b.partNumber || ''));
        
        // For filtered views (low/needed), show 50 max; for "all", show more to ensure all items accessible
        const displayLimit = (mobileInvFilterState === 'all') ? 500 : 50;
        console.log('[Inventory Cards] After filter/search:', items.length, 'items, showing:', Math.min(items.length, displayLimit));
        container.innerHTML = items.slice(0, displayLimit).map(item => {
            const partNum = item.partNumber || '-';
            const product = item.product || '-';
            const qty = formatNumber(item.fusionQty || 0);
            const min = formatNumber(item.minimum || 0);
            const target = formatNumber(item.manualTarget || item.minimum || 0);
            const toMake = formatNumber(item.partsToBeMade || 0);
            
            const isLow = item.fusionQty < item.minimum && item.minimum > 0;
            const isOut = item.fusionQty === 0;
            const pct = item.minimum > 0 ? Math.round((item.fusionQty / item.minimum) * 100) : 100;
            
            let borderColor = 'var(--success)';
            let statusBadge = '<span class="mobile-card-badge" style="background:var(--success);">OK</span>';
            if (isOut) {
                borderColor = 'var(--danger)';
                statusBadge = '<span class="mobile-card-badge" style="background:var(--danger);">OUT</span>';
            } else if (isLow) {
                borderColor = 'var(--warning)';
                statusBadge = '<span class="mobile-card-badge" style="background:var(--warning);color:black;">LOW</span>';
            }
            
            return `
                <div class="mobile-order-card" style="border-left: 4px solid ${borderColor};">
                    <div class="mobile-card-header">
                        <div>
                            <div class="mobile-card-title">${partNum}</div>
                            <div class="mobile-card-subtitle">${product}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.inStock')}</span>
                            <span class="mobile-card-value large ${isLow ? 'danger' : 'success'}">${qty}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.minimum')}</span>
                            <span class="mobile-card-value">${min}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.target')}</span>
                            <span class="mobile-card-value">${target}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.toMake')}</span>
                            <span class="mobile-card-value ${item.partsToBeMade > 0 ? 'warning' : ''}">${toMake}</span>
                        </div>
                    </div>
                    <div class="mobile-card-footer">
                        <span class="mobile-card-date">${pct}${t('mobile.ofMinimum')}</span>
                        <div style="width:60px;height:6px;background:var(--bg-dark);border-radius:3px;overflow:hidden;">
                            <div style="width:${Math.min(pct, 100)}%;height:100%;background:${borderColor};"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Mobile filter state
    let mobileFilterState = 'all';
    let mobileSearchTerm = '';
    
    // Mobile search function
    function mobileSearchOrders(searchText) {
        mobileSearchTerm = (searchText || '').toLowerCase().trim();
        renderMobileOrderCards('orders-queue');
    }
    
    // Mobile filter function for order cards
    function mobileFilterOrders(filter) {
        mobileFilterState = filter;
        
        // Update chip active states
        document.querySelectorAll('.mobile-filter-chip').forEach(chip => {
            const chipFilter = chip.getAttribute('onclick')?.match(/mobileFilterOrders\('([^']+)'\)/)?.[1];
            chip.classList.toggle('active', chipFilter === filter);
        });
        
        // Re-render cards with filter
        renderMobileOrderCards('orders-queue');
    }
    
    // Override renderMobileOrderCards to respect filter
    const _origRenderMobileOrderCards = renderMobileOrderCards;
    renderMobileOrderCards = function(pageType) {
        const container = document.getElementById('mobileCardsContainer');
        if (!container) return;
        
        let orders = [];
        let filterFn = () => true;
        
        // Check if filter is for a specific status
        const statusFilters = ['staged', 'shipped'];
        const isStatusFilter = statusFilters.includes(mobileFilterState);
        
        if (isStatusFilter) {
            // Show orders with the selected status (ignore pageType)
            filterFn = row => getStatus(row) === mobileFilterState;
        } else if (pageType === 'orders-queue') {
            filterFn = row => {
                const status = getStatus(row);
                return status === 'pending' || status === 'wip';
            };
        } else if (pageType === 'orders-staged') {
            filterFn = row => getStatus(row) === 'staged';
        } else if (pageType === 'orders-shipped') {
            filterFn = row => getStatus(row) === 'shipped';
        }
        
        orders = allData.filter(filterFn);
        
        // Apply mobile filter (skip if already filtering by status)
        if (mobileFilterState !== 'all' && !isStatusFilter) {
            orders = orders.filter(row => {
                const cat = getCategory(row);
                const urgent = isUrgent(row);
                const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                
                switch (mobileFilterState) {
                    case 'urgent': return urgent;
                    case 'due-week': return days >= 0 && days <= 7;
                    case 'rolltech': return cat === 'rolltech';
                    case 'molding': return cat === 'molding';
                    case 'snappad': return cat === 'snappad';
                    default: return true;
                }
            });
        }
        
        // Apply mobile search filter
        if (mobileSearchTerm) {
            orders = orders.filter(row => {
                const searchStr = [
                    getVal(row, 'LINE'),
                    getVal(row, 'CUSTOMER'),
                    getVal(row, 'PART'),
                    getVal(row, 'HUB'),
                    getVal(row, 'TIRE')
                ].join(' ').toLowerCase();
                return searchStr.includes(mobileSearchTerm);
            });
        }
        
        // Sort by urgency then days until
        orders.sort((a, b) => {
            const aUrgent = isUrgent(a) ? 0 : 1;
            const bUrgent = isUrgent(b) ? 0 : 1;
            if (aUrgent !== bUrgent) return aUrgent - bUrgent;
            return parseNumber(getVal(a, 'DAYS_UNTIL')) - parseNumber(getVal(b, 'DAYS_UNTIL'));
        });
        
        // Update stats
        const statsContainer = document.querySelector('.mobile-summary-bar');
        if (statsContainer) {
            const urgentCount = orders.filter(r => isUrgent(r)).length;
            const dueWeekCount = orders.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; }).length;
            statsContainer.innerHTML = `
                <div class="mobile-summary-stat"><span class="stat-value">${orders.length}</span><span class="stat-label">${t('mobile.orders')}</span></div>
                <div class="mobile-summary-stat"><span class="stat-value" style="color:var(--danger)">${urgentCount}</span><span class="stat-label">${t('stats.urgent')}</span></div>
                <div class="mobile-summary-stat"><span class="stat-value">${dueWeekCount}</span><span class="stat-label">${t('mobile.dueThisWeek')}</span></div>
            `;
        }
        
        // Render cards - use showMobilePhotos for mobile
        const isCardMode = document.body.classList.contains('mobile-mode') || document.body.classList.contains('tablet-portrait');
        container.innerHTML = orders.slice(0, 50).map(row => {
            const line = getVal(row, 'LINE') || '-';
            const customer = getVal(row, 'CUSTOMER') || '-';
            const part = getVal(row, 'PART') || '-';
            const qty = formatNumber(parseNumber(getVal(row, 'QTY')));
            const status = getStatus(row);
            const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
            const urgent = isUrgent(row);
            const dueDate = getVal(row, 'REQUESTED_DATE') || '-';
            const poNum = getVal(row, 'PO_NUM') || '-';
            const ifNum = getVal(row, 'IF_NUM') || '-';
            const tire = getVal(row, 'TIRE') || '-';
            const hub = getVal(row, 'HUB') || '-';
            const hubMold = getVal(row, 'HUB_MOLD') || '-';
            const cat = getCategory(row);
            const isRollTech = cat === 'rolltech';
            
            // Tire/Hub stock colors (green if have, red if don't) - only for Roll Tech
            const tireHasStock = hasTire(row);
            const hubHasStock = hasHub(row);
            const tireColor = isRollTech ? (tireHasStock ? '#48bb78' : '#fc8181') : 'inherit';
            const hubColor = isRollTech ? (hubHasStock ? '#48bb78' : '#fc8181') : 'inherit';
            const tireFontWeight = isRollTech && !tireHasStock ? 'bold' : 'normal';
            const hubFontWeight = isRollTech && !hubHasStock ? 'bold' : 'normal';
            
            let cardClass = 'mobile-order-card';
            if (urgent) cardClass += ' urgent';
            else if (days < 0) cardClass += ' overdue';
            
            let badgeClass = 'mobile-card-badge ' + status;
            let badgeText = status.toUpperCase();
            if (urgent) { badgeClass = 'mobile-card-badge urgent'; badgeText = 'URGENT'; }
            
            let daysText = days >= 0 ? `${days} ${t('mobile.days')}` : `${Math.abs(days)} ${t('mobile.daysOverdue')}`;
            let daysClass = days < 0 ? 'overdue' : '';
            
            // Use showMobilePhotos on mobile, showPalletPictures on desktop
            const clickFn = isCardMode ? `showMobilePhotos('${line}')` : `showPalletPictures('${line}')`;
            
            // Only show Hub Mold row for Roll Tech orders
            const hubMoldRow = isRollTech ? `
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('col.hubMold') || 'Hub Mold'}</span>
                            <span class="mobile-card-value">${hubMold}</span>
                        </div>` : '';
            
            return `
                <div class="${cardClass}" onclick="${clickFn}">
                    <div class="mobile-card-header">
                        <div>
                            <div class="mobile-card-title">${customer}</div>
                            <div class="mobile-card-subtitle">Line ${line} â€¢ ${part}</div>
                        </div>
                        <span class="${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.quantity')}</span>
                            <span class="mobile-card-value large">${qty}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.due')}</span>
                            <span class="mobile-card-value ${days < 0 ? 'danger' : ''}">${daysText}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('col.poNum') || 'PO #'}</span>
                            <span class="mobile-card-value">${poNum}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('col.ifNum') || 'IF #'}</span>
                            <span class="mobile-card-value">${ifNum}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.tire')}</span>
                            <span class="mobile-card-value" style="color:${tireColor};font-weight:${tireFontWeight};">${tire}</span>
                        </div>
                        <div class="mobile-card-field">
                            <span class="mobile-card-label">${t('mobile.hub')}</span>
                            <span class="mobile-card-value" style="color:${hubColor};font-weight:${hubFontWeight};">${hub}</span>
                        </div>${hubMoldRow}
                    </div>
                    <div class="mobile-card-footer">
                        <span class="mobile-card-date ${daysClass}">ðŸ“… ${dueDate}</span>
                        <span style="color:var(--text-secondary);font-size:11px;">${t('mobile.tapPhotos')} â†’</span>
                    </div>
                </div>
            `;
        }).join('');
    };
    
    // Mobile photo viewer - full screen modal
    async function showMobilePhotos(lineNum) {
        // Load data if needed
        await loadStagedRecordsData();
        await loadShippingRecordsData();
        
        const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
        if (!orderData) { alert('Order not found'); return; }
        
        const customer = getVal(orderData, 'CUSTOMER') || '-';
        const part = getVal(orderData, 'PART') || '-';
        const ifNum = getVal(orderData, 'IF_NUM') || '-';
        const pallets = getPalletDataForOrder(lineNum);
        
        // Get photos from staged and shipping records
        const stagedRecord = getStagedRecordsForOrder(ifNum, lineNum);
        const fusionPictures = stagedRecord ? (stagedRecord['Fusion Pictures'] || []) : [];
        const shippingRecords = getShippingRecordsForOrder(ifNum);
        const shipmentPictures = shippingRecords.flatMap(r => r['Shipment Pictures'] || []);
        const closeUpPictures = shippingRecords.flatMap(r => r['Close Up Pictures'] || []);
        
        // Get drawings
        const tirePartNum = getVal(orderData, 'TIRE') || '';
        const hubPartNum = getVal(orderData, 'HUB') || '';
        
        // Build photo sections
        let photosHtml = '';
        
        // Pallet photos
        if (pallets.length > 0) {
            photosHtml += `<div class="mobile-photo-section"><h4>ðŸ“¦ Pallet Photos</h4><div class="mobile-photo-grid">`;
            pallets.forEach((p, i) => {
                if (p.pictureUrl) {
                    const urls = getPhotoUrls(p.pictureUrl);
                    if (urls) photosHtml += `<img src="${urls.thumb}" onclick="openImageModal('${urls.full}')" alt="Pallet ${i+1}">`;
                }
            });
            photosHtml += `</div></div>`;
        }
        
        // Fusion photos
        if (fusionPictures.length > 0) {
            photosHtml += `<div class="mobile-photo-section"><h4>ðŸ“„ Fusion Photos</h4><div class="mobile-photo-grid">`;
            fusionPictures.forEach((url, i) => {
                const urls = getPhotoUrls(url);
                if (urls) photosHtml += `<img src="${urls.thumb}" onclick="openImageModal('${urls.full}')" alt="Fusion ${i+1}">`;
            });
            photosHtml += `</div></div>`;
        }
        
        // Shipment photos
        if (shipmentPictures.length > 0) {
            photosHtml += `<div class="mobile-photo-section"><h4>ðŸšš Shipment Photos</h4><div class="mobile-photo-grid">`;
            shipmentPictures.forEach((url, i) => {
                const urls = getPhotoUrls(url);
                if (urls) photosHtml += `<img src="${urls.thumb}" onclick="openImageModal('${urls.full}')" alt="Shipment ${i+1}">`;
            });
            photosHtml += `</div></div>`;
        }
        
        // Close-up photos
        if (closeUpPictures.length > 0) {
            photosHtml += `<div class="mobile-photo-section"><h4>ðŸ” Close-Up Photos</h4><div class="mobile-photo-grid">`;
            closeUpPictures.forEach((url, i) => {
                const urls = getPhotoUrls(url);
                if (urls) photosHtml += `<img src="${urls.thumb}" onclick="openImageModal('${urls.full}')" alt="Close-up ${i+1}">`;
            });
            photosHtml += `</div></div>`;
        }
        
        // Drawings
        if (window.drawingMap) {
            const tireDrawing = window.drawingMap[tirePartNum];
            const hubDrawing = window.drawingMap[hubPartNum];
            if (tireDrawing || hubDrawing) {
                photosHtml += `<div class="mobile-photo-section"><h4>ðŸ“ Drawings</h4><div class="mobile-photo-grid">`;
                if (tireDrawing?.drawing1) {
                    const url = getDriveThumbUrl(tireDrawing.drawing1, 400);
                    const full = getDriveThumbUrl(tireDrawing.drawing1, 1200);
                    if (url) photosHtml += `<img src="${url}" onclick="openImageModal('${full}')" alt="Tire Drawing">`;
                }
                if (hubDrawing?.drawing1) {
                    const url = getDriveThumbUrl(hubDrawing.drawing1, 400);
                    const full = getDriveThumbUrl(hubDrawing.drawing1, 1200);
                    if (url) photosHtml += `<img src="${url}" onclick="openImageModal('${full}')" alt="Hub Drawing">`;
                }
                photosHtml += `</div></div>`;
            }
        }
        
        if (!photosHtml) {
            photosHtml = '<p style="text-align:center;color:var(--text-secondary);padding:40px;">No photos available for this order.</p>';
        }
        
        // Create modal
        let modal = document.getElementById('mobilePhotoModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'mobilePhotoModal';
            modal.className = 'mobile-photo-modal';
            document.body.appendChild(modal);
        }
        
        modal.innerHTML = `
            <div class="mobile-photo-modal-header">
                <div>
                    <div style="font-size:16px;font-weight:600;">${customer}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">Line ${lineNum} â€¢ ${part} â€¢ IF: ${ifNum}</div>
                </div>
                <button onclick="closeMobilePhotos()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">âœ•</button>
            </div>
            <div class="mobile-photo-modal-body">
                ${photosHtml}
            </div>
        `;
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeMobilePhotos() {
        const modal = document.getElementById('mobilePhotoModal');
        if (modal) modal.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Update mobileNavTo to render appropriate cards
    const originalMobileNavTo = mobileNavTo;
    mobileNavTo = function(page) {
        // Update active state
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Navigate to page
        navigateTo(page);
        
        // Render cards based on page
        setTimeout(() => {
            if (page === 'orders-queue') renderMobileOrderCards('orders-queue');
            else if (page === 'orders-staged') renderMobileStagedCards();
            else if (page === 'inventory') renderMobileInventoryCards();
        }, 100);
    };
    
    // Auto-render cards when data loads on mobile
    const originalLoadDashboard = typeof loadDashboard === 'function' ? loadDashboard : null;
    if (originalLoadDashboard) {
        const patchedLoad = loadDashboard;
        // Cards will render when user navigates via mobile nav
    }
    </script>
</body>
</html>
<!-- cache bust 1770480695 -->
