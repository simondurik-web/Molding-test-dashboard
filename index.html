<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Molding Operations Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        /* DARK THEME (Default) */
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #3182ce;
            --success: #38a169;
            --success-light: #68d391;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #d69e2e;
            --purple: #805ad5;
            --teal: #319795;
            --orange: #dd6b20;
            --staged-blue: #4299e1;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --sidebar-width: 180px;
            /* Theme-specific variables */
            --body-bg: linear-gradient(135deg, #1a202c 0%, #0d1421 100%);
            --sidebar-bg: linear-gradient(180deg, #1a365d 0%, #2c5282 100%);
            --card-bg: linear-gradient(135deg, #2d3748 0%, #374151 100%);
            --table-header-bg: #2d3748;
            --table-row-hover: rgba(49, 130, 206, 0.15);
            --table-row-alt: rgba(45, 55, 72, 0.5);
            --input-bg: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --logo-gradient: linear-gradient(135deg, #fff 0%, #a0aec0 100%);
            --stat-card-bg: linear-gradient(135deg, #2d3748 0%, #374151 100%);
            --dropdown-bg: #2d3748;
            --modal-bg: #2d3748;
            --scrollbar-thumb: #4a5568;
            --scrollbar-track: #2d3748;
        }
        
        /* LIGHT THEME */
        html.light-theme {
            --primary: #2b6cb0;
            --primary-light: #3182ce;
            --accent: #2b6cb0;
            --bg-dark: #f7fafc;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --body-bg: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            --sidebar-bg: linear-gradient(180deg, #2b6cb0 0%, #3182ce 100%);
            --card-bg: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            --table-header-bg: #edf2f7;
            --table-row-hover: rgba(49, 130, 206, 0.1);
            --table-row-alt: rgba(237, 242, 247, 0.7);
            --input-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --logo-gradient: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
            --stat-card-bg: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            --dropdown-bg: #ffffff;
            --modal-bg: #ffffff;
            --scrollbar-thumb: #cbd5e0;
            --scrollbar-track: #edf2f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--body-bg);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 17px;
            overflow-x: hidden;
        }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: var(--sidebar-bg);
            padding: 14px 8px; overflow-y: auto; z-index: 1000;
            box-shadow: 4px 0 20px var(--shadow-color); transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar-tab { position: fixed; top: 8px; left: 8px; z-index: 1001; background: var(--primary); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; transform: translateX(-20px); }
        .sidebar-tab.visible { opacity: 1; pointer-events: auto; transform: translateX(0); }
        .main-content.expanded { margin-left: 0 !important; max-width: 100vw !important; padding-top: 42px !important; }
        .logo { text-align: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.15); margin-bottom: 12px; }
        .logo h1 { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #a0aec0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo span { font-size: 10px; color: var(--text-secondary); display: block; margin-top: 2px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 14px; font-weight: 700; }
        .nav-section-title.sales-locked { cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: linear-gradient(135deg, rgba(49,130,206,0.15) 0%, rgba(49,130,206,0.05) 100%); border-radius: 8px; margin: 4px 8px 8px; transition: all 0.2s; }
        .nav-section-title.sales-locked:hover { background: linear-gradient(135deg, rgba(49,130,206,0.25) 0%, rgba(49,130,206,0.15) 100%); }
        .nav-section-title.sales-locked .lock-icon { font-size: 12px; }
        .nav-section-title.sales-unlocked { cursor: default; background: linear-gradient(135deg, rgba(56,161,105,0.15) 0%, rgba(56,161,105,0.05) 100%); margin: 4px 8px 8px; padding: 12px 14px; border-radius: 8px; display: flex; align-items: center; gap: 8px; }
        .nav-section-title.sales-unlocked .lock-icon { display: none; }
        .financial-data { transition: opacity 0.3s; }
        .financial-hidden .financial-data { display: none !important; }
        .nav-item.locked-item { opacity: 0.5; cursor: pointer; }
        .nav-item.locked-item:hover { opacity: 0.7; }
        .nav-item.locked-item::after { content: 'ðŸ”’'; margin-left: 8px; font-size: 10px; }
        .nav-item { display: flex; align-items: center; padding: 7px 10px; margin: 2px 0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: rgba(255,255,255,0.85); font-size: 11px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); color: white; box-shadow: 0 4px 15px rgba(49,130,206,0.5); }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item.sub-item { padding-left: 36px; font-size: 11px; opacity: 0.9; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 8px; }
        .data-info { font-size: 10px; color: var(--text-secondary); padding: 14px 10px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .data-info strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 11px; }
        .toggle-controls { margin: 10px 8px; display: flex; flex-direction: column; gap: 6px; }
        .lang-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; }
        .lang-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .lang-btn.active { background: var(--accent); color: white; }
        .theme-toggle { display: flex; gap: 4px; background: var(--bg-dark); border-radius: 8px; padding: 3px; }
        .theme-btn { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .theme-btn.active { background: var(--accent); }
        html.light-theme .toggle-controls .lang-toggle,
        html.light-theme .toggle-controls .theme-toggle { background: rgba(0,0,0,0.1); }
        html.light-theme .lang-btn,
        html.light-theme .theme-btn { color: rgba(255,255,255,0.7); }
        html.light-theme .lang-btn.active,
        html.light-theme .theme-btn.active { background: rgba(255,255,255,0.2); color: white; }
        .main-content { margin-left: var(--sidebar-width); padding: 10px 12px; min-height: 100vh; max-width: calc(100vw - var(--sidebar-width)); overflow-x: hidden; transition: margin-left 0.3s ease, max-width 0.3s ease; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
        .page-header h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-header p { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .last-updated { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .last-updated .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .dept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dept-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 16px; padding: 24px; border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .dept-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .dept-card.sales::before { background: linear-gradient(90deg, var(--success), var(--teal)); }
        .dept-card.production::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .dept-card.inventory::before { background: linear-gradient(90deg, var(--teal), var(--accent)); }
        .dept-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-color: var(--accent); }
        .dept-card .icon-large { font-size: 40px; margin-bottom: 12px; }
        .dept-card h3 { font-size: 20px; margin-bottom: 8px; }
        .dept-card p { color: var(--text-secondary); font-size: 12px; margin-bottom: 16px; }
        .dept-card .metrics { display: flex; gap: 20px; flex-wrap: wrap; }
        .dept-card .metric .value { font-size: 22px; font-weight: 700; }
        .dept-card .metric .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .dept-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .dept-card.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .coming-soon { position: absolute; top: 12px; right: 12px; background: var(--warning); color: #1a202c; padding: 3px 10px; border-radius: 12px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .quick-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 24px; }
        .quick-stat { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 12px; padding: 16px; border: 1px solid var(--border); text-align: center; }
        .quick-stat .value { font-size: 24px; font-weight: 700; }
        .quick-stat .value.positive { color: var(--success); }
        .quick-stat .value.negative { color: var(--danger); }
        .quick-stat .value.warning { color: var(--warning); }
        .quick-stat .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 18px 20px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--teal)); }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .stat-card .label { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.8px; font-weight: 600; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .value.positive { color: var(--success); }
        .stat-card .value.negative { color: var(--danger); }
        .stat-card .sub { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }
        .info-banner { border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; display: none; }
        .info-banner.active { display: flex; align-items: center; gap: 12px; }
        .info-banner.warning { background: linear-gradient(135deg, #744210 0%, #975a16 100%); border: 1px solid var(--warning); }
        .info-banner.warning p { color: #fefcbf; }
        .info-banner.info { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border: 1px solid var(--accent); }
        .info-banner.info p { color: #bee3f8; }
        .info-banner p { font-size: 12px; margin: 0; }
        .info-banner .icon { font-size: 20px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: var(--bg-card); padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border); }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .toolbar select, .toolbar input[type="date"], .toolbar input[type="text"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; }
        .toolbar select:focus, .toolbar input:focus { outline: none; border-color: var(--accent); }
        .toolbar-btn { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .toolbar-btn:hover { border-color: var(--accent); background: rgba(49,130,206,0.2); }
        .toolbar-btn.active { background: var(--accent); border-color: var(--accent); }
        .toolbar-spacer { flex: 1; }
        .category-filters { display: flex; gap: 8px; }
        .category-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 2px solid; display: flex; align-items: center; gap: 6px; }
        .category-btn .indicator { width: 8px; height: 8px; border-radius: 50%; }
        .category-btn.rolltech { border-color: var(--accent); color: var(--accent); background: transparent; }
        .category-btn.rolltech.active { background: var(--accent); color: white; }
        .category-btn.rolltech .indicator { background: var(--accent); }
        .category-btn.molding { border-color: var(--warning); color: var(--warning); background: transparent; }
        .category-btn.molding.active { background: var(--warning); color: #1a202c; }
        .category-btn.molding .indicator { background: var(--warning); }
        .category-btn.snappad { border-color: #9f7aea; color: #9f7aea; background: transparent; }
        .category-btn.snappad.active { background: #9f7aea; color: white; }
        .category-btn.snappad .indicator { background: #9f7aea; }
        .category-btn:not(.active) { opacity: 0.5; }
        .category-btn:not(.active):hover { opacity: 0.8; }
        .status-filters { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; border: 1px solid; }
        .status-btn.pending { border-color: var(--warning); color: var(--warning); background: transparent; }
        .status-btn.pending.active { background: var(--warning); color: #1a202c; }
        .status-btn.staged { border-color: var(--staged-blue); color: var(--staged-blue); background: transparent; }
        .status-btn.staged.active { background: var(--staged-blue); color: white; }
        .status-btn.wip { border-color: var(--teal); color: var(--teal); background: transparent; }
        .status-btn.wip.active { background: var(--teal); color: white; }
        .status-btn.shipped { border-color: var(--success); color: var(--success); background: transparent; }
        .status-btn.shipped.active { background: var(--success); color: white; }
        .status-btn:not(.active) { opacity: 0.5; }
        .status-btn:not(.active):hover { opacity: 0.8; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; white-space: nowrap; cursor: pointer; user-select: none; }
        .data-table th:hover { background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%); }
        .data-table th .sort-indicator { margin-left: 4px; opacity: 0.5; font-size: 9px; }
        .data-table th.sorted .sort-indicator { opacity: 1; color: var(--warning); }
        .data-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; }
        .data-table tr:hover td { background: rgba(255,255,255,0.04); }
        .data-table .positive { color: var(--success); font-weight: 600; }
        .data-table .negative { color: var(--danger); font-weight: 600; }
        .data-table .warning-text { color: var(--warning); font-weight: 600; }
        .scrollable-table { max-height: 600px; overflow-y: auto; overflow-x: auto; border-radius: 10px; }
        .scrollable-table::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollable-table::-webkit-scrollbar-track { background: var(--bg-dark); }
        .scrollable-table::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.shipped { background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%); color: white; }
        .badge.pending { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%); color: #1a202c; }
        .badge.staged { background: linear-gradient(135deg, var(--staged-blue) 0%, #3182ce 100%); color: white; }
        .badge.wip { background: linear-gradient(135deg, var(--teal) 0%, #2c7a7b 100%); color: white; }
        .badge.urgent { background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%); color: white; }
        .badge.priority-1 { background: var(--danger); color: white; }
        .badge.priority-2 { background: var(--warning); color: #1a202c; }
        .badge.priority-3 { background: var(--accent); color: white; }
        .badge.priority-4 { background: var(--teal); color: white; }
        .cell-missing { color: var(--danger); font-weight: 600; }
        .cell-available { color: var(--success); }
        .chart-container { background: linear-gradient(135deg, var(--bg-card) 0%, #374151 100%); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .chart-header h3 { font-size: 16px; font-weight: 600; }
        .chart-wrapper { position: relative; height: 280px; }
        .chart-wrapper.large { height: 350px; }
        .price-history-container { position: relative; height: 250px; margin-bottom: 20px; padding-bottom: 30px; }
        .price-history-container canvas { max-height: 250px; }
        .search-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: white; font-size: 13px; min-width: 180px; transition: all 0.2s; }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.2); }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); position: sticky; top: 0; z-index: 1001; }
        .mobile-header h1 { font-size: 18px; }
        .menu-toggle { background: rgba(255,255,255,0.15); border: none; color: white; font-size: 22px; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1200px) { .quick-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .mobile-header { display: flex; }
            .dept-grid { grid-template-columns: 1fr; }
            .quick-stats { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-spacer { display: none; }
        }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 10px 20px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-color: var(--accent); }
        .bom-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        .bom-selector { max-height: 450px; overflow-y: auto; padding: 12px; background: var(--bg-dark); border-radius: 10px; }
        .bom-item { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; margin-bottom: 6px; }
        .bom-item:hover { border-color: var(--accent); transform: translateX(4px); }
        .bom-item.selected { border-color: var(--accent); background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); }
        .bom-details { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .bom-header { border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 16px; }
        .bom-header h3 { font-size: 20px; margin-bottom: 6px; }
        .bom-header .category { color: var(--accent); font-size: 13px; font-weight: 500; }
        .bom-section { margin-bottom: 20px; }
        .bom-section h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.8px; font-weight: 700; }
        .component-list { display: grid; gap: 8px; }
        .component-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; flex-wrap: wrap; gap: 8px; }
        .component-item .name { font-weight: 600; font-size: 12px; }
        .component-item .details { display: flex; gap: 14px; color: var(--text-secondary); font-size: 11px; }
        .cost-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .cost-item { display: flex; justify-content: space-between; padding: 10px 14px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; }
        .cost-item .label { color: var(--text-secondary); }
        .cost-item .value { font-weight: 600; }
        .highlight-box { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%); border-radius: 10px; padding: 16px; margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; text-align: center; }
        .highlight-box .item .value { font-size: 20px; font-weight: 700; }
        .highlight-box .item .label { font-size: 10px; opacity: 0.85; margin-top: 3px; }
        .inv-low { background: rgba(229,62,62,0.15) !important; }
        .inv-warning { background: rgba(214,158,46,0.15) !important; }
        .inv-ok { background: rgba(56,161,105,0.08) !important; }
        .drilldown-section { display: none; margin-top: 20px; background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); }
        .drilldown-section.active { display: block; }
        .drilldown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .drilldown-header h3 { font-size: 18px; }
        .breadcrumb { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .close-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .close-btn:hover { border-color: var(--danger); color: var(--danger); }
        .back-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }
        .summary-row { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .summary-item { background: var(--bg-dark); padding: 12px 16px; border-radius: 8px; }
        .summary-item .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-item .value { font-size: 18px; font-weight: 700; }
        @media (max-width: 768px) { .bom-grid { grid-template-columns: 1fr; } .tabs { flex-wrap: wrap; } }
        
        /* Column Filter System Styles */
        .filter-th { position: relative; }
        .filter-th-content { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .filter-th-btns { display: flex; gap: 2px; }
        .filter-th-btns button { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 20px; height: 20px; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .filter-th-btns button:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-th.filtered { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; }
        .filter-th.filtered .filter-th-btns button { background: rgba(0,0,0,0.2); }
        .filter-dropdown { position: fixed; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2000; min-width: 240px; max-width: 320px; max-height: 400px; display: none; flex-direction: column; }
        .filter-dropdown.active { display: flex; }
        .filter-dropdown-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-dropdown-header h4 { font-size: 12px; font-weight: 600; margin: 0; }
        .filter-dropdown-header button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; }
        .filter-search { margin: 10px; padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 12px; }
        .filter-search:focus { outline: none; border-color: var(--accent); }
        .filter-actions { display: flex; gap: 8px; padding: 0 10px 8px 10px; }
        .filter-actions button { flex: 1; padding: 6px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
        .filter-actions button:hover { border-color: var(--accent); color: white; }
        .filter-values-list { flex: 1; overflow-y: auto; padding: 0 10px; max-height: 220px; }
        .filter-value-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .filter-value-item:hover { background: rgba(255,255,255,0.05); }
        .filter-value-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        .filter-value-item label { cursor: pointer; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-dropdown-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .filter-dropdown-footer button { flex: 1; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .filter-dropdown-footer .clear-btn { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .filter-dropdown-footer .clear-btn:hover { border-color: var(--danger); color: var(--danger); }
        .filter-dropdown-footer .apply-btn { background: var(--accent); border: none; color: white; }
        .filter-dropdown-footer .apply-btn:hover { background: var(--primary-light); }
        .clear-all-filters-btn { background: var(--bg-dark) !important; }
        .clear-all-filters-btn.has-filters { background: linear-gradient(135deg, var(--warning) 0%, #b7791f 100%) !important; color: #1a202c !important; border-color: var(--warning) !important; }
        .show-hidden-btn { display: none; background: var(--bg-dark) !important; }
        .show-hidden-btn.has-hidden { display: inline-flex; background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%) !important; color: white !important; border-color: var(--accent) !important; }
        
        /* Column Toggle Dropdown */
        .columns-btn { background: var(--bg-dark) !important; position: relative; }
        .columns-btn.has-hidden { background: linear-gradient(135deg, var(--accent) 0%, #4299e1 100%) !important; color: white !important; border-color: var(--accent) !important; }
        .column-toggle-dropdown {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 10001; width: 320px; max-height: 80vh;
            display: none; flex-direction: column; overflow: hidden;
        }
        .column-toggle-dropdown.active { display: flex; }
        .column-toggle-header {
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(135deg, rgba(66,153,225,0.15) 0%, rgba(49,130,206,0.1) 100%);
        }
        .column-toggle-header h4 { margin: 0; font-size: 14px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .column-toggle-header button { background: transparent; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; padding: 4px; }
        .column-toggle-header button:hover { color: var(--text-primary); }
        .column-toggle-actions {
            padding: 10px 14px; border-bottom: 1px solid var(--border);
            display: flex; gap: 8px; background: rgba(0,0,0,0.1);
        }
        .column-toggle-actions button {
            flex: 1; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-secondary);
            transition: all 0.2s;
        }
        .column-toggle-actions button:hover { border-color: var(--accent); color: white; }
        .column-toggle-list { flex: 1; overflow-y: auto; padding: 8px 0; max-height: 400px; }
        .column-toggle-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 16px;
            cursor: pointer; font-size: 13px; transition: background 0.15s;
        }
        .column-toggle-item:hover { background: rgba(255,255,255,0.05); }
        .column-toggle-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent);
        }
        .column-toggle-item label { cursor: pointer; flex: 1; color: var(--text-primary); }
        .column-toggle-item.hidden-col label { color: var(--text-secondary); text-decoration: line-through; }
        .column-toggle-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 10000; display: none;
        }
        .column-toggle-overlay.active { display: block; }
        
        .watchlist-star { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .watchlist-star:hover { color: var(--warning); }
        .watchlist-star.active { color: var(--warning); }
        
        /* All Data table styles - larger for better readability */
        #all-data .data-table th { font-size: 11px; padding: 10px 8px; white-space: nowrap; min-width: 100px; }
        #all-data .data-table td { font-size: 12px; padding: 8px; white-space: nowrap; max-width: 250px; overflow: hidden; text-overflow: ellipsis; }
        #all-data .scrollable-table { overflow-x: auto; }
        #all-data .filter-th-btns button { width: 20px; height: 20px; font-size: 10px; }
        
        /* Zoom controls */
        .zoom-controls { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 10px 8px; }
        .zoom-btn { width: 28px; height: 28px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .zoom-btn:hover { background: var(--accent); border-color: var(--accent); }
        .zoom-reset-btn { width: 100%; margin-top: 8px; padding: 6px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .zoom-reset-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        /* Dashboard wrapper for zoom - applies to both sidebar and content */
        .dashboard-wrapper { zoom: 1; }
        
        /* Pallet Pictures Gallery Styles */
        .pallet-drilldown { display: none; background: var(--bg-card); border-radius: 0 0 14px 14px; padding: 20px; border: 1px solid var(--border); border-top: 2px solid var(--accent); margin-top: -1px; }
        .pallet-drilldown.active { display: block; }
        .pallet-drilldown-content { max-width: 100%; }
        tr.drilldown-active { background: rgba(49, 130, 206, 0.15) !important; }
        tr.drilldown-active td { border-bottom: none !important; }
        .order-drilldown-row td { border-top: none !important; }
        .pallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
        .pallet-header h3 { font-size: 18px; }
        .pallet-summary { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
        .pallet-summary-item { background: var(--bg-dark); padding: 8px 12px; border-radius: 6px; }
        .pallet-summary-item .label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .pallet-summary-item .value { font-size: 14px; font-weight: 700; }
        .pallet-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
        .photo-drilldown-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; width: 100%; }
        .photo-drilldown-box { padding: 20px; border-radius: 12px; min-height: 220px; display: flex; flex-direction: column; flex: 1; }
        .photo-drilldown-box h4 { margin: 0 0 16px 0; font-size: 14px; font-weight: 600; }
        .photo-drilldown-box .photo-btn { display: inline-block; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; margin: 4px; }
        .photo-drilldown-box .photo-info { font-size: 11px; color: var(--text-secondary); line-height: 1.6; margin-top: auto; }
        .pallet-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.2s; }
        .pallet-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .pallet-card-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pallet-card-header h4 { font-size: 14px; font-weight: 600; }
        .pallet-card-header .pallet-meta { font-size: 11px; color: var(--text-secondary); }
        .pallet-images { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .pallet-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .pallet-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
        .pallet-card-details { padding: 12px; background: rgba(0,0,0,0.2); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pallet-detail { font-size: 11px; }
        .pallet-detail .label { color: var(--text-secondary); }
        .pallet-detail .value { font-weight: 600; color: var(--text-primary); }
        .drawing-thumbnails { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .drawing-thumb {
            width: 180px; cursor: pointer; border-radius: 8px; overflow: hidden;
            border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card);
        }
        .drawing-thumb:hover { border-color: #ed8936; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .drawing-thumb img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .drawing-thumb .drawing-label { padding: 6px 10px; font-size: 11px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(237, 137, 54, 0.15); }
        .drawing-thumbnails { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .drawing-thumb { width: 180px; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card); }
        .drawing-thumb:hover { border-color: #ed8936; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .drawing-thumb img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .drawing-thumb .drawing-label { padding: 6px 10px; font-size: 11px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(237, 137, 54, 0.15); }
        /* Photo thumbnails - smaller than drawings */
        .photo-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; }
        .photo-thumb { width: 100px; cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid var(--border); transition: all 0.2s; background: var(--bg-card); }
        .photo-thumb:hover { border-color: var(--accent); transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .photo-thumb img { width: 100%; height: 75px; object-fit: cover; display: block; }
        .photo-thumb .photo-label { padding: 4px 6px; font-size: 10px; font-weight: 600; text-align: center; color: var(--text-primary); background: rgba(0,0,0,0.2); }
        .photo-thumb.pallet-photo:hover { border-color: var(--accent); }
        .photo-thumb.pallet-photo .photo-label { background: rgba(49, 130, 206, 0.3); }
        .photo-thumb.fusion-photo:hover { border-color: #38b2ac; }
        .photo-thumb.fusion-photo .photo-label { background: rgba(56, 178, 172, 0.3); }
        .photo-thumb.shipment-photo:hover { border-color: var(--success); }
        .photo-thumb.shipment-photo .photo-label { background: rgba(56, 161, 105, 0.3); }
        .photo-thumb.paperwork-photo:hover { border-color: #718096; }
        .photo-thumb.paperwork-photo .photo-label { background: rgba(113, 128, 150, 0.3); }
        .photo-thumb.closeup-photo:hover { border-color: #805ad5; }
        .photo-thumb.closeup-photo .photo-label { background: rgba(128, 90, 213, 0.3); }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .image-modal.active { display: flex; }
        .image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .image-modal-close:hover { background: var(--danger); }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover td { background: rgba(49,130,206,0.15) !important; }
        .pallet-indicator { margin-left: 6px; color: var(--accent); font-size: 12px; }
        
        /* Inventory History Modal */
        .history-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2500; align-items: center; justify-content: center; }
        .history-modal-overlay.active { display: flex; }
        .history-modal { background: var(--bg-card); border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .history-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }
        .history-modal-header h3 { font-size: 18px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .history-modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .history-modal-close:hover { background: var(--danger); }
        .history-modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 70px); }
        .history-chart-container { height: 300px; margin-bottom: 20px; }
        .history-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
        .history-date-inputs { display: flex; gap: 16px; flex-wrap: wrap; }
        .history-date-group { display: flex; align-items: center; gap: 8px; }
        .history-date-group label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
        .history-date-group input[type="date"] { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: white; font-size: 12px; }
        .history-date-group input[type="date"]:focus { outline: none; border-color: var(--accent); }
        .history-presets { display: flex; gap: 8px; flex-wrap: wrap; }
        .history-presets button { padding: 8px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .history-presets button:hover { background: var(--accent); border-color: var(--accent); color: white; }
        .history-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .history-stat { background: var(--bg-dark); padding: 14px; border-radius: 10px; text-align: center; }
        .history-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .history-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        .history-loading, .history-no-data { text-align: center; padding: 40px; color: var(--text-secondary); }
        .inv-history-btn { margin-left: 8px; background: var(--accent); color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; opacity: 0.8; transition: all 0.2s; }
        .inv-history-btn:hover { opacity: 1; }
        @media (max-width: 768px) {
            .history-modal { width: 95%; max-height: 95vh; }
            .history-controls { flex-direction: column; align-items: stretch; }
            .history-date-inputs { justify-content: center; }
            .history-presets { justify-content: center; }
            .history-stats { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Inventory History Page (Multi-Part) */
        .history-page-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 180px); }
        .history-parts-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .history-panel-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-panel-header h3 { font-size: 14px; font-weight: 600; }
        .history-selected-count { font-size: 11px; color: var(--accent); font-weight: 500; }
        .history-parts-search { margin: 12px; padding: 10px 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 12px; }
        .history-parts-search:focus { outline: none; border-color: var(--accent); }
        .history-parts-actions { display: flex; gap: 8px; padding: 0 12px 12px; }
        .history-parts-actions button { flex: 1; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .history-parts-actions button:hover { border-color: var(--accent); color: white; }
        .history-parts-list { flex: 1; overflow-y: auto; padding: 0 8px 8px; }
        .history-part-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .history-part-item:hover { background: rgba(255,255,255,0.05); }
        .history-part-item.selected { background: rgba(49,130,206,0.2); }
        .history-part-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
        .history-part-item .part-info { flex: 1; min-width: 0; }
        .history-part-item .part-number { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-part-item .part-type { font-size: 10px; color: var(--text-secondary); }
        .history-part-item .part-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .history-chart-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .history-chart-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .history-page-chart-container { flex: 1; position: relative; min-height: 300px; }
        .history-page-chart-container canvas { width: 100% !important; height: 100% !important; }
        .history-page-no-selection { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); font-size: 14px; }
        .history-legend { display: flex; flex-wrap: wrap; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
        .history-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .history-legend-color { width: 20px; height: 4px; border-radius: 2px; }
        .history-legend-below { font-size: 10px; color: var(--danger); margin-left: 4px; }
        .history-page-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 150px; overflow-y: auto; }
        .history-part-stat-card { background: var(--bg-dark); border-radius: 10px; padding: 12px; }
        .history-part-stat-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .history-part-stat-color { width: 12px; height: 12px; border-radius: 3px; }
        .history-part-stat-name { font-weight: 600; font-size: 12px; flex: 1; }
        .history-part-stat-values { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .history-part-stat-item { text-align: center; }
        .history-part-stat-value { font-size: 14px; font-weight: 600; color: var(--accent); }
        .history-part-stat-value.below-min { color: var(--danger); }
        .history-part-stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        @media (max-width: 900px) {
            .history-page-layout { grid-template-columns: 1fr; height: auto; }
            .history-parts-panel { max-height: 300px; }
            .history-page-chart-container { min-height: 350px; }
        }
        
        /* ========================================== */
        /* LIGHT THEME OVERRIDES                      */
        /* ========================================== */
        
        /* Page Headers */
        html.light-theme .page-header h2 {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Cards - Department Cards, Stat Cards, Quick Stats */
        html.light-theme .dept-card,
        html.light-theme .stat-card,
        html.light-theme .quick-stat {
            background: var(--card-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .dept-card:hover {
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        html.light-theme .stat-card:hover {
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        
        /* Chart Containers */
        html.light-theme .chart-container {
            background: var(--card-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        /* Toolbar */
        html.light-theme .toolbar {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .toolbar select,
        html.light-theme .toolbar input[type="date"],
        html.light-theme .toolbar input[type="text"] {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .toolbar-btn {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .toolbar-btn:hover {
            background: rgba(49,130,206,0.1);
        }
        
        /* Search Box */
        html.light-theme .search-box {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        /* Data Tables */
        html.light-theme .data-table th {
            background: linear-gradient(135deg, #2b6cb0 0%, #3182ce 100%);
        }
        html.light-theme .data-table th:hover {
            background: linear-gradient(135deg, #3182ce 0%, #4299e1 100%);
        }
        html.light-theme .data-table tr:hover td {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .data-table tr:nth-child(even) td {
            background: var(--table-row-alt);
        }
        html.light-theme .data-table tr:nth-child(even):hover td {
            background: rgba(49,130,206,0.08);
        }
        
        /* Scrollable Tables */
        html.light-theme .scrollable-table::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        html.light-theme .scrollable-table::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
        }
        
        /* Info Banner */
        html.light-theme .info-banner.warning {
            background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
            border-color: var(--warning);
        }
        html.light-theme .info-banner.warning p {
            color: #744210;
        }
        html.light-theme .info-banner.info {
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);
            border-color: var(--accent);
        }
        html.light-theme .info-banner.info p {
            color: #1a365d;
        }
        
        /* Modals */
        html.light-theme .filter-dropdown {
            background: var(--modal-bg);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        html.light-theme .filter-dropdown input {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border);
        }
        html.light-theme .filter-values-list label {
            color: var(--text-primary);
        }
        html.light-theme .filter-values-list label:hover {
            background: rgba(49,130,206,0.1);
        }
        
        /* Inventory History Modal */
        html.light-theme .history-modal {
            background: var(--modal-bg);
            box-shadow: 0 20px 60px var(--shadow-color);
        }
        html.light-theme .history-modal-header {
            background: linear-gradient(135deg, #2b6cb0 0%, #3182ce 100%);
        }
        html.light-theme .history-controls,
        html.light-theme .history-stats {
            background: var(--bg-dark);
        }
        
        /* Inventory History Page */
        html.light-theme .history-parts-panel,
        html.light-theme .history-chart-panel {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .history-parts-search {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .history-parts-actions button {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .history-part-item:hover {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .history-part-item.selected {
            background: rgba(49,130,206,0.15);
        }
        html.light-theme .history-part-stat-card {
            background: var(--bg-dark);
        }
        
        /* BOM Explorer */
        html.light-theme .bom-sidebar,
        html.light-theme .bom-main {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .bom-search,
        html.light-theme .bom-part-search {
            background: var(--input-bg);
            color: var(--text-primary);
        }
        html.light-theme .bom-part-item:hover {
            background: rgba(49,130,206,0.05);
        }
        html.light-theme .bom-part-item.selected {
            background: rgba(49,130,206,0.15);
        }
        
        /* Loading State */
        html.light-theme .spinner {
            border-color: rgba(0,0,0,0.1);
            border-top-color: var(--accent);
        }
        
        /* Mobile Header */
        html.light-theme .mobile-header {
            background: var(--sidebar-bg);
        }
        
        /* Drilldown Panel */
        html.light-theme .drilldown-panel {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .drilldown-section {
            background: var(--bg-dark);
        }
        
        /* Photo Drilldown */
        html.light-theme .pallet-drilldown {
            background: var(--bg-card);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        html.light-theme .photo-box {
            background: var(--bg-dark);
        }
        
        /* Zoom Controls */
        html.light-theme .zoom-controls input,
        html.light-theme .zoom-btn {
            background: rgba(0,0,0,0.1);
            color: rgba(255,255,255,0.9);
        }
        html.light-theme .zoom-reset-btn {
            background: rgba(0,0,0,0.1);
            color: rgba(255,255,255,0.9);
        }
        
        /* Data Info in Sidebar */
        html.light-theme .data-info {
            border-top-color: rgba(255,255,255,0.2);
        }
        html.light-theme .data-info strong {
            color: white;
        }
        html.light-theme .data-info {
            color: rgba(255,255,255,0.7);
        }
        /* ============================================================
           AI CHAT PANEL
           ============================================================ */
        .ai-chat-fab {
            position: fixed; bottom: 24px; right: 24px; z-index: 2000;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            border: none; color: white; font-size: 26px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(66,133,244,0.4);
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
        }
        .ai-chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(66,133,244,0.6); }
        .ai-chat-fab.hidden { display: none; }

        .ai-chat-panel {
            position: fixed; bottom: 24px; right: 24px; z-index: 2001;
            width: 420px; max-width: calc(100vw - 48px); height: 540px; max-height: calc(100vh - 48px);
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.9) translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.25s ease;
        }
        .ai-chat-panel.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: auto; }

        .ai-chat-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(66,133,244,0.15) 0%, rgba(52,168,83,0.1) 100%);
        }
        .ai-chat-header-left { display: flex; align-items: center; gap: 10px; }
        .ai-chat-header-left .ai-icon { font-size: 22px; }
        .ai-chat-header-left .ai-title { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .ai-chat-header-left .ai-subtitle { font-size: 10px; color: var(--text-secondary); }
        .ai-chat-header-actions { display: flex; gap: 6px; }
        .ai-chat-header-actions button {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            font-size: 16px; padding: 4px 6px; border-radius: 6px; transition: all 0.2s;
        }
        .ai-chat-header-actions button:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

        .ai-chat-messages {
            flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
            scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        .ai-chat-messages::-webkit-scrollbar { width: 6px; }
        .ai-chat-messages::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

        .ai-msg { max-width: 88%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.55; word-wrap: break-word; }
        .ai-msg.user { align-self: flex-end; background: linear-gradient(135deg, #4285f4 0%, #5a9cf5 100%); color: white; border-bottom-right-radius: 4px; }
        .ai-msg.bot { align-self: flex-start; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .ai-msg.bot .ai-table-wrap { overflow-x: auto; margin: 8px 0; -webkit-overflow-scrolling: touch; border-radius: 6px; border: 1px solid var(--border); }
        .ai-msg.bot table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .ai-msg.bot table th, .ai-msg.bot table td { padding: 5px 10px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
        .ai-msg.bot table th { background: rgba(66,133,244,0.2); font-weight: 600; font-size: 11px; }
        .ai-msg.bot code { background: rgba(0,0,0,0.2); padding: 1px 5px; border-radius: 3px; font-size: 12px; }
        .ai-msg.bot strong { color: #63b3ed; }
        .ai-msg.bot ul, .ai-msg.bot ol { padding-left: 18px; margin: 4px 0; }
        .ai-msg.system { align-self: center; color: var(--text-secondary); font-size: 11px; font-style: italic; padding: 4px 12px; }
        .ai-msg.error { align-self: flex-start; background: rgba(229,62,62,0.15); color: var(--danger-light); border: 1px solid rgba(229,62,62,0.3); border-bottom-left-radius: 4px; }

        .ai-typing { display: flex; align-items: center; gap: 4px; padding: 10px 14px; align-self: flex-start; }
        .ai-typing-dot { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: aiTypingBounce 1.4s infinite ease-in-out; }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiTypingBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

        .ai-chat-input-area {
            display: flex; align-items: center; gap: 8px;
            padding: 12px 14px; border-top: 1px solid var(--border); background: var(--input-bg);
        }
        .ai-chat-input-area input {
            flex: 1; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px;
            padding: 10px 14px; color: var(--text-primary); font-size: 13px; outline: none;
            transition: border-color 0.2s;
        }
        .ai-chat-input-area input::placeholder { color: var(--text-secondary); }
        .ai-chat-input-area input:focus { border-color: #4285f4; }
        .ai-chat-input-area button.ai-send-btn {
            width: 38px; height: 38px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white; font-size: 18px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .ai-chat-input-area button.ai-send-btn:hover { transform: scale(1.08); }
        .ai-chat-input-area button.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .ai-suggestions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 14px; border-top: 1px solid var(--border); }
        .ai-suggestion-chip {
            background: rgba(66,133,244,0.12); border: 1px solid rgba(66,133,244,0.25);
            color: #63b3ed; padding: 5px 12px; border-radius: 16px; font-size: 11px;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .ai-suggestion-chip:hover { background: rgba(66,133,244,0.25); border-color: #4285f4; }

        @media (max-width: 600px) {
            .ai-chat-panel { width: calc(100vw - 16px); height: calc(100vh - 80px); bottom: 8px; right: 8px; border-radius: 12px; }
            .ai-chat-fab { bottom: 16px; right: 16px; width: 50px; height: 50px; font-size: 22px; }
            .ai-suggestions { display: none; }
        }
    </style>
</head>
<body>
    <!-- Image Modal for Pallet Pictures -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <div class="image-modal-close" onclick="closeImageModal()">âœ•</div>
        <img id="modalImage" src="" alt="Pallet Picture">
    </div>

    <!-- Column Filter Dropdown Modal -->
    <div class="filter-dropdown" id="columnFilterDropdown">
        <div class="filter-dropdown-header">
            <h4 id="filterDropdownTitle" data-i18n="ui.filterColumn">Filter Column</h4>
            <button onclick="closeFilterDropdown()">âœ•</button>
        </div>
        <input type="text" class="filter-search" id="filterDropdownSearch" data-i18n-placeholder="ui.searchValues" placeholder="Search values..." oninput="filterDropdownSearch()">
        <div class="filter-actions">
            <button onclick="filterSelectAll()" data-i18n="ui.selectAll">Select All</button>
            <button onclick="filterDeselectAll()" data-i18n="ui.deselectAll">Deselect All</button>
        </div>
        <div class="filter-values-list" id="filterValuesList"></div>
        <div class="filter-dropdown-footer">
            <button class="clear-btn" onclick="clearColumnFilter()" data-i18n="ui.clear">Clear</button>
            <button class="hide-col-btn" onclick="hideCurrentColumn()" style="background:var(--bg-dark);border-color:var(--border);" data-i18n="ui.hideColumn">ðŸ‘ Hide</button>
            <button class="apply-btn" onclick="applyColumnFilter()" data-i18n="ui.apply">Apply</button>
        </div>
    </div>

    <!-- Column Toggle Dropdown Modal -->
    <div class="column-toggle-overlay" id="columnToggleOverlay" onclick="closeColumnToggle()"></div>
    <div class="column-toggle-dropdown" id="columnToggleDropdown">
        <div class="column-toggle-header">
            <h4>âš™ï¸ <span data-i18n="ui.columns">Columns</span></h4>
            <button onclick="closeColumnToggle()">âœ•</button>
        </div>
        <div class="column-toggle-actions">
            <button onclick="columnSelectAll()" data-i18n="ui.selectAll">Select All</button>
            <button onclick="columnDeselectAll()" data-i18n="ui.deselectAll">Deselect All</button>
        </div>
        <div class="column-toggle-list" id="columnToggleList"></div>
    </div>

    <!-- Inventory History Modal -->
    <div class="history-modal-overlay" id="inventoryHistoryModal" onclick="closeInventoryHistoryModal(event)">
        <div class="history-modal" onclick="event.stopPropagation()">
            <div class="history-modal-header">
                <h3>ðŸ“ˆ <span data-i18n="inv.historyTitle">Inventory History</span>: <span id="historyPartName"></span></h3>
                <button class="history-modal-close" onclick="closeInventoryHistoryModal()">âœ•</button>
            </div>
            <div class="history-modal-body">
                <div class="history-chart-container">
                    <canvas id="inventoryHistoryChart"></canvas>
                </div>
                <div class="history-controls">
                    <div class="history-date-inputs">
                        <div class="history-date-group">
                            <label data-i18n="ui.from">From</label>
                            <input type="date" id="historyStartDate" onchange="updateHistoryChart()">
                        </div>
                        <div class="history-date-group">
                            <label data-i18n="ui.to">To</label>
                            <input type="date" id="historyEndDate" onchange="updateHistoryChart()">
                        </div>
                    </div>
                    <div class="history-presets">
                        <button onclick="applyHistoryPreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                        <button onclick="applyHistoryPreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                        <button onclick="applyHistoryPreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                        <button onclick="applyHistoryPreset('all')" data-i18n="inv.allData">All Data</button>
                    </div>
                </div>
                <div class="history-stats" id="historyStatsPanel">
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatCurrent">-</div>
                        <div class="history-stat-label" data-i18n="inv.current">Current</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMin">-</div>
                        <div class="history-stat-label" data-i18n="inv.minimum">Minimum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatMax">-</div>
                        <div class="history-stat-label" data-i18n="inv.maximum">Maximum</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value" id="historyStatAvg">-</div>
                        <div class="history-stat-label" data-i18n="inv.average">Average</div>
                    </div>
                </div>
                <div class="history-loading" id="historyLoading" style="display:none;">
                    <span data-i18n="ui.loading">Loading...</span>
                </div>
                <div class="history-no-data" id="historyNoData" style="display:none;">
                    <span data-i18n="inv.noHistory">No history data available for this part</span>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-header">
        <div><h1>Molding</h1><span style="font-size:10px;color:var(--text-secondary);">Operations Dashboard</span></div>
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    </div>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button class="sidebar-tab" id="sidebarTabBtn" onclick="toggleSidebar()" title="Show Menu">â˜° Menu</button>
    <div class="sidebar" id="mainSidebar">
        <div class="logo">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div><h1>Molding</h1><span id="logoSubtitle">Operations Dashboard</span></div>
                <button id="sidebarToggleBtn" onclick="toggleSidebar()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:var(--text-secondary);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">âœ• Hide</button>
            </div>
        </div>
        <div class="toggle-controls">
            <div class="lang-toggle">
                <button class="lang-btn active" id="langEN" onclick="setLanguage('en')">English</button>
                <button class="lang-btn" id="langES" onclick="setLanguage('es')">EspaÃ±ol</button>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn" id="themeDark" onclick="setTheme('dark')" title="Dark Theme">ðŸŒ™</button>
                <button class="theme-btn" id="themeLight" onclick="setTheme('light')" title="Light Theme">â˜€ï¸</button>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-item active" data-page="main" onclick="navigateTo('main')"><span class="icon">ðŸ </span> <span data-i18n="nav.main">Main Dashboard</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.production">Production</div>
            <div class="nav-item" data-page="orders-data" onclick="navigateTo('orders-data')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.ordersData">Orders Data</span></div>
            <div class="nav-item sub-item" data-page="production-make" onclick="navigateTo('production-make')"><span class="icon">ðŸ­</span> <span data-i18n="nav.productionMake">Need to Make</span></div>
            <div class="nav-item sub-item" data-page="orders-queue" onclick="navigateTo('orders-queue')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.ordersQueue">Need to Package</span></div>
            <div class="nav-item sub-item" data-page="orders-staged" onclick="navigateTo('orders-staged')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.ordersStaged">Ready to Ship</span></div>
            <div class="nav-item sub-item" data-page="orders-shipped" onclick="navigateTo('orders-shipped')"><span class="icon">ðŸšš</span> <span data-i18n="nav.ordersShipped">Shipped</span></div>
            <div class="nav-item" data-page="inventory" onclick="navigateTo('inventory')"><span class="icon">ðŸ“¦</span> <span data-i18n="nav.inventory">Inventory</span></div>
            <div class="nav-item sub-item" data-page="inventory-history" onclick="navigateTo('inventory-history')"><span class="icon">ðŸ“ˆ</span> <span data-i18n="nav.inventoryHistory">Inventory History</span></div>
            <div class="nav-item sub-item" data-page="drawings-library" onclick="navigateTo('drawings-library')"><span class="icon">ðŸ“</span> <span data-i18n="nav.drawingsLibrary">Drawings</span></div>
            <div class="nav-item" data-page="pallet-records" onclick="navigateTo('pallet-records')"><span class="icon">ðŸ“·</span> <span data-i18n="nav.palletRecords">Pallet Records</span></div>
            <div class="nav-item" data-page="shipping-records" onclick="navigateTo('shipping-records')"><span class="icon">ðŸš›</span> <span data-i18n="nav.shippingRecords">Shipping Records</span></div>
            <div class="nav-item" data-page="staged-records" onclick="navigateTo('staged-records')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.stagedRecords">Staged Records</span></div>
        </div>
        <div class="nav-section" id="salesNavSection">
            <div class="nav-section-title sales-locked" id="salesNavTitle" onclick="promptSalesPassword()">
                <span class="lock-icon">ðŸ”’</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>
            </div>
            <div class="sales-nav-items" id="salesNavItems" style="display:none;">
                <div class="nav-item" data-page="sales-overview" onclick="navigateTo('sales-overview')"><span class="icon">ðŸ“Š</span> <span data-i18n="nav.plOverview">P/L Overview</span></div>
                <div class="nav-item sub-item" data-page="sales-parts" onclick="navigateTo('sales-parts')"><span class="icon">ðŸ”§</span> <span data-i18n="nav.byPart">By Part Number</span></div>
                <div class="nav-item sub-item" data-page="sales-customers" onclick="navigateTo('sales-customers')"><span class="icon">ðŸ‘¥</span> <span data-i18n="nav.byCustomer">By Customer</span></div>
                <div class="nav-item sub-item" data-page="sales-dates" onclick="navigateTo('sales-dates')"><span class="icon">ðŸ“…</span> <span data-i18n="nav.byDate">By Date</span></div>
            </div>
        </div>
        <div class="nav-section" id="bomNavSection" style="display:none;">
            <div class="nav-section-title" data-i18n="nav.billOfMaterials">Bill of Materials</div>
            <div class="nav-item" data-page="bom" onclick="navigateTo('bom')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.bomExplorer">BOM Explorer</span></div>
        </div>
        <div class="nav-section" id="rawDataNavSection">
            <div class="nav-section-title" data-i18n="nav.rawData">Raw Data</div>
            <div class="nav-item locked-item" id="allDataNavItem" data-page="all-data" onclick="handleAllDataClick()"><span class="icon">ðŸ—ƒ</span> <span data-i18n="nav.allData">All Data</span></div>
            <div class="nav-item locked-item" id="fpRefNavItem" data-page="fp-reference" onclick="handleRefDataClick('fp-reference')"><span class="icon">ðŸ“‹</span> <span data-i18n="nav.fpReference">FP Reference</span></div>
            <div class="nav-item locked-item" id="custRefNavItem" data-page="customer-reference" onclick="handleRefDataClick('customer-reference')"><span class="icon">ðŸ‘¥</span> <span data-i18n="nav.customerReference">Customer Reference</span></div>
            <div class="nav-item locked-item" id="quotesNavItem" data-page="quotes-registry" onclick="handleRefDataClick('quotes-registry')"><span class="icon">ðŸ“</span> <span data-i18n="nav.quotesRegistry">Quotes Registry</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="nav-section">
            <div class="nav-item" onclick="toggleAiChat()" style="background:linear-gradient(135deg,rgba(66,133,244,0.15),rgba(52,168,83,0.1));"><span class="icon">ðŸ¤–</span> <span data-i18n="nav.aiAssistant">AI Assistant</span></div>
        </div>
        <div class="nav-divider"></div>
        <div class="zoom-controls">
            <label style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block;" data-i18n="ui.zoom">Zoom</label>
            <div style="display:flex;align-items:center;gap:6px;">
                <button class="zoom-btn" onclick="adjustZoom(-10)">âˆ’</button>
                <input type="number" id="zoomInput" value="100" min="50" max="200" step="10" onchange="setZoom(this.value)" style="width:50px;text-align:center;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:white;padding:4px;font-size:11px;">
                <span style="font-size:10px;color:var(--text-secondary);">%</span>
                <button class="zoom-btn" onclick="adjustZoom(10)">+</button>
            </div>
            <button class="zoom-reset-btn" onclick="resetZoom()" data-i18n="ui.reset">Reset (100%)</button>
        </div>
        <div class="data-info" id="dataInfo"><strong>Loading...</strong></div>
        <div style="color:#718096;font-size:10px;margin-top:8px;text-align:center;">Dashboard v7.22</div>
    </div>

    <div class="main-content">
        <div id="loadingState" class="loading"><div class="spinner"></div><p style="margin-top:18px;color:var(--text-secondary);" data-i18n="loading">Loading data from Google Sheets...</p></div>

        <!-- MAIN DASHBOARD -->
        <div id="main" class="page">
            <div class="page-header">
                <div><h2 data-i18n="main.title">Operations Dashboard</h2><p data-i18n="main.subtitle">Real-time overview of manufacturing operations</p></div>
                <div class="last-updated"><span class="dot"></span><span id="lastUpdated">Loading...</span></div>
            </div>
            <div class="quick-stats">
                <div class="quick-stat"><div class="value warning" id="qsNeedToMake">-</div><div class="label" data-i18n="stats.needToMake">Need to Make</div></div>
                <div class="quick-stat"><div class="value" id="qsUrgentOrders">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                <div class="quick-stat"><div class="value" id="qsTotalQty">-</div><div class="label" data-i18n="stats.totalUnits">Total Units</div></div>
                <div class="quick-stat"><div class="value warning" id="qsMissingComponents">-</div><div class="label" data-i18n="stats.missingParts">Missing Parts</div></div>
            </div>
            <div class="dept-grid">
                <div class="dept-card production" onclick="navigateTo('orders-queue')">
                    <div class="icon-large">ðŸ­</div>
                    <h3 data-i18n="dept.production">Production Planning</h3>
                    <p data-i18n="dept.productionDesc">View orders to make, component status, and production queue</p>
                    <div class="metrics">
                        <div class="metric"><div class="value" id="deptProdOrders">-</div><div class="label" data-i18n="dept.needToMake">Need to Make</div></div>
                        <div class="metric"><div class="value" id="deptProdUnits">-</div><div class="label" data-i18n="dept.units">Units</div></div>
                        <div class="metric"><div class="value warning" id="deptProdUrgent">-</div><div class="label" data-i18n="stats.urgent">Urgent</div></div>
                    </div>
                </div>
                <div class="dept-card inventory" onclick="navigateTo('inventory')">
                    <div class="icon-large">ðŸ“¦</div>
                    <h3 data-i18n="dept.inventory">Inventory Management</h3>
                    <p data-i18n="dept.inventoryDesc">Stock levels, reorder points, and material tracking</p>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.ordersByStatus">Orders by Status</h3></div>
                    <div class="chart-wrapper"><canvas id="mainStatusChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div class="chart-header"><h3 data-i18n="chart.upcomingDeadlines">Upcoming Deadlines (Next 14 Days)</h3></div>
                    <div class="chart-wrapper"><canvas id="mainDeadlineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ORDERS DATA PAGE -->
        <div id="orders-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersData.title">All Orders Data</h2><p data-i18n="ordersData.subtitle">Complete order database with all statuses</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â†  <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="ordersDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersDataBtnRollTech" onclick="toggleOrdersDataCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersDataBtnMolding" onclick="toggleOrdersDataCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersDataBtnSnapPad" onclick="toggleOrdersDataCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group status-filters">
                    <label data-i18n="ui.status">Status:</label>
                    <button class="status-btn pending active" id="ordersDataStatusPending" onclick="toggleOrdersDataStatus('pending')"><span data-i18n="status.needToMake">Need to Make</span></button>
                    <button class="status-btn wip active" id="ordersDataStatusWip" onclick="toggleOrdersDataStatus('wip')"><span data-i18n="status.making">Making</span></button>
                    <button class="status-btn staged active" id="ordersDataStatusStaged" onclick="toggleOrdersDataStatus('staged')"><span data-i18n="status.readyToShip">Ready to Ship</span></button>
                    <button class="status-btn shipped" id="ordersDataStatusShipped" onclick="toggleOrdersDataStatus('shipped')"><span data-i18n="status.shipped">Shipped</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersDataClearFiltersBtn" onclick="clearAllTableFilters('ordersData')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersDataColumnsBtn" onclick="openColumnToggle('ordersData')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersDataSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersDataTable()">
                <button class="toolbar-btn" onclick="exportOrdersDataToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalOrders">Total Orders</div><div class="value" id="ordersDataTotalOrders">-</div><div class="sub" id="ordersDataTotalUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needToMake">Need to Make</div><div class="value warning" id="ordersDataNeedToMake">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.making">Making</div><div class="value" style="color:var(--teal);" id="ordersDataMaking">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.readyToShip">Ready to Ship</div><div class="value positive" id="ordersDataReadyToShip">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.orders">Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersDataTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="ordersDataTable"><thead><tr id="ordersDataTableHeader"></tr></thead><tbody id="ordersDataTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- PRODUCTION MAKE PAGE (Parts to be manufactured) -->
        <div id="production-make" class="page">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px;gap:8px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <button class="category-btn" id="prodMakeBtnTire" onclick="toggleProdMakeCategory('Tire')" style="padding:4px 10px;font-size:11px;background:#ed8936;"><span class="indicator"></span> Tires</button>
                    <button class="category-btn" id="prodMakeBtnHub" onclick="toggleProdMakeCategory('Hub')" style="padding:4px 10px;font-size:11px;background:#38b2ac;"><span class="indicator"></span> Hubs</button>
                    <button class="category-btn" id="prodMakeBtnFinished" onclick="toggleProdMakeCategory('Rubber molded finished part')" style="padding:4px 10px;font-size:11px;background:#805ad5;"><span class="indicator"></span> Finished Parts</button>
                    <button class="category-btn" id="prodMakeBtnBearing" onclick="toggleProdMakeCategory('Bearing')" style="padding:4px 10px;font-size:11px;background:#4a5568;"><span class="indicator"></span> Bearings</button>
                    <button class="category-btn active" id="prodMakeBtnAll" onclick="toggleProdMakeCategory('all')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> All</button>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);">Total Parts:</span> <strong id="prodMakeTotalParts" style="font-size:14px;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="prodMakeTotalUnits">-</span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <input type="text" class="search-box" id="prodMakeSearch" placeholder="Search part #, mold type..." oninput="filterProdMakeTable()" style="width:180px;padding:4px 8px;font-size:12px;">
                    <button class="toolbar-btn" onclick="exportProdMakeToCSV()" style="padding:4px 8px;font-size:11px;">ðŸ“¥ CSV</button>
                    <button class="toolbar-btn" onclick="navigateTo('main')" style="padding:4px 8px;font-size:11px;">â† Back</button>
                </div>
            </div>
            <div class="chart-container" style="margin:0 8px;">
                <div class="chart-header" style="padding:4px 12px;">
                    <h3 style="font-size:13px;">ðŸ­ Parts to Manufacture</h3>
                    <span style="color:var(--text-secondary);font-size:11px;" id="prodMakeTableCount">-</span>
                </div>
                <div class="scrollable-table" style="max-height:calc(100vh - 120px);">
                    <table class="data-table" style="font-size:12px;">
                        <thead>
                            <tr id="prodMakeTableHeader">
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('product')">Product â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('partNumber')">Part # â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('moldType')">Mold Type â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('fusionInventory')">Fusion Inv â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('minimums')">Minimums â†•</th>
                                <th style="cursor:pointer;" onclick="sortProdMakeTable('partsToBeMade')">Parts to Make â†•</th>
                                <th>ðŸ“ Drawing</th>
                            </tr>
                        </thead>
                        <tbody id="prodMakeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ORDERS QUEUE PAGE (Need to Package) -->
        <div id="orders-queue" class="page">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px;gap:8px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <button class="category-btn rolltech active" id="ordersQueueBtnRollTech" onclick="toggleOrdersQueueCategory('rolltech')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersQueueBtnMolding" onclick="toggleOrdersQueueCategory('molding')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersQueueBtnSnapPad" onclick="toggleOrdersQueueCategory('snappad')" style="padding:4px 10px;font-size:11px;"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.totalOrders">Total</span> <strong id="ordersQueueTotalOrders" style="font-size:14px;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="ordersQueueTotalUnits">-</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:#fc8181;">ðŸ”´</span> <strong id="ordersQueueUrgentCount" style="font-size:14px;color:#fc8181;">-</strong> <span style="font-size:11px;color:#fc8181;" data-i18n="stats.urgent">Urgent</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.dueThisWeek">Due This Week</span> <strong id="ordersQueueDueWeek" style="font-size:14px;color:#ecc94b;">-</strong>
                    <span style="font-size:11px;color:var(--text-secondary);" id="ordersQueueDueWeekUnits">-</span>
                    <span style="margin:0 4px;color:var(--text-secondary);">|</span>
                    <span style="font-size:12px;color:var(--text-secondary);" data-i18n="stats.componentsReady">Ready</span> <strong id="ordersQueueComponentsReady" style="font-size:14px;color:#48bb78;">-</strong>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <button class="toolbar-btn clear-all-filters-btn" id="ordersQueueClearFiltersBtn" onclick="clearAllTableFilters('ordersQueue')" style="padding:4px 8px;font-size:11px;">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear</span></button>
                    <button class="toolbar-btn columns-btn" id="ordersQueueColumnsBtn" onclick="openColumnToggle('ordersQueue')" style="padding:4px 8px;font-size:11px;">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                    <input type="text" class="search-box" id="ordersQueueSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersQueueTable()" style="width:140px;padding:4px 8px;font-size:12px;">
                    <button class="toolbar-btn" onclick="exportOrdersQueueToCSV()" style="padding:4px 8px;font-size:11px;">ðŸ“¥</button>
                    <button class="toolbar-btn" onclick="navigateTo('main')" style="padding:4px 8px;font-size:11px;">â† Back</button>
                </div>
            </div>
            <div class="info-banner warning" id="ordersQueueMissingBanner" style="margin:0 16px 4px;">
                <span class="icon">âš  </span>
                <p><strong id="ordersQueueMissingCount">0</strong> <span data-i18n="prod.missingMsg">orders have missing components.</span></p>
            </div>
            <div style="display:none;"><span id="ordersQueueLastUpdated">-</span></div>
            <div class="chart-container" style="margin:0 8px;">
                <div class="chart-header" style="padding:4px 12px;"><h3 data-i18n="table.ordersToMake" style="font-size:13px;">Orders to Make</h3><span style="color:var(--text-secondary);font-size:11px;" id="ordersQueueTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 100px);">
                    <table class="data-table" style="font-size:12px;"><thead><tr id="ordersQueueTableHeader"></tr></thead><tbody id="ordersQueueTableBody"></tbody></table>
                </div>
            </div>
        </div>
        <!-- ORDERS STAGED PAGE -->
        <div id="orders-staged" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersStaged.title">Staged Orders - Ready to Ship</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersStagedBtnRollTech" onclick="toggleOrdersStagedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersStagedBtnMolding" onclick="toggleOrdersStagedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersStagedBtnSnapPad" onclick="toggleOrdersStagedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersStagedClearFiltersBtn" onclick="clearAllTableFilters('ordersStaged')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersStagedColumnsBtn" onclick="openColumnToggle('ordersStaged')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersStagedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersStagedTable()">
                <button class="toolbar-btn" onclick="exportOrdersStagedToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.stagedOrders">Staged Orders</div><div class="value" id="ordersStagedTotalOrders">-</div><div class="sub" id="ordersStagedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersStagedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.avgOrderValue">Avg Order Value</div><div class="value" id="ordersStagedAvgValue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersStagedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.readyToShip">Ready to Ship</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersStagedTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table"><thead><tr id="ordersStagedTableHeader"></tr></thead><tbody id="ordersStagedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- ORDERS SHIPPED PAGE -->
        <div id="orders-shipped" class="page">
            <div class="page-header">
                <div><h2 data-i18n="ordersShipped.title">Shipped Orders History</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="ordersShippedBtnRollTech" onclick="toggleOrdersShippedCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="ordersShippedBtnMolding" onclick="toggleOrdersShippedCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="ordersShippedBtnSnapPad" onclick="toggleOrdersShippedCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="ordersShippedFromDate" onchange="applyShippedDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="ordersShippedToDate" onchange="applyShippedDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetShippedDateFilter()">ðŸ”„ Reset</button>
                <button class="toolbar-btn clear-all-filters-btn" id="ordersShippedClearFiltersBtn" onclick="clearAllTableFilters('ordersShipped')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="ordersShippedColumnsBtn" onclick="openColumnToggle('ordersShipped')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="ordersShippedSearch" data-i18n-placeholder="ui.search" placeholder="Search..." oninput="filterOrdersShippedTable()">
                <button class="toolbar-btn" onclick="exportOrdersShippedToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.shippedOrders">Shipped Orders</div><div class="value" id="ordersShippedTotalOrders">-</div><div class="sub" id="ordersShippedTotalUnits">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value positive" id="ordersShippedRevenue">-</div></div>
                <div class="stat-card financial-data"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="ordersShippedPL">-</div><div class="sub" id="ordersShippedMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.customers">Customers</div><div class="value" id="ordersShippedCustomers">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.shippedOrders">Shipped Orders</h3><span style="color:var(--text-secondary);font-size:12px;" id="ordersShippedTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table"><thead><tr id="ordersShippedTableHeader"></tr></thead><tbody id="ordersShippedTableBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- INVENTORY PAGE -->
        <div id="inventory" class="page">
            <div class="page-header">
                <div><h2 data-i18n="inv.title">Inventory Management</h2></div>
            </div>
            <div class="toolbar">
                <input type="text" class="search-box" id="invSearch" data-i18n-placeholder="ui.search" placeholder="Search items..." oninput="filterInvTable()">
                <div class="toolbar-group">
                    <button class="toolbar-btn active" id="invFilterAll" onclick="setInvFilter('all')" data-i18n="filter.all">All</button>
                    <button class="toolbar-btn" id="invFilterLow" onclick="setInvFilter('low')">âš ï¸ <span data-i18n="filter.lowStock">Low Stock</span></button>
                    <button class="toolbar-btn" id="invFilterNeeded" onclick="setInvFilter('needed')">ðŸ”§ <span data-i18n="filter.needsProduction">Needs Production</span></button>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="inventoryClearFiltersBtn" onclick="clearAllTableFilters('inventory')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="inventoryColumnsBtn" onclick="openColumnToggle('inventory')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportInvCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalItems">Total Items</div><div class="value" id="invStatTotal">-</div><div class="sub" id="invStatTypes">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.lowStock">Low Stock</div><div class="value" style="color:var(--danger);" id="invStatLow">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.needsProduction">Needs Production</div><div class="value" style="color:var(--warning);" id="invStatNeeded">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.adequateStock">Adequate Stock</div><div class="value" style="color:var(--success);" id="invStatOk">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.inventoryStatus">Inventory Status</h3><span style="color:var(--text-secondary);font-size:12px;" id="invTableCount">-</span></div>
                <div class="scrollable-table" style="max-height:calc(100vh - 340px);">
                    <table class="data-table" id="invTable">
                        <thead><tr id="invTableHeader"></tr></thead>
                        <tbody id="invTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- INVENTORY HISTORY PAGE (Multi-Part Comparison) -->
        <div id="inventory-history" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="inv.historyPageTitle">ðŸ“ˆ Inventory History</h2>
                    <p data-i18n="inv.historyPageSubtitle">Compare inventory levels over time for multiple parts</p>
                </div>
                <button class="toolbar-btn" onclick="navigateTo('inventory')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            
            <div class="history-page-layout">
                <!-- Left Panel: Part Selection -->
                <div class="history-parts-panel">
                    <div class="history-panel-header">
                        <h3 data-i18n="inv.selectParts">Select Parts</h3>
                        <span class="history-selected-count" id="historySelectedCount">0 <span data-i18n="inv.selected">selected</span></span>
                    </div>
                    <input type="text" class="history-parts-search" id="historyPartsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterHistoryPartsList()">
                    <div class="history-parts-actions">
                        <button onclick="selectAllHistoryParts()" data-i18n="ui.selectAll">Select All</button>
                        <button onclick="deselectAllHistoryParts()" data-i18n="ui.deselectAll">Deselect All</button>
                    </div>
                    <div class="history-parts-list" id="historyPartsList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Right Panel: Chart and Controls -->
                <div class="history-chart-panel">
                    <div class="history-chart-controls">
                        <div class="history-date-inputs">
                            <div class="history-date-group">
                                <label data-i18n="ui.from">From</label>
                                <input type="date" id="historyPageStartDate" onchange="updateHistoryPageChart()">
                            </div>
                            <div class="history-date-group">
                                <label data-i18n="ui.to">To</label>
                                <input type="date" id="historyPageEndDate" onchange="updateHistoryPageChart()">
                            </div>
                        </div>
                        <div class="history-presets">
                            <button onclick="applyHistoryPagePreset('last7')" data-i18n="inv.last7">Last 7 Days</button>
                            <button onclick="applyHistoryPagePreset('last30')" data-i18n="inv.last30">Last 30 Days</button>
                            <button onclick="applyHistoryPagePreset('last90')" data-i18n="inv.last90">Last 90 Days</button>
                            <button onclick="applyHistoryPagePreset('all')" data-i18n="inv.allData">All Data</button>
                        </div>
                    </div>
                    
                    <div class="history-page-chart-container" id="historyPageChartContainer">
                        <canvas id="inventoryHistoryPageChart"></canvas>
                        <div class="history-page-no-selection" id="historyPageNoSelection">
                            <span data-i18n="inv.selectPartsPrompt">Select one or more parts from the list to view their inventory history</span>
                        </div>
                    </div>
                    
                    <div class="history-legend" id="historyPageLegend">
                        <!-- Populated dynamically with part colors -->
                    </div>
                    
                    <div class="history-page-stats" id="historyPageStats">
                        <!-- Populated dynamically with stats for each selected part -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SALES OVERVIEW PAGE -->
        <div id="sales-overview" class="page">
            <div class="page-header">
                <div><h2 data-i18n="sales.title">P/L Overview</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('main')">â†  Back</button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="salesBtnRollTech" onclick="toggleSalesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="salesBtnMolding" onclick="toggleSalesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="salesBtnSnapPad" onclick="toggleSalesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportSalesCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.totalRevenue">Total Revenue</div><div class="value" id="salesStatRevenue">-</div><div class="sub" id="salesStatOrderCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.totalPL">Total P/L</div><div class="value" id="salesStatPL">-</div><div class="sub" id="salesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.shippedPL">Shipped P/L</div><div class="value" id="salesStatShippedPL">-</div><div class="sub" id="salesStatShippedCount">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.forecastedPL">Forecasted P/L</div><div class="value" id="salesStatForecastPL">-</div><div class="sub" id="salesStatForecastCount">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLTrend">Monthly P/L Trend</h3></div>
                <div class="chart-wrapper large"><canvas id="salesTrendChart"></canvas></div>
            </div>
        </div>

        <!-- SALES BY PARTS PAGE -->
        <div id="sales-parts" class="page">
            <div class="page-header">
                <div><h2 data-i18n="parts.title">P/L by Part Number</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="partsBtnRollTech" onclick="togglePartsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="partsBtnMolding" onclick="togglePartsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="partsBtnSnapPad" onclick="togglePartsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="partsFromDate" onchange="applyPartsDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="partsToDate" onchange="applyPartsDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetPartsDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="partsWatchlistBtn" onclick="togglePartsWatchlistFilter()">â­ <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="partsClearFiltersBtn" onclick="clearAllTableFilters('parts')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="partsColumnsBtn" onclick="openColumnToggle('parts')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="partsSearch" data-i18n-placeholder="ui.search" placeholder="Search parts..." oninput="filterPartsTable()">
                <button class="toolbar-btn" onclick="exportPartsCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.allPartsPL">All Parts P/L Analysis</h3></div>
                <div class="chart-wrapper large"><canvas id="partsBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.partsDetails">Parts Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="partsTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="partsTableHeader"></tr></thead><tbody id="partsTableBody"></tbody></table>
                </div>
            </div>
            <!-- Parts Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="partsCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts â€º <span id="partsCustomerDrilldownPart">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closePartsCustomerDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="partsCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr id="partsCustomerDrilldownHeader"></tr></thead>
                        <tbody id="partsCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Parts Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="partsOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Parts â€º <span id="partsOrdersBreadcrumbPart">-</span> â€º <span id="partsOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToPartsCustomers()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllPartsDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="partsOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="partsOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="partsOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY CUSTOMERS PAGE -->
        <div id="sales-customers" class="page">
            <div class="page-header">
                <div><h2 data-i18n="customers.title">P/L by Customer</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="customersBtnRollTech" onclick="toggleCustomersCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="customersBtnMolding" onclick="toggleCustomersCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="customersBtnSnapPad" onclick="toggleCustomersCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="customersFromDate" onchange="applyCustomersDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="customersToDate" onchange="applyCustomersDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetCustomersDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn" id="customersWatchlistBtn" onclick="toggleCustomersWatchlistFilter()">â­ <span data-i18n="btn.watchlist">Watchlist</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="customersClearFiltersBtn" onclick="clearAllTableFilters('customers')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="customersColumnsBtn" onclick="openColumnToggle('customers')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="customersSearch" data-i18n-placeholder="ui.search" placeholder="Search customers..." oninput="filterCustomersTable()">
                <button class="toolbar-btn" onclick="exportCustomersCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.customerPLDist">Customer P/L Distribution (Top 10)</h3></div>
                <div class="chart-wrapper large"><canvas id="customersChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.customerDetails">Customer Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="customersTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="customersTableHeader"></tr></thead><tbody id="customersTableBody"></tbody></table>
                </div>
            </div>
            <!-- Customers Product Drilldown (Level 1) -->
            <div class="drilldown-section" id="customersProductDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers â€º <span id="customersProductDrilldownCustomer">-</span></div>
                        <h3 data-i18n="drilldown.productBreakdown">Product Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeCustomersProductDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="customersProductSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part Number</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Margin</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="customersProductDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Customers Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="customersOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Customers â€º <span id="customersOrdersBreadcrumbCustomer">-</span> â€º <span id="customersOrdersBreadcrumbPart">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToCustomersProducts()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllCustomersDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="customersOrdersSummary"></div>
                <div class="price-history-container">
                    <h4 style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;">PRICE HISTORY</h4>
                    <canvas id="customersOrdersPriceChart"></canvas>
                </div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>PO #</th><th>Status</th><th>Qty</th><th>Unit Price</th><th>Contribution</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th><th>Date</th></tr></thead>
                        <tbody id="customersOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SALES BY DATE PAGE -->
        <div id="sales-dates" class="page">
            <div class="page-header">
                <div><h2 data-i18n="dates.title">P/L by Date</h2></div>
                <button class="toolbar-btn" onclick="navigateTo('sales-overview')">â† <span data-i18n="btn.back">Back</span></button>
            </div>
            <div class="toolbar">
                <div class="toolbar-group category-filters">
                    <label data-i18n="ui.category">Category:</label>
                    <button class="category-btn rolltech active" id="datesBtnRollTech" onclick="toggleDatesCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="datesBtnMolding" onclick="toggleDatesCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="datesBtnSnapPad" onclick="toggleDatesCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.from">From:</label><input type="date" id="datesFromDate" onchange="applyDatesDateFilter()">
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.to">To:</label><input type="date" id="datesToDate" onchange="applyDatesDateFilter()">
                </div>
                <button class="toolbar-btn" onclick="resetDatesDateFilter()">ðŸ”„ <span data-i18n="btn.clearDates">Clear Dates</span></button>
                <button class="toolbar-btn clear-all-filters-btn" id="datesClearFiltersBtn" onclick="clearAllTableFilters('dates')">ðŸ—‘ Clear Filters</button>
                <button class="toolbar-btn columns-btn" id="datesColumnsBtn" onclick="openColumnToggle('dates')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-btn" onclick="exportDatesCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label" data-i18n="stats.orders">Orders</div><div class="value" id="datesStatOrders">-</div><div class="sub" id="datesStatUnits">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.revenue">Revenue</div><div class="value" id="datesStatRevenue">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.pl">P/L</div><div class="value" id="datesStatPL">-</div><div class="sub" id="datesStatMargin">-</div></div>
                <div class="stat-card"><div class="label" data-i18n="stats.margin">Margin</div><div class="value" id="datesStatMarginPct">-</div><div class="sub" id="datesStatMonths">-</div></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="chart.monthlyPLBreakdown">Monthly P/L Breakdown</h3></div>
                <div class="chart-wrapper large"><canvas id="datesBarChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-header"><h3 data-i18n="table.monthlyDetails">Monthly Details</h3><span style="color:var(--text-secondary);font-size:12px;" id="datesTableCount">-</span></div>
                <div class="scrollable-table">
                    <table class="data-table"><thead><tr id="datesTableHeader"></tr></thead><tbody id="datesTableBody"></tbody></table>
                </div>
            </div>
            <!-- Dates Customer Drilldown (Level 1) -->
            <div class="drilldown-section" id="datesCustomerDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months â€º <span id="datesCustomerDrilldownMonth">-</span></div>
                        <h3 data-i18n="drilldown.customerBreakdown">Customer Breakdown</h3>
                    </div>
                    <button class="close-btn" onclick="closeDatesCustomerDrilldown()">âœ• <span data-i18n="ui.close">Close</span></button>
                </div>
                <div class="summary-row" id="datesCustomerSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Customer</th><th>Orders</th><th>Quantity</th><th>Revenue</th><th>P/L</th><th>Margin</th></tr></thead>
                        <tbody id="datesCustomerDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
            <!-- Dates Orders Drilldown (Level 2) -->
            <div class="drilldown-section" id="datesOrdersDrilldown">
                <div class="drilldown-header">
                    <div>
                        <div class="breadcrumb">Months â€º <span id="datesOrdersBreadcrumbMonth">-</span> â€º <span id="datesOrdersBreadcrumbCustomer">-</span></div>
                        <h3 data-i18n="drilldown.ordersHistory">Orders & Price History</h3>
                    </div>
                    <div>
                        <button class="back-btn" onclick="backToDatesCustomers()">â† <span data-i18n="btn.back">Back</span></button>
                        <button class="close-btn" onclick="closeAllDatesDrilldowns()">âœ• <span data-i18n="ui.closeAll">Close All</span></button>
                    </div>
                </div>
                <div class="summary-row" id="datesOrdersSummary"></div>
                <div class="scrollable-table">
                    <table class="data-table">
                        <thead><tr><th>Part</th><th>PO #</th><th>Status</th><th>Ship/Due Date</th><th>Qty</th><th>Unit Price</th><th>Profit/Part</th><th>P/L</th><th>Revenue</th></tr></thead>
                        <tbody id="datesOrdersDrilldownBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOM EXPLORER PAGE -->
        <div id="bom" class="page">
            <div class="page-header">
                <div><h2 data-i18n="bom.title">BOM Explorer</h2></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-bomtab="final" onclick="switchBomTab('final')" data-i18n="bom.finalAssembly">Final Assembly</div>
                <div class="tab" data-bomtab="sub" onclick="switchBomTab('sub')" data-i18n="bom.subAssembly">Sub Assembly</div>
                <div class="tab" data-bomtab="individual" onclick="switchBomTab('individual')" data-i18n="bom.individualItems">Individual Items</div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3 data-i18n="bom.selectPart">Select a Part</h3>
                    <input type="text" class="search-box" id="bomSearch" data-i18n-placeholder="bom.searchParts" placeholder="Search parts..." oninput="filterBomSelector()">
                </div>
                <div class="bom-grid">
                    <div class="bom-selector" id="bomSelector"><p style="color:var(--text-secondary);">Loading...</p></div>
                    <div class="bom-details">
                        <div class="bom-header">
                            <h3 id="bomPartName">Select a part</h3>
                            <div class="category" id="bomCategory"></div>
                        </div>
                        <div id="bomContent"><p style="color:var(--text-secondary);">Click on a part from the list to view details.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALL DATA PAGE -->
        <div id="all-data" class="page">
            <div class="page-header">
                <div><h2 data-i18n="allData.title">All Data (Raw)</h2><p data-i18n="allData.subtitle">Complete spreadsheet data - Columns A through AX</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="allDataLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="allDataRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="allDataColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="allDataClearFiltersBtn" onclick="clearAllTableFilters('allData')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="allDataColumnsBtn" onclick="openColumnToggle('allData')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="allDataGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterAllDataTable()">
                <button class="toolbar-btn" onclick="exportAllDataToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="allDataTable">
                        <thead><tr id="allDataTableHeader"></tr></thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FP REFERENCE DATA PAGE -->
        <div id="fp-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="fpRef.title">FP Reference Data</h2><p data-i18n="fpRef.subtitle">Finished Part specifications and attributes</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="fpRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="fpRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="fpRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="fpRefClearFiltersBtn" onclick="clearAllTableFilters('fpRef')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="fpRefColumnsBtn" onclick="openColumnToggle('fpRef')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="fpRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterFpRefTable()">
                <button class="toolbar-btn" onclick="exportFpRefToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="fpRefTable">
                        <thead><tr id="fpRefTableHeader"></tr></thead>
                        <tbody id="fpRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CUSTOMER REFERENCE DATA PAGE -->
        <div id="customer-reference" class="page">
            <div class="page-header">
                <div><h2 data-i18n="custRef.title">Customer Reference Data</h2><p data-i18n="custRef.subtitle">Customer pricing tiers and payment terms</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="custRefLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="custRefRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="custRefColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="custRefClearFiltersBtn" onclick="clearAllTableFilters('custRef')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="custRefColumnsBtn" onclick="openColumnToggle('custRef')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="custRefGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterCustRefTable()">
                <button class="toolbar-btn" onclick="exportCustRefToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="custRefTable">
                        <thead><tr id="custRefTableHeader"></tr></thead>
                        <tbody id="custRefTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- QUOTES REGISTRY PAGE -->
        <div id="quotes-registry" class="page">
            <div class="page-header">
                <div><h2 data-i18n="quotes.title">Quotes Registry</h2><p data-i18n="quotes.subtitle">Quote records and customer quotations</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <div class="last-updated"><span class="dot"></span><span id="quotesLastUpdated">-</span></div>
                </div>
            </div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="quotesRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.columns">Columns:</label>
                    <span id="quotesColCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="quotesClearFiltersBtn" onclick="clearAllTableFilters('quotes')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="quotesColumnsBtn" onclick="openColumnToggle('quotes')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="quotesGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Global search..." oninput="filterQuotesTable()">
                <button class="toolbar-btn" onclick="exportQuotesToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 280px);">
                    <table class="data-table" id="quotesTable">
                        <thead><tr id="quotesTableHeader"></tr></thead>
                        <tbody id="quotesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PALLET RECORDS PAGE -->
        <!-- DRAWINGS LIBRARY PAGE -->
        <div id="drawings-library" class="page">
            <div class="page-header">
                <div>
                    <h2 data-i18n="drawing.drawingsLibrary">ðŸ“ Drawings Library</h2>
                    <p id="drawingsLibraryCount" style="color: var(--text-secondary); font-size: 13px;"></p>
                </div>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="drawingsSearch" placeholder="Search by part number..." data-i18n-placeholder="drawing.searchPlaceholder" oninput="filterDrawingsLibrary()" style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 13px; width: 250px;">
                    <select id="drawingsTypeFilter" onchange="filterDrawingsLibrary()" style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 13px;">
                        <option value="all" data-i18n="drawing.allTypes">All Types</option>
                        <option value="Tire">Tire</option>
                        <option value="Hub">Hub</option>
                    </select>
                </div>
            </div>
            <div id="drawingsLibraryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-top: 16px;"></div>
        </div>

        <div id="pallet-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="palletRecords.title">Pallet Records</h2><p data-i18n="palletRecords.subtitle">Pallet photos and dimension records</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <button class="toolbar-btn" onclick="exportPalletRecordsToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="palletRecordsBtnRollTech" onclick="togglePalletRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="palletRecordsBtnMolding" onclick="togglePalletRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="palletRecordsBtnSnapPad" onclick="togglePalletRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="palletRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="palletRecordsClearFiltersBtn" onclick="clearAllTableFilters('palletRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="palletRecordsColumnsBtn" onclick="openColumnToggle('palletRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="palletRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Order#, Customer..." oninput="filterPalletRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="palletRecordsTable">
                        <thead><tr id="palletRecordsTableHeader"></tr></thead>
                        <tbody id="palletRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SHIPPING RECORDS PAGE -->
        <div id="shipping-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="shippingRecords.title">Shipping Records</h2><p data-i18n="shippingRecords.subtitle">Shipment photos and carrier information</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <button class="toolbar-btn" onclick="exportShippingRecordsToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="shippingRecordsBtnRollTech" onclick="toggleShippingRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="shippingRecordsBtnMolding" onclick="toggleShippingRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="shippingRecordsBtnSnapPad" onclick="toggleShippingRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="shippingRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="shippingRecordsClearFiltersBtn" onclick="clearAllTableFilters('shippingRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="shippingRecordsColumnsBtn" onclick="openColumnToggle('shippingRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="shippingRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Order#, Customer, Carrier..." oninput="filterShippingRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="shippingRecordsTable">
                        <thead><tr id="shippingRecordsTableHeader"></tr></thead>
                        <tbody id="shippingRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- STAGED RECORDS PAGE -->
        <div id="staged-records" class="page">
            <div class="page-header">
                <div><h2 data-i18n="stagedRecords.title">Staged Records</h2><p data-i18n="stagedRecords.subtitle">Staging confirmation and pallet information</p></div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="toolbar-btn" onclick="navigateTo('main')">â† <span data-i18n="btn.backToDashboard">Back</span></button>
                    <button class="toolbar-btn" onclick="exportStagedRecordsToCSV()">ðŸ“¥ <span data-i18n="ui.export">Export</span></button>
                </div>
            </div>
            <div class="toolbar">
                <div class="category-filters">
                    <button class="category-btn rolltech active" id="stagedRecordsBtnRollTech" onclick="toggleStagedRecordsCategory('rolltech')"><span class="indicator"></span> <span data-i18n="category.rollTech">Roll Tech</span></button>
                    <button class="category-btn molding active" id="stagedRecordsBtnMolding" onclick="toggleStagedRecordsCategory('molding')"><span class="indicator"></span> <span data-i18n="category.molding">Molding</span></button>
                    <button class="category-btn snappad active" id="stagedRecordsBtnSnapPad" onclick="toggleStagedRecordsCategory('snappad')"><span class="indicator"></span> <span data-i18n="category.snappad">Snap Pad</span></button>
                </div>
                <div class="toolbar-group">
                    <label data-i18n="ui.rows">Rows:</label>
                    <span id="stagedRecordsRowCount" style="color:var(--accent);font-weight:600;">-</span>
                </div>
                <button class="toolbar-btn clear-all-filters-btn" id="stagedRecordsClearFiltersBtn" onclick="clearAllTableFilters('stagedRecords')">ðŸ—‘ <span data-i18n="filter.clearFilters">Clear Filters</span></button>
                <button class="toolbar-btn columns-btn" id="stagedRecordsColumnsBtn" onclick="openColumnToggle('stagedRecords')">âš™ï¸ <span data-i18n="ui.columns">Columns</span></button>
                <div class="toolbar-spacer"></div>
                <input type="text" class="search-box" id="stagedRecordsGlobalSearch" data-i18n-placeholder="ui.globalSearch" placeholder="Search IF#, Line#, Customer..." oninput="filterStagedRecordsTable()">
            </div>
            <div class="chart-container" style="padding:10px;">
                <div class="scrollable-table" style="max-height:calc(100vh - 200px);">
                    <table class="data-table" id="stagedRecordsTable">
                        <thead><tr id="stagedRecordsTableHeader"></tr></thead>
                        <tbody id="stagedRecordsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Panel -->
    <button class="ai-chat-fab" id="aiChatFab" onclick="toggleAiChat()" title="AI Assistant">ðŸ¤–</button>
    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-header">
            <div class="ai-chat-header-left">
                <span class="ai-icon">ðŸ¤–</span>
                <div>
                    <div class="ai-title" data-i18n="ai.title">AI Assistant</div>
                    <div class="ai-subtitle" data-i18n="ai.subtitle">Ask about orders, inventory & production</div>
                </div>
            </div>
            <div class="ai-chat-header-actions">
                <button onclick="clearAiChat()" title="Clear chat">ðŸ—‘ï¸</button>
                <button onclick="toggleAiChat()" title="Close">âœ•</button>
            </div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-msg system" id="aiWelcomeMsg"></div>
        </div>
        <div class="ai-suggestions" id="aiSuggestions"></div>
        <div class="ai-chat-input-area">
            <input type="text" id="aiChatInput" data-i18n-placeholder="ai.placeholder" placeholder="Ask about your data..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage();}">
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAiMessage()" title="Send">âž¤</button>
        </div>
    </div>

    <script>
        // ============================================================
        // INTERNATIONALIZATION
        // ============================================================
        const translations = {
            en: {
                'logoSubtitle': 'Operations Dashboard',
                'nav.main': 'Main Dashboard',
                'nav.production': 'PRODUCTION',
                'nav.ordersData': 'Orders Data',
                'nav.productionMake': 'Need to Make',
                'nav.ordersQueue': 'Need to Package',
                'nav.ordersStaged': 'Ready to Ship',
                'nav.ordersShipped': 'Shipped',
                'nav.inventory': 'Inventory',
                'nav.salesFinance': 'SALES & FINANCE',
                'nav.plOverview': 'P/L Overview',
                'nav.byPart': 'By Part Number',
                'nav.byCustomer': 'By Customer',
                'nav.byDate': 'By Date',
                'nav.billOfMaterials': 'BILL OF MATERIALS',
                'nav.bomExplorer': 'BOM Explorer',
                'nav.rawData': 'RAW DATA',
                'nav.allData': 'All Data',
                'nav.fpReference': 'FP Reference',
                'nav.customerReference': 'Customer Reference',
                'nav.quotesRegistry': 'Quotes Registry',
                'nav.palletRecords': 'Pallet Records',
                'nav.shippingRecords': 'Shipping Records',
                'nav.stagedRecords': 'Staged Records',
                'nav.inventoryHistory': 'Inventory History',
                'nav.drawingsLibrary': 'Drawings',
                'palletRecords.title': 'Pallet Records',
                'palletRecords.subtitle': 'Pallet photos and dimension records',
                'shippingRecords.title': 'Shipping Records',
                'shippingRecords.subtitle': 'Shipment photos and carrier information',
                'stagedRecords.title': 'Staged Records',
                'stagedRecords.subtitle': 'Staging confirmation and pallet information',
                'fpRef.title': 'FP Reference Data',
                'fpRef.subtitle': 'Finished Part specifications and attributes',
                'custRef.title': 'Customer Reference Data',
                'custRef.subtitle': 'Customer pricing tiers and payment terms',
                'quotes.title': 'Quotes Registry',
                'quotes.subtitle': 'Quote records and customer quotations',
                'allData.title': 'All Data (Raw)',
                'allData.subtitle': 'Complete spreadsheet data - Columns A through AX',
                'loading': 'Loading data from Google Sheets...',
                'main.title': 'Operations Dashboard',
                'main.subtitle': 'Real-time overview of manufacturing operations',
                'stats.needToMake': 'Need to Make',
                'stats.making': 'Making',
                'stats.readyToShip': 'Ready to Ship',
                'stats.urgent': 'Urgent',
                'stats.totalUnits': 'Total Units',
                'stats.monthRevenue': 'Month Revenue',
                'stats.monthPL': 'Month P/L',
                'stats.missingParts': 'Missing Parts',
                'status.needToMake': 'Need to Make',
                'status.making': 'Making',
                'status.readyToShip': 'Ready to Ship',
                'status.shipped': 'Shipped',
                'status.urgent': 'URGENT',
                'dept.production': 'Production Planning',
                'dept.productionDesc': 'View orders to make, component status, and production queue',
                'dept.needToMake': 'Need to Make',
                'dept.units': 'Units',
                'dept.sales': 'Sales & P/L Analytics',
                'dept.salesDesc': 'Revenue, profitability, and customer analysis',
                'dept.revenue': 'Revenue',
                'dept.profit': 'Profit',
                'dept.orders': 'Orders',
                'dept.inventory': 'Inventory Management',
                'dept.inventoryDesc': 'Stock levels, reorder points, and material tracking',
                'chart.ordersByStatus': 'Orders by Status',
                'chart.upcomingDeadlines': 'Upcoming Deadlines (Next 14 Days)',
                'ordersData.title': 'All Orders Data',
                'ordersData.subtitle': 'Complete order database with all statuses',
                'ordersQueue.title': 'Orders Queue - Need to Make',
                'ordersQueue.subtitle': 'Orders pending production (Pending + Approved status)',
                'ordersStaged.title': 'Staged Orders - Ready to Ship',
                'ordersShipped.title': 'Shipped Orders History',
                'prod.missingMsg': 'orders have missing components.',
                'btn.backToDashboard': 'Back',
                'col.line': 'Line',
                'col.priority': 'Priority',
                'col.daysUntil': 'Days Until',
                'col.requestDate': 'Request Date',
                'col.dueDate': 'Due Date',
                'col.customer': 'Customer',
                'col.category': 'Category',
                'col.ifNum': 'IF #',
                'col.poNum': 'PO #',
                'col.fusionStatus': 'IF Status in Fusion',
                'col.part': 'Part #',
                'col.numPackages': '# Packages',
                'col.partsPerPackage': 'Parts/Package',
                'col.qty': 'Qty',
                'col.fusionInv': 'Fusion Inventory',
                'col.packaging': 'Packaging',
                'col.tire': 'Tire',
                'col.hub': 'Hub',
                'col.hubMold': 'Hub Mold',
                'col.bearings': 'Bearings',
                'col.status': 'Status',
                'col.assigned': 'Assigned To',
                'col.shippedDate': 'Shipped Date',
                'col.revenue': 'Revenue',
                'col.pl': 'P/L',
                'missing': 'Missing',
                'sales.title': 'P/L Overview',
                'inv.title': 'Inventory Management',
                'inv.historyTitle': 'Inventory History',
                'inv.clickHistory': 'Click to view history',
                'inv.last7': 'Last 7 Days',
                'inv.last30': 'Last 30 Days',
                'inv.last90': 'Last 90 Days',
                'inv.allData': 'All Data',
                'inv.current': 'Current',
                'inv.minimum': 'Minimum',
                'inv.maximum': 'Maximum',
                'inv.average': 'Average',
                'inv.noHistory': 'No history data available for this part',
                'inv.historyPageTitle': 'ðŸ“ˆ Inventory History',
                'inv.historyPageSubtitle': 'Compare inventory levels over time for multiple parts',
                'inv.selectParts': 'Select Parts',
                'inv.selected': 'selected',
                'inv.selectPartsPrompt': 'Select one or more parts from the list to view their inventory history',
                'inv.maxPartsWarning': 'Maximum 10 parts can be compared at once',
                'nav.inventoryHistory': 'Inventory History',
                'bom.title': 'BOM Explorer',
                'col.weight': 'Weight',
                'col.dimensions': 'Dimensions',
                'col.palletNum': 'Pallet #',
                'col.partsPerPallet': 'Parts/Pallet',
                'pallet.title': 'Pallet Pictures',
                'pallet.noPictures': 'No pallet pictures found for this order.',
                'pallet.clickToView': 'Click to view full size',
                'pallet.weight': 'Weight (lbs)',
                'pallet.dimensions': 'Dimensions (in)',
                'pallet.pallets': 'Pallets',
                'pallet.totalWeight': 'Total Weight',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Search values...',
                'ui.selectAll': 'Select All',
                'ui.deselectAll': 'Deselect All',
                'ui.clear': 'Clear',
                'ui.apply': 'Apply',
                'ui.hideColumn': 'ðŸ‘ Hide',
                'ui.showHidden': 'Show Hidden',
                'ui.columns': 'Columns',
                'ui.filterColumn': 'Filter Column',
                'ui.search': 'Search...',
                'ui.export': 'Export',
                'ui.category': 'Category:',
                'ui.status': 'Status:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Reset (100%)',
                'ui.close': 'Close',
                'ui.closeAll': 'Close All',
                'ui.units': 'units',
                'ui.orders': 'orders',
                'ui.months': 'months',
                'ui.productTypes': 'product types',
                'ui.qty': 'Qty',
                'ui.loading': 'Loading...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Molding',
                'category.snappad': 'Snap Pad',
                'ui.from': 'From:',
                'ui.to': 'To:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total Orders',
                'stats.stagedOrders': 'Staged Orders',
                'stats.shippedOrders': 'Shipped Orders',
                'stats.totalRevenue': 'Total Revenue',
                'stats.totalPL': 'Total P/L',
                'stats.avgOrderValue': 'Avg Order Value',
                'stats.customers': 'Customers',
                'stats.dueThisWeek': 'Due This Week',
                'stats.componentsReady': 'Components Ready',
                'stats.margin': 'Margin',
                'table.orders': 'Orders',
                'table.ordersToMake': 'Orders to Make',
                'table.readyToShip': 'Ready to Ship',
                'table.shippedOrders': 'Shipped Orders',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'Shipped P/L',
                'stats.forecastedPL': 'Forecasted P/L',
                'stats.shipped': 'shipped',
                'stats.pending': 'pending',
                'stats.orders': 'Orders',
                'stats.revenue': 'Revenue',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Monthly P/L Trend',
                'chart.allPartsPL': 'All Parts P/L Analysis',
                'chart.customerPLDist': 'Customer P/L Distribution (Top 10)',
                'chart.monthlyPLBreakdown': 'Monthly P/L Breakdown',
                'table.partsDetails': 'Parts Details',
                'table.customerDetails': 'Customer Details',
                'table.monthlyDetails': 'Monthly Details',
                'parts.title': 'P/L by Part Number',
                'customers.title': 'P/L by Customer',
                'dates.title': 'P/L by Date',
                'drilldown.customerBreakdown': 'Customer Breakdown',
                'drilldown.productBreakdown': 'Product Breakdown',
                'drilldown.ordersHistory': 'Orders & Price History',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'All',
                'filter.lowStock': 'Low Stock',
                'filter.needsProduction': 'Needs Production',
                'filter.clearFilters': 'Clear Filters',
                'stats.totalItems': 'Total Items',
                'stats.lowStock': 'Low Stock',
                'stats.needsProduction': 'Needs Production',
                'stats.adequateStock': 'Adequate Stock',
                'table.inventoryStatus': 'Inventory Status',
                'bom.selectPart': 'Select a part to view BOM',
                'bom.searchParts': 'Search parts...',
                'ui.globalSearch': 'Global search...',
                'ui.rows': 'Rows:',
                'ui.columns': 'Columns:',
                'ui.items': 'items',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Final Assembly',
                'bom.subAssembly': 'Sub Assembly',
                'bom.individualItems': 'Individual Items',
                'status.low': 'LOW',
                'status.make': 'MAKE',
                'status.ok': 'OK',
                'status.missing': 'Missing',
                'status.available': 'Available',
                'btn.clearDates': 'Clear Dates',
                'btn.watchlist': 'Watchlist',
                'btn.back': 'Back',
                'btn.backToDashboard': 'Back',
                'prod.missingBanner': 'orders have missing components.',
                'ui.parts': 'parts',
                'ui.customers': 'customers',
                // Photo Drilldown translations
                'photo.palletDetails': 'Pallet Details',
                'photo.fusionPictures': 'Fusion Pictures',
                'photo.shipmentPhotos': 'Shipment Photos',
                'photo.closeUpPictures': 'Close-Up Pictures',
                'photo.noPalletData': 'No pallet data',
                'photo.noFusionPictures': 'No fusion pictures',
                'photo.noShipmentPhotos': 'No shipment photos',
                'photo.noCloseUpPictures': 'No close-up pictures',
                'photo.ship': 'Ship',
                'photo.docs': 'Docs',
                'drawing.tireDrawing': 'Tire Drawing',
                'drawing.hubDrawing': 'Hub Drawing',
                'drawing.partDrawing': 'Part Drawing',
                'drawing.noDrawings': 'No drawings available',
                'drawing.drawings': 'Drawings',
                'drawing.drawingsLibrary': 'Drawings Library',
                'drawing.searchPlaceholder': 'Search by part number...',
                'drawing.allTypes': 'All Types',
                'drawing.noResults': 'No drawings found',
                // Theme translations
                'ui.darkTheme': 'Dark',
                'ui.lightTheme': 'Light',
                // AI Assistant
                'nav.aiAssistant': 'AI Assistant',
                'ai.title': 'AI Assistant',
                'ai.subtitle': 'Ask about orders, inventory & production',
                'ai.placeholder': 'Ask about your data...',
                'ai.welcome': 'Hi! I can answer questions about your production orders, inventory, and shipping data. Try asking something!',
                'ai.thinking': 'Thinking...',
                'ai.error': 'Sorry, something went wrong. Please try again.',
                'ai.rateLimit': 'Rate limited â€” please wait a moment and try again.',
                'ai.noData': 'Dashboard data is still loading. Please wait a moment.',
                'ai.cleared': 'Chat cleared.',
                'ai.suggestion1': 'Which orders are late?',
                'ai.suggestion2': 'Low inventory items',
                'ai.suggestion3': 'Orders by customer',
                'ai.suggestion4': 'Status summary'
            },
            es: {
                'logoSubtitle': 'Panel de Operaciones de Moldeo',
                'nav.main': 'Panel Principal',
                'nav.production': 'PRODUCCIÃ“N',
                'nav.ordersData': 'Datos de Ã“rdenes',
                'nav.productionMake': 'Por Fabricar',
                'nav.ordersQueue': 'Por Empacar',
                'nav.ordersStaged': 'Listo para Enviar',
                'nav.ordersShipped': 'Enviados',
                'nav.inventory': 'Inventario',
                'nav.salesFinance': 'VENTAS Y FINANZAS',
                'nav.plOverview': 'Resumen P/L',
                'nav.byPart': 'Por NÃºmero de Parte',
                'nav.byCustomer': 'Por Cliente',
                'nav.byDate': 'Por Fecha',
                'nav.billOfMaterials': 'LISTA DE MATERIALES',
                'nav.bomExplorer': 'Explorador BOM',
                'nav.rawData': 'DATOS CRUDOS',
                'nav.allData': 'Todos los Datos',
                'nav.fpReference': 'Referencia FP',
                'nav.customerReference': 'Referencia de Clientes',
                'nav.quotesRegistry': 'Registro de Cotizaciones',
                'nav.palletRecords': 'Registros de Paletas',
                'nav.shippingRecords': 'Registros de EnvÃ­os',
                'nav.stagedRecords': 'Registros de Staging',
                'nav.inventoryHistory': 'Historial de Inventario',
                'nav.drawingsLibrary': 'Dibujos',
                'palletRecords.title': 'Registros de Paletas',
                'palletRecords.subtitle': 'Fotos y dimensiones de paletas',
                'shippingRecords.title': 'Registros de EnvÃ­os',
                'shippingRecords.subtitle': 'Fotos de envÃ­o e informaciÃ³n de transportista',
                'stagedRecords.title': 'Registros de Staging',
                'stagedRecords.subtitle': 'ConfirmaciÃ³n de staging e informaciÃ³n de paletas',
                'fpRef.title': 'Datos de Referencia FP',
                'fpRef.subtitle': 'Especificaciones y atributos de partes terminadas',
                'custRef.title': 'Datos de Referencia de Clientes',
                'custRef.subtitle': 'Niveles de precios y tÃ©rminos de pago por cliente',
                'quotes.title': 'Registro de Cotizaciones',
                'quotes.subtitle': 'Registros de cotizaciones a clientes',
                'allData.title': 'Todos los Datos (Crudo)',
                'allData.subtitle': 'Datos completos de la hoja - Columnas A hasta AX',
                'loading': 'Cargando datos de Google Sheets...',
                'main.title': 'Panel de Operaciones',
                'main.subtitle': 'Vista en tiempo real de las operaciones de manufactura',
                'stats.needToMake': 'Por Fabricar',
                'stats.making': 'Fabricando',
                'stats.readyToShip': 'Listo para Enviar',
                'stats.urgent': 'Urgente',
                'stats.totalUnits': 'Unidades Totales',
                'stats.monthRevenue': 'Ingresos del Mes',
                'stats.monthPL': 'P/L del Mes',
                'stats.missingParts': 'Partes Faltantes',
                'status.needToMake': 'Por Fabricar',
                'status.making': 'Fabricando',
                'status.readyToShip': 'Listo para Enviar',
                'status.shipped': 'Enviado',
                'status.urgent': 'URGENTE',
                'dept.production': 'PlanificaciÃ³n de ProducciÃ³n',
                'dept.productionDesc': 'Ver Ã³rdenes a fabricar y estado de componentes',
                'dept.needToMake': 'Por Fabricar',
                'dept.units': 'Unidades',
                'dept.sales': 'Ventas y AnÃ¡lisis P/L',
                'dept.salesDesc': 'Ingresos, rentabilidad y anÃ¡lisis de clientes',
                'dept.revenue': 'Ingresos',
                'dept.profit': 'Ganancia',
                'dept.orders': 'Pedidos',
                'dept.inventory': 'GestiÃ³n de Inventario',
                'dept.inventoryDesc': 'Niveles de stock y seguimiento de materiales',
                'chart.ordersByStatus': 'Ã“rdenes por Estado',
                'chart.upcomingDeadlines': 'PrÃ³ximos Vencimientos (14 DÃ­as)',
                'ordersData.title': 'Todos los Datos de Ã“rdenes',
                'ordersData.subtitle': 'Base de datos completa de Ã³rdenes',
                'ordersQueue.title': 'Cola de Ã“rdenes - Por Fabricar',
                'ordersQueue.subtitle': 'Ã“rdenes pendientes de producciÃ³n',
                'ordersStaged.title': 'Ã“rdenes en Staging - Listas para Enviar',
                'ordersShipped.title': 'Historial de Ã“rdenes Enviadas',
                'prod.missingMsg': 'Ã³rdenes tienen componentes faltantes.',
                'btn.backToDashboard': 'Volver',
                'col.line': 'LÃ­nea',
                'col.priority': 'Prioridad',
                'col.daysUntil': 'DÃ­as Restantes',
                'col.requestDate': 'Fecha de Solicitud',
                'col.dueDate': 'Fecha de Entrega',
                'col.customer': 'Cliente',
                'col.category': 'CategorÃ­a',
                'col.ifNum': 'IF #',
                'col.poNum': 'PO #',
                'col.fusionStatus': 'Estado de IF en Fusion',
                'col.part': 'NÃºmero de Parte',
                'col.numPackages': '# Paquetes',
                'col.partsPerPackage': 'Partes/Paquete',
                'col.qty': 'Cantidad',
                'col.fusionInv': 'Inventario en Fusion',
                'col.packaging': 'Empaque',
                'col.tire': 'Llanta',
                'col.hub': 'Hub',
                'col.hubMold': 'Molde del Hub',
                'col.bearings': 'Baleros',
                'col.status': 'Estado',
                'col.assigned': 'Asignado a',
                'col.shippedDate': 'Fecha de EnvÃ­o',
                'col.revenue': 'Ingresos',
                'col.pl': 'P/L',
                'missing': 'Faltante',
                'sales.title': 'Resumen P/L',
                'inv.title': 'GestiÃ³n de Inventario',
                'inv.historyTitle': 'Historial de Inventario',
                'inv.clickHistory': 'Clic para ver historial',
                'inv.last7': 'Ãšltimos 7 DÃ­as',
                'inv.last30': 'Ãšltimos 30 DÃ­as',
                'inv.last90': 'Ãšltimos 90 DÃ­as',
                'inv.allData': 'Todos los Datos',
                'inv.current': 'Actual',
                'inv.minimum': 'MÃ­nimo',
                'inv.maximum': 'MÃ¡ximo',
                'inv.average': 'Promedio',
                'inv.noHistory': 'No hay datos histÃ³ricos disponibles para esta pieza',
                'inv.historyPageTitle': 'ðŸ“ˆ Historial de Inventario',
                'inv.historyPageSubtitle': 'Compare niveles de inventario a lo largo del tiempo para mÃºltiples piezas',
                'inv.selectParts': 'Seleccionar Piezas',
                'inv.selected': 'seleccionadas',
                'inv.selectPartsPrompt': 'Seleccione una o mÃ¡s piezas de la lista para ver su historial de inventario',
                'inv.maxPartsWarning': 'MÃ¡ximo 10 piezas se pueden comparar a la vez',
                'nav.inventoryHistory': 'Historial de Inventario',
                'bom.title': 'Explorador BOM',
                'col.weight': 'Peso',
                'col.dimensions': 'Dimensiones',
                'col.palletNum': 'Paleta #',
                'col.partsPerPallet': 'Partes/Paleta',
                'pallet.title': 'Fotos de Paletas',
                'pallet.noPictures': 'No hay fotos de paletas para esta orden.',
                'pallet.clickToView': 'Clic para ver tamaÃ±o completo',
                'pallet.weight': 'Peso (lbs)',
                'pallet.dimensions': 'Dimensiones (pulg)',
                'pallet.pallets': 'Paletas',
                'pallet.totalWeight': 'Peso Total',
                // Batch 1: Global UI Elements
                'ui.searchValues': 'Buscar valores...',
                'ui.selectAll': 'Seleccionar Todo',
                'ui.deselectAll': 'Deseleccionar Todo',
                'ui.clear': 'Limpiar',
                'ui.apply': 'Aplicar',
                'ui.hideColumn': 'ðŸ‘ Ocultar',
                'ui.showHidden': 'Mostrar Ocultas',
                'ui.columns': 'Columnas',
                'ui.filterColumn': 'Filtrar Columna',
                'ui.search': 'Buscar...',
                'ui.export': 'Exportar',
                'ui.category': 'CategorÃ­a:',
                'ui.status': 'Estado:',
                'ui.zoom': 'Zoom',
                'ui.reset': 'Restablecer (100%)',
                'ui.close': 'Cerrar',
                'ui.closeAll': 'Cerrar Todo',
                'ui.units': 'unidades',
                'ui.orders': 'Ã³rdenes',
                'ui.months': 'meses',
                'ui.productTypes': 'tipos de producto',
                'ui.qty': 'Cant',
                'ui.loading': 'Cargando...',
                'category.rollTech': 'Roll Tech',
                'category.molding': 'Moldeo',
                'category.snappad': 'Snap Pad',
                'ui.from': 'Desde:',
                'ui.to': 'Hasta:',
                // Batch 2: Production Pages
                'stats.totalOrders': 'Total de Ã“rdenes',
                'stats.stagedOrders': 'Ã“rdenes en Staging',
                'stats.shippedOrders': 'Ã“rdenes Enviadas',
                'stats.totalRevenue': 'Ingresos Totales',
                'stats.totalPL': 'P/L Total',
                'stats.avgOrderValue': 'Valor Promedio',
                'stats.customers': 'Clientes',
                'stats.dueThisWeek': 'Vence Esta Semana',
                'stats.componentsReady': 'Componentes Listos',
                'stats.margin': 'Margen',
                'table.orders': 'Ã“rdenes',
                'table.ordersToMake': 'Ã“rdenes a Fabricar',
                'table.readyToShip': 'Listo para Enviar',
                'table.shippedOrders': 'Ã“rdenes Enviadas',
                // Batch 3: Sales/Finance Pages
                'stats.shippedPL': 'P/L Enviados',
                'stats.forecastedPL': 'P/L Proyectado',
                'stats.shipped': 'enviados',
                'stats.pending': 'pendientes',
                'stats.orders': 'Ã“rdenes',
                'stats.revenue': 'Ingresos',
                'stats.pl': 'P/L',
                'chart.monthlyPLTrend': 'Tendencia Mensual P/L',
                'chart.allPartsPL': 'AnÃ¡lisis P/L de Partes',
                'chart.customerPLDist': 'DistribuciÃ³n P/L por Cliente (Top 10)',
                'chart.monthlyPLBreakdown': 'Desglose Mensual P/L',
                'table.partsDetails': 'Detalles de Partes',
                'table.customerDetails': 'Detalles de Clientes',
                'table.monthlyDetails': 'Detalles Mensuales',
                'parts.title': 'P/L por NÃºmero de Parte',
                'customers.title': 'P/L por Cliente',
                'dates.title': 'P/L por Fecha',
                'drilldown.customerBreakdown': 'Desglose por Cliente',
                'drilldown.productBreakdown': 'Desglose por Producto',
                'drilldown.ordersHistory': 'Historial de Ã“rdenes y Precios',
                // Batch 4: Inventory + BOM + All Data
                'filter.all': 'Todos',
                'filter.lowStock': 'Inventario Bajo',
                'filter.needsProduction': 'Requiere ProducciÃ³n',
                'filter.clearFilters': 'Limpiar Filtros',
                'stats.totalItems': 'Total de ArtÃ­culos',
                'stats.lowStock': 'Inventario Bajo',
                'stats.needsProduction': 'Requiere ProducciÃ³n',
                'stats.adequateStock': 'Stock Adecuado',
                'table.inventoryStatus': 'Estado del Inventario',
                'bom.selectPart': 'Seleccione una parte para ver BOM',
                'bom.searchParts': 'Buscar partes...',
                'ui.globalSearch': 'BÃºsqueda global...',
                'ui.rows': 'Filas:',
                'ui.columns': 'Columnas:',
                'ui.items': 'artÃ­culos',
                // Batch 5: Status badges, BOM tabs, misc
                'bom.finalAssembly': 'Ensamble Final',
                'bom.subAssembly': 'Sub Ensamble',
                'bom.individualItems': 'ArtÃ­culos Individuales',
                'status.low': 'BAJO',
                'status.make': 'HACER',
                'status.ok': 'OK',
                'status.missing': 'Faltante',
                'status.available': 'Disponible',
                'btn.clearDates': 'Limpiar Fechas',
                'btn.watchlist': 'Lista de Seguimiento',
                'btn.back': 'Volver',
                'btn.backToDashboard': 'Volver',
                'prod.missingBanner': 'Ã³rdenes tienen componentes faltantes.',
                'ui.parts': 'partes',
                'ui.customers': 'clientes',
                // Photo Drilldown translations
                'photo.palletDetails': 'Detalles de Paleta',
                'photo.fusionPictures': 'Fotos de Fusion',
                'photo.shipmentPhotos': 'Fotos de EnvÃ­o',
                'photo.closeUpPictures': 'Fotos de Cerca',
                'photo.noPalletData': 'Sin datos de paleta',
                'photo.noFusionPictures': 'Sin fotos de fusion',
                'photo.noShipmentPhotos': 'Sin fotos de envÃ­o',
                'photo.noCloseUpPictures': 'Sin fotos de cerca',
                'photo.ship': 'EnvÃ­o',
                'photo.docs': 'Docs',
                'drawing.tireDrawing': 'Dibujo de Llanta',
                'drawing.hubDrawing': 'Dibujo de Hub',
                'drawing.partDrawing': 'Dibujo de Pieza',
                'drawing.noDrawings': 'No hay dibujos disponibles',
                'drawing.drawings': 'Dibujos',
                'drawing.drawingsLibrary': 'Biblioteca de Dibujos',
                'drawing.searchPlaceholder': 'Buscar por nÃºmero de parte...',
                'drawing.allTypes': 'Todos los Tipos',
                'drawing.noResults': 'No se encontraron dibujos',
                // Theme translations
                'ui.darkTheme': 'Oscuro',
                'ui.lightTheme': 'Claro',
                // AI Assistant
                'nav.aiAssistant': 'Asistente IA',
                'ai.title': 'Asistente IA',
                'ai.subtitle': 'Pregunta sobre Ã³rdenes, inventario y producciÃ³n',
                'ai.placeholder': 'Pregunta sobre tus datos...',
                'ai.welcome': 'Â¡Hola! Puedo responder preguntas sobre tus Ã³rdenes de producciÃ³n, inventario y datos de envÃ­o. Â¡Intenta preguntar algo!',
                'ai.thinking': 'Pensando...',
                'ai.error': 'Lo siento, algo saliÃ³ mal. Por favor intenta de nuevo.',
                'ai.rateLimit': 'LÃ­mite de solicitudes â€” espera un momento e intenta de nuevo.',
                'ai.noData': 'Los datos del dashboard se estÃ¡n cargando. Por favor espera un momento.',
                'ai.cleared': 'Chat limpiado.',
                'ai.suggestion1': 'Â¿QuÃ© Ã³rdenes estÃ¡n atrasadas?',
                'ai.suggestion2': 'ArtÃ­culos con bajo inventario',
                'ai.suggestion3': 'Ã“rdenes por cliente',
                'ai.suggestion4': 'Resumen de estados'
            }
        };
        
        let currentLang = 'en';
        let currentTheme = 'dark';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langES').classList.toggle('active', lang === 'es');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            // Handle placeholder translations
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            document.getElementById('logoSubtitle').textContent = translations[lang]['logoSubtitle'];
            // Re-render current page
            if (currentPage.startsWith('orders-')) {
                if (currentPage === 'orders-data') updateOrdersDataPage();
                else if (currentPage === 'orders-queue') updateOrdersQueuePage();
                else if (currentPage === 'orders-staged') updateOrdersStagedPage();
                else if (currentPage === 'orders-shipped') updateOrdersShippedPage();
            } else if (currentPage === 'inventory') updateInventoryPage();
            else if (currentPage === 'inventory-history') updateInventoryHistoryPage();
            else if (currentPage === 'drawings-library') updateDrawingsLibrary();
            else if (currentPage === 'main') updateMainDashboard();
            else if (currentPage === 'sales-overview') updateSalesOverview();
            else if (currentPage === 'sales-parts') updateSalesPartsPage();
            else if (currentPage === 'sales-customers') updateSalesCustomersPage();
            else if (currentPage === 'sales-dates') updateSalesDatesPage();
            else if (currentPage === 'fp-reference') renderFpRefTable();
            else if (currentPage === 'customer-reference') renderCustRefTable();
            else if (currentPage === 'quotes-registry') renderQuotesTable();
            else if (currentPage === 'pallet-records') renderPalletRecordsTable();
            else if (currentPage === 'shipping-records') renderShippingRecordsTable();
            else if (currentPage === 'staged-records') renderStagedRecordsTable();
            // Update AI chat language
            if (typeof updateAiLanguage === 'function') updateAiLanguage();
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.classList.toggle('light-theme', theme === 'light');
            document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
            document.getElementById('themeLight').classList.toggle('active', theme === 'light');
            // Save preference
            try { localStorage.setItem('dashboardTheme', theme); } catch(e) {}
            // Update Chart.js colors for theme
            updateChartsForTheme();
        }
        
        function loadSavedTheme() {
            try {
                const saved = localStorage.getItem('dashboardTheme');
                if (saved === 'light' || saved === 'dark') {
                    setTheme(saved);
                } else {
                    setTheme('dark');
                }
            } catch(e) {
                // Fallback: just set class and buttons directly without calling setTheme
                currentTheme = 'dark';
                try {
                    document.getElementById('themeDark').classList.add('active');
                    document.getElementById('themeLight').classList.remove('active');
                } catch(e2) { /* ignore */ }
            }
        }
        
        function updateChartsForTheme() {
            const textColor = currentTheme === 'light' ? '#1a202c' : '#e2e8f0';
            const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
            
            try {
                if (window.Chart) {
                    Chart.defaults.color = textColor;
                    Chart.defaults.borderColor = gridColor;
                }
            } catch(e) { /* Chart.js not ready yet */ }
            
            // Re-render charts only if they are fully initialized
            try {
                if (window.mainStatusChart && mainStatusChart.options && mainStatusChart.options.plugins) {
                    if (mainStatusChart.options.plugins.legend && mainStatusChart.options.plugins.legend.labels) {
                        mainStatusChart.options.plugins.legend.labels.color = textColor;
                    }
                    mainStatusChart.update();
                }
            } catch(e) { /* chart not ready */ }
            
            try {
                if (window.mainDeadlineChart && mainDeadlineChart.options && mainDeadlineChart.options.scales) {
                    const scales = mainDeadlineChart.options.scales;
                    if (scales.x && scales.x.ticks) scales.x.ticks.color = textColor;
                    if (scales.y && scales.y.ticks) scales.y.ticks.color = textColor;
                    if (scales.x && scales.x.grid) scales.x.grid.color = gridColor;
                    if (scales.y && scales.y.grid) scales.y.grid.color = gridColor;
                    mainDeadlineChart.update();
                }
            } catch(e) { /* chart not ready */ }
        }
        
        function t(key) { return translations[currentLang][key] || key; }

        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SHEET_ID = '1bK0Ne-vX3i5wGoqyAklnyFDUNdE-WaN4Xs5XjggBSXw';
        const MAIN_DATA_GID = '290032634';
        const FUSION_EXPORT_GID = '1805754553';
        const PROD_DATA_TOTALS_GID = '430274636'; // Production Data Totals Dashboard (static export, unaffected by filters)
        const CONFIG_GID = '912029812';
        const PALLET_PICTURES_GID = '1879462508';
        const BOM_FINAL_GID = '74377031';
        const BOM_SUB_GID = '206288913';
        const BOM_INDIVIDUAL_GID = '751106736';
        const INVENTORY_HISTORY_GID = '171540940';  // Fusion records export (daily snapshots)
        const FP_REFERENCE_GID = '944406361';  // FP Reference data
        const CUSTOMER_REFERENCE_GID = '336333220';  // Customer Reference data Dashboard
        const QUOTES_REGISTRY_GID = '1279128282';  // Quotes Registry
        const STAGED_RECORDS_GID = '1519623398';  // Staged records dashboard
        const SHIPPING_RECORDS_GID = '1752263458';  // Shipping records dashboard
        
        const COL = {
            CATEGORY: 'Category',
            REQUEST_DATE: 'Date of Request',
            PRIORITY: 'Priority Level',
            URGENT: 'Urgent Override',
            LINE: 'Line',
            CUSTOMER: 'Customer',
            IF_NUM: 'IF #',
            PO_NUM: 'PO #',
            ENOUGH_INV: 'Enough inventory for current order',
            NUM_PACKAGES: 'Number of packages',
            PARTS_PER_PACKAGE: 'Parts per package',
            FUSION_INV: 'Fusion inventory',
            HAVE_TIRE: 'Have Tire?',
            HAVE_HUB: 'Have Hub?',
            PART: 'Part #',
            QTY: 'Order Qty',
            PACKAGING: 'Packaging (tipo de empaquetado)',
            TIRE: 'Tire',
            HUB: 'Hub',
            HUB_MOLD: 'Hub Mold',
            BEARINGS: 'Bearings',
            ASSIGNED: 'Assigned to',
            STATUS: 'Work order Internal Status',
            FUSION_STATUS: 'IF Status in Fusion',
            DAYS_UNTIL: 'Days until promise date',
            SHIPPED_DATE: 'Shipped Date',
            REQUESTED_DATE: 'Requested Completion Date',
            REVENUE: 'Revenue',
            PL: 'P/L',
            PL_TOTAL: 'P/L total',
            VARIABLE_COST: 'Variable Cost',
            TOTAL_COST: 'Total Cost'
        };
        
        const COL_ALTS = {
            CATEGORY: ['Category', 'Categoria'],
            REQUEST_DATE: ['Date of Request', 'Fecha de Entrega', 'Requested Completion Date'],
            PRIORITY: ['Priority Level', 'Prioridad', 'Priority'],
            LINE: ['Line', 'Linea'],
            CUSTOMER: ['Customer', 'Cliente'],
            PART: ['Part #', 'Numero de parte', 'RT Part #', 'Part Number'],
            QTY: ['Order Qty', 'Cantidad de la orden', 'Qty', 'Quantity'],
            PACKAGING: ['Packaging (tipo de empaquetado)', 'tipo de empaquetado', 'Packaging'],
            TIRE: ['Tire', 'Tire (Llanta)', 'Llanta'],
            HUB: ['Hub', 'Centro', 'Cubo'],
            HUB_MOLD: ['Hub Mold', 'Hub Mold (Molde del Hub)', 'Molde del Hub'],
            BEARINGS: ['Bearings', 'Bearings (Balero)', 'Balero', 'Baleros'],
            ASSIGNED: ['Assigned to', 'Assigned to:', 'Assigned to: (Asignado a:)', 'Asignado a'],
            STATUS: ['Work order Internal Status', 'Work order Status', 'Status', 'Estado'],
            FUSION_STATUS: ['IF Status in Fusion', 'IF Status', 'Fusion Status'],
            DAYS_UNTIL: ['Days until promise date', 'Days until promise date.', 'Dias faltantes', 'Days until', 'Days remaining'],
            IF_NUM: ['IF #', 'IF#', 'IF Number'],
            PO_NUM: ['PO #', 'PO#', 'PO Number', 'Purchase Order'],
            ENOUGH_INV: ['Enough inventory for current order', 'Enough Inventory', 'Enough inventory'],
            NUM_PACKAGES: ['Number of packages', 'Numero de paquetes', 'NÃºmero de paquetes'],
            PARTS_PER_PACKAGE: ['Parts per package', 'Partes por paquete'],
            FUSION_INV: ['Fusion inventory', 'Fusion Inventory', 'Inventario en Fusion'],
            HAVE_TIRE: ['Have Tire?', 'Have Tire', 'Tiene Llanta?'],
            HAVE_HUB: ['Have Hub?', 'Have Hub', 'Tiene Hub?'],
            PL: ['P/L', 'P/L total', 'PL', 'Profit/Loss'],
            REVENUE: ['Revenue', 'Total Sell Price', 'Sales']
        };
        
        function getVal(row, key) {
            const normalize = s => s.toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (row[COL[key]] !== undefined && row[COL[key]] !== null) return row[COL[key]];
            const alts = COL_ALTS[key];
            if (alts) {
                for (const alt of alts) {
                    if (row[alt] !== undefined && row[alt] !== null) return row[alt];
                }
            }
            const targetNames = alts ? [COL[key], ...alts] : [COL[key]];
            for (const target of targetNames) {
                if (!target) continue;
                const targetNorm = normalize(target);
                for (const k of Object.keys(row)) {
                    if (normalize(k) === targetNorm) return row[k];
                }
            }
            return null;
        }
        
        // State
        let allData = [];
        let allRawData = []; // Stores ALL columns A-AX for All Data page
        let allRawHeaders = []; // Column headers from spreadsheet
        let inventoryData = [];
        let palletData = []; // Stores pallet pictures data
        let bomFinalData = [], bomSubData = [], bomIndividualData = [];
        let currentBomTab = 'final';
        
        // Reference Data state (FP Reference, Customer Reference, Quotes Registry)
        let fpReferenceData = [];
        let fpReferenceHeaders = [];
        let customerReferenceData = [];
        let customerReferenceHeaders = [];
        let quotesRegistryData = [];
        let quotesRegistryHeaders = []; // Now loaded from spreadsheet (columns A-J only)
        
        // New Record Sections state (Pallet, Shipping, Staged)
        let palletRecordsData = [];
        let palletRecordsLoaded = false;
        let shippingRecordsData = [];
        let shippingRecordsLoaded = false;
        let stagedRecordsData = [];
        let stagedRecordsLoaded = false;
        
        // Category filters for new record sections
        let palletRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let shippingRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let stagedRecordsFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        
        // Sort state for new record sections
        let palletRecordsSort = { field: null, asc: true };
        let shippingRecordsSort = { field: null, asc: true };
        let stagedRecordsSort = { field: null, asc: true };
        
        // English headers for the new sections (mapped from bilingual spreadsheet headers)
        const PALLET_RECORDS_HEADERS = ['Timestamp', 'Order Number', 'Pallet Number', 'Pallet Picture 1', 'Pallet Weight (lbs)', 'Pallet Dimensions', 'Pallet Picture 2', 'Pallet Picture 3', 'Pallet Picture 4', 'Pallet Picture 5', 'Parts/Boxes per Pallet', 'Customer', 'IF Number', 'Category'];
        const SHIPPING_RECORDS_HEADERS = ['Timestamp', 'Carrier', 'IF Number', 'System', 'Order Number', 'Shipment Pictures', 'Paperwork Pictures', 'Close Up Pictures', 'Customer', 'Category'];
        const STAGED_RECORDS_HEADERS = ['Timestamp', 'Line Number', 'IF Number', 'Order Quantity', 'Number of Pallets', 'Staged By', 'Comments', 'Order Status', 'Staged in Fusion', 'Pallet Dimensions', 'Pallet Weight (lbs)', 'Confirmed Staged', 'Fusion Pictures', 'Customer', 'Category'];
        
        // Spanish headers for the new sections
        const PALLET_RECORDS_HEADERS_ES = ['Marca de tiempo', 'NÃºmero de Orden', 'NÃºmero de Paleta', 'Foto de Paleta 1', 'Peso de Paleta (lbs)', 'Dimensiones de Paleta', 'Foto de Paleta 2', 'Foto de Paleta 3', 'Foto de Paleta 4', 'Foto de Paleta 5', 'Partes/Cajas por Paleta', 'Cliente', 'NÃºmero IF', 'CategorÃ­a'];
        const SHIPPING_RECORDS_HEADERS_ES = ['Marca de tiempo', 'Transportista', 'NÃºmero IF', 'Sistema', 'NÃºmero de Orden', 'Fotos de EnvÃ­o', 'Fotos de Papeleo', 'Fotos de Primer Plano', 'Cliente', 'CategorÃ­a'];
        const STAGED_RECORDS_HEADERS_ES = ['Marca de tiempo', 'NÃºmero de LÃ­nea', 'NÃºmero IF', 'Cantidad de Orden', 'NÃºmero de Paletas', 'Staging por', 'Comentarios', 'Estado de Orden', 'Staging en Fusion', 'Dimensiones de Paleta', 'Peso de Paleta (lbs)', 'Staging Confirmado', 'Fotos de Fusion', 'Cliente', 'CategorÃ­a'];
        
        // Inventory History state (for historical tracking charts)
        let inventoryHistoryData = [];      // Raw data: [{partNumber, dataByDate: {date: qty}}]
        let inventoryHistoryDates = [];     // Array of available dates (sorted)
        let inventoryHistoryLoaded = false; // Lazy loading flag
        let currentHistoryPart = null;      // Currently viewed part in history modal
        let historyDateRange = { start: null, end: null }; // Date range filter
        
        // Multi-part history page state
        let selectedHistoryParts = new Set();  // Selected parts for comparison
        let historyPageDateRange = { start: null, end: null }; // Date range for history page
        const historyPartColors = [
            '#3182ce', '#38a169', '#d69e2e', '#805ad5', '#dd6b20',
            '#319795', '#e53e3e', '#667eea', '#48bb78', '#ed8936'
        ]; // Colors for multi-part chart
        
        let config = {};
        let charts = {};
        let currentPage = 'main';
        let currentPalletOrder = null; // Currently viewed pallet order
        
        // Filter states for each page
        let ordersDataFilters = { categories: { rolltech: true, molding: true, snappad: true }, statuses: { pending: true, wip: true, staged: true, shipped: false } };
        let ordersQueueFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersStagedFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let ordersShippedFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let salesFilters = { categories: { rolltech: true, molding: true, snappad: true } };
        let datesFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null };
        let partsFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        let customersFilters = { categories: { rolltech: true, molding: true, snappad: true }, fromDate: null, toDate: null, watchlistOnly: false };
        
        // Sort states
        let ordersDataSort = { field: 'daysUntil', asc: true };
        let ordersQueueSort = { field: 'default', asc: true };
        let ordersStagedSort = { field: 'customer', asc: true };
        let ordersShippedSort = { field: 'shippedDate', asc: false };
        let invFilter = 'all';
        let invSort = { field: 'partNumber', asc: true };
        let partsSort = { field: 'pl', asc: false };
        let customersSort = { field: 'pl', asc: false };
        let datesSort = { field: 'month', asc: false };
        let partsCustomerDrilldownSort = { field: 'pl', asc: false };
        let customersProductDrilldownSort = { field: 'pl', asc: false };
        let allDataSort = { field: null, asc: true };
        let fpRefSort = { field: null, asc: true };
        let custRefSort = { field: null, asc: true };
        let quotesSort = { field: null, asc: true };
        
        // Column Filter System State
        let columnFilters = {}; // { tableId: { columnKey: Set(selectedValues) } }
        let hiddenColumns = {}; // { tableId: Set(columnKeys) }
        let activeFilterDropdown = null; // { tableId, columnKey, allValues, selectedValues }
        
        // Drilldown state
        let currentDrilldownPart = null;
        let currentDrilldownCustomer = null;
        let currentDrilldownMonth = null;
        
        // Watchlist (localStorage persistence)
        let watchlistParts = [];
        let watchlistCustomers = [];
        try {
            watchlistParts = JSON.parse(localStorage.getItem('rolltech_watchlist_parts') || '[]');
            watchlistCustomers = JSON.parse(localStorage.getItem('rolltech_watchlist_customers') || '[]');
        } catch(e) { console.warn('Could not load watchlist from localStorage'); }

        // ============================================================
        // UTILITIES
        // ============================================================
        const formatCurrency = v => v == null || isNaN(v) ? '$0.00' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(v);
        const formatNumber = v => v == null || isNaN(v) ? '0' : new Intl.NumberFormat('en-US').format(Math.round(v));
        const parseNumber = v => { if (!v || v === '') return 0; if (typeof v === 'number') return v; let c = String(v).replace(/[$,%\s]/g,''); if (c.startsWith('(') && c.endsWith(')')) c = '-' + c.slice(1,-1); return parseFloat(c) || 0; };
        const parseDate = d => { if (!d) return null; if (d.includes('/')) { const p = d.split('/'); if (p.length >= 3) return new Date(p[2].length===2?'20'+p[2]:p[2], p[0]-1, p[1]); } return new Date(d); };
        const isEmpty = v => v === null || v === undefined || v === '';
        const isMissingComponent = v => v === null || v === undefined || v === '' || v === '-';
        const hasMissingCostData = row => isEmpty(row[COL.VARIABLE_COST]) || isEmpty(row[COL.TOTAL_COST]) || (isEmpty(row[COL.PL]) && isEmpty(row[COL.PL_TOTAL]));
        const getPLValue = row => { if (!isEmpty(row[COL.PL])) return parseNumber(row[COL.PL]); if (!isEmpty(row[COL.PL_TOTAL])) return parseNumber(row[COL.PL_TOTAL]); return 0; };
        
        // v5 Helper Functions
        const getAttributionDate = row => {
            const status = getStatus(row);
            if (status === 'shipped') return row[COL.SHIPPED_DATE];
            return row[COL.REQUESTED_DATE] || getVal(row, 'REQUEST_DATE');
        };
        
        const getMonthKey = dateStr => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr.substring(0, 7);
        };
        
        const formatMonthLabel = monthKey => {
            if (!monthKey) return '-';
            const [year, month] = monthKey.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(month) - 1]} ${year}`;
        };
        
        const getUnitPrice = row => {
            const unitPrice = parseNumber(row[COL.UNIT_PRICE]);
            if (unitPrice > 0) return unitPrice;
            const revenue = parseNumber(row[COL.REVENUE]);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? revenue / qty : 0;
        };
        
        const getProfitPerPart = row => {
            const pl = getPLValue(row);
            const qty = parseNumber(getVal(row, 'QTY'));
            return qty > 0 ? pl / qty : 0;
        };
        
        // Watchlist functions
        function isInWatchlist(type, value) {
            if (type === 'part') return watchlistParts.includes(value);
            if (type === 'customer') return watchlistCustomers.includes(value);
            return false;
        }
        
        function toggleWatchlistPart(part) {
            const idx = watchlistParts.indexOf(part);
            if (idx > -1) watchlistParts.splice(idx, 1);
            else watchlistParts.push(part);
            try { localStorage.setItem('rolltech_watchlist_parts', JSON.stringify(watchlistParts)); } catch(e) {}
            updateSalesPartsPage();
        }
        
        function toggleWatchlistCustomer(customer) {
            const idx = watchlistCustomers.indexOf(customer);
            if (idx > -1) watchlistCustomers.splice(idx, 1);
            else watchlistCustomers.push(customer);
            try { localStorage.setItem('rolltech_watchlist_customers', JSON.stringify(watchlistCustomers)); } catch(e) {}
            updateSalesCustomersPage();
        }
        
        const getContributionBadge = margin => {
            if (margin < -10) return '<span class="badge" style="background:var(--danger);">CRITICAL</span>';
            if (margin < 0) return '<span class="badge" style="background:var(--warning);color:#1a202c;">LOW</span>';
            if (margin < 15) return '<span class="badge" style="background:var(--accent);">TARGET</span>';
            return '<span class="badge" style="background:var(--success);">PROFITABLE</span>';
        };
        
        const getCategory = row => {
            const cat = (getVal(row, 'CATEGORY') || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        };
        
        // UPDATED: Uses FUSION_STATUS (Col G) as fallback when STATUS (Col H) is empty
        const getStatus = row => {
            // Check Work order Internal Status first (Column H)
            let status = (getVal(row, 'STATUS') || '').toLowerCase();
            
            // If STATUS is empty or unclear, use IF Status in Fusion (Column G) as fallback
            if (!status || status === '') {
                status = (getVal(row, 'FUSION_STATUS') || '').toLowerCase();
            }
            
            if (status.includes('pending') || status.includes('approved')) return 'pending';
            if (status.includes('staged')) return 'staged';
            if (status.includes('work in progress') || status.includes('wip')) return 'wip';
            if (status.includes('shipped') || status.includes('invoiced') || status.includes('to bill')) return 'shipped';
            return status;
        };
        
        // UPDATED: Uses translated labels
        const getStatusBadge = status => {
            const s = (status || '').toLowerCase();
            if (s.includes('shipped') || s === 'shipped') return `<span class="badge shipped">${t('status.shipped')}</span>`;
            if (s.includes('pending') || s.includes('approved') || s === 'pending') return `<span class="badge pending">${t('status.needToMake')}</span>`;
            if (s.includes('staged') || s === 'staged') return `<span class="badge staged">${t('status.readyToShip')}</span>`;
            if (s.includes('work in progress') || s.includes('wip') || s === 'wip') return `<span class="badge wip">${t('status.making')}</span>`;
            return `<span class="badge">${status || '-'}</span>`;
        };
        
        // UPDATED: Uses translated "URGENT" label
        const getPriorityBadge = (priority, urgent) => {
            const p = parseNumber(priority);
            const uVal = (urgent || '').toString().toLowerCase().trim();
            const isUrgent = uVal === 'urgent' || uVal === 'true' || uVal === '1' || uVal === 'yes' || uVal === 'x';
            if (isUrgent) return `<span class="badge urgent">${t('status.urgent')}</span>`;
            if (p === 1) return '<span class="badge priority-1">P1</span>';
            if (p === 2) return '<span class="badge priority-2">P2</span>';
            if (p === 3) return '<span class="badge priority-3">P3</span>';
            if (p === 4) return '<span class="badge priority-4">P4</span>';
            return `<span class="badge">P${p || '-'}</span>`;
        };
        
        const formatComponent = (value) => {
            if (isMissingComponent(value)) return `<span class="cell-missing">${t('missing')}</span>`;
            if (value === 'NA' || value === 'N/A') return `<span style="color:var(--text-secondary);">NA</span>`;
            return `<span class="cell-available">${value}</span>`;
        };

        // ============================================================
        // COLUMN FILTER SYSTEM
        // ============================================================
        function initTableFilters(tableId) {
            if (!columnFilters[tableId]) columnFilters[tableId] = {};
        }
        
        function createFilterHeader(tableId, columnKey, label, sortable = true) {
            initTableFilters(tableId);
            const isFiltered = columnFilters[tableId][columnKey] && columnFilters[tableId][columnKey].size > 0;
            const filteredClass = isFiltered ? 'filtered' : '';
            const filterIndicator = isFiltered ? ' ðŸ“‹' : '';
            return `<th class="filter-th ${filteredClass}">
                <div class="filter-th-content">
                    <span>${label}${filterIndicator}</span>
                    <div class="filter-th-btns">
                        ${sortable ? `<button onclick="sortTableColumn('${tableId}', '${columnKey}')" title="Sort">â†•</button>` : ''}
                        <button onclick="openColumnFilter('${tableId}', '${columnKey}', this)" title="Filter">Ã¢â€“Â¼</button>
                    </div>
                </div>
            </th>`;
        }
        
        function sortTableColumn(tableId, columnKey) {
            // Delegate to existing sort functions based on tableId
            switch(tableId) {
                case 'parts': sortPartsTable(columnKey); break;
                case 'customers': sortCustomersTable(columnKey); break;
                case 'ordersData': sortOrdersDataTable(columnKey); break;
                case 'ordersQueue': sortOrdersQueueTable(columnKey); break;
                case 'ordersStaged': sortOrdersStagedTable(columnKey); break;
                case 'ordersShipped': sortOrdersShippedTable(columnKey); break;
                case 'inventory': sortInvTable(columnKey); break;
                case 'dates': sortDatesTable(columnKey); break;
                case 'allData': sortAllDataTable(columnKey); break;
                case 'fpRef': sortFpRefTable(columnKey); break;
                case 'custRef': sortCustRefTable(columnKey); break;
                case 'quotes': sortQuotesTable(columnKey); break;
                case 'palletRecords': sortPalletRecordsTable(columnKey); break;
                case 'shippingRecords': sortShippingRecordsTable(columnKey); break;
                case 'stagedRecords': sortStagedRecordsTable(columnKey); break;
            }
        }
        
        function openColumnFilter(tableId, columnKey, buttonEl) {
            initTableFilters(tableId);
            const allValues = getUniqueValuesForColumn(tableId, columnKey);
            const currentFilter = columnFilters[tableId][columnKey];
            const selectedValues = currentFilter ? new Set(currentFilter) : new Set(allValues);
            
            activeFilterDropdown = { tableId, columnKey, allValues: [...allValues], selectedValues };
            
            const dropdown = document.getElementById('columnFilterDropdown');
            document.getElementById('filterDropdownTitle').textContent = `Filter: ${columnKey}`;
            document.getElementById('filterDropdownSearch').value = '';
            renderFilterValues(allValues, selectedValues);
            
            // Position dropdown near button
            const rect = buttonEl.getBoundingClientRect();
            dropdown.style.top = Math.min(rect.bottom + 5, window.innerHeight - 420) + 'px';
            dropdown.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
            dropdown.classList.add('active');
        }
        
        function closeFilterDropdown() {
            document.getElementById('columnFilterDropdown').classList.remove('active');
            activeFilterDropdown = null;
        }
        
        function renderFilterValues(values, selectedSet, searchTerm = '') {
            const list = document.getElementById('filterValuesList');
            const filtered = searchTerm ? values.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase())) : values;
            list.innerHTML = filtered.map(v => {
                const checked = selectedSet.has(v) ? 'checked' : '';
                const displayVal = v === '' ? '(empty)' : v;
                return `<div class="filter-value-item">
                    <input type="checkbox" id="fv_${encodeURIComponent(v)}" ${checked} onchange="toggleFilterValue('${encodeURIComponent(v)}')">
                    <label for="fv_${encodeURIComponent(v)}">${displayVal}</label>
                </div>`;
            }).join('');
        }
        
        function filterDropdownSearch() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value;
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function toggleFilterValue(encodedValue) {
            if (!activeFilterDropdown) return;
            const value = decodeURIComponent(encodedValue);
            if (activeFilterDropdown.selectedValues.has(value)) {
                activeFilterDropdown.selectedValues.delete(value);
            } else {
                activeFilterDropdown.selectedValues.add(value);
            }
        }
        
        function filterSelectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.add(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function filterDeselectAll() {
            if (!activeFilterDropdown) return;
            const searchTerm = document.getElementById('filterDropdownSearch').value.toLowerCase();
            activeFilterDropdown.allValues.forEach(v => {
                if (!searchTerm || String(v).toLowerCase().includes(searchTerm)) {
                    activeFilterDropdown.selectedValues.delete(v);
                }
            });
            renderFilterValues(activeFilterDropdown.allValues, activeFilterDropdown.selectedValues, searchTerm);
        }
        
        function clearColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            delete columnFilters[tableId][columnKey];
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function applyColumnFilter() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey, allValues, selectedValues } = activeFilterDropdown;
            
            // If all selected, remove filter; otherwise save it
            if (selectedValues.size === allValues.length) {
                delete columnFilters[tableId][columnKey];
            } else if (selectedValues.size === 0) {
                // Don't allow empty filter - select all instead
                delete columnFilters[tableId][columnKey];
            } else {
                columnFilters[tableId][columnKey] = new Set(selectedValues);
            }
            
            closeFilterDropdown();
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function clearAllTableFilters(tableId) {
            columnFilters[tableId] = {};
            refreshTableAfterFilter(tableId);
            updateClearAllButton(tableId);
        }
        
        function updateClearAllButton(tableId) {
            const btnId = tableId + 'ClearFiltersBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hasFilters = columnFilters[tableId] && Object.keys(columnFilters[tableId]).length > 0;
                btn.classList.toggle('has-filters', hasFilters);
            }
        }
        
        function refreshTableAfterFilter(tableId) {
            switch(tableId) {
                case 'parts': updateSalesPartsPage(); break;
                case 'customers': updateSalesCustomersPage(); break;
                case 'ordersData': updateOrdersDataPage(); break;
                case 'ordersQueue': updateOrdersQueuePage(); break;
                case 'ordersStaged': updateOrdersStagedPage(); break;
                case 'ordersShipped': updateOrdersShippedPage(); break;
                case 'inventory': renderInvTable(); break;
                case 'dates': updateSalesDatesPage(); break;
                case 'allData': renderAllDataTable(); break;
                case 'fpRef': renderFpRefTable(); break;
                case 'custRef': renderCustRefTable(); break;
                case 'quotes': renderQuotesTable(); break;
                case 'palletRecords': renderPalletRecordsTable(); break;
                case 'shippingRecords': renderShippingRecordsTable(); break;
                case 'stagedRecords': renderStagedRecordsTable(); break;
            }
        }
        
        function passesColumnFilter(tableId, columnKey, value) {
            if (!columnFilters[tableId] || !columnFilters[tableId][columnKey]) return true;
            return columnFilters[tableId][columnKey].has(value);
        }
        
        // ============================================================
        // HIDE COLUMNS SYSTEM
        // ============================================================
        function initHiddenColumns(tableId) {
            if (!hiddenColumns[tableId]) {
                hiddenColumns[tableId] = new Set();
                // Default hidden columns per table
                if (tableId === 'ordersQueue') {
                    hiddenColumns[tableId].add('fusionStatus');
                }
            }
        }
        
        function isColumnHidden(tableId, columnKey) {
            return hiddenColumns[tableId] && hiddenColumns[tableId].has(columnKey);
        }
        
        function hideCurrentColumn() {
            if (!activeFilterDropdown) return;
            const { tableId, columnKey } = activeFilterDropdown;
            hideColumn(tableId, columnKey);
            closeFilterDropdown();
        }
        
        function hideColumn(tableId, columnKey) {
            initHiddenColumns(tableId);
            hiddenColumns[tableId].add(columnKey);
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function showAllColumns(tableId) {
            if (hiddenColumns[tableId]) {
                hiddenColumns[tableId].clear();
            }
            updateShowHiddenButton(tableId);
            refreshTableAfterFilter(tableId);
        }
        
        function updateShowHiddenButton(tableId) {
            const btnId = tableId + 'ShowHiddenBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hiddenCount = hiddenColumns[tableId] ? hiddenColumns[tableId].size : 0;
                const hasHidden = hiddenCount > 0;
                btn.classList.toggle('has-hidden', hasHidden);
                // Update button text with count
                const spanEl = btn.querySelector('span');
                if (spanEl) {
                    spanEl.textContent = hasHidden ? `${t('ui.showHidden')} (${hiddenCount})` : t('ui.showHidden');
                }
            }
        }
        
        function getVisibleHeaders(tableId, allHeaders) {
            if (!hiddenColumns[tableId] || hiddenColumns[tableId].size === 0) return allHeaders;
            return allHeaders.filter((h, i) => !hiddenColumns[tableId].has(h) && !hiddenColumns[tableId].has(`col_${i}`));
        }
        
        // ============================================================
        // COLUMN TOGGLE SYSTEM (âš™ï¸ Columns button)
        // ============================================================
        let activeColumnToggle = null; // { tableId, columns: [{key, labelEn, labelEs}] }
        
        // Column definitions for each table - defines all possible columns
        const tableColumnDefs = {
            ordersData: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'priority', labelEn: 'Priority', labelEs: 'Prioridad' },
                { key: 'daysUntil', labelEn: 'Days Until', labelEs: 'DÃ­as Restantes' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'tire', labelEn: 'Tire', labelEs: 'Llanta' },
                { key: 'hub', labelEn: 'Hub', labelEs: 'Centro' },
                { key: 'bearings', labelEn: 'Bearings', labelEs: 'Baleros' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' }
            ],
            ordersQueue: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'priority', labelEn: 'Priority', labelEs: 'Prioridad' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'tire', labelEn: 'Tire', labelEs: 'Llanta' },
                { key: 'tireStock', labelEn: 'Tire Stock', labelEs: 'Stock Llanta' },
                { key: 'hub', labelEn: 'Hub', labelEs: 'Centro' },
                { key: 'hubStock', labelEn: 'Hub Stock', labelEs: 'Stock Centro' },
                { key: 'bearings', labelEn: 'Bearings', labelEs: 'Baleros' },
                { key: 'assigned', labelEn: 'Assigned', labelEs: 'Asignado' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' },
                { key: 'fusionStatus', labelEn: 'Fusion Status', labelEs: 'Estado Fusion' }
            ],
            ordersStaged: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'daysUntil', labelEn: 'Days Until', labelEs: 'DÃ­as Restantes' }
            ],
            ordersShipped: [
                { key: 'line', labelEn: 'Line', labelEs: 'LÃ­nea' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'poNum', labelEn: 'PO #', labelEs: 'PO #' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'shippedDate', labelEn: 'Shipped', labelEs: 'Enviado' }
            ],
            inventory: [
                { key: 'partNumber', labelEn: 'Part Number', labelEs: 'NÃºmero de Parte' },
                { key: 'product', labelEn: 'Product', labelEs: 'Producto' },
                { key: 'fusionInventory', labelEn: 'Fusion Inventory', labelEs: 'Inventario Fusion' },
                { key: 'minimums', labelEn: 'Minimums', labelEs: 'MÃ­nimos' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' },
                { key: 'makeNeeded', labelEn: 'Make Needed', labelEs: 'ProducciÃ³n Necesaria' }
            ],
            parts: [
                { key: 'part', labelEn: 'Part #', labelEs: 'Parte #' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            customers: [
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            dates: [
                { key: 'month', labelEn: 'Month', labelEs: 'Mes' },
                { key: 'orders', labelEn: 'Orders', labelEs: 'Ã“rdenes' },
                { key: 'units', labelEn: 'Units', labelEs: 'Unidades' },
                { key: 'revenue', labelEn: 'Revenue', labelEs: 'Ingresos' },
                { key: 'pl', labelEn: 'P/L', labelEs: 'G/P' },
                { key: 'margin', labelEn: 'Margin', labelEs: 'Margen' }
            ],
            palletRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'orderNum', labelEn: 'Order #', labelEs: 'Orden #' },
                { key: 'palletNum', labelEn: 'Pallet #', labelEs: 'Paleta #' },
                { key: 'weight', labelEn: 'Weight', labelEs: 'Peso' },
                { key: 'dimensions', labelEn: 'Dimensions', labelEs: 'Dimensiones' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'photos', labelEn: 'Photos', labelEs: 'Fotos' }
            ],
            shippingRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'carrier', labelEn: 'Carrier', labelEs: 'Transportista' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'system', labelEn: 'System', labelEs: 'Sistema' },
                { key: 'photos', labelEn: 'Photos', labelEs: 'Fotos' }
            ],
            stagedRecords: [
                { key: 'timestamp', labelEn: 'Timestamp', labelEs: 'Fecha' },
                { key: 'lineNum', labelEn: 'Line #', labelEs: 'LÃ­nea #' },
                { key: 'ifNum', labelEn: 'IF #', labelEs: 'IF #' },
                { key: 'qty', labelEn: 'Qty', labelEs: 'Cant.' },
                { key: 'pallets', labelEn: 'Pallets', labelEs: 'Paletas' },
                { key: 'stagedBy', labelEn: 'Staged By', labelEs: 'Preparado Por' },
                { key: 'customer', labelEn: 'Customer', labelEs: 'Cliente' },
                { key: 'status', labelEn: 'Status', labelEs: 'Estado' }
            ],
            allData: [
                { key: 'all', labelEn: 'All Columns', labelEs: 'Todas las Columnas' }
            ],
            fpRef: [
                { key: 'all', labelEn: 'All Columns', labelEs: 'Todas las Columnas' }
            ],
            custRef: [
                { key: 'all', labelEn: 'All Columns', labelEs: 'Todas las Columnas' }
            ],
            quotes: [
                { key: 'all', labelEn: 'All Columns', labelEs: 'Todas las Columnas' }
            ]
        };
        
        function openColumnToggle(tableId) {
            if (!tableColumnDefs[tableId]) return;
            initHiddenColumns(tableId);
            
            activeColumnToggle = { tableId, columns: tableColumnDefs[tableId] };
            
            const dropdown = document.getElementById('columnToggleDropdown');
            const overlay = document.getElementById('columnToggleOverlay');
            const list = document.getElementById('columnToggleList');
            
            // Render column list with checkboxes
            list.innerHTML = activeColumnToggle.columns.map(col => {
                const isHidden = hiddenColumns[tableId] && hiddenColumns[tableId].has(col.key);
                const label = currentLang === 'es' ? col.labelEs : col.labelEn;
                const itemClass = isHidden ? 'column-toggle-item hidden-col' : 'column-toggle-item';
                return `<div class="${itemClass}">
                    <input type="checkbox" id="col_${col.key}" ${!isHidden ? 'checked' : ''} 
                           onchange="toggleColumnVisibility('${tableId}', '${col.key}')">
                    <label for="col_${col.key}">${label}</label>
                </div>`;
            }).join('');
            
            dropdown.classList.add('active');
            overlay.classList.add('active');
        }
        
        function closeColumnToggle() {
            const dropdown = document.getElementById('columnToggleDropdown');
            const overlay = document.getElementById('columnToggleOverlay');
            dropdown.classList.remove('active');
            overlay.classList.remove('active');
            activeColumnToggle = null;
        }
        
        function toggleColumnVisibility(tableId, columnKey) {
            initHiddenColumns(tableId);
            if (hiddenColumns[tableId].has(columnKey)) {
                hiddenColumns[tableId].delete(columnKey);
            } else {
                hiddenColumns[tableId].add(columnKey);
            }
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            
            // Update the visual state of the item in the dropdown
            if (activeColumnToggle && activeColumnToggle.tableId === tableId) {
                const item = document.querySelector(`#col_${columnKey}`).closest('.column-toggle-item');
                if (item) {
                    item.classList.toggle('hidden-col', hiddenColumns[tableId].has(columnKey));
                }
            }
        }
        
        function columnSelectAll() {
            if (!activeColumnToggle) return;
            const { tableId } = activeColumnToggle;
            if (hiddenColumns[tableId]) {
                hiddenColumns[tableId].clear();
            }
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            // Re-render list
            openColumnToggle(tableId);
        }
        
        function columnDeselectAll() {
            if (!activeColumnToggle) return;
            const { tableId, columns } = activeColumnToggle;
            initHiddenColumns(tableId);
            columns.forEach(col => hiddenColumns[tableId].add(col.key));
            updateColumnsButton(tableId);
            refreshTableAfterFilter(tableId);
            // Re-render list
            openColumnToggle(tableId);
        }
        
        function updateColumnsButton(tableId) {
            const btnId = tableId + 'ColumnsBtn';
            const btn = document.getElementById(btnId);
            if (btn) {
                const hiddenCount = hiddenColumns[tableId] ? hiddenColumns[tableId].size : 0;
                const hasHidden = hiddenCount > 0;
                btn.classList.toggle('has-hidden', hasHidden);
                const spanEl = btn.querySelector('span');
                if (spanEl) {
                    spanEl.textContent = hasHidden ? `${t('ui.columns')} (${hiddenCount})` : t('ui.columns');
                }
            }
            // Also update old show-hidden button for backwards compatibility
            updateShowHiddenButton(tableId);
        }
        
        function getUniqueValuesForColumn(tableId, columnKey) {
            const values = new Set();
            
            switch(tableId) {
                case 'parts':
                    return getUniquePartsColumnValues(columnKey);
                case 'customers':
                    return getUniqueCustomersColumnValues(columnKey);
                case 'ordersData':
                case 'ordersQueue':
                case 'ordersStaged':
                case 'ordersShipped':
                    return getUniqueOrdersColumnValues(tableId, columnKey);
                case 'inventory':
                    return getUniqueInventoryColumnValues(columnKey);
                case 'dates':
                    return getUniqueDatesColumnValues(columnKey);
                case 'allData':
                    return getUniqueAllDataColumnValues(columnKey);
                case 'fpRef':
                    return getUniqueFpRefColumnValues(columnKey);
                case 'custRef':
                    return getUniqueCustRefColumnValues(columnKey);
                case 'quotes':
                    return getUniqueQuotesColumnValues(columnKey);
                case 'palletRecords':
                    return getUniquePalletRecordsColumnValues(columnKey);
                case 'shippingRecords':
                    return getUniqueShippingRecordsColumnValues(columnKey);
                case 'stagedRecords':
                    return getUniqueStagedRecordsColumnValues(columnKey);
            }
            return Array.from(values).sort();
        }
        
        function getUniquePartsColumnValues(columnKey) {
            const data = getFilteredPartsData();
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(partStats).forEach(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'part': values.add(part); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueCustomersColumnValues(columnKey) {
            const data = getFilteredCustomersData();
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(custStats).forEach(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'customer': values.add(customer); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueOrdersColumnValues(tableId, columnKey) {
            let data = allData;
            // Filter based on table type
            if (tableId === 'ordersQueue') data = data.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            else if (tableId === 'ordersStaged') data = data.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            else if (tableId === 'ordersShipped') data = data.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            else if (tableId === 'ordersData') data = data.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            
            const values = new Set();
            data.forEach(r => {
                switch(columnKey) {
                    case 'line': values.add(getVal(r, 'LINE') || '-'); break;
                    case 'priority': values.add(getVal(r, 'PRIORITY') || '-'); break;
                    case 'customer': values.add(getVal(r, 'CUSTOMER') || '-'); break;
                    case 'part': values.add(getVal(r, 'PART') || '-'); break;
                    case 'status': values.add(getStatus(r)); break;
                    case 'tire': values.add(isMissingComponent(getVal(r, 'TIRE')) ? 'Missing' : 'Available'); break;
                    case 'hub': values.add(isMissingComponent(getVal(r, 'HUB')) ? 'Missing' : 'Available'); break;
                    case 'bearings': values.add(isMissingComponent(getVal(r, 'BEARINGS')) ? 'Missing' : 'Available'); break;
                    case 'assigned': values.add(getVal(r, 'ASSIGNED') || '-'); break;
                    case 'packaging': values.add(getVal(r, 'PACKAGING') || '-'); break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueInventoryColumnValues(columnKey) {
            const values = new Set();
            inventoryData.forEach(i => {
                switch(columnKey) {
                    case 'product': values.add(i.product || '-'); break;
                    case 'partNumber': values.add(i.partNumber); break;
                    case 'fusionQty': values.add(String(i.fusionQty)); break;
                    case 'minimum': values.add(String(i.minimum)); break;
                    case 'manualTarget': values.add(String(i.manualTarget)); break;
                    case 'qtyNeeded': values.add(String(i.qtyNeeded)); break;
                    case 'partsToBeMade': values.add(String(i.partsToBeMade)); break;
                    case 'moldType': values.add(i.moldType || '-'); break;
                    case 'status':
                        const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                        const needsMake = i.partsToBeMade > 0;
                        values.add(isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK'));
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        function getUniqueDatesColumnValues(columnKey) {
            const data = getFilteredDatesData();
            const monthStats = {};
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, pl: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (getStatus(r) === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) monthStats[month].pl += getPLValue(r);
            });
            const values = new Set();
            Object.entries(monthStats).forEach(([month, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                switch(columnKey) {
                    case 'month': values.add(formatMonthLabel(month)); break;
                    case 'status': values.add(`${stats.shipped}/${stats.orders} Shipped`); break;
                    case 'orders': values.add(String(stats.orders)); break;
                    case 'qty': values.add(String(stats.qty)); break;
                    case 'revenue': values.add(formatCurrency(stats.revenue)); break;
                    case 'pl': values.add(stats.pl >= 0 ? 'Positive' : 'Negative'); break;
                    case 'margin':
                        if (margin < 0) values.add('Negative');
                        else if (margin < 10) values.add('Low (0-10%)');
                        else if (margin < 20) values.add('Medium (10-20%)');
                        else values.add('High (>20%)');
                        break;
                }
            });
            return Array.from(values).sort();
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('columnFilterDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!dropdown.contains(e.target) && !e.target.closest('.filter-th-btns')) {
                    closeFilterDropdown();
                }
            }
        });

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function fetchSheetData(gid, captureHeaders = false) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const headers = json.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
            if (captureHeaders) allRawHeaders = headers.filter(h => h); // Store non-empty headers
            return json.table.rows.map(r => {
                const obj = {};
                headers.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                return obj;
            });
        }
        
        async function loadDashboard() {
            try {
                const raw = await fetchSheetData(MAIN_DATA_GID, true); // Pass true to capture headers
                allRawData = raw; // Store ALL raw data for All Data page
                allData = raw.filter(r => {
                    const cat = getCategory(r);
                    return (cat === 'rolltech' || cat === 'molding' || cat === 'snappad') && getVal(r, 'PART');
                });
                if (allData.length === 0) allData = raw.filter(r => getVal(r, 'PART'));
                
                loadInventoryData().catch(e => console.warn('Inventory load failed:', e));
                loadBOMData().catch(e => console.warn('BOM load failed:', e));
                fetchPalletData().catch(e => console.warn('Pallet data load failed:', e));
                
                const now = new Date();
                document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
                document.getElementById('dataInfo').innerHTML = `<strong>Data Loaded</strong>${allData.length} orders<br>${now.toLocaleTimeString()}`;
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('main').classList.add('active');
                updateMainDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('loadingState').innerHTML = `<h3 style="color:var(--danger);">âš Â Â Error</h3><p>${e.message}</p><button onclick="location.reload()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px;">Retry</button>`;
            }
        }
        
        async function loadInventoryData() {
            try {
                const fusionData = await fetchSheetData(FUSION_EXPORT_GID);
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                const prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum) {
                        const fusionInv = parseNumber(row['Fusion inventory']) || parseNumber(row['Fusion Inventory']);
                        if (partNum === 'FS-TPO' || partNum === 'FS-URTH-BRN') {
                            console.log('Inventory Debug v7.5 - ' + partNum + ':', { 
                                fusionInventory: fusionInv, 
                                rawLower: row['Fusion inventory'], 
                                rawUpper: row['Fusion Inventory'] 
                            });
                        }
                        var drawing1Url = row['Drawing 1 URL'] || row['Drawing 1 url'] || '';
                        var drawing2Url = row['Drawing 2 URL'] || row['Drawing 2 url'] || '';
                        prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            qtyNeeded: parseNumber(row['Quantity Needed']),
                            minimums: parseNumber(row['Minimums']),
                            manualTarget: parseNumber(row['Manual target']) || parseNumber(row['Manual Target']),
                            moldType: row['Mold type'] || row['Mold Type'] || '',
                            fusionInventory: fusionInv,
                            partsToBeMade: parseNumber(row['Parts to be made']) || parseNumber(row['Parts to be Made']),
                            drawing1Url: drawing1Url,
                            drawing2Url: drawing2Url
                        };
                        // Build global drawing lookup map
                        if (drawing1Url || drawing2Url) {
                            if (!window.drawingMap) window.drawingMap = {};
                            if (!window.drawingTypeMap) window.drawingTypeMap = {};
                            window.drawingMap[partNum] = { drawing1: drawing1Url, drawing2: drawing2Url };
                            var productType = (row['Product'] || '').toString().trim();
                            window.drawingTypeMap[partNum] = productType === 'Tire' ? 'Tire' : productType === 'Hub' ? 'Hub' : (productType || 'Other');
                        }
                    }
                });
                // Expose prodTotalsMap globally for Production Make page
                window.prodTotalsMap = prodTotalsMap;
                const mergedData = [];
                const seenParts = new Set();
                fusionData.forEach(row => {
                    let partNum = (row['itemNumber'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (!partNum) return;
                    seenParts.add(partNum);
                    const prodData = prodTotalsMap[partNum] || {};
                    const fusionTarget = parseNumber(row['Target']);
                    const fusionExportQty = parseNumber(row['Real number value']);
                    // Use Fusion Export qty if available, otherwise fall back to Production Data Totals
                    const finalFusionQty = fusionExportQty > 0 ? fusionExportQty : (prodData.fusionInventory || 0);
                    mergedData.push({
                        partNumber: partNum,
                        product: prodData.product || '',
                        fusionQty: finalFusionQty,
                        minimum: prodData.minimums || fusionTarget || 0,
                        manualTarget: prodData.manualTarget || 0,
                        qtyNeeded: prodData.qtyNeeded || 0,
                        partsToBeMade: prodData.partsToBeMade || 0,
                        moldType: prodData.moldType || ''
                    });
                });
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim().replace(/[^\x20-\x7E]/g, '');
                    if (partNum && !seenParts.has(partNum)) {
                        const data = prodTotalsMap[partNum];
                        mergedData.push({
                            partNumber: partNum,
                            product: data.product || '',
                            fusionQty: data.fusionInventory || 0,
                            minimum: data.minimums || 0,
                            manualTarget: data.manualTarget || 0,
                            qtyNeeded: data.qtyNeeded || 0,
                            partsToBeMade: data.partsToBeMade || 0,
                            moldType: data.moldType || ''
                        });
                    }
                });
                inventoryData = mergedData;
            } catch (e) { console.error('Inventory load error:', e); inventoryData = []; }
        }
        
        // Load historical inventory data (lazy loaded when needed)
        async function loadInventoryHistoryData() {
            if (inventoryHistoryLoaded) return; // Already loaded
            try {
                console.log('Loading inventory history data...');
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${INVENTORY_HISTORY_GID}`;
                const response = await fetch(url);
                const csvText = await response.text();
                
                // Parse CSV manually to preserve date headers
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.warn('No inventory history data found');
                    inventoryHistoryLoaded = true;
                    return;
                }
                
                // Parse header row to get dates (skip first column which is itemNumber)
                const headerRow = parseCSVLine(lines[0]);
                inventoryHistoryDates = [];
                for (let i = 1; i < headerRow.length; i++) {
                    const dateStr = headerRow[i].trim().replace(/^"|"$/g, '');
                    if (dateStr && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        inventoryHistoryDates.push(dateStr);
                    }
                }
                console.log(`Found ${inventoryHistoryDates.length} date columns`);
                
                // Parse data rows
                inventoryHistoryData = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    const partNumber = (row[0] || '').trim().replace(/^"|"$/g, '');
                    if (!partNumber) continue;
                    
                    const dataByDate = {};
                    for (let j = 1; j < row.length && j <= inventoryHistoryDates.length; j++) {
                        const qty = parseNumber(row[j]);
                        const date = inventoryHistoryDates[j - 1];
                        if (date) dataByDate[date] = qty;
                    }
                    
                    inventoryHistoryData.push({ partNumber, dataByDate });
                }
                console.log(`Loaded history for ${inventoryHistoryData.length} parts`);
                inventoryHistoryLoaded = true;
            } catch (e) {
                console.error('Inventory history load error:', e);
                inventoryHistoryData = [];
                inventoryHistoryDates = [];
            }
        }
        
        // Helper to parse CSV line handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        async function loadBOMData() {
            try {
                bomIndividualData = await fetchSheetData(BOM_INDIVIDUAL_GID);
                bomSubData = await fetchSheetData(BOM_SUB_GID);
                bomFinalData = await fetchSheetData(BOM_FINAL_GID);
            } catch (e) { console.warn('BOM load error:', e); }
        }
        
        async function fetchPalletData() {
            try {
                const data = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Raw pallet data first row keys:', data.length > 0 ? Object.keys(data[0]) : 'no data');
                console.log('Raw pallet data sample row:', data[0]);
                
                palletData = data.map(row => {
                    // Get all keys to find the right columns
                    const keys = Object.keys(row);
                    
                    // Find order number - try various patterns
                    let orderNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('order') && k.toLowerCase().includes('number')) {
                            orderNum = row[k];
                            break;
                        }
                    }
                    if (!orderNum) orderNum = row[keys[1]] || ''; // Fallback to column B
                    
                    // Find pallet number
                    let palletNum = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('pallet') && k.toLowerCase().includes('number')) {
                            palletNum = row[k];
                            break;
                        }
                    }
                    if (!palletNum) palletNum = row[keys[2]] || ''; // Fallback to column C
                    
                    // Find picture URL
                    let pictureUrl = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('picture') && !k.includes('2') && !k.includes('3') && !k.includes('4') && !k.includes('5')) {
                            pictureUrl = row[k];
                            break;
                        }
                    }
                    if (!pictureUrl) pictureUrl = row[keys[3]] || ''; // Fallback to column D
                    
                    // Find weight
                    let weight = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('weight')) {
                            weight = row[k];
                            break;
                        }
                    }
                    if (!weight) weight = row[keys[4]] || ''; // Fallback to column E
                    
                    // Find dimensions
                    let dims = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('dimension')) {
                            dims = row[k];
                            break;
                        }
                    }
                    if (!dims) dims = row[keys[5]] || ''; // Fallback to column F
                    
                    // Find parts/boxes per pallet (Column K)
                    let partsBoxes = '';
                    for (const k of keys) {
                        if (k.toLowerCase().includes('parts') || k.toLowerCase().includes('boxes') || k.toLowerCase().includes('per pallet')) {
                            partsBoxes = row[k];
                            break;
                        }
                    }
                    if (!partsBoxes) partsBoxes = row[keys[10]] || ''; // Fallback to column K (index 10)
                    
                    return {
                        orderNumber: String(orderNum).trim(),
                        palletNumber: palletNum,
                        pictureUrl: pictureUrl,
                        weight: weight,
                        dimensions: dims,
                        partsPerPallet: partsBoxes
                    };
                }).filter(p => p.orderNumber && p.orderNumber !== '');
                
                console.log('Pallet data loaded:', palletData.length, 'entries');
                if (palletData.length > 0) {
                    console.log('Sample parsed pallet:', palletData[0]);
                    // Log unique order numbers for debugging
                    const uniqueOrders = [...new Set(palletData.map(p => p.orderNumber))];
                    console.log('Unique order numbers in pallet data:', uniqueOrders.slice(0, 20));
                }
            } catch (e) { 
                console.error('Pallet data load error:', e); 
                palletData = []; 
            }
        }

        // ============================================================
        // SALES PASSWORD PROTECTION
        // ============================================================
        // Simple hash function to obscure password (not cryptographically secure, but deters casual inspection)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        const SALES_HASH = '2001594324'; // Hash of 'Sales@@@'
        let salesUnlocked = sessionStorage.getItem('salesUnlocked') === 'true';
        
        function checkSalesUnlock() {
            if (salesUnlocked) {
                // Show Sales & Finance items
                document.getElementById('salesNavItems').style.display = 'block';
                document.getElementById('salesNavTitle').classList.remove('sales-locked');
                document.getElementById('salesNavTitle').classList.add('sales-unlocked');
                document.getElementById('salesNavTitle').onclick = null;
                document.getElementById('salesNavTitle').innerHTML = '<span class="lock-icon">ðŸ”“</span> <span data-i18n="nav.salesFinance">Sales & Finance</span>';
                
                // Show BOM Explorer section
                document.getElementById('bomNavSection').style.display = 'block';
                
                // Unlock All Data nav item
                const allDataNav = document.getElementById('allDataNavItem');
                allDataNav.classList.remove('locked-item');
                allDataNav.onclick = function() { navigateTo('all-data'); };
                
                // Unlock FP Reference nav item
                const fpRefNav = document.getElementById('fpRefNavItem');
                if (fpRefNav) {
                    fpRefNav.classList.remove('locked-item');
                    fpRefNav.onclick = function() { navigateTo('fp-reference'); };
                }
                
                // Unlock Customer Reference nav item
                const custRefNav = document.getElementById('custRefNavItem');
                if (custRefNav) {
                    custRefNav.classList.remove('locked-item');
                    custRefNav.onclick = function() { navigateTo('customer-reference'); };
                }
                
                // Unlock Quotes Registry nav item
                const quotesNav = document.getElementById('quotesNavItem');
                if (quotesNav) {
                    quotesNav.classList.remove('locked-item');
                    quotesNav.onclick = function() { navigateTo('quotes-registry'); };
                }
                
                // Remove financial-hidden class from body to show financial data
                document.body.classList.remove('financial-hidden');
            } else {
                // Add financial-hidden class to body to hide financial data
                document.body.classList.add('financial-hidden');
            }
        }
        
        // Handle All Data click - prompts for password if locked
        function handleAllDataClick() {
            if (salesUnlocked) {
                navigateTo('all-data');
            } else {
                promptSalesPassword();
                if (salesUnlocked) {
                    navigateTo('all-data');
                }
            }
        }
        
        function promptSalesPassword() {
            const password = prompt('Enter password to access Sales & Finance:');
            if (password === null) return; // User cancelled
            
            if (simpleHash(password) === SALES_HASH) {
                salesUnlocked = true;
                sessionStorage.setItem('salesUnlocked', 'true');
                checkSalesUnlock();
                alert('Access granted! Sales & Finance section is now unlocked.');
            } else {
                alert('Incorrect password. Please try again.');
            }
        }
        
        // Check unlock state on page load
        document.addEventListener('DOMContentLoaded', checkSalesUnlock);

        // ============================================================
        // NAVIGATION
        // ============================================================
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const hideBtn = document.getElementById('sidebarToggleBtn');
            const tabBtn = document.getElementById('sidebarTabBtn');
            const main = document.querySelector('.main-content');
            const overlay = document.querySelector('.sidebar-overlay');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('active');
            main.classList.toggle('expanded', isCollapsed);
            tabBtn.classList.toggle('visible', isCollapsed);
            hideBtn.textContent = 'âœ• Hide';
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }
        // Restore sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            document.getElementById('mainSidebar').classList.add('collapsed');
            document.getElementById('sidebarTabBtn').classList.add('visible');
            document.querySelector('.main-content').classList.add('expanded');
        }
        
        function navigateTo(page) {
            // Check if trying to access sales pages without unlock
            const salesPages = ['sales-overview', 'sales-parts', 'sales-customers', 'sales-dates'];
            if (salesPages.includes(page) && !salesUnlocked) {
                promptSalesPassword();
                if (!salesUnlocked) return; // Still not unlocked, don't navigate
            }
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            currentPage = page;
            switch(page) {
                case 'main': updateMainDashboard(); break;
                case 'orders-data': updateOrdersDataPage(); break;
                case 'production-make': updateProdMakePage(); break;
                case 'orders-queue': updateOrdersQueuePage(); break;
                case 'orders-staged': updateOrdersStagedPage(); break;
                case 'orders-shipped': updateOrdersShippedPage(); break;
                case 'inventory': updateInventoryPage(); break;
                case 'inventory-history': updateInventoryHistoryPage(); break;
                case 'drawings-library': updateDrawingsLibrary(); break;
                case 'sales-overview': updateSalesOverview(); break;
                case 'sales-parts': updateSalesPartsPage(); break;
                case 'sales-customers': updateSalesCustomersPage(); break;
                case 'sales-dates': updateSalesDatesPage(); break;
                case 'bom': initBomExplorer(); break;
                case 'all-data': updateAllDataPage(); break;
                case 'fp-reference': updateFpReferencePage(); break;
                case 'customer-reference': updateCustReferencePage(); break;
                case 'quotes-registry': updateQuotesRegistryPage(); break;
                case 'pallet-records': updatePalletRecordsPage(); break;
                case 'shipping-records': updateShippingRecordsPage(); break;
                case 'staged-records': updateStagedRecordsPage(); break;
            }
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }
        
        // Old mobile toggleSidebar replaced by new unified version above

        // ============================================================
        // ZOOM CONTROLS
        // ============================================================
        let currentZoom = 100;
        
        function setZoom(value) {
            value = parseInt(value);
            if (isNaN(value) || value < 50) value = 50;
            if (value > 200) value = 200;
            currentZoom = value;
            document.getElementById('zoomInput').value = value;
            // Apply CSS zoom to html element - this scales everything including sidebar
            document.documentElement.style.zoom = value / 100;
            // Save to localStorage
            try { localStorage.setItem('rolltech_zoom', value); } catch(e) {}
        }
        
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }
        
        function resetZoom() {
            setZoom(100);
        }
        
        function loadSavedZoom() {
            try {
                const saved = localStorage.getItem('rolltech_zoom');
                if (saved) {
                    setZoom(parseInt(saved));
                }
            } catch(e) {}
        }

        // ============================================================
        // MAIN DASHBOARD
        // ============================================================
        function updateMainDashboard() {
            const rollTechData = allData.filter(r => getCategory(r) === 'rolltech');
            const needToMakeOrders = rollTechData.filter(r => getStatus(r) === 'pending' || getStatus(r) === 'wip');
            const urgentOrders = needToMakeOrders.filter(r => (getVal(r, 'URGENT') || '').toLowerCase() === 'urgent');
            const totalQty = needToMakeOrders.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthData = rollTechData.filter(r => {
                const d = r[COL.SHIPPED_DATE] || r[COL.REQUESTED_DATE];
                if (!d) return false;
                let month;
                if (d.includes('/')) { const parts = d.split('/'); month = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}`; }
                else { month = d.substring(0, 7); }
                return month === currentMonth;
            });
            const monthRevenue = monthData.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const monthPL = monthData.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            const missingComponents = needToMakeOrders.filter(r => {
                return isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS'));
            }).length;
            
            document.getElementById('qsNeedToMake').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('qsUrgentOrders').textContent = formatNumber(urgentOrders.length);
            document.getElementById('qsUrgentOrders').className = `value ${urgentOrders.length > 0 ? 'negative' : ''}`;
            document.getElementById('qsTotalQty').textContent = formatNumber(totalQty);
            document.getElementById('qsMissingComponents').textContent = formatNumber(missingComponents);
            
            document.getElementById('deptProdOrders').textContent = formatNumber(needToMakeOrders.length);
            document.getElementById('deptProdUnits').textContent = formatNumber(totalQty);
            document.getElementById('deptProdUrgent').textContent = formatNumber(urgentOrders.length);
            
            renderMainStatusChart(rollTechData.filter(r => getStatus(r) !== 'shipped'));
            renderMainDeadlineChart(needToMakeOrders);
        }
        
        function renderMainStatusChart(data) {
            const statusCounts = { pending: 0, wip: 0, staged: 0 };
            data.forEach(r => { const s = getStatus(r); if (statusCounts[s] !== undefined) statusCounts[s]++; });
            const labels = [t('status.needToMake'), t('status.making'), t('status.readyToShip')];
            const values = [statusCounts.pending, statusCounts.wip, statusCounts.staged];
            const colors = ['#d69e2e', '#319795', '#4299e1'];
            if (charts.mainStatus) charts.mainStatus.destroy();
            charts.mainStatus = new Chart(document.getElementById('mainStatusChart'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 11 } } } } }
            });
        }
        
        function renderMainDeadlineChart(data) {
            const deadlines = {};
            for (let i = -7; i <= 14; i++) deadlines[i] = 0;
            data.forEach(r => { const days = parseNumber(getVal(r, 'DAYS_UNTIL')); if (days >= -7 && days <= 14) deadlines[days]++; });
            const labels = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return `${Math.abs(n)}d late`; if (n === 0) return 'Today'; return `${n}d`; });
            const values = Object.values(deadlines);
            const colors = Object.keys(deadlines).map(d => { const n = parseInt(d); if (n < 0) return 'rgba(229,62,62,0.8)'; if (n <= 2) return 'rgba(214,158,46,0.8)'; return 'rgba(49,130,206,0.8)'; });
            if (charts.mainDeadline) charts.mainDeadline.destroy();
            charts.mainDeadline = new Chart(document.getElementById('mainDeadlineChart'), {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // ============================================================
        // ORDERS DATA PAGE (All orders with status filters)
        // ============================================================
        function toggleOrdersDataCategory(cat) {
            ordersDataFilters.categories[cat] = !ordersDataFilters.categories[cat];
            if (!ordersDataFilters.categories.rolltech && !ordersDataFilters.categories.molding && !ordersDataFilters.categories.snappad) { ordersDataFilters.categories[cat] = true; return; }
            document.getElementById('ordersDataBtnRollTech').classList.toggle('active', ordersDataFilters.categories.rolltech);
            document.getElementById('ordersDataBtnMolding').classList.toggle('active', ordersDataFilters.categories.molding);
            document.getElementById('ordersDataBtnSnapPad').classList.toggle('active', ordersDataFilters.categories.snappad);
            updateOrdersDataPage();
        }
        
        function toggleOrdersDataStatus(status) {
            ordersDataFilters.statuses[status] = !ordersDataFilters.statuses[status];
            document.getElementById(`ordersDataStatus${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.toggle('active', ordersDataFilters.statuses[status]);
            updateOrdersDataPage();
        }
        
        function updateOrdersDataPage() {
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersDataFilters.categories[cat]) return false;
                if (!ordersDataFilters.statuses[status]) return false;
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const needToMake = data.filter(r => getStatus(r) === 'pending').length;
            const making = data.filter(r => getStatus(r) === 'wip').length;
            const readyToShip = data.filter(r => getStatus(r) === 'staged').length;
            
            document.getElementById('ordersDataTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersDataTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersDataNeedToMake').textContent = formatNumber(needToMake);
            document.getElementById('ordersDataMaking').textContent = formatNumber(making);
            document.getElementById('ordersDataReadyToShip').textContent = formatNumber(readyToShip);
            document.getElementById('ordersDataLastUpdated').textContent = new Date().toLocaleTimeString();
            
            renderOrdersDataTableHeader();
            renderOrdersDataTable(data);
        }
        
        function renderOrdersDataTableHeader() {
            initTableFilters('ordersData');
            initHiddenColumns('ordersData');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'priority', label: t('col.priority') },
                { key: 'daysUntil', label: t('col.daysUntil') }, { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'tire', label: t('col.tire') }, { key: 'hub', label: t('col.hub') },
                { key: 'bearings', label: t('col.bearings') }, { key: 'status', label: t('col.status') }
            ];
            document.getElementById('ordersDataTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersData', h.key)) return '';
                return createFilterHeader('ordersData', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersDataTable(data) {
            renderOrdersDataTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const status = getStatus(r);
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersData', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersData', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersData', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersData', 'status', status)) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersDataSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = a[ordersDataSort.field]; vb = b[ordersDataSort.field];
                }
                if (typeof va === 'string') return ordersDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersDataSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersDataSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersDataTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersDataTableBody');
            tbody.innerHTML = sorted.map(r => {
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isRollTech = getCategory(r) === 'rolltech';
                // Only show missing warning for Roll Tech items
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                const lineNum = getVal(r, 'LINE') || '-';
                const status = getStatus(r);
                // Make all rows clickable to show order details
                const rowClass = 'clickable-row';
                const rowClick = `onclick="showPalletPictures('${lineNum}', this)"`;                
                // Helper for component cells - show N/A for non-Roll Tech
                const formatComponentForCategory = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                let cells = '';
                if (!isColumnHidden('ordersData', 'line')) cells += `<td><strong>${lineNum}</strong></td>`;
                if (!isColumnHidden('ordersData', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersData', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersData', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersData', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersData', 'tire')) cells += `<td>${formatComponentForCategory(getVal(r, 'TIRE'))}</td>`;
                if (!isColumnHidden('ordersData', 'hub')) cells += `<td>${formatComponentForCategory(getVal(r, 'HUB'))}</td>`;
                if (!isColumnHidden('ordersData', 'bearings')) cells += `<td>${formatComponentForCategory(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersData', 'status')) cells += `<td>${getStatusBadge(status)}</td>`;
                
                return `<tr class="${rowClass}" ${rowClick} style="${isMissing ? 'background:rgba(229,62,62,0.1);' : ''}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersData');
            updateShowHiddenButton('ordersData');
        }
        
        function openOrderDrilldown(lineNum) {
            // Find the order by line number and open appropriate drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                // Load necessary data asynchronously then show drilldown
                const status = getStatus(order);
                (async () => {
                    if (status === 'staged' && !stagedRecordsLoaded) {
                        await loadStagedRecordsData();
                    }
                    if (status === 'shipped' && !shippingRecordsLoaded) {
                        await loadShippingRecordsData();
                    }
                    showPalletPictures(lineNum);
                })();
            }
        }
        
        function openPalletDrilldownFromData(lineNum) {
            // Find the order by line number and open pallet drilldown
            const order = allData.find(r => getVal(r, 'LINE') === lineNum);
            if (order) {
                showPalletPictures(lineNum);
            }
        }
        
        function sortOrdersDataTable(field) {
            if (ordersDataSort.field === field) ordersDataSort.asc = !ordersDataSort.asc;
            else { ordersDataSort.field = field; ordersDataSort.asc = true; }
            updateOrdersDataPage();
        }
        
        function filterOrdersDataTable() { updateOrdersDataPage(); }
        
        function exportOrdersDataToCSV() {
            const data = allData.filter(r => ordersDataFilters.categories[getCategory(r)] && ordersDataFilters.statuses[getStatus(r)]);
            const headers = ['Line','IF #','PO #','Priority','Days Until','Customer','Part','Qty','Tire','Hub','Bearings','Status'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'IF_NUM'),getVal(r,'PO_NUM'),getVal(r,'PRIORITY'),getVal(r,'DAYS_UNTIL'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'BEARINGS'),getStatus(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_data.csv');
        }

        // ============================================================
        // ORDERS QUEUE PAGE (Need to Make = Pending + Approved)
        // ============================================================
        function toggleOrdersQueueCategory(cat) {
            ordersQueueFilters.categories[cat] = !ordersQueueFilters.categories[cat];
            if (!ordersQueueFilters.categories.rolltech && !ordersQueueFilters.categories.molding && !ordersQueueFilters.categories.snappad) { ordersQueueFilters.categories[cat] = true; return; }
            document.getElementById('ordersQueueBtnRollTech').classList.toggle('active', ordersQueueFilters.categories.rolltech);
            document.getElementById('ordersQueueBtnMolding').classList.toggle('active', ordersQueueFilters.categories.molding);
            document.getElementById('ordersQueueBtnSnapPad').classList.toggle('active', ordersQueueFilters.categories.snappad);
            updateOrdersQueuePage();
        }
        
        // ============================================================
        // PRODUCTION MAKE PAGE (Parts to Manufacture from Production Data Totals)
        // ============================================================
        let prodMakeData = [];
        let prodMakeFilter = 'all';
        let prodMakeSortCol = 'partsToBeMade';
        let prodMakeSortDir = 'desc';
        let prodMakeExpandedPart = null;
        
        async function updateProdMakePage() {
            // Show loading state
            document.getElementById('prodMakeTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Loading data...</td></tr>';
            try {
                // Load production data directly from sheet
                const prodTotalsData = await fetchSheetData(PROD_DATA_TOTALS_GID);
                window.prodTotalsMap = {};
                prodTotalsData.forEach(row => {
                    let partNum = (row['Part Number'] || '').toString().trim();
                    if (partNum) {
                        window.prodTotalsMap[partNum] = {
                            product: row['Product'] || '',
                            minimums: parseNumber(row['Minimums']),
                            moldType: row['Mold type'] || row['Mold Type'] || '',
                            fusionInventory: parseNumber(row['Fusion inventory']) || parseNumber(row['Fusion Inventory']),
                            partsToBeMade: parseNumber(row['Parts to be made']) || parseNumber(row['Parts to be Made']),
                            drawing1Url: row['Drawing 1 URL'] || '',
                            drawing2Url: row['Drawing 2 URL'] || ''
                        };
                    }
                });
                console.log('Production Make: Loaded', Object.keys(window.prodTotalsMap).length, 'parts');
                buildProdMakeData();
            } catch (e) {
                console.error('Failed to load production data:', e);
                document.getElementById('prodMakeTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#fc8181;">Error loading data. Please refresh.</td></tr>';
            }
        }
        
        function buildProdMakeData() {
            prodMakeData = [];
            for (const [partNum, data] of Object.entries(prodTotalsMap)) {
                const partsToBeMade = parseNumber(data.partsToBeMade) || 0;
                // Only include items that need to be made (parts to be made > 0)
                if (partsToBeMade > 0) {
                    prodMakeData.push({
                        product: data.product || '',
                        partNumber: partNum,
                        moldType: data.moldType || '',
                        fusionInventory: parseNumber(data.fusionInventory) || 0,
                        minimums: parseNumber(data.minimums) || 0,
                        manualTarget: parseNumber(data.manualTarget) || 0,
                        partsToBeMade: partsToBeMade,
                        drawing1: data.drawing1Url || '',
                        drawing2: data.drawing2Url || ''
                    });
                }
            }
            renderProdMakeTable();
        }
        
        function toggleProdMakeCategory(cat) {
            prodMakeFilter = cat;
            // Update button states
            document.querySelectorAll('#production-make .category-btn').forEach(btn => btn.classList.remove('active'));
            if (cat === 'all') {
                document.getElementById('prodMakeBtnAll').classList.add('active');
            } else if (cat === 'Tire') {
                document.getElementById('prodMakeBtnTire').classList.add('active');
            } else if (cat === 'Hub') {
                document.getElementById('prodMakeBtnHub').classList.add('active');
            } else if (cat === 'Rubber molded finished part') {
                document.getElementById('prodMakeBtnFinished').classList.add('active');
            } else if (cat === 'Bearing') {
                document.getElementById('prodMakeBtnBearing').classList.add('active');
            }
            renderProdMakeTable();
        }
        
        function sortProdMakeTable(col) {
            if (prodMakeSortCol === col) {
                prodMakeSortDir = prodMakeSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                prodMakeSortCol = col;
                prodMakeSortDir = 'desc';
            }
            renderProdMakeTable();
        }
        
        function filterProdMakeTable() {
            renderProdMakeTable();
        }
        
        function renderProdMakeTable() {
            const searchTerm = (document.getElementById('prodMakeSearch')?.value || '').toLowerCase();
            
            // Filter data
            let filtered = prodMakeData.filter(row => {
                // Category filter
                if (prodMakeFilter !== 'all' && row.product !== prodMakeFilter) return false;
                // Search filter
                if (searchTerm) {
                    const searchStr = (row.partNumber + ' ' + row.moldType + ' ' + row.product).toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                return true;
            });
            
            // Sort data
            filtered.sort((a, b) => {
                let valA = a[prodMakeSortCol];
                let valB = b[prodMakeSortCol];
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return prodMakeSortDir === 'asc' ? valA - valB : valB - valA;
                }
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if (valA < valB) return prodMakeSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return prodMakeSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update stats
            const totalUnits = filtered.reduce((s, r) => s + r.partsToBeMade, 0);
            document.getElementById('prodMakeTotalParts').textContent = filtered.length;
            document.getElementById('prodMakeTotalUnits').textContent = formatNumber(totalUnits) + ' units';
            document.getElementById('prodMakeTableCount').textContent = filtered.length + ' items';
            
            // Build table rows
            const tbody = document.getElementById('prodMakeTableBody');
            let html = '';
            
            filtered.forEach(row => {
                const hasDrawing = row.drawing1 || row.drawing2;
                const productColor = row.product === 'Tire' ? '#ed8936' : 
                                    row.product === 'Hub' ? '#38b2ac' : 
                                    row.product === 'Bearing' ? '#4a5568' : '#805ad5';
                
                html += `<tr class="clickable-row" onclick="toggleProdMakeDrawing('${row.partNumber}')" style="cursor:pointer;">
                    <td><span style="background:${productColor};color:white;padding:2px 8px;border-radius:4px;font-size:10px;">${row.product}</span></td>
                    <td><strong>${row.partNumber}</strong></td>
                    <td>${row.moldType || '-'}</td>
                    <td style="text-align:right;">${formatNumber(row.fusionInventory)}</td>
                    <td style="text-align:right;">${formatNumber(row.minimums)}</td>
                    <td style="text-align:right;font-weight:bold;color:#ed8936;">${formatNumber(row.partsToBeMade)}</td>
                    <td style="text-align:center;">${hasDrawing ? 'ðŸ“ View' : '-'}</td>
                </tr>`;
                
                // Add expanded drawing row if this part is expanded
                if (prodMakeExpandedPart === row.partNumber && hasDrawing) {
                    html += `<tr class="drawing-expanded-row">
                        <td colspan="7" style="background:rgba(237,137,54,0.1);padding:16px;border:2px solid #ed8936;">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">`;
                    if (row.drawing1) {
                        const thumb1 = getDriveThumbUrl(row.drawing1, 400);
                        const full1 = getDriveThumbUrl(row.drawing1, 1200);
                        if (thumb1) {
                            html += `<div class="drawing-thumb" onclick="event.stopPropagation();openImageModal('${full1}')">
                                <img src="${thumb1}" alt="Drawing 1" loading="lazy" onerror="this.parentElement.style.display='none'">
                                <div class="drawing-label">Drawing 1</div>
                            </div>`;
                        }
                    }
                    if (row.drawing2) {
                        const thumb2 = getDriveThumbUrl(row.drawing2, 400);
                        const full2 = getDriveThumbUrl(row.drawing2, 1200);
                        if (thumb2) {
                            html += `<div class="drawing-thumb" onclick="event.stopPropagation();openImageModal('${full2}')">
                                <img src="${thumb2}" alt="Drawing 2" loading="lazy" onerror="this.parentElement.style.display='none'">
                                <div class="drawing-label">Drawing 2</div>
                            </div>`;
                        }
                    }
                    html += `</div></td></tr>`;
                }
            });
            
            tbody.innerHTML = html;
        }
        
        function toggleProdMakeDrawing(partNumber) {
            if (prodMakeExpandedPart === partNumber) {
                prodMakeExpandedPart = null;
            } else {
                prodMakeExpandedPart = partNumber;
            }
            renderProdMakeTable();
        }
        
        function exportProdMakeToCSV() {
            const searchTerm = (document.getElementById('prodMakeSearch')?.value || '').toLowerCase();
            let filtered = prodMakeData.filter(row => {
                if (prodMakeFilter !== 'all' && row.product !== prodMakeFilter) return false;
                if (searchTerm) {
                    const searchStr = (row.partNumber + ' ' + row.moldType + ' ' + row.product).toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                return true;
            });
            
            let csv = 'Product,Part Number,Mold Type,Fusion Inventory,Minimums,Parts to Make\\n';
            filtered.forEach(row => {
                csv += `"${row.product}","${row.partNumber}","${row.moldType}",${row.fusionInventory},${row.minimums},${row.partsToBeMade}\\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'parts-to-make-' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function updateOrdersQueuePage() {
            // Queue = "pending" + "wip" statuses (orders still being worked on)
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersQueueFilters.categories[cat] && (status === 'pending' || status === 'wip');
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const isUrgentRow = r => { const u = (getVal(r, 'URGENT') || '').toString().toLowerCase().trim(); return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x'; };
            const urgentCount = data.filter(isUrgentRow).length;
            const dueWeek = data.filter(r => { const d = parseNumber(getVal(r, 'DAYS_UNTIL')); return d >= 0 && d <= 7; });
            const dueWeekQty = dueWeek.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const componentsReady = data.filter(r => getCategory(r) !== 'rolltech' || (!isMissingComponent(getVal(r,'TIRE')) && !isMissingComponent(getVal(r,'HUB')) && !isMissingComponent(getVal(r,'BEARINGS')))).length;
            const missingOrders = data.filter(r => getCategory(r) === 'rolltech' && (isMissingComponent(getVal(r,'TIRE')) || isMissingComponent(getVal(r,'HUB')) || isMissingComponent(getVal(r,'BEARINGS'))));
            
            document.getElementById('ordersQueueTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersQueueTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueUrgentCount').textContent = formatNumber(urgentCount);
            document.getElementById('ordersQueueDueWeek').textContent = formatNumber(dueWeek.length);
            document.getElementById('ordersQueueDueWeekUnits').textContent = `${formatNumber(dueWeekQty)} ${t('ui.units')}`;
            document.getElementById('ordersQueueComponentsReady').textContent = formatNumber(componentsReady);
            document.getElementById('ordersQueueLastUpdated').textContent = new Date().toLocaleTimeString();
            
            if (missingOrders.length > 0) {
                document.getElementById('ordersQueueMissingCount').textContent = missingOrders.length;
                document.getElementById('ordersQueueMissingBanner').classList.add('active');
            } else {
                document.getElementById('ordersQueueMissingBanner').classList.remove('active');
            }
            
            renderOrdersQueueTableHeader();
            renderOrdersQueueTable(data);
        }
        
        function renderOrdersQueueTableHeader() {
            initTableFilters('ordersQueue');
            initHiddenColumns('ordersQueue');
            const headers = [
                { key: 'category', label: t('col.category') },
                { key: 'dueDate', label: t('col.dueDate') },
                { key: 'priority', label: t('col.priority') },
                { key: 'line', label: t('col.line') },
                { key: 'customer', label: t('col.customer') },
                { key: 'ifNum', label: t('col.ifNum') },
                { key: 'fusionStatus', label: t('col.fusionStatus') },
                { key: 'part', label: t('col.part') },
                { key: 'numPackages', label: t('col.numPackages') },
                { key: 'packaging', label: t('col.packaging') },
                { key: 'partsPerPackage', label: t('col.partsPerPackage') },
                { key: 'qty', label: t('col.qty') },
                { key: 'fusionInv', label: t('col.fusionInv') },
                { key: 'tire', label: t('col.tire') },
                { key: 'hub', label: t('col.hub') },
                { key: 'hubMold', label: t('col.hubMold') },
                { key: 'bearings', label: t('col.bearings') },
                { key: 'assigned', label: t('col.assigned') },
                { key: 'status', label: t('col.status') },
                { key: 'daysUntil', label: t('col.daysUntil') }
            ];
            document.getElementById('ordersQueueTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersQueue', h.key)) return '';
                return createFilterHeader('ordersQueue', h.key, h.label, true);
            }).join('');
        }
        
        // Helper: check if inventory is enough
        function hasEnoughInventory(r) {
            const val = (getVal(r, 'ENOUGH_INV') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        function hasTire(r) {
            const val = (getVal(r, 'HAVE_TIRE') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        function hasHub(r) {
            const val = (getVal(r, 'HAVE_HUB') || '').toString().toLowerCase().trim();
            return val === 'yes' || val === 'true' || val === '1' || val === 'si' || val === 'sÃ­';
        }
        
        function renderOrdersQueueTable(data) {
            renderOrdersQueueTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const isRollTech = getCategory(r) === 'rolltech';
                if (!passesColumnFilter('ordersQueue', 'category', getCategory(r) || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'priority', getVal(r, 'PRIORITY') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'fusionStatus', getVal(r, 'FUSION_STATUS') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'numPackages', getVal(r, 'NUM_PACKAGES') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'partsPerPackage', getVal(r, 'PARTS_PER_PACKAGE') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersQueue', 'fusionInv', getVal(r, 'FUSION_INV') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'tire', isRollTech ? (getVal(r, 'TIRE') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hub', isRollTech ? (getVal(r, 'HUB') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'hubMold', getVal(r, 'HUB_MOLD') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'bearings', isRollTech ? (getVal(r, 'BEARINGS') || '-') : 'N/A')) return false;
                if (!passesColumnFilter('ordersQueue', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                if (!passesColumnFilter('ordersQueue', 'status', getStatusBadge(getStatus(r)))) return false;
                if (!passesColumnFilter('ordersQueue', 'daysUntil', String(parseNumber(getVal(r, 'DAYS_UNTIL')) || '-'))) return false;
                return true;
            });
            
            // Default sort: urgent first, then group by category, then by requested completion date
            const catOrder = { 'rolltech': 0, 'molding': 1, 'snappad': 2 };
            const isUrgentItem = r => { const u = (getVal(r, 'URGENT') || '').toString().toLowerCase().trim(); return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x'; };
            sorted.sort((a, b) => {
                let va, vb;
                // Always put urgent items first in default sort
                if (ordersQueueSort.field === 'default') {
                    const urgA = isUrgentItem(a) ? 0 : 1;
                    const urgB = isUrgentItem(b) ? 0 : 1;
                    if (urgA !== urgB) return urgA - urgB;
                    // Then group by category
                    const catA = catOrder[getCategory(a)] ?? 3;
                    const catB = catOrder[getCategory(b)] ?? 3;
                    if (catA !== catB) return catA - catB;
                    va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0);
                    vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0);
                    return va - vb;
                }
                switch(ordersQueueSort.field) {
                    case 'category': va = catOrder[getCategory(a)] ?? 3; vb = catOrder[getCategory(b)] ?? 3; break;
                    case 'dueDate': va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); break;
                    case 'priority': va = parseNumber(getVal(a, 'PRIORITY')); vb = parseNumber(getVal(b, 'PRIORITY')); break;
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'fusionStatus': va = getVal(a, 'FUSION_STATUS') || ''; vb = getVal(b, 'FUSION_STATUS') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'status': va = getStatus(a); vb = getStatus(b); break;
                    default: va = getVal(a, ordersQueueSort.field) || ''; vb = getVal(b, ordersQueueSort.field) || '';
                }
                if (typeof va === 'string') return ordersQueueSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersQueueSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersQueueSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'LINE') || '').toString().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersQueueTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersQueueTableBody');
            
            let lastCat = null;
            const colCount = document.getElementById('ordersQueueTableHeader').querySelectorAll('th').length;
            
            tbody.innerHTML = sorted.map(r => {
                const cat = getCategory(r);
                const isRollTech = cat === 'rolltech';
                const isUrgent = isUrgentItem(r);
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const isMissing = isRollTech && (isMissingComponent(getVal(r, 'TIRE')) || isMissingComponent(getVal(r, 'HUB')) || isMissingComponent(getVal(r, 'BEARINGS')));
                
                // Part # coloring: Molding/Snap Pad use inventory check; Roll Tech stays normal
                const partVal = getVal(r, 'PART') || '-';
                let partCell;
                if (cat === 'molding' || cat === 'snappad') {
                    const enough = hasEnoughInventory(r);
                    partCell = enough ? `<strong style="color:#48bb78;">${partVal}</strong>` : `<strong style="color:#fc8181;font-weight:900;">${partVal}</strong>`;
                } else {
                    partCell = `<strong>${partVal}</strong>`;
                }
                
                // Tire coloring: Roll Tech only
                const tireVal = getVal(r, 'TIRE') || '-';
                let tireCell;
                if (isRollTech) {
                    if (tireVal === '-' || !tireVal) { tireCell = '<span style="color:var(--text-secondary);">-</span>'; }
                    else { tireCell = hasTire(r) ? `<span style="color:#48bb78;">${tireVal}</span>` : `<strong style="color:#fc8181;">${tireVal}</strong>`; }
                } else {
                    tireCell = '<span style="color:var(--text-secondary);">N/A</span>';
                }
                
                // Hub coloring: Roll Tech only
                const hubVal = getVal(r, 'HUB') || '-';
                let hubCell;
                if (isRollTech) {
                    if (hubVal === '-' || !hubVal) { hubCell = '<span style="color:var(--text-secondary);">-</span>'; }
                    else { hubCell = hasHub(r) ? `<span style="color:#48bb78;">${hubVal}</span>` : `<strong style="color:#fc8181;">${hubVal}</strong>`; }
                } else {
                    hubCell = '<span style="color:var(--text-secondary);">N/A</span>';
                }
                
                const formatComponentCell = (value) => {
                    if (!isRollTech) return '<span style="color:var(--text-secondary);">N/A</span>';
                    return formatComponent(value);
                };
                
                // Category group separator
                let catRow = '';
                if (cat !== lastCat) {
                    lastCat = cat;
                    const catLabel = cat === 'rolltech' ? 'Roll Tech' : cat === 'molding' ? 'Molding' : cat === 'snappad' ? 'Snap Pad' : cat;
                    catRow = `<tr class="category-group-header"><td colspan="${colCount || 20}" style="background:var(--card-bg);padding:10px 16px;font-weight:bold;font-size:14px;border-top:2px solid var(--border-color);color:var(--text-primary);">ðŸ“ ${catLabel}</td></tr>`;
                }
                
                let cells = '';
                if (!isColumnHidden('ordersQueue', 'category')) cells += `<td>${cat === 'rolltech' ? 'Roll Tech' : cat === 'molding' ? 'Molding' : cat === 'snappad' ? 'Snap Pad' : cat}</td>`;
                if (!isColumnHidden('ordersQueue', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'priority')) cells += `<td>${getPriorityBadge(getVal(r, 'PRIORITY'), getVal(r, 'URGENT'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'line')) cells += `<td><strong>${getVal(r, 'LINE') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersQueue', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'fusionStatus')) cells += `<td>${getVal(r, 'FUSION_STATUS') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'part')) cells += `<td>${partCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'numPackages')) cells += `<td>${getVal(r, 'NUM_PACKAGES') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'partsPerPackage')) cells += `<td>${getVal(r, 'PARTS_PER_PACKAGE') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersQueue', 'fusionInv')) cells += `<td>${getVal(r, 'FUSION_INV') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'tire')) cells += `<td>${tireCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'hub')) cells += `<td>${hubCell}</td>`;
                if (!isColumnHidden('ordersQueue', 'hubMold')) cells += `<td>${getVal(r, 'HUB_MOLD') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'bearings')) cells += `<td>${formatComponentCell(getVal(r, 'BEARINGS'))}</td>`;
                if (!isColumnHidden('ordersQueue', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                if (!isColumnHidden('ordersQueue', 'status')) cells += `<td>${getStatusBadge(getStatus(r))}</td>`;
                if (!isColumnHidden('ordersQueue', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                
                const rowStyle = isUrgent ? 'background:rgba(229,62,62,0.25);' : isMissing ? 'background:rgba(229,62,62,0.1);' : '';
                const lineNum = getVal(r, 'LINE') || '';
                const statusVal = getStatus(r);
                const clickable = ` class="clickable-row" style="${rowStyle}cursor:pointer;" onclick="showNtmPalletDetails('${lineNum}', this)"`;
                return `${catRow}<tr${clickable}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersQueue');
            updateShowHiddenButton('ordersQueue');
        }
        
        function sortOrdersQueueTable(field) {
            if (ordersQueueSort.field === field) ordersQueueSort.asc = !ordersQueueSort.asc;
            else { ordersQueueSort.field = field; ordersQueueSort.asc = true; }
            updateOrdersQueuePage();
        }
        
        function filterOrdersQueueTable() { updateOrdersQueuePage(); }
        
        function exportOrdersQueueToCSV() {
            const data = allData.filter(r => ordersQueueFilters.categories[getCategory(r)] && getStatus(r) === 'pending');
            const headers = ['Category','Due Date','Priority','Line','Customer','IF #','IF Status','Part #','# Packages','Packaging','Parts/Package','Qty','Fusion Inventory','Tire','Hub','Hub Mold','Bearings','Assigned','Status','Days Until'];
            const rows = data.map(r => [getCategory(r),r[COL.REQUESTED_DATE],getVal(r,'PRIORITY'),getVal(r,'LINE'),getVal(r,'CUSTOMER'),getVal(r,'IF_NUM'),getVal(r,'FUSION_STATUS'),getVal(r,'PART'),getVal(r,'NUM_PACKAGES'),getVal(r,'PACKAGING'),getVal(r,'PARTS_PER_PACKAGE'),getVal(r,'QTY'),getVal(r,'FUSION_INV'),getVal(r,'TIRE'),getVal(r,'HUB'),getVal(r,'HUB_MOLD'),getVal(r,'BEARINGS'),getVal(r,'ASSIGNED'),getStatus(r),getVal(r,'DAYS_UNTIL')].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_queue.csv');
        }

        // ============================================================
        // ORDERS STAGED PAGE (Ready to Ship)
        // ============================================================
        function toggleOrdersStagedCategory(cat) {
            ordersStagedFilters.categories[cat] = !ordersStagedFilters.categories[cat];
            if (!ordersStagedFilters.categories.rolltech && !ordersStagedFilters.categories.molding && !ordersStagedFilters.categories.snappad) { ordersStagedFilters.categories[cat] = true; return; }
            document.getElementById('ordersStagedBtnRollTech').classList.toggle('active', ordersStagedFilters.categories.rolltech);
            document.getElementById('ordersStagedBtnMolding').classList.toggle('active', ordersStagedFilters.categories.molding);
            document.getElementById('ordersStagedBtnSnapPad').classList.toggle('active', ordersStagedFilters.categories.snappad);
            updateOrdersStagedPage();
        }
        
        async function updateOrdersStagedPage() {
            // Load staged records data for fusion pictures (async)
            if (!stagedRecordsLoaded) {
                await loadStagedRecordsData();
            }
            
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                return ordersStagedFilters.categories[cat] && status === 'staged';
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const avgValue = data.length > 0 ? totalRevenue / data.length : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersStagedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersStagedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersStagedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersStagedAvgValue').textContent = formatCurrency(avgValue);
            document.getElementById('ordersStagedCustomers').textContent = formatNumber(customers);
            
            renderOrdersStagedTableHeader();
            renderOrdersStagedTable(data);
        }
        
        function renderOrdersStagedTableHeader() {
            initTableFilters('ordersStaged');
            initHiddenColumns('ordersStaged');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'customer', label: t('col.customer') },
                { key: 'part', label: t('col.part') }, { key: 'qty', label: t('col.qty') },
                { key: 'packaging', label: t('col.packaging') }
            ];
            // Only add revenue column if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
            }
            headers.push(
                { key: 'dueDate', label: t('col.dueDate') }, { key: 'daysUntil', label: t('col.daysUntil') },
                { key: 'weight', label: t('col.weight') }, { key: 'dimensions', label: t('col.dimensions') },
                { key: 'assigned', label: t('col.assigned') }, { key: 'pallets', label: 'ðŸ“¦' }
            );
            document.getElementById('ordersStagedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersStaged', h.key)) return '';
                return createFilterHeader('ordersStaged', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersStagedTable(data) {
            renderOrdersStagedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                
                if (!passesColumnFilter('ordersStaged', 'line', line || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'packaging', getVal(r, 'PACKAGING') || '-')) return false;
                if (salesUnlocked && !passesColumnFilter('ordersStaged', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                if (!passesColumnFilter('ordersStaged', 'dueDate', r[COL.REQUESTED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'daysUntil', String(daysUntil || '-'))) return false;
                if (!passesColumnFilter('ordersStaged', 'weight', hasPallets ? formatNumber(totalWeight) + ' lbs' : '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'dimensions', firstDimensions)) return false;
                if (!passesColumnFilter('ordersStaged', 'assigned', getVal(r, 'ASSIGNED') || '-')) return false;
                if (!passesColumnFilter('ordersStaged', 'pallets', hasPallets ? String(pallets.length) : '-')) return false;
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                const lineA = getVal(a, 'LINE');
                const lineB = getVal(b, 'LINE');
                const palletA = getPalletDataForOrder(lineA);
                const palletB = getPalletDataForOrder(lineB);
                switch(ordersStagedSort.field) {
                    case 'line': va = parseNumber(lineA); vb = parseNumber(lineB); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'dueDate': 
                        va = parseDate(a[COL.REQUESTED_DATE]) || new Date(0); 
                        vb = parseDate(b[COL.REQUESTED_DATE]) || new Date(0); 
                        break;
                    case 'daysUntil': va = parseNumber(getVal(a, 'DAYS_UNTIL')); vb = parseNumber(getVal(b, 'DAYS_UNTIL')); break;
                    case 'weight': 
                        va = palletA.length > 0 ? palletA.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        vb = palletB.length > 0 ? palletB.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                        break;
                    case 'pallets':
                        va = palletA.length;
                        vb = palletB.length;
                        break;
                    default: va = getVal(a, ordersStagedSort.field) || ''; vb = getVal(b, ordersStagedSort.field) || '';
                }
                if (typeof va === 'string') return ordersStagedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersStagedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersStagedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersStagedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersStagedTableBody');
            
            // Debug: log line numbers being rendered
            const lineNums = sorted.map(r => getVal(r, 'LINE')).filter(Boolean);
            console.log('Staged orders Line numbers:', lineNums.slice(0, 20));
            
            tbody.innerHTML = sorted.map(r => {
                const line = getVal(r, 'LINE');
                const pallets = getPalletDataForOrder(line);
                const hasPallets = pallets.length > 0;
                const totalWeight = hasPallets ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : 0;
                const firstDimensions = hasPallets && pallets[0].dimensions ? pallets[0].dimensions : '-';
                const daysUntil = parseNumber(getVal(r, 'DAYS_UNTIL'));
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                const palletIndicator = hasPallets ? `<span class="pallet-indicator" title="${pallets.length} ${t('pallet.pallets').toLowerCase()}">ðŸ“· ${pallets.length}</span>` : 'ðŸ“‹';
                // Always allow clicking to view drilldown (may have fusion pictures even without pallets)
                const clickHandler = `onclick="showPalletPictures('${line}', this)" style="cursor:pointer;"`;
                
                let cells = '';
                if (!isColumnHidden('ordersStaged', 'line')) cells += `<td><strong>${line || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersStaged', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (!isColumnHidden('ordersStaged', 'packaging')) cells += `<td>${getVal(r, 'PACKAGING') || '-'}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersStaged', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (!isColumnHidden('ordersStaged', 'dueDate')) cells += `<td>${r[COL.REQUESTED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'daysUntil')) cells += `<td class="${daysClass}">${daysUntil || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'weight')) cells += `<td>${hasPallets ? formatNumber(totalWeight) + ' lbs' : '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'dimensions')) cells += `<td>${firstDimensions}</td>`;
                if (!isColumnHidden('ordersStaged', 'assigned')) cells += `<td>${getVal(r, 'ASSIGNED') || '-'}</td>`;
                if (!isColumnHidden('ordersStaged', 'pallets')) cells += `<td>${palletIndicator}</td>`;
                
                return `<tr class="clickable-row" ${clickHandler}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersStaged');
            updateShowHiddenButton('ordersStaged');
        }
        
        // Get pallet data for a specific order (by Line number)
        function getPalletDataForOrder(lineNum) {
            if (!lineNum || !palletData || palletData.length === 0) return [];
            const lineStr = String(lineNum).trim();
            const matches = palletData.filter(p => String(p.orderNumber).trim() === lineStr);
            if (matches.length > 0) {
                console.log(`Found ${matches.length} pallets for line ${lineStr}`);
            }
            return matches;
        }
        
        // Get staged records data for an order by IF number or Line number
        function getStagedRecordsForOrder(ifNum, lineNum) {
            if (!stagedRecordsData || stagedRecordsData.length === 0) return null;
            const ifNumNorm = String(ifNum || '').trim().toUpperCase();
            const lineNumNorm = String(lineNum || '').trim();
            
            // Only return records where Order Status = "Staged" (these have the Fusion pictures)
            return stagedRecordsData.find(row => {
                const orderStatus = String(row['Order Status'] || '').trim().toLowerCase();
                // Skip records that are not "Staged" - they don't have fusion pictures
                if (!orderStatus.includes('staged')) return false;
                
                const rowIf = String(row['IF Number'] || '').trim().toUpperCase();
                const rowLine = String(row['Line Number'] || '').trim();
                if (ifNumNorm && rowIf && rowIf.includes(ifNumNorm)) return true;
                if (lineNumNorm && rowLine === lineNumNorm) return true;
                return false;
            });
        }
        
        // Get shipping records data for an order by IF number
        function getShippingRecordsForOrder(ifNum) {
            if (!shippingRecordsData || shippingRecordsData.length === 0) return [];
            const ifNumNorm = String(ifNum || '').trim().toUpperCase();
            if (!ifNumNorm) return [];
            
            return shippingRecordsData.filter(row => {
                const rowIf = String(row['IF Number'] || '').trim().toUpperCase();
                // Check if IF number matches (can be comma-separated or dash-separated)
                if (rowIf.includes(ifNumNorm)) return true;
                // Parse multiple IFs
                const ifNums = rowIf.split(/[,\-\s]+/).map(s => s.trim().toUpperCase());
                return ifNums.includes(ifNumNorm);
            });
        }
        
        // Show pallet pictures modal for an order (using Line number)
        async function showPalletPictures(lineNum, clickedRow) {
            // Ensure staged and shipping records are loaded
            await loadStagedRecordsData();
            await loadShippingRecordsData();
            
            // If clicking the same order, close it
            if (currentPalletOrder === lineNum) {
                closePalletDrilldown();
                return;
            }
            
            // Close any existing drilldown first
            closePalletDrilldown();
            
            const pallets = getPalletDataForOrder(lineNum);
            
            currentPalletOrder = lineNum;
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            const ifNum = orderData ? getVal(orderData, 'IF_NUM') : '';
            const status = orderData ? getStatus(orderData) : '';
            const daysUntil = orderData ? parseNumber(getVal(orderData, 'DAYS_UNTIL')) : 0;
            
            // Calculate days early/late for shipped orders
            let daysEarlyLate = '';
            let daysEarlyLateClass = '';
            if (status === 'shipped' && orderData) {
                const shippedDateStr = orderData[COL.SHIPPED_DATE];
                const requestedDateStr = orderData[COL.REQUESTED_DATE];
                if (shippedDateStr && requestedDateStr) {
                    const shippedDate = parseDate(shippedDateStr);
                    const requestedDate = parseDate(requestedDateStr);
                    if (shippedDate && requestedDate) {
                        const diffDays = Math.round((requestedDate - shippedDate) / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysEarlyLate = `${diffDays} days early`;
                            daysEarlyLateClass = 'positive';
                        } else if (diffDays < 0) {
                            daysEarlyLate = `${Math.abs(diffDays)} days late`;
                            daysEarlyLateClass = 'negative';
                        } else {
                            daysEarlyLate = 'On time';
                            daysEarlyLateClass = 'positive';
                        }
                    }
                }
            }
            
            // Get staged records for fusion picture (for staged orders)
            const stagedRecord = getStagedRecordsForOrder(ifNum, lineNum);
            const fusionPictures = stagedRecord ? (stagedRecord['Fusion Pictures'] || []) : [];
            
            // Get shipping records for shipping photos (for shipped orders)
            const shippingRecords = getShippingRecordsForOrder(ifNum);
            console.log('==== SHIPPING PHOTOS DEBUG ====');
            console.log('IF Number:', ifNum);
            console.log('Shipping records found:', shippingRecords.length);
            if (shippingRecords.length > 0) {
                console.log('First shipping record:', JSON.stringify(shippingRecords[0], null, 2));
            }
            // Aggregate all photos from all matching records
            const shipmentPictures = shippingRecords.flatMap(r => r['Shipment Pictures'] || []);
            const paperworkPictures = shippingRecords.flatMap(r => r['Paperwork Pictures'] || []);
            const closeUpPictures = shippingRecords.flatMap(r => r['Close Up Pictures'] || []);
            console.log('Photos found - Shipment:', shipmentPictures.length, 'Paperwork:', paperworkPictures.length, 'CloseUp:', closeUpPictures.length);
            console.log('============================');
            
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            
            // Build summary section with IF# and days info
            let summaryHtml = `
                <div class="pallet-summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.ifNum')}</div><div class="value">${ifNum || '-'}</div></div>
            `;
            
            if (status === 'staged') {
                // Show days remaining for staged orders
                const daysClass = daysUntil < 0 ? 'negative' : daysUntil <= 3 ? 'warning-text' : '';
                summaryHtml += `<div class="pallet-summary-item"><div class="label">${t('col.daysUntil')}</div><div class="value ${daysClass}">${daysUntil} days</div></div>`;
            } else if (status === 'shipped' && daysEarlyLate) {
                // Show days early/late for shipped orders
                summaryHtml += `<div class="pallet-summary-item"><div class="label">Delivery</div><div class="value ${daysEarlyLateClass}">${daysEarlyLate}</div></div>`;
            }
            
            summaryHtml += `
                <div class="pallet-summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${pallets.length}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Build gallery content - horizontal layout with 4 boxes filling full width
            let galleryHtml = '<div class="photo-drilldown-grid">';
            
            // BOX 1: Pallet Details (Blue)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(49, 130, 206, 0.15); border: 1px solid var(--accent); border-top: 4px solid var(--accent);">`;
            galleryHtml += `<h4 style="color: var(--accent);">ðŸ“¦ ${t('photo.palletDetails')}</h4>`;
            if (pallets.length > 0) {
                // Show pallet info with photo thumbnails
                galleryHtml += `<div class="photo-thumbnails" style="margin-bottom: 12px;">`;
                pallets.forEach((p, idx) => {
                    const num = p.palletNumber || (idx + 1);
                    if (p.pictureUrl) {
                        galleryHtml += buildPhotoThumb(p.pictureUrl, `Pallet ${num}`, 'pallet-photo');
                    }
                });
                galleryHtml += `</div>`;
                galleryHtml += `<div class="photo-info" style="font-size: 11px;">`;
                galleryHtml += pallets.map((p, idx) => `#${p.palletNumber || (idx + 1)}: ${p.weight || '-'}lbs, ${p.dimensions || '-'}`).join(' | ');
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noPalletData')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 2: Fusion Pictures (Teal/Cyan)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(56, 178, 172, 0.15); border: 1px solid #38b2ac; border-top: 4px solid #38b2ac;">`;
            galleryHtml += `<h4 style="color: #38b2ac;">ðŸ“„ ${t('photo.fusionPictures')}</h4>`;
            if (fusionPictures.length > 0) {
                galleryHtml += `<div class="photo-thumbnails">`;
                fusionPictures.forEach((url, i) => {
                    galleryHtml += buildPhotoThumb(url, `Fusion ${i + 1}`, 'fusion-photo');
                });
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noFusionPictures')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 3: Shipment & Paperwork Pictures (Green)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(56, 161, 105, 0.15); border: 1px solid var(--success); border-top: 4px solid var(--success);">`;
            galleryHtml += `<h4 style="color: var(--success);">ðŸšš ${t('photo.shipmentPhotos')}</h4>`;
            if (shipmentPictures.length > 0 || paperworkPictures.length > 0) {
                if (shipmentPictures.length > 0) {
                    galleryHtml += `<div style="margin-bottom: 10px;"><div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">${t('photo.ship')}:</div>`;
                    galleryHtml += `<div class="photo-thumbnails">`;
                    shipmentPictures.forEach((url, i) => {
                        galleryHtml += buildPhotoThumb(url, `${t('photo.ship')} ${i + 1}`, 'shipment-photo');
                    });
                    galleryHtml += `</div></div>`;
                }
                if (paperworkPictures.length > 0) {
                    galleryHtml += `<div><div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">${t('photo.docs')}:</div>`;
                    galleryHtml += `<div class="photo-thumbnails">`;
                    paperworkPictures.forEach((url, i) => {
                        galleryHtml += buildPhotoThumb(url, `Doc ${i + 1}`, 'paperwork-photo');
                    });
                    galleryHtml += `</div></div>`;
                }
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noShipmentPhotos')}</div>`;
            }
            galleryHtml += `</div>`;
            
            // BOX 4: Close-Up Pictures (Purple)
            galleryHtml += `<div class="photo-drilldown-box" style="background: rgba(128, 90, 213, 0.15); border: 1px solid #805ad5; border-top: 4px solid #805ad5;">`;
            galleryHtml += `<h4 style="color: #805ad5;">ðŸ” ${t('photo.closeUpPictures')}</h4>`;
            if (closeUpPictures.length > 0) {
                galleryHtml += `<div class="photo-thumbnails">`;
                closeUpPictures.forEach((url, i) => {
                    galleryHtml += buildPhotoThumb(url, `Close-up ${i + 1}`, 'closeup-photo');
                });
                galleryHtml += `</div>`;
            } else {
                galleryHtml += `<div class="photo-info">${t('photo.noCloseUpPictures')}</div>`;
            }
            galleryHtml += `</div>`;
            
            galleryHtml += '</div>'; // Close grid
            
            // Add drawing thumbnails for tire and hub (category-aware)
            var drillTirePartNum = orderData ? getVal(orderData, 'TIRE') : '';
            var drillHubPartNum = orderData ? getVal(orderData, 'HUB') : '';
            var drillCategory = orderData ? getCategory(orderData) : '';
            var drillPartNum = orderData ? getVal(orderData, 'PART') : '';
            galleryHtml += buildDrawingThumbnails(drillTirePartNum, drillHubPartNum, drillCategory, drillPartNum);
            
            // Build the full drilldown HTML
            const drilldownHtml = `
                <tr id="orderDrilldownRow" class="order-drilldown-row">
                    <td colspan="20" style="padding: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 0 0 10px 10px;">
                        <div style="padding: 20px 24px;">
                            <div class="pallet-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div class="breadcrumb" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Order Details â€º Line #${lineNum}</div>
                                    <h3 style="font-size: 16px; margin: 0;">Order Photos & Details</h3>
                                </div>
                                <button class="close-btn" onclick="closePalletDrilldown()" style="background: var(--bg-dark); border: 1px solid var(--border); padding: 8px 14px; border-radius: 6px; cursor: pointer; color: var(--text); font-size: 12px;">âœ• Close</button>
                            </div>
                            <div class="pallet-summary" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                                ${summaryHtml}
                            </div>
                            <div style="width: 100%;">
                                ${galleryHtml}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            
            // Find the clicked row and insert drilldown after it
            if (clickedRow) {
                clickedRow.classList.add('drilldown-active');
                clickedRow.insertAdjacentHTML('afterend', drilldownHtml);
            } else {
                // Fallback: find the row by line number
                const allRows = document.querySelectorAll('tr.clickable-row');
                for (const row of allRows) {
                    const lineCell = row.querySelector('td:first-child strong');
                    if (lineCell && lineCell.textContent === String(lineNum)) {
                        row.classList.add('drilldown-active');
                        row.insertAdjacentHTML('afterend', drilldownHtml);
                        break;
                    }
                }
            }
            
            // Scroll the drilldown into view
            const drilldownRow = document.getElementById('orderDrilldownRow');
            if (drilldownRow) {
                drilldownRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function closePalletDrilldown() {
            // Remove any existing drilldown row
            const existingDrilldown = document.getElementById('orderDrilldownRow');
            if (existingDrilldown) {
                existingDrilldown.remove();
            }
            // Remove active state from all rows
            document.querySelectorAll('tr.drilldown-active').forEach(row => row.classList.remove('drilldown-active'));
            currentPalletOrder = null;
        }
        
        // Need to Make - Pallet drilldown for MAKING status rows (pallet details only)
        async function showNtmPalletDetails(lineNum, clickedRow) {
            // Toggle: if clicking same order, close it
            if (currentPalletOrder === lineNum) {
                closePalletDrilldown();
                return;
            }
            closePalletDrilldown();
            
            const pallets = getPalletDataForOrder(lineNum);
            currentPalletOrder = lineNum;
            
            const orderData = allData.find(r => String(getVal(r, 'LINE')).trim() === String(lineNum).trim());
            const customer = orderData ? getVal(orderData, 'CUSTOMER') : '';
            const part = orderData ? getVal(orderData, 'PART') : '';
            const ifNum = orderData ? getVal(orderData, 'IF_NUM') : '';
            const qty = orderData ? parseNumber(getVal(orderData, 'QTY')) : 0;
            const totalWeight = pallets.reduce((s, p) => s + parseNumber(p.weight), 0);
            const totalParts = pallets.reduce((s, p) => s + parseNumber(p.partsPerPallet || p.boxesPerPallet), 0);
            
            // Summary info
            let summaryHtml = `
                <div class="pallet-summary-item"><div class="label">${t('col.customer')}</div><div class="value">${customer}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.part')}</div><div class="value">${part}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.ifNum')}</div><div class="value">${ifNum || '-'}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('col.qty')}</div><div class="value">${formatNumber(qty)}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.pallets')}</div><div class="value">${pallets.length}</div></div>
                <div class="pallet-summary-item"><div class="label">${t('pallet.totalWeight')}</div><div class="value">${formatNumber(totalWeight)} lbs</div></div>
            `;
            
            // Build pallet details - ONLY pallet box (no fusion, shipping, or close-up)
            let palletHtml = '';
            if (pallets.length > 0) {
                palletHtml += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; width: 100%;">`;
                pallets.forEach((p, idx) => {
                    const num = p.palletNumber || (idx + 1);
                    const photoUrls = p.pictureUrl ? getPhotoUrls(p.pictureUrl) : null;
                    palletHtml += `<div style="background: rgba(49, 130, 206, 0.1); border: 1px solid var(--accent); border-radius: 10px; overflow: hidden;">`;
                    palletHtml += `<div style="padding: 12px 16px; background: rgba(49, 130, 206, 0.15); border-bottom: 1px solid var(--accent);">`;
                    palletHtml += `<strong style="color: var(--accent);">ðŸ“¦ Pallet ${num}</strong>`;
                    palletHtml += `</div>`;
                    if (photoUrls) {
                        palletHtml += `<div style="padding: 12px; cursor: pointer;" onclick="openImageModal('${photoUrls.full}')">`;
                        palletHtml += `<img src="${photoUrls.thumb}" alt="Pallet ${num}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px; border: 2px solid var(--border); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'" onerror="this.parentElement.style.display='none'">`;
                        palletHtml += `</div>`;
                    }
                    palletHtml += `<div class="pallet-card-details">`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Weight:</span> <span class="value">${p.weight || '-'} lbs</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Dimensions:</span> <span class="value">${p.dimensions || '-'}</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Parts/Boxes:</span> <span class="value">${p.partsPerPallet || p.boxesPerPallet || '-'}</span></div>`;
                    palletHtml += `<div class="pallet-detail"><span class="label">Order #:</span> <span class="value">${p.orderNumber || '-'}</span></div>`;
                    palletHtml += `</div></div>`;
                });
                palletHtml += `</div>`;
            } else {
                palletHtml = `<div style="text-align:center; padding: 30px; color: var(--text-secondary);"><p style="font-size: 14px;">ðŸ“¦ ${t('photo.noPalletData')}</p><p style="font-size: 12px; margin-top: 8px;">No pallet records found for Line #${lineNum}</p></div>`;
            }
            
            // Add drawing thumbnails for NTM drilldown (category-aware)
            var ntmTirePartNum = orderData ? getVal(orderData, 'TIRE') : '';
            var ntmHubPartNum = orderData ? getVal(orderData, 'HUB') : '';
            var ntmCategory = orderData ? getCategory(orderData) : '';
            var ntmPartNum = orderData ? getVal(orderData, 'PART') : '';
            var ntmDrawingHtml = buildDrawingThumbnails(ntmTirePartNum, ntmHubPartNum, ntmCategory, ntmPartNum);
            
            const colCount = document.getElementById('ordersQueueTableHeader').querySelectorAll('th').length;
            const drilldownHtml = `
                <tr id="orderDrilldownRow" class="order-drilldown-row">
                    <td colspan="${colCount}" style="padding: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 0 0 10px 10px; margin-top: -1px;">
                        <div style="padding: 20px 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Making â€º Line #${lineNum}</div>
                                    <h3 style="font-size: 16px; margin: 0;">ðŸ“¦ Pallet Details</h3>
                                </div>
                                <button onclick="closePalletDrilldown()" style="background: var(--bg-dark); border: 1px solid var(--border); padding: 8px 14px; border-radius: 6px; cursor: pointer; color: var(--text); font-size: 12px;">âœ• Close</button>
                            </div>
                            <div class="pallet-summary" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;">
                                ${summaryHtml}
                            </div>
                            ${palletHtml}
                            ${ntmDrawingHtml}
                        </div>
                    </td>
                </tr>
            `;
            
            if (clickedRow) {
                clickedRow.classList.add('drilldown-active');
                clickedRow.insertAdjacentHTML('afterend', drilldownHtml);
            }
            
            const drilldownRow = document.getElementById('orderDrilldownRow');
            if (drilldownRow) {
                drilldownRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function openImageModal(imgUrl) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalImage').src = imgUrl;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        // Get thumbnail and full URLs for a photo (handles Google Drive/Forms and direct URLs)
        function getPhotoUrls(url) {
            if (!url) return null;
            url = String(url).trim();
            if (!url) return null;
            
            var fileId = null;
            
            // Pattern 1: /d/FILEID/ (standard Drive share link)
            var m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (m1) fileId = m1[1];
            
            // Pattern 2: id=FILEID (Google Forms, open?id=, export?id=)
            if (!fileId) {
                var m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (m2) fileId = m2[1];
            }
            
            // Pattern 3: lh3.googleusercontent.com/d/FILEID
            if (!fileId) {
                var m3 = url.match(/googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/);
                if (m3) fileId = m3[1];
            }
            
            // If we found a Google file ID, use thumbnail API
            if (fileId) {
                return {
                    thumb: 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w200',
                    full: 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1200'
                };
            }
            
            // Direct image URL - use as-is for both
            return { thumb: url, full: url };
        }
        
        // Build photo thumbnail HTML
        function buildPhotoThumb(url, label, cssClass) {
            var urls = getPhotoUrls(url);
            if (!urls) return '';
            return '<div class="photo-thumb ' + cssClass + '" onclick="openImageModal(\'' + urls.full + '\')">' +
                   '<img src="' + urls.thumb + '" alt="' + label + '" loading="lazy" onerror="this.parentElement.style.display=\'none\'">' +
                   '<div class="photo-label">' + label + '</div></div>';
        }
        
        // Extract Google Drive file ID from URL and build thumbnail URL
        function getDriveThumbUrl(driveUrl, size) {
            if (!driveUrl) return null;
            var m = driveUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
            return m ? 'https://drive.google.com/thumbnail?id=' + m[1] + '&sz=w' + (size || 400) : null;
        }

        // Build drawing thumbnails HTML â€” category-aware labels
        // For Roll Tech: shows Tire Drawing + Hub Drawing separately
        // For other categories: shows Part Drawing (using part number lookup)
        function buildDrawingThumbnails(tirePartNum, hubPartNum, category, partNum) {
            if (!window.drawingMap) return '';
            var isRollTech = category === 'rolltech';
            var drawings = [];
            
            if (isRollTech) {
                // Roll Tech: separate tire and hub drawings
                var tireDrawings = tirePartNum ? (window.drawingMap[tirePartNum.toString().trim()] || null) : null;
                var hubDrawings = hubPartNum ? (window.drawingMap[hubPartNum.toString().trim()] || null) : null;
                if (tireDrawings) {
                    if (tireDrawings.drawing1) drawings.push({ url: tireDrawings.drawing1, label: t('drawing.tireDrawing') + ' 1', alt: 'Tire Drawing 1' });
                    if (tireDrawings.drawing2) drawings.push({ url: tireDrawings.drawing2, label: t('drawing.tireDrawing') + ' 2', alt: 'Tire Drawing 2' });
                }
                if (hubDrawings) {
                    if (hubDrawings.drawing1) drawings.push({ url: hubDrawings.drawing1, label: t('drawing.hubDrawing') + ' 1', alt: 'Hub Drawing 1' });
                    if (hubDrawings.drawing2) drawings.push({ url: hubDrawings.drawing2, label: t('drawing.hubDrawing') + ' 2', alt: 'Hub Drawing 2' });
                }
            } else {
                // Other categories: look up part number directly
                var partDrawings = partNum ? (window.drawingMap[partNum.toString().trim()] || null) : null;
                if (partDrawings) {
                    if (partDrawings.drawing1) drawings.push({ url: partDrawings.drawing1, label: t('drawing.partDrawing') + ' 1', alt: 'Part Drawing 1' });
                    if (partDrawings.drawing2) drawings.push({ url: partDrawings.drawing2, label: t('drawing.partDrawing') + ' 2', alt: 'Part Drawing 2' });
                }
            }
            
            if (drawings.length === 0) return '';
            
            var html = '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">';
            html += '<h4 style="font-size: 14px; font-weight: 600; color: #ed8936; margin: 0 0 12px 0;">\uD83D\uDCD0 ' + t('drawing.drawings') + '</h4>';
            html += '<div class="drawing-thumbnails">';
            
            drawings.forEach(function(d) {
                var thumbUrl = getDriveThumbUrl(d.url, 400);
                var fullUrl = getDriveThumbUrl(d.url, 1200);
                if (thumbUrl) {
                    html += '<div class="drawing-thumb" onclick="openImageModal(\'' + fullUrl + '\')">';
                    html += '<img src="' + thumbUrl + '" alt="' + d.alt + '" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                    html += '<div class="drawing-label">' + d.label + '</div></div>';
                }
            });
            
            html += '</div></div>';
            return html;
        }
        
        // ============================================================
        // DRAWINGS LIBRARY PAGE
        // ============================================================
        function updateDrawingsLibrary() {
            if (!window.drawingMap) {
                // Drawings not loaded yet â€” try loading inventory data first
                loadInventoryData().then(function() { renderDrawingsLibrary(); });
                return;
            }
            renderDrawingsLibrary();
        }
        
        function filterDrawingsLibrary() {
            renderDrawingsLibrary();
        }
        
        function renderDrawingsLibrary() {
            var grid = document.getElementById('drawingsLibraryGrid');
            var countEl = document.getElementById('drawingsLibraryCount');
            if (!grid) return;
            
            if (!window.drawingMap || Object.keys(window.drawingMap).length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-secondary);"><p style="font-size: 16px;">ðŸ“ ' + t('drawing.noResults') + '</p></div>';
                if (countEl) countEl.textContent = '0 ' + t('drawing.drawings').toLowerCase();
                return;
            }
            
            var search = (document.getElementById('drawingsSearch')?.value || '').toLowerCase().trim();
            var typeFilter = document.getElementById('drawingsTypeFilter')?.value || 'all';
            
            // Build list of all parts with drawings, with their type from prodTotalsData
            var entries = [];
            var drawingMapKeys = Object.keys(window.drawingMap);
            
            // Also build type info from drawingTypeMap (populated during data load)
            drawingMapKeys.forEach(function(partNum) {
                var d = window.drawingMap[partNum];
                var typeInfo = window.drawingTypeMap ? (window.drawingTypeMap[partNum] || 'Other') : 'Other';
                
                // Apply filters
                if (search && !partNum.toLowerCase().includes(search)) return;
                if (typeFilter !== 'all' && typeInfo !== typeFilter) return;
                
                entries.push({
                    partNum: partNum,
                    type: typeInfo,
                    drawing1: d.drawing1,
                    drawing2: d.drawing2
                });
            });
            
            // Sort: Tires first, then Hubs, then others
            var typeOrder = { 'Tire': 0, 'Hub': 1, 'Other': 2 };
            entries.sort(function(a, b) {
                var ta = typeOrder[a.type] !== undefined ? typeOrder[a.type] : 2;
                var tb = typeOrder[b.type] !== undefined ? typeOrder[b.type] : 2;
                if (ta !== tb) return ta - tb;
                return a.partNum.localeCompare(b.partNum);
            });
            
            if (countEl) countEl.textContent = entries.length + ' ' + t('drawing.drawings').toLowerCase();
            
            if (entries.length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;"><p style="font-size: 16px;">ðŸ“ ' + t('drawing.noResults') + '</p></div>';
                return;
            }
            
            var html = '';
            entries.forEach(function(entry) {
                var typeColor = entry.type === 'Tire' ? '#3182ce' : entry.type === 'Hub' ? '#38b2ac' : '#ed8936';
                var typeBadge = '<span style="background:' + typeColor + '; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">' + entry.type + '</span>';
                
                html += '<div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.borderColor=\'#ed8936\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
                html += '<div style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">';
                html += '<strong style="font-size: 14px; color: var(--text-primary);">' + entry.partNum + '</strong>';
                html += typeBadge;
                html += '</div>';
                html += '<div style="display: flex; gap: 8px; padding: 12px;">';
                
                if (entry.drawing1) {
                    var thumb1 = getDriveThumbUrl(entry.drawing1, 400);
                    var full1 = getDriveThumbUrl(entry.drawing1, 1200);
                    if (thumb1) {
                        html += '<div style="flex: 1; cursor: pointer; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);" onclick="openImageModal(\'' + full1 + '\')">';
                        html += '<img src="' + thumb1 + '" style="width:100%; height: 100px; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                        html += '<div style="padding: 4px; text-align: center; font-size: 10px; color: var(--text-secondary); background: rgba(237,137,54,0.1);">Drawing 1</div>';
                        html += '</div>';
                    }
                }
                
                if (entry.drawing2) {
                    var thumb2 = getDriveThumbUrl(entry.drawing2, 400);
                    var full2 = getDriveThumbUrl(entry.drawing2, 1200);
                    if (thumb2) {
                        html += '<div style="flex: 1; cursor: pointer; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);" onclick="openImageModal(\'' + full2 + '\')">';
                        html += '<img src="' + thumb2 + '" style="width:100%; height: 100px; object-fit: cover; display: block;" loading="lazy" onerror="this.parentElement.style.display=\'none\'">';
                        html += '<div style="padding: 4px; text-align: center; font-size: 10px; color: var(--text-secondary); background: rgba(237,137,54,0.1);">Drawing 2</div>';
                        html += '</div>';
                    }
                }
                
                html += '</div></div>';
            });
            
            grid.innerHTML = html;
        }
        
        function sortOrdersStagedTable(field) {
            if (ordersStagedSort.field === field) ordersStagedSort.asc = !ordersStagedSort.asc;
            else { ordersStagedSort.field = field; ordersStagedSort.asc = true; }
            updateOrdersStagedPage();
        }
        
        function filterOrdersStagedTable() { updateOrdersStagedPage(); }
        
        function exportOrdersStagedToCSV() {
            const data = allData.filter(r => ordersStagedFilters.categories[getCategory(r)] && getStatus(r) === 'staged');
            const headers = ['Line','IF #','PO #','Customer','Part','Qty','Packaging','Revenue','Due Date','Days Until','Weight (lbs)','Dimensions','Assigned','Pallets'];
            const rows = data.map(r => {
                const line = getVal(r,'LINE');
                const pallets = getPalletDataForOrder(line);
                const totalWeight = pallets.length > 0 ? pallets.reduce((s, p) => s + parseNumber(p.weight), 0) : '';
                const dimensions = pallets.length > 0 && pallets[0].dimensions ? pallets[0].dimensions : '';
                return [line,getVal(r,'IF_NUM'),getVal(r,'PO_NUM'),getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),getVal(r,'PACKAGING'),r[COL.REVENUE],r[COL.REQUESTED_DATE],getVal(r,'DAYS_UNTIL'),totalWeight,dimensions,getVal(r,'ASSIGNED'),pallets.length].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',');
            });
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_staged.csv');
        }

        // ============================================================
        // ORDERS SHIPPED PAGE (History with date filter)
        // ============================================================
        function toggleOrdersShippedCategory(cat) {
            ordersShippedFilters.categories[cat] = !ordersShippedFilters.categories[cat];
            if (!ordersShippedFilters.categories.rolltech && !ordersShippedFilters.categories.molding && !ordersShippedFilters.categories.snappad) { ordersShippedFilters.categories[cat] = true; return; }
            document.getElementById('ordersShippedBtnRollTech').classList.toggle('active', ordersShippedFilters.categories.rolltech);
            document.getElementById('ordersShippedBtnMolding').classList.toggle('active', ordersShippedFilters.categories.molding);
            document.getElementById('ordersShippedBtnSnapPad').classList.toggle('active', ordersShippedFilters.categories.snappad);
            updateOrdersShippedPage();
        }
        
        function applyShippedDateFilter() {
            const fromInput = document.getElementById('ordersShippedFromDate').value;
            const toInput = document.getElementById('ordersShippedToDate').value;
            ordersShippedFilters.fromDate = fromInput ? new Date(fromInput) : null;
            ordersShippedFilters.toDate = toInput ? new Date(toInput) : null;
            updateOrdersShippedPage();
        }
        
        function resetShippedDateFilter() {
            document.getElementById('ordersShippedFromDate').value = '';
            document.getElementById('ordersShippedToDate').value = '';
            ordersShippedFilters.fromDate = null;
            ordersShippedFilters.toDate = null;
            updateOrdersShippedPage();
        }
        
        async function updateOrdersShippedPage() {
            // Load shipping records data for shipping photos (async)
            if (!shippingRecordsLoaded) {
                await loadShippingRecordsData();
            }
            
            const data = allData.filter(r => {
                const cat = getCategory(r);
                const status = getStatus(r);
                if (!ordersShippedFilters.categories[cat] || status !== 'shipped') return false;
                
                if (ordersShippedFilters.fromDate || ordersShippedFilters.toDate) {
                    const dateStr = r[COL.SHIPPED_DATE];
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (ordersShippedFilters.fromDate && rowDate < ordersShippedFilters.fromDate) return false;
                    if (ordersShippedFilters.toDate && rowDate > ordersShippedFilters.toDate) return false;
                }
                return true;
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRevenue = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100).toFixed(1) : 0;
            const customers = new Set(data.map(r => getVal(r, 'CUSTOMER'))).size;
            
            document.getElementById('ordersShippedTotalOrders').textContent = formatNumber(data.length);
            document.getElementById('ordersShippedTotalUnits').textContent = `${formatNumber(totalQty)} ${t('ui.units')}`;
            document.getElementById('ordersShippedRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('ordersShippedPL').textContent = formatCurrency(totalPL);
            document.getElementById('ordersShippedPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('ordersShippedMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('ordersShippedCustomers').textContent = formatNumber(customers);
            
            renderOrdersShippedTableHeader();
            renderOrdersShippedTable(data);
        }
        
        function renderOrdersShippedTableHeader() {
            initTableFilters('ordersShipped');
            initHiddenColumns('ordersShipped');
            const headers = [
                { key: 'line', label: t('col.line') }, { key: 'ifNum', label: t('col.ifNum') }, { key: 'poNum', label: t('col.poNum') },
                { key: 'shippedDate', label: t('col.shippedDate') },
                { key: 'customer', label: t('col.customer') }, { key: 'part', label: t('col.part') },
                { key: 'qty', label: t('col.qty') }
            ];
            // Only add revenue and P/L columns if sales is unlocked
            if (salesUnlocked) {
                headers.push({ key: 'revenue', label: t('col.revenue') });
                headers.push({ key: 'pl', label: t('col.pl') });
            }
            document.getElementById('ordersShippedTableHeader').innerHTML = headers.map(h => {
                if (isColumnHidden('ordersShipped', h.key)) return '';
                return createFilterHeader('ordersShipped', h.key, h.label, true);
            }).join('');
        }
        
        function renderOrdersShippedTable(data) {
            renderOrdersShippedTableHeader();
            
            // Apply column filters
            let sorted = [...data].filter(r => {
                const pl = getPLValue(r);
                if (!passesColumnFilter('ordersShipped', 'line', getVal(r, 'LINE') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'ifNum', getVal(r, 'IF_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'poNum', getVal(r, 'PO_NUM') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'shippedDate', r[COL.SHIPPED_DATE] || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'customer', getVal(r, 'CUSTOMER') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'part', getVal(r, 'PART') || '-')) return false;
                if (!passesColumnFilter('ordersShipped', 'qty', String(parseNumber(getVal(r, 'QTY')) || '-'))) return false;
                if (salesUnlocked) {
                    if (!passesColumnFilter('ordersShipped', 'revenue', formatCurrency(parseNumber(r[COL.REVENUE])))) return false;
                    if (!passesColumnFilter('ordersShipped', 'pl', formatCurrency(pl))) return false;
                }
                return true;
            });
            
            sorted.sort((a, b) => {
                let va, vb;
                switch(ordersShippedSort.field) {
                    case 'line': va = parseNumber(getVal(a, 'LINE')); vb = parseNumber(getVal(b, 'LINE')); break;
                    case 'ifNum': va = getVal(a, 'IF_NUM') || ''; vb = getVal(b, 'IF_NUM') || ''; break;
                    case 'poNum': va = getVal(a, 'PO_NUM') || ''; vb = getVal(b, 'PO_NUM') || ''; break;
                    case 'shippedDate': va = parseDate(a[COL.SHIPPED_DATE]) || new Date(0); vb = parseDate(b[COL.SHIPPED_DATE]) || new Date(0); break;
                    case 'customer': va = getVal(a, 'CUSTOMER') || ''; vb = getVal(b, 'CUSTOMER') || ''; break;
                    case 'part': va = getVal(a, 'PART') || ''; vb = getVal(b, 'PART') || ''; break;
                    case 'qty': va = parseNumber(getVal(a, 'QTY')); vb = parseNumber(getVal(b, 'QTY')); break;
                    case 'revenue': va = parseNumber(a[COL.REVENUE]); vb = parseNumber(b[COL.REVENUE]); break;
                    case 'pl': va = getPLValue(a); vb = getPLValue(b); break;
                    default: va = a[ordersShippedSort.field] || ''; vb = b[ordersShippedSort.field] || '';
                }
                if (typeof va === 'string') return ordersShippedSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                return ordersShippedSort.asc ? va - vb : vb - va;
            });
            
            const search = (document.getElementById('ordersShippedSearch').value || '').toLowerCase();
            if (search) {
                sorted = sorted.filter(r => (getVal(r, 'CUSTOMER') || '').toLowerCase().includes(search) || (getVal(r, 'PART') || '').toLowerCase().includes(search) || (getVal(r, 'IF_NUM') || '').toLowerCase().includes(search) || (getVal(r, 'PO_NUM') || '').toLowerCase().includes(search));
            }
            
            document.getElementById('ordersShippedTableCount').textContent = `${sorted.length} ${t('ui.orders')}`;
            const tbody = document.getElementById('ordersShippedTableBody');
            tbody.innerHTML = sorted.map(r => {
                const pl = getPLValue(r);
                const line = getVal(r, 'LINE');
                // Add click handler for shipped orders photo drilldown
                const clickHandler = `onclick="showPalletPictures('${line}', this)" style="cursor:pointer;"`;
                
                let cells = '';
                if (!isColumnHidden('ordersShipped', 'line')) cells += `<td><strong>${line || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'ifNum')) cells += `<td>${getVal(r, 'IF_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'poNum')) cells += `<td>${getVal(r, 'PO_NUM') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'shippedDate')) cells += `<td>${r[COL.SHIPPED_DATE] || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'customer')) cells += `<td>${getVal(r, 'CUSTOMER') || '-'}</td>`;
                if (!isColumnHidden('ordersShipped', 'part')) cells += `<td><strong>${getVal(r, 'PART') || '-'}</strong></td>`;
                if (!isColumnHidden('ordersShipped', 'qty')) cells += `<td>${formatNumber(parseNumber(getVal(r, 'QTY')))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'revenue')) cells += `<td class="positive">${formatCurrency(parseNumber(r[COL.REVENUE]))}</td>`;
                if (salesUnlocked && !isColumnHidden('ordersShipped', 'pl')) cells += `<td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>`;
                
                return `<tr class="clickable-row" ${clickHandler}>${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('ordersShipped');
            updateShowHiddenButton('ordersShipped');
        }
        
        function sortOrdersShippedTable(field) {
            if (ordersShippedSort.field === field) ordersShippedSort.asc = !ordersShippedSort.asc;
            else { ordersShippedSort.field = field; ordersShippedSort.asc = true; }
            updateOrdersShippedPage();
        }
        
        function filterOrdersShippedTable() { updateOrdersShippedPage(); }
        
        function exportOrdersShippedToCSV() {
            const data = allData.filter(r => ordersShippedFilters.categories[getCategory(r)] && getStatus(r) === 'shipped');
            const headers = ['Line','IF #','PO #','Shipped Date','Customer','Part','Qty','Revenue','P/L'];
            const rows = data.map(r => [getVal(r,'LINE'),getVal(r,'IF_NUM'),getVal(r,'PO_NUM'),r[COL.SHIPPED_DATE],getVal(r,'CUSTOMER'),getVal(r,'PART'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
            downloadCSV([headers.join(','),...rows].join('\n'), 'orders_shipped.csv');
        }

        // ============================================================
        // UTILITY FUNCTION
        // ============================================================
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ============================================================
        // INVENTORY PAGE
        // ============================================================
        function setInvFilter(filter) {
            invFilter = filter;
            document.getElementById('invFilterAll').classList.toggle('active', filter === 'all');
            document.getElementById('invFilterLow').classList.toggle('active', filter === 'low');
            document.getElementById('invFilterNeeded').classList.toggle('active', filter === 'needed');
            renderInvTable();
        }
        
        function updateInventoryPage() {
            const lowStock = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            const needsProduction = inventoryData.filter(i => i.partsToBeMade > 0);
            const okStock = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
            const productTypes = [...new Set(inventoryData.map(i => i.product).filter(p => p))];
            
            document.getElementById('invStatTotal').textContent = formatNumber(inventoryData.length);
            document.getElementById('invStatTypes').textContent = `${productTypes.length} ${t('ui.productTypes')}`;
            document.getElementById('invStatLow').textContent = formatNumber(lowStock.length);
            document.getElementById('invStatNeeded').textContent = formatNumber(needsProduction.length);
            document.getElementById('invStatOk').textContent = formatNumber(okStock.length);
            
            setInvFilter('all');
        }
        
        function sortInvTable(field) {
            if (invSort.field === field) invSort.asc = !invSort.asc;
            else { invSort.field = field; invSort.asc = true; }
            renderInvTable();
        }
        
        function renderInvTableHeader() {
            initHiddenColumns('inventory');
            const cols = [
                { key: 'product', label: 'Product Type' },
                { key: 'partNumber', label: 'Part Number' },
                { key: 'fusionQty', label: 'Fusion Qty' },
                { key: 'minimum', label: 'Minimum' },
                { key: 'manualTarget', label: 'Manual Target' },
                { key: 'qtyNeeded', label: 'Qty Needed' },
                { key: 'partsToBeMade', label: 'Parts to Make' },
                { key: 'moldType', label: 'Mold Type' },
                { key: 'status', label: 'Status' }
            ];
            document.getElementById('invTableHeader').innerHTML = cols.map(col => {
                if (isColumnHidden('inventory', col.key)) return '';
                return createFilterHeader('inventory', col.key, col.label);
            }).join('');
        }
        
        function renderInvTable() {
            renderInvTableHeader();
            let data = [...inventoryData];
            const searchTerm = (document.getElementById('invSearch')?.value || '').toLowerCase();
            
            if (invFilter === 'low') data = data.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
            else if (invFilter === 'needed') data = data.filter(i => i.partsToBeMade > 0);
            
            if (searchTerm) {
                data = data.filter(i => (i.partNumber || '').toLowerCase().includes(searchTerm) || (i.product || '').toLowerCase().includes(searchTerm) || (i.moldType || '').toLowerCase().includes(searchTerm));
            }
            
            // Apply column filters
            data = data.filter(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const status = isLow ? 'LOW' : (needsMake ? 'MAKE' : 'OK');
                
                if (!passesColumnFilter('inventory', 'product', i.product || '-')) return false;
                if (!passesColumnFilter('inventory', 'partNumber', i.partNumber)) return false;
                if (!passesColumnFilter('inventory', 'fusionQty', String(i.fusionQty))) return false;
                if (!passesColumnFilter('inventory', 'minimum', String(i.minimum))) return false;
                if (!passesColumnFilter('inventory', 'manualTarget', String(i.manualTarget))) return false;
                if (!passesColumnFilter('inventory', 'qtyNeeded', String(i.qtyNeeded))) return false;
                if (!passesColumnFilter('inventory', 'partsToBeMade', String(i.partsToBeMade))) return false;
                if (!passesColumnFilter('inventory', 'moldType', i.moldType || '-')) return false;
                if (!passesColumnFilter('inventory', 'status', status)) return false;
                return true;
            });
            
            data.sort((a, b) => {
                let va = a[invSort.field], vb = b[invSort.field];
                if (typeof va === 'string') return invSort.asc ? (va || '').localeCompare(vb || '') : (vb || '').localeCompare(va || '');
                return invSort.asc ? (va || 0) - (vb || 0) : (vb || 0) - (va || 0);
            });
            
            document.getElementById('invTableCount').textContent = `${data.length} ${t('ui.items')}`;
            const tbody = document.getElementById('invTableBody');
            tbody.innerHTML = data.map(i => {
                const isLow = i.fusionQty < i.minimum && i.minimum > 0;
                const needsMake = i.partsToBeMade > 0;
                const rowClass = isLow ? 'inv-low clickable-row' : (needsMake ? 'inv-warning clickable-row' : 'clickable-row');
                const statusBadge = isLow ? `<span class="badge" style="background:var(--danger);color:white;">${t('status.low')}</span>` : (needsMake ? `<span class="badge" style="background:var(--warning);color:#1a202c;">${t('status.make')}</span>` : `<span class="badge" style="background:var(--success);color:white;">${t('status.ok')}</span>`);
                const escapedPart = (i.partNumber || '').replace(/'/g, "\\'");
                
                // Build row with hidden column support
                let cells = '';
                if (!isColumnHidden('inventory', 'product')) cells += `<td>${i.product || '-'}</td>`;
                if (!isColumnHidden('inventory', 'partNumber')) cells += `<td><strong>${i.partNumber}</strong><button class="inv-history-btn" onclick="event.stopPropagation(); openInventoryHistoryModal('${escapedPart}')">ðŸ“ˆ</button></td>`;
                if (!isColumnHidden('inventory', 'fusionQty')) cells += `<td>${formatNumber(i.fusionQty)}</td>`;
                if (!isColumnHidden('inventory', 'minimum')) cells += `<td>${formatNumber(i.minimum)}</td>`;
                if (!isColumnHidden('inventory', 'manualTarget')) cells += `<td>${formatNumber(i.manualTarget)}</td>`;
                if (!isColumnHidden('inventory', 'qtyNeeded')) cells += `<td>${formatNumber(i.qtyNeeded)}</td>`;
                if (!isColumnHidden('inventory', 'partsToBeMade')) cells += `<td class="${i.partsToBeMade > 0 ? 'negative' : ''}">${formatNumber(i.partsToBeMade)}</td>`;
                if (!isColumnHidden('inventory', 'moldType')) cells += `<td>${i.moldType || '-'}</td>`;
                if (!isColumnHidden('inventory', 'status')) cells += `<td>${statusBadge}</td>`;
                
                return `<tr class="${rowClass}" onclick="openInventoryHistoryModal('${escapedPart}')" title="${t('inv.clickHistory')}">${cells}</tr>`;
            }).join('');
            
            updateClearAllButton('inventory');
            updateShowHiddenButton('inventory');
        }
        
        function filterInvTable() { renderInvTable(); }
        function exportInvCSV() { downloadCSV('Product Type,Part Number,...', 'inventory.csv'); }
        
        // ============================================================
        // INVENTORY HISTORY MODAL
        // ============================================================
        async function openInventoryHistoryModal(partNumber) {
            currentHistoryPart = partNumber;
            const modal = document.getElementById('inventoryHistoryModal');
            const loading = document.getElementById('historyLoading');
            const noData = document.getElementById('historyNoData');
            const chartContainer = document.querySelector('.history-chart-container');
            const statsPanel = document.getElementById('historyStatsPanel');
            const controls = document.querySelector('.history-controls');
            
            // Show modal with loading state
            modal.classList.add('active');
            document.getElementById('historyPartName').textContent = partNumber;
            loading.style.display = 'block';
            noData.style.display = 'none';
            chartContainer.style.display = 'none';
            statsPanel.style.display = 'none';
            controls.style.display = 'none';
            
            // Ensure history data is loaded
            await loadInventoryHistoryData();
            
            // Find data for this part
            const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
            
            loading.style.display = 'none';
            
            if (!partData || Object.keys(partData.dataByDate).length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            // Show chart and controls
            chartContainer.style.display = 'block';
            statsPanel.style.display = 'grid';
            controls.style.display = 'flex';
            
            // Reset date range to all data
            historyDateRange = { start: null, end: null };
            document.getElementById('historyStartDate').value = '';
            document.getElementById('historyEndDate').value = '';
            
            // Render chart
            renderInventoryHistoryChart();
        }
        
        function closeInventoryHistoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('inventoryHistoryModal').classList.remove('active');
            currentHistoryPart = null;
            
            // Destroy chart if exists
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
                charts.inventoryHistory = null;
            }
        }
        
        function renderInventoryHistoryChart() {
            if (!currentHistoryPart) return;
            
            const partData = inventoryHistoryData.find(p => p.partNumber === currentHistoryPart);
            if (!partData) return;
            
            // Get minimum threshold for this part
            const minimum = getPartMinimum(currentHistoryPart);
            
            // Get filtered dates based on range
            let dates = [...inventoryHistoryDates];
            if (historyDateRange.start || historyDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyDateRange.start && date < historyDateRange.start) return false;
                    if (historyDateRange.end && date > historyDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Build data points
            const dataPoints = [];
            const labels = [];
            dates.forEach(dateStr => {
                const qty = partData.dataByDate[dateStr];
                if (qty !== undefined) {
                    dataPoints.push(qty);
                    // Format label as "Jan 12"
                    const parts = dateStr.split('/');
                    const date = new Date(parts[2], parts[0] - 1, parts[1]);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    labels.push(`${monthNames[date.getMonth()]} ${date.getDate()}`);
                }
            });
            
            if (dataPoints.length === 0) {
                document.getElementById('historyNoData').style.display = 'block';
                document.querySelector('.history-chart-container').style.display = 'none';
                document.getElementById('historyStatsPanel').style.display = 'none';
                return;
            }
            
            // Calculate stats
            const current = dataPoints[dataPoints.length - 1] || 0;
            const minVal = Math.min(...dataPoints);
            const maxVal = Math.max(...dataPoints);
            const avg = Math.round(dataPoints.reduce((a, b) => a + b, 0) / dataPoints.length);
            const belowMin = minimum > 0 && current < minimum;
            
            document.getElementById('historyStatCurrent').textContent = formatNumber(current);
            document.getElementById('historyStatCurrent').style.color = belowMin ? 'var(--danger)' : 'var(--accent)';
            document.getElementById('historyStatMin').textContent = formatNumber(minimum);  // Show threshold, not historical low
            document.getElementById('historyStatMin').style.color = minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)';
            document.getElementById('historyStatMax').textContent = formatNumber(maxVal);
            document.getElementById('historyStatAvg').textContent = formatNumber(avg);
            
            // Destroy existing chart
            if (charts.inventoryHistory) {
                charts.inventoryHistory.destroy();
            }
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryChart').getContext('2d');
            
            // Handle flat line case
            let suggestedMin = minVal * 0.9;
            let suggestedMax = maxVal * 1.1;
            if (maxVal - minVal < 1) {
                suggestedMin = minVal - Math.max(1, minVal * 0.1);
                suggestedMax = maxVal + Math.max(1, maxVal * 0.1);
            }
            
            // Dataset with segment coloring for below minimum
            const dataset = {
                label: currentHistoryPart,
                data: dataPoints,
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                fill: true,
                tension: 0.2,
                pointRadius: dataPoints.length < 30 ? 4 : 2,
                pointHoverRadius: 6
            };
            
            // Add segment coloring if minimum is set
            if (minimum > 0) {
                dataset.segment = {
                    borderColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? '#e53e3e' : '#3182ce';
                    },
                    backgroundColor: ctx => {
                        const yVal = ctx.p1.parsed.y;
                        return yVal < minimum ? 'rgba(229, 62, 62, 0.1)' : 'rgba(49, 130, 206, 0.1)';
                    }
                };
                dataset.pointBackgroundColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
                dataset.pointBorderColor = ctx => {
                    const yVal = ctx.raw;
                    return yVal < minimum ? '#e53e3e' : '#3182ce';
                };
            }
            
            charts.inventoryHistory = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [dataset]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    let label = `${t('ui.qty')}: ${formatNumber(ctx.raw)}`;
                                    if (minimum > 0 && ctx.raw < minimum) {
                                        label += ` (${t('status.low')})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            suggestedMin: suggestedMin,
                            suggestedMax: suggestedMax
                        }
                    }
                }
            });
        }
        
        function updateHistoryChart() {
            const startVal = document.getElementById('historyStartDate').value;
            const endVal = document.getElementById('historyEndDate').value;
            
            historyDateRange.start = startVal ? new Date(startVal) : null;
            historyDateRange.end = endVal ? new Date(endVal) : null;
            
            renderInventoryHistoryChart();
        }
        
        function applyHistoryPreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7':
                    start = new Date(now);
                    start.setDate(start.getDate() - 7);
                    break;
                case 'last30':
                    start = new Date(now);
                    start.setDate(start.getDate() - 30);
                    break;
                case 'last90':
                    start = new Date(now);
                    start.setDate(start.getDate() - 90);
                    break;
                case 'all':
                default:
                    start = null;
                    break;
            }
            
            historyDateRange.start = start;
            historyDateRange.end = null;
            
            // Update input fields
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyStartDate').value = '';
            }
            document.getElementById('historyEndDate').value = '';
            
            renderInventoryHistoryChart();
        }

        // ============================================================
        // INVENTORY HISTORY PAGE (Multi-Part Comparison)
        // ============================================================
        async function updateInventoryHistoryPage() {
            // Ensure data is loaded
            await loadInventoryHistoryData();
            
            // Render parts list
            renderHistoryPartsList();
            
            // Render chart (will show "select parts" message if none selected)
            renderHistoryPageChart();
        }
        
        function renderHistoryPartsList() {
            const container = document.getElementById('historyPartsList');
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            
            // Get all unique parts from inventory data (which has minimum info) or history data
            let parts = [];
            if (inventoryData.length > 0) {
                parts = inventoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: item.product || '',
                    minimum: item.minimum || 0
                }));
            } else if (inventoryHistoryData.length > 0) {
                parts = inventoryHistoryData.map(item => ({
                    partNumber: item.partNumber,
                    product: '',
                    minimum: 0
                }));
            }
            
            // Filter by search term
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    p.product.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort alphabetically
            parts.sort((a, b) => a.partNumber.localeCompare(b.partNumber));
            
            container.innerHTML = parts.map((part, idx) => {
                const isSelected = selectedHistoryParts.has(part.partNumber);
                const colorIdx = Array.from(selectedHistoryParts).indexOf(part.partNumber);
                const color = colorIdx >= 0 ? historyPartColors[colorIdx % historyPartColors.length] : '#4a5568';
                
                return `<div class="history-part-item ${isSelected ? 'selected' : ''}" onclick="toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleHistoryPart('${part.partNumber.replace(/'/g, "\\'")}')">
                    <div class="part-info">
                        <div class="part-number">${part.partNumber}</div>
                        <div class="part-type">${part.product || '-'}</div>
                    </div>
                    ${isSelected ? `<div class="part-color" style="background:${color}"></div>` : ''}
                </div>`;
            }).join('');
            
            // Update selected count
            document.getElementById('historySelectedCount').innerHTML = 
                `${selectedHistoryParts.size} <span data-i18n="inv.selected">${t('inv.selected')}</span>`;
        }
        
        function toggleHistoryPart(partNumber) {
            if (selectedHistoryParts.has(partNumber)) {
                selectedHistoryParts.delete(partNumber);
            } else {
                if (selectedHistoryParts.size >= 10) {
                    alert(t('inv.maxPartsWarning') || 'Maximum 10 parts can be compared at once');
                    return;
                }
                selectedHistoryParts.add(partNumber);
            }
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function selectAllHistoryParts() {
            const searchTerm = (document.getElementById('historyPartsSearch')?.value || '').toLowerCase();
            let parts = inventoryData.length > 0 ? inventoryData : inventoryHistoryData;
            
            if (searchTerm) {
                parts = parts.filter(p => 
                    p.partNumber.toLowerCase().includes(searchTerm) ||
                    (p.product || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Limit to 10
            const toAdd = parts.slice(0, 10);
            selectedHistoryParts.clear();
            toAdd.forEach(p => selectedHistoryParts.add(p.partNumber));
            
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function deselectAllHistoryParts() {
            selectedHistoryParts.clear();
            renderHistoryPartsList();
            renderHistoryPageChart();
        }
        
        function filterHistoryPartsList() {
            renderHistoryPartsList();
        }
        
        function getPartMinimum(partNumber) {
            const invItem = inventoryData.find(i => i.partNumber === partNumber);
            return invItem ? invItem.minimum : 0;
        }
        
        function renderHistoryPageChart() {
            const chartContainer = document.getElementById('historyPageChartContainer');
            const noSelection = document.getElementById('historyPageNoSelection');
            const legend = document.getElementById('historyPageLegend');
            const statsContainer = document.getElementById('historyPageStats');
            
            // Destroy existing chart
            if (charts.inventoryHistoryPage) {
                charts.inventoryHistoryPage.destroy();
                charts.inventoryHistoryPage = null;
            }
            
            if (selectedHistoryParts.size === 0) {
                noSelection.style.display = 'block';
                legend.innerHTML = '';
                statsContainer.innerHTML = '';
                return;
            }
            
            noSelection.style.display = 'none';
            
            // Get filtered dates
            let dates = [...inventoryHistoryDates];
            if (historyPageDateRange.start || historyPageDateRange.end) {
                dates = dates.filter(dateStr => {
                    const dateParts = dateStr.split('/');
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (historyPageDateRange.start && date < historyPageDateRange.start) return false;
                    if (historyPageDateRange.end && date > historyPageDateRange.end) return false;
                    return true;
                });
            }
            
            // Sort dates chronologically
            dates.sort((a, b) => {
                const aParts = a.split('/'), bParts = b.split('/');
                const aDate = new Date(aParts[2], aParts[0] - 1, aParts[1]);
                const bDate = new Date(bParts[2], bParts[0] - 1, bParts[1]);
                return aDate - bDate;
            });
            
            // Format labels
            const labels = dates.map(dateStr => {
                const parts = dateStr.split('/');
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[date.getMonth()]} ${date.getDate()}`;
            });
            
            // Build datasets
            const datasets = [];
            const partsArray = Array.from(selectedHistoryParts);
            let legendHtml = '';
            let statsHtml = '';
            
            partsArray.forEach((partNumber, idx) => {
                const partData = inventoryHistoryData.find(p => p.partNumber === partNumber);
                if (!partData) return;
                
                const color = historyPartColors[idx % historyPartColors.length];
                const minimum = getPartMinimum(partNumber);
                
                // Build data points
                const dataPoints = dates.map(dateStr => partData.dataByDate[dateStr] ?? null);
                
                // Calculate stats
                const validPoints = dataPoints.filter(v => v !== null);
                const current = validPoints.length > 0 ? validPoints[validPoints.length - 1] : 0;
                const min = validPoints.length > 0 ? Math.min(...validPoints) : 0;
                const max = validPoints.length > 0 ? Math.max(...validPoints) : 0;
                const avg = validPoints.length > 0 ? Math.round(validPoints.reduce((a, b) => a + b, 0) / validPoints.length) : 0;
                const belowMin = minimum > 0 && current < minimum;
                
                // Create dataset with segment coloring for below minimum
                datasets.push({
                    label: partNumber,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    tension: 0.2,
                    pointRadius: dates.length < 50 ? 3 : 1,
                    pointHoverRadius: 5,
                    minimum: minimum, // Store for segment callback
                    segment: {
                        borderColor: ctx => {
                            const yVal = ctx.p1.parsed.y;
                            return (minimum > 0 && yVal < minimum) ? '#e53e3e' : color;
                        }
                    }
                });
                
                // Legend
                legendHtml += `<div class="history-legend-item">
                    <div class="history-legend-color" style="background:${color}"></div>
                    <span>${partNumber}</span>
                    ${minimum > 0 ? `<span class="history-legend-below">(min: ${formatNumber(minimum)})</span>` : ''}
                </div>`;
                
                // Stats card
                statsHtml += `<div class="history-part-stat-card">
                    <div class="history-part-stat-header">
                        <div class="history-part-stat-color" style="background:${color}"></div>
                        <div class="history-part-stat-name">${partNumber}</div>
                    </div>
                    <div class="history-part-stat-values">
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value ${belowMin ? 'below-min' : ''}">${formatNumber(current)}</div>
                            <div class="history-part-stat-label">${t('inv.current')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value" style="color: ${minimum > 0 ? 'var(--warning)' : 'var(--text-secondary)'}">${formatNumber(minimum)}</div>
                            <div class="history-part-stat-label">${t('inv.minimum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(max)}</div>
                            <div class="history-part-stat-label">${t('inv.maximum')}</div>
                        </div>
                        <div class="history-part-stat-item">
                            <div class="history-part-stat-value">${formatNumber(avg)}</div>
                            <div class="history-part-stat-label">${t('inv.average')}</div>
                        </div>
                    </div>
                </div>`;
            });
            
            legend.innerHTML = legendHtml;
            statsContainer.innerHTML = statsHtml;
            
            // Create chart
            const ctx = document.getElementById('inventoryHistoryPageChart').getContext('2d');
            charts.inventoryHistoryPage = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${formatNumber(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                maxRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#a0aec0',
                                callback: val => formatNumber(val)
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function updateHistoryPageChart() {
            const startVal = document.getElementById('historyPageStartDate').value;
            const endVal = document.getElementById('historyPageEndDate').value;
            
            historyPageDateRange.start = startVal ? new Date(startVal) : null;
            historyPageDateRange.end = endVal ? new Date(endVal) : null;
            
            renderHistoryPageChart();
        }
        
        function applyHistoryPagePreset(preset) {
            const now = new Date();
            let start = null;
            
            switch (preset) {
                case 'last7': start = new Date(now); start.setDate(start.getDate() - 7); break;
                case 'last30': start = new Date(now); start.setDate(start.getDate() - 30); break;
                case 'last90': start = new Date(now); start.setDate(start.getDate() - 90); break;
                case 'all': default: start = null; break;
            }
            
            historyPageDateRange.start = start;
            historyPageDateRange.end = null;
            
            if (start) {
                const y = start.getFullYear();
                const m = String(start.getMonth() + 1).padStart(2, '0');
                const d = String(start.getDate()).padStart(2, '0');
                document.getElementById('historyPageStartDate').value = `${y}-${m}-${d}`;
            } else {
                document.getElementById('historyPageStartDate').value = '';
            }
            document.getElementById('historyPageEndDate').value = '';
            
            renderHistoryPageChart();
        }

        // ============================================================
        // SALES OVERVIEW PAGE (Enhanced)
        // ============================================================
        function toggleSalesCategory(cat) {
            salesFilters.categories[cat] = !salesFilters.categories[cat];
            if (!salesFilters.categories.rolltech && !salesFilters.categories.molding && !salesFilters.categories.snappad) { salesFilters.categories[cat] = true; return; }
            document.getElementById('salesBtnRollTech').classList.toggle('active', salesFilters.categories.rolltech);
            document.getElementById('salesBtnMolding').classList.toggle('active', salesFilters.categories.molding);
            document.getElementById('salesBtnSnapPad').classList.toggle('active', salesFilters.categories.snappad);
            updateSalesOverview();
        }
        
        function applySalesDateFilter() {
            const fromInput = document.getElementById('salesFromDate').value;
            const toInput = document.getElementById('salesToDate').value;
            salesFilters.fromDate = fromInput ? new Date(fromInput) : null;
            salesFilters.toDate = toInput ? new Date(toInput) : null;
            updateSalesOverview();
        }
        
        function resetSalesDateFilter() {
            document.getElementById('salesFromDate').value = '';
            document.getElementById('salesToDate').value = '';
            salesFilters.fromDate = null;
            salesFilters.toDate = null;
            updateSalesOverview();
        }
        
        function toggleSalesHeatMap() {
            salesHeatMapEnabled = !salesHeatMapEnabled;
            document.getElementById('salesHeatMapBtn').classList.toggle('active', salesHeatMapEnabled);
            updateSalesOverview();
        }
        
        function toggleSalesAutoRefresh() {
            if (salesAutoRefreshInterval) {
                clearInterval(salesAutoRefreshInterval);
                salesAutoRefreshInterval = null;
                document.getElementById('salesAutoRefreshBtn').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').classList.remove('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span>Auto-refresh: Off</span>';
            } else {
                salesAutoRefreshInterval = setInterval(() => { loadDashboard(); }, 300000); // 5 minutes
                document.getElementById('salesAutoRefreshBtn').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').classList.add('active');
                document.getElementById('salesAutoRefreshIndicator').innerHTML = '<span class="pulse"></span><span>Auto-refresh: On (5 min)</span>';
            }
        }
        
        function getFilteredSalesData() {
            return allData.filter(r => {
                if (!salesFilters.categories[getCategory(r)]) return false;
                if (salesFilters.fromDate || salesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (salesFilters.fromDate && rowDate < salesFilters.fromDate) return false;
                    if (salesFilters.toDate && rowDate > salesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesOverview() {
            const data = getFilteredSalesData();
            let totalRevenue = 0, totalPL = 0, shippedPL = 0, forecastPL = 0, shippedCount = 0, forecastCount = 0;
            
            data.forEach(r => {
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    totalPL += pl;
                    if (getStatus(r) === 'shipped') { shippedPL += pl; shippedCount++; }
                    else { forecastPL += pl; forecastCount++; }
                } else {
                    if (getStatus(r) === 'shipped') shippedCount++; else forecastCount++;
                }
            });
            
            const margin = totalRevenue ? ((totalPL / totalRevenue) * 100).toFixed(2) : 0;
            
            document.getElementById('salesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('salesStatOrderCount').textContent = `${data.length} ${t('ui.orders')}`;
            document.getElementById('salesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('salesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatMargin').textContent = `${t('stats.margin')}: ${margin}%`;
            document.getElementById('salesStatShippedPL').textContent = formatCurrency(shippedPL);
            document.getElementById('salesStatShippedPL').className = `value ${shippedPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatShippedCount').textContent = `${shippedCount} ${t('stats.shipped')}`;
            document.getElementById('salesStatForecastPL').textContent = formatCurrency(forecastPL);
            document.getElementById('salesStatForecastPL').className = `value ${forecastPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('salesStatForecastCount').textContent = `${forecastCount} ${t('stats.pending')}`;
            
            // Render the Monthly P/L Trend chart
            renderSalesTrendChart(data);
        }
        
        function renderSalesLossesChart(data) {
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { pl: 0 };
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            // Get top 5 losses and top 5 gains
            const sorted = Object.entries(partStats).sort((a,b) => a[1].pl - b[1].pl);
            const topLosses = sorted.slice(0, 5).filter(([_,v]) => v.pl < 0);
            const topGains = sorted.slice(-5).reverse().filter(([_,v]) => v.pl > 0);
            const combined = [...topLosses, ...topGains.reverse()];
            
            if (charts.salesLosses) charts.salesLosses.destroy();
            charts.salesLosses = new Chart(document.getElementById('salesLossesChart'), {
                type: 'bar',
                data: {
                    labels: combined.map(s => s[0]),
                    datasets: [{
                        data: combined.map(s => s[1].pl),
                        backgroundColor: combined.map(s => s[1].pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)')
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function renderSalesCustomerPieChart(data) {
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { pl: 0 };
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const sorted = Object.entries(custStats).filter(([_,v]) => v.pl > 0).sort((a,b) => b[1].pl - a[1].pl).slice(0, 8);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#718096'];
            
            if (charts.salesCustomerPie) charts.salesCustomerPie.destroy();
            charts.salesCustomerPie = new Chart(document.getElementById('salesCustomerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0].substring(0, 20)),
                    datasets: [{ data: sorted.map(s => s[1].pl), backgroundColor: colors }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
        }
        
        function renderSalesTrendChart(data) {
            const monthStats = {};
            data.forEach(r => {
                const d = getAttributionDate(r);
                if (!d) return;
                const month = getMonthKey(d);
                if (!monthStats[month]) monthStats[month] = { shipped: 0, forecast: 0, revenue: 0 };
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (getStatus(r) === 'shipped') monthStats[month].shipped += pl;
                    else monthStats[month].forecast += pl;
                }
            });
            
            const sorted = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0])).slice(-24);
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: sorted.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped P/L', data: sorted.map(s => s[1].shipped), borderColor: '#38a169', backgroundColor: 'rgba(56,161,105,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                        { label: 'Forecast P/L', data: sorted.map(s => s[1].forecast), borderColor: '#d69e2e', backgroundColor: 'rgba(214,158,46,0.1)', fill: true, tension: 0.3, borderDash: [5,5], yAxisID: 'y' },
                        { label: 'Revenue', data: sorted.map(s => s[1].revenue), borderColor: '#3182ce', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { type: 'linear', position: 'left', ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y1: { type: 'linear', position: 'right', ticks: { callback: v => formatCurrency(v), color: '#3182ce' }, grid: { drawOnChartArea: false } },
                        x: { ticks: { color: '#a0aec0', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        function exportSalesCSV() {
            const data = getFilteredSalesData();
            const csv = data.map(r => [getVal(r,'PART'),getVal(r,'CUSTOMER'),getVal(r,'QTY'),r[COL.REVENUE],getPLValue(r)].join(',')).join('\n');
            downloadCSV('Part,Customer,Qty,Revenue,P/L\n' + csv, `sales_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SALES BY PARTS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function togglePartsCategory(cat) {
            partsFilters.categories[cat] = !partsFilters.categories[cat];
            if (!partsFilters.categories.rolltech && !partsFilters.categories.molding && !partsFilters.categories.snappad) { partsFilters.categories[cat] = true; return; }
            document.getElementById('partsBtnRollTech').classList.toggle('active', partsFilters.categories.rolltech);
            document.getElementById('partsBtnMolding').classList.toggle('active', partsFilters.categories.molding);
            document.getElementById('partsBtnSnapPad').classList.toggle('active', partsFilters.categories.snappad);
            updateSalesPartsPage();
        }
        
        function applyPartsDateFilter() {
            partsFilters.fromDate = document.getElementById('partsFromDate').value ? new Date(document.getElementById('partsFromDate').value) : null;
            partsFilters.toDate = document.getElementById('partsToDate').value ? new Date(document.getElementById('partsToDate').value) : null;
            updateSalesPartsPage();
        }
        
        function resetPartsDateFilter() {
            document.getElementById('partsFromDate').value = '';
            document.getElementById('partsToDate').value = '';
            partsFilters.fromDate = null;
            partsFilters.toDate = null;
            updateSalesPartsPage();
        }
        
        function togglePartsWatchlistFilter() {
            partsFilters.watchlistOnly = !partsFilters.watchlistOnly;
            document.getElementById('partsWatchlistBtn').classList.toggle('active', partsFilters.watchlistOnly);
            updateSalesPartsPage();
        }
        
        function getFilteredPartsData() {
            return allData.filter(r => {
                if (!partsFilters.categories[getCategory(r)]) return false;
                if (partsFilters.fromDate || partsFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (partsFilters.fromDate && rowDate < partsFilters.fromDate) return false;
                    if (partsFilters.toDate && rowDate > partsFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesPartsPage() {
            const data = getFilteredPartsData();
            const partStats = {};
            
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            let partsArray = Object.entries(partStats).map(([part, stats]) => ({ part, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            // Filter by watchlist if enabled
            if (partsFilters.watchlistOnly) partsArray = partsArray.filter(p => isInWatchlist('part', p.part));
            
            // Search filter
            const search = (document.getElementById('partsSearch')?.value || '').toLowerCase();
            if (search) partsArray = partsArray.filter(p => p.part.toLowerCase().includes(search));
            
            // Column filters
            partsArray = partsArray.filter(p => {
                if (!passesColumnFilter('parts', 'part', p.part)) return false;
                if (!passesColumnFilter('parts', 'orders', String(p.orders))) return false;
                if (!passesColumnFilter('parts', 'qty', String(p.qty))) return false;
                if (!passesColumnFilter('parts', 'revenue', formatCurrency(p.revenue))) return false;
                if (!passesColumnFilter('parts', 'pl', p.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (p.margin < 0) marginCat = 'Negative';
                else if (p.margin < 10) marginCat = 'Low (0-10%)';
                else if (p.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('parts', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort - handle string vs numeric fields
            partsArray.sort((a, b) => {
                if (partsSort.field === 'part') {
                    return partsSort.asc ? a.part.localeCompare(b.part) : b.part.localeCompare(a.part);
                }
                return partsSort.asc ? a[partsSort.field] - b[partsSort.field] : b[partsSort.field] - a[partsSort.field];
            });
            
            // Render chart
            renderPartsBarChart(partsArray);
            
            // Render table
            document.getElementById('partsTableCount').textContent = `${partsArray.length} ${t('ui.parts')}`;
            document.getElementById('partsTableHeader').innerHTML = `
                <th>â˜…</th>
                ${createFilterHeader('parts', 'part', 'Part #')}
                ${createFilterHeader('parts', 'orders', 'Orders')}
                ${createFilterHeader('parts', 'qty', 'Qty')}
                ${createFilterHeader('parts', 'revenue', 'Revenue')}
                ${createFilterHeader('parts', 'pl', 'P/L')}
                ${createFilterHeader('parts', 'margin', 'Margin')}
            `;
            
            document.getElementById('partsTableBody').innerHTML = partsArray.map(p => `
                <tr class="clickable" onclick="showPartsCustomerDrilldown('${p.part.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('part', p.part) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistPart('${p.part.replace(/'/g, "\\'")}')">â˜…</span></td>
                    <td><strong>${p.part}</strong></td>
                    <td>${formatNumber(p.orders)}</td>
                    <td>${formatNumber(p.qty)}</td>
                    <td>${formatCurrency(p.revenue)}</td>
                    <td class="${p.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(p.pl)}</td>
                    <td class="${p.margin >= 0 ? 'positive' : 'negative'}">${p.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function renderPartsBarChart(partsArray) {
            // Sort all parts from lowest (losses) to highest (gains) P/L
            const sortedParts = [...partsArray].sort((a,b) => a.pl - b.pl);
            if (charts.partsBar) charts.partsBar.destroy();
            charts.partsBar = new Chart(document.getElementById('partsBarChart'), {
                type: 'bar',
                data: {
                    labels: sortedParts.map(p => p.part),
                    datasets: [{ data: sortedParts.map(p => p.pl), backgroundColor: sortedParts.map(p => p.pl >= 0 ? 'rgba(56,161,105,0.8)' : 'rgba(229,62,62,0.8)') }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#a0aec0', font: { size: 9 }, maxRotation: 90 }, grid: { display: false } } } }
            });
        }
        
        function sortPartsTable(field) {
            if (partsSort.field === field) partsSort.asc = !partsSort.asc;
            else { partsSort.field = field; partsSort.asc = field === 'part'; }
            updateSalesPartsPage();
        }
        
        function filterPartsTable() { updateSalesPartsPage(); }
        function exportPartsCSV() { downloadCSV('Part,Orders,Qty,Revenue,P/L,Margin', 'parts_pl.csv'); }
        
        // Parts Drilldown Functions
        let partsCustomerDrilldownData = []; // Store data for re-sorting
        
        function showPartsCustomerDrilldown(part) {
            currentDrilldownPart = part;
            partsCustomerDrilldownSort = { field: 'pl', asc: false }; // Reset sort
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part);
            
            const customerStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!customerStats[c]) customerStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                customerStats[c].orders++;
                customerStats[c].qty += parseNumber(getVal(r, 'QTY'));
                customerStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) customerStats[c].pl += getPLValue(r);
            });
            
            // Convert to array with computed fields
            partsCustomerDrilldownData = Object.entries(customerStats).map(([customer, stats]) => ({
                customer,
                qty: stats.qty,
                unitPrice: stats.qty > 0 ? stats.revenue / stats.qty : 0,
                margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0,
                pl: stats.pl,
                revenue: stats.revenue
            }));
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsCustomerDrilldownPart').textContent = part;
            document.getElementById('partsCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Customers</div><div class="value">${partsCustomerDrilldownData.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            renderPartsCustomerDrilldownTable();
            
            document.getElementById('partsCustomerDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            document.getElementById('partsCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderPartsCustomerDrilldownTable() {
            // Render sortable header
            document.getElementById('partsCustomerDrilldownHeader').innerHTML = `
                <th onclick="sortPartsCustomerDrilldown('customer')">Customer <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('qty')">Qty <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('unitPrice')">Unit Price <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Contribution <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('margin')">Margin <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('pl')">P/L <span class="sort-indicator">â†•</span></th>
                <th onclick="sortPartsCustomerDrilldown('revenue')">Revenue <span class="sort-indicator">â†•</span></th>
            `;
            
            // Sort data
            const sorted = [...partsCustomerDrilldownData].sort((a, b) => {
                if (partsCustomerDrilldownSort.field === 'customer') {
                    return partsCustomerDrilldownSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return partsCustomerDrilldownSort.asc ? a[partsCustomerDrilldownSort.field] - b[partsCustomerDrilldownSort.field] : b[partsCustomerDrilldownSort.field] - a[partsCustomerDrilldownSort.field];
            });
            
            document.getElementById('partsCustomerDrilldownBody').innerHTML = sorted.map(row => {
                return `<tr class="clickable" onclick="showPartsOrdersDrilldown('${currentDrilldownPart.replace(/'/g, "\\'")}', '${row.customer.replace(/'/g, "\\'")}')">
                    <td><strong>${row.customer}</strong></td>
                    <td>${formatNumber(row.qty)}</td>
                    <td>${formatCurrency(row.unitPrice)}</td>
                    <td>${getContributionBadge(row.margin)}</td>
                    <td class="${row.margin >= 0 ? 'positive' : 'negative'}">${row.margin.toFixed(1)}%</td>
                    <td class="${row.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(row.pl)}</td>
                    <td>${formatCurrency(row.revenue)}</td>
                </tr>`;
            }).join('');
        }
        
        function sortPartsCustomerDrilldown(field) {
            if (partsCustomerDrilldownSort.field === field) {
                partsCustomerDrilldownSort.asc = !partsCustomerDrilldownSort.asc;
            } else {
                partsCustomerDrilldownSort.field = field;
                partsCustomerDrilldownSort.asc = field === 'customer'; // Strings default asc, numbers default desc
            }
            renderPartsCustomerDrilldownTable();
        }
        
        function showPartsOrdersDrilldown(part, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredPartsData().filter(r => getVal(r, 'PART') === part && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('partsOrdersBreadcrumbPart').textContent = part;
            document.getElementById('partsOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('partsOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.partsOrdersPrice) charts.partsOrdersPrice.destroy();
            const priceChartEl = document.getElementById('partsOrdersPriceChart');
            console.log('Price History Debug v7.5:', { dataPoints: priceData.length, prices: priceData.slice(0,5).map(d => d.price) });
            if (priceData.length > 1 && priceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                // If all prices are same or very close, create artificial range
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                console.log('Y-Axis Debug v7.5:', { minPrice, maxPrice, allSame, yAxisMin, yAxisMax });
                
                charts.partsOrdersPrice = new Chart(priceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Orders table
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('partsOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('partsOrdersDrilldown').classList.add('active');
            document.getElementById('partsOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closePartsCustomerDrilldown() {
            document.getElementById('partsCustomerDrilldown').classList.remove('active');
            document.getElementById('partsOrdersDrilldown').classList.remove('active');
            currentDrilldownPart = null;
        }
        
        function closePartsOrdersDrilldown() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function backToPartsCustomers() { document.getElementById('partsOrdersDrilldown').classList.remove('active'); }
        function closeAllPartsDrilldowns() { closePartsCustomerDrilldown(); }

        // ============================================================
        // SALES BY CUSTOMERS PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleCustomersCategory(cat) {
            customersFilters.categories[cat] = !customersFilters.categories[cat];
            if (!customersFilters.categories.rolltech && !customersFilters.categories.molding && !customersFilters.categories.snappad) { customersFilters.categories[cat] = true; return; }
            document.getElementById('customersBtnRollTech').classList.toggle('active', customersFilters.categories.rolltech);
            document.getElementById('customersBtnMolding').classList.toggle('active', customersFilters.categories.molding);
            document.getElementById('customersBtnSnapPad').classList.toggle('active', customersFilters.categories.snappad);
            updateSalesCustomersPage();
        }
        
        function applyCustomersDateFilter() {
            customersFilters.fromDate = document.getElementById('customersFromDate').value ? new Date(document.getElementById('customersFromDate').value) : null;
            customersFilters.toDate = document.getElementById('customersToDate').value ? new Date(document.getElementById('customersToDate').value) : null;
            updateSalesCustomersPage();
        }
        
        function resetCustomersDateFilter() {
            document.getElementById('customersFromDate').value = '';
            document.getElementById('customersToDate').value = '';
            customersFilters.fromDate = null;
            customersFilters.toDate = null;
            updateSalesCustomersPage();
        }
        
        function toggleCustomersWatchlistFilter() {
            customersFilters.watchlistOnly = !customersFilters.watchlistOnly;
            document.getElementById('customersWatchlistBtn').classList.toggle('active', customersFilters.watchlistOnly);
            updateSalesCustomersPage();
        }
        
        function getFilteredCustomersData() {
            return allData.filter(r => {
                if (!customersFilters.categories[getCategory(r)]) return false;
                if (customersFilters.fromDate || customersFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (customersFilters.fromDate && rowDate < customersFilters.fromDate) return false;
                    if (customersFilters.toDate && rowDate > customersFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesCustomersPage() {
            const data = getFilteredCustomersData();
            const custStats = {};
            
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            let custArray = Object.entries(custStats).map(([customer, stats]) => ({ customer, ...stats, margin: stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0 }));
            
            if (customersFilters.watchlistOnly) custArray = custArray.filter(c => isInWatchlist('customer', c.customer));
            
            const search = (document.getElementById('customersSearch')?.value || '').toLowerCase();
            if (search) custArray = custArray.filter(c => c.customer.toLowerCase().includes(search));
            
            // Column filters
            custArray = custArray.filter(c => {
                if (!passesColumnFilter('customers', 'customer', c.customer)) return false;
                if (!passesColumnFilter('customers', 'orders', String(c.orders))) return false;
                if (!passesColumnFilter('customers', 'qty', String(c.qty))) return false;
                if (!passesColumnFilter('customers', 'revenue', formatCurrency(c.revenue))) return false;
                if (!passesColumnFilter('customers', 'pl', c.pl >= 0 ? 'Positive' : 'Negative')) return false;
                let marginCat;
                if (c.margin < 0) marginCat = 'Negative';
                else if (c.margin < 10) marginCat = 'Low (0-10%)';
                else if (c.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('customers', 'margin', marginCat)) return false;
                return true;
            });
            
            custArray.sort((a, b) => {
                if (customersSort.field === 'customer') {
                    return customersSort.asc ? a.customer.localeCompare(b.customer) : b.customer.localeCompare(a.customer);
                }
                return customersSort.asc ? a[customersSort.field] - b[customersSort.field] : b[customersSort.field] - a[customersSort.field];
            });
            
            // Chart
            const top10 = [...custArray].sort((a,b) => b.pl - a.pl).slice(0, 10);
            const colors = ['#38a169', '#319795', '#3182ce', '#805ad5', '#d53f8c', '#dd6b20', '#d69e2e', '#e53e3e', '#718096', '#4a5568'];
            if (charts.customers) charts.customers.destroy();
            charts.customers = new Chart(document.getElementById('customersChart'), {
                type: 'doughnut',
                data: { labels: top10.map(c => c.customer.substring(0, 20)), datasets: [{ data: top10.map(c => Math.abs(c.pl)), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a0aec0', font: { size: 10 } } } } }
            });
            
            // Table
            document.getElementById('customersTableCount').textContent = `${custArray.length} ${t('ui.customers')}`;
            document.getElementById('customersTableHeader').innerHTML = `
                <th>â˜…</th>
                ${createFilterHeader('customers', 'customer', 'Customer')}
                ${createFilterHeader('customers', 'orders', 'Orders')}
                ${createFilterHeader('customers', 'qty', 'Qty')}
                ${createFilterHeader('customers', 'revenue', 'Revenue')}
                ${createFilterHeader('customers', 'pl', 'P/L')}
                ${createFilterHeader('customers', 'margin', 'Margin')}
            `;
            
            document.getElementById('customersTableBody').innerHTML = custArray.map(c => `
                <tr class="clickable" onclick="showCustomersProductDrilldown('${c.customer.replace(/'/g, "\\'")}')">
                    <td><span class="watchlist-star ${isInWatchlist('customer', c.customer) ? 'active' : ''}" onclick="event.stopPropagation(); toggleWatchlistCustomer('${c.customer.replace(/'/g, "\\'")}')">â˜…</span></td>
                    <td><strong>${c.customer}</strong></td>
                    <td>${formatNumber(c.orders)}</td>
                    <td>${formatNumber(c.qty)}</td>
                    <td>${formatCurrency(c.revenue)}</td>
                    <td class="${c.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(c.pl)}</td>
                    <td class="${c.margin >= 0 ? 'positive' : 'negative'}">${c.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
            
            updateClearAllButton('customers');
        }
        
        function sortCustomersTable(field) {
            if (customersSort.field === field) customersSort.asc = !customersSort.asc;
            else { customersSort.field = field; customersSort.asc = field === 'customer'; }
            updateSalesCustomersPage();
        }
        
        function filterCustomersTable() { updateSalesCustomersPage(); }
        function exportCustomersCSV() { downloadCSV('Customer,Orders,Qty,Revenue,P/L,Margin', 'customers_pl.csv'); }
        
        // Customers Drilldown Functions
        function showCustomersProductDrilldown(customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer);
            
            const partStats = {};
            data.forEach(r => {
                const p = getVal(r, 'PART');
                if (!partStats[p]) partStats[p] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                partStats[p].orders++;
                partStats[p].qty += parseNumber(getVal(r, 'QTY'));
                partStats[p].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) partStats[p].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersProductDrilldownCustomer').textContent = customer;
            document.getElementById('customersProductSummary').innerHTML = `
                <div class="summary-item"><div class="label">Products</div><div class="value">${Object.keys(partStats).length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(partStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('customersProductDrilldownBody').innerHTML = sorted.map(([part, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                const avgPrice = stats.qty > 0 ? stats.revenue / stats.qty : 0;
                return `<tr class="clickable" onclick="showCustomersOrdersDrilldown('${currentDrilldownCustomer.replace(/'/g, "\\'")}', '${part.replace(/'/g, "\\'")}')">
                    <td><strong>${part}</strong></td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(avgPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersProductDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            document.getElementById('customersProductDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showCustomersOrdersDrilldown(customer, part) {
            currentDrilldownPart = part;
            const data = getFilteredCustomersData().filter(r => getVal(r, 'CUSTOMER') === customer && getVal(r, 'PART') === part);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('customersOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('customersOrdersBreadcrumbPart').textContent = part;
            document.getElementById('customersOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            // Price history chart for customer orders
            const priceData = data.map(r => ({ date: parseDate(getAttributionDate(r)), price: getUnitPrice(r) })).filter(d => d.date).sort((a,b) => a.date - b.date);
            if (charts.customersOrdersPrice) charts.customersOrdersPrice.destroy();
            const custPriceChartEl = document.getElementById('customersOrdersPriceChart');
            if (priceData.length > 1 && custPriceChartEl) {
                const prices = priceData.map(d => d.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const allSame = (maxPrice - minPrice) < 0.01;
                const yAxisMin = allSame ? minPrice * 0.9 : minPrice - (maxPrice - minPrice) * 0.15;
                const yAxisMax = allSame ? maxPrice * 1.1 : maxPrice + (maxPrice - minPrice) * 0.15;
                
                charts.customersOrdersPrice = new Chart(custPriceChartEl, {
                    type: 'line',
                    data: {
                        labels: priceData.map(d => d.date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                        datasets: [{
                            label: 'Unit Price',
                            data: prices,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49,130,206,0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4,
                            pointBackgroundColor: '#3182ce'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                min: yAxisMin,
                                max: yAxisMax,
                                ticks: { callback: v => formatCurrency(v), color: '#a0aec0', maxTicksLimit: 5 },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            x: {
                                ticks: { color: '#a0aec0', font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('customersOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const margin = revenue > 0 ? (pl / revenue * 100) : 0;
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td>${getContributionBadge(margin)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                    <td>${dateStr}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('customersOrdersDrilldown').classList.add('active');
            document.getElementById('customersOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeCustomersProductDrilldown() {
            document.getElementById('customersProductDrilldown').classList.remove('active');
            document.getElementById('customersOrdersDrilldown').classList.remove('active');
            currentDrilldownCustomer = null;
        }
        
        function closeCustomersOrdersDrilldown() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function backToCustomersProducts() { document.getElementById('customersOrdersDrilldown').classList.remove('active'); }
        function closeAllCustomersDrilldowns() { closeCustomersProductDrilldown(); }

        // ============================================================
        // SALES BY DATE PAGE (Enhanced with Drilldowns)
        // ============================================================
        function toggleDatesCategory(cat) {
            datesFilters.categories[cat] = !datesFilters.categories[cat];
            if (!datesFilters.categories.rolltech && !datesFilters.categories.molding && !datesFilters.categories.snappad) { datesFilters.categories[cat] = true; return; }
            document.getElementById('datesBtnRollTech').classList.toggle('active', datesFilters.categories.rolltech);
            document.getElementById('datesBtnMolding').classList.toggle('active', datesFilters.categories.molding);
            document.getElementById('datesBtnSnapPad').classList.toggle('active', datesFilters.categories.snappad);
            updateSalesDatesPage();
        }
        
        function applyDatesDateFilter() {
            datesFilters.fromDate = document.getElementById('datesFromDate').value ? new Date(document.getElementById('datesFromDate').value) : null;
            datesFilters.toDate = document.getElementById('datesToDate').value ? new Date(document.getElementById('datesToDate').value) : null;
            updateSalesDatesPage();
        }
        
        function resetDatesDateFilter() {
            document.getElementById('datesFromDate').value = '';
            document.getElementById('datesToDate').value = '';
            datesFilters.fromDate = null;
            datesFilters.toDate = null;
            updateSalesDatesPage();
        }
        
        function getFilteredDatesData() {
            return allData.filter(r => {
                if (!datesFilters.categories[getCategory(r)]) return false;
                if (datesFilters.fromDate || datesFilters.toDate) {
                    const dateStr = getAttributionDate(r);
                    if (!dateStr) return false;
                    const rowDate = parseDate(dateStr);
                    if (!rowDate) return false;
                    if (datesFilters.fromDate && rowDate < datesFilters.fromDate) return false;
                    if (datesFilters.toDate && rowDate > datesFilters.toDate) return false;
                }
                return true;
            });
        }
        
        function updateSalesDatesPage() {
            const data = getFilteredDatesData();
            const monthStats = {};
            let totalOrders = 0, totalUnits = 0, totalRevenue = 0, totalPL = 0;
            
            data.forEach(r => {
                const dateStr = getAttributionDate(r);
                if (!dateStr) return;
                const month = getMonthKey(dateStr);
                const status = getStatus(r);
                if (!monthStats[month]) monthStats[month] = { orders: 0, shipped: 0, qty: 0, revenue: 0, shippedPL: 0, forecastPL: 0 };
                monthStats[month].orders++;
                monthStats[month].qty += parseNumber(getVal(r, 'QTY'));
                monthStats[month].revenue += parseNumber(r[COL.REVENUE]);
                if (status === 'shipped') monthStats[month].shipped++;
                if (!hasMissingCostData(r)) {
                    const pl = getPLValue(r);
                    if (status === 'shipped') monthStats[month].shippedPL += pl;
                    else monthStats[month].forecastPL += pl;
                }
                totalOrders++;
                totalUnits += parseNumber(getVal(r, 'QTY'));
                totalRevenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) totalPL += getPLValue(r);
            });
            
            const margin = totalRevenue > 0 ? ((totalPL / totalRevenue) * 100) : 0;
            const monthCount = Object.keys(monthStats).length;
            
            document.getElementById('datesStatOrders').textContent = formatNumber(totalOrders);
            document.getElementById('datesStatUnits').textContent = `${formatNumber(totalUnits)} ${t('ui.units')}`;
            document.getElementById('datesStatRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('datesStatPL').textContent = formatCurrency(totalPL);
            document.getElementById('datesStatPL').className = `value ${totalPL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMargin').textContent = `${t('stats.margin')}: ${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('datesStatMarginPct').className = `value ${margin >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('datesStatMonths').textContent = `${monthCount} ${t('ui.months')}`;
            
            // Convert to array for filtering and sorting
            let monthsArray = Object.entries(monthStats).map(([month, stats]) => {
                const totalPL = stats.shippedPL + stats.forecastPL;
                const rowMargin = stats.revenue > 0 ? (totalPL / stats.revenue * 100) : 0;
                return {
                    month,
                    monthLabel: formatMonthLabel(month),
                    statusText: `${stats.shipped}/${stats.orders} Shipped`,
                    orders: stats.orders,
                    shipped: stats.shipped,
                    qty: stats.qty,
                    revenue: stats.revenue,
                    pl: totalPL,
                    margin: rowMargin,
                    shippedPL: stats.shippedPL,
                    forecastPL: stats.forecastPL
                };
            });
            
            // Apply column filters
            monthsArray = monthsArray.filter(m => {
                if (!passesColumnFilter('dates', 'month', m.monthLabel)) return false;
                if (!passesColumnFilter('dates', 'status', m.statusText)) return false;
                if (!passesColumnFilter('dates', 'orders', String(m.orders))) return false;
                if (!passesColumnFilter('dates', 'qty', String(m.qty))) return false;
                if (!passesColumnFilter('dates', 'revenue', formatCurrency(m.revenue))) return false;
                if (!passesColumnFilter('dates', 'pl', m.pl >= 0 ? 'Positive' : 'Negative')) return false;
                // Margin category filter
                let marginCat;
                if (m.margin < 0) marginCat = 'Negative';
                else if (m.margin < 10) marginCat = 'Low (0-10%)';
                else if (m.margin < 20) marginCat = 'Medium (10-20%)';
                else marginCat = 'High (>20%)';
                if (!passesColumnFilter('dates', 'margin', marginCat)) return false;
                return true;
            });
            
            // Sort
            monthsArray.sort((a, b) => {
                const field = datesSort.field;
                if (field === 'month') {
                    return datesSort.asc ? a.month.localeCompare(b.month) : b.month.localeCompare(a.month);
                }
                return datesSort.asc ? a[field] - b[field] : b[field] - a[field];
            });
            
            // Use full array for chart (before filtering affects it)
            const chartMonths = Object.entries(monthStats).sort((a,b) => a[0].localeCompare(b[0]));
            
            // Stacked bar chart with shipped profit/loss and forecast profit/loss
            if (charts.datesBar) charts.datesBar.destroy();
            charts.datesBar = new Chart(document.getElementById('datesBarChart'), {
                type: 'bar',
                data: {
                    labels: chartMonths.map(s => formatMonthLabel(s[0])),
                    datasets: [
                        { label: 'Shipped Profit', data: chartMonths.map(s => Math.max(0, s[1].shippedPL)), backgroundColor: 'rgba(56,161,105,0.8)', stack: 'shipped' },
                        { label: 'Shipped Loss', data: chartMonths.map(s => Math.min(0, s[1].shippedPL)), backgroundColor: 'rgba(229,62,62,0.8)', stack: 'shipped' },
                        { label: 'Forecast Profit', data: chartMonths.map(s => Math.max(0, s[1].forecastPL)), backgroundColor: 'rgba(56,161,105,0.4)', stack: 'forecast' },
                        { label: 'Forecast Loss', data: chartMonths.map(s => Math.min(0, s[1].forecastPL)), backgroundColor: 'rgba(229,62,62,0.4)', stack: 'forecast' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0aec0' } } },
                    scales: {
                        y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#a0aec0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { stacked: true, ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
            
            // Render filterable table header
            document.getElementById('datesTableHeader').innerHTML = 
                createFilterHeader('dates', 'month', 'Month') +
                createFilterHeader('dates', 'status', 'Status') +
                createFilterHeader('dates', 'orders', 'Orders') +
                createFilterHeader('dates', 'qty', 'Qty') +
                createFilterHeader('dates', 'revenue', 'Revenue') +
                createFilterHeader('dates', 'pl', 'P/L') +
                createFilterHeader('dates', 'margin', 'Margin');
            
            // Table with X/Y Shipped format
            document.getElementById('datesTableCount').textContent = `${monthsArray.length} ${t('ui.months')}`;
            document.getElementById('datesTableBody').innerHTML = monthsArray.map(m => {
                return `<tr class="clickable" onclick="showDatesCustomerDrilldown('${m.month}')">
                    <td><strong>${m.monthLabel}</strong></td>
                    <td>${m.statusText}</td>
                    <td>${formatNumber(m.orders)}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatCurrency(m.revenue)}</td>
                    <td class="${m.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.pl)}</td>
                    <td class="${m.margin >= 0 ? 'positive' : 'negative'}">${m.margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            updateClearAllButton('dates');
        }
        
        function sortDatesTable(field) {
            if (datesSort.field === field) datesSort.asc = !datesSort.asc;
            else { datesSort.field = field; datesSort.asc = field === 'month'; }
            updateSalesDatesPage();
        }
        
        function exportDatesCSV() { downloadCSV('Month,Status,Orders,Quantity,Revenue,P/L,Margin', 'dates_pl.csv'); }
        
        // Dates Drilldown Functions
        function showDatesCustomerDrilldown(month) {
            currentDrilldownMonth = month;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month);
            
            const custStats = {};
            data.forEach(r => {
                const c = getVal(r, 'CUSTOMER') || 'Unknown';
                if (!custStats[c]) custStats[c] = { orders: 0, qty: 0, revenue: 0, pl: 0 };
                custStats[c].orders++;
                custStats[c].qty += parseNumber(getVal(r, 'QTY'));
                custStats[c].revenue += parseNumber(r[COL.REVENUE]);
                if (!hasMissingCostData(r)) custStats[c].pl += getPLValue(r);
            });
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesCustomerDrilldownMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesCustomerSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = Object.entries(custStats).sort((a,b) => b[1].pl - a[1].pl);
            document.getElementById('datesCustomerDrilldownBody').innerHTML = sorted.map(([customer, stats]) => {
                const margin = stats.revenue > 0 ? (stats.pl / stats.revenue * 100) : 0;
                return `<tr class="clickable" onclick="showDatesOrdersDrilldown('${currentDrilldownMonth}', '${customer.replace(/'/g, "\\'")}')">
                    <td><strong>${customer}</strong></td>
                    <td>${formatNumber(stats.orders)}</td>
                    <td>${formatNumber(stats.qty)}</td>
                    <td>${formatCurrency(stats.revenue)}</td>
                    <td class="${stats.pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.pl)}</td>
                    <td class="${margin >= 0 ? 'positive' : 'negative'}">${margin.toFixed(1)}%</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesCustomerDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            document.getElementById('datesCustomerDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDatesOrdersDrilldown(month, customer) {
            currentDrilldownCustomer = customer;
            const data = getFilteredDatesData().filter(r => getMonthKey(getAttributionDate(r)) === month && getVal(r, 'CUSTOMER') === customer);
            
            const totalQty = data.reduce((s, r) => s + parseNumber(getVal(r, 'QTY')), 0);
            const totalRev = data.reduce((s, r) => s + parseNumber(r[COL.REVENUE]), 0);
            const totalPL = data.filter(r => !hasMissingCostData(r)).reduce((s, r) => s + getPLValue(r), 0);
            
            document.getElementById('datesOrdersBreadcrumbMonth').textContent = formatMonthLabel(month);
            document.getElementById('datesOrdersBreadcrumbCustomer').textContent = customer;
            document.getElementById('datesOrdersSummary').innerHTML = `
                <div class="summary-item"><div class="label">Orders</div><div class="value">${data.length}</div></div>
                <div class="summary-item"><div class="label">Total Qty</div><div class="value">${formatNumber(totalQty)}</div></div>
                <div class="summary-item"><div class="label">Revenue</div><div class="value">${formatCurrency(totalRev)}</div></div>
                <div class="summary-item"><div class="label">P/L</div><div class="value ${totalPL >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalPL)}</div></div>
            `;
            
            const sorted = [...data].sort((a,b) => {
                const da = parseDate(getAttributionDate(a)) || new Date(0);
                const db = parseDate(getAttributionDate(b)) || new Date(0);
                return db - da;
            });
            
            document.getElementById('datesOrdersDrilldownBody').innerHTML = sorted.map(r => {
                const status = getStatus(r);
                const pl = getPLValue(r);
                const qty = parseNumber(getVal(r, 'QTY'));
                const revenue = parseNumber(r[COL.REVENUE]);
                const unitPrice = getUnitPrice(r);
                const profitPart = getProfitPerPart(r);
                const dateStr = getAttributionDate(r) || '-';
                const statusBadge = status === 'shipped' ? getStatusBadge(status) : `<span class="badge forecast">FORECAST</span>`;
                
                return `<tr>
                    <td><strong>${getVal(r, 'PART') || '-'}</strong></td>
                    <td>${getVal(r, 'PO_NUM') || getVal(r, 'IF_NUM') || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${dateStr}</td>
                    <td>${formatNumber(qty)}</td>
                    <td>${formatCurrency(unitPrice)}</td>
                    <td class="${profitPart >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitPart)}</td>
                    <td class="${pl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl)}</td>
                    <td>${formatCurrency(revenue)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('datesOrdersDrilldown').classList.add('active');
            document.getElementById('datesOrdersDrilldown').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeDatesCustomerDrilldown() {
            document.getElementById('datesCustomerDrilldown').classList.remove('active');
            document.getElementById('datesOrdersDrilldown').classList.remove('active');
            currentDrilldownMonth = null;
        }
        
        function closeDatesOrdersDrilldown() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function backToDatesCustomers() { document.getElementById('datesOrdersDrilldown').classList.remove('active'); }
        function closeAllDatesDrilldowns() { closeDatesCustomerDrilldown(); }

        // ============================================================
        // ============================================================
        // ALL DATA PAGE (Raw spreadsheet data - Columns A-AX)
        // ============================================================
        function updateAllDataPage() {
            document.getElementById('allDataLastUpdated').textContent = new Date().toLocaleTimeString();
            document.getElementById('allDataRowCount').textContent = allRawData.length;
            document.getElementById('allDataColCount').textContent = allRawHeaders.length;
            
            renderAllDataTableHeader();
            renderAllDataTable();
            updateClearAllButton('allData');
        }
        
        function renderAllDataTableHeader() {
            initTableFilters('allData');
            initHiddenColumns('allData');
            document.getElementById('allDataTableHeader').innerHTML = allRawHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('allData', colKey)) return '';
                return createFilterHeader('allData', colKey, h, true);
            }).join('');
        }
        
        function renderAllDataTable() {
            let data = [...allRawData];
            
            // Filter out rows where column A is empty (array formula fills column A only for valid rows)
            const firstColHeader = allRawHeaders[0];
            if (firstColHeader) {
                data = data.filter(row => {
                    const val = row[firstColHeader];
                    return val !== undefined && val !== null && val !== '';
                });
            }
            
            // Global search filter
            const globalSearch = (document.getElementById('allDataGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return allRawHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return allRawHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('allData', colKey, val);
                });
            });
            
            // Apply sort
            if (allDataSort.field !== null) {
                const colIndex = parseInt(allDataSort.field.replace('col_', ''));
                const header = allRawHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    // Try numeric comparison first
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return allDataSort.asc ? numA - numB : numB - numA;
                    }
                    // Fall back to string comparison
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return allDataSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table header (with hidden columns support)
            renderAllDataTableHeader();
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('allDataTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${allRawHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('allData', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('revenue') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('price') || h.toLowerCase().includes('p/l'))) {
                            const cls = num >= 0 ? 'positive' : 'negative';
                            return `<td class="${cls}">${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = allRawHeaders.filter((h, i) => !isColumnHidden('allData', `col_${i}`)).length;
            document.getElementById('allDataRowCount').textContent = data.length;
            document.getElementById('allDataColCount').textContent = visibleColCount;
            updateShowHiddenButton('allData');
        }
        
        function sortAllDataTable(field) {
            if (allDataSort.field === field) {
                allDataSort.asc = !allDataSort.asc;
            } else {
                allDataSort.field = field;
                allDataSort.asc = true;
            }
            renderAllDataTable();
        }
        
        function filterAllDataTable() {
            renderAllDataTable();
        }
        
        function getUniqueAllDataColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = allRawHeaders[colIndex];
            const firstColHeader = allRawHeaders[0];
            const values = new Set();
            // Only include values from rows where column A has data
            allRawData.forEach(row => {
                const firstColVal = row[firstColHeader];
                if (firstColVal === undefined || firstColVal === null || firstColVal === '') return;
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            // Sort values - try numeric first
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportAllDataToCSV() {
            const headers = allRawHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = allRawData.map(row => 
                allRawHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `all_data_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // BOM EXPLORER
        // ============================================================
        function initBomExplorer() { renderBomSelector(); }
        function filterBomSelector() { renderBomSelector((document.getElementById('bomSearch').value || '').toLowerCase()); }
        
        function switchBomTab(tab) {
            currentBomTab = tab;
            document.querySelectorAll('.tab[data-bomtab]').forEach(t => t.classList.toggle('active', t.dataset.bomtab === tab));
            document.getElementById('bomSearch').value = '';
            renderBomSelector();
            document.getElementById('bomPartName').textContent = 'Select a part';
            document.getElementById('bomCategory').textContent = '';
            document.getElementById('bomContent').innerHTML = '<p style="color:var(--text-secondary);">Click on a part from the list to view details.</p>';
        }
        
        function renderBomSelector(filter = '') {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const selector = document.getElementById('bomSelector');
            if (!data || data.length === 0) { selector.innerHTML = '<p style="color:var(--text-secondary);">No BOM data available. Check that the source sheet contains data.</p>'; return; }
            const nameKey = Object.keys(data[0]).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const filtered = data.filter(d => (d[nameKey] || '').toLowerCase().includes(filter));
            selector.innerHTML = filtered.length === 0 ? '<p style="color:var(--text-secondary);">No parts found.</p>' : filtered.map((d, i) => {
                const originalIndex = data.indexOf(d);
                return `<div class="bom-item" data-index="${originalIndex}" onclick="showBomDetails(${originalIndex})">${d[nameKey] || 'Unknown'}</div>`;
            }).join('');
        }
        
        function showBomDetails(index) {
            const data = currentBomTab === 'final' ? bomFinalData : currentBomTab === 'sub' ? bomSubData : bomIndividualData;
            const part = data[index];
            if (!part) return;
            
            document.querySelectorAll('.bom-item').forEach((item, i) => item.classList.toggle('selected', parseInt(item.dataset.index) === index));
            
            const nameKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'part name') || 'Part name';
            const catKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'category');
            document.getElementById('bomPartName').textContent = part[nameKey] || 'Unknown';
            document.getElementById('bomCategory').textContent = catKey ? (part[catKey] || '') : '';
            
            let content = '';
            if (currentBomTab === 'individual') {
                content = `<div class="bom-section"><h4>Item Details</h4><div class="cost-breakdown">`;
                const descKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'description');
                const costKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('cost'));
                const suppKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'supplier');
                if (descKey && part[descKey]) content += `<div class="cost-item"><span class="label">Description</span><span class="value">${part[descKey]}</span></div>`;
                if (costKey && part[costKey]) content += `<div class="cost-item"><span class="label">Cost/lb</span><span class="value">${formatCurrency(parseNumber(part[costKey]))}</span></div>`;
                if (suppKey && part[suppKey]) content += `<div class="cost-item"><span class="label">Supplier</span><span class="value">${part[suppKey]}</span></div>`;
                content += `</div></div>`;
            } else if (currentBomTab === 'sub') {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                for (const [label, search, exactMatch] of [['Mold','mold',false],['Weight','weight',false],['Labor/Part','labor cost/ part',false],['Overhead','overhead',false],['Total Cost','total cost',true]]) {
                    let key = exactMatch ? Object.keys(part).find(k => k.trim().toLowerCase() === search) : Object.keys(part).find(k => k.trim().toLowerCase().includes(search));
                    if (key && part[key]) content += `<div class="cost-item"><span class="label">${label}</span><span class="value">${['Labor/Part','Overhead','Total Cost'].includes(label) ? formatCurrency(parseNumber(part[key])) : part[key]}</span></div>`;
                }
                content += `</div></div><div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 5; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} cost`);
                    if (comp && part[comp] && part[comp] !== 'nan') content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty ? part[qty] : '-'}</span><span>Cost: ${cost ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                }
                content += `</div></div>`;
            } else {
                content = `<div class="bom-section"><h4>Assembly Info</h4><div class="cost-breakdown">`;
                const partsPkgKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('parts per package'));
                if (partsPkgKey && part[partsPkgKey]) content += `<div class="cost-item"><span class="label">Parts/Pkg</span><span class="value">${part[partsPkgKey]}</span></div>`;
                const laborKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('labor cost / finished') || k.trim().toLowerCase().includes('labor cost/ finished'));
                if (laborKey && part[laborKey]) content += `<div class="cost-item"><span class="label">Labor</span><span class="value">${formatCurrency(parseNumber(part[laborKey]))}</span></div>`;
                const varCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'variable cost');
                if (varCostKey && part[varCostKey]) content += `<div class="cost-item"><span class="label">Variable Cost</span><span class="value">${formatCurrency(parseNumber(part[varCostKey]))}</span></div>`;
                const totalCostKey = Object.keys(part).find(k => k.trim().toLowerCase() === 'total cost');
                if (totalCostKey && part[totalCostKey]) content += `<div class="cost-item"><span class="label">Total Cost</span><span class="value">${formatCurrency(parseNumber(part[totalCostKey]))}</span></div>`;
                content += `</div></div>`;
                const profitKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('profit target'));
                const salesKey = Object.keys(part).find(k => k.trim().toLowerCase().includes('sales target'));
                if ((profitKey && part[profitKey]) || (salesKey && part[salesKey])) {
                    content += `<div class="highlight-box">`;
                    if (profitKey && part[profitKey]) { const profitVal = parseNumber(part[profitKey]); const displayVal = profitVal < 1 ? (profitVal * 100).toFixed(0) + '%' : profitVal.toFixed(0) + '%'; content += `<div class="item"><div class="value">${displayVal}</div><div class="label">Profit Target</div></div>`; }
                    if (salesKey && part[salesKey]) content += `<div class="item"><div class="value">${formatCurrency(parseNumber(part[salesKey]))}</div><div class="label">Sales Target</div></div>`;
                    content += `</div>`;
                }
                content += `<div class="bom-section"><h4>Components</h4><div class="component-list">`;
                for (let i = 1; i <= 13; i++) {
                    const comp = Object.keys(part).find(k => k.trim() === `Component ${i}`);
                    const qty = Object.keys(part).find(k => k.trim() === `Component ${i} Qty.`);
                    const cost = Object.keys(part).find(k => k.trim() === `Component ${i} Cost.`);
                    if (comp && part[comp] && part[comp] !== 'nan' && !String(part[comp]).startsWith('nan')) {
                        content += `<div class="component-item"><span class="name">${part[comp]}</span><span class="details"><span>Qty: ${qty && part[qty] && part[qty] !== 'nan' ? part[qty] : '-'}</span><span>Cost: ${cost && part[cost] && part[cost] !== 'nan' ? formatCurrency(parseNumber(part[cost])) : '-'}</span></span></div>`;
                    }
                }
                content += `</div></div>`;
            }
            document.getElementById('bomContent').innerHTML = content;
        }

        // ============================================================
        // REFERENCE DATA SECTIONS (FP Reference, Customer Reference, Quotes Registry)
        // ============================================================
        
        function handleRefDataClick(page) {
            if (!salesUnlocked) {
                promptSalesPassword();
                return;
            }
            navigateTo(page);
        }
        
        // Track if reference data has been loaded
        let referenceDataLoaded = false;
        
        async function updateFpReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderFpRefTable();
        }
        
        async function updateCustReferencePage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderCustRefTable();
        }
        
        async function updateQuotesRegistryPage() {
            if (!referenceDataLoaded) {
                await loadReferenceData();
                referenceDataLoaded = true;
            }
            renderQuotesTable();
        }
        
        async function updatePalletRecordsPage() {
            if (!palletRecordsLoaded) {
                await loadPalletRecordsData();
            }
            renderPalletRecordsTable();
        }
        
        async function updateShippingRecordsPage() {
            if (!shippingRecordsLoaded) {
                await loadShippingRecordsData();
            }
            renderShippingRecordsTable();
        }
        
        async function updateStagedRecordsPage() {
            if (!stagedRecordsLoaded) {
                await loadStagedRecordsData();
            }
            renderStagedRecordsTable();
        }
        
        async function loadReferenceData() {
            try {
                // Load FP Reference Data
                const fpRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${FP_REFERENCE_GID}`;
                const fpRes = await fetch(fpRefUrl);
                const fpText = await fpRes.text();
                const fpJson = JSON.parse(fpText.substring(fpText.indexOf('{'), fpText.lastIndexOf('}') + 1));
                fpReferenceHeaders = fpJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                fpReferenceData = fpJson.table.rows.map(r => {
                    const obj = {};
                    fpReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded FP Reference:', fpReferenceData.length, 'rows');
                
                // Load Customer Reference Data
                const custRefUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${CUSTOMER_REFERENCE_GID}`;
                const custRes = await fetch(custRefUrl);
                const custText = await custRes.text();
                const custJson = JSON.parse(custText.substring(custText.indexOf('{'), custText.lastIndexOf('}') + 1));
                customerReferenceHeaders = custJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim()).filter(h => h);
                customerReferenceData = custJson.table.rows.map(r => {
                    const obj = {};
                    customerReferenceHeaders.forEach((h, i) => { if (h) obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && v !== ''));
                console.log('Loaded Customer Reference:', customerReferenceData.length, 'rows');
                
                // Load Quotes Registry Data (with headers from spreadsheet, columns A-J only)
                const quotesUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${QUOTES_REGISTRY_GID}`;
                const quotesRes = await fetch(quotesUrl);
                const quotesText = await quotesRes.text();
                const quotesJson = JSON.parse(quotesText.substring(quotesText.indexOf('{'), quotesText.lastIndexOf('}') + 1));
                // Get headers from spreadsheet columns A-J (first 10 columns only)
                const allQuotesHeaders = quotesJson.table.cols.map(c => (c.label || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim());
                quotesRegistryHeaders = allQuotesHeaders.slice(0, 10).filter(h => h); // Only columns A-J
                quotesRegistryData = quotesJson.table.rows.map(r => {
                    const obj = {};
                    quotesRegistryHeaders.forEach((h, i) => { obj[h] = (r.c && r.c[i]) ? (r.c[i].f ?? r.c[i].v ?? '') : ''; });
                    return obj;
                }).filter(row => {
                    // Filter out rows without Quote Number and filter out the header row if it got included as data
                    const quoteNum = row['Quote Number'] || row[quotesRegistryHeaders[0]];
                    return quoteNum && quoteNum !== 'Quote Number';
                });
                console.log('Loaded Quotes Registry:', quotesRegistryData.length, 'rows, Headers:', quotesRegistryHeaders);
                
            } catch (e) {
                console.error('Reference data load error:', e);
            }
        }
        
        // FP Reference Data Functions
        function renderFpRefTableHeader() {
            initTableFilters('fpRef');
            initHiddenColumns('fpRef');
            document.getElementById('fpRefTableHeader').innerHTML = fpReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('fpRef', colKey)) return '';
                return createFilterHeader('fpRef', colKey, h, true);
            }).join('');
        }
        
        function renderFpRefTable() {
            if (fpReferenceHeaders.length === 0) {
                document.getElementById('fpRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderFpRefTableHeader();
            let data = [...fpReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('fpRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return fpReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return fpReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('fpRef', colKey, val);
                });
            });
            
            // Apply sort
            if (fpRefSort.field !== null) {
                const colIndex = parseInt(fpRefSort.field.replace('col_', ''));
                const header = fpReferenceHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return fpRefSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return fpRefSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('fpRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${fpReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('fpRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = fpReferenceHeaders.filter((h, i) => !isColumnHidden('fpRef', `col_${i}`)).length;
            document.getElementById('fpRefRowCount').textContent = data.length;
            document.getElementById('fpRefColCount').textContent = visibleColCount;
            document.getElementById('fpRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('fpRef');
            updateShowHiddenButton('fpRef');
        }
        
        function sortFpRefTable(field) {
            if (fpRefSort.field === field) {
                fpRefSort.asc = !fpRefSort.asc;
            } else {
                fpRefSort.field = field;
                fpRefSort.asc = true;
            }
            renderFpRefTable();
        }
        
        function filterFpRefTable() { renderFpRefTable(); }
        
        function getUniqueFpRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = fpReferenceHeaders[colIndex];
            const values = new Set();
            fpReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportFpRefToCSV() {
            const headers = fpReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = fpReferenceData.map(row => 
                fpReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `fp_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Customer Reference Data Functions
        function renderCustRefTableHeader() {
            initTableFilters('custRef');
            initHiddenColumns('custRef');
            document.getElementById('custRefTableHeader').innerHTML = customerReferenceHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('custRef', colKey)) return '';
                return createFilterHeader('custRef', colKey, h, true);
            }).join('');
        }
        
        function renderCustRefTable() {
            if (customerReferenceHeaders.length === 0) {
                document.getElementById('custRefTableBody').innerHTML = '<tr><td colspan="20">Loading data...</td></tr>';
                return;
            }
            
            renderCustRefTableHeader();
            let data = [...customerReferenceData];
            
            // Global search filter
            const globalSearch = (document.getElementById('custRefGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return customerReferenceHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return customerReferenceHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('custRef', colKey, val);
                });
            });
            
            // Apply sort
            if (custRefSort.field !== null) {
                const colIndex = parseInt(custRefSort.field.replace('col_', ''));
                const header = customerReferenceHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return custRefSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return custRefSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('custRefTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${customerReferenceHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('custRef', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Format currency values
                    if (typeof val === 'number' || (typeof val === 'string' && val.startsWith('$'))) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && (h.toLowerCase().includes('price') || h.toLowerCase().includes('cost') || h.toLowerCase().includes('sell'))) {
                            return `<td>${formatCurrency(num)}</td>`;
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = customerReferenceHeaders.filter((h, i) => !isColumnHidden('custRef', `col_${i}`)).length;
            document.getElementById('custRefRowCount').textContent = data.length;
            document.getElementById('custRefColCount').textContent = visibleColCount;
            document.getElementById('custRefLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('custRef');
            updateShowHiddenButton('custRef');
        }
        
        function sortCustRefTable(field) {
            if (custRefSort.field === field) {
                custRefSort.asc = !custRefSort.asc;
            } else {
                custRefSort.field = field;
                custRefSort.asc = true;
            }
            renderCustRefTable();
        }
        
        function filterCustRefTable() { renderCustRefTable(); }
        
        function getUniqueCustRefColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = customerReferenceHeaders[colIndex];
            const values = new Set();
            customerReferenceData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportCustRefToCSV() {
            const headers = customerReferenceHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = customerReferenceData.map(row => 
                customerReferenceHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `customer_reference_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Quotes Registry Functions
        function renderQuotesTableHeader() {
            initTableFilters('quotes');
            initHiddenColumns('quotes');
            document.getElementById('quotesTableHeader').innerHTML = quotesRegistryHeaders.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('quotes', colKey)) return '';
                return createFilterHeader('quotes', colKey, h, true);
            }).join('');
        }
        
        function renderQuotesTable() {
            if (quotesRegistryData.length === 0) {
                document.getElementById('quotesTableBody').innerHTML = '<tr><td colspan="11">Loading data...</td></tr>';
                return;
            }
            
            renderQuotesTableHeader();
            let data = [...quotesRegistryData];
            
            // Global search filter
            const globalSearch = (document.getElementById('quotesGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return quotesRegistryHeaders.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return quotesRegistryHeaders.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('quotes', colKey, val);
                });
            });
            
            // Apply sort
            if (quotesSort.field !== null) {
                const colIndex = parseInt(quotesSort.field.replace('col_', ''));
                const header = quotesRegistryHeaders[colIndex];
                data.sort((a, b) => {
                    let va = a[header], vb = b[header];
                    const numA = parseNumber(va), numB = parseNumber(vb);
                    if (!isNaN(numA) && !isNaN(numB) && va !== '' && vb !== '') {
                        return quotesSort.asc ? numA - numB : numB - numA;
                    }
                    va = va !== undefined && va !== null ? String(va) : '';
                    vb = vb !== undefined && vb !== null ? String(vb) : '';
                    return quotesSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
            }
            
            // Render table body (skip hidden columns)
            const tbody = document.getElementById('quotesTableBody');
            tbody.innerHTML = data.map(row => {
                return `<tr>${quotesRegistryHeaders.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('quotes', colKey)) return '';
                    let val = row[h];
                    if (val === undefined || val === null) val = '';
                    // Make Drive Link clickable (case-insensitive check)
                    if (h.toLowerCase().includes('drive') && h.toLowerCase().includes('link') && val && String(val).startsWith('http')) {
                        return `<td><a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“„ View</a></td>`;
                    }
                    // Format Amount as currency (case-insensitive check)
                    if (h.toLowerCase() === 'amount' && val) {
                        const num = parseNumber(val);
                        if (!isNaN(num) && num !== 0) return `<td>${formatCurrency(num)}</td>`;
                    }
                    return `<td>${val}</td>`;
                }).join('')}</tr>`;
            }).join('');
            
            // Count visible columns
            const visibleColCount = quotesRegistryHeaders.filter((h, i) => !isColumnHidden('quotes', `col_${i}`)).length;
            document.getElementById('quotesRowCount').textContent = data.length;
            document.getElementById('quotesColCount').textContent = visibleColCount;
            document.getElementById('quotesLastUpdated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            updateClearAllButton('quotes');
            updateShowHiddenButton('quotes');
        }
        
        function sortQuotesTable(field) {
            if (quotesSort.field === field) {
                quotesSort.asc = !quotesSort.asc;
            } else {
                quotesSort.field = field;
                quotesSort.asc = true;
            }
            renderQuotesTable();
        }
        
        function filterQuotesTable() { renderQuotesTable(); }
        
        function getUniqueQuotesColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = quotesRegistryHeaders[colIndex];
            const values = new Set();
            quotesRegistryData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            const arr = Array.from(values);
            arr.sort((a, b) => {
                const numA = parseFloat(a), numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            return arr;
        }
        
        function exportQuotesToCSV() {
            const headers = quotesRegistryHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = quotesRegistryData.map(row => 
                quotesRegistryHeaders.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headers, ...rows].join('\n'), `quotes_registry_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // PALLET RECORDS FUNCTIONS
        // ============================================================
        
        async function loadPalletRecordsData() {
            if (palletRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(PALLET_PICTURES_GID);
                console.log('Pallet Records raw data sample:', rawData.length > 0 ? rawData[0] : 'no data');
                console.log('Pallet Records raw data count:', rawData.length);
                
                // Map the original bilingual headers to simplified English headers
                // The headers in the spreadsheet are bilingual, so we need to find them
                palletRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Order Number': findVal('order number', 'numero de orden'),
                        'Pallet Number': findVal('pallet number', 'numero de paleta'),
                        'Pallet Picture 1': findVal('pallet pictures', 'fotos de paletas'),
                        'Pallet Weight (lbs)': findVal('pallet weight', 'peso de la paleta'),
                        'Pallet Dimensions': findVal('pallet dimensions', 'dimensiones de la paleta'),
                        'Pallet Picture 2': findVal('pallet pictures 2', 'fotos de paletas 2'),
                        'Pallet Picture 3': findVal('pallet pictures 3', 'fotos de paletas 3'),
                        'Pallet Picture 4': findVal('pallet pictures 4', 'fotos de paletas 4'),
                        'Pallet Picture 5': findVal('pallet pictures 5', 'fotos de paletas 5'),
                        'Parts/Boxes per Pallet': findVal('parts/boxes per pallet', 'partes o cajas por paleta'),
                        'Customer': findVal('customer', 'cliente'),
                        'IF Number': findVal('if number', 'numero if'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Order Number'];
                });
                
                palletRecordsLoaded = true;
                console.log('Loaded Pallet Records:', palletRecordsData.length, 'rows');
                if (palletRecordsData.length > 0) {
                    console.log('First row sample:', palletRecordsData[0]);
                }
            } catch (e) {
                console.error('Pallet Records load error:', e);
                palletRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getPalletRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function togglePalletRecordsCategory(cat) {
            palletRecordsFilters.categories[cat] = !palletRecordsFilters.categories[cat];
            document.getElementById(`palletRecordsBtnRollTech`).classList.toggle('active', palletRecordsFilters.categories.rolltech);
            document.getElementById(`palletRecordsBtnMolding`).classList.toggle('active', palletRecordsFilters.categories.molding);
            document.getElementById(`palletRecordsBtnSnapPad`).classList.toggle('active', palletRecordsFilters.categories.snappad);
            renderPalletRecordsTable();
        }
        
        function renderPalletRecordsTableHeader() {
            const headers = currentLang === 'es' ? PALLET_RECORDS_HEADERS_ES : PALLET_RECORDS_HEADERS;
            initTableFilters('palletRecords');
            initHiddenColumns('palletRecords');
            document.getElementById('palletRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('palletRecords', colKey)) return '';
                return createFilterHeader('palletRecords', colKey, h, true);
            }).join('');
        }
        
        function renderPalletRecordsTable() {
            if (!palletRecordsLoaded) {
                document.getElementById('palletRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('palletRecordsRowCount').textContent = '-';
                return;
            }
            if (palletRecordsData.length === 0) {
                document.getElementById('palletRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('palletRecordsRowCount').textContent = '0';
                return;
            }
            
            renderPalletRecordsTableHeader();
            const headers = PALLET_RECORDS_HEADERS;
            let data = [...palletRecordsData];
            
            // Category filter
            data = data.filter(row => palletRecordsFilters.categories[getPalletRecordsCategory(row)] || getPalletRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('palletRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('palletRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (palletRecordsSort.field !== null) {
                const colIndex = parseInt(palletRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return palletRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return palletRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('palletRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('palletRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('palletRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links
                    if (h.includes('Picture') && val && val.toString().includes('http')) {
                        val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('palletRecords');
        }
        
        function sortPalletRecordsTable(field) {
            if (palletRecordsSort.field === field) {
                palletRecordsSort.asc = !palletRecordsSort.asc;
            } else {
                palletRecordsSort.field = field;
                palletRecordsSort.asc = true;
            }
            renderPalletRecordsTable();
        }
        
        function filterPalletRecordsTable() { renderPalletRecordsTable(); }
        
        function getUniquePalletRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = PALLET_RECORDS_HEADERS[colIndex];
            const values = new Set();
            palletRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportPalletRecordsToCSV() {
            const headers = currentLang === 'es' ? PALLET_RECORDS_HEADERS_ES : PALLET_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = palletRecordsData.map(row => 
                PALLET_RECORDS_HEADERS.map(h => {
                    const val = row[h];
                    if (val === undefined || val === null) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `pallet_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // SHIPPING RECORDS FUNCTIONS
        // ============================================================
        
        async function loadShippingRecordsData() {
            if (shippingRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(SHIPPING_RECORDS_GID);
                console.log('==== SHIPPING RECORDS LOAD DEBUG ====');
                console.log('Raw data count:', rawData.length);
                if (rawData.length > 0) {
                    const headers = Object.keys(rawData[0]);
                    console.log('ALL Column headers (' + headers.length + '):', headers);
                    // Show headers that might contain pictures
                    const pictureHeaders = headers.filter(h => 
                        h.toLowerCase().includes('picture') || 
                        h.toLowerCase().includes('foto') ||
                        h.toLowerCase().includes('image') ||
                        h.toLowerCase().includes('ship') ||
                        h.toLowerCase().includes('envio') ||
                        h.toLowerCase().includes('paper') ||
                        h.toLowerCase().includes('papeleo') ||
                        h.toLowerCase().includes('close') ||
                        h.toLowerCase().includes('cercana')
                    );
                    console.log('Picture-related headers:', pictureHeaders);
                    console.log('First row sample:', rawData[0]);
                }
                console.log('=====================================');
                
                // Helper to extract URLs from a field that may contain multiple URLs
                const extractUrls = (value) => {
                    if (!value) return [];
                    const str = value.toString();
                    // Split by comma, newline, or space followed by http
                    const urls = str.split(/[,\n]|\s+(?=https?:)/)
                        .map(u => u.trim())
                        .filter(u => u && u.includes('http'));
                    return urls;
                };
                
                // Map the original bilingual headers to simplified English headers
                shippingRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    // Get all picture URLs from columns matching ANY of the keywords
                    const findAllPictures = (...keywords) => {
                        const allUrls = [];
                        for (const [header, value] of Object.entries(row)) {
                            const h = header.toLowerCase();
                            if (keywords.some(k => h.includes(k.toLowerCase()))) {
                                const urls = extractUrls(value);
                                allUrls.push(...urls);
                            }
                        }
                        return allUrls;
                    };
                    
                    // Determine system and normalize
                    let system = findVal('system', 'sistema').toString().toLowerCase();
                    if (system.includes('fusion')) system = 'Fusion';
                    else if (system.includes('veeqo') || system.includes('veeco')) system = 'Veeqo';
                    else if (system) system = 'Other';
                    else system = '';
                    
                    // Get all shipment pictures - match various patterns for shipment photos
                    // Column names may include: "Shipment", "EnvÃ­o", "Envio", "ship"
                    const shipmentPictures = findAllPictures('shipment', 'envÃ­o', 'envio', 'ship');
                    
                    // Get all paperwork pictures
                    // Column names may include: "Paperwork", "Papeleo", "BOL", "document"
                    const paperworkPictures = findAllPictures('paperwork', 'papeleo', 'bol', 'document');
                    
                    // Get all close up pictures
                    // Column names may include: "Close-up", "Close up", "Closeup", "Primer Plano", "Cercana"
                    const closeUpPictures = findAllPictures('close-up', 'close up', 'closeup', 'primer plano', 'cercana');
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Carrier': findVal('carrier', 'transportista'),
                        'IF Number': findVal('if #', 'if number', 'numero if', 'numero de if'),
                        'System': system,
                        'Order Number': findVal('order number', 'numero de orden'),
                        'Shipment Pictures': shipmentPictures,  // Array of URLs
                        'Paperwork Pictures': paperworkPictures, // Array of URLs
                        'Close Up Pictures': closeUpPictures,   // Array of URLs
                        'Customer': findVal('customer', 'cliente', 'costumer'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Carrier'];
                });
                
                shippingRecordsLoaded = true;
                console.log('Loaded Shipping Records:', shippingRecordsData.length, 'rows');
                if (shippingRecordsData.length > 0) {
                    console.log('First row sample:', shippingRecordsData[0]);
                    // Log first row with any photos
                    const rowWithPhotos = shippingRecordsData.find(r => r['Shipment Pictures'].length > 0 || r['Paperwork Pictures'].length > 0 || r['Close Up Pictures'].length > 0);
                    if (rowWithPhotos) {
                        console.log('Row with photos sample:', rowWithPhotos);
                    }
                }
            } catch (e) {
                console.error('Shipping Records load error:', e);
                shippingRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getShippingRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function toggleShippingRecordsCategory(cat) {
            shippingRecordsFilters.categories[cat] = !shippingRecordsFilters.categories[cat];
            document.getElementById(`shippingRecordsBtnRollTech`).classList.toggle('active', shippingRecordsFilters.categories.rolltech);
            document.getElementById(`shippingRecordsBtnMolding`).classList.toggle('active', shippingRecordsFilters.categories.molding);
            document.getElementById(`shippingRecordsBtnSnapPad`).classList.toggle('active', shippingRecordsFilters.categories.snappad);
            renderShippingRecordsTable();
        }
        
        function renderShippingRecordsTableHeader() {
            const headers = currentLang === 'es' ? SHIPPING_RECORDS_HEADERS_ES : SHIPPING_RECORDS_HEADERS;
            initTableFilters('shippingRecords');
            initHiddenColumns('shippingRecords');
            document.getElementById('shippingRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('shippingRecords', colKey)) return '';
                return createFilterHeader('shippingRecords', colKey, h, true);
            }).join('');
        }
        
        function renderShippingRecordsTable() {
            if (!shippingRecordsLoaded) {
                document.getElementById('shippingRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('shippingRecordsRowCount').textContent = '-';
                return;
            }
            if (shippingRecordsData.length === 0) {
                document.getElementById('shippingRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('shippingRecordsRowCount').textContent = '0';
                return;
            }
            
            renderShippingRecordsTableHeader();
            const headers = SHIPPING_RECORDS_HEADERS;
            let data = [...shippingRecordsData];
            
            // Category filter
            data = data.filter(row => shippingRecordsFilters.categories[getShippingRecordsCategory(row)] || getShippingRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('shippingRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('shippingRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (shippingRecordsSort.field !== null) {
                const colIndex = parseInt(shippingRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return shippingRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return shippingRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('shippingRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('shippingRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('shippingRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links - handle arrays of URLs
                    if (h.includes('Pictures')) {
                        if (Array.isArray(val) && val.length > 0) {
                            val = val.map((url, idx) => `<a href="${url}" target="_blank" style="color:var(--accent);margin-right:4px;">ðŸ“·${val.length > 1 ? (idx + 1) : ''}</a>`).join('');
                        } else if (typeof val === 'string' && val.includes('http')) {
                            val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                        } else {
                            val = '-';
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('shippingRecords');
        }
        
        function sortShippingRecordsTable(field) {
            if (shippingRecordsSort.field === field) {
                shippingRecordsSort.asc = !shippingRecordsSort.asc;
            } else {
                shippingRecordsSort.field = field;
                shippingRecordsSort.asc = true;
            }
            renderShippingRecordsTable();
        }
        
        function filterShippingRecordsTable() { renderShippingRecordsTable(); }
        
        function getUniqueShippingRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = SHIPPING_RECORDS_HEADERS[colIndex];
            const values = new Set();
            shippingRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportShippingRecordsToCSV() {
            const headers = currentLang === 'es' ? SHIPPING_RECORDS_HEADERS_ES : SHIPPING_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = shippingRecordsData.map(row => 
                SHIPPING_RECORDS_HEADERS.map(h => {
                    let val = row[h];
                    if (val === undefined || val === null) return '""';
                    // Handle arrays by joining with semicolon
                    if (Array.isArray(val)) val = val.join('; ');
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `shipping_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // STAGED RECORDS FUNCTIONS
        // ============================================================
        
        async function loadStagedRecordsData() {
            if (stagedRecordsLoaded) return;
            try {
                // Use proven fetchSheetData function
                const rawData = await fetchSheetData(STAGED_RECORDS_GID);
                console.log('Staged Records raw data sample:', rawData.length > 0 ? rawData[0] : 'no data');
                console.log('Staged Records raw data count:', rawData.length);
                
                // Map the original bilingual headers to simplified English headers
                stagedRecordsData = rawData.map(row => {
                    // Find values by checking multiple possible header names
                    const findVal = (...keys) => {
                        for (const key of keys) {
                            for (const [header, value] of Object.entries(row)) {
                                if (header.toLowerCase().includes(key.toLowerCase())) {
                                    return value ?? '';
                                }
                            }
                        }
                        return '';
                    };
                    
                    // Helper to extract URLs from a field
                    const extractUrls = (value) => {
                        if (!value) return [];
                        const str = value.toString();
                        const urls = str.split(/[,\n]|\s+(?=https?:)/)
                            .map(u => u.trim())
                            .filter(u => u && u.includes('http'));
                        return urls;
                    };
                    
                    // Find Fusion Picture specifically (Column M) - be careful not to match "Staged in Fusion"
                    const findFusionPicture = () => {
                        for (const [header, value] of Object.entries(row)) {
                            const h = header.toLowerCase();
                            // Match "Fusion Picture" or "Foto de Fusion" but NOT "Staged in Fusion"
                            if ((h.includes('fusion picture') || h.includes('foto de fusion') || h === 'fusion') && !h.includes('staged')) {
                                if (value && value.toString().includes('http')) {
                                    return extractUrls(value);
                                }
                            }
                        }
                        return [];
                    };
                    
                    return {
                        'Timestamp': findVal('timestamp', 'marca de tiempo'),
                        'Line Number': findVal('line number', 'numero de linea'),
                        'IF Number': findVal('if number', 'numero if', 'numero de if'),
                        'Order Quantity': findVal('order quantity', 'cantidad de orden', 'cantidad'),
                        'Number of Pallets': findVal('number of pallets', 'numero de paletas'),
                        'Staged By': findVal('name', 'nombre', 'staged by'),
                        'Comments': findVal('comments', 'comentarios'),
                        'Order Status': findVal('order status', 'estado de orden', 'status'),
                        'Staged in Fusion': findVal('staged in fusion', 'fulfillment staged'),
                        'Pallet Dimensions': findVal('pallet dimensions', 'dimensiones de la paleta'),
                        'Pallet Weight (lbs)': findVal('pallet weight', 'peso de la paleta'),
                        'Confirmed Staged': findVal('confirmed', 'confirmacion', 'confirmation'),
                        'Fusion Pictures': findFusionPicture(),  // Now returns array of URLs
                        'Customer': findVal('customer', 'cliente'),
                        'Category': findVal('category', 'categoria')
                    };
                }).filter(row => {
                    // Keep rows that have at least a timestamp or IF number
                    return row['Timestamp'] || row['IF Number'] || row['Line Number'];
                });
                
                stagedRecordsLoaded = true;
                console.log('Loaded Staged Records:', stagedRecordsData.length, 'rows');
                if (stagedRecordsData.length > 0) {
                    console.log('First row sample:', stagedRecordsData[0]);
                }
            } catch (e) {
                console.error('Staged Records load error:', e);
                stagedRecordsLoaded = true; // Mark as loaded to prevent infinite retries
            }
        }
        
        function getStagedRecordsCategory(row) {
            const cat = (row['Category'] || '').toLowerCase();
            if (cat.includes('roll tech')) return 'rolltech';
            if (cat.includes('molding')) return 'molding';
            if (cat.includes('snap pad')) return 'snappad';
            return 'other';
        }
        
        function toggleStagedRecordsCategory(cat) {
            stagedRecordsFilters.categories[cat] = !stagedRecordsFilters.categories[cat];
            document.getElementById(`stagedRecordsBtnRollTech`).classList.toggle('active', stagedRecordsFilters.categories.rolltech);
            document.getElementById(`stagedRecordsBtnMolding`).classList.toggle('active', stagedRecordsFilters.categories.molding);
            document.getElementById(`stagedRecordsBtnSnapPad`).classList.toggle('active', stagedRecordsFilters.categories.snappad);
            renderStagedRecordsTable();
        }
        
        function renderStagedRecordsTableHeader() {
            const headers = currentLang === 'es' ? STAGED_RECORDS_HEADERS_ES : STAGED_RECORDS_HEADERS;
            initTableFilters('stagedRecords');
            initHiddenColumns('stagedRecords');
            document.getElementById('stagedRecordsTableHeader').innerHTML = headers.map((h, i) => {
                const colKey = `col_${i}`;
                if (isColumnHidden('stagedRecords', colKey)) return '';
                return createFilterHeader('stagedRecords', colKey, h, true);
            }).join('');
        }
        
        function renderStagedRecordsTable() {
            if (!stagedRecordsLoaded) {
                document.getElementById('stagedRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;">Loading data...</td></tr>';
                document.getElementById('stagedRecordsRowCount').textContent = '-';
                return;
            }
            if (stagedRecordsData.length === 0) {
                document.getElementById('stagedRecordsTableBody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:var(--warning);">No data found. Check console for errors.</td></tr>';
                document.getElementById('stagedRecordsRowCount').textContent = '0';
                return;
            }
            
            renderStagedRecordsTableHeader();
            const headers = STAGED_RECORDS_HEADERS;
            let data = [...stagedRecordsData];
            
            // Category filter
            data = data.filter(row => stagedRecordsFilters.categories[getStagedRecordsCategory(row)] || getStagedRecordsCategory(row) === 'other');
            
            // Global search filter
            const globalSearch = (document.getElementById('stagedRecordsGlobalSearch')?.value || '').toLowerCase();
            if (globalSearch) {
                data = data.filter(row => {
                    return headers.some(h => {
                        const val = row[h];
                        return val && String(val).toLowerCase().includes(globalSearch);
                    });
                });
            }
            
            // Apply column filters
            data = data.filter(row => {
                return headers.every((h, i) => {
                    const colKey = `col_${i}`;
                    const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
                    return passesColumnFilter('stagedRecords', colKey, val);
                });
            });
            
            // Apply sort
            if (stagedRecordsSort.field !== null) {
                const colIndex = parseInt(stagedRecordsSort.field.replace('col_', ''));
                const header = headers[colIndex];
                data.sort((a, b) => {
                    let aVal = a[header] ?? '';
                    let bVal = b[header] ?? '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) return stagedRecordsSort.asc ? aNum - bNum : bNum - aNum;
                    return stagedRecordsSort.asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
                });
            }
            
            document.getElementById('stagedRecordsRowCount').textContent = data.length;
            
            // Render rows
            const tbody = document.getElementById('stagedRecordsTableBody');
            tbody.innerHTML = data.map(row => {
                return '<tr>' + headers.map((h, i) => {
                    const colKey = `col_${i}`;
                    if (isColumnHidden('stagedRecords', colKey)) return '';
                    let val = row[h] ?? '';
                    // Render picture links - handle arrays of URLs
                    if (h.includes('Pictures')) {
                        if (Array.isArray(val) && val.length > 0) {
                            val = val.map((url, idx) => `<a href="${url}" target="_blank" style="color:var(--accent);margin-right:4px;">ðŸ“·${val.length > 1 ? (idx + 1) : ''}</a>`).join('');
                        } else if (typeof val === 'string' && val.includes('http')) {
                            val = `<a href="${val}" target="_blank" style="color:var(--accent);">ðŸ“· View</a>`;
                        } else {
                            val = '-';
                        }
                    }
                    return `<td>${val}</td>`;
                }).join('') + '</tr>';
            }).join('');
            
            updateFilterButtonState('stagedRecords');
        }
        
        function sortStagedRecordsTable(field) {
            if (stagedRecordsSort.field === field) {
                stagedRecordsSort.asc = !stagedRecordsSort.asc;
            } else {
                stagedRecordsSort.field = field;
                stagedRecordsSort.asc = true;
            }
            renderStagedRecordsTable();
        }
        
        function filterStagedRecordsTable() { renderStagedRecordsTable(); }
        
        function getUniqueStagedRecordsColumnValues(columnKey) {
            const colIndex = parseInt(columnKey.replace('col_', ''));
            const header = STAGED_RECORDS_HEADERS[colIndex];
            const values = new Set();
            stagedRecordsData.forEach(row => {
                const val = row[header];
                if (val !== undefined && val !== null && val !== '') {
                    values.add(String(val));
                }
            });
            return Array.from(values).sort((a, b) => a.localeCompare(b));
        }
        
        function exportStagedRecordsToCSV() {
            const headers = currentLang === 'es' ? STAGED_RECORDS_HEADERS_ES : STAGED_RECORDS_HEADERS;
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const rows = stagedRecordsData.map(row => 
                STAGED_RECORDS_HEADERS.map(h => {
                    let val = row[h];
                    if (val === undefined || val === null) return '""';
                    // Handle arrays by joining with semicolon
                    if (Array.isArray(val)) val = val.join('; ');
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            );
            downloadCSV([headerRow, ...rows].join('\n'), `staged_records_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ============================================================
        // AI ASSISTANT â€” Gemini Integration
        // ============================================================
        // Key split to avoid automated leak detection on public repos
        const _gk = ['AIza','SyCQ','iYrn','1yOk','B7RF','A683','NyW6','pl_7','TtXL','rEU'];
        const GEMINI_API_KEY = _gk.join('');
        const GEMINI_MODELS = [
            'gemini-2.5-flash',
            'gemini-2.0-flash',
            'gemini-2.0-flash-lite'
        ];
        let aiChatOpen = false;
        let aiChatHistory = []; // {role:'user'|'model', parts:[{text}]}
        let aiCurrentModel = 0;
        let aiIsBusy = false;

        // Build the system instruction that teaches Gemini our domain
        function buildAiSystemInstruction() {
            return `You are an AI assistant embedded in a Molding Operations Dashboard for a manufacturing company (Entech / Roll Tech). You answer questions about production orders, inventory, and shipping data.

RESPOND IN THE SAME LANGUAGE THE USER WRITES IN. If they write in Spanish, respond in Spanish. If English, respond in English.

## Data You Have Access To

### 1. Production Orders (allData) â€” ~${allData.length} active orders
Each order has these fields:
- **Category**: "Roll Tech", "Molding", or "Snap Pad" (product lines)
- **Line**: Work order line number
- **IF #**: Internal Fusion order number (IF = "Internal Fusion")
- **PO #**: Customer purchase order number
- **Customer**: Customer name (e.g., Schaefer, TBC, Stellar)
- **Part #**: Part number (e.g., 668.254.353, FS-TPO)
- **Order Qty**: Quantity ordered
- **Status**: One of: pending (Need to Make), wip (Making/Work in Progress), staged (Ready to Ship/Packed), shipped (Shipped/Invoiced)
- **Priority**: Priority level (1-5, where 1 is highest)
- **Urgent**: Whether order is marked urgent
- **Requested Completion Date**: When the order is due
- **Days Until Promise Date**: Days remaining (negative = overdue/late)
- **Assigned to**: Worker assigned to the order
- **Tire**: Tire part number (Roll Tech only)
- **Hub**: Hub/center piece part (Roll Tech only)
- **Hub Mold**: Mold used for the hub (Roll Tech only)
- **Bearings**: Bearings needed (Roll Tech only)
- **Packaging**: How the order is packaged
- **Enough Inventory**: Whether there's enough inventory for this order
- **Have Tire?**: Whether tire is in stock (Roll Tech only)
- **Have Hub?**: Whether hub is in stock (Roll Tech only)

### 2. Inventory Data (inventoryData) â€” ~${inventoryData.length} items
- **Part Number**: The part number
- **Product**: Product type/name
- **Fusion Qty**: Current quantity in Fusion (ERP system)
- **Minimum**: Minimum stock level
- **Manual Target**: Target inventory level
- **Qty Needed**: Quantity needed for current orders
- **Parts to Make**: How many need to be manufactured
- **Mold Type**: Type of mold used

### 3. Pallet Records (palletRecordsData) â€” ${palletRecordsData.length} records
Records of pallets packed for orders, with photos and measurements.

## Domain Knowledge
- **Entech** recycles tires: melts tire wire into ingots, makes molded products from crumb rubber
- **Roll Tech** wheels have components: Tire (outer ring) + Hub (center) + Bearings
- **Molding** products: rubber mats, bumpers, etc. from crumb rubber
- **Snap Pad** products: rail crossing pads
- **Fusion**: Their ERP system (iFusion) â€” tracks orders, inventory, invoicing
- **Staged**: Product is packed on pallets, weighed, photographed â€” ready to ship
- **WIP (Work in Progress)**: Currently being manufactured on the press
- Status flow: **Pending â†’ WIP (Making) â†’ Staged (Ready to Ship) â†’ Shipped**
- Overdue orders have **negative** "Days Until" values
- Priority 1 = most urgent; "Urgent Override" flag can mark any order as urgent regardless of priority number

## Financial Data Access
${salesUnlocked ? 'âœ… The user HAS unlocked Sales & Finance. You can answer questions about revenue, profit/loss, costs, and margins.' : 'ðŸ”’ The user has NOT unlocked Sales & Finance. Financial data (revenue, P/L, profit, loss, costs, margins, pricing) is RESTRICTED. If asked about financial data, tell them: "Financial data is locked. Please unlock the Sales & Finance section in the sidebar first." Do NOT guess, estimate, or reveal any financial figures.'}

## CRITICAL: Accuracy Rules
- **NEVER guess or estimate counts.** Use ONLY the pre-computed statistics provided in the "STATISTICS" section of the data.
- When asked "how many orders for part X?" â€” find that part in the STATISTICS section and use the exact count shown there.
- When asked about a specific part, customer, or status â€” find matching rows in the data and count them ONE BY ONE. Do not round or approximate.
- If the statistics section shows "Part 620.308.2211: 4 orders (pending=3, staged=1)" then the answer is exactly 4, not 10, not "about".
- **Double-check your count** before answering. If you say "Found 5 orders" then list exactly 5 in the table.
- If you're unsure about a count, list the matching items in a table and count the rows you listed.

## Response Guidelines
- Be concise and direct â€” this is a production floor tool, not a chatbot
- Use tables (markdown) when showing multiple items
- When listing orders, include: Line, Customer, Part#, Qty, Status, Days Until
- For inventory, include: Part#, Fusion Qty, Minimum, Status
- If asked about something not in the data, say so honestly
- Numbers: use commas for thousands (1,234)
- Dates: use MM/DD/YYYY format
- For "late" or "overdue" orders: Days Until < 0
- For "low inventory": Fusion Qty < Minimum
- Always give counts when listing items (e.g., "Found 5 orders:")
- **Match the count in your text with the actual rows you list.** Never say "Found 5" then list 3.`;
        }

        // Pre-compute statistics for AI accuracy
        function buildAiStatistics() {
            let stats = '\\n## PRE-COMPUTED STATISTICS (use these for counts â€” do NOT count rows manually)\\n';

            if (allData.length === 0) return stats + 'No order data loaded.\\n';

            // Overall counts
            const statusCounts = { pending: 0, wip: 0, staged: 0, shipped: 0 };
            const catCounts = { rolltech: 0, molding: 0, snappad: 0, other: 0 };
            const byPart = {};
            const byCustomer = {};
            const overdueOrders = [];
            const urgentOrders = [];

            allData.forEach(row => {
                const status = getStatus(row);
                const cat = getCategory(row);
                const part = (getVal(row, 'PART') || '-').toString().trim();
                const cust = (getVal(row, 'CUSTOMER') || '-').toString().trim();
                const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                const line = getVal(row, 'LINE') || '-';
                const urgent = (getVal(row, 'URGENT') || '').toString().toLowerCase().trim();
                const isUrgent = urgent === 'urgent' || urgent === 'true' || urgent === '1' || urgent === 'yes' || urgent === 'x';

                if (statusCounts[status] !== undefined) statusCounts[status]++;
                if (catCounts[cat] !== undefined) catCounts[cat]++;
                else catCounts.other++;

                // By Part
                if (!byPart[part]) byPart[part] = { total: 0, pending: 0, wip: 0, staged: 0, shipped: 0, totalQty: 0, customers: new Set() };
                byPart[part].total++;
                if (byPart[part][status] !== undefined) byPart[part][status]++;
                byPart[part].totalQty += parseNumber(getVal(row, 'QTY')) || 0;
                byPart[part].customers.add(cust);

                // By Customer
                if (!byCustomer[cust]) byCustomer[cust] = { total: 0, pending: 0, wip: 0, staged: 0, shipped: 0, totalQty: 0, parts: new Set() };
                byCustomer[cust].total++;
                if (byCustomer[cust][status] !== undefined) byCustomer[cust][status]++;
                byCustomer[cust].totalQty += parseNumber(getVal(row, 'QTY')) || 0;
                byCustomer[cust].parts.add(part);

                // Overdue
                if (days < 0 && status !== 'shipped') overdueOrders.push({ line, part, cust, days, status });
                // Urgent
                if (isUrgent) urgentOrders.push({ line, part, cust, status });
            });

            // Overall summary
            const activeTotal = statusCounts.pending + statusCounts.wip + statusCounts.staged;
            stats += `\\n### Overall: ${allData.length} total orders (${activeTotal} active, ${statusCounts.shipped} shipped)\\n`;
            stats += `Status breakdown: pending=${statusCounts.pending}, wip=${statusCounts.wip}, staged=${statusCounts.staged}, shipped=${statusCounts.shipped}\\n`;
            stats += `Category breakdown: RollTech=${catCounts.rolltech}, Molding=${catCounts.molding}, SnapPad=${catCounts.snappad}\\n`;
            stats += `Overdue orders (active, DaysUntil < 0): ${overdueOrders.length}\\n`;
            stats += `Urgent orders: ${urgentOrders.length}\\n`;

            // Per-part summary
            stats += `\\n### Orders by Part Number (${Object.keys(byPart).length} unique parts):\\n`;
            Object.entries(byPart).sort((a, b) => b[1].total - a[1].total).forEach(([part, d]) => {
                const custList = Array.from(d.customers).join(', ');
                stats += `Part ${part}: ${d.total} orders (pending=${d.pending}, wip=${d.wip}, staged=${d.staged}, shipped=${d.shipped}) | TotalQty=${d.totalQty.toLocaleString()} | Customers: ${custList}\\n`;
            });

            // Per-customer summary
            stats += `\\n### Orders by Customer (${Object.keys(byCustomer).length} unique customers):\\n`;
            Object.entries(byCustomer).sort((a, b) => b[1].total - a[1].total).forEach(([cust, d]) => {
                const partList = Array.from(d.parts).join(', ');
                stats += `Customer ${cust}: ${d.total} orders (pending=${d.pending}, wip=${d.wip}, staged=${d.staged}, shipped=${d.shipped}) | TotalQty=${d.totalQty.toLocaleString()} | Parts: ${partList}\\n`;
            });

            // Overdue details
            if (overdueOrders.length > 0) {
                stats += `\\n### Overdue Orders (${overdueOrders.length} total):\\n`;
                overdueOrders.sort((a, b) => a.days - b.days).forEach(o => {
                    stats += `Line ${o.line}: Part=${o.part} | Customer=${o.cust} | ${Math.abs(o.days)} days overdue | Status=${o.status}\\n`;
                });
            }

            // Inventory stats
            if (inventoryData.length > 0) {
                const lowItems = inventoryData.filter(i => i.fusionQty < i.minimum && i.minimum > 0);
                const okItems = inventoryData.filter(i => i.fusionQty >= i.minimum || i.minimum === 0);
                stats += `\\n### Inventory: ${inventoryData.length} items total, ${lowItems.length} LOW (below minimum), ${okItems.length} OK\\n`;
                if (lowItems.length > 0) {
                    stats += `Low inventory items:\\n`;
                    lowItems.sort((a, b) => (a.fusionQty / (a.minimum || 1)) - (b.fusionQty / (b.minimum || 1))).forEach(i => {
                        stats += `Part ${i.partNumber}: Qty=${i.fusionQty} / Min=${i.minimum} (${i.minimum > 0 ? Math.round(i.fusionQty / i.minimum * 100) : 0}% of minimum)\\n`;
                    });
                }
            }

            return stats;
        }

        // Build compact data context string from live dashboard data
        function buildAiDataContext() {
            let ctx = '';
            const hasSalesAccess = salesUnlocked === true;

            // Pre-computed statistics (Option 1: helps AI avoid miscounting)
            ctx += buildAiStatistics();

            // Raw orders data
            if (allData.length > 0) {
                ctx += '\\n## Raw Orders Data (for detailed lookups)\\n';
                allData.forEach((row, i) => {
                    const line = getVal(row, 'LINE') || '-';
                    const cust = getVal(row, 'CUSTOMER') || '-';
                    const part = getVal(row, 'PART') || '-';
                    const qty = getVal(row, 'QTY') || '-';
                    const status = getStatus(row);
                    const cat = getCategory(row);
                    const days = getVal(row, 'DAYS_UNTIL');
                    const ifNum = getVal(row, 'IF_NUM') || '-';
                    const poNum = getVal(row, 'PO_NUM') || '-';
                    const priority = getVal(row, 'PRIORITY') || '-';
                    const urgent = getVal(row, 'URGENT') || '';
                    const assigned = getVal(row, 'ASSIGNED') || '-';
                    const tire = getVal(row, 'TIRE') || '';
                    const hub = getVal(row, 'HUB') || '';
                    const bearings = getVal(row, 'BEARINGS') || '';
                    const dueDate = getVal(row, 'REQUESTED_DATE') || '-';
                    const enoughInv = getVal(row, 'ENOUGH_INV') || '';
                    const haveTire = getVal(row, 'HAVE_TIRE') || '';
                    const haveHub = getVal(row, 'HAVE_HUB') || '';
                    let orderLine = `Order ${i+1}: Line=${line} | IF#=${ifNum} | PO#=${poNum} | Customer=${cust} | Part=${part} | Qty=${qty} | Status=${status} | Category=${cat} | Priority=${priority} | Urgent=${urgent} | DaysUntil=${days} | DueDate=${dueDate} | Assigned=${assigned} | Tire=${tire} | Hub=${hub} | Bearings=${bearings} | EnoughInv=${enoughInv} | HaveTire=${haveTire} | HaveHub=${haveHub}`;
                    // Only include financial data if sales section is unlocked
                    if (hasSalesAccess) {
                        const revenue = getVal(row, 'REVENUE') || '';
                        const pl = getVal(row, 'PL') || '';
                        const plTotal = row[COL.PL_TOTAL] || '';
                        const varCost = row[COL.VARIABLE_COST] || '';
                        const totalCost = row[COL.TOTAL_COST] || '';
                        orderLine += ` | Revenue=${revenue} | P/L=${pl} | P/L_Total=${plTotal} | VariableCost=${varCost} | TotalCost=${totalCost}`;
                    }
                    ctx += orderLine + '\\n';
                });
            }
            // Inventory data
            if (inventoryData.length > 0) {
                ctx += '\\n## Raw Inventory Data (for detailed lookups)\\n';
                inventoryData.forEach((item, i) => {
                    const status = item.fusionQty < item.minimum ? 'LOW' : (item.fusionQty >= (item.manualTarget || item.minimum) ? 'OK' : 'WATCH');
                    ctx += `Inv ${i+1}: Part=${item.partNumber} | Product=${item.product} | FusionQty=${item.fusionQty} | Min=${item.minimum} | Target=${item.manualTarget || '-'} | QtyNeeded=${item.qtyNeeded} | ToMake=${item.partsToBeMade} | MoldType=${item.moldType || '-'} | Status=${status}\\n`;
                });
            }
            // Pallet summary (compact)
            if (palletRecordsData && palletRecordsData.length > 0) {
                ctx += `\\n## Pallet Records: ${palletRecordsData.length} total records available\\n`;
            }
            return ctx;
        }

        // Option 3: Pre-filter data based on user query to give AI targeted results
        function buildQueryHelper(userMessage) {
            const msg = userMessage.toLowerCase();
            let helper = '';

            // Detect part number mentions (patterns like 620.308.2211, FS-TPO, THRESH-1.5, etc.)
            const partPatterns = msg.match(/\b[\d]{3}[\.\-][\d]{3}[\.\-][\d]{3,}[\w]*/gi) || [];
            const partWords = msg.match(/\b(?:fs|sp|spo|spec|spcf|spef|thresh|rubb|earthedge|padasm)[\-\w]+/gi) || [];
            const allPartMentions = [...partPatterns, ...partWords];

            if (allPartMentions.length > 0) {
                allPartMentions.forEach(searchPart => {
                    const sp = searchPart.toLowerCase();
                    const matchingOrders = allData.filter(row => {
                        const part = (getVal(row, 'PART') || '').toString().toLowerCase();
                        return part.includes(sp) || sp.includes(part);
                    });
                    const matchingInv = inventoryData.filter(item => {
                        const part = (item.partNumber || '').toLowerCase();
                        return part.includes(sp) || sp.includes(part);
                    });
                    if (matchingOrders.length > 0 || matchingInv.length > 0) {
                        helper += `\\n[QUERY HELPER â€” pre-filtered results for "${searchPart}"]\\n`;
                        if (matchingOrders.length > 0) {
                            helper += `Matching orders: exactly ${matchingOrders.length} found\\n`;
                            matchingOrders.forEach((row, i) => {
                                helper += `  ${i+1}. Line=${getVal(row,'LINE')} | IF#=${getVal(row,'IF_NUM')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | Qty=${getVal(row,'QTY')} | Status=${getStatus(row)} | DaysUntil=${getVal(row,'DAYS_UNTIL')}\\n`;
                            });
                        }
                        if (matchingInv.length > 0) {
                            helper += `Matching inventory: exactly ${matchingInv.length} found\\n`;
                            matchingInv.forEach((item, i) => {
                                helper += `  ${i+1}. Part=${item.partNumber} | FusionQty=${item.fusionQty} | Min=${item.minimum} | Status=${item.fusionQty < item.minimum ? 'LOW' : 'OK'}\\n`;
                            });
                        }
                    }
                });
            }

            // Detect customer name mentions
            const knownCustomers = [...new Set(allData.map(r => (getVal(r, 'CUSTOMER') || '').toString().trim()).filter(Boolean))];
            knownCustomers.forEach(cust => {
                if (msg.includes(cust.toLowerCase())) {
                    const matchingOrders = allData.filter(row => (getVal(row, 'CUSTOMER') || '').toString().trim().toLowerCase() === cust.toLowerCase());
                    if (matchingOrders.length > 0) {
                        helper += `\\n[QUERY HELPER â€” pre-filtered results for customer "${cust}"]\\n`;
                        helper += `Matching orders: exactly ${matchingOrders.length} found\\n`;
                        matchingOrders.forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Part=${getVal(row,'PART')} | Qty=${getVal(row,'QTY')} | Status=${getStatus(row)} | DaysUntil=${getVal(row,'DAYS_UNTIL')}\\n`;
                        });
                    }
                }
            });

            // Detect status queries
            const statusTerms = { 'late': 'overdue', 'overdue': 'overdue', 'atrasad': 'overdue', 'retrasad': 'overdue', 'urgent': 'urgent', 'urgente': 'urgent' };
            Object.entries(statusTerms).forEach(([term, type]) => {
                if (msg.includes(term)) {
                    if (type === 'overdue') {
                        const overdue = allData.filter(row => {
                            const days = parseNumber(getVal(row, 'DAYS_UNTIL'));
                            return days < 0 && getStatus(row) !== 'shipped';
                        });
                        helper += `\\n[QUERY HELPER â€” overdue/late orders]\\n`;
                        helper += `Overdue active orders: exactly ${overdue.length} found\\n`;
                        overdue.sort((a, b) => parseNumber(getVal(a, 'DAYS_UNTIL')) - parseNumber(getVal(b, 'DAYS_UNTIL'))).forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | ${Math.abs(parseNumber(getVal(row,'DAYS_UNTIL')))} days overdue | Status=${getStatus(row)}\\n`;
                        });
                    }
                    if (type === 'urgent') {
                        const urgents = allData.filter(row => {
                            const u = (getVal(row, 'URGENT') || '').toString().toLowerCase().trim();
                            return u === 'urgent' || u === 'true' || u === '1' || u === 'yes' || u === 'x';
                        });
                        helper += `\\n[QUERY HELPER â€” urgent orders]\\n`;
                        helper += `Urgent orders: exactly ${urgents.length} found\\n`;
                        urgents.forEach((row, i) => {
                            helper += `  ${i+1}. Line=${getVal(row,'LINE')} | Customer=${getVal(row,'CUSTOMER')} | Part=${getVal(row,'PART')} | Status=${getStatus(row)}\\n`;
                        });
                    }
                }
            });

            return helper;
        }

        // Call Gemini API
        async function callGemini(userMessage) {
            const systemInstruction = buildAiSystemInstruction();
            const dataContext = buildAiDataContext();
            const queryHelper = buildQueryHelper(userMessage);

            // Add data context as first user message if not already there
            const contents = [];
            if (aiChatHistory.length === 0) {
                // First message â€” prepend data context + query helper
                contents.push({
                    role: 'user',
                    parts: [{ text: `Here is the current live data from the dashboard:\\n${dataContext}${queryHelper}\\n\\nMy question: ${userMessage}` }]
                });
            } else {
                // Subsequent messages â€” include history
                // Re-inject fresh data context with each turn for accuracy
                const firstMsg = {
                    role: 'user',
                    parts: [{ text: `[UPDATED LIVE DATA]\\n${dataContext}` }]
                };
                const firstResp = {
                    role: 'model',
                    parts: [{ text: 'Got it, I have the latest data.' }]
                };
                contents.push(firstMsg, firstResp);
                // Add prior conversation
                for (let i = 0; i < aiChatHistory.length; i++) {
                    contents.push(aiChatHistory[i]);
                }
                contents.push({ role: 'user', parts: [{ text: `${queryHelper}\\n\\n${userMessage}` }] });
            }

            let lastError = null;
            let errors = [];
            for (let m = aiCurrentModel; m < GEMINI_MODELS.length; m++) {
                const model = GEMINI_MODELS[m];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                try {
                    console.log(`[AI] Trying model: ${model}`);
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            system_instruction: { parts: [{ text: systemInstruction }] },
                            contents: contents,
                            generationConfig: {
                                temperature: 0.3,
                                maxOutputTokens: 2048
                            }
                        })
                    });
                    if (resp.status === 429) {
                        console.warn(`[AI] ${model}: rate limited (429)`);
                        errors.push(`${model}: rate limited`);
                        lastError = 'rate_limit';
                        continue;
                    }
                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        const errMsg = errData.error?.message || `HTTP ${resp.status}`;
                        console.warn(`[AI] ${model}: error â€” ${errMsg}`);
                        errors.push(`${model}: ${errMsg}`);
                        lastError = new Error(errMsg);
                        continue;
                    }
                    const data = await resp.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) {
                        const blockReason = data.candidates?.[0]?.finishReason || data.promptFeedback?.blockReason || 'empty';
                        throw new Error(`No response (${blockReason})`);
                    }
                    console.log(`[AI] Success with ${model}`);
                    aiCurrentModel = m; // Stick with working model
                    return { text, model };
                } catch (e) {
                    console.warn(`[AI] ${model}: ${e.message}`);
                    errors.push(`${model}: ${e.message}`);
                    lastError = e;
                }
            }
            // All models failed
            aiCurrentModel = 0; // Reset for next attempt
            const allRateLimited = errors.every(e => e.includes('rate limited'));
            if (allRateLimited) {
                throw new Error('RATE_LIMIT');
            }
            throw new Error(errors.join(' â†’ '));
        }

        // Render markdown-ish text to HTML (simple parser)
        function renderAiMarkdown(text) {
            // --- Phase 1: Parse markdown tables as blocks BEFORE line-level processing ---
            text = text.replace(/((?:^\|.+\n?)+)/gm, (tableBlock) => {
                const lines = tableBlock.trim().split('\n').filter(l => l.trim());
                if (lines.length < 2) return tableBlock;
                // Find separator row (line of |---|---|)
                const sepIdx = lines.findIndex((l, i) => i > 0 && /^\|[\s:|-]+\|?\s*$/.test(l.trim()));
                if (sepIdx < 1) return tableBlock; // No separator = not a real table
                const parseCells = (line) => {
                    let l = line.trim();
                    if (l.startsWith('|')) l = l.slice(1);
                    if (l.endsWith('|')) l = l.slice(0, -1);
                    return l.split('|').map(c => c.trim());
                };
                const headerRows = lines.slice(0, sepIdx);
                const bodyRows = lines.slice(sepIdx + 1).filter(l => l.trim() && /\|/.test(l));
                let t = '<div class="ai-table-wrap"><table>';
                t += '<thead>';
                headerRows.forEach(r => {
                    t += '<tr>' + parseCells(r).map(c => `<th>${c}</th>`).join('') + '</tr>';
                });
                t += '</thead>';
                if (bodyRows.length) {
                    t += '<tbody>';
                    bodyRows.forEach(r => {
                        t += '<tr>' + parseCells(r).map(c => `<td>${c}</td>`).join('') + '</tr>';
                    });
                    t += '</tbody>';
                }
                t += '</table></div>';
                return '\n' + t + '\n';
            });

            // --- Phase 2: Inline markdown ---
            let html = text
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^### (.*$)/gm, '<strong style="font-size:14px;display:block;margin:8px 0 4px;">$1</strong>')
                .replace(/^## (.*$)/gm, '<strong style="font-size:15px;display:block;margin:10px 0 4px;">$1</strong>')
                .replace(/^[-â€¢]\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>')
                .replace(/\n/g, '<br>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.*?<\/li><br>?)+)/g, (match) => {
                return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
            });

            // Clean up extra <br> around block elements
            html = html.replace(/<\/(table|ul|ol|pre|div)><br>/g, '</$1>');
            html = html.replace(/<br><(div class="ai-table-wrap")/g, '<$1');

            return html;
        }

        // Toggle chat panel
        function toggleAiChat() {
            aiChatOpen = !aiChatOpen;
            document.getElementById('aiChatPanel').classList.toggle('open', aiChatOpen);
            document.getElementById('aiChatFab').classList.toggle('hidden', aiChatOpen);
            if (aiChatOpen) {
                initAiChat();
                setTimeout(() => document.getElementById('aiChatInput').focus(), 300);
            }
        }

        // Initialize chat UI
        function initAiChat() {
            const welcomeMsg = document.getElementById('aiWelcomeMsg');
            if (welcomeMsg && !welcomeMsg.dataset.init) {
                welcomeMsg.textContent = t('ai.welcome');
                welcomeMsg.dataset.init = '1';
                // Render suggestion chips
                renderAiSuggestions();
            }
        }

        function renderAiSuggestions() {
            const container = document.getElementById('aiSuggestions');
            container.innerHTML = '';
            ['ai.suggestion1', 'ai.suggestion2', 'ai.suggestion3', 'ai.suggestion4'].forEach(key => {
                const chip = document.createElement('div');
                chip.className = 'ai-suggestion-chip';
                chip.textContent = t(key);
                chip.onclick = () => {
                    document.getElementById('aiChatInput').value = t(key);
                    sendAiMessage();
                };
                container.appendChild(chip);
            });
        }

        // Send a message
        async function sendAiMessage() {
            if (aiIsBusy) return;
            const input = document.getElementById('aiChatInput');
            const msg = input.value.trim();
            if (!msg) return;

            // Check data loaded
            if (allData.length === 0 && inventoryData.length === 0) {
                appendAiMessage(t('ai.noData'), 'system');
                return;
            }

            input.value = '';
            aiIsBusy = true;
            document.getElementById('aiSendBtn').disabled = true;
            document.getElementById('aiSuggestions').style.display = 'none';

            // Show user message
            appendAiMessage(msg, 'user');

            // Show typing indicator
            const typingEl = showAiTyping();

            try {
                const result = await callGemini(msg);
                // Save to history
                aiChatHistory.push({ role: 'user', parts: [{ text: msg }] });
                aiChatHistory.push({ role: 'model', parts: [{ text: result.text }] });
                // Remove typing, show response
                typingEl.remove();
                appendAiMessage(result.text, 'bot');
            } catch (e) {
                typingEl.remove();
                if (e.message === 'RATE_LIMIT') {
                    appendAiMessage(t('ai.rateLimit'), 'error');
                } else {
                    appendAiMessage(`${t('ai.error')}\n${e.message}`, 'error');
                }
            } finally {
                aiIsBusy = false;
                document.getElementById('aiSendBtn').disabled = false;
                input.focus();
            }
        }

        function appendAiMessage(text, type) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = `ai-msg ${type}`;
            if (type === 'bot') {
                div.innerHTML = renderAiMarkdown(text);
            } else {
                div.textContent = text;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showAiTyping() {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = 'ai-typing';
            div.innerHTML = '<div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function clearAiChat() {
            aiChatHistory = [];
            aiCurrentModel = 0;
            const container = document.getElementById('aiChatMessages');
            container.innerHTML = '<div class="ai-msg system" id="aiWelcomeMsg"></div>';
            document.getElementById('aiWelcomeMsg').textContent = t('ai.welcome');
            document.getElementById('aiWelcomeMsg').dataset.init = '1';
            document.getElementById('aiSuggestions').style.display = 'flex';
            renderAiSuggestions();
            appendAiMessage(t('ai.cleared'), 'system');
        }

        // Update AI chat text when language changes
        function updateAiLanguage() {
            const welcomeMsg = document.getElementById('aiWelcomeMsg');
            if (welcomeMsg && welcomeMsg.dataset.init) {
                welcomeMsg.textContent = t('ai.welcome');
            }
            const input = document.getElementById('aiChatInput');
            if (input) input.placeholder = t('ai.placeholder');
            const title = document.querySelector('.ai-chat-header .ai-title');
            if (title) title.textContent = t('ai.title');
            const subtitle = document.querySelector('.ai-chat-header .ai-subtitle');
            if (subtitle) subtitle.textContent = t('ai.subtitle');
            renderAiSuggestions();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedZoom();
            loadSavedTheme();
            loadDashboard();
        });
    </script>
</body>
</html>
